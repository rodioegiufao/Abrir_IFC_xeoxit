/**
 * xeokit-sdk v2.6.91
 *  Commit: 2db2a75dcf9d25eb41ff787cc12a1723e194eb92
 *  Built: 2025-10-06T08:15:55.730Z
 */

var e,t,i,r=l().mark(mg),n=l().mark(_g),s=l().mark(ib);function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return a(e,arguments,x(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),_(r,e)},o(e)}function a(e,t,i){return a=B()?Reflect.construct.bind():function(e,t,i){var r=[null];r.push.apply(r,t);var n=new(Function.bind.apply(e,r));return i&&_(n,i.prototype),n},a.apply(null,arguments)}function l(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */l=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",s=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function a(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,i){return e[t]=i}}function u(e,t,i,r){var n=t&&t.prototype instanceof h?t:h,s=Object.create(n.prototype),o=new x(r||[]);return s._invoke=function(e,t,i){var r="suspendedStart";return function(n,s){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===n)throw s;return M()}for(i.method=n,i.arg=s;;){var o=i.delegate;if(o){var a=b(o,i);if(a){if(a===c)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var l=A(e,t,i);if("normal"===l.type){if(r=i.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r="completed",i.method="throw",i.arg=l.arg)}}}(e,i,o),s}function A(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var c={};function h(){}function d(){}function p(){}var f={};a(f,n,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(C([])));g&&g!==t&&i.call(g,n)&&(f=g);var m=p.prototype=h.prototype=Object.create(f);function _(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function r(n,s,o,a){var l=A(e[n],e,s);if("throw"!==l.type){var u=l.arg,c=u.value;return c&&"object"==P(c)&&i.call(c,"__await")?t.resolve(c.__await).then((function(e){r("next",e,o,a)}),(function(e){r("throw",e,o,a)})):t.resolve(c).then((function(e){u.value=e,o(u)}),(function(e){return r("throw",e,o,a)}))}a(l.arg)}var n;this._invoke=function(e,i){function s(){return new t((function(t,n){r(e,i,t,n)}))}return n=n?n.then(s,s):s()}}function b(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var r=A(i,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,c;var n=r.arg;return n?n.done?(t[e.resultName]=n.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):n:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function B(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function C(e){if(e){var t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,s=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return{next:M}}function M(){return{value:void 0,done:!0}}return d.prototype=p,a(m,"constructor",p),a(p,"constructor",d),d.displayName=a(p,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,a(e,o,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},_(y.prototype),a(y.prototype,s,(function(){return this})),e.AsyncIterator=y,e.async=function(t,i,r,n,s){void 0===s&&(s=Promise);var o=new y(u(t,i,r,n),s);return e.isGeneratorFunction(i)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},_(m),a(m,o,"Generator"),a(m,n,(function(){return this})),a(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},e.values=C,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(B),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(i,r){return o.type="throw",o.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n],o=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var a=i.call(s,"catchLoc"),l=i.call(s,"finallyLoc");if(a&&l){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(a){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&i.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var s=n;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,c):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),B(i),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;B(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:C(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),c}},e}function u(e,t,i,r,n,s,o){try{var a=e[s](o),l=a.value}catch(e){return void i(e)}a.done?t(l):Promise.resolve(l).then(r,n)}function A(e){return function(){var t=this,i=arguments;return new Promise((function(r,n){var s=e.apply(t,i);function o(e){u(s,r,n,o,a,"next",e)}function a(e){u(s,r,n,o,a,"throw",e)}o(void 0)}))}}function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function h(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){d(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function d(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=M(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw s}}}}function f(e){return function(e){if(Array.isArray(e))return F(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||M(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(){return v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var r=g(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(arguments.length<3?e:i):n.value}},v.apply(this,arguments)}function g(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=x(e)););return e}function m(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_(e,t)}function _(e,t){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_(e,t)}function y(e){var t=B();return function(){var i,r=x(e);if(t){var n=x(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return b(this,i)}}function b(e,t){if(t&&("object"===P(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return w(e)}function w(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function B(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function x(e){return x=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},x(e)}function P(e){return P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},P(e)}function C(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==i)return;var r,n,s=[],o=!0,a=!1;try{for(i=i.call(e);!(o=(r=i.next()).done)&&(s.push(r.value),!t||s.length!==t);o=!0);}catch(e){a=!0,n=e}finally{try{o||null==i.return||i.return()}finally{if(a)throw n}}return s}(e,t)||M(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function M(e,t){if(e){if("string"==typeof e)return F(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?F(e,t):void 0}}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function k(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function E(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function I(e,t,i){return t&&E(e.prototype,t),i&&E(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function T(e){return new R(e)}function D(e){return function(){return new S(e.apply(this,arguments))}}function S(e){var t,i;function r(t,i){try{var s=e[t](i),o=s.value,a=o instanceof R;Promise.resolve(a?o.wrapped:o).then((function(e){a?r("return"===t?"return":"next",e):n(s.done?"return":"normal",e)}),(function(e){r("throw",e)}))}catch(e){n("throw",e)}}function n(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?r(t.key,t.arg):i=null}this._invoke=function(e,n){return new Promise((function(s,o){var a={key:e,arg:n,resolve:s,reject:o,next:null};i?i=i.next=a:(t=i=a,r(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}function R(e){this.wrapped=e}function U(e){var t,i,r,n=2;for("undefined"!=typeof Symbol&&(i=Symbol.asyncIterator,r=Symbol.iterator);n--;){if(i&&null!=(t=e[i]))return t.call(e);if(r&&null!=(t=e[r]))return new L(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function L(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return L=function(e){this.s=e,this.n=e.next},L.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Promise.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Promise.reject(e):t(i.apply(this.s,arguments))}},new L(e)}S.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},S.prototype.next=function(e){return this._invoke("next",e)},S.prototype.throw=function(e){return this._invoke("throw",e)},S.prototype.return=function(e){return this._invoke("return",e)},"undefined"!=typeof window&&(window.__XEOKIT__={version:"2.6.91",commit:"2db2a75dcf9d25eb41ff787cc12a1723e194eb92",built:"2025-10-06T08:15:55.730Z"});var O,N,V,Q,H,G,j,z,W,X,K,Z=function(){function e(t,i){k(this,e),this.items=t||[],this._lastUniqueId=(i||0)+1}return I(e,[{key:"addItem",value:function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){var i=this._lastUniqueId++;if(!this.items[i])return this.items[i]=e,i}}},{key:"removeItem",value:function(e){var t=this.items[e];return delete this.items[e],t}}]),e}(),J=new Z,Y=I((function e(t){k(this,e),this.id=t,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0})),q=I((function e(){k(this,e),this.items=[]})),$=I((function e(t,i,r,n,s){k(this,e),this.id=t,this.getTitle=i,this.doAction=r,this.getEnabled=n,this.getShown=s,this.itemElement=null,this.subMenu=null,this.enabled=!0})),ee=function(){function e(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this._id=J.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._parentNode=i.parentNode||document.body,this._offsetParent=this._parentNode instanceof ShadowRoot?this._parentNode.host:this._parentNode,this._eventSubs={},!1!==i.hideOnMouseDown&&(this._parentNode.addEventListener("mousedown",(function(e){e.target.classList.contains("xeokit-context-menu-item")||t.hide()})),this._parentNode.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){e.target.classList.contains("xeokit-context-menu-item")||t.hide()})),i.items&&(this.items=i.items),this._hideOnAction=!1!==i.hideOnAction,this.context=i.context,this.enabled=!1!==i.enabled,this.hide()}return I(e,[{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"items",get:function(){return this._itemsCfg},set:function(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}},{key:"enabled",get:function(){return this._enabled},set:function(e){(e=!!e)!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}},{key:"context",get:function(){return this._context},set:function(e){this._context=e}},{key:"show",value:function(e,t){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._updateSubMenuInfo(),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first")}},{key:"shown",get:function(){return this._shown}},{key:"hide",value:function(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}},{key:"destroy",value:function(){this._context=null,this._clear(),null!==this._id&&(J.removeItem(this._id),this._id=null)}},{key:"_clear",value:function(){for(var e=0,t=this._menuList.length;e<t;e++){this._menuList[e].menuElement.remove()}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}},{key:"_parseItems",value:function(e){var t=this;this._rootMenu=function e(i){for(var r=t._getNextId(),n=new Y(r),s=0,o=i.length;s<o;s++){var a=i[s],l=new q;n.groups.push(l);for(var u=function(i,r){var s=a[i],o=s.items,u=o&&o.length>0,A=t._getNextId(),c=s.getTitle||function(){return s.title||""},h=s.doAction||s.callback||function(){},d=s.getEnabled||function(){return!0},p=s.getShown||function(){return!0},f=new $(A,c,h,d,p);if(f.parentMenu=n,l.items.push(f),u){var v=e(o);f.subMenu=v,v.parentItem=f}t._itemList.push(f),t._itemMap[f.id]=f},A=0,c=a.length;A<c;A++)u(A)}return t._menuList.push(n),t._menuMap[n.id]=n,n}(e)}},{key:"_getNextId",value:function(){return"ContextMenu_"+this._id+"_"+this._nextId++}},{key:"_createUI",value:function(){var e=this;!function t(i){e._createMenuUI(i);for(var r=i.groups,n=0,s=r.length;n<s;n++)for(var o=r[n].items,a=0,l=o.length;a<l;a++){var u=o[a].subMenu;u&&t(u)}}(this._rootMenu)}},{key:"_createMenuUI",value:function(e){var t=this,i=e.groups,r=[],n=document.createElement("div");if(n.classList.add("xeokit-context-menu",e.id),n.style.zIndex=3e5,n.style.position="absolute",r.push("<ul>"),i)for(var s=0,o=i.length;s<o;s++){var a=s,l=o,u=i[s].items;if(u)for(var A=0,c=u.length;A<c;A++){var h=u[A],d=h.subMenu,p=h.title||"";d?(r.push('<li id="'+h.id+'" class="xeokit-context-menu-item xeokit-context-menu-submenu">'+p+"</li>"),a===l-1||A<c-1||r.push('<li id="'+h.id+'" class="xeokit-context-menu-item-separator"></li>')):(r.push('<li id="'+h.id+'" class="xeokit-context-menu-item">'+p+"</li>"),a===l-1||A<c-1||r.push('<li id="'+h.id+'" class="xeokit-context-menu-item-separator"></li>'))}}r.push("</ul>");var f=r.join("");n.innerHTML=f,this._parentNode.appendChild(n),e.menuElement=n,n.style["border-radius"]="4px",n.style.display="none",n.style["z-index"]=3e5,n.style.background="white",n.style.border="1px solid black",n.style["box-shadow"]="0 4px 5px 0 gray",n.oncontextmenu=function(e){e.preventDefault()};var v=this,g=null;if(i)for(var m=0,_=i.length;m<_;m++){var y=i[m].items;if(y)for(var b=function(e,i){var r=y[e],n=r.subMenu;if(r.itemElement=t._parentNode.querySelector("#".concat(r.id)),!r.itemElement)return console.error("ContextMenu item element not found: "+r.id),"continue";r.itemElement.addEventListener("mouseenter",(function(e){e.preventDefault();var t=r.subMenu;if(t){if(g&&g.id!==t.id&&(v._hideMenu(g.id),g=null),!1!==r.enabled){var i=r.itemElement,n=t.menuElement,s=i.getBoundingClientRect();n.getBoundingClientRect();var o=v._offsetParent.getBoundingClientRect(),a=200,l=s.right+a<o.right,u=s.left-a>o.left;if(l)v._showMenu(t.id,s.right+window.scrollX-5,s.top+window.scrollY-1);else if(u)v._showMenu(t.id,s.left-a+window.scrollX,s.top+window.scrollY-1);else{var A=s.left-o.left,c=o.right-s.right;c>A?v._showMenu(t.id,s.right-5-(a-c),s.top+window.scrollY-1):v._showMenu(t.id,s.left-A,s.top+window.scrollY-1)}g=t}}else g&&(v._hideMenu(g.id),g=null)})),n||(r.itemElement.addEventListener("click",(function(e){e.preventDefault(),v._context&&!1!==r.enabled&&(r.doAction&&r.doAction(v._context),t._hideOnAction?v.hide():(v._updateItemsTitles(),v._updateItemsEnabledStatus()))})),r.itemElement.addEventListener("mouseup",(function(e){3===e.which&&(e.preventDefault(),v._context&&!1!==r.enabled&&(r.doAction&&r.doAction(v._context),t._hideOnAction?v.hide():(v._updateItemsTitles(),v._updateItemsEnabledStatus())))})),r.itemElement.addEventListener("mouseenter",(function(e){e.preventDefault(),!1!==r.enabled&&r.doHover&&r.doHover(v._context)})))},w=0,B=y.length;w<B;w++)b(w)}}},{key:"_updateItemsTitles",value:function(){if(this._context)for(var e=0,t=this._itemList.length;e<t;e++){var i=this._itemList[e],r=i.itemElement;if(r){var n=i.getShown;if(n&&n(this._context)){var s=i.getTitle(this._context);i.subMenu,r.innerText=s}}}}},{key:"_updateItemsEnabledStatus",value:function(){if(this._context)for(var e=0,t=this._itemList.length;e<t;e++){var i=this._itemList[e],r=i.itemElement;if(r){var n=i.getEnabled;if(n){var s=i.getShown;if(s){var o=s(this._context);if(i.shown=o,o){r.style.display="";var a=n(this._context);i.enabled=a,a?r.classList.remove("disabled"):r.classList.add("disabled")}else r.style.display="none"}}}}}},{key:"_updateSubMenuInfo",value:function(){var e,t,i,r,n,s;this._context&&this._itemList.forEach((function(o){o.subMenu&&(e=o.itemElement,t=e.getBoundingClientRect(),i=o.subMenu.menuElement,r={visibility:i.style.visibility,display:i.style.display},i.style.display="block",i.style.visibility="hidden",s=o.subMenu.menuElement.getBoundingClientRect().width,i.style.visibility=r.visibility,i.style.display=r.display,n=t.right+s>window.innerWidth,e.setAttribute("data-submenuposition",n?"left":"right"))}))}},{key:"_showMenu",value:function(e,t,i){var r=this._menuMap[e];if(r){if(!r.shown){var n=r.menuElement;n&&(this._showMenuElement(n,t,i),r.shown=!0)}}else console.error("Menu not found: "+e)}},{key:"_hideMenu",value:function(e){var t=this._menuMap[e];if(t){if(t.shown){var i=t.menuElement;i&&(this._hideMenuElement(i),t.shown=!1)}}else console.error("Menu not found: "+e)}},{key:"_hideAllMenus",value:function(){for(var e=0,t=this._menuList.length;e<t;e++){var i=this._menuList[e];this._hideMenu(i.id)}}},{key:"_showMenuElement",value:function(e,t,i){e.style.display="block";var r=e.offsetHeight,n=e.offsetWidth,s=this._offsetParent.getBoundingClientRect(),o=this._offsetParent===window.document.body&&0===s.bottom?window.innerHeight:s.bottom+window.scrollY,a=s.right+window.scrollX;i+r>o&&(i=o-r),t+n>a&&(t=a-n),e.style.left=t-s.left-window.scrollX+"px",e.style.top=i-s.top-window.scrollY+"px"}},{key:"_hideMenuElement",value:function(e){e.style.display="none"}}]),e}(),te=function(){function e(t){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this.viewer=t,this.scene=this.viewer.scene,this._lensCursorDiv=document.createElement("div"),this._lensParams={canvasSize:300,cursorBorder:2,cursorSize:10},this._lensCursorDiv.style.borderRadius="50%",this._lensCursorDiv.style.width=this._lensParams.cursorSize+"px",this._lensCursorDiv.style.height=this._lensParams.cursorSize+"px",this._lensCursorDiv.style.zIndex="100000",this._lensCursorDiv.style.position="absolute",this._lensCursorDiv.style.pointerEvents="none",this._lensContainer=document.createElement("div"),this._lensContainerId=r.containerId||"xeokit-lens",this._lensContainer.setAttribute("id",this._lensContainerId),this._lensContainer.style.border="1px solid black",this._lensContainer.style.background="white",this._lensContainer.style.borderRadius="50%",this._lensContainer.style.width=this._lensParams.canvasSize+"px",this._lensContainer.style.height=this._lensParams.canvasSize+"px",this._lensContainer.style.zIndex="15000",this._lensContainer.style.position="absolute",this._lensContainer.style.pointerEvents="none",this._lensContainer.style.visibility="hidden",this._lensCanvas=document.createElement("canvas"),this._lensCanvas.id="".concat(this._lensContainerId,"-canvas"),this._lensCanvas.style.borderRadius="50%",this._lensCanvas.style.width=this._lensParams.canvasSize+"px",this._lensCanvas.style.height=this._lensParams.canvasSize+"px",this._lensCanvas.style.zIndex="15000",this._lensCanvas.style.pointerEvents="none",document.body.appendChild(this._lensContainer),this._lensContainer.appendChild(this._lensCanvas),this._lensContainer.appendChild(this._lensCursorDiv),this._lensCanvasContext=this._lensCanvas.getContext("2d"),this._canvasElement=this.viewer.scene.canvas.canvas,this._canvasPos=null,this._snappedCanvasPos=null,this._lensPosToggle=r.lensPosToggle||!0,this._lensPosToggleAmount=r.lensPosToggleAmount||85,this._lensPosMarginLeft=r.lensPosMarginLeft||85,this._lensPosMarginTop=r.lensPosMarginTop||25,this._lensContainer.style.marginTop="".concat(this._lensPosMarginTop,"px"),this._lensContainer.style.marginLeft="".concat(this._lensPosMarginLeft,"px"),this._zoomLevel=r.zoomLevel||2,this._active=!1!==r.active,this._visible=!1,this.snapped=!1,this._onViewerRendering=this.viewer.scene.on("rendering",(function(){i._active&&i._visible&&i.update()}))}return I(e,[{key:"update",value:function(){if(this._active&&this._visible&&this._canvasPos){var e=this._lensContainer.getBoundingClientRect(),t=this._canvasElement.getBoundingClientRect(),i=this._canvasPos[0]<e.right&&this._canvasPos[0]>e.left&&this._canvasPos[1]<e.bottom&&this._canvasPos[1]>e.top;this._lensContainer.style.marginLeft="".concat(this._lensPosMarginLeft,"px"),i&&(this._lensPosToggle?this._lensContainer.style.marginTop="".concat(t.bottom-t.top-this._lensCanvas.height-this._lensPosToggleAmount,"px"):this._lensContainer.style.marginTop="".concat(this._lensPosMarginTop,"px"),this._lensPosToggle=!this._lensPosToggle),this._lensCanvasContext.clearRect(0,0,this._lensCanvas.width,this._lensCanvas.height);var r=Math.max(this._lensCanvas.width,this._lensCanvas.height)/this._zoomLevel;this._lensCanvasContext.drawImage(this._canvasElement,this._canvasPos[0]-r/2,this._canvasPos[1]-r/2,r,r,0,0,this._lensCanvas.width,this._lensCanvas.height);var n=this._lensParams.canvasSize/2-this._lensParams.cursorSize/2-this._lensParams.cursorBorder,s=this._snappedCanvasPos?this._snappedCanvasPos[0]-this._canvasPos[0]:0,o=this._snappedCanvasPos?this._snappedCanvasPos[1]-this._canvasPos[1]:0;this._lensCursorDiv.style.left="".concat(n+s*this._zoomLevel,"px"),this._lensCursorDiv.style.top="".concat(n+o*this._zoomLevel,"px")}}},{key:"zoomFactor",get:function(){return this._zoomFactor},set:function(e){this._zoomFactor=e,this.update()}},{key:"canvasPos",get:function(){return this._canvasPos},set:function(e){this._canvasPos=e,this.update()}},{key:"snappedCanvasPos",get:function(){return this._snappedCanvasPos},set:function(e){this._snappedCanvasPos=e,this.update()}},{key:"snapped",get:function(){return this._snapped},set:function(e){this._snapped=e;var t=C(e?["greenyellow","green"]:["pink","red"],2),i=t[0],r=t[1];this._lensCursorDiv.style.background=i,this._lensCursorDiv.style.border=this._lensParams.cursorBorder+"px solid "+r}},{key:"_updateActiveVisible",value:function(){this._lensContainer.style.visibility=this._active&&this._visible?"visible":"hidden",this.update()}},{key:"active",get:function(){return this._active},set:function(e){this._active=e,this._updateActiveVisible()}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible=e,this._updateActiveVisible()}},{key:"destroy",value:function(){this._destroyed||(this.viewer.scene.off(this._onViewerRendering),this._lensContainer.removeChild(this._lensCanvas),document.body.removeChild(this._lensContainer),this._destroyed=!0)}}]),e}(),ie=!0,re=ie?Float64Array:Float32Array,ne=new re(3),se=new re(16),oe=new re(16),ae=new re(4),le={setDoublePrecisionEnabled:function(e){re=(ie=e)?Float64Array:Float32Array},getDoublePrecisionEnabled:function(){return ie},MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,MAX_INT:1e7,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId:function(e,t){var i=t.indexOf("#");return i===e.length&&t.startsWith(e)?t.substring(i+1):t},globalizeObjectId:function(e,t){return e+"#"+t},safeInv:function(e){var t=1/e;return isNaN(t)||!isFinite(t)?1:t},vec2:function(e){return new re(e||2)},vec3:function(e){return new re(e||3)},vec4:function(e){return new re(e||4)},mat3:function(e){return new re(e||9)},mat3ToMat4:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new re(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},mat4:function(e){return new re(e||16)},mat4ToMat3:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new re(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},doublesToFloats:function(e,t,i){for(var r=new re(2),n=0,s=e.length;n<s;n++)le.splitDouble(e[n],r),t[n]=r[0],i[n]=r[1]},splitDouble:function(e,t){var i=re.from([e])[0],r=e-i;t[0]=i,t[1]=r},createUUID:function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return function(){var t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return"".concat(e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255],"-").concat(e[255&i]).concat(e[i>>8&255],"-").concat(e[i>>16&15|64]).concat(e[i>>24&255],"-").concat(e[63&r|128]).concat(e[r>>8&255],"-").concat(e[r>>16&255]).concat(e[r>>24&255]).concat(e[255&n]).concat(e[n>>8&255]).concat(e[n>>16&255]).concat(e[n>>24&255])}}(),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},fmod:function(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},compareVec3:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},compareVec4:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},negateVec3:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},negateVec4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},addVec4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i},addVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i},addVec3:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i},addVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i},subVec4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i},subVec3:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i},subVec2:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i},geometricMeanVec2:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=new re(t[0]),n=1;n<t.length;n++)r[0]+=t[n][0],r[1]+=t[n][1];return r[0]/=t.length,r[1]/=t.length,r},subVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i},subScalarVec4:function(e,t,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i},mulVec4:function(e,t,i){return i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i},mulVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i},mulVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i},mulVec2Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i},divVec3:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i},divVec4:function(e,t,i){return i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i},divScalarVec3:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i},divVec3Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i},divVec4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i},divScalarVec4:function(e,t,i){return i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i},dotVec4:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},cross3Vec4:function(e,t){var i=e[0],r=e[1],n=e[2],s=t[0],o=t[1],a=t[2];return[r*a-n*o,n*s-i*a,i*o-r*s,0]},cross3Vec3:function(e,t,i){i||(i=e);var r=e[0],n=e[1],s=e[2],o=t[0],a=t[1],l=t[2];return i[0]=n*l-s*a,i[1]=s*o-r*l,i[2]=r*a-n*o,i},sqLenVec4:function(e){return le.dotVec4(e,e)},lenVec4:function(e){return Math.sqrt(le.sqLenVec4(e))},dotVec3:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dotVec2:function(e,t){return e[0]*t[0]+e[1]*t[1]},sqLenVec3:function(e){return le.dotVec3(e,e)},sqLenVec2:function(e){return le.dotVec2(e,e)},lenVec3:function(e){return Math.sqrt(le.sqLenVec3(e))},distVec3:(K=new re(3),function(e,t){return le.lenVec3(le.subVec3(e,t,K))}),lenVec2:function(e){return Math.sqrt(le.sqLenVec2(e))},distVec2:function(){var e=new re(2);return function(t,i){return le.lenVec2(le.subVec2(t,i,e))}}(),rcpVec3:function(e,t){return le.divScalarVec3(1,e,t)},normalizeVec4:function(e,t){var i=1/le.lenVec4(e);return le.mulVec4Scalar(e,i,t)},normalizeVec3:function(e,t){var i=1/le.lenVec3(e);return le.mulVec3Scalar(e,i,t)},normalizeVec2:function(e,t){var i=1/le.lenVec2(e);return le.mulVec2Scalar(e,i,t)},angleVec3:function(e,t){var i=le.dotVec3(e,t)/Math.sqrt(le.sqLenVec3(e)*le.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:function(){var e=new re(3);return function(t,i){return e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=le.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=le.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=le.lenVec3(e),i}}(),vecToArray:function(){function e(e){return Math.round(1e5*e)/1e5}return function(t){for(var i=0,r=(t=Array.prototype.slice.call(t)).length;i<r;i++)t[i]=e(t[i]);return t}}(),xyzArrayToObject:function(e){return{x:e[0],y:e[1],z:e[2]}},xyzObjectToArray:function(e,t){return(t=t||le.vec3())[0]=e.x,t[1]=e.y,t[2]=e.z,t},dupMat4:function(e){return e.slice(0,16)},mat4To3:function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]},m4s:function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]},setMat4ToZeroes:function(){return le.m4s(0)},setMat4ToOnes:function(){return le.m4s(1)},diagonalMat4v:function(e){return new re([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]])},diagonalMat4c:function(e,t,i,r){return le.diagonalMat4v([e,t,i,r])},diagonalMat4s:function(e){return le.diagonalMat4c(e,e,e,e)},identityMat4:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new re(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},identityMat3:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new re(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},isIdentityMat4:function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]},negateMat4:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},addMat4:function(e,t,i){return i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i},addMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i},addScalarMat4:function(e,t,i){return le.addMat4Scalar(t,e,i)},subMat4:function(e,t,i){return i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i},subMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i},subScalarMat4:function(e,t,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i},mulMat4:function(e,t,i){i||(i=e);var r=e[0],n=e[1],s=e[2],o=e[3],a=e[4],l=e[5],u=e[6],A=e[7],c=e[8],h=e[9],d=e[10],p=e[11],f=e[12],v=e[13],g=e[14],m=e[15],_=t[0],y=t[1],b=t[2],w=t[3],B=t[4],x=t[5],P=t[6],C=t[7],M=t[8],F=t[9],k=t[10],E=t[11],I=t[12],T=t[13],D=t[14],S=t[15];return i[0]=_*r+y*a+b*c+w*f,i[1]=_*n+y*l+b*h+w*v,i[2]=_*s+y*u+b*d+w*g,i[3]=_*o+y*A+b*p+w*m,i[4]=B*r+x*a+P*c+C*f,i[5]=B*n+x*l+P*h+C*v,i[6]=B*s+x*u+P*d+C*g,i[7]=B*o+x*A+P*p+C*m,i[8]=M*r+F*a+k*c+E*f,i[9]=M*n+F*l+k*h+E*v,i[10]=M*s+F*u+k*d+E*g,i[11]=M*o+F*A+k*p+E*m,i[12]=I*r+T*a+D*c+S*f,i[13]=I*n+T*l+D*h+S*v,i[14]=I*s+T*u+D*d+S*g,i[15]=I*o+T*A+D*p+S*m,i},mulMat3:function(e,t,i){i||(i=new re(9));var r=e[0],n=e[3],s=e[6],o=e[1],a=e[4],l=e[7],u=e[2],A=e[5],c=e[8],h=t[0],d=t[3],p=t[6],f=t[1],v=t[4],g=t[7],m=t[2],_=t[5],y=t[8];return i[0]=r*h+n*f+s*m,i[3]=r*d+n*v+s*_,i[6]=r*p+n*g+s*y,i[1]=o*h+a*f+l*m,i[4]=o*d+a*v+l*_,i[7]=o*p+a*g+l*y,i[2]=u*h+A*f+c*m,i[5]=u*d+A*v+c*_,i[8]=u*p+A*g+c*y,i},mulMat4Scalar:function(e,t,i){return i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i},mulMat4v4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4(),r=t[0],n=t[1],s=t[2],o=t[3];return i[0]=e[0]*r+e[4]*n+e[8]*s+e[12]*o,i[1]=e[1]*r+e[5]*n+e[9]*s+e[13]*o,i[2]=e[2]*r+e[6]*n+e[10]*s+e[14]*o,i[3]=e[3]*r+e[7]*n+e[11]*s+e[15]*o,i},transposeMat4:function(e,t){var i=e[4],r=e[14],n=e[8],s=e[13],o=e[12],a=e[9];if(!t||e===t){var l=e[1],u=e[2],A=e[3],c=e[6],h=e[7],d=e[11];return e[1]=i,e[2]=n,e[3]=o,e[4]=l,e[6]=a,e[7]=s,e[8]=u,e[9]=c,e[11]=r,e[12]=A,e[13]=h,e[14]=d,e}return t[0]=e[0],t[1]=i,t[2]=n,t[3]=o,t[4]=e[1],t[5]=e[5],t[6]=a,t[7]=s,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=r,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3:function(e,t){if(t===e){var i=e[1],r=e[2],n=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=r,t[7]=n}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4:function(e){var t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],o=e[5],a=e[6],l=e[7],u=e[8],A=e[9],c=e[10],h=e[11],d=e[12],p=e[13],f=e[14],v=e[15];return d*A*a*n-u*p*a*n-d*o*c*n+s*p*c*n+u*o*f*n-s*A*f*n-d*A*r*l+u*p*r*l+d*i*c*l-t*p*c*l-u*i*f*l+t*A*f*l+d*o*r*h-s*p*r*h-d*i*a*h+t*p*a*h+s*i*f*h-t*o*f*h-u*o*r*v+s*A*r*v+u*i*a*v-t*A*a*v-s*i*c*v+t*o*c*v},inverseMat4:function(e,t){t||(t=e);var i=e[0],r=e[1],n=e[2],s=e[3],o=e[4],a=e[5],l=e[6],u=e[7],A=e[8],c=e[9],h=e[10],d=e[11],p=e[12],f=e[13],v=e[14],g=e[15],m=i*a-r*o,_=i*l-n*o,y=i*u-s*o,b=r*l-n*a,w=r*u-s*a,B=n*u-s*l,x=A*f-c*p,P=A*v-h*p,C=A*g-d*p,M=c*v-h*f,F=c*g-d*f,k=h*g-d*v,E=1/(m*k-_*F+y*M+b*C-w*P+B*x);return t[0]=(a*k-l*F+u*M)*E,t[1]=(-r*k+n*F-s*M)*E,t[2]=(f*B-v*w+g*b)*E,t[3]=(-c*B+h*w-d*b)*E,t[4]=(-o*k+l*C-u*P)*E,t[5]=(i*k-n*C+s*P)*E,t[6]=(-p*B+v*y-g*_)*E,t[7]=(A*B-h*y+d*_)*E,t[8]=(o*F-a*C+u*x)*E,t[9]=(-i*F+r*C-s*x)*E,t[10]=(p*w-f*y+g*m)*E,t[11]=(-A*w+c*y-d*m)*E,t[12]=(-o*M+a*P-l*x)*E,t[13]=(i*M-r*P+n*x)*E,t[14]=(-p*b+f*_-v*m)*E,t[15]=(A*b-c*_+h*m)*E,t},traceMat4:function(e){return e[0]+e[5]+e[10]+e[15]},translationMat4v:function(e,t){var i=t||le.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v:function(e,t){var i=t||le.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(X=new re(3),function(e,t,i,r){return X[0]=e,X[1]=t,X[2]=i,le.translationMat4v(X,r)}),translationMat4s:function(e,t){return le.translationMat4c(e,e,e,t)},translateMat4v:function(e,t){return le.translateMat4c(e[0],e[1],e[2],t)},translateMat4c:function(e,t,i,r){var n=r[3];r[0]+=n*e,r[1]+=n*t,r[2]+=n*i;var s=r[7];r[4]+=s*e,r[5]+=s*t,r[6]+=s*i;var o=r[11];r[8]+=o*e,r[9]+=o*t,r[10]+=o*i;var a=r[15];return r[12]+=a*e,r[13]+=a*t,r[14]+=a*i,r},setMat4Translation:function(e,t,i){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=e[15],i},rotationMat4v:function(e,t,i){var r,n,s,o,a,l,u=le.normalizeVec4([t[0],t[1],t[2],0],[]),A=Math.sin(e),c=Math.cos(e),h=1-c,d=u[0],p=u[1],f=u[2];return r=d*p,n=p*f,s=f*d,o=d*A,a=p*A,l=f*A,(i=i||le.mat4())[0]=h*d*d+c,i[1]=h*r+l,i[2]=h*s-a,i[3]=0,i[4]=h*r-l,i[5]=h*p*p+c,i[6]=h*n+o,i[7]=0,i[8]=h*s+a,i[9]=h*n-o,i[10]=h*f*f+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(e,t,i,r,n){return le.rotationMat4v(e,[t,i,r],n)},scalingMat4v:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.identityMat4();return t[0]=e[0],t[5]=e[1],t[10]=e[2],t},scalingMat3v:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.identityMat3();return t[0]=e[0],t[4]=e[1],t},scalingMat4c:function(){var e=new re(3);return function(t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,le.scalingMat4v(e,n)}}(),scaleMat4c:function(e,t,i,r){return r[0]*=e,r[4]*=t,r[8]*=i,r[1]*=e,r[5]*=t,r[9]*=i,r[2]*=e,r[6]*=t,r[10]*=i,r[3]*=e,r[7]*=t,r[11]*=i,r},scaleMat4v:function(e,t){var i=e[0],r=e[1],n=e[2];return t[0]*=i,t[4]*=r,t[8]*=n,t[1]*=i,t[5]*=r,t[9]*=n,t[2]*=i,t[6]*=r,t[10]*=n,t[3]*=i,t[7]*=r,t[11]*=n,t},scalingMat4s:function(e){return le.scalingMat4c(e,e,e)},rotationTranslationMat4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.mat4(),r=e[0],n=e[1],s=e[2],o=e[3],a=r+r,l=n+n,u=s+s,A=r*a,c=r*l,h=r*u,d=n*l,p=n*u,f=s*u,v=o*a,g=o*l,m=o*u;return i[0]=1-(d+f),i[1]=c+m,i[2]=h-g,i[3]=0,i[4]=c-m,i[5]=1-(A+f),i[6]=p+v,i[7]=0,i[8]=h+g,i[9]=p-v,i[10]=1-(A+d),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4(),r=le.clamp,n=e[0],s=e[4],o=e[8],a=e[1],l=e[5],u=e[9],A=e[2],c=e[6],h=e[10];return"XYZ"===t?(i[1]=Math.asin(r(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-u,h),i[2]=Math.atan2(-s,n)):(i[0]=Math.atan2(c,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(i[1]=Math.atan2(o,h),i[2]=Math.atan2(a,l)):(i[1]=Math.atan2(-A,n),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(-A,h),i[2]=Math.atan2(-s,l)):(i[1]=0,i[2]=Math.atan2(a,n))):"ZYX"===t?(i[1]=Math.asin(-r(A,-1,1)),Math.abs(A)<.99999?(i[0]=Math.atan2(c,h),i[2]=Math.atan2(a,n)):(i[0]=0,i[2]=Math.atan2(-s,l))):"YZX"===t?(i[2]=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-u,l),i[1]=Math.atan2(-A,n)):(i[0]=0,i[1]=Math.atan2(o,h))):"XZY"===t&&(i[2]=Math.asin(-r(s,-1,1)),Math.abs(s)<.99999?(i[0]=Math.atan2(c,l),i[1]=Math.atan2(o,n)):(i[0]=Math.atan2(-u,h),i[1]=0)),i[0]*=le.RADTODEG,i[1]*=le.RADTODEG,i[2]*=le.RADTODEG,i},composeMat4:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:le.mat4();return le.quaternionToRotationMat4(t,r),le.scaleMat4v(i,r),le.translateMat4v(e,r),r},decomposeMat4:function(){var e=new re(3),t=new re(16);return function(i,r,n,s){e[0]=i[0],e[1]=i[1],e[2]=i[2];var o=le.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];var a=le.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];var l=le.lenVec3(e);le.determinantMat4(i)<0&&(o=-o),r[0]=i[12],r[1]=i[13],r[2]=i[14],t.set(i);var u=1/o,A=1/a,c=1/l;return t[0]*=u,t[1]*=u,t[2]*=u,t[4]*=A,t[5]*=A,t[6]*=A,t[8]*=c,t[9]*=c,t[10]*=c,le.mat4ToQuaternion(t,n),s[0]=o,s[1]=a,s[2]=l,this}}(),getColMat4:function(e,t){var i=4*t;return[e[i],e[i+1],e[i+2],e[i+3]]},setRowMat4:function(e,t,i){e[t]=i[0],e[t+4]=i[1],e[t+8]=i[2],e[t+12]=i[3]},lookAtMat4v:function(e,t,i,r){r||(r=le.mat4());var n,s,o,a,l,u,A,c,h,d,p=e[0],f=e[1],v=e[2],g=i[0],m=i[1],_=i[2],y=t[0],b=t[1],w=t[2];return p===y&&f===b&&v===w?le.identityMat4():(n=p-y,s=f-b,o=v-w,a=m*(o*=d=1/Math.sqrt(n*n+s*s+o*o))-_*(s*=d),l=_*(n*=d)-g*o,u=g*s-m*n,(d=Math.sqrt(a*a+l*l+u*u))?(a*=d=1/d,l*=d,u*=d):(a=0,l=0,u=0),A=s*u-o*l,c=o*a-n*u,h=n*l-s*a,(d=Math.sqrt(A*A+c*c+h*h))?(A*=d=1/d,c*=d,h*=d):(A=0,c=0,h=0),r[0]=a,r[1]=A,r[2]=n,r[3]=0,r[4]=l,r[5]=c,r[6]=s,r[7]=0,r[8]=u,r[9]=h,r[10]=o,r[11]=0,r[12]=-(a*p+l*f+u*v),r[13]=-(A*p+c*f+h*v),r[14]=-(n*p+s*f+o*v),r[15]=1,r)},lookAtMat4c:function(e,t,i,r,n,s,o,a,l){return le.lookAtMat4v([e,t,i],[r,n,s],[o,a,l],[])},orthoMat4c:function(e,t,i,r,n,s,o){o||(o=le.mat4());var a=t-e,l=r-i,u=s-n;return o[0]=2/a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/u,o[11]=0,o[12]=-(e+t)/a,o[13]=-(r+i)/l,o[14]=-(s+n)/u,o[15]=1,o},frustumMat4v:function(e,t,i){i||(i=le.mat4());var r=[e[0],e[1],e[2],0],n=[t[0],t[1],t[2],0];le.addVec4(n,r,se),le.subVec4(n,r,oe);var s=2*r[2],o=oe[0],a=oe[1],l=oe[2];return i[0]=s/o,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=s/a,i[6]=0,i[7]=0,i[8]=se[0]/o,i[9]=se[1]/a,i[10]=-se[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-s*n[2]/l,i[15]=0,i},frustumMat4:function(e,t,i,r,n,s,o){o||(o=le.mat4());var a=t-e,l=r-i,u=s-n;return o[0]=2*n/a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*n/l,o[6]=0,o[7]=0,o[8]=(t+e)/a,o[9]=(r+i)/l,o[10]=-(s+n)/u,o[11]=-1,o[12]=0,o[13]=0,o[14]=-s*n*2/u,o[15]=0,o},perspectiveMat4:function(e,t,i,r,n){var s=[],o=[];return s[2]=i,o[2]=r,o[1]=s[2]*Math.tan(e/2),s[1]=-o[1],o[0]=o[1]*t,s[0]=-o[0],le.frustumMat4v(s,o,n)},compareMat4:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},transformPoint3:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec3(),r=t[0],n=t[1],s=t[2];return i[0]=e[0]*r+e[4]*n+e[8]*s+e[12],i[1]=e[1]*r+e[5]*n+e[9]*s+e[13],i[2]=e[2]*r+e[6]*n+e[10]*s+e[14],i},transformPoint4:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4();return i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i},transformPoints3:function(e,t,i){for(var r,n,s,o,a,l=i||[],u=t.length,A=e[0],c=e[1],h=e[2],d=e[3],p=e[4],f=e[5],v=e[6],g=e[7],m=e[8],_=e[9],y=e[10],b=e[11],w=e[12],B=e[13],x=e[14],P=e[15],C=0;C<u;++C)r=(o=t[C])[0],n=o[1],s=o[2],(a=l[C]||(l[C]=[0,0,0]))[0]=A*r+p*n+m*s+w,a[1]=c*r+f*n+_*s+B,a[2]=h*r+v*n+y*s+x,a[3]=d*r+g*n+b*s+P;return l.length=u,l},transformPositions3:function(e,t){var i,r,n,s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,a=t.length,l=e[0],u=e[1],A=e[2];e[3];var c=e[4],h=e[5],d=e[6];e[7];var p=e[8],f=e[9],v=e[10];e[11];var g=e[12],m=e[13],_=e[14];for(e[15],i=0;i<a;i+=3)r=t[i+0],n=t[i+1],s=t[i+2],o[i+0]=l*r+c*n+p*s+g,o[i+1]=u*r+h*n+f*s+m,o[i+2]=A*r+d*n+v*s+_;return o},transformPositions4:function(e,t){var i,r,n,s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,a=t.length,l=e[0],u=e[1],A=e[2],c=e[3],h=e[4],d=e[5],p=e[6],f=e[7],v=e[8],g=e[9],m=e[10],_=e[11],y=e[12],b=e[13],w=e[14],B=e[15];for(i=0;i<a;i+=4)r=t[i+0],n=t[i+1],s=t[i+2],o[i+0]=l*r+h*n+v*s+y,o[i+1]=u*r+d*n+g*s+b,o[i+2]=A*r+p*n+m*s+w,o[i+3]=c*r+f*n+_*s+B;return o},transformVec3:function(e,t,i){var r=t[0],n=t[1],s=t[2];return(i=i||this.vec3())[0]=e[0]*r+e[4]*n+e[8]*s,i[1]=e[1]*r+e[5]*n+e[9]*s,i[2]=e[2]*r+e[6]*n+e[10]*s,i},transformVec4:function(e,t,i){var r=t[0],n=t[1],s=t[2],o=t[3];return(i=i||le.vec4())[0]=e[0]*r+e[4]*n+e[8]*s+e[12]*o,i[1]=e[1]*r+e[5]*n+e[9]*s+e[13]*o,i[2]=e[2]*r+e[6]*n+e[10]*s+e[14]*o,i[3]=e[3]*r+e[7]*n+e[11]*s+e[15]*o,i},rotateVec2:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,n=Math.cos(i),s=Math.sin(i),o=e[0]-t[0],a=e[1]-t[1];return r[0]=o*n-a*s+t[0],r[1]=o*s+a*n+t[1],e},rotateVec3X:function(e,t,i,r){var n=[],s=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],s[0]=n[0],s[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),s[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),r[0]=s[0]+t[0],r[1]=s[1]+t[1],r[2]=s[2]+t[2],r},rotateVec3Y:function(e,t,i,r){var n=[],s=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],s[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),s[1]=n[1],s[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),r[0]=s[0]+t[0],r[1]=s[1]+t[1],r[2]=s[2]+t[2],r},rotateVec3Z:function(e,t,i,r){var n=[],s=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],s[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),s[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),s[2]=n[2],r[0]=s[0]+t[0],r[1]=s[1]+t[1],r[2]=s[2]+t[2],r},projectVec4:function(e,t){var i=1/e[3];return(t=t||le.vec2())[0]=e[0]*i,t[1]=e[1]*i,t},unprojectVec3:(j=new re(16),z=new re(16),W=new re(16),function(e,t,i,r){return this.transformVec3(this.mulMat4(this.inverseMat4(t,j),this.inverseMat4(i,z),W),e,r)}),lerpVec3:function(e,t,i,r,n,s){var o=s||le.vec3(),a=(e-t)/(i-t);return o[0]=r[0]+a*(n[0]-r[0]),o[1]=r[1]+a*(n[1]-r[1]),o[2]=r[2]+a*(n[2]-r[2]),o},lerpMat4:function(e,t,i,r,n,s){var o=s||le.mat4(),a=(e-t)/(i-t);return o[0]=r[0]+a*(n[0]-r[0]),o[1]=r[1]+a*(n[1]-r[1]),o[2]=r[2]+a*(n[2]-r[2]),o[3]=r[3]+a*(n[3]-r[3]),o[4]=r[4]+a*(n[4]-r[4]),o[5]=r[5]+a*(n[5]-r[5]),o[6]=r[6]+a*(n[6]-r[6]),o[7]=r[7]+a*(n[7]-r[7]),o[8]=r[8]+a*(n[8]-r[8]),o[9]=r[9]+a*(n[9]-r[9]),o[10]=r[10]+a*(n[10]-r[10]),o[11]=r[11]+a*(n[11]-r[11]),o[12]=r[12]+a*(n[12]-r[12]),o[13]=r[13]+a*(n[13]-r[13]),o[14]=r[14]+a*(n[14]-r[14]),o[15]=r[15]+a*(n[15]-r[15]),o},flatten:function(e){var t,i,r,n,s,o=[];for(t=0,i=e.length;t<i;t++)for(r=0,n=(s=e[t]).length;r<n;r++)o.push(s[r]);return o},identityQuaternion:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:le.vec4();return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},eulerToQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4(),r=e[0]*le.DEGTORAD/2,n=e[1]*le.DEGTORAD/2,s=e[2]*le.DEGTORAD/2,o=Math.cos(r),a=Math.cos(n),l=Math.cos(s),u=Math.sin(r),A=Math.sin(n),c=Math.sin(s);return"XYZ"===t?(i[0]=u*a*l+o*A*c,i[1]=o*A*l-u*a*c,i[2]=o*a*c+u*A*l,i[3]=o*a*l-u*A*c):"YXZ"===t?(i[0]=u*a*l+o*A*c,i[1]=o*A*l-u*a*c,i[2]=o*a*c-u*A*l,i[3]=o*a*l+u*A*c):"ZXY"===t?(i[0]=u*a*l-o*A*c,i[1]=o*A*l+u*a*c,i[2]=o*a*c+u*A*l,i[3]=o*a*l-u*A*c):"ZYX"===t?(i[0]=u*a*l-o*A*c,i[1]=o*A*l+u*a*c,i[2]=o*a*c-u*A*l,i[3]=o*a*l+u*A*c):"YZX"===t?(i[0]=u*a*l+o*A*c,i[1]=o*A*l+u*a*c,i[2]=o*a*c-u*A*l,i[3]=o*a*l-u*A*c):"XZY"===t&&(i[0]=u*a*l-o*A*c,i[1]=o*A*l-u*a*c,i[2]=o*a*c+u*A*l,i[3]=o*a*l+u*A*c),i},mat4ToQuaternion:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec4(),r=e[0],n=e[4],s=e[8],o=e[1],a=e[5],l=e[9],u=e[2],A=e[6],c=e[10],h=r+a+c;return h>0?(t=.5/Math.sqrt(h+1),i[3]=.25/t,i[0]=(A-l)*t,i[1]=(s-u)*t,i[2]=(o-n)*t):r>a&&r>c?(t=2*Math.sqrt(1+r-a-c),i[3]=(A-l)/t,i[0]=.25*t,i[1]=(n+o)/t,i[2]=(s+u)/t):a>c?(t=2*Math.sqrt(1+a-r-c),i[3]=(s-u)/t,i[0]=(n+o)/t,i[1]=.25*t,i[2]=(l+A)/t):(t=2*Math.sqrt(1+c-r-a),i[3]=(o-n)/t,i[0]=(s+u)/t,i[1]=(l+A)/t,i[2]=.25*t),i},vec3PairToQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4(),r=Math.sqrt(le.dotVec3(e,e)*le.dotVec3(t,t)),n=r+le.dotVec3(e,t);return n<1e-8*r?(n=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):le.cross3Vec3(e,t,i),i[3]=n,le.normalizeQuaternion(i)},angleAxisToQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec4(),i=e[3]/2,r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t},quaternionToEuler:function(){var e=new re(16);return function(t,i,r){return r=r||le.vec3(),le.quaternionToRotationMat4(t,e),le.mat4ToEuler(e,i,r),r}}(),mulQuaternions:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec4(),r=e[0],n=e[1],s=e[2],o=e[3],a=t[0],l=t[1],u=t[2],A=t[3];return i[0]=o*a+r*A+n*u-s*l,i[1]=o*l+n*A+s*a-r*u,i[2]=o*u+s*A+r*l-n*a,i[3]=o*A-r*a-n*l-s*u,i},vec3ApplyQuaternion:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:le.vec3(),r=t[0],n=t[1],s=t[2],o=e[0],a=e[1],l=e[2],u=e[3],A=u*r+a*s-l*n,c=u*n+l*r-o*s,h=u*s+o*n-a*r,d=-o*r-a*n-l*s;return i[0]=A*u+d*-o+c*-l-h*-a,i[1]=c*u+d*-a+h*-o-A*-l,i[2]=h*u+d*-l+A*-a-c*-o,i},quaternionToMat4:function(e,t){t=le.identityMat4(t);var i=e[0],r=e[1],n=e[2],s=e[3],o=2*i,a=2*r,l=2*n,u=o*s,A=a*s,c=l*s,h=o*i,d=a*i,p=l*i,f=a*r,v=l*r,g=l*n;return t[0]=1-(f+g),t[1]=d+c,t[2]=p-A,t[4]=d-c,t[5]=1-(h+g),t[6]=v+u,t[8]=p+A,t[9]=v-u,t[10]=1-(h+f),t},quaternionToRotationMat4:function(e,t){var i=e[0],r=e[1],n=e[2],s=e[3],o=i+i,a=r+r,l=n+n,u=i*o,A=i*a,c=i*l,h=r*a,d=r*l,p=n*l,f=s*o,v=s*a,g=s*l;return t[0]=1-(h+p),t[4]=A-g,t[8]=c+v,t[1]=A+g,t[5]=1-(u+p),t[9]=d-f,t[2]=c-v,t[6]=d+f,t[10]=1-(u+h),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=le.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},inverseQuaternion:function(e,t){return le.normalizeQuaternion(le.conjugateQuaternion(e,t))},quaternionToAngleAxis:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec4(),i=(e=le.normalizeQuaternion(e,ae))[3],r=2*Math.acos(i),n=Math.sqrt(1-i*i);return n<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n),t[3]=r,t},AABB3:function(e){return new re(e||6)},AABB2:function(e){return new re(e||4)},OBB3:function(e){return new re(e||32)},OBB2:function(e){return new re(e||16)},Sphere3:function(e,t,i,r){return new re([e,t,i,r])},transformOBB3:function(e,t){var i,r,n,s,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,a=t.length,l=e[0],u=e[1],A=e[2],c=e[3],h=e[4],d=e[5],p=e[6],f=e[7],v=e[8],g=e[9],m=e[10],_=e[11],y=e[12],b=e[13],w=e[14],B=e[15];for(i=0;i<a;i+=4)r=t[i+0],n=t[i+1],s=t[i+2],o[i+0]=l*r+h*n+v*s+y,o[i+1]=u*r+d*n+g*s+b,o[i+2]=A*r+p*n+m*s+w,o[i+3]=c*r+f*n+_*s+B;return o},containsAABB3:function(e,t){return e[0]<=t[0]&&t[3]<=e[3]&&e[1]<=t[1]&&t[4]<=e[4]&&e[2]<=t[2]&&t[5]<=e[5]},getAABB3Diag:function(){var e=new re(3),t=new re(3),i=new re(3);return function(r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],t[0]=r[3],t[1]=r[4],t[2]=r[5],le.subVec3(t,e,i),Math.abs(le.lenVec3(i))}}(),getAABB3DiagPoint:function(){var e=new re(3),t=new re(3),i=new re(3);return function(r,n){e[0]=r[0],e[1]=r[1],e[2]=r[2],t[0]=r[3],t[1]=r[4],t[2]=r[5];var s=le.subVec3(t,e,i),o=n[0]-r[0],a=r[3]-n[0],l=n[1]-r[1],u=r[4]-n[1],A=n[2]-r[2],c=r[5]-n[2];return s[0]+=o>a?o:a,s[1]+=l>u?l:u,s[2]+=A>c?A:c,Math.abs(le.lenVec3(s))}}(),getAABB3Area:function(e){return(e[3]-e[0])*(e[4]-e[1])*(e[5]-e[2])},getAABB3Center:function(e,t){var i=t||le.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center:function(e,t){var i=t||le.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:le.AABB3();return e[0]=le.MAX_DOUBLE,e[1]=le.MAX_DOUBLE,e[2]=le.MAX_DOUBLE,e[3]=le.MIN_DOUBLE,e[4]=le.MIN_DOUBLE,e[5]=le.MIN_DOUBLE,e},AABB3ToOBB3:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.OBB3();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t},positions3ToAABB3:function(){var e=new re(3);return function(t,i,r){i=i||le.AABB3();for(var n,s,o,a=le.MAX_DOUBLE,l=le.MAX_DOUBLE,u=le.MAX_DOUBLE,A=le.MIN_DOUBLE,c=le.MIN_DOUBLE,h=le.MIN_DOUBLE,d=0,p=t.length;d<p;d+=3)r?(e[0]=t[d+0],e[1]=t[d+1],e[2]=t[d+2],le.decompressPosition(e,r,e),n=e[0],s=e[1],o=e[2]):(n=t[d+0],s=t[d+1],o=t[d+2]),n<a&&(a=n),s<l&&(l=s),o<u&&(u=o),n>A&&(A=n),s>c&&(c=s),o>h&&(h=o);return i[0]=a,i[1]=l,i[2]=u,i[3]=A,i[4]=c,i[5]=h,i}}(),OBB3ToAABB3:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.AABB3(),s=le.MAX_DOUBLE,o=le.MAX_DOUBLE,a=le.MAX_DOUBLE,l=le.MIN_DOUBLE,u=le.MIN_DOUBLE,A=le.MIN_DOUBLE,c=0,h=e.length;c<h;c+=4)(t=e[c+0])<s&&(s=t),(i=e[c+1])<o&&(o=i),(r=e[c+2])<a&&(a=r),t>l&&(l=t),i>u&&(u=i),r>A&&(A=r);return n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=u,n[5]=A,n},points3ToAABB3:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.AABB3(),s=le.MAX_DOUBLE,o=le.MAX_DOUBLE,a=le.MAX_DOUBLE,l=le.MIN_DOUBLE,u=le.MIN_DOUBLE,A=le.MIN_DOUBLE,c=0,h=e.length;c<h;c++)(t=e[c][0])<s&&(s=t),(i=e[c][1])<o&&(o=i),(r=e[c][2])<a&&(a=r),t>l&&(l=t),i>u&&(u=i),r>A&&(A=r);return n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=u,n[5]=A,n},points3ToSphere3:function(){var e=new re(3);return function(t,i){i=i||le.vec4();var r,n=0,s=0,o=0,a=t.length;for(r=0;r<a;r++)n+=t[r][0],s+=t[r][1],o+=t[r][2];i[0]=n/a,i[1]=s/a,i[2]=o/a;var l,u=0;for(r=0;r<a;r++)(l=Math.abs(le.lenVec3(le.subVec3(t[r],i,e))))>u&&(u=l);return i[3]=u,i}}(),positions3ToSphere3:function(){var e=new re(3),t=new re(3);return function(i,r){r=r||le.vec4();var n,s=0,o=0,a=0,l=i.length,u=0;for(n=0;n<l;n+=3)s+=i[n],o+=i[n+1],a+=i[n+2];var A,c=l/3;for(r[0]=s/c,r[1]=o/c,r[2]=a/c,n=0;n<l;n+=3)e[0]=i[n],e[1]=i[n+1],e[2]=i[n+2],(A=Math.abs(le.lenVec3(le.subVec3(e,r,t))))>u&&(u=A);return r[3]=u,r}}(),OBB3ToSphere3:function(){var e=new re(3),t=new re(3);return function(i,r){r=r||le.vec4();var n,s=0,o=0,a=0,l=i.length,u=l/4;for(n=0;n<l;n+=4)s+=i[n+0],o+=i[n+1],a+=i[n+2];r[0]=s/u,r[1]=o/u,r[2]=a/u;var A,c=0;for(n=0;n<l;n+=4)e[0]=i[n+0],e[1]=i[n+1],e[2]=i[n+2],(A=Math.abs(le.lenVec3(le.subVec3(e,r,t))))>c&&(c=A);return r[3]=c,r}}(),getSphere3Center:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec3();return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},getPositionsCenter:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec3(),i=0,r=0,n=0,s=0,o=e.length;s<o;s+=3)i+=e[s+0],r+=e[s+1],n+=e[s+2];var a=e.length/3;return t[0]=i/a,t[1]=r/a,t[2]=n/a,t},expandAABB3:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e},expandAABB3Point3:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e},expandAABB3Points3:function(e,t){for(var i,r,n,s=0,o=t.length;s<o;s+=3)i=t[s],r=t[s+1],n=t[s+2],e[0]>i&&(e[0]=i),e[1]>r&&(e[1]=r),e[2]>n&&(e[2]=n),e[3]<i&&(e[3]=i),e[4]<r&&(e[4]=r),e[5]<n&&(e[5]=n);return e},collapseAABB2:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:le.AABB2();return e[0]=le.MAX_DOUBLE,e[1]=le.MAX_DOUBLE,e[2]=le.MIN_DOUBLE,e[3]=le.MIN_DOUBLE,e},point3AABB3Intersect:function(e,t){return e[0]>t[0]||e[3]<t[0]||e[1]>t[1]||e[4]<t[1]||e[2]>t[2]||e[5]<t[2]},point3AABB3AbsoluteIntersect:function(e,t){return e[0]<=t[0]&&e[3]>=t[0]&&e[1]<=t[1]&&e[4]>=t[1]&&e[2]<=t[2]&&e[5]>=t[2]},planeAABB3Intersect:function(e,t,i){var r,n;return e[0]>0?(r=e[0]*i[0],n=e[0]*i[3]):(r=e[0]*i[3],n=e[0]*i[0]),e[1]>0?(r+=e[1]*i[1],n+=e[1]*i[4]):(r+=e[1]*i[4],n+=e[1]*i[1]),e[2]>0?(r+=e[2]*i[2],n+=e[2]*i[5]):(r+=e[2]*i[5],n+=e[2]*i[2]),r<=-t&&n<=-t?-1:r>=-t&&n>=-t?1:0},OBB3ToAABB2:function(e){for(var t,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.AABB2(),s=le.MAX_DOUBLE,o=le.MAX_DOUBLE,a=le.MIN_DOUBLE,l=le.MIN_DOUBLE,u=0,A=e.length;u<A;u+=4)t=e[u+0],i=e[u+1],(t*=r=1/(e[u+3]||1))<s&&(s=t),(i*=r)<o&&(o=i),t>a&&(a=t),i>l&&(l=i);return n[0]=s,n[1]=o,n[2]=a,n[3]=l,n},expandAABB2:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e},expandAABB2Point2:function(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e},AABB2ToCanvas:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,n=.5*(e[0]+1),s=.5*(e[1]+1),o=.5*(e[2]+1),a=.5*(e[3]+1);return r[0]=Math.floor(n*t),r[1]=i-Math.floor(a*i),r[2]=Math.floor(o*t),r[3]=i-Math.floor(s*i),r},tangentQuadraticBezier:function(e,t,i,r){return 2*(1-e)*(i-t)+2*e*(r-i)},tangentQuadraticBezier3:function(e,t,i,r,n){return-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*n},tangentSpline:function(e){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},catmullRomInterpolate:function(e,t,i,r,n){var s=.5*(i-e),o=.5*(r-t),a=n*n;return(2*t-2*i+s+o)*(n*a)+(-3*t+3*i-2*s-o)*a+s*n+t},b2p0:function(e,t){var i=1-e;return i*i*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,i,r){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,r)},b3p0:function(e,t){var i=1-e;return i*i*i*t},b3p1:function(e,t){var i=1-e;return 3*i*i*e*t},b3p2:function(e,t){return 3*(1-e)*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,i,r,n){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,r)+this.b3p3(e,n)},triangleNormal:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:le.vec3(),n=t[0]-e[0],s=t[1]-e[1],o=t[2]-e[2],a=i[0]-e[0],l=i[1]-e[1],u=i[2]-e[2],A=s*u-o*l,c=o*a-n*u,h=n*l-s*a,d=Math.sqrt(A*A+c*c+h*h);return 0===d?(r[0]=0,r[1]=0,r[2]=0):(r[0]=A/d,r[1]=c/d,r[2]=h/d),r},rayTriangleIntersect:function(){var e=new re(3),t=new re(3),i=new re(3),r=new re(3),n=new re(3);return function(s,o,a,l,u,A){A=A||le.vec3();var c=le.subVec3(l,a,e),h=le.subVec3(u,a,t),d=le.cross3Vec3(o,h,i),p=le.dotVec3(c,d);if(p<1e-6)return null;var f=le.subVec3(s,a,r),v=le.dotVec3(f,d);if(v<0||v>p)return null;var g=le.cross3Vec3(f,c,n),m=le.dotVec3(o,g);if(m<0||v+m>p)return null;var _=le.dotVec3(h,g)/p;return A[0]=s[0]+_*o[0],A[1]=s[1]+_*o[1],A[2]=s[2]+_*o[2],A}}(),rayPlaneIntersect:function(){var e=new re(3),t=new re(3),i=new re(3),r=new re(3);return function(n,s,o,a,l,u){u=u||le.vec3(),s=le.normalizeVec3(s,e);var A=le.subVec3(a,o,t),c=le.subVec3(l,o,i),h=le.cross3Vec3(A,c,r);le.normalizeVec3(h,h);var d=-le.dotVec3(o,h),p=-(le.dotVec3(n,h)+d)/le.dotVec3(s,h);return u[0]=n[0]+p*s[0],u[1]=n[1]+p*s[1],u[2]=n[2]+p*s[2],u}}(),cartesianToBarycentric:function(){var e=new re(3),t=new re(3),i=new re(3);return function(r,n,s,o,a){var l=le.subVec3(o,n,e),u=le.subVec3(s,n,t),A=le.subVec3(r,n,i),c=le.dotVec3(l,l),h=le.dotVec3(l,u),d=le.dotVec3(l,A),p=le.dotVec3(u,u),f=le.dotVec3(u,A),v=c*p-h*h;if(0===v)return null;var g=1/v,m=(p*d-h*f)*g,_=(c*f-h*d)*g;return a[0]=1-m-_,a[1]=_,a[2]=m,a}}(),barycentricInsideTriangle:function(e){var t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian:function(e,t,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:le.vec3(),s=e[0],o=e[1],a=e[2];return n[0]=t[0]*s+i[0]*o+r[0]*a,n[1]=t[1]*s+i[1]*o+r[1]*a,n[2]=t[2]*s+i[2]*o+r[2]*a,n},mergeVertices:function(e,t,i,r){var n,s,o,a,l,u,A={},c=[],h=[],d=t?[]:null,p=i?[]:null,f=[],v=Math.pow(10,4),g=0;for(l=0,u=e.length;l<u;l+=3)n=e[l],s=e[l+1],o=e[l+2],void 0===A[a="".concat(Math.round(n*v),"_").concat(Math.round(s*v),"_").concat(Math.round(o*v))]&&(A[a]=h.length/3,h.push(n),h.push(s),h.push(o),t&&(d.push(t[l]),d.push(t[l+1]),d.push(t[l+2])),i&&(p.push(i[g]),p.push(i[g+1]))),c[l/3]=A[a],g+=2;for(l=0,u=r.length;l<u;l++)f[l]=c[r[l]];var m={positions:h,indices:f};return d&&(m.normals=d),p&&(m.uv=p),m},buildNormals:function(){var e=new re(3),t=new re(3),i=new re(3),r=new re(3),n=new re(3),s=new re(3);return function(o,a,l){var u,A,c,h,d,p,f,v,g,m=new Array(o.length/3);for(u=0,A=a.length;u<A;u+=3){c=a[u],h=a[u+1],d=a[u+2],e[0]=o[3*c],e[1]=o[3*c+1],e[2]=o[3*c+2],t[0]=o[3*h],t[1]=o[3*h+1],t[2]=o[3*h+2],i[0]=o[3*d],i[1]=o[3*d+1],i[2]=o[3*d+2],le.subVec3(t,e,r),le.subVec3(i,e,n);var _=le.vec3();le.normalizeVec3(le.cross3Vec3(r,n,s),_),m[c]||(m[c]=[]),m[h]||(m[h]=[]),m[d]||(m[d]=[]),m[c].push(_),m[h].push(_),m[d].push(_)}for(l=l&&l.length===o.length?l:new Float32Array(o.length),u=0,A=m.length;u<A;u++){p=m[u].length,f=0,v=0,g=0;for(var y=0;y<p;y++)f+=m[u][y][0],v+=m[u][y][1],g+=m[u][y][2];l[3*u]=f/p,l[3*u+1]=v/p,l[3*u+2]=g/p}return l}}(),buildTangents:function(){var e=new re(3),t=new re(3),i=new re(3),r=new re(3),n=new re(3),s=new re(3),o=new re(3);return function(a,l,u){for(var A=new Float32Array(a.length),c=0;c<l.length;c+=3){var h=l[c],d=a.subarray(3*h,3*h+3),p=u.subarray(2*h,2*h+2);h=l[c+1];var f=a.subarray(3*h,3*h+3),v=u.subarray(2*h,2*h+2);h=l[c+2];for(var g=a.subarray(3*h,3*h+3),m=u.subarray(2*h,2*h+2),_=le.subVec3(f,d,e),y=le.subVec3(g,d,t),b=le.subVec2(v,p,i),w=le.subVec2(m,p,r),B=1/(b[0]*w[1]-b[1]*w[0]),x=le.mulVec3Scalar(le.subVec3(le.mulVec3Scalar(_,w[1],n),le.mulVec3Scalar(y,b[1],s),o),B,s),P=void 0,C=0;C<3;C++)A[P=3*l[c+C]]+=x[0],A[P+1]+=x[1],A[P+2]+=x[2]}return A}}(),buildPickTriangles:function(e,t,i){for(var r,n,s,o,a,l=t.length,u=i?new Uint16Array(9*l):new Float32Array(9*l),A=new Uint8Array(12*l),c=0,h=0,d=0,p=0;p<l;p+=3)a=c>>24&255,o=c>>16&255,s=c>>8&255,n=255&c,r=3*t[p],u[h++]=e[r],u[h++]=e[r+1],u[h++]=e[r+2],A[d++]=n,A[d++]=s,A[d++]=o,A[d++]=a,r=3*t[p+1],u[h++]=e[r],u[h++]=e[r+1],u[h++]=e[r+2],A[d++]=n,A[d++]=s,A[d++]=o,A[d++]=a,r=3*t[p+2],u[h++]=e[r],u[h++]=e[r+1],u[h++]=e[r+2],A[d++]=n,A[d++]=s,A[d++]=o,A[d++]=a,c++;return{positions:u,colors:A}},faceToVertexNormals:function(e,t){var i,r,n,s,o,a,l,u,A,c,h,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},p=d.smoothNormalsAngleThreshold||20,f={},v=[],g={},m=4,_=Math.pow(10,m);for(l=0,A=e.length;l<A;l+=3){a=l/3,r=e[l],n=e[l+1],s=e[l+2],void 0===f[o="".concat(Math.round(r*_),"_").concat(Math.round(n*_),"_").concat(Math.round(s*_))]?f[o]=[a]:f[o].push(a);var y=le.normalizeVec3([t[l],t[l+1],t[l+2]]);v[a]=y,i=le.vec4([y[0],y[1],y[2],1]),g[a]=i}for(o in f)if(f.hasOwnProperty(o)){var b=f[o],w=b.length;for(l=0;l<w;l++){var B=b[l];for(i=g[B],u=0;u<w;u++)if(l!==u){var x=b[u];c=v[B],h=v[x];var P=Math.abs(le.angleVec3(c,h)/le.DEGTORAD);P<p&&(i[0]+=h[0],i[1]+=h[1],i[2]+=h[2],i[3]+=1)}}}for(l=0,A=t.length;l<A;l+=3)i=g[l/3],t[l+0]=i[0]/i[3],t[l+1]=i[1]/i[3],t[l+2]=i[2]/i[3]},transformRay:function(){var e=new re(4),t=new re(4);return function(i,r,n,s,o){e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,le.transformVec4(i,e,t),s[0]=t[0],s[1]=t[1],s[2]=t[2],e[0]=n[0],e[1]=n[1],e[2]=n[2],le.transformVec3(i,e,t),le.normalizeVec3(t),o[0]=t[0],o[1]=t[1],o[2]=t[2]}}(),canvasPosToWorldRay:(V=new re(16),Q=new re(4),H=new re(4),G=function(e,t,i,r,n){n[0]=e,n[1]=t,n[2]=i,n[3]=1,le.transformVec4(V,n,n),r||le.mulVec4Scalar(n,1/n[3])},function(e,t,i,r,n,s,o){var a="ortho"===r;le.mulMat4(i,t,V),le.inverseMat4(V,V);var l=2*n[0]/e.clientWidth-1,u=1-2*n[1]/e.clientHeight;G(l,u,-1,a,Q),G(l,u,1,a,H),s[0]=Q[0],s[1]=Q[1],s[2]=Q[2],le.subVec3(H,Q,o),le.normalizeVec3(o)}),canvasPosToLocalRay:(O=new re(3),N=new re(3),function(e,t,i,r,n,s,o,a){le.canvasPosToWorldRay(e,t,i,r,s,O,N),le.worldRayToLocalRay(n,O,N,o,a)}),worldRayToLocalRay:function(){var e=new re(16),t=new re(4),i=new re(4);return function(r,n,s,o,a){var l=le.inverseMat4(r,e);t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=1,le.transformVec4(l,t,i),o[0]=i[0],o[1]=i[1],o[2]=i[2],le.transformVec3(l,s,a)}}(),buildKDTree:function(){var e=new Float32Array;function t(i,r,n,s){var o,a,l=new re(6),u={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};for(l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY,o=0,a=i.length;o<a;++o)for(var A=3*i[o],c=0;c<3;++c){var h=3*r[A+c];n[h]<l[0]&&(l[0]=n[h]),n[h]>l[3]&&(l[3]=n[h]),n[h+1]<l[1]&&(l[1]=n[h+1]),n[h+1]>l[4]&&(l[4]=n[h+1]),n[h+2]<l[2]&&(l[2]=n[h+2]),n[h+2]>l[5]&&(l[5]=n[h+2])}if(i.length<20||s>10)return u.triangles=i,u.leaf=!0,u;e[0]=l[3]-l[0],e[1]=l[4]-l[1],e[2]=l[5]-l[2];var d=0;e[1]>e[d]&&(d=1),e[2]>e[d]&&(d=2),u.splitDim=d;var p=(l[d]+l[d+3])/2,f=new Array(i.length),v=0,g=new Array(i.length),m=0;for(o=0,a=i.length;o<a;++o){var _=r[A=3*i[o]],y=3*r[A+1],b=3*r[A+2];n[3*_+d]<=p||n[y+d]<=p||n[b+d]<=p?f[v++]=i[o]:g[m++]=i[o]}return f.length=v,g.length=m,u.left=t(f,r,n,s+1),u.right=t(g,r,n,s+1),u}return function(e,i){for(var r=e.length/3,n=new Array(r),s=0;s<r;++s)n[s]=s;return t(n,e,i,0)}}(),decompressPosition:function(e,t,i){(i=i||e)[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[12],i[r+1]=e[r+1]*t[5]+t[13],i[r+2]=e[r+2]*t[10]+t[14];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[6],i[r+1]=e[r+1]*t[4]+t[7];return i},octDecodeVec2:function(e,t){var i=e[0],r=e[1];i=(2*i+1)/255,r=(2*r+1)/255;var n=1-Math.abs(i)-Math.abs(r);n<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var s=Math.sqrt(i*i+r*r+n*n);return t[0]=i/s,t[1]=r/s,t[2]=n/s,t},octDecodeVec2s:function(e,t){for(var i=0,r=0,n=e.length;i<n;i+=2){var s=e[i+0],o=e[i+1];s=(2*s+1)/255,o=(2*o+1)/255;var a=1-Math.abs(s)-Math.abs(o);a<0&&(s=(1-Math.abs(o))*(s>=0?1:-1),o=(1-Math.abs(s))*(o>=0?1:-1));var l=Math.sqrt(s*s+o*o+a*a);t[r+0]=s/l,t[r+1]=o/l,t[r+2]=a/l,r+=3}return t}};le.buildEdgeIndices=function(){var e=[],t=[],i=[],r=[],n=[],s=0,o=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),u=le.vec3(),A=le.vec3(),c=le.vec3(),h=le.vec3(),d=le.vec3(),p=le.vec3(),f=le.vec3();return function(v,g,m,_){!function(n,s){var o,a,l,u,A,c,h={},d=Math.pow(10,4),p=0;for(A=0,c=n.length;A<c;A+=3)o=n[A],a=n[A+1],l=n[A+2],void 0===h[u=Math.round(o*d)+"_"+Math.round(a*d)+"_"+Math.round(l*d)]&&(h[u]=p/3,e[p++]=o,e[p++]=a,e[p++]=l),t[A/3]=h[u];for(A=0,c=s.length;A<c;A++)r[A]=t[s[A]],i[r[A]]=s[A]}(v,g),function(t,i){s=0;for(var v=0,g=t;v<g;v+=3){var m=3*r[v],_=3*r[v+1],y=3*r[v+2];i?(o[0]=e[m],o[1]=e[m+1],o[2]=e[m+2],a[0]=e[_],a[1]=e[_+1],a[2]=e[_+2],l[0]=e[y],l[1]=e[y+1],l[2]=e[y+2],le.decompressPosition(o,i,u),le.decompressPosition(a,i,A),le.decompressPosition(l,i,c)):(u[0]=e[m],u[1]=e[m+1],u[2]=e[m+2],A[0]=e[_],A[1]=e[_+1],A[2]=e[_+2],c[0]=e[y],c[1]=e[y+1],c[2]=e[y+2]),le.subVec3(c,A,h),le.subVec3(u,A,d),le.cross3Vec3(h,d,p),le.normalizeVec3(p,f);var b=n[s]||(n[s]={normal:le.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],s++}}(g.length,m);for(var y,b,w,B,x,P,C,M,F,k,E=[],I=Math.cos(le.DEGTORAD*_),T={},D=!1,S=0,R=g.length;S<R;S+=3)for(var U=S/3,L=0;L<3;L++)y=r[S+L],b=r[S+(L+1)%3],void 0===T[x=(w=Math.min(y,b))+","+(B=Math.max(y,b))]?T[x]={index1:w,index2:B,face1:U,face2:void 0}:T[x].face2=U;for(x in T)void 0!==(P=T[x]).face2&&(C=n[P.face1].normal,M=n[P.face2].normal,le.dotVec3(C,M)>I)||(F=i[P.index1],k=i[P.index2],(!D&&F>65535||k>65535)&&(D=!0),E.push(F),E.push(k));return D?new Uint32Array(E):new Uint16Array(E)}}(),le.planeClipsPositions3=function(e,t,i){for(var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3,n=0,s=i.length;n<s;n+=r){ne[0]=i[n+0]-e[0],ne[1]=i[n+1]-e[1],ne[2]=i[n+2]-e[2];var o=ne[0]*t[0]+ne[1]*t[1]+ne[2]*t[2];if(o<0)return!0}return!1};var ue=new Float32Array(3),Ae=function(){function e(t){var i=this;if(k(this,e),!t)throw"Parameter expected: cfg";if(!t.viewer)throw"Parameter expected: cfg.viewer";this.viewer=t.viewer,this._maxTreeDepth=t.maxTreeDepth||15,this._root=null,this._needsRebuild=!0,this._onModelLoaded=this.viewer.scene.on("modelLoaded",(function(e){i._needsRebuild=!0})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(function(e){i._needsRebuild=!0}))}return I(e,[{key:"root",get:function(){return this._needsRebuild&&this._rebuild(),this._root}},{key:"_rebuild",value:function(){var e=this.viewer.scene;for(var t in this._root={aabb:e.getAABB()},e.objects){var i=e.objects[t];this._insertEntity(this._root,i,1)}this._needsRebuild=!1}},{key:"_insertEntity",value:function(e,t,i){var r=t.aabb;if(i>=this._maxTreeDepth)return e.entities=e.entities||[],void e.entities.push(t);if(e.left&&le.containsAABB3(e.left.aabb,r))this._insertEntity(e.left,t,i+1);else if(e.right&&le.containsAABB3(e.right.aabb,r))this._insertEntity(e.right,t,i+1);else{var n=e.aabb;ue[0]=n[3]-n[0],ue[1]=n[4]-n[1],ue[2]=n[5]-n[2];var s=0;if(ue[1]>ue[s]&&(s=1),ue[2]>ue[s]&&(s=2),!e.left){var o=n.slice();if(o[s+3]=(n[s]+n[s+3])/2,e.left={aabb:o},le.containsAABB3(o,r))return void this._insertEntity(e.left,t,i+1)}if(!e.right){var a=n.slice();if(a[s]=(n[s]+n[s+3])/2,e.right={aabb:a},le.containsAABB3(a,r))return void this._insertEntity(e.right,t,i+1)}e.entities=e.entities||[],e.entities.push(t)}}},{key:"destroy",value:function(){var e=this.viewer.scene;e.off(this._onModelLoaded),e.off(this._onModelUnloaded),this._root=null,this._needsRebuild=!0}}]),e}(),ce=function(){function e(){k(this,e),this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}return I(e,[{key:"length",get:function(){return this._length}},{key:"shift",value:function(){if(this._index>=this._headLength){var e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}var t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t}},{key:"push",value:function(e){return this._length++,this._tail.push(e),this}},{key:"unshift",value:function(e){return this._head[--this._index]=e,this._length++,this}}]),e}(),he={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var de=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],n=i;n<r;++n)t.push(n);return String.fromCharCode.apply(null,t)})).join("");function pe(e,t){return(t&&4!==t?[0,6]:[0,6,12,18]).map((function(t){return de.substr(parseInt(e/(1<<t))%64,1)})).reverse().join("")}var fe=function(){for(var e={},t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var r=t[i].split("=");if(void 0===e[r[0]])e[r[0]]=decodeURIComponent(r[1]);else if("string"==typeof e[r[0]]){var n=[e[r[0]],decodeURIComponent(r[1])];e[r[0]]=n}else e[r[0]].push(decodeURIComponent(r[1]))}return e}();var ve,ge={xmlToJson:function e(t,i){if(t.nodeType===t.TEXT_NODE){var r=t.nodeValue;if(null===r.match(/^\s+$/))return r}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var n={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var s=0;s<t.attributes.length;s++){var o=t.attributes[s];n[i[o.nodeName]||o.nodeName]=o.nodeValue}for(var a=0;a<t.childNodes.length;a++){(s=e(t.childNodes[a],i))&&n.children.push(s)}return n}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(t){return parseInt(e.substr(t,2),16)}));return pe(t[0],2)+[1,4,7,10,13].map((function(e){return pe((t[e]<<16)+(t[e+1]<<8)+t[e+2])})).join("")},findNodeOfType:function(e,t){var i=[];return function e(r){r.type===t&&i.push(r),(r.children||[]).forEach((function(t){e(t)}))}(e),i},timeout:function(e){return new Promise((function(t,i){setTimeout(t,e)}))},httpRequest:function(e){return new Promise((function(t,i){var r=new XMLHttpRequest;r.open(e.method||"GET",e.url,!0),r.onload=function(e){4===r.readyState&&(200===r.status?t(r.responseXML):i(r.statusText))},r.send(null)}))},loadJSON:function(e,t,i){var r=function(e){};t=t||r,i=i||r;var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",e,!0),n.addEventListener("load",(function(e){var r=e.target.response;if(200===this.status){var n;try{n=JSON.parse(r)}catch(e){i("utils.loadJSON(): Failed to parse JSON response - ".concat(e))}t(n)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(r))}catch(e){i("utils.loadJSON(): Failed to parse JSON response - ".concat(e))}}else i(e)}),!1),n.addEventListener("error",(function(e){i(e)}),!1),n.send(null)},loadArraybuffer:function(e,t,i){var r=function(e){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var s=!!n[2],o=n[3];o=window.decodeURIComponent(o),s&&(o=window.atob(o));try{for(var a=new ArrayBuffer(o.length),l=new Uint8Array(a),u=0;u<o.length;u++)l[u]=o.charCodeAt(u);Fe.scheduleTask((function(){t(a)}))}catch(e){Fe.scheduleTask((function(){i(e)}))}}else{var A=new XMLHttpRequest;A.open("GET",e,!0),A.responseType="arraybuffer",A.onreadystatechange=function(){4===A.readyState&&(200===A.status?t(A.response):i("loadArrayBuffer error : "+A.response))},A.send(null)}},queryString:fe,isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"===P(e)&&"number"==typeof e.length},isString:function(e){return"string"==typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return ge.isString(e)||ge.isNumeric(e)},isSameComponent:function(e,t){return!(!e||!t)&&(ge.isNumeric(e)||ge.isString(e)?"".concat(e):e.id)===(ge.isNumeric(t)||ge.isString(t)?"".concat(t):t.id)},isFunction:function(e){return"function"==typeof e},isObject:function(e){var t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return ge.apply(e,{})},apply:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(var i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return ge.isNumeric(e)?"".concat(e):"'".concat(e,"'")},concat:function(e,t){var i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},flattenParentChildHierarchy:function(e){var t=[];return function e(i){i.id=i.uuid,delete i.oid,t.push(i);var r=i.children;if(r)for(var n=0,s=r.length;n<s;n++){r[n].parent=i.id,e(r[n])}i.children=[]}(e),t}},me={},_e=new Z,ye=new ce,be={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},we=[],Be=0,xe=0;var Pe,Ce,Me,Fe=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(e){if(e.id){if(Fe.scenes[e.id])return void console.error("[ERROR] Scene ".concat(ge.inQuotes(e.id)," already exists"))}else e.id=_e.addItem({});Fe.scenes[e.id]=e;var t=e.ticksPerOcclusionTest,i=e.ticksPerRender;me[e.id]={ticksPerOcclusionTest:t,ticksPerRender:i,renderCountdown:i},he.components.scenes++,e.once("destroyed",(function(){_e.removeItem(e.id),delete Fe.scenes[e.id],delete me[e.id],he.components.scenes--}))},this.clear=function(){var e;for(var t in Fe.scenes)Fe.scenes.hasOwnProperty(t)&&(e=Fe.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete Fe.scenes[e.id]))},this.scheduleTask=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ye.push(e),ye.push(t)},this.runTasks=function(){for(var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,r=(new Date).getTime(),n=0;ye.length>0&&(i<0||r<i);)e=ye.shift(),(t=ye.shift())?e.call(t):e(),r=(new Date).getTime(),n++;return n},this.getNumTasks=function(){return ye.length}},ke=function(){var e=Date.now();if(ve=e-Be,Be>0&&ve>0){var t=1e3/ve;xe+=t,we.push(t),we.length>=30&&(xe-=we.shift()),he.frame.fps=Math.round(xe/we.length)}for(var i in Fe.scenes)Fe.scenes[i].compile();Ee(e),Be=e};Pe=function(){ke()},Ce=100,Me=Date.now()+Ce,function e(){var t=Date.now()-Me;Pe(),Me+=Ce,setTimeout(e,Math.max(0,Ce-t))}();function Ee(e){var t=Fe.runTasks(e+10),i=Fe.getNumTasks();he.frame.tasksRun=t,he.frame.tasksScheduled=i,he.frame.tasksBudget=10}!function e(){var t=Date.now();if(ve=t-Be,Be>0&&ve>0){var i=1e3/ve;xe+=i,we.push(i),we.length>=30&&(xe-=we.shift()),he.frame.fps=Math.round(xe/we.length)}Ee(t),function(e){for(var t in be.time=e,Fe.scenes)if(Fe.scenes.hasOwnProperty(t)){var i=Fe.scenes[t];be.sceneId=t,be.startTime=i.startTime,be.deltaTime=null!=be.prevTime?be.time-be.prevTime:0,i.fire("tick",be,!0)}be.prevTime=e}(t),function(){var e,t,i,r,n,s=Fe.scenes,o=!1;for(n in s)s.hasOwnProperty(n)&&(e=s[n],(t=me[n])||(t=me[n]={}),i=e.ticksPerOcclusionTest,t.ticksPerOcclusionTest!==i&&(t.ticksPerOcclusionTest=i,t.renderCountdown=i),--e.occlusionTestCountdown<=0&&(e.doOcclusionTest(),e.occlusionTestCountdown=i),r=e.ticksPerRender,t.ticksPerRender!==r&&(t.ticksPerRender=r,t.renderCountdown=r),0==--t.renderCountdown&&(e.render(o),t.renderCountdown=r))}(),void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(ke):requestAnimationFrame(e)}();var Ie=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,e),this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=i.viewer;else{if("Scene"===t.type)this.scene=t;else{if(!(t instanceof e))throw"Invalid param: owner must be a Component";this.scene=t.scene}this._owner=t}this._dontClear=!!i.dontClear,this._renderer=this.scene._renderer,this.meta=i.meta||{},this.id=i.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,t&&t._own(this)}return I(e,[{key:"type",get:function(){return"Component"}},{key:"isComponent",get:function(){return!0}},{key:"glRedraw",value:function(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}},{key:"glResort",value:function(){this._renderer&&this._renderer.needStateSort()}},{key:"owner",get:function(){return this._owner}},{key:"isType",value:function(e){return this.type===e}},{key:"fire",value:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);var r,n=this._eventSubs[e];if(n)for(var s in n)n.hasOwnProperty(s)&&(r=n[s],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}},{key:"on",value:function(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Z),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});var r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);var n=this._subIdMap.addItem();r[n]={callback:t,scope:i||this},this._subIdEvents[n]=e;var s=this._events[e];return void 0!==s&&t.call(i||this,s),n}},{key:"off",value:function(e){if(null!=e&&this._subIdEvents){var t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];var i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}}},{key:"once",value:function(e,t,i){var r=this,n=this.on(e,(function(e){r.off(n),t.call(i||this,e)}),i)}},{key:"hasSubs",value:function(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}},{key:"log",value:function(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}},{key:"_message",value:function(e){return" ["+this.type+" "+ge.inQuotes(this.id)+"]: "+e}},{key:"warn",value:function(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}},{key:"error",value:function(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}},{key:"_attach",value:function(e){var t=e.name;if(t){var i=e.component,r=e.sceneDefault,n=e.sceneSingleton,s=e.type,o=e.on,a=!1!==e.recompiles;if(i&&(ge.isNumeric(i)||ge.isString(i))){var l=i;if(!(i=this.scene.components[l]))return void this.error("Component not found: "+ge.inQuotes(l))}if(!i)if(!0===n){var u=this.scene.types[s];for(var A in u)if(u.hasOwnProperty){i=u[A];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===r&&!(i=this.scene[t]))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+ge.inQuotes(i.id));if(s&&!i.isType(s))return void this.error("Expected a "+s+" type or subtype: "+i.type+" "+ge.inQuotes(i.id))}this._attachments||(this._attachments={});var c,h,d,p=this._attached[t];if(p){if(i&&p.id===i.id)return;var f=this._attachments[p.id];for(h=0,d=(c=f.subs).length;h<d;h++)p.off(c[h]);delete this._attached[t],delete this._attachments[p.id];var v=f.params.onDetached;v&&(ge.isFunction(v)?v(p):v.scope?v.callback.call(v.scope,p):v.callback(p)),f.managingLifecycle&&p.destroy()}if(i){var g={params:e,component:i,subs:[],managingLifecycle:!1};g.subs.push(i.once("destroyed",(function(){g.params.component=null,this._attach(g.params)}),this)),a&&g.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[t]=i,this._attachments[i.id]=g;var m,_,y,b,w=e.onAttached;if(w&&(ge.isFunction(w)?w(i):w.scope?w.callback.call(w.scope,i):w.callback(i)),o)for(m in o)if(o.hasOwnProperty(m)){if(_=o[m],ge.isFunction(_)?(y=_,b=null):(y=_.callback,b=_.scope),!y)continue;g.subs.push(i.on(m,y,b))}}return a&&this.fire("dirty",this),this.fire(t,i),i}this.error("Component 'name' expected")}},{key:"_checkComponent",value:function(e,t){if(!t.isComponent){if(!ge.isID(t))return void this.error("Expected a Component or ID");var i=t;if(!(t=this.scene.components[i]))return void this.error("Component not found: "+i)}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type)}else this.error("Expected a "+e+" Component")}},{key:"_checkComponent2",value:function(e,t){if(!t.isComponent){if(!ge.isID(t))return void this.error("Expected a Component or ID");var i=t;if(!(t=this.scene.components[i]))return void this.error("Component not found: "+i)}if(t.scene.id===this.scene.id){for(var r=0,n=e.length;r<n;r++)if(e[r]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type)}},{key:"_own",value:function(e){var t=this;this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",(function(){delete t._ownedComponents[e.id]}),this)}},{key:"_needUpdate",value:function(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():Fe.scheduleTask(this._doUpdate,this))}},{key:"_doUpdate",value:function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}},{key:"scheduleTask",value:function(e){Fe.scheduleTask(e,null)}},{key:"_update",value:function(){}},{key:"clear",value:function(){if(this._ownedComponents)for(var e in this._ownedComponents){if(this._ownedComponents.hasOwnProperty(e))this._ownedComponents[e].destroy(),delete this._ownedComponents[e]}}},{key:"destroy",value:function(){if(!this.destroyed){var e,t,i,r,n,s;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=(t=this._attachments[e]).component,n=0,s=(r=t.subs).length;n<s;n++)i.off(r[n]);t.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&((i=this._ownedComponents[e]).destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}}]),e}(),Te=le.vec3(),De=le.vec3(),Se=le.mat4(),Re=function(){function e(){k(this,e),this.normal=le.vec3(),this.offset=0,this.testVertex=le.vec3()}return I(e,[{key:"set",value:function(e,t,i,r){var n=1/Math.sqrt(e*e+t*t+i*i);this.normal[0]=e*n,this.normal[1]=t*n,this.normal[2]=i*n,this.offset=r*n,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}]),e}(),Ue=I((function e(){k(this,e),this.planes=[new Re,new Re,new Re,new Re,new Re,new Re]}));function Le(e,t,i){var r=le.mulMat4(i,t,Se),n=r[0],s=r[1],o=r[2],a=r[3],l=r[4],u=r[5],A=r[6],c=r[7],h=r[8],d=r[9],p=r[10],f=r[11],v=r[12],g=r[13],m=r[14],_=r[15];e.planes[0].set(a-n,c-l,f-h,_-v),e.planes[1].set(a+n,c+l,f+h,_+v),e.planes[2].set(a-s,c-u,f-d,_-g),e.planes[3].set(a+s,c+u,f+d,_+g),e.planes[4].set(a-o,c-A,f-p,_-m),e.planes[5].set(a+o,c+A,f+p,_+m)}function Oe(e,t){var i=Ue.INSIDE,r=Te,n=De;r[0]=t[0],r[1]=t[1],r[2]=t[2],n[0]=t[3],n[1]=t[4],n[2]=t[5];for(var s=[r,n],o=0;o<6;++o){var a=e.planes[o];if(a.normal[0]*s[a.testVertex[0]][0]+a.normal[1]*s[a.testVertex[1]][1]+a.normal[2]*s[a.testVertex[2]][2]+a.offset<0)return Ue.OUTSIDE;a.normal[0]*s[1-a.testVertex[0]][0]+a.normal[1]*s[1-a.testVertex[1]][1]+a.normal[2]*s[1-a.testVertex[2]][2]+a.offset<0&&(i=Ue.INTERSECT)}return i}Ue.INSIDE=0,Ue.INTERSECT=1,Ue.OUTSIDE=2;var Ne=function(e){m(i,Ie);var t=y(i);function i(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(k(this,i),!r.viewer)throw"[MarqueePicker] Missing config: viewer";if(!r.objectsKdTree3)throw"[MarqueePicker] Missing config: objectsKdTree3";return(e=t.call(this,r.viewer.scene,r)).viewer=r.viewer,e._objectsKdTree3=r.objectsKdTree3,e._canvasMarqueeCorner1=le.vec2(),e._canvasMarqueeCorner2=le.vec2(),e._canvasMarquee=le.AABB2(),e._marqueeFrustum=new Ue,e._marqueeFrustumProjMat=le.mat4(),e._pickMode=!1,e._marqueeElement=document.createElement("div"),document.body.appendChild(e._marqueeElement),e._marqueeElement.style.position="absolute",e._marqueeElement.style["z-index"]="40000005",e._marqueeElement.style.width="8px",e._marqueeElement.style.height="8px",e._marqueeElement.style.visibility="hidden",e._marqueeElement.style.top="0px",e._marqueeElement.style.left="0px",e._marqueeElement.style["box-shadow"]="0 2px 5px 0 #182A3D;",e._marqueeElement.style.opacity=1,e._marqueeElement.style["pointer-events"]="none",e}return I(i,[{key:"setMarqueeCorner1",value:function(e){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(e),this._updateMarquee()}},{key:"setMarqueeCorner2",value:function(e){this._canvasMarqueeCorner2.set(e),this._updateMarquee()}},{key:"setMarquee",value:function(e,t){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(t),this._updateMarquee()}},{key:"setMarqueeVisible",value:function(e){this._marqueVisible=e,this._marqueeElement.style.visibility=e?"visible":"hidden"}},{key:"getMarqueeVisible",value:function(){return this._marqueVisible}},{key:"setPickMode",value:function(e){if(e!==i.PICK_MODE_INSIDE&&e!==i.PICK_MODE_INTERSECTS)throw"Illegal MarqueePicker pickMode: must be MarqueePicker.PICK_MODE_INSIDE or MarqueePicker.PICK_MODE_INTERSECTS";e!==this._pickMode&&(this._marqueeElement.style["background-image"]=e===i.PICK_MODE_INSIDE?"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e\")":"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e\")",this._pickMode=e)}},{key:"getPickMode",value:function(){return this._pickMode}},{key:"clear",value:function(){this.fire("clear",{})}},{key:"pick",value:function(){var e=this;this._updateMarquee(),this._buildMarqueeFrustum();var t=[];return(this._canvasMarquee[2]-this._canvasMarquee[0]>3||this._canvasMarquee[3]-this._canvasMarquee[1]>3)&&function r(n){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ue.INTERSECT;if(s===Ue.INTERSECT&&(s=Oe(e._marqueeFrustum,n.aabb)),s!==Ue.OUTSIDE){if(n.entities)for(var o=n.entities,a=0,l=o.length;a<l;a++){var u=o[a];if(u.visible){var A=u.aabb;if(e._pickMode===i.PICK_MODE_INSIDE)Oe(e._marqueeFrustum,A)===Ue.INSIDE&&t.push(u.id);else Oe(e._marqueeFrustum,A)!==Ue.OUTSIDE&&t.push(u.id)}}n.left&&r(n.left,s),n.right&&r(n.right,s)}}(this._objectsKdTree3.root),this.fire("picked",t),t}},{key:"_updateMarquee",value:function(){this._canvasMarquee[0]=Math.min(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[1]=Math.min(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._canvasMarquee[2]=Math.max(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[3]=Math.max(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._marqueeElement.style.width="".concat(this._canvasMarquee[2]-this._canvasMarquee[0],"px"),this._marqueeElement.style.height="".concat(this._canvasMarquee[3]-this._canvasMarquee[1],"px"),this._marqueeElement.style.left="".concat(this._canvasMarquee[0],"px"),this._marqueeElement.style.top="".concat(this._canvasMarquee[1],"px")}},{key:"_buildMarqueeFrustum",value:function(){var e=this.viewer.scene.canvas.canvas,t=e.clientWidth,i=e.clientHeight,r=e.clientLeft,n=e.clientTop,s=2/t,o=2/i,a=e.clientHeight/e.clientWidth,l=(this._canvasMarquee[0]-r)*s-1,u=(this._canvasMarquee[2]-r)*s-1,A=-(this._canvasMarquee[3]-n)*o+1,c=-(this._canvasMarquee[1]-n)*o+1,h=this.viewer.scene.camera.frustum.near*(17*a);le.frustumMat4(l,u,A*a,c*a,h,1e4,this._marqueeFrustumProjMat),Le(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._marqueeElement.parentElement&&(this._marqueeElement.parentElement.removeChild(this._marqueeElement),this._marqueeElement=null,this._objectsKdTree3=null)}}]),i}();Ne.PICK_MODE_INTERSECTS=0,Ne.PICK_MODE_INSIDE=1;var Ve=function(e){m(i,Ie);var t=y(i);function i(e){var r;k(this,i),r=t.call(this,e.marqueePicker,e);var n,s,o,a,l,u,A,c=e.marqueePicker,h=c.viewer.scene.canvas.canvas,d=!1,p=!1,f=!1;return h.addEventListener("mousedown",(function(e){r.getActive()&&0===e.button&&(A=setTimeout((function(){var t=c.viewer.scene.input;t.keyDown[t.KEY_CTRL]||c.clear(),n=e.pageX,s=e.pageY,l=e.offsetX,c.setMarqueeCorner1([n,s]),d=!0,c.viewer.cameraControl.pointerEnabled=!1,c.setMarqueeVisible(!0),h.style.cursor="crosshair"}),400),p=!0)})),h.addEventListener("mouseup",(function(e){if(r.getActive()&&(d||f)&&0===e.button){clearTimeout(A),o=e.pageX,a=e.pageY;var t=Math.abs(o-n),i=Math.abs(a-s);d=!1,c.viewer.cameraControl.pointerEnabled=!0,f&&(f=!1),(t>3||i>3)&&c.pick()}})),document.addEventListener("mouseup",(function(e){r.getActive()&&0===e.button&&(clearTimeout(A),d&&(c.setMarqueeVisible(!1),d=!1,p=!1,f=!0,c.viewer.cameraControl.pointerEnabled=!0))}),!0),h.addEventListener("mousemove",(function(e){r.getActive()&&0===e.button&&p&&(clearTimeout(A),d&&(o=e.pageX,a=e.pageY,u=e.offsetX,c.setMarqueeVisible(!0),c.setMarqueeCorner2([o,a]),c.setPickMode(l<u?Ne.PICK_MODE_INSIDE:Ne.PICK_MODE_INTERSECTS)))})),r}return I(i,[{key:"setActive",value:function(e){this._active!==e&&(this._active=e,this.fire("active",this._active))}},{key:"getActive",value:function(){return this._active}},{key:"destroy",value:function(){}}]),i}(),Qe=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this.viewer=t,this.scene=this.viewer.scene,this._circleDiv=document.createElement("div"),this.viewer.scene.canvas.canvas.parentNode.insertBefore(this._circleDiv,this.viewer.scene.canvas.canvas),this._circleDiv.style.backgroundColor="transparent",this._circleDiv.style.border="2px solid green",this._circleDiv.style.borderRadius="50px",this._circleDiv.style.width="50px",this._circleDiv.style.height="50px",this._circleDiv.style.margin="-200px -200px",this._circleDiv.style.zIndex="100000",this._circleDiv.style.position="absolute",this._circleDiv.style.pointerEvents="none",this._circlePos=null,this._circleMaxRadius=200,this._circleMinRadius=2,this._active=!1!==i.active,this._visible=!1,this._running=!1,this._destroyed=!1}return I(e,[{key:"start",value:function(e){var t=this;if(!this._destroyed){this._circlePos=e,this._running=!1,this._circleRadius=this._circleMaxRadius,this._circleDiv.style.borderRadius="".concat(this._circleRadius,"px"),this._circleDiv.style.marginLeft="".concat(this._circlePos[0]-this._circleRadius,"px"),this._circleDiv.style.marginTop="".concat(this._circlePos[1]-this._circleRadius,"px");var i,r=this._circleMaxRadius;this._running=!0,requestAnimationFrame((function e(n){if(t._running){i||(i=n);var s=n-i,o=Math.min(s/300,1),a=r+(2-r)*o;t._circleRadius=a,t._circleDiv.style.width="".concat(t._circleRadius,"px"),t._circleDiv.style.height="".concat(t._circleRadius,"px"),t._circleDiv.style.marginLeft="".concat(t._circlePos[0]-t._circleRadius/2,"px"),t._circleDiv.style.marginTop="".concat(t._circlePos[1]-t._circleRadius/2,"px"),o<1&&requestAnimationFrame(e)}})),this._circleDiv.style.visibility="visible"}}},{key:"stop",value:function(){this._destroyed||(this._running=!1,this._circleRadius=this._circleMaxRadius,this._circleDiv.style.borderRadius="".concat(this._circleRadius,"px"),this._circleDiv.style.visibility="hidden")}},{key:"durationMs",get:function(){return this._durationMs},set:function(e){this.stop(),this._durationMs=e}},{key:"destroy",value:function(){this._destroyed||(this.stop(),this._circleDiv.parentElement.removeChild(this._circleDiv),this._destroyed=!0)}}]),e}(),He=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=t.messages,this.locale=t.locale}return I(e,[{key:"messages",set:function(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}},{key:"loadMessages",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t in e)this._messages[t]=e[t];this.messages=this._messages}},{key:"clearMessages",value:function(){this.messages={}}},{key:"locales",get:function(){return this._locales}},{key:"locale",get:function(){return this._locale},set:function(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}},{key:"translate",value:function(e,t){var i=this._messages[this._locale];if(!i)return null;var r=Ge(e,i);return r?t?je(r,t):r:null}},{key:"translatePlurals",value:function(e,t,i){var r=this._messages[this._locale];if(!r)return null;var n=Ge(e,r);return(n=0===(t=parseInt(""+t,10))?n.zero:t>1?n.other:n.one)?(n=je(n,[t]),i&&(n=je(n,i)),n):null}},{key:"fire",value:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);var r=this._eventSubs[e];if(r)for(var n in r){if(r.hasOwnProperty(n))r[n].callback(t)}}},{key:"on",value:function(e,t){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new Z),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});var i=this._eventSubs[e];i||(i={},this._eventSubs[e]=i);var r=this._eventSubIDMap.addItem();i[r]={callback:t},this._eventSubEvents[r]=e;var n=this._events[e];return void 0!==n&&t(n),r}},{key:"off",value:function(e){if(null!=e&&this._eventSubEvents){var t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];var i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}}]),e}();function Ge(e,t){if(t[e])return t[e];for(var i=e.split("."),r=t,n=0,s=i.length;r&&n<s;n++){r=r[i[n]]}return r}function je(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,i){return"{{"===e?"{":"}}"===e?"}":t[i]}))}var ze=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).t=n.t,r}return I(i,[{key:"t",get:function(){return this._t},set:function(e){e=e||0,this._t=e<0?0:e>1?1:e}},{key:"tangent",get:function(){return this.getTangent(this._t)}},{key:"length",get:function(){var e=this._getLengths();return e[e.length-1]}},{key:"getTangent",value:function(e){var t=1e-4;void 0===e&&(e=this._t);var i=e-t,r=e+t;i<0&&(i=0),r>1&&(r=1);var n=this.getPoint(i),s=this.getPoint(r),o=le.subVec3(s,n,[]);return le.normalizeVec3(o,[])}},{key:"getPointAt",value:function(e){var t=this.getUToTMapping(e);return this.getPoint(t)}},{key:"getPoints",value:function(e){e||(e=5);var t,i=[];for(t=0;t<=e;t++)i.push(this.getPoint(t/e));return i}},{key:"_getLengths",value:function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,r=[],n=this.getPoint(0),s=0;for(r.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),s+=le.lenVec3(le.subVec3(t,n,[])),r.push(s),n=t;return this.cacheArcLengths=r,r}},{key:"_updateArcLengths",value:function(){this.needsUpdate=!0,this._getLengths()}},{key:"getUToTMapping",value:function(e,t){var i,r=this._getLengths(),n=0,s=r.length;i=t||e*r[s-1];for(var o,a=0,l=s-1;a<=l;)if((o=r[n=Math.floor(a+(l-a)/2)]-i)<0)a=n+1;else{if(!(o>0)){l=n;break}l=n-1}if(r[n=l]===i)return n/(s-1);var u=r[n];return(n+(i-u)/(r[n+1]-u))/(s-1)}}]),i}(),We=function(e){m(i,ze);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).points=n.points,r.t=n.t,r}return I(i,[{key:"points",get:function(){return this._points},set:function(e){this._points=e||[]}},{key:"t",get:function(){return this._t},set:function(e){e=e||0,this._t=e<0?0:e>1?1:e}},{key:"point",get:function(){return this.getPoint(this._t)}},{key:"getPoint",value:function(e){var t=this.points;if(!(t.length<3)){var i=(t.length-1)*e,r=Math.floor(i),n=i-r,s=t[0===r?r:r-1],o=t[r],a=t[r>t.length-2?t.length-1:r+1],l=t[r>t.length-3?t.length-1:r+2],u=le.vec3();return u[0]=le.catmullRomInterpolate(s[0],o[0],a[0],l[0],n),u[1]=le.catmullRomInterpolate(s[1],o[1],a[1],l[1],n),u[2]=le.catmullRomInterpolate(s[2],o[2],a[2],l[2],n),u}this.error("Can't sample point from SplineCurve - not enough points on curve - returning [0,0,0].")}},{key:"getJSON",value:function(){return{points:points,t:this._t}}}]),i}(),Xe=le.vec3(),Ke=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._frames=[],r._eyeCurve=new We(w(r)),r._lookCurve=new We(w(r)),r._upCurve=new We(w(r)),n.frames&&(r.addFrames(n.frames),r.smoothFrameTimes(1)),r}return I(i,[{key:"type",get:function(){return"CameraPath"}},{key:"frames",get:function(){return this._frames}},{key:"eyeCurve",get:function(){return this._eyeCurve}},{key:"lookCurve",get:function(){return this._lookCurve}},{key:"upCurve",get:function(){return this._upCurve}},{key:"saveFrame",value:function(e){var t=this.scene.camera;this.addFrame(e,t.eye,t.look,t.up)}},{key:"addFrame",value:function(e,t,i,r){var n={t:e,eye:t.slice(0),look:i.slice(0),up:r.slice(0)};this._frames.push(n),this._eyeCurve.points.push(n.eye),this._lookCurve.points.push(n.look),this._upCurve.points.push(n.up)}},{key:"addFrames",value:function(e){for(var t,i=0,r=e.length;i<r;i++)t=e[i],this.addFrame(t.t||0,t.eye,t.look,t.up)}},{key:"loadFrame",value:function(e){var t=this.scene.camera;e=(e/=this._frames[this._frames.length-1].t-this._frames[0].t)<0?0:e>1?1:e,t.eye=this._eyeCurve.getPoint(e,Xe),t.look=this._lookCurve.getPoint(e,Xe),t.up=this._upCurve.getPoint(e,Xe)}},{key:"sampleFrame",value:function(e,t,i,r){e=e<0?0:e>1?1:e,this._eyeCurve.getPoint(e,t),this._lookCurve.getPoint(e,i),this._upCurve.getPoint(e,r)}},{key:"smoothFrameTimes",value:function(e){if(0!==this._frames.length){var t=le.vec3(),i=0;this._frames[0].t=0;for(var r=[],n=1,s=this._frames.length;n<s;n++){var o=le.lenVec3(le.subVec3(this._frames[n].eye,this._frames[n-1].eye,t));r[n]=o,i+=o}for(var a=1,l=this._frames.length;a<l;a++){var u=r[a]/i*e;this._frames[a].t=this._frames[a-1].t+u}}}},{key:"clearFrames",value:function(){this._frames=[],this._eyeCurve.points=[],this._lookCurve.points=[],this._upCurve.points=[]}}]),i}(),Ze=le.vec3(),Je=le.vec3(),Ye=le.vec3(),qe=le.vec3(),$e=le.vec3(),et=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._look1=le.vec3(),r._eye1=le.vec3(),r._up1=le.vec3(),r._look2=le.vec3(),r._eye2=le.vec3(),r._up2=le.vec3(),r._orthoScale1=1,r._orthoScale2=1,r._flying=!1,r._flyEyeLookUp=!1,r._flyingEye=!1,r._flyingLook=!1,r._callback=null,r._callbackScope=null,r._time1=null,r._time2=null,r.easing=!1!==n.easing,r.duration=n.duration,r.fit=n.fit,r.fitFOV=n.fitFOV,r.trail=n.trail,r}return I(i,[{key:"type",get:function(){return"CameraFlightAnimation"}},{key:"flyTo",value:function(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;var r,n,s,o,a,l=this.scene.camera,u=!!e.projection&&e.projection!==l.projection;if(this._eye1[0]=l.eye[0],this._eye1[1]=l.eye[1],this._eye1[2]=l.eye[2],this._look1[0]=l.look[0],this._look1[1]=l.look[1],this._look1[2]=l.look[2],this._up1[0]=l.up[0],this._up1[1]=l.up[1],this._up1[2]=l.up[2],this._orthoScale1=l.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)r=e.aabb;else if(6===e.length)r=e;else if(e.eye&&e.look||e.up)n=e.eye,s=e.look,o=e.up;else if(e.eye)n=e.eye;else if(e.look)s=e.look;else{var A=e;if((ge.isNumeric(A)||ge.isString(A))&&(a=A,!(A=this.scene.components[a])))return this.error("Component not found: "+ge.inQuotes(a)),void(t&&(i?t.call(i):t()));u||(r=A.aabb||this.scene.aabb)}var c=e.poi;if(r){if(r[3]<r[0]||r[4]<r[1]||r[5]<r[2])return;if(r[3]===r[0]&&r[4]===r[1]&&r[5]===r[2])return;r=r.slice();var h=le.getAABB3Center(r);this._look2=c||h;var d=le.subVec3(this._eye1,this._look1,Ze),p=le.normalizeVec3(d),f=c?le.getAABB3DiagPoint(r,c):le.getAABB3Diag(r),v=e.fitFOV||this._fitFOV,g=Math.abs(f/Math.tan(v*le.DEGTORAD));this._orthoScale2=1.1*f,this._eye2[0]=this._look2[0]+p[0]*g,this._eye2[1]=this._look2[1]+p[1]*g,this._eye2[2]=this._look2[2]+p[2]*g,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||s||o)&&(this._flyingEyeLookUp=!!n&&!!s&&!!o,this._flyingEye=!!n&&!s,this._flyingLook=!!s&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),s&&(this._look2[0]=s[0],this._look2[1]=s[1],this._look2[2]=s[2]),o&&(this._up2[0]=o[0],this._up2[1]=o[1],this._up2[2]=o[2]));u?("ortho"===e.projection&&"ortho"!==l.projection&&(this._projection2="ortho",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.ortho.matrix.slice(),l.projection="customProjection"),"perspective"===e.projection&&"perspective"!==l.projection&&(this._projection2="perspective",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.perspective.matrix.slice(),l.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(Number.isFinite(e.duration)?1e3*e.duration:this._duration),this._flying=!0,Fe.scheduleTask(this._update,this)}},{key:"jumpTo",value:function(e){this._jumpTo(e)}},{key:"_jumpTo",value:function(e){this._flying&&this.stop();var t,i,r,n,s,o=this.scene.camera;if(e.aabb)t=e.aabb;else if(6===e.length)t=e;else if(e.eye||e.look||e.up)r=e.eye,n=e.look,s=e.up;else{var a=e;if((ge.isNumeric(a)||ge.isString(a))&&(i=a,!(a=this.scene.components[i])))return void this.error("Component not found: "+ge.inQuotes(i));t=a.aabb||this.scene.aabb}var l=e.poi;if(t){if(t[3]<=t[0]||t[4]<=t[1]||t[5]<=t[2])return;var u,A=l?le.getAABB3DiagPoint(t,l):le.getAABB3Diag(t);n=l||le.getAABB3Center(t,n),this._trail?le.subVec3(o.look,n,$e):le.subVec3(o.eye,o.look,$e),le.normalizeVec3($e),u=(void 0!==e.fit?e.fit:this._fit)?Math.abs(A/Math.tan((e.fitFOV||this._fitFOV)*le.DEGTORAD)):le.lenVec3(le.subVec3(o.eye,o.look,Ze)),le.mulVec3Scalar($e,u),o.eye=le.addVec3(n,$e,Ze),o.look=n,this.scene.camera.ortho.scale=1.1*A}else(r||n||s)&&(r&&(o.eye=r),n&&(o.look=n),s&&(o.up=s));e.projection&&(o.projection=e.projection)}},{key:"_update",value:function(){if(this._flying){var e=(Date.now()-this._time1)/(this._time2-this._time1),t=e>=1;e>1&&(e=1);var r=this.easing?i._ease(e,0,1,1):e,n=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(le.subVec3(n.eye,n.look,$e),n.eye=le.lerpVec3(r,0,1,this._eye1,this._eye2,Ye),n.look=le.subVec3(Ye,$e,Je)):this._flyingLook&&(n.look=le.lerpVec3(r,0,1,this._look1,this._look2,Je),n.up=le.lerpVec3(r,0,1,this._up1,this._up2,qe)):this._flyingEyeLookUp&&(n.eye=le.lerpVec3(r,0,1,this._eye1,this._eye2,Ye),n.look=le.lerpVec3(r,0,1,this._look1,this._look2,Je),n.up=le.lerpVec3(r,0,1,this._up1,this._up2,qe)),this._projection2){var s="ortho"===this._projection2?i._easeOutExpo(e,0,1,1):i._easeInCubic(e,0,1,1);n.customProjection.matrix=le.lerpMat4(s,0,1,this._projMatrix1,this._projMatrix2)}else n.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);if(t)return n.ortho.scale=this._orthoScale2,void this.stop();Fe.scheduleTask(this._update,this)}}},{key:"stop",value:function(){if(this._flying){this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);var e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}}},{key:"cancel",value:function(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}},{key:"duration",get:function(){return this._duration/1e3},set:function(e){this._duration=Number.isFinite(e)?1e3*e:500,this.stop()}},{key:"fit",get:function(){return this._fit},set:function(e){this._fit=!1!==e}},{key:"fitFOV",get:function(){return this._fitFOV},set:function(e){this._fitFOV=e||45}},{key:"trail",get:function(){return this._trail},set:function(e){this._trail=!!e}},{key:"destroy",value:function(){this.stop(),v(x(i.prototype),"destroy",this).call(this)}}],[{key:"_ease",value:function(e,t,i,r){return-i*(e/=r)*(e-2)+t}},{key:"_easeInCubic",value:function(e,t,i,r){return i*(e/=r)*e*e+t}},{key:"_easeOutExpo",value:function(e,t,i,r){return i*(1-Math.pow(2,-10*e/r))+t}}]),i}(),tt=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._cameraFlightAnimation=new et(w(r)),r._t=0,r.state=i.SCRUBBING,r._playingFromT=0,r._playingToT=0,r._playingRate=n.playingRate||1,r._playingDir=1,r._lastTime=null,r.cameraPath=n.cameraPath,r._tick=r.scene.on("tick",r._updateT,w(r)),r}return I(i,[{key:"type",get:function(){return"CameraPathAnimation"}},{key:"_updateT",value:function(){var e=this._cameraPath;if(e){var t,r,n=performance.now(),s=this._lastTime?.001*(n-this._lastTime):0;if(this._lastTime=n,0!==s)switch(this.state){case i.SCRUBBING:return;case i.PLAYING:if(this._t+=this._playingRate*s,0===(t=this._cameraPath.frames.length)||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t)return this.state=i.SCRUBBING,this._t=this._cameraPath.frames[t-1].t,void this.fire("stopped");e.loadFrame(this._t);break;case i.PLAYING_TO:r=this._t+this._playingRate*s*this._playingDir,(this._playingDir<0&&r<=this._playingToT||this._playingDir>0&&r>=this._playingToT)&&(r=this._playingToT,this.state=i.SCRUBBING,this.fire("stopped")),this._t=r,e.loadFrame(this._t)}}}},{key:"_ease",value:function(e,t,i,r){return-i*(e/=r)*(e-2)+t}},{key:"cameraPath",get:function(){return this._cameraPath},set:function(e){this._cameraPath=e}},{key:"rate",get:function(){return this._playingRate},set:function(e){this._playingRate=e}},{key:"play",value:function(){this._cameraPath&&(this._lastTime=null,this.state=i.PLAYING)}},{key:"playToT",value:function(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=i.PLAYING_TO)}},{key:"playToFrame",value:function(e){var t=this._cameraPath;if(t){var i=t.frames[e];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+e)}}},{key:"flyToFrame",value:function(e,t){var r=this._cameraPath;if(r){var n=r.frames[e];n?(this.state=i.SCRUBBING,this._cameraFlightAnimation.flyTo(n,t)):this.error("flyToFrame - frame index out of range: "+e)}}},{key:"scrubToT",value:function(e){var t=this._cameraPath;t&&(this.scene.camera&&(this._t=e,t.loadFrame(this._t),this.state=i.SCRUBBING))}},{key:"scrubToFrame",value:function(e){var t=this._cameraPath;t&&(this.scene.camera&&(t.frames[e]?(t.loadFrame(this._t),this.state=i.SCRUBBING):this.error("playToFrame - frame index out of range: "+e)))}},{key:"stop",value:function(){this.state=i.SCRUBBING,this.fire("stopped")}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene.off(this._tick)}}]),i}();tt.STOPPED=0,tt.SCRUBBING=1,tt.PLAYING=2,tt.PLAYING_TO=3;var it=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),r=t.call(this,e,n),he.memory.meshes++,r}return I(i,[{key:"type",get:function(){return"Geometry"}},{key:"isGeometry",get:function(){return!0}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),he.memory.meshes--}}]),i}(),rt=new Z({}),nt=function(){function e(t){for(var i in k(this,e),this.id=rt.addItem({}),t)t.hasOwnProperty(i)&&(this[i]=t[i])}return I(e,[{key:"destroy",value:function(){rt.removeItem(this.id)}}]),e}(),st=function(){function e(t,i,r,n,s,o,a,l,u){switch(k(this,e),this._gl=t,this.type=i,this.allocated=!1,this.ConstructorType=r.constructor,r.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=n,this.numItems=0,this.itemSize=s,this.normalized=!!a,this.stride=l||0,this.offset=u||0,this._allocate(r)}return I(e,[{key:"_allocate",value:function(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}},{key:"setData",value:function(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}},{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.numItems-e;if(!this.allocated)return[];var i=new this.ConstructorType(t*this.itemSize);return this._gl.bindBuffer(this.type,this._handle),this._gl.getBufferSubData(this.type,e*this.itemByteSize*this.itemSize,i,0,t*this.itemSize),i}},{key:"bind",value:function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}},{key:"unbind",value:function(){this.allocated&&this._gl.bindBuffer(this.type,null)}},{key:"destroy",value:function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}]),e}(),ot=function(){var e=[],t=[],i=[],r=[],n=[],s=0,o=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),u=le.vec3(),A=le.vec3(),c=le.vec3(),h=le.vec3(),d=le.vec3(),p=le.vec3(),f=le.vec3();return function(v,g,m,_){!function(n,s){var o,a,l,u,A,c,h={},d=Math.pow(10,4),p=0;for(A=0,c=n.length;A<c;A+=3)o=n[A],a=n[A+1],l=n[A+2],void 0===h[u=Math.round(o*d)+"_"+Math.round(a*d)+"_"+Math.round(l*d)]&&(h[u]=p/3,e[p++]=o,e[p++]=a,e[p++]=l),t[A/3]=h[u];for(A=0,c=s.length;A<c;A++)r[A]=t[s[A]],i[r[A]]=s[A]}(v,g),function(t,i){s=0;for(var v=0,g=t;v<g;v+=3){var m=3*r[v],_=3*r[v+1],y=3*r[v+2];i?(o[0]=e[m],o[1]=e[m+1],o[2]=e[m+2],a[0]=e[_],a[1]=e[_+1],a[2]=e[_+2],l[0]=e[y],l[1]=e[y+1],l[2]=e[y+2],le.decompressPosition(o,i,u),le.decompressPosition(a,i,A),le.decompressPosition(l,i,c)):(u[0]=e[m],u[1]=e[m+1],u[2]=e[m+2],A[0]=e[_],A[1]=e[_+1],A[2]=e[_+2],c[0]=e[y],c[1]=e[y+1],c[2]=e[y+2]),le.subVec3(c,A,h),le.subVec3(u,A,d),le.cross3Vec3(h,d,p),le.normalizeVec3(p,f);var b=n[s]||(n[s]={normal:le.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],s++}}(g.length,m);for(var y,b,w,B,x,P,C,M,F,k,E=[],I=Math.cos(le.DEGTORAD*_),T={},D=!1,S=0,R=g.length;S<R;S+=3)for(var U=S/3,L=0;L<3;L++)y=r[S+L],b=r[S+(L+1)%3],void 0===T[x=(w=Math.min(y,b))+","+(B=Math.max(y,b))]?T[x]={index1:w,index2:B,face1:U,face2:void 0}:T[x].face2=U;for(x in T)void 0!==(P=T[x]).face2&&(C=n[P.face1].normal,M=n[P.face2].normal,le.dotVec3(C,M)>I)||(F=i[P.index1],k=i[P.index2],(!D&&F>65535||k>65535)&&(D=!0),E.push(F),E.push(k));return D?new Uint32Array(E):new Uint16Array(E)}}();var at,lt,ut=(at=le.mat4(),lt=le.mat4(),function(e,t){t=t||le.mat4();var i=e[0],r=e[1],n=e[2],s=e[3]-i,o=e[4]-r,a=e[5]-n,l=65535;return le.identityMat4(at),le.translationMat4v(e,at),le.identityMat4(lt),le.scalingMat4v([s/l,o/l,a/l],lt),le.mulMat4(at,lt,t),t}),At=function(){var e=le.mat4(),t=le.mat4();return function(i,r,n){var s,o=new Uint16Array(i.length),a=new Float32Array([n[0]!==r[0]?65535/(n[0]-r[0]):0,n[1]!==r[1]?65535/(n[1]-r[1]):0,n[2]!==r[2]?65535/(n[2]-r[2]):0]);for(s=0;s<i.length;s+=3)o[s+0]=Math.max(0,Math.min(65535,Math.floor((i[s+0]-r[0])*a[0]))),o[s+1]=Math.max(0,Math.min(65535,Math.floor((i[s+1]-r[1])*a[1]))),o[s+2]=Math.max(0,Math.min(65535,Math.floor((i[s+2]-r[2])*a[2])));return le.identityMat4(e),le.translationMat4v(r,e),le.identityMat4(t),le.scalingMat4v([(n[0]-r[0])/65535,(n[1]-r[1])/65535,(n[2]-r[2])/65535],t),{quantized:o,decodeMatrix:le.mulMat4(e,t,le.identityMat4())}}}();var ct=function(){var e=le.mat3(),t=le.mat3();return function(i,r,n){var s,o=new Uint16Array(i.length),a=new Float32Array([65535/(n[0]-r[0]),65535/(n[1]-r[1])]);for(s=0;s<i.length;s+=2)o[s+0]=Math.max(0,Math.min(65535,Math.floor((i[s+0]-r[0])*a[0]))),o[s+1]=Math.max(0,Math.min(65535,Math.floor((i[s+1]-r[1])*a[1])));return le.identityMat3(e),le.translationMat3v(r,e),le.identityMat3(t),le.scalingMat3v([(n[0]-r[0])/65535,(n[1]-r[1])/65535],t),{quantized:o,decodeMatrix:le.mulMat3(e,t,le.identityMat3())}}}();function ht(e,t,i,r){var n=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),s=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){var o=(1-Math.abs(s))*(n>=0?1:-1),a=(1-Math.abs(n))*(s>=0?1:-1);n=o,s=a}return new Int8Array([Math[i](127.5*n+(n<0?-1:0)),Math[r](127.5*s+(s<0?-1:0))])}function dt(e){var t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;var r=1-Math.abs(t)-Math.abs(i);r<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));var n=Math.sqrt(t*t+i*i+r*r);return[t/n,i/n,r/n]}function pt(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}var ft={getPositionsBounds:function(e){var t,i,r=new Float32Array(3),n=new Float32Array(3);for(t=0;t<3;t++)r[t]=Number.MAX_VALUE,n[t]=-Number.MAX_VALUE;for(t=0;t<e.length;t+=3)for(i=0;i<3;i++)r[i]=Math.min(r[i],e[t+i]),n[i]=Math.max(n[i],e[t+i]);return{min:r,max:n}},createPositionsDecodeMatrix:ut,compressPositions:At,compressPosition:function(e,t,i){var r=new Float32Array([t[3]!==t[0]?65535/(t[3]-t[0]):0,t[4]!==t[1]?65535/(t[4]-t[1]):0,t[5]!==t[2]?65535/(t[5]-t[2]):0]);i[0]=Math.max(0,Math.min(65535,Math.floor((e[0]-t[0])*r[0]))),i[1]=Math.max(0,Math.min(65535,Math.floor((e[1]-t[1])*r[1]))),i[2]=Math.max(0,Math.min(65535,Math.floor((e[2]-t[2])*r[2])))},decompressPositions:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[12],i[r+1]=e[r+1]*t[5]+t[13],i[r+2]=e[r+2]*t[10]+t[14];return i},decompressPosition:function(e,t,i){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i},decompressAABB:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i[3]=e[3]*t[0]+t[12],i[4]=e[4]*t[5]+t[13],i[5]=e[5]*t[10]+t[14],i},getUVBounds:function(e){var t,i,r=new Float32Array(2),n=new Float32Array(2);for(t=0;t<2;t++)r[t]=Number.MAX_VALUE,n[t]=-Number.MAX_VALUE;for(t=0;t<e.length;t+=2)for(i=0;i<2;i++)r[i]=Math.min(r[i],e[t+i]),n[i]=Math.max(n[i],e[t+i]);return{min:r,max:n}},compressUVs:ct,decompressUVs:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(e.length),r=0,n=e.length;r<n;r+=3)i[r+0]=e[r+0]*t[0]+t[6],i[r+1]=e[r+1]*t[4]+t[7];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},compressNormals:function(e){for(var t,i,r,n,s=new Int8Array(e.length),o=0;o<e.length;o+=3)i=t=ht(e,o,"floor","floor"),r=n=pt(e,o,dt(t)),(r=pt(e,o,dt(t=ht(e,o,"ceil","floor"))))>n&&(i=t,n=r),(r=pt(e,o,dt(t=ht(e,o,"floor","ceil"))))>n&&(i=t,n=r),(r=pt(e,o,dt(t=ht(e,o,"ceil","ceil"))))>n&&(i=t,n=r),s[o]=i[0],s[o+1]=i[1];return s},decompressNormals:function(e,t){for(var i=0,r=0,n=e.length;i<n;i+=2){var s=e[i+0],o=e[i+1];s=(2*s+1)/255,o=(2*o+1)/255;var a=1-Math.abs(s)-Math.abs(o);a<0&&(s=(1-Math.abs(o))*(s>=0?1:-1),o=(1-Math.abs(s))*(o>=0?1:-1));var l=Math.sqrt(s*s+o*o+a*a);t[r+0]=s/l,t[r+1]=o/l,t[r+2]=a/l,r+=3}return t},decompressNormal:function(e,t){var i=e[0],r=e[1];i=(2*i+1)/255,r=(2*r+1)/255;var n=1-Math.abs(i)-Math.abs(r);n<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var s=Math.sqrt(i*i+r*r+n*n);return t[0]=i/s,t[1]=r/s,t[2]=n/s,t}},vt=he.memory,gt=le.AABB3(),mt=function(e){m(i,it);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n))._state=new nt({compressGeometry:!!n.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),r._numTriangles=0,r._edgeThreshold=n.edgeThreshold||10,r._edgeIndicesBuf=null,r._pickTrianglePositionsBuf=null,r._pickTriangleColorsBuf=null,r._aabbDirty=!0,r._boundingSphere=!0,r._aabb=null,r._aabbDirty=!0,r._obb=null,r._obbDirty=!0;var s=r._state,o=r.scene.canvas.gl;switch(n.primitive=n.primitive||"triangles",n.primitive){case"points":s.primitive=o.POINTS,s.primitiveName=n.primitive;break;case"lines":s.primitive=o.LINES,s.primitiveName=n.primitive;break;case"line-loop":s.primitive=o.LINE_LOOP,s.primitiveName=n.primitive;break;case"line-strip":s.primitive=o.LINE_STRIP,s.primitiveName=n.primitive;break;case"triangles":s.primitive=o.TRIANGLES,s.primitiveName=n.primitive;break;case"triangle-strip":s.primitive=o.TRIANGLE_STRIP,s.primitiveName=n.primitive;break;case"triangle-fan":s.primitive=o.TRIANGLE_FAN,s.primitiveName=n.primitive;break;default:r.error("Unsupported value for 'primitive': '"+n.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),s.primitive=o.TRIANGLES,s.primitiveName=n.primitive}if(n.positions)if(r._state.compressGeometry){var a=ft.getPositionsBounds(n.positions),l=ft.compressPositions(n.positions,a.min,a.max);s.positions=l.quantized,s.positionsDecodeMatrix=l.decodeMatrix}else s.positions=n.positions.constructor===Float32Array?n.positions:new Float32Array(n.positions);if(n.colors&&(s.colors=n.colors.constructor===Float32Array?n.colors:new Float32Array(n.colors)),n.uv)if(r._state.compressGeometry){var u=ft.getUVBounds(n.uv),A=ft.compressUVs(n.uv,u.min,u.max);s.uv=A.quantized,s.uvDecodeMatrix=A.decodeMatrix}else s.uv=n.uv.constructor===Float32Array?n.uv:new Float32Array(n.uv);return n.normals&&(r._state.compressGeometry?s.normals=ft.compressNormals(n.normals):s.normals=n.normals.constructor===Float32Array?n.normals:new Float32Array(n.normals)),n.indices&&(s.indices=n.indices.constructor===Uint32Array||n.indices.constructor===Uint16Array?n.indices:new Uint32Array(n.indices),"triangles"===r._state.primitiveName&&(r._numTriangles=n.indices.length/3)),r._buildHash(),vt.meshes++,r._buildVBOs(),r}return I(i,[{key:"type",get:function(){return"ReadableGeometry"}},{key:"isReadableGeometry",get:function(){return!0}},{key:"_buildVBOs",value:function(){var e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new st(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),vt.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new st(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),vt.positions+=e.positionsBuf.numItems),e.normals){var i=e.compressGeometry;e.normalsBuf=new st(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),vt.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new st(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),vt.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new st(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),vt.uvs+=e.uvBuf.numItems)}},{key:"_buildHash",value:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}},{key:"_getEdgeIndices",value:function(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}},{key:"_getPickTrianglePositions",value:function(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}},{key:"_getPickTriangleColors",value:function(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}},{key:"_buildEdgeIndices",value:function(){var e=this._state;if(e.positions&&e.indices){var t=this.scene.canvas.gl,i=ot(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new st(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),vt.indices+=this._edgeIndicesBuf.numItems}}},{key:"_buildPickTriangleVBOs",value:function(){var e=this._state;if(e.positions&&e.indices){var t=this.scene.canvas.gl,i=le.buildPickTriangles(e.positions,e.indices,e.compressGeometry),r=i.positions,n=i.colors;this._pickTrianglePositionsBuf=new st(t,t.ARRAY_BUFFER,r,r.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new st(t,t.ARRAY_BUFFER,n,n.length,4,t.STATIC_DRAW,!0),vt.positions+=this._pickTrianglePositionsBuf.numItems,vt.colors+=this._pickTriangleColorsBuf.numItems}}},{key:"_buildPickVertexVBOs",value:function(){}},{key:"_webglContextLost",value:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}},{key:"_webglContextRestored",value:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}},{key:"primitive",get:function(){return this._state.primitiveName}},{key:"compressGeometry",get:function(){return this._state.compressGeometry}},{key:"positions",get:function(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),ft.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null},set:function(e){var t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.compressGeometry){var r=ft.getPositionsBounds(e),n=ft.compressPositions(e,r.min,r.max);e=n.quantized,t.positionsDecodeMatrix=n.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}},{key:"normals",get:function(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){var e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),ft.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry normals - quantized geometry is immutable");else{var t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}}},{key:"uv",get:function(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),ft.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry UVs - quantized geometry is immutable");else{var t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}}},{key:"colors",get:function(){return this._state.colors},set:function(e){if(this._state.compressGeometry)this.error("can't update geometry colors - quantized geometry is immutable");else{var t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}}},{key:"indices",get:function(){return this._state.indices}},{key:"aabb",get:function(){return this._aabbDirty&&(this._aabb||(this._aabb=le.AABB3()),le.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}},{key:"obb",get:function(){return this._obbDirty&&(this._obb||(this._obb=le.OBB3()),le.positions3ToAABB3(this._state.positions,gt,this._state.positionsDecodeMatrix),le.AABB3ToOBB3(gt,this._obb),this._obbDirty=!1),this._obb}},{key:"_getMetrics",value:function(){if(!("_metrics"in this))switch(this._state.primitiveName){case"solid":case"surface":case"triangles":for(var e=this._state.indices,t=this._state.positions,i=function(i,r){for(var n=3*e[i],s=0;s<3;++s)r[s]=t[n+s];return r},r=[le.vec3(),le.vec3(),le.vec3(),le.vec3()],n=0,s=le.vec3([0,0,0]),o=0;o<e.length;o+=3){var a=i(o,r[0]),l=i(o+1,r[1]),u=i(o+2,r[2]);le.addVec3(a,l,r[3]),le.addVec3(u,r[3],r[3]);var A=le.lenVec3(le.cross3Vec3(le.subVec3(l,a,r[1]),le.subVec3(u,a,r[2]),r[0]))/2;n+=A,le.mulVec3Scalar(r[3],A,r[3]),le.addVec3(s,r[3],s)}this._metrics={surfaceArea:n,centroid:le.mulVec3Scalar(s,1/n/3,s)};break;default:this._metrics={surfaceArea:0}}return this._metrics}},{key:"surfaceArea",get:function(){return this._getMetrics().surfaceArea}},{key:"centroid",get:function(){return this._getMetrics().centroid}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"_setAABBDirty",value:function(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),vt.meshes--}}]),i}(),_t=he.memory,yt=le.AABB3(),bt=function(e){m(i,it);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n))._state=new nt({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),r._numTriangles=0,r._edgeThreshold=n.edgeThreshold||10,r._aabb=null,r._obb=le.OBB3();var s,o=r._state,a=r.scene.canvas.gl;switch(n.primitive=n.primitive||"triangles",n.primitive){case"points":o.primitive=a.POINTS,o.primitiveName=n.primitive;break;case"lines":o.primitive=a.LINES,o.primitiveName=n.primitive;break;case"line-loop":o.primitive=a.LINE_LOOP,o.primitiveName=n.primitive;break;case"line-strip":o.primitive=a.LINE_STRIP,o.primitiveName=n.primitive;break;case"triangles":o.primitive=a.TRIANGLES,o.primitiveName=n.primitive;break;case"triangle-strip":o.primitive=a.TRIANGLE_STRIP,o.primitiveName=n.primitive;break;case"triangle-fan":o.primitive=a.TRIANGLE_FAN,o.primitiveName=n.primitive;break;default:r.error("Unsupported value for 'primitive': '"+n.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),o.primitive=a.TRIANGLES,o.primitiveName=n.primitive}if(!n.positions)return r.error("Config expected: positions"),b(r);if(!n.indices)return r.error("Config expected: indices"),b(r);var l=n.positionsDecodeMatrix;if(l);else{var u=ft.getPositionsBounds(n.positions),A=ft.compressPositions(n.positions,u.min,u.max);s=A.quantized,o.positionsDecodeMatrix=A.decodeMatrix,o.positionsBuf=new st(a,a.ARRAY_BUFFER,s,s.length,3,a.STATIC_DRAW),_t.positions+=o.positionsBuf.numItems,le.positions3ToAABB3(n.positions,r._aabb),le.positions3ToAABB3(s,yt,o.positionsDecodeMatrix),le.AABB3ToOBB3(yt,r._obb)}if(n.colors){var c=n.colors.constructor===Float32Array?n.colors:new Float32Array(n.colors);o.colorsBuf=new st(a,a.ARRAY_BUFFER,c,c.length,4,a.STATIC_DRAW),_t.colors+=o.colorsBuf.numItems}if(n.uv){var h=ft.getUVBounds(n.uv),d=ft.compressUVs(n.uv,h.min,h.max),p=d.quantized;o.uvDecodeMatrix=d.decodeMatrix,o.uvBuf=new st(a,a.ARRAY_BUFFER,p,p.length,2,a.STATIC_DRAW),_t.uvs+=o.uvBuf.numItems}if(n.normals){var f=ft.compressNormals(n.normals),v=o.compressGeometry;o.normalsBuf=new st(a,a.ARRAY_BUFFER,f,f.length,3,a.STATIC_DRAW,v),_t.normals+=o.normalsBuf.numItems}var g=n.indices.constructor===Uint32Array||n.indices.constructor===Uint16Array?n.indices:new Uint32Array(n.indices);o.indicesBuf=new st(a,a.ELEMENT_ARRAY_BUFFER,g,g.length,1,a.STATIC_DRAW),_t.indices+=o.indicesBuf.numItems;var m=ot(s,g,o.positionsDecodeMatrix,r._edgeThreshold);return r._edgeIndicesBuf=new st(a,a.ELEMENT_ARRAY_BUFFER,m,m.length,1,a.STATIC_DRAW),"triangles"===r._state.primitiveName&&(r._numTriangles=n.indices.length/3),r._buildHash(),_t.meshes++,r}return I(i,[{key:"type",get:function(){return"VBOGeometry"}},{key:"isVBOGeometry",get:function(){return!0}},{key:"_buildHash",value:function(){var e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}},{key:"_getEdgeIndices",value:function(){return this._edgeIndicesBuf}},{key:"primitive",get:function(){return this._state.primitiveName}},{key:"aabb",get:function(){return this._aabb}},{key:"obb",get:function(){return this._obb}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),_t.meshes--}}]),i}(),wt={};function Bt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(i,r){t.src||(console.error("load3DSGeometry: Parameter expected: src"),r());var n=e.canvas.spinner;n.processes++,ge.loadArraybuffer(t.src,(function(e){e.byteLength||(console.error("load3DSGeometry: no data loaded"),n.processes--,r());var s=wt.parse.from3DS(e).edit.objects[0].mesh,o=s.vertices,a=s.uvt,l=s.indices;n.processes--,i(ge.apply(t,{primitive:"triangles",positions:o,normals:null,uv:a,indices:l}))}),(function(e){console.error("load3DSGeometry: "+e),n.processes--,r()}))}))}function xt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(i,r){t.src||(console.error("loadOBJGeometry: Parameter expected: src"),r());var n=e.canvas.spinner;n.processes++,ge.loadArraybuffer(t.src,(function(e){e.byteLength||(console.error("loadOBJGeometry: no data loaded"),n.processes--,r());for(var s=wt.parse.fromOBJ(e),o=wt.edit.unwrap(s.i_verts,s.c_verts,3),a=wt.edit.unwrap(s.i_norms,s.c_norms,3),l=wt.edit.unwrap(s.i_uvt,s.c_uvt,2),u=new Int32Array(s.i_verts.length),A=0;A<s.i_verts.length;A++)u[A]=A;n.processes--,i(ge.apply(t,{primitive:"triangles",positions:o,normals:a.length>0?a:null,autoNormals:0===a.length,uv:l,indices:u}))}),(function(e){console.error("loadOBJGeometry: "+e),n.processes--,r()}))}))}function Pt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);var i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);var r=e.zSize||1;r<0&&(console.error("negative zSize not allowed - will invert"),r*=-1);var n=e.center,s=n?n[0]:0,o=n?n[1]:0,a=n?n[2]:0,l=-t+s,u=-i+o,A=-r+a,c=t+s,h=i+o,d=r+a;return ge.apply(e,{positions:[c,h,d,l,h,d,l,u,d,c,u,d,c,h,d,c,u,d,c,u,A,c,h,A,c,h,d,c,h,A,l,h,A,l,h,d,l,h,d,l,h,A,l,u,A,l,u,d,l,u,A,c,u,A,c,u,d,l,u,d,c,u,A,l,u,A,l,h,A,c,h,A],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}function Ct(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);var i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);var r=e.zSize||1;r<0&&(console.error("negative zSize not allowed - will invert"),r*=-1);var n=e.center,s=n?n[0]:0,o=n?n[1]:0,a=n?n[2]:0,l=-t+s,u=-i+o,A=-r+a,c=t+s,h=i+o,d=r+a;return ge.apply(e,{primitive:"lines",positions:[l,u,A,l,u,d,l,h,A,l,h,d,c,u,A,c,u,d,c,h,A,c,h,d],indices:[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]})}function Mt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Ct({id:e.id,center:[(e.aabb[0]+e.aabb[3])/2,(e.aabb[1]+e.aabb[4])/2,(e.aabb[2]+e.aabb[5])/2],xSize:Math.abs(e.aabb[3]-e.aabb[0])/2,ySize:Math.abs(e.aabb[4]-e.aabb[1])/2,zSize:Math.abs(e.aabb[5]-e.aabb[2])/2})}function Ft(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);var i=e.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);var r=e.height||1;r<0&&(console.error("negative height not allowed - will invert"),r*=-1);var n=e.radialSegments||32;n<0&&(console.error("negative radialSegments not allowed - will invert"),n*=-1),n<3&&(n=3);var s=e.heightSegments||1;s<0&&(console.error("negative heightSegments not allowed - will invert"),s*=-1),s<1&&(s=1);var o,a,l,u,A,c,h,d,p,f,v,g=!!e.openEnded,m=e.center,_=m?m[0]:0,y=m?m[1]:0,b=m?m[2]:0,w=r/2,B=r/s,x=2*Math.PI/n,P=1/n,C=(t-i)/s,M=[],F=[],k=[],E=[],I=(90-180*Math.atan(r/(i-t))/Math.PI)/90;for(o=0;o<=s;o++)for(A=t-o*C,c=w-o*B,a=0;a<=n;a++)l=Math.sin(a*x),u=Math.cos(a*x),F.push(A*l),F.push(I),F.push(A*u),k.push(a*P),k.push(1*o/s),M.push(A*l+_),M.push(c+y),M.push(A*u+b);for(o=0;o<s;o++)for(a=0;a<=n;a++)d=(h=o*(n+1)+a)+n,E.push(h),E.push(d),E.push(d+1),E.push(h),E.push(d+1),E.push(h+1);if(!g&&t>0){for(p=M.length/3,F.push(0),F.push(1),F.push(0),k.push(.5),k.push(.5),M.push(0+_),M.push(w+y),M.push(0+b),a=0;a<=n;a++)l=Math.sin(a*x),u=Math.cos(a*x),f=.5*Math.sin(a*x)+.5,v=.5*Math.cos(a*x)+.5,F.push(t*l),F.push(1),F.push(t*u),k.push(f),k.push(v),M.push(t*l+_),M.push(w+y),M.push(t*u+b);for(a=0;a<n;a++)m=p,h=p+1+a,E.push(h),E.push(h+1),E.push(m)}if(!g&&i>0){for(p=M.length/3,F.push(0),F.push(-1),F.push(0),k.push(.5),k.push(.5),M.push(0+_),M.push(0-w+y),M.push(0+b),a=0;a<=n;a++)l=Math.sin(a*x),u=Math.cos(a*x),f=.5*Math.sin(a*x)+.5,v=.5*Math.cos(a*x)+.5,F.push(i*l),F.push(-1),F.push(i*u),k.push(f),k.push(v),M.push(i*l+_),M.push(0-w+y),M.push(i*u+b);for(a=0;a<n;a++)m=p,h=p+1+a,E.push(m),E.push(h+1),E.push(h)}return ge.apply(e,{positions:M,normals:F,uv:k,indices:E})}function kt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.size||1;t<0&&(console.error("negative size not allowed - will invert"),t*=-1);var i=e.divisions||1;i<0&&(console.error("negative divisions not allowed - will invert"),i*=-1),i<1&&(i=1);for(var r=(t=t||10)/(i=i||10),n=t/2,s=[],o=[],a=0,l=0,u=-n;l<=i;l++,u+=r)s.push(-n),s.push(0),s.push(u),s.push(n),s.push(0),s.push(u),s.push(u),s.push(0),s.push(-n),s.push(u),s.push(0),s.push(n),o.push(a++),o.push(a++),o.push(a++),o.push(a++);return ge.apply(e,{primitive:"lines",positions:s,indices:o})}function Et(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);var i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);var r=e.xSegments||1;r<0&&(console.error("negative xSegments not allowed - will invert"),r*=-1),r<1&&(r=1);var n=e.xSegments||1;n<0&&(console.error("negative zSegments not allowed - will invert"),n*=-1),n<1&&(n=1);var s,o,a,l,u,A,c,h=e.center,d=h?h[0]:0,p=h?h[1]:0,f=h?h[2]:0,v=t/2,g=i/2,m=Math.floor(r)||1,_=Math.floor(n)||1,y=m+1,b=_+1,w=t/m,B=i/_,x=new Float32Array(y*b*3),P=new Float32Array(y*b*3),C=new Float32Array(y*b*2),M=0,F=0;for(s=0;s<b;s++){var k=s*B-g;for(o=0;o<y;o++)a=o*w-v,x[M]=a+d,x[M+1]=p,x[M+2]=-k+f,P[M+1]=1,C[F]=o/m,C[F+1]=(_-s)/_,M+=3,F+=2}M=0;var E=new(x.length/3>65535?Uint32Array:Uint16Array)(m*_*6);for(s=0;s<_;s++)for(o=0;o<m;o++)l=o+y*s,u=o+y*(s+1),A=o+1+y*(s+1),c=o+1+y*s,E[M]=c,E[M+1]=u,E[M+2]=l,E[M+3]=c,E[M+4]=A,E[M+5]=u,M+=6;return ge.apply(e,{positions:x,normals:P,uv:C,indices:E})}function It(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.lod||1,i=e.center?e.center[0]:0,r=e.center?e.center[1]:0,n=e.center?e.center[2]:0,s=e.radius||1;s<0&&(console.error("negative radius not allowed - will invert"),s*=-1);var o=e.heightSegments||18;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),(o=Math.floor(t*o))<18&&(o=18);var a=e.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),(a=Math.floor(t*a))<18&&(a=18);var l,u,A,c,h,d,p,f,v,g,m,_,y,b,w=[],B=[],x=[],P=[];for(l=0;l<=o;l++)for(A=l*Math.PI/o,c=Math.sin(A),h=Math.cos(A),u=0;u<=a;u++)d=2*u*Math.PI/a,p=Math.sin(d),f=Math.cos(d)*c,v=h,g=p*c,m=1-u/a,_=l/o,B.push(f),B.push(v),B.push(g),x.push(m),x.push(_),w.push(i+s*f),w.push(r+s*v),w.push(n+s*g);for(l=0;l<o;l++)for(u=0;u<a;u++)b=(y=l*(a+1)+u)+a+1,P.push(y+1),P.push(b+1),P.push(b),P.push(y+1),P.push(b),P.push(y);return ge.apply(e,{positions:w,normals:B,uv:x,indices:P})}function Tt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radius||1;t<0&&(console.error("negative radius not allowed - will invert"),t*=-1),t*=.5;var i=e.tube||.3;i<0&&(console.error("negative tube not allowed - will invert"),i*=-1);var r=e.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<4&&(r=4);var n=e.tubeSegments||24;n<0&&(console.error("negative tubeSegments not allowed - will invert"),n*=-1),n<4&&(n=4);var s=e.arc||2*Math.PI;s<0&&(console.warn("negative arc not allowed - will invert"),s*=-1),s>360&&(s=360);var o,a,l,u,A,c,h,d,p,f,v,g,m=e.center,_=m?m[0]:0,y=m?m[1]:0,b=m?m[2]:0,w=[],B=[],x=[],P=[];for(d=0;d<=n;d++)for(h=0;h<=r;h++)o=h/r*s,a=.785398+d/n*Math.PI*2,_=t*Math.cos(o),y=t*Math.sin(o),l=(t+i*Math.cos(a))*Math.cos(o),u=(t+i*Math.cos(a))*Math.sin(o),A=i*Math.sin(a),w.push(l+_),w.push(u+y),w.push(A+b),x.push(1-h/r),x.push(d/n),c=le.normalizeVec3(le.subVec3([l,u,A],[_,y,b],[]),[]),B.push(c[0]),B.push(c[1]),B.push(c[2]);for(d=1;d<=n;d++)for(h=1;h<=r;h++)p=(r+1)*d+h-1,f=(r+1)*(d-1)+h-1,v=(r+1)*(d-1)+h,g=(r+1)*d+h,P.push(p),P.push(f),P.push(v),P.push(v),P.push(g),P.push(p);return ge.apply(e,{positions:w,normals:B,uv:x,indices:P})}wt.load=function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(e){t(e.target.response)},i.send()},wt.save=function(e,t){var i="data:application/octet-stream;base64,"+btoa(wt.parse._buffToStr(e));window.location.href=i},wt.clone=function(e){return JSON.parse(JSON.stringify(e))},wt.bin={},wt.bin.f=new Float32Array(1),wt.bin.fb=new Uint8Array(wt.bin.f.buffer),wt.bin.rf=function(e,t){for(var i=wt.bin.f,r=wt.bin.fb,n=0;n<4;n++)r[n]=e[t+n];return i[0]},wt.bin.rsl=function(e,t){return e[t]|e[t+1]<<8},wt.bin.ril=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24},wt.bin.rASCII0=function(e,t){for(var i="";0!=e[t];)i+=String.fromCharCode(e[t++]);return i},wt.bin.wf=function(e,t,i){new Float32Array(e.buffer,t,1)[0]=i},wt.bin.wsl=function(e,t,i){e[t]=i,e[t+1]=i>>8},wt.bin.wil=function(e,t,i){e[t]=i,e[t+1]=i>>8,e[t+2]=i>>16,e[t+3]},wt.parse={},wt.parse._buffToStr=function(e){for(var t=new Uint8Array(e),i="",r=0;r<t.length;r++)i=i.concat(String.fromCharCode(t[r]));return i},wt.parse._strToBuff=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),r=0;r<e.length;r++)i[r]=e.charCodeAt(r);return t},wt.parse._readLine=function(e,t){for(var i="";10!=e[t];)i+=String.fromCharCode(e[t++]);return i},wt.parse.fromJSON=function(e){return JSON.parse(wt.parse._buffToStr(e))},wt.parse.toJSON=function(e){var t=JSON.stringify(e);return wt.parse._strToBuff(t)},wt.parse.fromOBJ=function(e){for(var t={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},i={from:0,to:0},r=0,n=new Uint8Array(e);r<n.length;){var s=wt.parse._readLine(n,r);r+=s.length+1;var o=(s=(s=s.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==o[0]&&(i.to=t.i_verts.length,null==t.groups[o[1]]&&(t.groups[o[1]]={from:t.i_verts.length,to:0}),i=t.groups[o[1]]),"v"==o[0]){var a=parseFloat(o[1]),l=parseFloat(o[2]),u=parseFloat(o[3]);t.c_verts.push(a,l,u)}if("vt"==o[0]){a=parseFloat(o[1]),l=1-parseFloat(o[2]);t.c_uvt.push(a,l)}if("vn"==o[0]){a=parseFloat(o[1]),l=parseFloat(o[2]),u=parseFloat(o[3]);t.c_norms.push(a,l,u)}if("f"==o[0]){var A=o[1].split("/"),c=o[2].split("/"),h=o[3].split("/"),d=parseInt(A[0])-1,p=parseInt(c[0])-1,f=parseInt(h[0])-1,v=parseInt(A[1])-1,g=parseInt(c[1])-1,m=parseInt(h[1])-1,_=parseInt(A[2])-1,y=parseInt(c[2])-1,b=parseInt(h[2])-1,w=t.c_verts.length/3,B=t.c_uvt.length/2,x=t.c_norms.length/3;if(d<0&&(d=w+d+1),p<0&&(p=w+p+1),f<0&&(f=w+f+1),v<0&&(v=B+v+1),g<0&&(g=B+g+1),m<0&&(m=B+m+1),_<0&&(_=x+_+1),y<0&&(y=x+y+1),b<0&&(b=x+b+1),t.i_verts.push(d,p,f),t.i_uvt.push(v,g,m),t.i_norms.push(_,y,b),5==o.length){var P=o[4].split("/"),C=parseInt(P[0])-1,M=parseInt(P[1])-1,F=parseInt(P[2])-1;C<0&&(C=w+C+1),M<0&&(M=B+M+1),F<0&&(F=x+F+1),t.i_verts.push(d,f,C),t.i_uvt.push(v,m,M),t.i_norms.push(_,b,F)}}}return i.to=t.i_verts.length,t},wt.parse.fromMD2=function(e){e=new Uint8Array(e);var t={},i={};i.ident=wt.bin.ril(e,0),i.version=wt.bin.ril(e,4),i.skinwidth=wt.bin.ril(e,8),i.skinheight=wt.bin.ril(e,12),i.framesize=wt.bin.ril(e,16),i.num_skins=wt.bin.ril(e,20),i.num_vertices=wt.bin.ril(e,24),i.num_st=wt.bin.ril(e,28),i.num_tris=wt.bin.ril(e,32),i.num_glcmds=wt.bin.ril(e,36),i.num_frames=wt.bin.ril(e,40),i.offset_skins=wt.bin.ril(e,44),i.offset_st=wt.bin.ril(e,48),i.offset_tris=wt.bin.ril(e,52),i.offset_frames=wt.bin.ril(e,56),i.offset_glcmds=wt.bin.ril(e,60),i.offset_end=wt.bin.ril(e,64);var r=i.offset_st;t.c_uvt=[];for(var n=0;n<i.num_st;n++){var s=wt.bin.rsl(e,r)/i.skinwidth,o=wt.bin.rsl(e,r+2)/i.skinheight;t.c_uvt.push(s,o),r+=4}r=i.offset_tris;var a=[],l=[];t.i_verts=a,t.i_uvt=l;for(n=0;n<i.num_tris;n++)a.push(wt.bin.rsl(e,r),wt.bin.rsl(e,r+2),wt.bin.rsl(e,r+4)),l.push(wt.bin.rsl(e,r+6),wt.bin.rsl(e,r+8),wt.bin.rsl(e,r+10)),r+=12;r=i.offset_skins;t.skins=[];for(n=0;n<i.num_skins;n++)t.skins.push(wt.bin.rASCII0(e,r)),r+=64;r=i.offset_frames;t.frames=[];var u=wt.parse.fromMD2._normals;for(n=0;n<i.num_frames;n++){var A={},c=wt.bin.rf(e,r),h=wt.bin.rf(e,r+4),d=wt.bin.rf(e,r+8);r+=12;var p=wt.bin.rf(e,r),f=wt.bin.rf(e,r+4),v=wt.bin.rf(e,r+8);r+=12,A.name=wt.bin.rASCII0(e,r),r+=16,A.verts=[],A.norms=[];for(var g=0;g<i.num_vertices;g++)A.verts.push(e[r]*c+p,e[r+1]*h+f,e[r+2]*d+v),A.norms.push(u[3*e[r+3]],u[3*e[r+3]+1],u[3*e[r+3]+2]),r+=4;t.frames.push(A)}return t},wt.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],wt.parse.fromCollada=function(e){var t=wt.parse._buffToStr(e),i=(new DOMParser).parseFromString(t,"text/xml"),r={},n=(i=i.childNodes[0]).getElementsByTagName("asset")[0],s=i.getElementsByTagName("library_geometries")[0],o=i.getElementsByTagName("library_images")[0],a=i.getElementsByTagName("library_materials")[0],l=i.getElementsByTagName("library_effects")[0];return n&&(r.asset=wt.parse.fromCollada._asset(n)),s&&(r.geometries=wt.parse.fromCollada._libGeometries(s)),o&&(r.images=wt.parse.fromCollada._libImages(o)),a&&(r.materials=wt.parse.fromCollada._libMaterials(a)),l&&(r.effects=wt.parse.fromCollada._libEffects(l)),r},wt.parse.fromCollada._asset=function(e){return{created:e.getElementsByTagName("created")[0].textContent,modified:e.getElementsByTagName("modified")[0].textContent,up_axis:e.getElementsByTagName("up_axis")[0].textContent}},wt.parse.fromCollada._libGeometries=function(e){e=e.getElementsByTagName("geometry");for(var t=[],i=0;i<e.length;i++){var r=e[i],n=wt.parse.fromCollada._getMesh(r.getElementsByTagName("mesh")[0]);t.push(n)}return t},wt.parse.fromCollada._getMesh=function(e){for(var t={},i=e.getElementsByTagName("source"),r=t.sources={},n=0;n<i.length;n++){for(var s=i[n].getElementsByTagName("float_array")[0].textContent.split(" "),o=s.length-(""==s[s.length-1]?1:0),a=new Array(o),l=0;l<o;l++)a[l]=parseFloat(s[l]);r[i[n].getAttribute("id")]=a}t.triangles=[];var u=e.getElementsByTagName("triangles");if(null==u)return t;for(n=0;n<u.length;n++){var A={},c=u[n];A.material=c.getAttribute("material");var h=c.getElementsByTagName("input"),d=[];for(l=0;l<h.length;l++){var p=h[l];a=[];d[parseInt(p.getAttribute("offset"))]=a;var f=p.getAttribute("semantic");A["s_"+f]="VERTEX"==f?e.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):p.getAttribute("source").substring(1),A["i_"+f]=a,r[A["s_"+f]]}var v=c.getElementsByTagName("p")[0].textContent.split(" "),g=3*Math.floor(v.length/3);for(l=0;l<g;l++)d[l%h.length].push(parseInt(v[l]));t.triangles.push(A)}return t},wt.parse.fromCollada._libImages=function(e){e=e.getElementsByTagName("image");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("id")]=e[i].getElementsByTagName("init_from")[0].textContent;return t},wt.parse.fromCollada._libMaterials=function(e){e=e.getElementsByTagName("material");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("name")]=e[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return t},wt.parse.fromCollada._libEffects=function(e){e=e.getElementsByTagName("effect");for(var t={},i=0;i<e.length;i++){for(var r={},n=e[i].getElementsByTagName("newparam"),s=0;s<n.length;s++){var o=n[s].getElementsByTagName("surface")[0];o&&(r.surface=o.getElementsByTagName("init_from")[0].textContent)}t[e[i].getAttribute("id")]=r}return t},wt.parse.from3DS=function(e){e=new Uint8Array(e);var t={};if(19789!=wt.bin.rsl(e,0))return null;for(var i=wt.bin.ril(e,2),r=6;r<i;){var n=wt.bin.rsl(e,r),s=wt.bin.ril(e,r+2);15677==n&&(t.edit=wt.parse.from3DS._edit3ds(e,r,s)),45056==n&&(t.keyf=wt.parse.from3DS._keyf3ds(e,r,s)),r+=s}return t},wt.parse.from3DS._edit3ds=function(e,t,i){for(var r={},n=t+6;n<t+i;){var s=wt.bin.rsl(e,n),o=wt.bin.ril(e,n+2);16384==s&&(null==r.objects&&(r.objects=[]),r.objects.push(wt.parse.from3DS._edit_object(e,n,o))),n+=o}return r},wt.parse.from3DS._keyf3ds=function(e,t,i){for(var r={},n=t+6;n<t+i;){var s=wt.bin.rsl(e,n),o=wt.bin.ril(e,n+2);45058==s&&(null==r.desc&&(r.desc=[]),r.desc.push(wt.parse.from3DS._keyf_objdes(e,n,o))),n+=o}return r},wt.parse.from3DS._keyf_objdes=function(e,t,i){for(var r={},n=t+6;n<t+i;){var s=wt.bin.rsl(e,n),o=wt.bin.ril(e,n+2);45072==s&&(r.hierarchy=wt.parse.from3DS._keyf_objhierarch(e,n,o)),45073==s&&(r.dummy_name=wt.bin.rASCII0(e,n+6)),n+=o}return r},wt.parse.from3DS._keyf_objhierarch=function(e,t,i){var r={},n=t+6;return r.name=wt.bin.rASCII0(e,n),n+=r.name.length+1,r.hierarchy=wt.bin.rsl(e,n+4),r},wt.parse.from3DS._edit_object=function(e,t,i){var r={},n=t+6;for(r.name=wt.bin.rASCII0(e,n),n+=r.name.length+1;n<t+i;){var s=wt.bin.rsl(e,n),o=wt.bin.ril(e,n+2);16640==s&&(r.mesh=wt.parse.from3DS._obj_trimesh(e,n,o)),n+=o}return r},wt.parse.from3DS._obj_trimesh=function(e,t,i){for(var r={},n=t+6;n<t+i;){var s=wt.bin.rsl(e,n),o=wt.bin.ril(e,n+2);16656==s&&(r.vertices=wt.parse.from3DS._tri_vertexl(e,n,o)),16672==s&&(r.indices=wt.parse.from3DS._tri_facel1(e,n,o)),16704==s&&(r.uvt=wt.parse.from3DS._tri_mappingcoors(e,n,o)),16736==s&&(r.local=wt.parse.from3DS._tri_local(e,n,o)),n+=o}return r},wt.parse.from3DS._tri_vertexl=function(e,t,i){var r=[],n=t+6,s=wt.bin.rsl(e,n);n+=2;for(var o=0;o<s;o++)r.push(wt.bin.rf(e,n)),r.push(wt.bin.rf(e,n+4)),r.push(wt.bin.rf(e,n+8)),n+=12;return r},wt.parse.from3DS._tri_facel1=function(e,t,i){var r=[],n=t+6,s=wt.bin.rsl(e,n);n+=2;for(var o=0;o<s;o++)r.push(wt.bin.rsl(e,n)),r.push(wt.bin.rsl(e,n+2)),r.push(wt.bin.rsl(e,n+4)),n+=8;return r},wt.parse.from3DS._tri_mappingcoors=function(e,t,i){var r=[],n=t+6,s=wt.bin.rsl(e,n);n+=2;for(var o=0;o<s;o++)r.push(wt.bin.rf(e,n)),r.push(1-wt.bin.rf(e,n+4)),n+=8;return r},wt.parse.from3DS._tri_local=function(e,t,i){var r={},n=t+6;return r.X=[wt.bin.rf(e,n),wt.bin.rf(e,n+4),wt.bin.rf(e,n+8)],n+=12,r.Y=[wt.bin.rf(e,n),wt.bin.rf(e,n+4),wt.bin.rf(e,n+8)],n+=12,r.Z=[wt.bin.rf(e,n),wt.bin.rf(e,n+4),wt.bin.rf(e,n+8)],n+=12,r.C=[wt.bin.rf(e,n),wt.bin.rf(e,n+4),wt.bin.rf(e,n+8)],n+=12,r},wt.parse.fromBIV=function(e){e=new Uint8Array(e);var t={},i={};return i.id=wt.bin.ril(e,0),i.verS=wt.bin.ril(e,4),i.texS=wt.bin.ril(e,8),i.indS=wt.bin.ril(e,12),i.verO=wt.bin.ril(e,16),i.verL=wt.bin.ril(e,20),i.texO=wt.bin.ril(e,24),i.texL=wt.bin.ril(e,28),i.indO=wt.bin.ril(e,32),i.indL=wt.bin.ril(e,36),0!=i.verO&&(t.vertices=wt.parse.fromBIV._readFloats(e,i.verO,i.verL)),0!=i.texO&&(t.uvt=wt.parse.fromBIV._readFloats(e,i.texO,i.texL)),0!=i.indO&&(t.indices=wt.parse.fromBIV._readInts(e,i.indO,i.indL,i.indS)),t},wt.parse.toBIV=function(e){for(var t=0,i=0;i<e.indices.length;i++)t=Math.max(t,e.indices[i]);var r=32;t<=65535&&(r=16);var n=40;e.vertices&&(n+=4*e.vertices.length),e.uvt&&(n+=4*e.uvt.length),e.indices&&(n+=e.indices.length*r/8);var s=new Uint8Array(n);wt.bin.wil(s,0,1769365870),wt.bin.wil(s,4,32),wt.bin.wil(s,8,32),wt.bin.wil(s,12,r);var o=40;return e.vertices&&(wt.bin.wil(s,16,o),wt.bin.wil(s,20,4*e.vertices.length),wt.parse.fromBIV._writeFloats(s,o,e.vertices),o+=4*e.vertices.length),e.uvt&&(wt.bin.wil(s,24,o),wt.bin.wil(s,28,4*e.uvt.length),wt.parse.fromBIV._writeFloats(s,o,e.uvt),o+=4*e.uvt.length),e.indices&&(wt.bin.wil(s,32,o),wt.bin.wil(s,36,4*e.indices.length),wt.parse.fromBIV._writeInts(s,o,e.indices,r)),s.buffer},wt.parse.fromBIV._readFloats=function(e,t,i){for(var r=[],n=0;n<i/4;n++)r.push(wt.bin.rf(e,t+4*n));return r},wt.parse.fromBIV._writeFloats=function(e,t,i){for(var r=0;r<i.length;r++)wt.bin.wf(e,t+4*r,i[r])},wt.parse.fromBIV._readInts=function(e,t,i,r){for(var n=[],s=0;s<i/4;s++)16==r&&n.push(wt.bin.rsl(e,t+2*s)),32==r&&n.push(wt.bin.ril(e,t+4*s));return n},wt.parse.fromBIV._writeInts=function(e,t,i,r){for(var n=0;n<i.length;n++)16==r&&wt.bin.wsl(e,t+2*n,i[n]),32==r&&wt.bin.wil(e,t+4*n,i[n])},wt.gen={},wt.gen.Plane=function(e,t,i,r){i||(i=1),r||(r=1);for(var n={verts:[],inds:[],uvt:[]},s=e+1,o=t+1,a=0;a<o;a++)for(var l=0;l<s;l++){var u=l*(2/e)-1,A=a*(2/t)-1;n.verts.push(u,A,0),n.uvt.push(i*l/e,r*a/t),a<t&&l<e&&n.inds.push(a*s+l,a*s+l+1,(a+1)*s+l,a*s+l+1,(a+1)*s+l,(a+1)*s+l+1)}return n},wt.gen.Cube=function(){return{verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},wt.gen.Sphere=function(e,t){for(var i={verts:[],inds:[],uvt:[]},r=e+1,n=t+1,s=0;s<n;s++)for(var o=0;o<r;o++){var a=-Math.PI/2+s*Math.PI/t,l=2*o*Math.PI/e,u=Math.cos(a)*Math.cos(l),A=Math.sin(a),c=Math.cos(a)*Math.sin(l);i.verts.push(u,A,c),i.uvt.push(o/e,s/t),s<t&&o<e&&i.inds.push(r*s+o,r*s+o+1,r*(s+1)+o,r*s+o+1,r*(s+1)+o,r*(s+1)+o+1)}return i},wt.mat={},wt.mat.scale=function(e,t,i){return[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]},wt.mat.translate=function(e,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]},wt.mat.rotateDeg=function(e,t,i){var r=Math.PI/180;return wt.mat.rotate(e*r,t*r,i*r)},wt.mat.rotate=function(e,t,i){var r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],n=e,s=t,o=i,a=Math.cos(n),l=Math.cos(s),u=Math.cos(o),A=Math.sin(n),c=Math.sin(s),h=Math.sin(o);return r[0]=l*u,r[1]=-l*h,r[2]=c,r[4]=a*h+A*c*u,r[5]=a*u-A*c*h,r[6]=-A*l,r[8]=A*h-a*c*u,r[9]=A*u+a*c*h,r[10]=a*l,r},wt.edit={},wt.edit.interpolate=function(e,t,i,r){for(var n=0;n<e.length;n++)i[n]=e[n]+r*(t[n]-e[n])},wt.edit.transform=function(e,t){for(var i=0;i<e.length;i+=3){var r=e[i],n=e[i+1],s=e[i+2];e[i+0]=t[0]*r+t[4]*n+t[8]*s+t[12],e[i+1]=t[1]*r+t[5]*n+t[9]*s+t[13],e[i+2]=t[2]*r+t[6]*n+t[10]*s+t[14]}},wt.edit.unwrap=function(e,t,i){for(var r=new Array(Math.floor(e.length/3)*i),n=0;n<e.length;n++)for(var s=0;s<i;s++)r[n*i+s]=t[e[n]*i+s];return r},wt.edit.remap=function(e,t,i,r){for(var n=new Array(i.length),s=0;s<e.length;s++)for(var o=0;o<r;o++)n[t[s]*r+o]=i[e[s]*r+o];return n},wt.utils={},wt.utils.getAABB=function(e){var t,i,r,n,s,o;n=s=o=-(t=i=r=999999999);for(var a=0;a<e.length;a+=3){var l=e[a+0],u=e[a+1],A=e[a+2];l<t&&(t=l),l>n&&(n=l),u<i&&(i=u),u>s&&(s=u),A<r&&(r=A),u>o&&(o=A)}return{min:{x:t,y:i,z:r},max:{x:n,y:s,z:o}}};var Dt={" ":{width:16,points:[]},"!":{width:10,points:[[5,21],[5,7],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},'"':{width:16,points:[[4,21],[4,14],[-1,-1],[12,21],[12,14]]},"#":{width:21,points:[[11,25],[4,-7],[-1,-1],[17,25],[10,-7],[-1,-1],[4,12],[18,12],[-1,-1],[3,6],[17,6]]},$:{width:20,points:[[8,25],[8,-4],[-1,-1],[12,25],[12,-4],[-1,-1],[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},"%":{width:24,points:[[21,21],[3,0],[-1,-1],[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],[10,20],[13,19],[16,19],[19,20],[21,21],[-1,-1],[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},"&":{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},"'":{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},"(":{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},")":{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},"*":{width:16,points:[[8,21],[8,9],[-1,-1],[3,18],[13,12],[-1,-1],[13,18],[3,12]]},"+":{width:26,points:[[13,18],[13,0],[-1,-1],[4,9],[22,9]]},",":{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"-":{width:26,points:[[4,9],[22,9]]},".":{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},"/":{width:22,points:[[20,25],[2,-7]]},0:{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},1:{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},2:{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},3:{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},4:{width:20,points:[[13,21],[3,7],[18,7],[-1,-1],[13,21],[13,0]]},5:{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},6:{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},7:{width:20,points:[[17,21],[7,0],[-1,-1],[3,21],[17,21]]},8:{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},9:{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},":":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},";":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"<":{width:24,points:[[20,18],[4,9],[20,0]]},"=":{width:26,points:[[4,12],[22,12],[-1,-1],[4,6],[22,6]]},">":{width:24,points:[[4,18],[20,9],[4,0]]},"?":{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],[-1,-1],[9,2],[8,1],[9,0],[10,1],[9,2]]},"@":{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],[-1,-1],[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],[-1,-1],[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],[-1,-1],[19,16],[18,8],[18,6],[19,5]]},A:{width:18,points:[[9,21],[1,0],[-1,-1],[9,21],[17,0],[-1,-1],[4,7],[14,7]]},B:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[-1,-1],[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},C:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},D:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},E:{width:19,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11],[-1,-1],[4,0],[17,0]]},F:{width:18,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11]]},G:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],[-1,-1],[13,8],[18,8]]},H:{width:22,points:[[4,21],[4,0],[-1,-1],[18,21],[18,0],[-1,-1],[4,11],[18,11]]},I:{width:8,points:[[4,21],[4,0]]},J:{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},K:{width:21,points:[[4,21],[4,0],[-1,-1],[18,21],[4,7],[-1,-1],[9,12],[18,0]]},L:{width:17,points:[[4,21],[4,0],[-1,-1],[4,0],[16,0]]},M:{width:24,points:[[4,21],[4,0],[-1,-1],[4,21],[12,0],[-1,-1],[20,21],[12,0],[-1,-1],[20,21],[20,0]]},N:{width:22,points:[[4,21],[4,0],[-1,-1],[4,21],[18,0],[-1,-1],[18,21],[18,0]]},O:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},P:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},Q:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],[-1,-1],[12,4],[18,-2]]},R:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],[-1,-1],[11,11],[18,0]]},S:{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},T:{width:16,points:[[8,21],[8,0],[-1,-1],[1,21],[15,21]]},U:{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},V:{width:18,points:[[1,21],[9,0],[-1,-1],[17,21],[9,0]]},W:{width:24,points:[[2,21],[7,0],[-1,-1],[12,21],[7,0],[-1,-1],[12,21],[17,0],[-1,-1],[22,21],[17,0]]},X:{width:20,points:[[3,21],[17,0],[-1,-1],[17,21],[3,0]]},Y:{width:18,points:[[1,21],[9,11],[9,0],[-1,-1],[17,21],[9,11]]},Z:{width:20,points:[[17,21],[3,0],[-1,-1],[3,21],[17,21],[-1,-1],[3,0],[17,0]]},"[":{width:14,points:[[4,25],[4,-7],[-1,-1],[5,25],[5,-7],[-1,-1],[4,25],[11,25],[-1,-1],[4,-7],[11,-7]]},"\\":{width:14,points:[[0,21],[14,-3]]},"]":{width:14,points:[[9,25],[9,-7],[-1,-1],[10,25],[10,-7],[-1,-1],[3,25],[10,25],[-1,-1],[3,-7],[10,-7]]},"^":{width:16,points:[[6,15],[8,18],[10,15],[-1,-1],[3,12],[8,17],[13,12],[-1,-1],[8,17],[8,0]]},_:{width:16,points:[[0,-2],[16,-2]]},"`":{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},a:{width:19,points:[[15,14],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},b:{width:19,points:[[4,21],[4,0],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},c:{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},d:{width:19,points:[[15,21],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},e:{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},f:{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],[-1,-1],[2,14],[9,14]]},g:{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},h:{width:19,points:[[4,21],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},i:{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],[-1,-1],[4,14],[4,0]]},j:{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],[-1,-1],[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},k:{width:17,points:[[4,21],[4,0],[-1,-1],[14,14],[4,4],[-1,-1],[8,8],[15,0]]},l:{width:8,points:[[4,21],[4,0]]},m:{width:30,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],[-1,-1],[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},n:{width:19,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},o:{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},p:{width:19,points:[[4,14],[4,-7],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},q:{width:19,points:[[15,14],[15,-7],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},r:{width:13,points:[[4,14],[4,0],[-1,-1],[4,8],[5,11],[7,13],[9,14],[12,14]]},s:{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},t:{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],[-1,-1],[2,14],[9,14]]},u:{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],[-1,-1],[15,14],[15,0]]},v:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0]]},w:{width:22,points:[[3,14],[7,0],[-1,-1],[11,14],[7,0],[-1,-1],[11,14],[15,0],[-1,-1],[19,14],[15,0]]},x:{width:17,points:[[3,14],[14,0],[-1,-1],[14,14],[3,0]]},y:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},z:{width:17,points:[[14,14],[3,0],[-1,-1],[3,14],[14,14],[-1,-1],[3,0],[14,0]]},"{":{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],[-1,-1],[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],[-1,-1],[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},"|":{width:8,points:[[4,25],[4,-7]]},"}":{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],[-1,-1],[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],[-1,-1],[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},"~":{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],[-1,-1],[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]}};function St(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.origin||[0,0,0],i=t[0],r=t[1],n=t[2],s=e.size||1,o=[],a=[],l=e.text;ge.isNumeric(l)&&(l=""+l);for(var u,A,c,h,d,p,f,v,g,m=(l||"").split("\n"),_=0,y=0,b=.04,w=0;w<m.length;w++){u=0,c=(A=m[w]).length;for(var B=0;B<c;B++)if(h=Dt[A.charAt(B)]){d=1,p=-1,f=-1,v=h.points.length;for(var x=0;x<v;x++)-1!==(g=h.points[x])[0]||-1!==g[1]?(o.push(u+g[0]*s*b+i),o.push(y+g[1]*s*b+r),o.push(0+n),-1===p?p=_:(-1===f||(p=f),f=_),_++,d?d=!1:(a.push(p),a.push(f))):d=1;u+=h.width*b*s}y-=35*b*s}return ge.apply(e,{primitive:"lines",positions:o,indices:a})}function Rt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.points.length%3!=0)throw"Size of points array for given polyline should be divisible by 3";var t=e.points.length/3;if(t<2)throw"There should be at least 2 points to create a polyline";for(var i=[],r=0;r<t-1;r++)i.push(r),i.push(r+1);return ge.apply(e,{primitive:"lines",positions:e.points,indices:i})}function Ut(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.curve.getPoints(e.divisions).map((function(e){return f(e)})).flat();return Rt({id:e.id,points:t})}function Lt(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(3!==e.startPoint.length)throw"Start point should contain 3 elements in array: x, y and z";if(3!==e.endPoint.length)throw"End point should contain 3 elements in array: x, y and z";var t=[],i=[],r=e.startPoint[0],n=e.startPoint[1],s=e.startPoint[2],o=e.endPoint[0],a=e.endPoint[1],l=e.endPoint[2],u=Math.sqrt(Math.pow(o-r,2)+Math.pow(a-n,2)+Math.pow(l-s,2)),A=[(o-r)/u,(a-n)/u,(l-s)/u];if(e.pattern){var c=e.pattern.length,h=!1,d=0,p=0,f=0,v=[r,n,s],g=e.pattern[p];for(i.push(v[0],v[1],v[2]);g<=u-d;){var m=[A[0]*g,A[1]*g,A[2]*g],_=[v[0]+m[0],v[1]+m[1],v[2]+m[2]];i.push(_[0],_[1],_[2]),h||(t.push(f),t.push(f+1)),h=!h,f+=1,v=_,(p+=1)>=c&&(p=0),d+=g,g=e.pattern[p]}e.extendToEnd&&(i.push(o,a,l),t.push(t.length-2),t.push(t.length-1))}else t.push(0),t.push(1),i.push(r,n,s,o,a,l);return ge.apply(e,{primitive:"lines",positions:i,indices:t})}var Ot=le.vec4(4),Nt=le.vec4(),Vt=le.vec4(),Qt=le.vec3([1,0,0]),Ht=le.vec3([0,1,0]),Gt=le.vec3([0,0,1]),jt=le.vec3(3),zt=le.vec3(3),Wt=le.identityMat4(),Xt=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,e,n))._parentNode=null,r._children=[],r._aabb=null,r._aabbDirty=!0,r.scene._aabbDirty=!0,r._numTriangles=0,r._scale=le.vec3(),r._quaternion=le.identityQuaternion(),r._rotation=le.vec3(),r._position=le.vec3(),r._offset=le.vec3(),r._localMatrix=le.identityMat4(),r._worldMatrix=le.identityMat4(),r._localMatrixDirty=!0,r._worldMatrixDirty=!0,n.matrix?r.matrix=n.matrix:(r.scale=n.scale,r.position=n.position,n.quaternion||(r.rotation=n.rotation)),r._isModel=n.isModel,r._isModel&&r.scene._registerModel(w(r)),r._isObject=n.isObject,r._isObject&&r.scene._registerObject(w(r)),r.origin=n.origin,r.visible=n.visible,r.culled=n.culled,r.pickable=n.pickable,r.clippable=n.clippable,r.collidable=n.collidable,r.castsShadow=n.castsShadow,r.receivesShadow=n.receivesShadow,r.xrayed=n.xrayed,r.highlighted=n.highlighted,r.selected=n.selected,r.edges=n.edges,r.colorize=n.colorize,r.opacity=n.opacity,r.offset=n.offset,n.children)for(var s=n.children,o=0,a=s.length;o<a;o++)r.addChild(s[o],n.inheritStates);if(n.parentId){var l=r.scene.components[n.parentId];l?l.isNode?l.addChild(w(r)):r.error("Parent is not a Node: '"+n.parentId+"'"):r.error("Parent not found: '"+n.parentId+"'")}else n.parent&&(n.parent.isNode||r.error("Parent is not a Node"),n.parent.addChild(w(r)));return r}return I(i,[{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return this._isObject}},{key:"aabb",get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},{key:"origin",get:function(){return this._origin},set:function(e){e?(this._origin||(this._origin=le.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(var t=0,i=this._children.length;t<i;t++)this._children[t].origin=e;this.glRedraw()}},{key:"rtcCenter",get:function(){return this.origin},set:function(e){this.origin=e}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"visible",get:function(){return this._visible},set:function(e){e=!1!==e,this._visible=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}},{key:"xrayed",get:function(){return this._xrayed},set:function(e){e=!!e,this._xrayed=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}},{key:"highlighted",get:function(){return this._highlighted},set:function(e){e=!!e,this._highlighted=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}},{key:"selected",get:function(){return this._selected},set:function(e){e=!!e,this._selected=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}},{key:"edges",get:function(){return this._edges},set:function(e){e=!!e,this._edges=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}},{key:"culled",get:function(){return this._culled},set:function(e){e=!!e,this._culled=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}},{key:"clippable",get:function(){return this._clippable},set:function(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}},{key:"collidable",get:function(){return this._collidable},set:function(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}},{key:"pickable",get:function(){return this._pickable},set:function(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}},{key:"colorize",get:function(){return this._colorize.slice(0,3)},set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(var i=0,r=this._children.length;i<r;i++)this._children[i].colorize=t;if(this._isObject){var n=!!e;this.scene._objectColorizeUpdated(this,n)}}},{key:"opacity",get:function(){return this._colorize[3]},set:function(e){var t=this._colorize;t||((t=this._colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1;for(var i=0,r=this._children.length;i<r;i++)this._children[i].opacity=e;if(this._isObject){var n=null!=e;this.scene._objectOpacityUpdated(this,n)}}},{key:"castsShadow",get:function(){return this._castsShadow},set:function(e){e=!!e,this._castsShadow=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}},{key:"receivesShadow",get:function(){return this._receivesShadow},set:function(e){e=!!e,this._receivesShadow=e;for(var t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}},{key:"saoEnabled",get:function(){return!1}},{key:"offset",get:function(){return this._offset},set:function(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var t=0,i=this._children.length;t<i;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}},{key:"isNode",get:function(){return!0}},{key:"_setLocalMatrixDirty",value:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}},{key:"_setWorldMatrixDirty",value:function(){this._worldMatrixDirty=!0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}},{key:"_buildWorldMatrix",value:function(){var e=this.matrix;if(this._parentNode)le.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}},{key:"_setSubtreeAABBsDirty",value:function(e){if(e._aabbDirty=!0,e._children)for(var t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}},{key:"_setAABBDirty",value:function(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(var e=this;e;e=e._parentNode)e._aabbDirty=!0}},{key:"_updateAABB",value:function(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=le.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{var e;le.collapseAABB3(this._aabb);for(var t=0,i=this._children.length;t<i;t++)(e=this._children[t]).collidable&&le.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}},{key:"addChild",value:function(e,t){if(ge.isNumeric(e)||ge.isString(e)){var i=e;if(!(e=this.scene.component[i]))return void this.warn("Component not found: "+ge.inQuotes(i));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+i)}else{if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e)}}if(e.id,e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id)}},{key:"removeChild",value:function(e){for(var t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}},{key:"removeChildren",value:function(){for(var e,t=0,i=this._children.length;t<i;t++)(e=this._children[t])._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}},{key:"numChildren",get:function(){return this._children.length}},{key:"children",get:function(){return this._children}},{key:"parent",get:function(){return this._parentNode},set:function(e){if(ge.isNumeric(e)||ge.isString(e)){var t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+ge.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id)}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),le.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),le.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"matrix",get:function(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=le.identityMat4()),le.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix},set:function(e){this._localMatrix||(this._localMatrix=le.identityMat4()),this._localMatrix.set(e||Wt),le.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"worldMatrix",get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},{key:"rotate",value:function(e,t){return Ot[0]=e[0],Ot[1]=e[1],Ot[2]=e[2],Ot[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(Ot,Nt),le.mulQuaternions(this.quaternion,Nt,Vt),this.quaternion=Vt,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"rotateOnWorldAxis",value:function(e,t){return Ot[0]=e[0],Ot[1]=e[1],Ot[2]=e[2],Ot[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(Ot,Nt),le.mulQuaternions(Nt,this.quaternion,Nt),this}},{key:"rotateX",value:function(e){return this.rotate(Qt,e)}},{key:"rotateY",value:function(e){return this.rotate(Ht,e)}},{key:"rotateZ",value:function(e){return this.rotate(Gt,e)}},{key:"translate",value:function(e,t){return le.vec3ApplyQuaternion(this.quaternion,e,jt),le.mulVec3Scalar(jt,t,zt),le.addVec3(this.position,zt,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"translateX",value:function(e){return this.translate(Qt,e)}},{key:"translateY",value:function(e){return this.translate(Ht,e)}},{key:"translateZ",value:function(e){return this.translate(Gt,e)}},{key:"type",get:function(){return"Node"}},{key:"destroy",value:function(){if(v(x(i.prototype),"destroy",this).call(this),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some((function(e){return 0!==e}))&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length)for(var e=this._children.splice(0),t=0,r=e.length;t<r;t++)e[t].destroy();this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}]),i}(),Kt=le.vec3(),Zt=le.vec4(),Jt=function(){var e=new Float64Array(16),t=new Float64Array(4),i=new Float64Array(4);return function(r,n,s){return s=s||e,t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=1,le.transformVec4(r,t,i),le.setMat4Translation(r,i,s),s.slice()}}();function Yt(e,t,i){var r=Float32Array.from([e[0]])[0],n=e[0]-r,s=Float32Array.from([e[1]])[0],o=e[1]-s,a=Float32Array.from([e[2]])[0],l=e[2]-a;t[0]=r,t[1]=s,t[2]=a,i[0]=n,i[1]=o,i[2]=l}function qt(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e3,n=le.getPositionsCenter(e,Kt),s=Math.round(n[0]/r)*r,o=Math.round(n[1]/r)*r,a=Math.round(n[2]/r)*r;i[0]=s,i[1]=o,i[2]=a;var l=0!==i[0]||0!==i[1]||0!==i[2];if(l)for(var u=0,A=e.length;u<A;u+=3)t[u+0]=e[u+0]-s,t[u+1]=e[u+1]-o,t[u+2]=e[u+2]-a;return l}function $t(e,t,i){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i}function ei(e,t,i,r,n){var s=n?(Zt.set(i,0),Zt[3]=1,le.mulMat4v4(n,Zt,Zt)):i,o=le.dotVec3(t,s)+e,a=le.normalizeVec3(t,Kt);return le.mulVec3Scalar(a,-o,r),r}var ti=1e3,ii=1001,ri=1002,ni=1003,si=1004,oi=1004,ai=1005,li=1005,ui=1006,Ai=1007,ci=1007,hi=1008,di=1008,pi=1009,fi=1010,vi=1011,gi=1012,mi=1013,_i=1014,yi=1015,bi=1016,wi=1017,Bi=1018,xi=1020,Pi=1021,Ci=1022,Mi=1023,Fi=1024,ki=1025,Ei=1026,Ii=1027,Ti=1028,Di=1029,Si=1030,Ri=1031,Ui=1033,Li=33776,Oi=33777,Ni=33778,Vi=33779,Qi=35840,Hi=35841,Gi=35842,ji=35843,zi=36196,Wi=37492,Xi=37496,Ki=37808,Zi=37809,Ji=37810,Yi=37811,qi=37812,$i=37813,er=37814,tr=37815,ir=37816,rr=37817,nr=37818,sr=37819,or=37820,ar=37821,lr=36492,ur=3e3,Ar=3001,cr=1e4,hr=10001,dr=10002,pr=10003,fr=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene._lightsState,n=e._geometry._state,s=e._state.billboard,o=e._state.stationary,a=i.getNumAllocatedSectionPlanes()>0,l=!!n.compressGeometry,u=[];u.push("#version 300 es"),u.push("// Lambertian drawing vertex shader"),u.push("in vec3 position;"),u.push("uniform mat4 modelMatrix;"),u.push("uniform mat4 viewMatrix;"),u.push("uniform mat4 projMatrix;"),u.push("uniform vec4 colorize;"),u.push("uniform vec3 offset;"),u.push("uniform vec3 scale;"),l&&u.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(u.push("uniform float logDepthBufFC;"),u.push("out float vFragDepth;"),u.push("bool isPerspectiveMatrix(mat4 m) {"),u.push("    return (m[2][3] == - 1.0);"),u.push("}"),u.push("out float isPerspective;"));a&&u.push("out vec4 vWorldPosition;");if(u.push("uniform vec4 lightAmbient;"),u.push("uniform vec4 materialColor;"),u.push("uniform vec3 materialEmissive;"),n.normalsBuf){u.push("in vec3 normal;"),u.push("uniform mat4 modelNormalMatrix;"),u.push("uniform mat4 viewNormalMatrix;");for(var A=0,c=r.lights.length;A<c;A++){var h=r.lights[A];"ambient"!==h.type&&(u.push("uniform vec4 lightColor"+A+";"),"dir"===h.type&&u.push("uniform vec3 lightDir"+A+";"),"point"===h.type&&u.push("uniform vec3 lightPos"+A+";"),"spot"===h.type&&(u.push("uniform vec3 lightPos"+A+";"),u.push("uniform vec3 lightDir"+A+";")))}l&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}u.push("out vec4 vColor;"),"points"===n.primitiveName&&u.push("uniform float pointSize;");"spherical"!==s&&"cylindrical"!==s||(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = scale[0];"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),"spherical"===s&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = scale[1];"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}"));u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),l&&u.push("localPosition = positionsDecodeMatrix * localPosition;");n.normalsBuf&&(l?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));u.push("mat4 viewMatrix2 = viewMatrix;"),u.push("mat4 modelMatrix2 = modelMatrix;"),o&&u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),n.normalsBuf&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.normalsBuf&&u.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(u.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),u.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),u.push("float lambertian = 1.0;"),n.normalsBuf)for(var d=0,p=r.lights.length;d<p;d++){var f=r.lights[d];if("ambient"!==f.type){if("dir"===f.type)"view"===f.space?u.push("viewLightDir = normalize(lightDir"+d+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);");else if("point"===f.type)"view"===f.space?u.push("viewLightDir = -normalize(lightPos"+d+" - viewPosition.xyz);"):u.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+d+", 0.0)).xyz);");else{if("spot"!==f.type)continue;"view"===f.space?u.push("viewLightDir = normalize(lightDir"+d+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);")}u.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),u.push("reflectedColor += lambertian * (lightColor"+d+".rgb * lightColor"+d+".a);")}}u.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&u.push("vWorldPosition = worldPosition;");"points"===n.primitiveName&&u.push("gl_PointSize = pointSize;");u.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(u.push("vFragDepth = 1.0 + clipPos.w;"),u.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return u.push("gl_Position = clipPos;"),u.push("}"),u}(e),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState;e._material._state;var r=e._geometry._state,n=i.getNumAllocatedSectionPlanes()>0,s=t.gammaOutput,o=[];o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));if(n){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(var a=0,l=i.getNumAllocatedSectionPlanes();a<l;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";")}o.push("in vec4 vColor;"),s&&(o.push("uniform float gammaFactor;"),o.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(o.push("out vec4 outColor;"),o.push("void main(void) {"),n){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(var u=0,A=i.getNumAllocatedSectionPlanes();u<A;u++)o.push("if (sectionPlaneActive"+u+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+u+".xyz, vWorldPosition.xyz - sectionPlanePos"+u+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===r.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e)):(this.vertex=function(e){var t=e.scene;e._material;var i,r=e._state,n=t._sectionPlanesState,s=e._geometry._state,o=t._lightsState,a=r.billboard,l=r.background,u=r.stationary,A=function(e){if(!e._geometry._state.uvBuf)return!1;var t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),c=mr(e),h=n.getNumAllocatedSectionPlanes()>0,d=gr(e),p=!!s.compressGeometry,f=[];f.push("#version 300 es"),f.push("// Drawing vertex shader"),f.push("in  vec3 position;"),p&&f.push("uniform mat4 positionsDecodeMatrix;");f.push("uniform  mat4 modelMatrix;"),f.push("uniform  mat4 viewMatrix;"),f.push("uniform  mat4 projMatrix;"),f.push("out  vec3 vViewPosition;"),f.push("uniform  vec3 offset;"),f.push("uniform  vec3 scale;"),h&&f.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(f.push("uniform float logDepthBufFC;"),f.push("out float vFragDepth;"),f.push("bool isPerspectiveMatrix(mat4 m) {"),f.push("    return (m[2][3] == - 1.0);"),f.push("}"),f.push("out float isPerspective;"));o.lightMaps.length>0&&f.push("out    vec3 vWorldNormal;");if(c){f.push("in  vec3 normal;"),f.push("uniform    mat4 modelNormalMatrix;"),f.push("uniform    mat4 viewNormalMatrix;"),f.push("out    vec3 vViewNormal;");for(var v=0,g=o.lights.length;v<g;v++)"ambient"!==(i=o.lights[v]).type&&("dir"===i.type&&f.push("uniform vec3 lightDir"+v+";"),"point"===i.type&&f.push("uniform vec3 lightPos"+v+";"),"spot"===i.type&&(f.push("uniform vec3 lightPos"+v+";"),f.push("uniform vec3 lightDir"+v+";")),"dir"===i.type&&"view"===i.space||f.push("out vec4 vViewLightReverseDirAndDist"+v+";"));p&&(f.push("vec3 octDecode(vec2 oct) {"),f.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),f.push("    if (v.z < 0.0) {"),f.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),f.push("    }"),f.push("    return normalize(v);"),f.push("}"))}A&&(f.push("in vec2 uv;"),f.push("out vec2 vUV;"),p&&f.push("uniform mat3 uvDecodeMatrix;"));s.colors&&(f.push("in vec4 color;"),f.push("out vec4 vColor;"));"points"===s.primitiveName&&f.push("uniform float pointSize;");"spherical"!==a&&"cylindrical"!==a||(f.push("void billboard(inout mat4 mat) {"),f.push("   mat[0][0] = scale[0];"),f.push("   mat[0][1] = 0.0;"),f.push("   mat[0][2] = 0.0;"),"spherical"===a&&(f.push("   mat[1][0] = 0.0;"),f.push("   mat[1][1] = scale[1];"),f.push("   mat[1][2] = 0.0;")),f.push("   mat[2][0] = 0.0;"),f.push("   mat[2][1] = 0.0;"),f.push("   mat[2][2] =1.0;"),f.push("}"));if(d){f.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(var m=0,_=o.lights.length;m<_;m++)o.lights[m].castsShadow&&(f.push("uniform mat4 shadowViewMatrix"+m+";"),f.push("uniform mat4 shadowProjMatrix"+m+";"),f.push("out vec4 vShadowPosFromLight"+m+";"))}f.push("void main(void) {"),f.push("vec4 localPosition = vec4(position, 1.0); "),f.push("vec4 worldPosition;"),p&&f.push("localPosition = positionsDecodeMatrix * localPosition;");c&&(p?f.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):f.push("vec4 localNormal = vec4(normal, 0.0); "),f.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),f.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));f.push("mat4 viewMatrix2           = viewMatrix;"),f.push("mat4 modelMatrix2          = modelMatrix;"),u?f.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):l&&f.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===a||"cylindrical"===a?(f.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),f.push("billboard(modelMatrix2);"),f.push("billboard(viewMatrix2);"),f.push("billboard(modelViewMatrix);"),c&&(f.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),f.push("billboard(modelNormalMatrix2);"),f.push("billboard(viewNormalMatrix2);"),f.push("billboard(modelViewNormalMatrix);")),f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("worldPosition.xyz = worldPosition.xyz + offset;"),f.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("worldPosition.xyz = worldPosition.xyz + offset;"),f.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(c){f.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&f.push("vWorldNormal = worldNormal;"),f.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),f.push("vec3 tmpVec3;"),f.push("float lightDist;");for(var y=0,b=o.lights.length;y<b;y++)"ambient"!==(i=o.lights[y]).type&&("dir"===i.type&&"world"===i.space&&(f.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+y+", 0.0) ).xyz;"),f.push("vViewLightReverseDirAndDist"+y+" = vec4(-tmpVec3, 0.0);")),"point"===i.type&&("world"===i.space?(f.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+y+", 1.0)).xyz - viewPosition.xyz;"),f.push("lightDist = abs(length(tmpVec3));")):(f.push("tmpVec3 = lightPos"+y+".xyz - viewPosition.xyz;"),f.push("lightDist = abs(length(tmpVec3));")),f.push("vViewLightReverseDirAndDist"+y+" = vec4(tmpVec3, lightDist);")))}A&&(p?f.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):f.push("vUV = uv;"));s.colors&&f.push("vColor = color;");"points"===s.primitiveName&&f.push("gl_PointSize = pointSize;");h&&f.push("vWorldPosition = worldPosition;");f.push("   vViewPosition = viewPosition.xyz;"),f.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(f.push("vFragDepth = 1.0 + clipPos.w;"),f.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));l&&f.push("clipPos.z = clipPos.w;");if(f.push("gl_Position = clipPos;"),d){f.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),f.push("vec4 tempx; ");for(var w=0,B=o.lights.length;w<B;w++)o.lights[w].castsShadow&&f.push("vShadowPosFromLight"+w+" = texUnitConverter * shadowProjMatrix"+w+" * (shadowViewMatrix"+w+" * worldPosition); ")}return f.push("}"),f}(e),this.fragment=function(e){var t=e.scene;t.canvas.gl;var i=e._material,r=e._geometry._state,n=e.scene._sectionPlanesState,s=e.scene._lightsState,o=e._material._state,a=n.getNumAllocatedSectionPlanes()>0,l=mr(e),u=r.uvBuf,A="PhongMaterial"===o.type,c="MetallicMaterial"===o.type,h="SpecularMaterial"===o.type,d=gr(e);t.gammaInput;var p=t.gammaOutput,f=[];f.push("#version 300 es"),f.push("// Drawing fragment shader"),f.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),f.push("precision highp float;"),f.push("precision highp int;"),f.push("#else"),f.push("precision mediump float;"),f.push("precision mediump int;"),f.push("#endif"),t.logarithmicDepthBufferEnabled&&(f.push("in float isPerspective;"),f.push("uniform float logDepthBufFC;"),f.push("in float vFragDepth;"));d&&(f.push("float unpackDepth (vec4 color) {"),f.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),f.push("  return dot(color, bitShift);"),f.push("}"));f.push("uniform float gammaFactor;"),f.push("vec4 linearToLinear( in vec4 value ) {"),f.push("  return value;"),f.push("}"),f.push("vec4 sRGBToLinear( in vec4 value ) {"),f.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),f.push("}"),f.push("vec4 gammaToLinear( in vec4 value) {"),f.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),f.push("}"),p&&(f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}"));if(a){f.push("in vec4 vWorldPosition;"),f.push("uniform bool clippable;");for(var v=0;v<n.getNumAllocatedSectionPlanes();v++)f.push("uniform bool sectionPlaneActive"+v+";"),f.push("uniform vec3 sectionPlanePos"+v+";"),f.push("uniform vec3 sectionPlaneDir"+v+";")}l&&(s.lightMaps.length>0&&(f.push("uniform samplerCube lightMap;"),f.push("uniform mat4 viewNormalMatrix;")),s.reflectionMaps.length>0&&f.push("uniform samplerCube reflectionMap;"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&f.push("uniform mat4 viewMatrix;"),f.push("#define PI 3.14159265359"),f.push("#define RECIPROCAL_PI 0.31830988618"),f.push("#define RECIPROCAL_PI2 0.15915494"),f.push("#define EPSILON 1e-6"),f.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),f.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),f.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),f.push("}"),f.push("struct IncidentLight {"),f.push("   vec3 color;"),f.push("   vec3 direction;"),f.push("};"),f.push("struct ReflectedLight {"),f.push("   vec3 diffuse;"),f.push("   vec3 specular;"),f.push("};"),f.push("struct Geometry {"),f.push("   vec3 position;"),f.push("   vec3 viewNormal;"),f.push("   vec3 worldNormal;"),f.push("   vec3 viewEyeDir;"),f.push("};"),f.push("struct Material {"),f.push("   vec3    diffuseColor;"),f.push("   float   specularRoughness;"),f.push("   vec3    specularColor;"),f.push("   float   shine;"),f.push("};"),A&&((s.lightMaps.length>0||s.reflectionMaps.length>0)&&(f.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(f.push("   vec3 irradiance = "+vr[s.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),f.push("   radiance *= PI;"),f.push("   reflectedLight.specular     += radiance;")),f.push("}")),f.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),f.push("   vec3 irradiance = dotNL * directLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),f.push("}")),(c||h)&&(f.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),f.push("   float r = ggxRoughness + 0.0001;"),f.push("   return (2.0 / (r * r) - 2.0);"),f.push("}"),f.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),f.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),f.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),f.push("}"),s.reflectionMaps.length>0&&(f.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),f.push("   vec3 envMapColor = "+vr[s.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),f.push("  return envMapColor;"),f.push("}")),f.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),f.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),f.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),f.push("}"),f.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   return 1.0 / ( gl * gv );"),f.push("}"),f.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   return 0.5 / max( gv + gl, EPSILON );"),f.push("}"),f.push("float D_GGX(const in float alpha, const in float dotNH) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),f.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float alpha = ( roughness * roughness );"),f.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),f.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),f.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),f.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),f.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),f.push("   vec3  F = F_Schlick( specularColor, dotLH );"),f.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),f.push("   float D = D_GGX( alpha, dotNH );"),f.push("   return F * (G * D);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),f.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),f.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),f.push("   vec4 r = roughness * c0 + c1;"),f.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),f.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),f.push("   return specularColor * AB.x + AB.y;"),f.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(f.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(f.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),f.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),f.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),f.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),f.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),f.push("}")),f.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),f.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),f.push("}")));f.push("in vec3 vViewPosition;"),r.colors&&f.push("in vec4 vColor;");u&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&f.push("in vec2 vUV;");l&&(s.lightMaps.length>0&&f.push("in vec3 vWorldNormal;"),f.push("in vec3 vViewNormal;"));o.ambient&&f.push("uniform vec3 materialAmbient;");o.baseColor&&f.push("uniform vec3 materialBaseColor;");void 0!==o.alpha&&null!==o.alpha&&f.push("uniform vec4 materialAlphaModeCutoff;");o.emissive&&f.push("uniform vec3 materialEmissive;");o.diffuse&&f.push("uniform vec3 materialDiffuse;");void 0!==o.glossiness&&null!==o.glossiness&&f.push("uniform float materialGlossiness;");void 0!==o.shininess&&null!==o.shininess&&f.push("uniform float materialShininess;");o.specular&&f.push("uniform vec3 materialSpecular;");void 0!==o.metallic&&null!==o.metallic&&f.push("uniform float materialMetallic;");void 0!==o.roughness&&null!==o.roughness&&f.push("uniform float materialRoughness;");void 0!==o.specularF0&&null!==o.specularF0&&f.push("uniform float materialSpecularF0;");u&&i._ambientMap&&(f.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&f.push("uniform mat4 ambientMapMatrix;"));u&&i._baseColorMap&&(f.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&f.push("uniform mat4 baseColorMapMatrix;"));u&&i._diffuseMap&&(f.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&f.push("uniform mat4 diffuseMapMatrix;"));u&&i._emissiveMap&&(f.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&f.push("uniform mat4 emissiveMapMatrix;"));l&&u&&i._metallicMap&&(f.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&f.push("uniform mat4 metallicMapMatrix;"));l&&u&&i._roughnessMap&&(f.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&f.push("uniform mat4 roughnessMapMatrix;"));l&&u&&i._metallicRoughnessMap&&(f.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&f.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(f.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&f.push("uniform mat4 normalMapMatrix;"),f.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),f.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),f.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),f.push("      vec2 st0 = dFdx( uv.st );"),f.push("      vec2 st1 = dFdy( uv.st );"),f.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),f.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),f.push("      vec3 N = normalize( surf_norm );"),f.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),f.push("      mat3 tsn = mat3( S, T, N );"),f.push("      return normalize( tsn * mapN );"),f.push("}"));u&&i._occlusionMap&&(f.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&f.push("uniform mat4 occlusionMapMatrix;"));u&&i._alphaMap&&(f.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&f.push("uniform mat4 alphaMapMatrix;"));l&&u&&i._specularMap&&(f.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&f.push("uniform mat4 specularMapMatrix;"));l&&u&&i._glossinessMap&&(f.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&f.push("uniform mat4 glossinessMapMatrix;"));l&&u&&i._specularGlossinessMap&&(f.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&f.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(f.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),f.push("    float fr = abs(dot(eyeDir, normal));"),f.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),f.push("    return pow(finalFr, power);"),f.push("}"),i._diffuseFresnel&&(f.push("uniform float  diffuseFresnelCenterBias;"),f.push("uniform float  diffuseFresnelEdgeBias;"),f.push("uniform float  diffuseFresnelPower;"),f.push("uniform vec3   diffuseFresnelCenterColor;"),f.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(f.push("uniform float  specularFresnelCenterBias;"),f.push("uniform float  specularFresnelEdgeBias;"),f.push("uniform float  specularFresnelPower;"),f.push("uniform vec3   specularFresnelCenterColor;"),f.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(f.push("uniform float  alphaFresnelCenterBias;"),f.push("uniform float  alphaFresnelEdgeBias;"),f.push("uniform float  alphaFresnelPower;"),f.push("uniform vec3   alphaFresnelCenterColor;"),f.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(f.push("uniform float  materialSpecularF0FresnelCenterBias;"),f.push("uniform float  materialSpecularF0FresnelEdgeBias;"),f.push("uniform float  materialSpecularF0FresnelPower;"),f.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),f.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(f.push("uniform float  emissiveFresnelCenterBias;"),f.push("uniform float  emissiveFresnelEdgeBias;"),f.push("uniform float  emissiveFresnelPower;"),f.push("uniform vec3   emissiveFresnelCenterColor;"),f.push("uniform vec3   emissiveFresnelEdgeColor;")));if(f.push("uniform vec4   lightAmbient;"),l)for(var g=0,m=s.lights.length;g<m;g++){var _=s.lights[g];"ambient"!==_.type&&(f.push("uniform vec4 lightColor"+g+";"),"point"===_.type&&f.push("uniform vec3 lightAttenuation"+g+";"),"dir"===_.type&&"view"===_.space&&f.push("uniform vec3 lightDir"+g+";"),"point"===_.type&&"view"===_.space?f.push("uniform vec3 lightPos"+g+";"):f.push("in vec4 vViewLightReverseDirAndDist"+g+";"))}if(d)for(var y=0,b=s.lights.length;y<b;y++)s.lights[y].castsShadow&&(f.push("in vec4 vShadowPosFromLight"+y+";"),f.push("uniform sampler2D shadowMap"+y+";"));if(f.push("uniform vec4 colorize;"),f.push("out vec4 outColor;"),f.push("void main(void) {"),a){f.push("if (clippable) {"),f.push("  float dist = 0.0;");for(v=0;v<n.getNumAllocatedSectionPlanes();v++)f.push("if (sectionPlaneActive"+v+") {"),f.push("   dist += clamp(dot(-sectionPlaneDir"+v+".xyz, vWorldPosition.xyz - sectionPlanePos"+v+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}"points"===r.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}"));f.push("float occlusion = 1.0;"),o.ambient?f.push("vec3 ambientColor = materialAmbient;"):f.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");o.diffuse?f.push("vec3 diffuseColor = materialDiffuse;"):o.baseColor?f.push("vec3 diffuseColor = materialBaseColor;"):f.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");r.colors&&f.push("diffuseColor *= vColor.rgb;");o.emissive?f.push("vec3 emissiveColor = materialEmissive;"):f.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");o.specular?f.push("vec3 specular = materialSpecular;"):f.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==o.alpha?f.push("float alpha = materialAlphaModeCutoff[0];"):f.push("float alpha = 1.0;");r.colors&&f.push("alpha *= vColor.a;");void 0!==o.glossiness?f.push("float glossiness = materialGlossiness;"):f.push("float glossiness = 1.0;");void 0!==o.metallic?f.push("float metallic = materialMetallic;"):f.push("float metallic = 1.0;");void 0!==o.roughness?f.push("float roughness = materialRoughness;"):f.push("float roughness = 1.0;");void 0!==o.specularF0?f.push("float specularF0 = materialSpecularF0;"):f.push("float specularF0 = 1.0;");u&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(f.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),f.push("vec2 textureCoord;"));u&&i._ambientMap&&(i._ambientMap._state.matrix?f.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),f.push("ambientTexel = "+vr[i._ambientMap._state.encoding]+"(ambientTexel);"),f.push("ambientColor *= ambientTexel.rgb;"));u&&i._diffuseMap&&(i._diffuseMap._state.matrix?f.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),f.push("diffuseTexel = "+vr[i._diffuseMap._state.encoding]+"(diffuseTexel);"),f.push("diffuseColor *= diffuseTexel.rgb;"),f.push("alpha *= diffuseTexel.a;"));u&&i._baseColorMap&&(i._baseColorMap._state.matrix?f.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),f.push("baseColorTexel = "+vr[i._baseColorMap._state.encoding]+"(baseColorTexel);"),f.push("diffuseColor *= baseColorTexel.rgb;"),f.push("alpha *= baseColorTexel.a;"));u&&i._emissiveMap&&(i._emissiveMap._state.matrix?f.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),f.push("emissiveTexel = "+vr[i._emissiveMap._state.encoding]+"(emissiveTexel);"),f.push("emissiveColor = emissiveTexel.rgb;"));u&&i._alphaMap&&(i._alphaMap._state.matrix?f.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("alpha *= texture(alphaMap, textureCoord).r;"));u&&i._occlusionMap&&(i._occlusionMap._state.matrix?f.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("occlusion *= texture(occlusionMap, textureCoord).r;"));if(l&&(s.lights.length>0||s.lightMaps.length>0||s.reflectionMaps.length>0)){u&&i._normalMap?(i._normalMap._state.matrix?f.push("textureCoord = (normalMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):f.push("vec3 viewNormal = normalize(vViewNormal);"),u&&i._specularMap&&(i._specularMap._state.matrix?f.push("textureCoord = (specularMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("specular *= texture(specularMap, textureCoord).rgb;")),u&&i._glossinessMap&&(i._glossinessMap._state.matrix?f.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("glossiness *= texture(glossinessMap, textureCoord).r;")),u&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?f.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),f.push("specular *= specGlossRGB.rgb;"),f.push("glossiness *= specGlossRGB.a;")),u&&i._metallicMap&&(i._metallicMap._state.matrix?f.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("metallic *= texture(metallicMap, textureCoord).r;")),u&&i._roughnessMap&&(i._roughnessMap._state.matrix?f.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("roughness *= texture(roughnessMap, textureCoord).r;")),u&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?f.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),f.push("metallic *= metalRoughRGB.b;"),f.push("roughness *= metalRoughRGB.g;")),f.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(f.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),f.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(f.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),f.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(f.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),f.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(f.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),f.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),f.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),f.push("   discard;"),f.push("}"),f.push("IncidentLight  light;"),f.push("Material       material;"),f.push("Geometry       geometry;"),f.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),f.push("vec3           viewLightDir;"),A&&(f.push("material.diffuseColor      = diffuseColor;"),f.push("material.specularColor     = specular;"),f.push("material.shine             = materialShininess;")),h&&(f.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),f.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),f.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),f.push("material.specularColor     = specular;")),c&&(f.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),f.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),f.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),f.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),f.push("geometry.position      = vViewPosition;"),s.lightMaps.length>0&&f.push("geometry.worldNormal   = normalize(vWorldNormal);"),f.push("geometry.viewNormal    = viewNormal;"),f.push("geometry.viewEyeDir    = viewEyeDir;"),A&&(s.lightMaps.length>0||s.reflectionMaps.length>0)&&f.push("computePhongLightMapping(geometry, material, reflectedLight);"),(h||c)&&(s.lightMaps.length>0||s.reflectionMaps.length>0)&&f.push("computePBRLightMapping(geometry, material, reflectedLight);"),f.push("float shadow = 1.0;"),f.push("float shadowAcneRemover = 0.007;"),f.push("vec3 fragmentDepth;"),f.push("float texelSize = 1.0 / 1024.0;"),f.push("float amountInLight = 0.0;"),f.push("vec3 shadowCoord;"),f.push("vec4 rgbaDepth;"),f.push("float depth;");for(var w=0,B=s.lights.length;w<B;w++){var x=s.lights[w];"ambient"!==x.type&&("dir"===x.type&&"view"===x.space?f.push("viewLightDir = -normalize(lightDir"+w+");"):"point"===x.type&&"view"===x.space?f.push("viewLightDir = normalize(lightPos"+w+" - vViewPosition);"):f.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+w+".xyz);"),d&&x.castsShadow?(f.push("shadow = 0.0;"),f.push("fragmentDepth = vShadowPosFromLight"+w+".xyz;"),f.push("fragmentDepth.z -= shadowAcneRemover;"),f.push("for (int x = -3; x <= 3; x++) {"),f.push("  for (int y = -3; y <= 3; y++) {"),f.push("      float texelDepth = unpackDepth(texture(shadowMap"+w+", fragmentDepth.xy + vec2(x, y) * texelSize));"),f.push("      if (fragmentDepth.z < texelDepth) {"),f.push("          shadow += 1.0;"),f.push("      }"),f.push("  }"),f.push("}"),f.push("shadow = shadow / 9.0;"),f.push("light.color =  lightColor"+w+".rgb * (lightColor"+w+".a * shadow);")):f.push("light.color =  lightColor"+w+".rgb * (lightColor"+w+".a );"),f.push("light.direction = viewLightDir;"),A&&f.push("computePhongLighting(light, geometry, material, reflectedLight);"),(h||c)&&f.push("computePBRLighting(light, geometry, material, reflectedLight);"))}A?f.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):f.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else f.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),f.push("vec3 outgoingLight = emissiveColor + ambientColor;");f.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),p&&f.push("fragColor = linearToGamma(fragColor, gammaFactor);");f.push("outColor = fragColor;"),t.logarithmicDepthBufferEnabled&&f.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return f.push("}"),f}(e))},vr={};function gr(e){if(!e.receivesShadow)return!1;var t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(var i=0,r=t.length;i<r;i++)if(t[i].castsShadow)return!0;return!1}function mr(e){var t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}vr[3e3]="linearToLinear",vr[3001]="sRGBToLinear";var _r=function(){function e(t,i,r){if(k(this,e),this.allocated=!1,this.compiled=!1,this.handle=t.createShader(i),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,r),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){for(var n=r.split("\n"),s=[],o=0;o<n.length;o++)s.push(o+1+": "+n[o]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}return I(e,[{key:"destroy",value:function(){}}]),e}(),yr=I((function e(t,i){k(this,e),this.bindTexture=function(e,r){return!!e.bind(r)&&(t.uniform1i(i,r),!0)}})),br=function(){function e(t,i){k(this,e),this._gl=t,this.location=i}return I(e,[{key:"bindArrayBuffer",value:function(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}]),e}(),wr=new Z({});function Br(e){for(var t,i,r=[],n=0,s=e.length;n<s;n++)(i=(t=e[n]).indexOf("/"))>0&&"/"===t.charAt(i+1)&&(t=t.substring(0,i)),r.push(t);return r.join("\n")}function xr(e){console.error(e.join("\n"))}var Pr=function(){function e(t,i){k(this,e),this.id=wr.addItem({}),this.source=i,this.init(t)}return I(e,[{key:"init",value:function(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new _r(e,e.VERTEX_SHADER,Br(this.source.vertex)),this._fragmentShader=new _r(e,e.FRAGMENT_SHADER,Br(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void xr(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void xr(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void xr(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void xr(this.errors);var t,i,r,n,s;if(this.compiled=!0,this.handle=e.createProgram(),this.handle){if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void xr(this.errors);var o=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<o;++i)(r=e.getActiveUniform(this.handle,i))&&("\0"===(n=r.name)[n.length-1]&&(n=n.substr(0,n.length-1)),s=e.getUniformLocation(this.handle,n),r.type===e.SAMPLER_2D||r.type===e.SAMPLER_CUBE||35682===r.type||e instanceof WebGL2RenderingContext&&(r.type===e.UNSIGNED_INT_SAMPLER_2D||r.type===e.INT_SAMPLER_2D)?this.samplers[n]=new yr(e,s):this.uniforms[n]=s);var a=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<a;i++)(t=e.getActiveAttrib(this.handle,i))&&(s=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new br(e,s));this.allocated=!0}else this.errors=["Failed to allocate program"]}},{key:"bind",value:function(){this.allocated&&this.gl.useProgram(this.handle)}},{key:"getLocation",value:function(e){if(this.allocated)return this.uniforms[e]}},{key:"getAttribute",value:function(e){if(this.allocated)return this.attributes[e]}},{key:"bindTexture",value:function(e,t,i){if(!this.allocated)return!1;var r=this.samplers[e];return!!r&&r.bindTexture(t,i)}},{key:"destroy",value:function(){this.allocated&&(wr.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}]),e}(),Cr={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},Mr=document.createElement("canvas");if(Mr){var Fr=Mr.getContext("webgl",{antialias:!0})||Mr.getContext("experimental-webgl",{antialias:!0});Cr.WEBGL=!!Fr,Cr.WEBGL&&(Cr.ANTIALIAS=Fr.getContextAttributes().antialias,Fr.getShaderPrecisionFormat?Fr.getShaderPrecisionFormat(Fr.FRAGMENT_SHADER,Fr.HIGH_FLOAT).precision>0?Cr.FS_MAX_FLOAT_PRECISION="highp":Fr.getShaderPrecisionFormat(Fr.FRAGMENT_SHADER,Fr.MEDIUM_FLOAT).precision>0?Cr.FS_MAX_FLOAT_PRECISION="mediump":Cr.FS_MAX_FLOAT_PRECISION="lowp":Cr.FS_MAX_FLOAT_PRECISION="mediump",Cr.DEPTH_BUFFER_BITS=Fr.getParameter(Fr.DEPTH_BITS),Cr.MAX_TEXTURE_SIZE=Fr.getParameter(Fr.MAX_TEXTURE_SIZE),Cr.MAX_CUBE_MAP_SIZE=Fr.getParameter(Fr.MAX_CUBE_MAP_TEXTURE_SIZE),Cr.MAX_RENDERBUFFER_SIZE=Fr.getParameter(Fr.MAX_RENDERBUFFER_SIZE),Cr.MAX_TEXTURE_UNITS=Fr.getParameter(Fr.MAX_COMBINED_TEXTURE_IMAGE_UNITS),Cr.MAX_TEXTURE_IMAGE_UNITS=Fr.getParameter(Fr.MAX_TEXTURE_IMAGE_UNITS),Cr.MAX_VERTEX_ATTRIBS=Fr.getParameter(Fr.MAX_VERTEX_ATTRIBS),Cr.MAX_VERTEX_UNIFORM_VECTORS=Fr.getParameter(Fr.MAX_VERTEX_UNIFORM_VECTORS),Cr.MAX_FRAGMENT_UNIFORM_VECTORS=Fr.getParameter(Fr.MAX_FRAGMENT_UNIFORM_VECTORS),Cr.MAX_VARYING_VECTORS=Fr.getParameter(Fr.MAX_VARYING_VECTORS),Fr.getSupportedExtensions().forEach((function(e){Cr.SUPPORTED_EXTENSIONS[e]=!0})))}var kr=le.vec3(),Er=new Z({}),Ir=function(e,t){this.id=Er.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new fr(t),this._allocate(t)},Tr={};Ir.get=function(e){var t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";"),r=Tr[i];if(!r){if((r=new Ir(i,e)).errors)return console.log(r.errors.join("\n")),null;Tr[i]=r,he.memory.programs++}return r._useCount++,r},Ir.prototype.put=function(){0==--this._useCount&&(Er.removeItem(this.id),this._program&&this._program.destroy(),delete Tr[this._hash],he.memory.programs--)},Ir.prototype.webglContextRestored=function(){this._program=null},Ir.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=Cr.MAX_TEXTURE_UNITS,r=t.scene,n=t._material,s=r.canvas.gl,o=this._program,a=t._state,l=t._material._state,u=t._geometry._state,A=r.camera,c=t.origin,h=a.background;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,h&&s.depthFunc(s.LEQUAL),this._bindProgram(e)),s.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(a.originHash,c):A.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,A.viewNormalMatrix),a.clippable){var d=r._sectionPlanesState.getNumAllocatedSectionPlanes(),p=r._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=r._sectionPlanesState.sectionPlanes,v=t.renderFlags,g=0;g<d;g++){var m=this._uSectionPlanes[g];if(m)if(g<p){var _=v.sectionPlanesActivePerLayer[g];if(s.uniform1i(m.active,_?1:0),_){var y=f[g];if(c){var b=ei(y.dist,y.dir,c,kr);s.uniform3fv(m.pos,b)}else s.uniform3fv(m.pos,y.pos);s.uniform3fv(m.dir,y.dir)}}else s.uniform1i(m.active,0)}}if(l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;var w=l.backfaces;e.backfaces!==w&&(w?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=w);var B=l.frontface;switch(e.frontface!==B&&(B?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=B),e.lineWidth!==l.lineWidth&&(s.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&s.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&s.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&s.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&s.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&s.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&s.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&s.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&s.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&s.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&s.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),n._ambientMap&&n._ambientMap._state.texture&&this._uMaterialAmbientMap&&(o.bindTexture(this._uMaterialAmbientMap,n._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&s.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,n._ambientMap._state.matrix)),n._diffuseMap&&n._diffuseMap._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,n._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&s.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,n._diffuseMap._state.matrix)),n._specularMap&&n._specularMap._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,n._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&s.uniformMatrix4fv(this._uSpecularMapMatrix,!1,n._specularMap._state.matrix)),n._emissiveMap&&n._emissiveMap._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,n._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&s.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,n._emissiveMap._state.matrix)),n._alphaMap&&n._alphaMap._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,n._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&s.uniformMatrix4fv(this._uAlphaMapMatrix,!1,n._alphaMap._state.matrix)),n._reflectivityMap&&n._reflectivityMap._state.texture&&this._uReflectivityMap&&(o.bindTexture(this._uReflectivityMap,n._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&s.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,n._reflectivityMap._state.matrix)),n._normalMap&&n._normalMap._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,n._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&s.uniformMatrix4fv(this._uNormalMapMatrix,!1,n._normalMap._state.matrix)),n._occlusionMap&&n._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,n._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&s.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,n._occlusionMap._state.matrix)),n._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&s.uniform1f(this._uDiffuseFresnelEdgeBias,n._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&s.uniform1f(this._uDiffuseFresnelCenterBias,n._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&s.uniform3fv(this._uDiffuseFresnelEdgeColor,n._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&s.uniform3fv(this._uDiffuseFresnelCenterColor,n._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&s.uniform1f(this._uDiffuseFresnelPower,n._diffuseFresnel.power)),n._specularFresnel&&(this._uSpecularFresnelEdgeBias&&s.uniform1f(this._uSpecularFresnelEdgeBias,n._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&s.uniform1f(this._uSpecularFresnelCenterBias,n._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&s.uniform3fv(this._uSpecularFresnelEdgeColor,n._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&s.uniform3fv(this._uSpecularFresnelCenterColor,n._specularFresnel.centerColor),this._uSpecularFresnelPower&&s.uniform1f(this._uSpecularFresnelPower,n._specularFresnel.power)),n._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&s.uniform1f(this._uAlphaFresnelEdgeBias,n._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&s.uniform1f(this._uAlphaFresnelCenterBias,n._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&s.uniform3fv(this._uAlphaFresnelEdgeColor,n._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&s.uniform3fv(this._uAlphaFresnelCenterColor,n._alphaFresnel.centerColor),this._uAlphaFresnelPower&&s.uniform1f(this._uAlphaFresnelPower,n._alphaFresnel.power)),n._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&s.uniform1f(this._uReflectivityFresnelEdgeBias,n._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&s.uniform1f(this._uReflectivityFresnelCenterBias,n._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&s.uniform3fv(this._uReflectivityFresnelEdgeColor,n._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&s.uniform3fv(this._uReflectivityFresnelCenterColor,n._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&s.uniform1f(this._uReflectivityFresnelPower,n._reflectivityFresnel.power)),n._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&s.uniform1f(this._uEmissiveFresnelEdgeBias,n._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&s.uniform1f(this._uEmissiveFresnelCenterBias,n._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&s.uniform3fv(this._uEmissiveFresnelEdgeColor,n._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&s.uniform3fv(this._uEmissiveFresnelCenterColor,n._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&s.uniform1f(this._uEmissiveFresnelPower,n._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&s.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&s.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&s.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&s.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&s.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&s.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var x=n._baseColorMap;x&&x._state.texture&&this._uBaseColorMap&&(o.bindTexture(this._uBaseColorMap,x._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&s.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,x._state.matrix));var P=n._metallicMap;P&&P._state.texture&&this._uMetallicMap&&(o.bindTexture(this._uMetallicMap,P._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&s.uniformMatrix4fv(this._uMetallicMapMatrix,!1,P._state.matrix));var C=n._roughnessMap;C&&C._state.texture&&this._uRoughnessMap&&(o.bindTexture(this._uRoughnessMap,C._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&s.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,C._state.matrix));var M=n._metallicRoughnessMap;M&&M._state.texture&&this._uMetallicRoughnessMap&&(o.bindTexture(this._uMetallicRoughnessMap,M._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&s.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,M._state.matrix)),(I=n._emissiveMap)&&I._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,I._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&s.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,I._state.matrix)),(T=n._occlusionMap)&&n._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,T._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&s.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,T._state.matrix)),(D=n._alphaMap)&&D._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,D._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&s.uniformMatrix4fv(this._uAlphaMapMatrix,!1,D._state.matrix)),(S=n._normalMap)&&S._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,S._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&s.uniformMatrix4fv(this._uNormalMapMatrix,!1,S._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&s.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&s.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&s.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&s.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&s.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&s.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var F=n._diffuseMap;F&&F._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,F._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&s.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,F._state.matrix));var k=n._specularMap;k&&k._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,k._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&s.uniformMatrix4fv(this._uSpecularMapMatrix,!1,k._state.matrix));var E=n._glossinessMap;E&&E._state.texture&&this._uGlossinessMap&&(o.bindTexture(this._uGlossinessMap,E._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&s.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,E._state.matrix));var I,T,D,S,R=n._specularGlossinessMap;R&&R._state.texture&&this._uSpecularGlossinessMap&&(o.bindTexture(this._uSpecularGlossinessMap,R._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&s.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,R._state.matrix)),(I=n._emissiveMap)&&I._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,I._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&s.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,I._state.matrix)),(T=n._occlusionMap)&&T._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,T._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&s.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,T._state.matrix)),(D=n._alphaMap)&&D._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,D._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&s.uniformMatrix4fv(this._uAlphaMapMatrix,!1,D._state.matrix)),(S=n._normalMap)&&S._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,S._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&s.uniformMatrix4fv(this._uNormalMapMatrix,!1,S._state.matrix))}this._lastMaterialId=l.id}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),this._uColorize){var U=a.colorize,L=this._lastColorize;L[0]===U[0]&&L[1]===U[1]&&L[2]===U[2]&&L[3]===U[3]||(s.uniform4fv(this._uColorize,U),L[0]=U[0],L[1]=U[1],L[2]=U[2],L[3]=U[3])}s.uniform3fv(this._uOffset,a.offset),s.uniform3fv(this._uScale,t.scale),u.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._uUVDecodeMatrix&&s.uniformMatrix3fv(this._uUVDecodeMatrix,!1,u.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(u.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(u.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(u.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(u.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(u.flagsBuf),e.bindArray++),u.indicesBuf&&(u.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=u.id),u.indicesBuf?(s.drawElements(u.primitive,u.indicesBuf.numItems,u.indicesBuf.itemType,0),e.drawElements++):u.positions&&(s.drawArrays(s.TRIANGLES,0,u.positions.numItems),e.drawArrays++),h&&s.depthFunc(s.LESS)},Ir.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl,r=e._material,n=t._lightsState,s=t._sectionPlanesState,o=e._material._state;if(this._program=new Pr(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));for(var l,u=n.lights,A=0,c=u.length;A<c;A++){switch((l=u[A]).type){case"ambient":this._uLightAmbient[A]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[A]=a.getLocation("lightColor"+A),this._uLightPos[A]=null,this._uLightDir[A]=a.getLocation("lightDir"+A);break;case"point":this._uLightColor[A]=a.getLocation("lightColor"+A),this._uLightPos[A]=a.getLocation("lightPos"+A),this._uLightDir[A]=null,this._uLightAttenuation[A]=a.getLocation("lightAttenuation"+A);break;case"spot":this._uLightColor[A]=a.getLocation("lightColor"+A),this._uLightPos[A]=a.getLocation("lightPos"+A),this._uLightDir[A]=a.getLocation("lightDir"+A),this._uLightAttenuation[A]=a.getLocation("lightAttenuation"+A)}l.castsShadow&&(this._uShadowViewMatrix[A]=a.getLocation("shadowViewMatrix"+A),this._uShadowProjMatrix[A]=a.getLocation("shadowProjMatrix"+A))}n.lightMaps.length>0&&(this._uLightMap="lightMap"),n.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(A=0,c=s.sectionPlanes.length;A<c;A++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+A),pos:a.getLocation("sectionPlanePos"+A),dir:a.getLocation("sectionPlaneDir"+A)});switch(this._uPointSize=a.getLocation("pointSize"),o.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),r._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),r._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),r._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),r._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),r._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),r._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),r._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),r._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),r._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"))}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._uScale=a.getLocation("scale"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0}},Ir.prototype._bindProgram=function(e){var t,i=Cr.MAX_TEXTURE_UNITS,r=this._scene,n=r.canvas.gl,s=r._lightsState,o=r.camera.project,a=this._program;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,n.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),r.logarithmicDepthBufferEnabled){var l=2/(Math.log(o.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,l)}for(var u=0,A=s.lights.length;u<A;u++)if(t=s.lights[u],this._uLightAmbient[u])n.uniform4f(this._uLightAmbient[u],t.color[0],t.color[1],t.color[2],t.intensity);else if(this._uLightColor[u]&&n.uniform4f(this._uLightColor[u],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[u]&&(n.uniform3fv(this._uLightPos[u],t.pos),this._uLightAttenuation[u]&&n.uniform1f(this._uLightAttenuation[u],t.attenuation)),this._uLightDir[u]&&n.uniform3fv(this._uLightDir[u],t.dir),t.castsShadow){this._uShadowViewMatrix[u]&&n.uniformMatrix4fv(this._uShadowViewMatrix[u],!1,t.getShadowViewMatrix()),this._uShadowProjMatrix[u]&&n.uniformMatrix4fv(this._uShadowProjMatrix[u],!1,t.getShadowProjMatrix());var c=t.getShadowRenderBuf();c&&(a.bindTexture("shadowMap"+u,c.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++)}s.lightMaps.length>0&&s.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,s.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),s.reflectionMaps.length>0&&s.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,s.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),this._uGammaFactor&&n.uniform1f(this._uGammaFactor,r.gammaFactor),this._baseTextureUnit=e.textureUnit};var Dr=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene,i=t._lightsState,r=function(e){var t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),n=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!e._geometry._state.compressGeometry,o=e._state.billboard,a=e._state.stationary,l=[];l.push("#version 300 es"),l.push("// EmphasisFillShaderSource vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),l.push("uniform vec3 scale;"),s&&l.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;"));n&&l.push("out vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),r){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(var u=0,A=i.lights.length;u<A;u++){var c=i.lights[u];"ambient"!==c.type&&(l.push("uniform vec4 lightColor"+u+";"),"dir"===c.type&&l.push("uniform vec3 lightDir"+u+";"),"point"===c.type&&l.push("uniform vec3 lightPos"+u+";"),"spot"===c.type&&l.push("uniform vec3 lightPos"+u+";"))}s&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("out vec4 vColor;"),("spherical"===o||"cylindrical"===o)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = scale[0];"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===o&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = scale[1];"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),s&&l.push("localPosition = positionsDecodeMatrix * localPosition;");r&&(s?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),a&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),r&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),r)for(var h=0,d=i.lights.length;h<d;h++){var p=i.lights[h];if("ambient"!==p.type){if("dir"===p.type)"view"===p.space?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else{if("point"!==p.type)continue;"view"===p.space?l.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),n&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(t),this.fragment=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene.gammaOutput,n=i.getNumAllocatedSectionPlanes()>0,s=[];s.push("#version 300 es"),s.push("// Lambertian drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"));r&&(s.push("uniform float gammaFactor;"),s.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),s.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),s.push("}"));if(n){s.push("in vec4 vWorldPosition;"),s.push("uniform bool clippable;");for(var o=0,a=i.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),n){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var l=0,u=i.getNumAllocatedSectionPlanes();l<u;l++)s.push("if (sectionPlaneActive"+l+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}"points"===e._geometry._state.primitiveName&&(s.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("float r = dot(cxy, cxy);"),s.push("if (r > 1.0) {"),s.push("   discard;"),s.push("}"));t.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");r?s.push("outColor = linearToGamma(vColor, gammaFactor);"):s.push("outColor = vColor;");return s.push("}"),s}(t)}));var Sr=new Z({}),Rr=le.vec3(),Ur=function(e,t){this.id=Sr.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Dr(t),this._allocate(t)},Lr={};Ur.get=function(e){var t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=Lr[t];return i||(i=new Ur(t,e),Lr[t]=i,he.memory.programs++),i._useCount++,i},Ur.prototype.put=function(){0==--this._useCount&&(Sr.removeItem(this.id),this._program&&this._program.destroy(),delete Lr[this._hash],he.memory.programs--)},Ur.prototype.webglContextRestored=function(){this._program=null},Ur.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var r=this._scene,n=r.camera,s=r.canvas.gl,o=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,l=t._geometry._state,u=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniformMatrix4fv(this._uViewMatrix,!1,u?e.getRTCViewMatrix(a.originHash,u):n.viewMatrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),a.clippable){var A=r._sectionPlanesState.getNumAllocatedSectionPlanes(),c=r._sectionPlanesState.sectionPlanes.length;if(A>0)for(var h=r._sectionPlanesState.sectionPlanes,d=t.renderFlags,p=0;p<A;p++){var f=this._uSectionPlanes[p];if(f)if(p<c){var v=d.sectionPlanesActivePerLayer[p];if(s.uniform1i(f.active,v?1:0),v){var g=h[p];if(u){var m=ei(g.dist,g.dir,u,Rr);s.uniform3fv(f.pos,m)}else s.uniform3fv(f.pos,g.pos);s.uniform3fv(f.dir,g.dir)}}else s.uniform1i(f.active,0)}}if(o.id!==this._lastMaterialId){var _=o.fillColor,y=o.backfaces;e.backfaces!==y&&(y?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=y),s.uniform4f(this._uFillColor,_[0],_[1],_[2],o.fillAlpha),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),s.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&s.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),e.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),e.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(s.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++):l.positionsBuf&&(s.drawArrays(s.TRIANGLES,0,l.positionsBuf.numItems),e.drawArrays++)},Ur.prototype._allocate=function(e){var t=e.scene,i=t._lightsState,r=t._sectionPlanesState,n=t.canvas.gl;if(this._program=new Pr(n,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uModelNormalMatrix=s.getLocation("modelNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var o=0,a=i.lights.length;o<a;o++){switch(i.lights[o].type){case"ambient":this._uLightAmbient[o]=s.getLocation("lightAmbient");break;case"dir":this._uLightColor[o]=s.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=s.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=s.getLocation("lightColor"+o),this._uLightPos[o]=s.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=s.getLocation("lightAttenuation"+o)}}this._uSectionPlanes=[];for(var l=0,u=r.getNumAllocatedSectionPlanes();l<u;l++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+l),pos:s.getLocation("sectionPlanePos"+l),dir:s.getLocation("sectionPlaneDir"+l)});this._uFillColor=s.getLocation("fillColor"),this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},Ur.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,r=t._lightsState,n=t.camera,s=n.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){var o=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}for(var a=0,l=r.lights.length;a<l;a++){var u=r.lights[a];this._uLightAmbient[a]?i.uniform4f(this._uLightAmbient[a],u.color[0],u.color[1],u.color[2],u.intensity):(this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],u.color[0],u.color[1],u.color[2],u.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],u.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],u.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],u.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};var Or=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,s=e._state.stationary,o=[];o.push("#version 300 es"),o.push("// Edges drawing vertex shader"),o.push("in vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec4 edgeColor;"),o.push("uniform vec3 offset;"),o.push("uniform vec3 scale;"),r&&o.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;"));i&&o.push("out vec4 vWorldPosition;");o.push("out vec4 vColor;"),("spherical"===n||"cylindrical"===n)&&(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = scale[0];"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===n&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = scale[1];"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),o.push("vec4 worldPosition;"),r&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),s&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"),o.push("billboard(modelViewMatrix);"),o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));o.push("vColor = edgeColor;"),i&&o.push("vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return o.push("gl_Position = clipPos;"),o.push("}"),o}(t),this.fragment=function(e){var t=e.scene,i=e.scene._sectionPlanesState,r=e.scene.gammaOutput,n=i.getNumAllocatedSectionPlanes()>0,s=[];s.push("#version 300 es"),s.push("// Edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"));r&&(s.push("uniform float gammaFactor;"),s.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),s.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),s.push("}"));if(n){s.push("in vec4 vWorldPosition;"),s.push("uniform bool clippable;");for(var o=0,a=i.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),n){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var l=0,u=i.getNumAllocatedSectionPlanes();l<u;l++)s.push("if (sectionPlaneActive"+l+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}t.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");r?s.push("outColor = linearToGamma(vColor, gammaFactor);"):s.push("outColor = vColor;");return s.push("}"),s}(t)}));var Nr=new Z({}),Vr=le.vec3(),Qr=function(e,t){this.id=Nr.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Or(t),this._allocate(t)},Hr={};Qr.get=function(e){var t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=Hr[t];return i||(i=new Qr(t,e),Hr[t]=i,he.memory.programs++),i._useCount++,i},Qr.prototype.put=function(){0==--this._useCount&&(Nr.removeItem(this.id),this._program&&this._program.destroy(),delete Hr[this._hash],he.memory.programs--)},Qr.prototype.webglContextRestored=function(){this._program=null},Qr.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);var r,n,s=this._scene,o=s.camera,a=s.canvas.gl,l=t._state,u=t._geometry,A=u._state,c=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(l.originHash,c):o.viewMatrix),l.clippable){var h=s._sectionPlanesState.getNumAllocatedSectionPlanes(),d=s._sectionPlanesState.sectionPlanes.length;if(h>0)for(var p=s._sectionPlanesState.sectionPlanes,f=t.renderFlags,v=0;v<h;v++){var g=this._uSectionPlanes[v];if(g)if(v<d){var m=f.sectionPlanesActivePerLayer[v];if(a.uniform1i(g.active,m?1:0),m){var _=p[v];if(c){var y=ei(_.dist,_.dir,c,Vr);a.uniform3fv(g.pos,y)}else a.uniform3fv(g.pos,_.pos);a.uniform3fv(g.dir,_.dir)}}else a.uniform1i(g.active,0)}}switch(i){case 0:r=t._xrayMaterial._state;break;case 1:r=t._highlightMaterial._state;break;case 2:r=t._selectedMaterial._state;break;default:r=t._edgeMaterial._state}if(r.id!==this._lastMaterialId){var b=r.backfaces;if(e.backfaces!==b&&(b?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=b),e.lineWidth!==r.edgeWidth&&(a.lineWidth(r.edgeWidth),e.lineWidth=r.edgeWidth),this._uEdgeColor){var w=r.edgeColor,B=r.edgeAlpha;a.uniform4f(this._uEdgeColor,w[0],w[1],w[2],B)}this._lastMaterialId=r.id}a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uClippable&&a.uniform1i(this._uClippable,l.clippable),a.uniform3fv(this._uOffset,l.offset),A.primitive===a.TRIANGLES?n=u._getEdgeIndices():A.primitive===a.LINES&&(n=A.indicesBuf),n&&(A.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,A.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf,A.compressGeometry?a.UNSIGNED_SHORT:a.FLOAT),e.bindArray++),n.bind(),e.bindArray++,this._lastGeometryId=A.id),a.drawElements(a.LINES,n.numItems,n.itemType,0),e.drawElements++)},Qr.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl,r=t._sectionPlanesState;if(this._program=new Pr(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=r.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+s),pos:n.getLocation("sectionPlanePos"+s),dir:n.getLocation("sectionPlaneDir"+s)});this._uEdgeColor=n.getLocation("edgeColor"),this._aPosition=n.getAttribute("position"),this._uClippable=n.getLocation("clippable"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uOffset=n.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},Qr.prototype._bindProgram=function(e){var t=this._program,i=this._scene,r=i.canvas.gl,n=i.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),i.logarithmicDepthBufferEnabled){var s=2/(Math.log(n.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,s)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)};var Gr=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,s=e._state.stationary,o=[];o.push("#version 300 es"),o.push("// Mesh picking vertex shader"),o.push("in vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("out vec4 vViewPosition;"),o.push("uniform vec3 offset;"),o.push("uniform vec3 scale;"),r&&o.push("uniform mat4 positionsDecodeMatrix;");i&&o.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;"));"spherical"!==n&&"cylindrical"!==n||(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = scale[0];"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===n&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = scale[1];"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("uniform vec2 pickClipPos;"),o.push("vec4 remapClipPos(vec4 clipPos) {"),o.push("    clipPos.xy /= clipPos.w;"),o.push("    clipPos.xy -= pickClipPos;"),o.push("    clipPos.xy *= clipPos.w;"),o.push("    return clipPos;"),o.push("}"),o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),r&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),s&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==n&&"cylindrical"!==n||(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"));o.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&o.push("   vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return o.push("gl_Position = remapClipPos(clipPos);"),o.push("}"),o}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.getNumAllocatedSectionPlanes()>0,n=[];n.push("#version 300 es"),n.push("// Mesh picking fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(n.push("uniform vec4 pickColor;"),r){n.push("uniform bool clippable;"),n.push("in vec4 vWorldPosition;");for(var s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";")}if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("   outColor = pickColor; "),n.push("}"),n}(t)}));var jr=le.vec3(),zr=function(e,t){this._hash=e,this._shaderSource=new Gr(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Wr={};zr.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),i=Wr[t];if(!i){if((i=new zr(t,e)).errors)return console.log(i.errors.join("\n")),null;Wr[t]=i,he.memory.programs++}return i._useCount++,i},zr.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Wr[this._hash],he.memory.programs--)},zr.prototype.webglContextRestored=function(){this._program=null},zr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._state,s=t._material._state,o=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCPickViewMatrix(n.originHash,a):e.pickViewMatrix),n.clippable){var l=i._sectionPlanesState.getNumAllocatedSectionPlanes(),u=i._sectionPlanesState.sectionPlanes.length;if(l>0)for(var A=i._sectionPlanesState.sectionPlanes,c=t.renderFlags,h=0;h<l;h++){var d=this._uSectionPlanes[h];if(d)if(h<u){var p=c.sectionPlanesActivePerLayer[h];if(r.uniform1i(d.active,p?1:0),p){var f=A[h];if(a){var v=ei(f.dist,f.dir,a,jr);r.uniform3fv(d.pos,v)}else r.uniform3fv(d.pos,f.pos);r.uniform3fv(d.dir,f.dir)}}else r.uniform1i(d.active,0)}}if(s.id!==this._lastMaterialId){var g=s.backfaces;e.backfaces!==g&&(g?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=g);var m=s.frontface;e.frontface!==m&&(m?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=m),this._lastMaterialId=s.id}r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),e.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=o.id);var _=t._state.pickID,y=_>>24&255,b=_>>16&255,w=_>>8&255,B=255&_;r.uniform4f(this._uPickColor,B/255,w/255,b/255,y/255),r.uniform2fv(this._uPickClipPos,e.pickClipPos),o.indicesBuf?(r.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&r.drawArrays(r.TRIANGLES,0,o.positions.numItems)},zr.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new Pr(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,s=t._sectionPlanesState.sectionPlanes.length;n<s;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uPickColor=r.getLocation("pickColor"),this._uPickClipPos=r.getLocation("pickClipPos"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null}},zr.prototype._bindProgram=function(e){var t=this._scene,i=t.canvas.gl,r=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}this._lastMaterialId=null,this._lastGeometryId=null};var Xr=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,r=!!e._geometry._state.compressGeometry,n=[];n.push("#version 300 es"),n.push("// Surface picking vertex shader"),n.push("in vec3 position;"),n.push("in vec4 color;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),i&&(n.push("uniform bool clippable;"),n.push("out vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));n.push("uniform vec2 pickClipPos;"),n.push("vec4 remapClipPos(vec4 clipPos) {"),n.push("    clipPos.xy /= clipPos.w;"),n.push("    clipPos.xy -= pickClipPos;"),n.push("    clipPos.xy *= clipPos.w;"),n.push("    return clipPos;"),n.push("}"),n.push("out vec4 vColor;"),r&&n.push("uniform mat4 positionsDecodeMatrix;");n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),r&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("   vec4 worldPosition = modelMatrix * localPosition; "),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&n.push("   vWorldPosition = worldPosition;");n.push("   vColor = color;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = remapClipPos(clipPos);"),n.push("}"),n}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.getNumAllocatedSectionPlanes()>0,n=[];n.push("#version 300 es"),n.push("// Surface picking fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),n.push("in vec4 vColor;"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(r){n.push("uniform bool clippable;"),n.push("in vec4 vWorldPosition;");for(var s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";")}if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)n.push("if (sectionPlaneActive"+o+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("   outColor = vColor;"),n.push("}"),n}(t)}));var Kr=le.vec3(),Zr=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Xr(t),this._allocate(t)},Jr={};Zr.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";"),i=Jr[t];if(!i){if((i=new Zr(t,e)).errors)return console.log(i.errors.join("\n")),null;Jr[t]=i,he.memory.programs++}return i._useCount++,i},Zr.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Jr[this._hash],he.memory.programs--)},Zr.prototype.webglContextRestored=function(){this._program=null},Zr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._state,s=t._material._state,o=t._geometry,a=t._geometry._state,l=t.origin,u=s.backfaces,A=s.frontface,c=i.camera.project,h=o._getPickTrianglePositions(),d=o._getPickTriangleColors();if(this._program.bind(),e.useProgram++,i.logarithmicDepthBufferEnabled){var p=2/(Math.log(c.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,p)}if(r.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCPickViewMatrix(n.originHash,l):e.pickViewMatrix),n.clippable){var f=i._sectionPlanesState.getNumAllocatedSectionPlanes(),v=i._sectionPlanesState.sectionPlanes.length;if(f>0)for(var g=i._sectionPlanesState.sectionPlanes,m=t.renderFlags,_=0;_<f;_++){var y=this._uSectionPlanes[_];if(y)if(_<v){var b=m.sectionPlanesActivePerLayer[_];if(r.uniform1i(y.active,b?1:0),b){var w=g[_];if(l){var B=ei(w.dist,w.dir,l,Kr);r.uniform3fv(y.pos,B)}else r.uniform3fv(y.pos,w.pos);r.uniform3fv(y.dir,w.dir)}}else r.uniform1i(y.active,0)}}r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.logarithmicDepthBufferEnabled&&r.uniform1f(this._uZFar,i.camera.project.far),e.backfaces!==u&&(u?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=u),e.frontface!==A&&(A?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=A),r.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(h,a.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT)):this._aPosition.bindArrayBuffer(h),r.uniform2fv(this._uPickClipPos,e.pickClipPos),d.bind(),r.enableVertexAttribArray(this._aColor.location),r.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),r.drawArrays(a.primitive,0,h.numItems/3)},Zr.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new Pr(i,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,s=t._sectionPlanesState.sectionPlanes.length;n<s;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._uPickClipPos=r.getLocation("pickClipPos"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}};var Yr=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,r=!!e._geometry._state.compressGeometry,n=e._state.billboard,s=e._state.stationary,o=[];o.push("#version 300 es"),o.push("// Mesh occlusion vertex shader"),o.push("in vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec3 offset;"),o.push("uniform vec3 scale;"),r&&o.push("uniform mat4 positionsDecodeMatrix;");i&&o.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;"));"spherical"!==n&&"cylindrical"!==n||(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = scale[0];"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===n&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = scale[1];"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),o.push("vec4 worldPosition;"),r&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),s&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"),o.push("billboard(modelViewMatrix);"),o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));i&&o.push("   vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return o.push("gl_Position = clipPos;"),o.push("}"),o}(t),this.fragment=function(e){var t=e.scene,i=t._sectionPlanesState,r=i.getNumAllocatedSectionPlanes()>0,n=[];n.push("#version 300 es"),n.push("// Mesh occlusion fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(r){n.push("uniform bool clippable;"),n.push("in vec4 vWorldPosition;");for(var s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";")}if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}n.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return n.push("}"),n}(t)}));var qr=le.vec3(),$r=function(e,t){this._hash=e,this._shaderSource=new Yr(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},en={};$r.get=function(e){var t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.occlusionHash].join(";"),i=en[t];if(!i){if((i=new $r(t,e)).errors)return console.log(i.errors.join("\n")),null;en[t]=i,he.memory.programs++}return i._useCount++,i},$r.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete en[this._hash],he.memory.programs--)},$r.prototype.webglContextRestored=function(){this._program=null},$r.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene,r=i.canvas.gl,n=t._material._state,s=t._state,o=t._geometry._state,a=t.origin;if(!(n.alpha<1)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.id!==this._lastMaterialId){var l=n.backfaces;e.backfaces!==l&&(l?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=l);var u=n.frontface;e.frontface!==u&&(u?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=u),this._lastMaterialId=n.id}var A=i.camera;if(r.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCViewMatrix(s.originHash,a):A.viewMatrix),s.clippable){var c=i._sectionPlanesState.getNumAllocatedSectionPlanes(),h=i._sectionPlanesState.sectionPlanes.length;if(c>0)for(var d=i._sectionPlanesState.sectionPlanes,p=t.renderFlags,f=0;f<c;f++){var v=this._uSectionPlanes[f];if(v)if(f<h){var g=p.sectionPlanesActivePerLayer[f];if(r.uniform1i(v.active,g?1:0),g){var m=d[f];if(a){var _=ei(m.dist,m.dir,a,qr);r.uniform3fv(v.pos,_)}else r.uniform3fv(v.pos,m.pos);r.uniform3fv(v.dir,m.dir)}}else r.uniform1i(v.active,0)}}r.uniformMatrix4fv(this._uProjMatrix,!1,A._project._state.matrix),r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,t._state.clippable),r.uniform3fv(this._uOffset,t._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),e.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=o.id),o.indicesBuf?(r.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&r.drawArrays(r.TRIANGLES,0,o.positions.numItems)}},$r.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new Pr(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,s=t._sectionPlanesState.sectionPlanes.length;n<s;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},$r.prototype._bindProgram=function(e){var t=this._scene,i=t.camera.project,r=t.canvas.gl;if(this._program.bind(),e.useProgram++,r.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var n=2/(Math.log(i.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,n)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var tn=I((function e(t){k(this,e),this.vertex=function(e){var t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,r=[];r.push("// Mesh shadow vertex shader"),r.push("in vec3 position;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 shadowViewMatrix;"),r.push("uniform mat4 shadowProjMatrix;"),r.push("uniform vec3 offset;"),i&&r.push("uniform mat4 positionsDecodeMatrix;");t&&r.push("out vec4 vWorldPosition;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),r.push("vec4 worldPosition;"),i&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("worldPosition = modelMatrix * localPosition;"),r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&r.push("vWorldPosition = worldPosition;");return r.push("   gl_Position = shadowProjMatrix * viewPosition;"),r.push("}"),r}(t),this.fragment=function(e){var t=e.scene;t.canvas.gl;var i=t._sectionPlanesState,r=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("// Mesh shadow fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),r){n.push("uniform bool clippable;"),n.push("in vec4 vWorldPosition;");for(var s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";")}if(n.push("vec4 encodeFloat( const in float depth ) {"),n.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),n.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),n.push("  vec4 comp = fract(depth * bitShift);"),n.push("  comp -= comp.xxyz * bitMask;"),n.push("  return comp;"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(s=0;s<i.getNumAllocatedSectionPlanes();s++)n.push("if (sectionPlaneActive"+s+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}return n.push("outColor = encodeFloat(gl_FragCoord.z);"),n.push("}"),n}(t)}));var rn=function(e,t){this._hash=e,this._shaderSource=new tn(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},nn={};rn.get=function(e){var t=e.scene,i=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";"),r=nn[i];if(!r){if((r=new rn(i,e)).errors)return console.log(r.errors.join("\n")),null;nn[i]=r,he.memory.programs++}return r._useCount++,r},rn.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete nn[this._hash],he.memory.programs--)},rn.prototype.webglContextRestored=function(){this._program=null},rn.prototype.drawMesh=function(e,t){this._program||this._allocate(t);var i=this._scene.canvas.gl,r=t._material._state,n=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){var s=r.backfaces;e.backfaces!==s&&(s?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=s);var o=r.frontface;e.frontface!==o&&(o?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=o),e.lineWidth!==r.lineWidth&&(i.lineWidth(r.lineWidth),e.lineWidth=r.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,r.pointSize),this._lastMaterialId=r.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),n.combineGeometry){var a=t.vertexBufs;a.id!==this._lastVertexBufsId&&(a.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=a.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),n.combineGeometry?n.indicesBufCombined&&(n.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=n.id),n.combineGeometry?n.indicesBufCombined&&(i.drawElements(n.primitive,n.indicesBufCombined.numItems,n.indicesBufCombined.itemType,0),e.drawElements++):n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&(i.drawArrays(i.TRIANGLES,0,n.positions.numItems),e.drawArrays++)},rn.prototype._allocate=function(e){var t=e.scene,i=t.canvas.gl;if(this._program=new Pr(i,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(var n=0,s=t._sectionPlanesState.sectionPlanes.length;n<s;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},rn.prototype._bindProgram=function(e){this._program||this._allocate(mesh);var t=this._scene,i=t.canvas.gl,r=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.getNumAllocatedSectionPlanes()>0)for(var n,s,o,a=0,l=this._uSectionPlanes.length;a<l;a++)s=(n=this._uSectionPlanes[a]).active,o=r.sectionPlanes[a],s&&i.uniform1i(s,o.active),n.pos&&i.uniform3fv(n.pos,o.pos),n.dir&&i.uniform3fv(n.dir,o.dir)};var sn=function(){function e(){k(this,e),this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}return I(e,[{key:"reset",value:function(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}]),e}(),on=le.OBB3(),an=le.vec4(),ln=le.vec4(),un=le.vec4(),An=le.vec3([1,0,0]),cn=le.vec3([0,1,0]),hn=le.vec3([0,0,1]),dn=le.vec3(3),pn=le.vec3(3),fn=le.identityMat4(),vn=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n)).renderOrder=n.renderOrder||0,r.originalSystemId=n.originalSystemId||r.id,r.renderFlags=new sn,r._state=new nt({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==n.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!n.stationary,background:!!n.background,billboard:r._checkBillboard(n.billboard),layer:null,colorize:null,pickID:r.scene._renderer.getPickID(w(r)),drawHash:"",pickHash:"",offset:le.vec3(),origin:null,originHash:null,isUI:n.isUI}),r._drawRenderer=null,r._shadowRenderer=null,r._emphasisFillRenderer=null,r._emphasisEdgesRenderer=null,r._pickMeshRenderer=null,r._pickTriangleRenderer=null,r._occlusionRenderer=null,r._geometry=n.geometry?r._checkComponent2(["ReadableGeometry","VBOGeometry"],n.geometry):r.scene.geometry,r._material=n.material?r._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],n.material):r.scene.material,r._xrayMaterial=n.xrayMaterial?r._checkComponent("EmphasisMaterial",n.xrayMaterial):r.scene.xrayMaterial,r._highlightMaterial=n.highlightMaterial?r._checkComponent("EmphasisMaterial",n.highlightMaterial):r.scene.highlightMaterial,r._selectedMaterial=n.selectedMaterial?r._checkComponent("EmphasisMaterial",n.selectedMaterial):r.scene.selectedMaterial,r._edgeMaterial=n.edgeMaterial?r._checkComponent("EdgeMaterial",n.edgeMaterial):r.scene.edgeMaterial,r._parentNode=null,r._aabb=null,r._aabbDirty=!0,r._numTriangles=r._geometry?r._geometry.numTriangles:0,r.scene._aabbDirty=!0,r._scale=le.vec3(),r._quaternion=le.identityQuaternion(),r._rotation=le.vec3(),r._position=le.vec3(),r._worldMatrix=le.identityMat4(),r._worldNormalMatrix=le.identityMat4(),r._localMatrixDirty=!0,r._worldMatrixDirty=!0,r._worldNormalMatrixDirty=!0;var s=n.origin||n.rtcCenter;if(s&&(r._state.origin=le.vec3(s),r._state.originHash=s.join()),n.matrix?r.matrix=n.matrix:(r.scale=n.scale,r.position=n.position,n.quaternion||(r.rotation=n.rotation)),r._isObject=n.isObject,r._isObject&&r.scene._registerObject(w(r)),r._isModel=n.isModel,r._isModel&&r.scene._registerModel(w(r)),r.visible=n.visible,r.culled=n.culled,r.pickable=n.pickable,r.clippable=n.clippable,r.collidable=n.collidable,r.castsShadow=n.castsShadow,r.receivesShadow=n.receivesShadow,r.xrayed=n.xrayed,r.highlighted=n.highlighted,r.selected=n.selected,r.edges=n.edges,r.layer=n.layer,r.colorize=n.colorize,r.opacity=n.opacity,r.offset=n.offset,n.parentId){var o=r.scene.components[n.parentId];o?o.isNode?o.addChild(w(r)):r.error("Parent is not a Node: '"+n.parentId+"'"):r.error("Parent not found: '"+n.parentId+"'"),r._parentNode=o}else n.parent&&(n.parent.isNode||r.error("Parent is not a Node"),n.parent.addChild(w(r)),r._parentNode=n.parent);return r.compile(),r}return I(i,[{key:"type",get:function(){return"Mesh"}},{key:"isMesh",get:function(){return!0}},{key:"parent",get:function(){return this._parentNode}},{key:"geometry",get:function(){return this._geometry}},{key:"material",get:function(){return this._material}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),le.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),le.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"matrix",get:function(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=le.identityMat4()),le.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix},set:function(e){this.__localMatrix||(this.__localMatrix=le.identityMat4()),this.__localMatrix.set(e||fn),le.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}},{key:"worldMatrix",get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},{key:"worldNormalMatrix",get:function(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}},{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return this._isObject}},{key:"isUI",get:function(){return this._state.isUI}},{key:"aabb",get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},{key:"origin",get:function(){return this._state.origin},set:function(e){e?(this._state.origin||(this._state.origin=le.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}},{key:"rtcCenter",get:function(){return this.origin},set:function(e){this.origin=e}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"visible",get:function(){return this._state.visible},set:function(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this,e),this.glRedraw()}},{key:"xrayed",get:function(){return this._state.xrayed},set:function(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this,e),this.glRedraw())}},{key:"highlighted",get:function(){return this._state.highlighted},set:function(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this,e),this.glRedraw())}},{key:"selected",get:function(){return this._state.selected},set:function(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this,e),this.glRedraw())}},{key:"edges",get:function(){return this._state.edges},set:function(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}},{key:"culled",get:function(){return this._state.culled},set:function(e){this._state.culled=!!e,this.glRedraw()}},{key:"clippable",get:function(){return this._state.clippable},set:function(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}},{key:"collidable",get:function(){return this._state.collidable},set:function(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}},{key:"pickable",get:function(){return this._state.pickable},set:function(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}},{key:"castsShadow",get:function(){return this._state.castsShadow},set:function(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}},{key:"receivesShadow",get:function(){return this._state.receivesShadow},set:function(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}},{key:"saoEnabled",get:function(){return!1}},{key:"colorize",get:function(){return this._state.colorize},set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);var i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}},{key:"opacity",get:function(){return this._state.colorize[3]},set:function(e){var t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1);var i=null!=e;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}},{key:"transparent",get:function(){return 2===this._material.alphaMode||this._state.colorize[3]<1}},{key:"layer",get:function(){return this._state.layer},set:function(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}},{key:"stationary",get:function(){return this._state.stationary}},{key:"billboard",get:function(){return this._state.billboard}},{key:"offset",get:function(){return this._state.offset},set:function(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}},{key:"isDrawable",get:function(){return!0}},{key:"isStateSortable",get:function(){return!0}},{key:"xrayMaterial",get:function(){return this._xrayMaterial}},{key:"highlightMaterial",get:function(){return this._highlightMaterial}},{key:"selectedMaterial",get:function(){return this._selectedMaterial}},{key:"edgeMaterial",get:function(){return this._edgeMaterial}},{key:"_checkBillboard",value:function(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}},{key:"compile",value:function(){var e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=Ir.get(this),this._emphasisFillRenderer=Ur.get(this),this._emphasisEdgesRenderer=Qr.get(this));var t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=zr.get(this)),this._state.occluder){var i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=$r.get(this))}}},{key:"_setLocalMatrixDirty",value:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}},{key:"_setWorldMatrixDirty",value:function(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}},{key:"_buildWorldMatrix",value:function(){var e=this.matrix;if(this._parentNode)le.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}},{key:"_buildWorldNormalMatrix",value:function(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=le.mat4()),le.transposeMat4(this._worldMatrix,this._worldNormalMatrix),le.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}},{key:"_setAABBDirty",value:function(){if(this.collidable)for(var e=this;e;e=e._parentNode)e._aabbDirty=!0}},{key:"_updateAABB",value:function(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=le.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}},{key:"_webglContextRestored",value:function(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}},{key:"_makeDrawHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}},{key:"_makePickHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}},{key:"_makeOcclusionHash",value:function(){var e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}},{key:"_buildAABB",value:function(e,t){le.transformOBB3(e,this._geometry.obb,on),le.OBB3ToAABB3(on,t);var i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){var r=this._state.origin;t[0]+=r[0],t[1]+=r[1],t[2]+=r[2],t[3]+=r[0],t[4]+=r[1],t[5]+=r[2]}}},{key:"rotate",value:function(e,t){return an[0]=e[0],an[1]=e[1],an[2]=e[2],an[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(an,ln),le.mulQuaternions(this.quaternion,ln,un),this.quaternion=un,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"rotateOnWorldAxis",value:function(e,t){return an[0]=e[0],an[1]=e[1],an[2]=e[2],an[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(an,ln),le.mulQuaternions(ln,this.quaternion,ln),this}},{key:"rotateX",value:function(e){return this.rotate(An,e)}},{key:"rotateY",value:function(e){return this.rotate(cn,e)}},{key:"rotateZ",value:function(e){return this.rotate(hn,e)}},{key:"translate",value:function(e,t){return le.vec3ApplyQuaternion(this.quaternion,e,dn),le.mulVec3Scalar(dn,t,pn),le.addVec3(this.position,pn,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}},{key:"translateX",value:function(e){return this.translate(An,e)}},{key:"translateY",value:function(e){return this.translate(cn,e)}},{key:"translateZ",value:function(e){return this.translate(hn,e)}},{key:"_putDrawRenderers",value:function(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}},{key:"_putPickRenderers",value:function(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}},{key:"_putOcclusionRenderer",value:function(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}},{key:"stateSortCompare",value:function(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}},{key:"rebuildRenderFlags",value:function(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}},{key:"_updateRenderFlags",value:function(){var e=this.renderFlags,t=this._state;if(t.xrayed){var i=this._xrayMaterial._state;i.fill&&(i.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges)this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0;if(t.selected){var r=this._selectedMaterial._state;r.fill&&(r.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){var n=this._highlightMaterial._state;n.fill&&(n.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),n.edges&&(n.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}},{key:"_getActiveSectionPlanes",value:function(){if(this._state.clippable){var e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(var i=0;i<t;i++){var r=e[i],n=this.renderFlags;if(r.active)if(this._state.origin){var s=le.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===s)return!1;var o=0===s;n.sectionPlanesActivePerLayer[i]=o}else n.sectionPlanesActivePerLayer[i]=!0;else n.sectionPlanesActivePerLayer[i]=!1}}return!0}},{key:"drawColorOpaque",value:function(e){(this._drawRenderer||(this._drawRenderer=Ir.get(this)))&&this._drawRenderer.drawMesh(e,this)}},{key:"drawColorTransparent",value:function(e){(this._drawRenderer||(this._drawRenderer=Ir.get(this)))&&this._drawRenderer.drawMesh(e,this)}},{key:"drawSilhouetteXRayed",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ur.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}},{key:"drawSilhouetteHighlighted",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ur.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}},{key:"drawSilhouetteSelected",value:function(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ur.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}},{key:"drawEdgesColorOpaque",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}},{key:"drawEdgesColorTransparent",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}},{key:"drawEdgesXRayed",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}},{key:"drawEdgesHighlighted",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}},{key:"drawEdgesSelected",value:function(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}},{key:"drawOcclusion",value:function(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=$r.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}},{key:"drawShadow",value:function(e){(this._shadowRenderer||(this._shadowRenderer=rn.get(this)))&&this._shadowRenderer.drawMesh(e,this)}},{key:"drawPickMesh",value:function(e){(this._pickMeshRenderer||(this._pickMeshRenderer=zr.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}},{key:"canPickTriangle",value:function(){return this._geometry.isReadableGeometry}},{key:"drawPickTriangles",value:function(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Zr.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}},{key:"pickTriangleSurface",value:function(e,t,i,r){gn(this,e,t,i,r)}},{key:"drawPickVertices",value:function(e){}},{key:"delegatePickedEntity",value:function(){return this}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some((function(e){return 0!==e}))&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}]),i}(),gn=function(){var e=le.vec3(),t=le.vec3(),i=le.vec3(),r=le.vec3(),n=le.vec3(),s=le.vec3(),o=le.vec4(),a=le.vec3(),l=le.vec3(),u=le.vec3(),A=le.vec3(),c=le.vec3(),h=le.vec3(),d=le.vec3(),p=le.vec3(),f=le.vec3(),v=le.vec4(),g=le.vec4(),m=le.vec4(),_=le.vec3(),y=le.vec3(),b=le.vec3(),w=le.vec3(),B=le.vec3(),x=le.vec3(),P=le.vec3(),C=le.vec3(),M=le.vec3(),F=le.vec3(),k=le.vec3();return function(E,I,T,D,S){var R=S.primIndex;if(null!=R&&R>-1){var U=E.geometry._state,L=E.scene,O=L.camera,N=L.canvas;if("triangles"===U.primitiveName){S.primitive="triangle";var V,Q,H,G=R,j=U.indices,z=U.positions;if(j){var W=j[G+0],X=j[G+1],K=j[G+2];s[0]=W,s[1]=X,s[2]=K,S.indices=s,V=3*W,Q=3*X,H=3*K}else H=(Q=(V=3*G)+3)+3;if(i[0]=z[V+0],i[1]=z[V+1],i[2]=z[V+2],r[0]=z[Q+0],r[1]=z[Q+1],r[2]=z[Q+2],n[0]=z[H+0],n[1]=z[H+1],n[2]=z[H+2],U.compressGeometry){var Z=U.positionsDecodeMatrix;Z&&(ft.decompressPosition(i,Z,i),ft.decompressPosition(r,Z,r),ft.decompressPosition(n,Z,n))}S.canvasPos?le.canvasPosToLocalRay(N.canvas,E.origin?Jt(I,E.origin):I,T,D,E.worldMatrix,S.canvasPos,e,t):S.origin&&S.direction&&le.worldRayToLocalRay(E.worldMatrix,S.origin,S.direction,e,t),le.normalizeVec3(t),le.rayPlaneIntersect(e,t,i,r,n,o),S.localPos=o,S.position=o,v[0]=o[0],v[1]=o[1],v[2]=o[2],v[3]=1,le.transformVec4(E.worldMatrix,v,g),a[0]=g[0],a[1]=g[1],a[2]=g[2],S.canvasPos&&E.origin&&(a[0]+=E.origin[0],a[1]+=E.origin[1],a[2]+=E.origin[2]),S.worldPos=a,le.transformVec4(O.matrix,g,m),l[0]=m[0],l[1]=m[1],l[2]=m[2],S.viewPos=l,le.cartesianToBarycentric(o,i,r,n,u),S.bary=u;var J=U.normals;if(J){if(U.compressGeometry){var Y=3*W,q=3*X,$=3*K;ft.decompressNormal(J.subarray(Y,Y+2),A),ft.decompressNormal(J.subarray(q,q+2),c),ft.decompressNormal(J.subarray($,$+2),h)}else A[0]=J[V],A[1]=J[V+1],A[2]=J[V+2],c[0]=J[Q],c[1]=J[Q+1],c[2]=J[Q+2],h[0]=J[H],h[1]=J[H+1],h[2]=J[H+2];var ee=le.addVec3(le.addVec3(le.mulVec3Scalar(A,u[0],_),le.mulVec3Scalar(c,u[1],y),b),le.mulVec3Scalar(h,u[2],w),B);S.worldNormal=le.normalizeVec3(le.transformVec3(E.worldNormalMatrix,ee,x))}var te=U.uv;if(te){if(d[0]=te[2*W],d[1]=te[2*W+1],p[0]=te[2*X],p[1]=te[2*X+1],f[0]=te[2*K],f[1]=te[2*K+1],U.compressGeometry){var ie=U.uvDecodeMatrix;ie&&(ft.decompressUV(d,ie,d),ft.decompressUV(p,ie,p),ft.decompressUV(f,ie,f))}S.uv=le.addVec3(le.addVec3(le.mulVec2Scalar(d,u[0],P),le.mulVec2Scalar(p,u[1],C),M),le.mulVec2Scalar(f,u[2],F),k)}}}}}(),mn=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),r=t.call(this,e,n),he.memory.materials++,r}return I(i,[{key:"type",get:function(){return"Material"}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),he.memory.materials--}}]),i}(),_n={opaque:0,mask:1,blend:2},yn=["opaque","mask","blend"],bn=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"PhongMaterial",ambient:le.vec3([1,1,1]),diffuse:le.vec3([1,1,1]),specular:le.vec3([1,1,1]),emissive:le.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),r.ambient=n.ambient,r.diffuse=n.diffuse,r.specular=n.specular,r.emissive=n.emissive,r.alpha=n.alpha,r.shininess=n.shininess,r.reflectivity=n.reflectivity,r.lineWidth=n.lineWidth,r.pointSize=n.pointSize,n.ambientMap&&(r._ambientMap=r._checkComponent("Texture",n.ambientMap)),n.diffuseMap&&(r._diffuseMap=r._checkComponent("Texture",n.diffuseMap)),n.specularMap&&(r._specularMap=r._checkComponent("Texture",n.specularMap)),n.emissiveMap&&(r._emissiveMap=r._checkComponent("Texture",n.emissiveMap)),n.alphaMap&&(r._alphaMap=r._checkComponent("Texture",n.alphaMap)),n.reflectivityMap&&(r._reflectivityMap=r._checkComponent("Texture",n.reflectivityMap)),n.normalMap&&(r._normalMap=r._checkComponent("Texture",n.normalMap)),n.occlusionMap&&(r._occlusionMap=r._checkComponent("Texture",n.occlusionMap)),n.diffuseFresnel&&(r._diffuseFresnel=r._checkComponent("Fresnel",n.diffuseFresnel)),n.specularFresnel&&(r._specularFresnel=r._checkComponent("Fresnel",n.specularFresnel)),n.emissiveFresnel&&(r._emissiveFresnel=r._checkComponent("Fresnel",n.emissiveFresnel)),n.alphaFresnel&&(r._alphaFresnel=r._checkComponent("Fresnel",n.alphaFresnel)),n.reflectivityFresnel&&(r._reflectivityFresnel=r._checkComponent("Fresnel",n.reflectivityFresnel)),r.alphaMode=n.alphaMode,r.alphaCutoff=n.alphaCutoff,r.backfaces=n.backfaces,r.frontface=n.frontface,r._makeHash(),r}return I(i,[{key:"type",get:function(){return"PhongMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}},{key:"ambient",get:function(){return this._state.ambient},set:function(e){var t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"diffuse",get:function(){return this._state.diffuse},set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"specular",get:function(){return this._state.specular},set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"shininess",get:function(){return this._state.shininess},set:function(e){this._state.shininess=void 0!==e?e:80,this.glRedraw()}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"reflectivity",get:function(){return this._state.reflectivity},set:function(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw()}},{key:"normalMap",get:function(){return this._normalMap}},{key:"ambientMap",get:function(){return this._ambientMap}},{key:"diffuseMap",get:function(){return this._diffuseMap}},{key:"specularMap",get:function(){return this._specularMap}},{key:"emissiveMap",get:function(){return this._emissiveMap}},{key:"alphaMap",get:function(){return this._alphaMap}},{key:"reflectivityMap",get:function(){return this._reflectivityMap}},{key:"occlusionMap",get:function(){return this._occlusionMap}},{key:"diffuseFresnel",get:function(){return this._diffuseFresnel}},{key:"specularFresnel",get:function(){return this._specularFresnel}},{key:"emissiveFresnel",get:function(){return this._emissiveFresnel}},{key:"alphaFresnel",get:function(){return this._alphaFresnel}},{key:"reflectivityFresnel",get:function(){return this._reflectivityFresnel}},{key:"alphaMode",get:function(){return yn[this._state.alphaMode]},set:function(e){var t=_n[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}();function wn(e,t){if(void 0===e._cachedExtensions&&(e._cachedExtensions={}),void 0!==e._cachedExtensions[t])return e._cachedExtensions[t];var i;switch(t){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(t)}return e._cachedExtensions[t]=i,i}function Bn(e,t){var i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=t;if(1009===n)return e.UNSIGNED_BYTE;if(1017===n)return e.UNSIGNED_SHORT_4_4_4_4;if(1018===n)return e.UNSIGNED_SHORT_5_5_5_1;if(1010===n)return e.BYTE;if(1011===n)return e.SHORT;if(1012===n)return e.UNSIGNED_SHORT;if(1013===n)return e.INT;if(1014===n)return e.UNSIGNED_INT;if(1015===n)return e.FLOAT;if(1016===n)return e.HALF_FLOAT;if(1021===n)return e.ALPHA;if(1023===n)return e.RGBA;if(1024===n)return e.LUMINANCE;if(1025===n)return e.LUMINANCE_ALPHA;if(1026===n)return e.DEPTH_COMPONENT;if(1027===n)return e.DEPTH_STENCIL;if(1028===n)return e.RED;if(1022===n)return e.RGBA;if(1029===n)return e.RED_INTEGER;if(1030===n)return e.RG;if(1031===n)return e.RG_INTEGER;if(1033===n)return e.RGBA_INTEGER;if(33776===n||33777===n||33778===n||33779===n)if(3001===r){var s=wn(e,"WEBGL_compressed_texture_s3tc_srgb");if(null===s)return null;if(33776===n)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(33777===n)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(33778===n)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(33779===n)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(i=wn(e,"WEBGL_compressed_texture_s3tc")))return null;if(33776===n)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===n)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===n)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===n)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===n||35841===n||35842===n||35843===n){var o=wn(e,"WEBGL_compressed_texture_pvrtc");if(null===o)return null;if(35840===n)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===n)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===n)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===n)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===n){var a=wn(e,"WEBGL_compressed_texture_etc1");return null!==a?a.COMPRESSED_RGB_ETC1_WEBGL:null}if(37492===n||37496===n){var l=wn(e,"WEBGL_compressed_texture_etc");if(null===l)return null;if(37492===n)return 3001===r?l.COMPRESSED_SRGB8_ETC2:l.COMPRESSED_RGB8_ETC2;if(37496===n)return 3001===r?l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:l.COMPRESSED_RGBA8_ETC2_EAC}if(37808===n||37809===n||37810===n||37811===n||37812===n||37813===n||37814===n||37815===n||37816===n||37817===n||37818===n||37819===n||37820===n||37821===n){var u=wn(e,"WEBGL_compressed_texture_astc");if(null===u)return null;if(37808===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:u.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:u.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:u.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:u.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:u.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:u.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:u.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:u.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:u.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:u.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:u.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:u.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:u.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===n)return 3001===r?u.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:u.COMPRESSED_RGBA_ASTC_12x12_KHR}if(36492===n){var A=wn(e,"EXT_texture_compression_bptc");if(null===A)return null;if(36492===n)return 3001===r?A.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:A.COMPRESSED_RGBA_BPTC_UNORM_EXT}return 1020===n?e.UNSIGNED_INT_24_8:1e3===n?e.REPEAT:1001===n?e.CLAMP_TO_EDGE:1004===n||1005===n?e.NEAREST_MIPMAP_LINEAR:1007===n?e.LINEAR_MIPMAP_NEAREST:1008===n?e.LINEAR_MIPMAP_LINEAR:1003===n?e.NEAREST:1006===n?e.LINEAR:null}var xn=new Uint8Array([0,0,0,1]),Pn=function(){function e(t){var i=t.gl,r=t.target,n=t.format,s=t.type,o=t.wrapS,a=t.wrapT,l=t.wrapR,u=t.encoding,A=t.preloadColor,c=t.premultiplyAlpha,h=t.flipY;k(this,e),this.gl=i,this.target=r||i.TEXTURE_2D,this.format=n||1023,this.type=s||1009,this.internalFormat=null,this.premultiplyAlpha=!!c,this.flipY=!!h,this.unpackAlignment=4,this.wrapS=o||1e3,this.wrapT=a||1e3,this.wrapR=l||1e3,this.encoding=u||3001,this.texture=i.createTexture(),A&&this.setPreloadColor(A),this.allocated=!0}return I(e,[{key:"setPreloadColor",value:function(e){e?(xn[0]=Math.floor(255*e[0]),xn[1]=Math.floor(255*e[1]),xn[2]=Math.floor(255*e[2]),xn[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(xn[0]=0,xn[1]=0,xn[2]=0,xn[3]=255);var t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP)for(var i=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],r=0,n=i.length;r<n;r++)t.texImage2D(i[r],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,xn);else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,xn);t.bindTexture(this.target,null)}},{key:"setTarget",value:function(e){this.target=e||this.gl.TEXTURE_2D}},{key:"setImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.gl;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR);var r=!1;i.bindTexture(this.target,this.texture);var n=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY);var s=i.getParameter(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);var o=i.getParameter(i.UNPACK_ALIGNMENT);i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment);var a=i.getParameter(i.UNPACK_COLORSPACE_CONVERSION_WEBGL);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);var l=Bn(i,this.minFilter);i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,l),l!==i.NEAREST_MIPMAP_NEAREST&&l!==i.LINEAR_MIPMAP_NEAREST&&l!==i.NEAREST_MIPMAP_LINEAR&&l!==i.LINEAR_MIPMAP_LINEAR||(r=!0);var u=Bn(i,this.magFilter);u&&i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,u);var A=Bn(i,this.wrapS);A&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,A);var c=Bn(i,this.wrapT);c&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,c);var h=Bn(i,this.format,this.encoding),d=Bn(i,this.type),p=Cn(i,this.internalFormat,h,d,this.encoding,!1);if(this.target===i.TEXTURE_CUBE_MAP){if(ge.isArray(e))for(var f=e,v=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z],g=0,m=v.length;g<m;g++)i.texImage2D(v[g],0,p,h,d,f[g])}else i.texImage2D(i.TEXTURE_2D,0,p,h,d,e);r&&i.generateMipmap(this.target),i.bindTexture(this.target,null),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,n),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s),i.pixelStorei(i.UNPACK_ALIGNMENT,o),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,a)}},{key:"setCompressedData",value:function(e){var t=e.mipmaps,i=e.props,r=void 0===i?{}:i,n=this.gl,s=t.length;void 0!==r.format&&(this.format=r.format),void 0!==r.internalFormat&&(this.internalFormat=r.internalFormat),void 0!==r.encoding&&(this.encoding=r.encoding),void 0!==r.type&&(this.type=r.type),void 0!==r.flipY&&(this.flipY=r.flipY),void 0!==r.premultiplyAlpha&&(this.premultiplyAlpha=r.premultiplyAlpha),void 0!==r.unpackAlignment&&(this.unpackAlignment=r.unpackAlignment),void 0!==r.minFilter&&(this.minFilter=r.minFilter),void 0!==r.magFilter&&(this.magFilter=r.magFilter),void 0!==r.wrapS&&(this.wrapS=r.wrapS),void 0!==r.wrapT&&(this.wrapT=r.wrapT),void 0!==r.wrapR&&(this.wrapR=r.wrapR),n.activeTexture(n.TEXTURE0+0),n.bindTexture(this.target,this.texture);var o=t.length>1;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,this.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,this.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE);var a=Bn(n,this.wrapS);a&&n.texParameteri(this.target,n.TEXTURE_WRAP_S,a);var l=Bn(n,this.wrapT);if(l&&n.texParameteri(this.target,n.TEXTURE_WRAP_T,l),this.type===n.TEXTURE_3D||this.type===n.TEXTURE_2D_ARRAY){var u=Bn(n,this.wrapR);u&&n.texParameteri(this.target,n.TEXTURE_WRAP_R,u),n.texParameteri(this.type,n.TEXTURE_WRAP_R,u)}o?(n.texParameteri(this.target,n.TEXTURE_MIN_FILTER,Mn(n,this.minFilter)),n.texParameteri(this.target,n.TEXTURE_MAG_FILTER,Mn(n,this.magFilter))):(n.texParameteri(this.target,n.TEXTURE_MIN_FILTER,Bn(n,this.minFilter)),n.texParameteri(this.target,n.TEXTURE_MAG_FILTER,Bn(n,this.magFilter)));var A=Bn(n,this.format,this.encoding),c=Bn(n,this.type),h=Cn(n,this.internalFormat,A,c,this.encoding,!1);n.texStorage2D(n.TEXTURE_2D,s,h,t[0].width,t[0].height);for(var d=0,p=t.length;d<p;d++){var f=t[d];1023!==this.format?null!==A?n.compressedTexSubImage2D(n.TEXTURE_2D,d,0,0,f.width,f.height,A,f.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):n.texSubImage2D(n.TEXTURE_2D,d,0,0,f.width,f.height,A,c,f.data)}n.bindTexture(this.target,null)}},{key:"setProps",value:function(e){var t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null)}},{key:"_uploadProps",value:function(e){var t=this.gl;if(void 0!==e.format&&(this.format=e.format),void 0!==e.internalFormat&&(this.internalFormat=e.internalFormat),void 0!==e.encoding&&(this.encoding=e.encoding),void 0!==e.type&&(this.type=e.type),void 0!==e.minFilter){var i=Bn(t,e.minFilter);i&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(void 0!==e.magFilter){var r=Bn(t,e.magFilter);r&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,r))}if(void 0!==e.wrapS){var n=Bn(t,e.wrapS);n&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,n))}if(void 0!==e.wrapT){var s=Bn(t,e.wrapT);s&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,s))}}},{key:"bind",value:function(e){if(this.allocated){if(this.texture){var t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}},{key:"unbind",value:function(e){if(this.allocated&&this.texture){var t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}},{key:"destroy",value:function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}]),e}();function Cn(e,t,i,r,n){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(null!==t){if(void 0!==e[t])return e[t];console.warn("Attempt to use non-existing WebGL internal format '"+t+"'")}var o=i;return i===e.RED&&(r===e.FLOAT&&(o=e.R32F),r===e.HALF_FLOAT&&(o=e.R16F),r===e.UNSIGNED_BYTE&&(o=e.R8)),i===e.RG&&(r===e.FLOAT&&(o=e.RG32F),r===e.HALF_FLOAT&&(o=e.RG16F),r===e.UNSIGNED_BYTE&&(o=e.RG8)),i===e.RGBA&&(r===e.FLOAT&&(o=e.RGBA32F),r===e.HALF_FLOAT&&(o=e.RGBA16F),r===e.UNSIGNED_BYTE&&(o=3001===n&&!1===s?e.SRGB8_ALPHA8:e.RGBA8),r===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),r===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)),o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||wn(e,"EXT_color_buffer_float"),o}function Mn(e,t){return 1003===t||1004===t||1005===t?e.NEAREST:e.LINEAR}function Fn(e){if(!kn(e.width)||!kn(e.height)){var t=document.createElement("canvas");t.width=En(e.width),t.height=En(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function kn(e){return 0==(e&e-1)}function En(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}var In=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({texture:new Pn({gl:r.scene.canvas.gl}),matrix:le.identityMat4(),hasMatrix:n.translate&&(0!==n.translate[0]||0!==n.translate[1])||!!n.rotate||n.scale&&(0!==n.scale[0]||0!==n.scale[1]),minFilter:r._checkMinFilter(n.minFilter),magFilter:r._checkMagFilter(n.magFilter),wrapS:r._checkWrapS(n.wrapS),wrapT:r._checkWrapT(n.wrapT),flipY:r._checkFlipY(n.flipY),encoding:r._checkEncoding(n.encoding)}),r._src=null,r._image=null,r._translate=le.vec2([0,0]),r._scale=le.vec2([1,1]),r._rotate=le.vec2([0,0]),r._matrixDirty=!1,r.translate=n.translate,r.scale=n.scale,r.rotate=n.rotate,n.src?r.src=n.src:n.image&&(r.image=n.image),he.memory.textures++,r}return I(i,[{key:"type",get:function(){return"Texture"}},{key:"_checkMinFilter",value:function(e){return 1006!==(e=e||1008)&&1007!==e&&1008!==e&&1005!==e&&1004!==e&&(this.error("Unsupported value for 'minFilter' - supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, NearestMipMapLinearFilter and LinearMipMapLinearFilter. Defaulting to LinearMipMapLinearFilter."),e=1008),e}},{key:"_checkMagFilter",value:function(e){return 1006!==(e=e||1006)&&1003!==e&&(this.error("Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),e=1006),e}},{key:"_checkWrapS",value:function(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}},{key:"_checkWrapT",value:function(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}},{key:"_checkFlipY",value:function(e){return!!e}},{key:"_checkEncoding",value:function(e){return 3e3!==(e=e||3e3)&&3001!==e&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=3e3),e}},{key:"_webglContextRestored",value:function(){this._state.texture=new Pn({gl:this.scene.canvas.gl}),this._image?this.image=this._image:this._src&&(this.src=this._src)}},{key:"_update",value:function(){var e,t,i=this._state;this._matrixDirty&&(0===this._translate[0]&&0===this._translate[1]||(e=le.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(t=le.scalingMat4v([this._scale[0],this._scale[1],1]),e=e?le.mulMat4(e,t):t),0!==this._rotate&&(t=le.rotationMat4v(.0174532925*this._rotate,[0,0,1]),e=e?le.mulMat4(e,t):t),e&&(i.matrix=e),this._matrixDirty=!1);this.glRedraw()}},{key:"image",get:function(){return this._image},set:function(e){this._image=Fn(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._src=null,this.glRedraw()}},{key:"src",get:function(){return this._src},set:function(e){this.scene.loading++,this.scene.canvas.spinner.processes++;var t=this,i=new Image;i.onload=function(){i=Fn(i),t._state.texture.setImage(i,t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--},i.src=e,this._src=e,this._image=null}},{key:"translate",get:function(){return this._translate},set:function(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}},{key:"rotate",get:function(){return this._rotate},set:function(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}},{key:"minFilter",get:function(){return this._state.minFilter}},{key:"magFilter",get:function(){return this._state.magFilter}},{key:"wrapS",get:function(){return this._state.wrapS}},{key:"wrapT",get:function(){return this._state.wrapT}},{key:"flipY",get:function(){return this._state.flipY}},{key:"encoding",get:function(){return this._state.encoding}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),he.memory.textures--}}]),i}(),Tn=le.vec3(),Dn=le.vec3();le.vec3();var Sn=le.vec3([0,-1,0]),Rn=le.vec4([0,0,0,1]),Un=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._src=null,r._image=null,r._pos=le.vec3(),r._origin=le.vec3(),r._rtcPos=le.vec3(),r._dir=le.vec3(),r._size=1,r._imageSize=le.vec2(),r._texture=new In(w(r)),r._plane=new vn(w(r),{geometry:new mt(w(r),Et({center:[0,0,0],xSize:1,zSize:1,xSegments:10,zSegments:10})),material:new bn(w(r),{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:r._texture,emissiveMap:r._texture,backfaces:!0}),clippable:n.clippable}),r._grid=new vn(w(r),{geometry:new mt(w(r),kt({size:1,divisions:10})),material:new bn(w(r),{diffuse:[0,0,0],ambient:[0,0,0],emissive:[.2,.8,.2]}),position:[0,.001,0],clippable:n.clippable}),r._node=new Xt(w(r),{rotation:[0,0,0],position:[0,0,0],scale:[1,1,1],clippable:!1,children:[r._plane,r._grid]}),r._gridVisible=!1,r.visible=!0,r.gridVisible=n.gridVisible,r.position=n.position,r.rotation=n.rotation,r.dir=n.dir,r.size=n.size,r.collidable=n.collidable,r.clippable=n.clippable,r.pickable=n.pickable,r.opacity=n.opacity,n.image?r.image=n.image:r.src=n.src,r}return I(i,[{key:"visible",get:function(){return this._plane.visible},set:function(e){this._plane.visible=e,this._grid.visible=this._gridVisible&&e}},{key:"gridVisible",get:function(){return this._gridVisible},set:function(e){e=!1!==e,this._gridVisible=e,this._grid.visible=this._gridVisible&&this.visible}},{key:"image",get:function(){return this._image},set:function(e){this._image=e,this._image&&(this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}},{key:"src",get:function(){return this._src},set:function(e){var t=this;if(this._src=e,this._src){this._image=null;var i=new Image;i.onload=function(){t._texture.image=i,t._imageSize[0]=i.width,t._imageSize[1]=i.height,t._updatePlaneSizeFromImage()},i.src=this._src}}},{key:"position",get:function(){return this._pos},set:function(e){this._pos.set(e||[0,0,0]),Yt(this._pos,this._origin,this._rtcPos),this._node.origin=this._origin,this._node.position=this._rtcPos}},{key:"rotation",get:function(){return this._node.rotation},set:function(e){this._node.rotation=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=null==e?1:e,this._image&&this._updatePlaneSizeFromImage()}},{key:"dir",get:function(){return this._dir},set:function(e){if(this._dir.set(e||[0,0,-1]),e){var t=this.scene.center,i=[-this._dir[0],-this._dir[1],-this._dir[2]];le.subVec3(t,this.position,Tn);var r=-le.dotVec3(i,Tn);le.normalizeVec3(i),le.mulVec3Scalar(i,r,Dn),le.vec3PairToQuaternion(Sn,e,Rn),this._node.quaternion=Rn}}},{key:"collidable",get:function(){return this._node.collidable},set:function(e){this._node.collidable=!1!==e}},{key:"clippable",get:function(){return this._node.clippable},set:function(e){this._node.clippable=!1!==e}},{key:"pickable",get:function(){return this._node.pickable},set:function(e){this._node.pickable=!1!==e}},{key:"opacity",get:function(){return this._node.opacity},set:function(e){this._node.opacity=e}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}},{key:"_updatePlaneSizeFromImage",value:function(){var e=this._size,t=this._imageSize[0],i=this._imageSize[1];if(t>i){var r=i/t;this._node.scale=[e,1,e*r]}else{var n=t/i;this._node.scale=[e*n,1,e]}}}]),i}(),Ln=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"LambertMaterial",ambient:le.vec3([1,1,1]),color:le.vec3([1,1,1]),emissive:le.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),r.ambient=n.ambient,r.color=n.color,r.emissive=n.emissive,r.alpha=n.alpha,r.lineWidth=n.lineWidth,r.pointSize=n.pointSize,r.backfaces=n.backfaces,r.frontface=n.frontface,r}return I(i,[{key:"type",get:function(){return"LambertMaterial"}},{key:"ambient",get:function(){return this._state.ambient},set:function(e){var t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"color",get:function(){return this._state.color},set:function(e){var t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._state.alphaMode=e<1?2:0,this.glRedraw())}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),On={opaque:0,mask:1,blend:2},Nn=["opaque","mask","blend"],Vn=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"MetallicMaterial",baseColor:le.vec4([1,1,1]),emissive:le.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),r.baseColor=n.baseColor,r.metallic=n.metallic,r.roughness=n.roughness,r.specularF0=n.specularF0,r.emissive=n.emissive,r.alpha=n.alpha,n.baseColorMap&&(r._baseColorMap=r._checkComponent("Texture",n.baseColorMap)),n.metallicMap&&(r._metallicMap=r._checkComponent("Texture",n.metallicMap)),n.roughnessMap&&(r._roughnessMap=r._checkComponent("Texture",n.roughnessMap)),n.metallicRoughnessMap&&(r._metallicRoughnessMap=r._checkComponent("Texture",n.metallicRoughnessMap)),n.emissiveMap&&(r._emissiveMap=r._checkComponent("Texture",n.emissiveMap)),n.occlusionMap&&(r._occlusionMap=r._checkComponent("Texture",n.occlusionMap)),n.alphaMap&&(r._alphaMap=r._checkComponent("Texture",n.alphaMap)),n.normalMap&&(r._normalMap=r._checkComponent("Texture",n.normalMap)),r.alphaMode=n.alphaMode,r.alphaCutoff=n.alphaCutoff,r.backfaces=n.backfaces,r.frontface=n.frontface,r.lineWidth=n.lineWidth,r.pointSize=n.pointSize,r._makeHash(),r}return I(i,[{key:"type",get:function(){return"MetallicMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/met"];this._baseColorMap&&(t.push("/bm"),this._baseColorMap._state.hasMatrix&&t.push("/mat"),t.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(t.push("/mm"),this._metallicMap._state.hasMatrix&&t.push("/mat")),this._roughnessMap&&(t.push("/rm"),this._roughnessMap._state.hasMatrix&&t.push("/mat")),this._metallicRoughnessMap&&(t.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap._state.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap._state.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/am"),this._alphaMap._state.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap._state.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}},{key:"baseColor",get:function(){return this._state.baseColor},set:function(e){var t=this._state.baseColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.baseColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"baseColorMap",get:function(){return this._baseColorMap}},{key:"metallic",get:function(){return this._state.metallic},set:function(e){e=null!=e?e:1,this._state.metallic!==e&&(this._state.metallic=e,this.glRedraw())}},{key:"metallicMap",get:function(){return this._attached.metallicMap}},{key:"roughness",get:function(){return this._state.roughness},set:function(e){e=null!=e?e:1,this._state.roughness!==e&&(this._state.roughness=e,this.glRedraw())}},{key:"roughnessMap",get:function(){return this._attached.roughnessMap}},{key:"metallicRoughnessMap",get:function(){return this._attached.metallicRoughnessMap}},{key:"specularF0",get:function(){return this._state.specularF0},set:function(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"emissiveMap",get:function(){return this._attached.emissiveMap}},{key:"occlusionMap",get:function(){return this._attached.occlusionMap}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"alphaMap",get:function(){return this._attached.alphaMap}},{key:"normalMap",get:function(){return this._attached.normalMap}},{key:"alphaMode",get:function(){return Nn[this._state.alphaMode]},set:function(e){var t=On[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Qn={opaque:0,mask:1,blend:2},Hn=["opaque","mask","blend"],Gn=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"SpecularMaterial",diffuse:le.vec3([1,1,1]),emissive:le.vec3([0,0,0]),specular:le.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),r.diffuse=n.diffuse,r.specular=n.specular,r.glossiness=n.glossiness,r.specularF0=n.specularF0,r.emissive=n.emissive,r.alpha=n.alpha,n.diffuseMap&&(r._diffuseMap=r._checkComponent("Texture",n.diffuseMap)),n.emissiveMap&&(r._emissiveMap=r._checkComponent("Texture",n.emissiveMap)),n.specularMap&&(r._specularMap=r._checkComponent("Texture",n.specularMap)),n.glossinessMap&&(r._glossinessMap=r._checkComponent("Texture",n.glossinessMap)),n.specularGlossinessMap&&(r._specularGlossinessMap=r._checkComponent("Texture",n.specularGlossinessMap)),n.occlusionMap&&(r._occlusionMap=r._checkComponent("Texture",n.occlusionMap)),n.alphaMap&&(r._alphaMap=r._checkComponent("Texture",n.alphaMap)),n.normalMap&&(r._normalMap=r._checkComponent("Texture",n.normalMap)),r.alphaMode=n.alphaMode,r.alphaCutoff=n.alphaCutoff,r.backfaces=n.backfaces,r.frontface=n.frontface,r.lineWidth=n.lineWidth,r.pointSize=n.pointSize,r._makeHash(),r}return I(i,[{key:"type",get:function(){return"SpecularMaterial"}},{key:"_makeHash",value:function(){var e=this._state,t=["/spe"];this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat")),this._glossinessMap&&(t.push("/gm"),this._glossinessMap.hasMatrix&&t.push("/mat")),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._specularGlossinessMap&&(t.push("/sgm"),this._specularGlossinessMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}},{key:"diffuse",get:function(){return this._state.diffuse},set:function(e){var t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"diffuseMap",get:function(){return this._diffuseMap}},{key:"specular",get:function(){return this._state.specular},set:function(e){var t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}},{key:"specularMap",get:function(){return this._specularMap}},{key:"specularGlossinessMap",get:function(){return this._specularGlossinessMap}},{key:"glossiness",get:function(){return this._state.glossiness},set:function(e){e=null!=e?e:1,this._state.glossiness!==e&&(this._state.glossiness=e,this.glRedraw())}},{key:"glossinessMap",get:function(){return this._glossinessMap}},{key:"specularF0",get:function(){return this._state.specularF0},set:function(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}},{key:"emissive",get:function(){return this._state.emissive},set:function(e){var t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}},{key:"emissiveMap",get:function(){return this._emissiveMap}},{key:"alpha",get:function(){return this._state.alpha},set:function(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}},{key:"alphaMap",get:function(){return this._alphaMap}},{key:"normalMap",get:function(){return this._normalMap}},{key:"occlusionMap",get:function(){return this._occlusionMap}},{key:"alphaMode",get:function(){return Hn[this._state.alphaMode]},set:function(e){var t=Qn[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}},{key:"alphaCutoff",get:function(){return this._state.alphaCutoff},set:function(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"frontface",get:function(){return this._state.frontface?"ccw":"cw"},set:function(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||1,this.glRedraw()}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),jn={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}},zn=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),r._preset="default",n.preset?(r.preset=n.preset,void 0!==n.fill&&(r.fill=n.fill),n.fillColor&&(r.fillColor=n.fillColor),void 0!==n.fillAlpha&&(r.fillAlpha=n.fillAlpha),void 0!==n.edges&&(r.edges=n.edges),n.edgeColor&&(r.edgeColor=n.edgeColor),void 0!==n.edgeAlpha&&(r.edgeAlpha=n.edgeAlpha),void 0!==n.edgeWidth&&(r.edgeWidth=n.edgeWidth),void 0!==n.backfaces&&(r.backfaces=n.backfaces),void 0!==n.glowThrough&&(r.glowThrough=n.glowThrough)):(r.fill=n.fill,r.fillColor=n.fillColor,r.fillAlpha=n.fillAlpha,r.edges=n.edges,r.edgeColor=n.edgeColor,r.edgeAlpha=n.edgeAlpha,r.edgeWidth=n.edgeWidth,r.backfaces=n.backfaces,r.glowThrough=n.glowThrough),r}return I(i,[{key:"type",get:function(){return"EmphasisMaterial"}},{key:"presets",get:function(){return jn}},{key:"fill",get:function(){return this._state.fill},set:function(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}},{key:"fillColor",get:function(){return this._state.fillColor},set:function(e){var t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}},{key:"fillAlpha",get:function(){return this._state.fillAlpha},set:function(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}},{key:"edges",get:function(){return this._state.edges},set:function(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}},{key:"edgeColor",get:function(){return this._state.edgeColor},set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"edgeAlpha",get:function(){return this._state.edgeAlpha},set:function(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}},{key:"edgeWidth",get:function(){return this._state.edgeWidth},set:function(e){this._state.edgeWidth=e||1,this.glRedraw()}},{key:"backfaces",get:function(){return this._state.backfaces},set:function(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}},{key:"glowThrough",get:function(){return this._state.glowThrough},set:function(e){e=!1!==e,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}},{key:"preset",get:function(){return console.warn("EmphasisMaterial.preset is deprecated and will be removed in future versions."),this._preset},set:function(e){if(console.warn("EmphasisMaterial.preset is deprecated and will be removed in future versions."),e=e||"default",this._preset!==e){var t=jn[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(jn).join(", "))}}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Wn={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}},Xn=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),r._preset="default",n.preset?(r.preset=n.preset,n.edgeColor&&(r.edgeColor=n.edgeColor),void 0!==n.edgeAlpha&&(r.edgeAlpha=n.edgeAlpha),void 0!==n.edgeWidth&&(r.edgeWidth=n.edgeWidth)):(r.edgeColor=n.edgeColor,r.edgeAlpha=n.edgeAlpha,r.edgeWidth=n.edgeWidth),r.edges=!1!==n.edges,r}return I(i,[{key:"type",get:function(){return"EdgeMaterial"}},{key:"presets",get:function(){return Wn}},{key:"edges",get:function(){return this._state.edges},set:function(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}},{key:"edgeColor",get:function(){return this._state.edgeColor},set:function(e){var t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}},{key:"edgeAlpha",get:function(){return this._state.edgeAlpha},set:function(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}},{key:"edgeWidth",get:function(){return this._state.edgeWidth},set:function(e){this._state.edgeWidth=e||1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=Wn[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Wn).join(", "))}}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Kn=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({edgeColor:le.vec3([0,0,0]),centerColor:le.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),r.edgeColor=n.edgeColor,r.centerColor=n.centerColor,r.edgeBias=n.edgeBias,r.centerBias=n.centerBias,r.power=n.power,r}return I(i,[{key:"type",get:function(){return"Fresnel"}},{key:"edgeColor",get:function(){return this._state.edgeColor},set:function(e){this._state.edgeColor.set(e||[0,0,0]),this.glRedraw()}},{key:"centerColor",get:function(){return this._state.centerColor},set:function(e){this._state.centerColor.set(e||[1,1,1]),this.glRedraw()}},{key:"edgeBias",get:function(){return this._state.edgeBias},set:function(e){this._state.edgeBias=e||0,this.glRedraw()}},{key:"centerBias",get:function(){return this._state.centerBias},set:function(e){this._state.centerBias=null!=e?e:1,this.glRedraw()}},{key:"power",get:function(){return this._state.power},set:function(e){this._state.power=null!=e?e:1,this.glRedraw()}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Zn=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._type=n.type||(n.src?n.src.split(".").pop():null)||"jpg",r._pos=le.vec3(n.pos||[0,0,0]),r._up=le.vec3(n.up||[0,1,0]),r._normal=le.vec3(n.normal||[0,0,1]),r._height=n.height||1,r._origin=le.vec3(),r._rtcPos=le.vec3(),r._imageSize=le.vec2(),r._texture=new In(w(r),{flipY:!0}),r._image=new Image,"jpg"!==r._type&&"png"!==r._type&&(r.error('Unsupported type - defaulting to "jpg"'),r._type="jpg"),r._node=new Xt(w(r),{matrix:le.inverseMat4(le.lookAtMat4v(r._pos,le.subVec3(r._pos,r._normal,le.mat4()),r._up,le.mat4())),children:[r._bitmapMesh=new vn(w(r),{scale:[1,1,1],rotation:[-90,0,0],collidable:n.collidable,pickable:n.pickable,opacity:n.opacity,clippable:n.clippable,geometry:new mt(w(r),Et({center:[0,0,0],xSize:1,zSize:1,xSegments:2,zSegments:2})),material:new bn(w(r),{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:r._texture,emissiveMap:r._texture,backfaces:!0})})]}),n.image?r.image=n.image:n.src?r.src=n.src:n.imageData&&(r.imageData=n.imageData),r.scene._bitmapCreated(w(r)),r}return I(i,[{key:"visible",get:function(){return this._bitmapMesh.visible},set:function(e){this._bitmapMesh.visible=e}},{key:"image",get:function(){return this._image},set:function(e){this._image=e,this._image&&(this._texture.image=this._image,this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updateBitmapMeshScale())}},{key:"src",get:function(){return this._image.src},set:function(e){var t=this;if(e)switch(this._image.onload=function(){t._texture.image=t._image,t._imageSize[0]=t._image.width,t._imageSize[1]=t._image.height,t._updateBitmapMeshScale()},this._image.src=e,e.split(".").pop()){case"jpeg":case"jpg":this._type="jpg";break;case"png":this._type="png"}}},{key:"imageData",get:function(){var e=document.createElement("canvas"),t=e.getContext("2d");return e.width=this._image.width,e.height=this._image.height,t.drawImage(this._image,0,0),e.toDataURL("jpg"===this._type?"image/jpeg":"image/png")},set:function(e){var t=this;this._image.onload=function(){t._texture.image=image,t._imageSize[0]=image.width,t._imageSize[1]=image.height,t._updateBitmapMeshScale()},this._image.src=e}},{key:"type",get:function(){return this._type},set:function(e){"png"===(e=e||"jpg")&&"jpg"===e||(this.error("Unsupported value for `type` - supported types are `jpg` and `png` - defaulting to `jpg`"),e="jpg"),this._type=e}},{key:"pos",get:function(){return this._pos}},{key:"normal",get:function(){return this._normal}},{key:"up",get:function(){return this._up}},{key:"height",get:function(){return this._height},set:function(e){this._height=null==e?1:e,this._image&&this._updateBitmapMeshScale()}},{key:"collidable",get:function(){return this._bitmapMesh.collidable},set:function(e){this._bitmapMesh.collidable=!1!==e}},{key:"clippable",get:function(){return this._bitmapMesh.clippable},set:function(e){this._bitmapMesh.clippable=!1!==e}},{key:"pickable",get:function(){return this._bitmapMesh.pickable},set:function(e){this._bitmapMesh.pickable=!1!==e}},{key:"opacity",get:function(){return this._bitmapMesh.opacity},set:function(e){this._bitmapMesh.opacity=e}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene._bitmapDestroyed(this)}},{key:"_updateBitmapMeshScale",value:function(){var e=this._imageSize[1]/this._imageSize[0];this._bitmapMesh.scale=[this._height/e,1,this._height]}}]),i}(),Jn=function(e,t){var i=[],r=[];function n(e,i){for(var r,n,s=0;s<3;s++)if((r=t[3*e+s])!==(n=t[3*i+s]))return n-r;return 0}for(var s=e.slice().sort(n),o=null,a=0,l=s.length;a<l;a++)0!==a&&0===n(s[a],s[a-1])||(o=s[a]),i[s[a]]=o;for(var u=0,A=e.length;u<A;u+=3){var c=i[e[u]],h=i[e[u+1]],d=i[e[u+2]],p=c,f=h,v=d;if(c>h&&c>d?h>d?(p=c,f=h,v=d):(p=c,f=d,v=h):h>c&&h>d?c>d?(p=h,f=c,v=d):(p=h,f=d,v=c):d>c&&d>h&&(c>h?(p=d,f=c,v=h):(p=d,f=h,v=c)),r[u+0]=[p,f],r[u+1]=[f,v],p>v){var g=v;v=p,p=g}r[u+2]=[v,p]}function m(e,t){for(var i,r,n=0;n<2;n++)if(i=e[n],(r=t[n])!==i)return r-i;return 0}(r=r.slice(0,e.length)).sort(m);for(var _=0,y=0;y<r.length;y++)if(0===y||0!==m(r[y],r[y-1])){if(0!==y&&2!==_)return!1;_=1}else _++;return!(r.length>0&&2!==_)},Yn=le.vec3(),qn=le.vec3(),$n=le.vec3(),es=function(){function e(){k(this,e),this.vertices=[],this.indices=[],this.reset()}return I(e,[{key:"reset",value:function(){this.lenVertices=0,this.lenIndices=0,this.primitive=null}},{key:"setPrimitive",value:function(e){this.primitive=e}},{key:"addVertex",value:function(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}},{key:"addIndex",value:function(e){this.indices[this.lenIndices++]=e}},{key:"volume",get:function(){var e=this.vertices,t=this.indices;if("solid"!==this.primitive&&"surface"!==this.primitive&&"triangles"!==this.primitive)return-1;if("solid"!==this.primitive&&!Jn(t,e))return-1;for(var i=0,r=0;r<this.lenIndices;r+=3){var n=3*t[r],s=3*t[r+1],o=3*t[r+2];Yn[0]=e[n],Yn[1]=e[n+1],Yn[2]=e[n+2],qn[0]=e[s],qn[1]=e[s+1],qn[2]=e[s+2],$n[0]=e[o],$n[1]=e[o+1],$n[2]=e[o+2],le.cross3Vec3(Yn,qn,Yn),i+=le.dotVec3(Yn,$n)}return i/6}}]),e}(),ts=new es,is=le.vec3(),rs=le.vec3(),ns=le.vec3(),ss=le.vec3(),os=le.vec3(),as=le.vec3(),ls=function(){function e(){k(this,e),this.vertices=[],this.indices=[],this.reset()}return I(e,[{key:"reset",value:function(){this.lenVertices=0,this.lenIndices=0}},{key:"addVertex",value:function(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}},{key:"addIndex",value:function(e){this.indices[this.lenIndices++]=e}},{key:"surfaceArea",get:function(){for(var e=this.vertices,t=this.indices,i=0,r=0;r<this.lenIndices;r+=3){var n=3*t[r],s=3*t[r+1],o=3*t[r+2];is[0]=e[n],is[1]=e[n+1],is[2]=e[n+2],rs[0]=e[s],rs[1]=e[s+1],rs[2]=e[s+2],ns[0]=e[o],ns[1]=e[o+1],ns[2]=e[o+2],le.subVec3(is,rs,ss),le.subVec3(ns,rs,os),i+=.5*le.lenVec3(le.cross3Vec3(ss,os,as))}return i}}]),e}(),us=new ls,As=le.OBB3(),cs=le.OBB3(),hs=le.OBB3(),ds=function(){function e(t,i,r,n,s,o){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0;k(this,e),this.model=t,this.object=null,this.parent=null,this.transform=s,this.textureSet=o,this._matrixDirty=!1,this._matrixUpdateScheduled=!1,this.id=i,this.obb=null,this._aabbLocal=null,this._aabbWorld=le.AABB3(),this._aabbWorldDirty=!1,this.layer=a,this.portionId=l,this._color=new Uint8Array([r[0],r[1],r[2],n]),this._colorize=new Uint8Array([r[0],r[1],r[2],n]),this._colorizing=!1,this._transparent=n<255,this.numTriangles=0,this.origin=null,this.entity=null,s&&s._addMesh(this),this._volume=null,this._surfaceArea=null}return I(e,[{key:"_sceneModelDirty",value:function(){this._aabbWorldDirty=!0,this.layer.aabbDirty=!0}},{key:"_transformDirty",value:function(){this._matrixDirty||this._matrixUpdateScheduled||(this.model._meshMatrixDirty(this),this._matrixDirty=!0,this._matrixUpdateScheduled=!0),this._aabbWorldDirty=!0,this.layer.aabbDirty=!0,this.entity&&this.entity._transformDirty()}},{key:"_updateMatrix",value:function(){this.transform&&this._matrixDirty&&this.layer.setMatrix(this.portionId,this.transform.worldMatrix),this._matrixDirty=!1,this._matrixUpdateScheduled=!1}},{key:"_finalize",value:function(e){this.layer.initFlags(this.portionId,e,this._transparent)}},{key:"_finalize2",value:function(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}},{key:"_setVisible",value:function(e){this.layer.setVisible(this.portionId,e,this._transparent)}},{key:"_setColor",value:function(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this.layer.setColor(this.portionId,this._color,!1)}},{key:"_setColorize",value:function(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this.layer.setColor(this.portionId,this._colorize,false),this._colorizing=!0):(this.layer.setColor(this.portionId,this._color,false),this._colorizing=!1)}},{key:"_setOpacity",value:function(e,t){var i=e<255,r=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this.layer.setColor(this.portionId,this._colorize):this.layer.setColor(this.portionId,this._color),r&&this.layer.setTransparent(this.portionId,t,i)}},{key:"_setOffset",value:function(e){this.layer.setOffset(this.portionId,e)}},{key:"_setHighlighted",value:function(e){this.layer.setHighlighted(this.portionId,e,this._transparent)}},{key:"_setXRayed",value:function(e){this.layer.setXRayed(this.portionId,e,this._transparent)}},{key:"_setSelected",value:function(e){this.layer.setSelected(this.portionId,e,this._transparent)}},{key:"_setEdges",value:function(e){this.layer.setEdges(this.portionId,e,this._transparent)}},{key:"_setClippable",value:function(e){this.layer.setClippable(this.portionId,e,this._transparent)}},{key:"_setCollidable",value:function(e){this.layer.setCollidable(this.portionId,e)}},{key:"_setPickable",value:function(e){this.layer.setPickable(this.portionId,e,this._transparent)}},{key:"_setCulled",value:function(e){this.layer.setCulled(this.portionId,e,this._transparent)}},{key:"canPickTriangle",value:function(){return!1}},{key:"drawPickTriangles",value:function(e,t){}},{key:"pickTriangleSurface",value:function(e){}},{key:"precisionRayPickSurface",value:function(e,t,i,r){return!!this.layer.precisionRayPickSurface&&this.layer.precisionRayPickSurface(this.portionId,e,t,i,r)}},{key:"canPickWorldPos",value:function(){return!0}},{key:"drawPickDepths",value:function(e){this.model.drawPickDepths(e)}},{key:"drawPickNormals",value:function(e){this.model.drawPickNormals(e)}},{key:"delegatePickedEntity",value:function(){return this.parent}},{key:"getEachVertex",value:function(e){this.layer.getEachVertex&&this.layer.getEachVertex(this.portionId,e)}},{key:"getEachIndex",value:function(e){this.layer.getEachIndex&&this.layer.getEachIndex(this.portionId,e)}},{key:"isSolid",value:function(){return this.layer.solid}},{key:"volume",get:function(){if(null!==this._volume)return this._volume;switch(this.layer.primitive){case"solid":case"surface":case"triangles":ts.reset(),ts.setPrimitive(this.layer.primitive),this.getEachVertex((function(e){ts.addVertex(e)})),this.getEachIndex((function(e){ts.addIndex(e)})),this._volume=ts.volume;break;default:this._volume=0}return this._volume}},{key:"surfaceArea",get:function(){if(null!==this._surfaceArea)return this._surfaceArea;switch(this.layer.primitive){case"solid":case"surface":case"triangles":us.reset(),this.getEachVertex((function(e){us.addVertex(e)})),this.getEachIndex((function(e){us.addIndex(e)})),this._surfaceArea=us.surfaceArea;break;default:this._surfaceArea=0}return this._surfaceArea}},{key:"aabb",get:function(){return this._aabbWorldDirty&&(le.AABB3ToOBB3(this._aabbLocal,As),this.transform?(le.transformOBB3(this.transform.worldMatrix,As,cs),le.transformOBB3(this.model.worldMatrix,cs,hs),le.OBB3ToAABB3(hs,this._aabbWorld)):(le.transformOBB3(this.model.worldMatrix,As,cs),le.OBB3ToAABB3(cs,this._aabbWorld)),this._aabbWorldDirty=!1),this._aabbWorld},set:function(e){if(this._aabbLocal=e,this.origin){this._aabbLocal=e.slice(0);var t=this.origin;this._aabbLocal[0]+=t[0],this._aabbLocal[1]+=t[1],this._aabbLocal[2]+=t[2],this._aabbLocal[3]+=t[0],this._aabbLocal[4]+=t[1],this._aabbLocal[5]+=t[2]}}},{key:"_destroy",value:function(){this.model.scene._renderer.putPickID(this.pickId)}}]),e}(),ps=new(function(){function e(){k(this,e),this._uint8Arrays={},this._float32Arrays={}}return I(e,[{key:"_clear",value:function(){this._uint8Arrays={},this._float32Arrays={}}},{key:"getUInt8Array",value:function(e){var t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}},{key:"getFloat32Array",value:function(e){var t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}}]),e}()),fs=0;function vs(){return fs++,ps}var gs=1,ms=4,_s=8,ys=16,bs=32,ws=256,Bs=512,xs=1024,Ps=2048,Cs={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},Ms=new Float32Array([1,1,1,1]),Fs=new Float32Array([0,0,0,1]),ks=le.vec4(),Es=le.vec3(),Is=le.vec3(),Ts=le.mat4(),Ds=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.instancing,s=void 0!==n&&n,o=r.edges,a=void 0!==o&&o,l=r.useAlphaCutoff,u=void 0!==l&&l;k(this,e),this._scene=t,this._withSAO=i,this._instancing=s,this._edges=a,this._useAlphaCutoff=u,this._hash=this._getHash(),this._matricesUniformBlockBufferBindingPoint=0,this._matricesUniformBlockBuffer=this._scene.canvas.gl.createBuffer(),this._matricesUniformBlockBufferData=new Float32Array(96),this._vaoCache=new WeakMap,this._allocate()}return I(e,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){return[""]}},{key:"_buildFragmentShader",value:function(){return[""]}},{key:"_addMatricesUniformBlockLines",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.push("uniform Matrices {"),e.push("    mat4 worldMatrix;"),e.push("    mat4 viewMatrix;"),e.push("    mat4 projMatrix;"),e.push("    mat4 positionsDecodeMatrix;"),t&&(e.push("    mat4 worldNormalMatrix;"),e.push("    mat4 viewNormalMatrix;")),e.push("};"),e}},{key:"_addRemapClipPosLines",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return e.push("uniform vec2 drawingBufferSize;"),e.push("uniform vec2 pickClipPos;"),e.push("vec4 remapClipPos(vec4 clipPos) {"),e.push("    clipPos.xy /= clipPos.w;"),1===t?e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"):e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * (drawingBufferSize / float(".concat(t,"));")),e.push("    clipPos.xy *= clipPos.w;"),e.push("    return clipPos;"),e.push("}"),e}},{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"setSectionPlanesStateUniforms",value:function(e){var t=this._scene,i=t.canvas.gl,r=e.model,n=e.layerIndex,s=t._sectionPlanesState.getNumAllocatedSectionPlanes(),o=t._sectionPlanesState.sectionPlanes.length;if(s>0){var a=t._sectionPlanesState.sectionPlanes,l=n*o,u=r.renderFlags;t.crossSections&&(i.uniform4fv(this._uSliceColor,t.crossSections.sliceColor),i.uniform1f(this._uSliceThickness,t.crossSections.sliceThickness));for(var A=0;A<s;A++){var c=this._uSectionPlanes[A];if(c)if(A<o){var h=u.sectionPlanesActivePerLayer[l+A];if(i.uniform1i(c.active,h?1:0),h){var d=a[A],p=e._state.origin;if(p){var f=ei(d.dist,d.dir,p,Es,r.matrix);i.uniform3fv(c.pos,f)}else i.uniform3fv(c.pos,d.pos);i.uniform3fv(c.dir,d.dir)}}else i.uniform1i(c.active,0)}}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uColor=r.getLocation("color"),this._uColor||(this._uColor=r.getLocation("silhouetteColor")),this._uUVDecodeMatrix=r.getLocation("uvDecodeMatrix"),this._uPickInvisible=r.getLocation("pickInvisible"),this._uGammaFactor=r.getLocation("gammaFactor"),t.uniformBlockBinding(r.handle,t.getUniformBlockIndex(r.handle,"Matrices"),this._matricesUniformBlockBufferBindingPoint),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=r.getLocation("zFar")),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,s=0,o=n.length;s<o;s++)switch(n[s].type){case"dir":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=null,this._uLightDir[s]=r.getLocation("lightDir"+s);break;case"point":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=r.getLocation("lightPos"+s),this._uLightDir[s]=null,this._uLightAttenuation[s]=r.getLocation("lightAttenuation"+s);break;case"spot":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=r.getLocation("lightPos"+s),this._uLightDir[s]=r.getLocation("lightDir"+s),this._uLightAttenuation[s]=r.getLocation("lightAttenuation"+s)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(var a=0,l=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<l;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aUV=r.getAttribute("uv"),this._aColor=r.getAttribute("color"),this._aMetallicRoughness=r.getAttribute("metallicRoughness"),this._aFlags=r.getAttribute("flags"),this._aPickColor=r.getAttribute("pickColor"),this._uPickZNear=r.getLocation("pickZNear"),this._uPickZFar=r.getLocation("pickZFar"),this._uPickClipPos=r.getLocation("pickClipPos"),this._uDrawingBufferSize=r.getLocation("drawingBufferSize"),this._uColorMap="uColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._instancing&&(this._aModelMatrix=r.getAttribute("modelMatrix"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2")),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),this._useAlphaCutoff&&(this._alphaCutoffLocation=r.getLocation("materialAlphaCutoff")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),e.pointsMaterial._state.filterIntensity&&(this._uIntensityRange=r.getLocation("intensityRange")),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.crossSections&&(this._uSliceColor=r.getLocation("sliceColor"),this._uSliceThickness=r.getLocation("sliceThickness"))}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t._lightsState,s=n.lights;r.bind(),e.textureUnit=0,this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,n.getAmbientColorAndIntensity()),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor);for(var o=0,a=s.length;o<a;o++){var l=s[o];this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],l.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],l.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],l.dir)}}},{key:"_makeVAO",value:function(e){var t=this._scene.canvas.gl,i=t.createVertexArray();return t.bindVertexArray(i),this._instancing&&(this._aModelMatrixCol0.bindArrayBuffer(e.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(e.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(e.modelMatrixCol2Buf),t.vertexAttribDivisor(this._aModelMatrixCol0.location,1),t.vertexAttribDivisor(this._aModelMatrixCol1.location,1),t.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0&&(this._aModelNormalMatrixCol0.bindArrayBuffer(e.modelNormalMatrixCol0Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1)),this._aModelNormalMatrixCol1&&(this._aModelNormalMatrixCol1.bindArrayBuffer(e.modelNormalMatrixCol1Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1)),this._aModelNormalMatrixCol2&&(this._aModelNormalMatrixCol2.bindArrayBuffer(e.modelNormalMatrixCol2Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1))),this._aPosition.bindArrayBuffer(e.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(e.uvBuf),this._aNormal&&this._aNormal.bindArrayBuffer(e.normalsBuf),this._aMetallicRoughness&&(this._aMetallicRoughness.bindArrayBuffer(e.metallicRoughnessBuf),this._instancing&&t.vertexAttribDivisor(this._aMetallicRoughness.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(e.colorsBuf),this._instancing&&e.colorsBuf&&t.vertexAttribDivisor(this._aColor.location,1)),this._aFlags&&(this._aFlags.bindArrayBuffer(e.flagsBuf),this._instancing&&t.vertexAttribDivisor(this._aFlags.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(e.offsetsBuf),this._instancing&&t.vertexAttribDivisor(this._aOffset.location,1)),this._aPickColor&&(this._aPickColor.bindArrayBuffer(e.pickColorsBuf),this._instancing&&t.vertexAttribDivisor(this._aPickColor.location,1)),this._instancing,this._edges&&e.edgeIndicesBuf?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind(),i}},{key:"drawLayer",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=r.colorUniform,s=void 0!==n&&n,o=r.incrementDrawState,a=void 0!==o&&o,l=Cr.MAX_TEXTURE_IMAGE_UNITS,u=this._scene,A=u.canvas.gl,c=t._state,h=t.model,d=c.textureSet,p=c.origin,f=c.positionsDecodeMatrix,v=u._lightsState,g=u.pointsMaterial,m=h.scene.camera,_=m.viewNormalMatrix,y=m.project,b=e.pickViewMatrix||m.viewMatrix,w=h.position,B=h.rotationMatrix,x=h.worldNormalMatrix;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),this._vaoCache.has(t)?A.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(c));var P=0,C=16;this._matricesUniformBlockBufferData.set(B,0);var M=0!==p[0]||0!==p[1]||0!==p[2],F=0!==w[0]||0!==w[1]||0!==w[2];if(M||F){var k=Es;if(M){var E=le.transformPoint3(B,p,Is);k[0]=E[0],k[1]=E[1],k[2]=E[2]}else k[0]=0,k[1]=0,k[2]=0;k[0]+=w[0],k[1]+=w[1],k[2]+=w[2],this._matricesUniformBlockBufferData.set(Jt(b,k,Ts),P+=C)}else this._matricesUniformBlockBufferData.set(b,P+=C);if(this._matricesUniformBlockBufferData.set(e.pickProjMatrix||y.matrix,P+=C),this._matricesUniformBlockBufferData.set(f,P+=C),this._matricesUniformBlockBufferData.set(x,P+=C),this._matricesUniformBlockBufferData.set(_,P+=C),A.bindBuffer(A.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),A.bufferData(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,A.DYNAMIC_DRAW),A.bindBufferBase(A.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer),A.uniform1i(this._uRenderPass,i),this.setSectionPlanesStateUniforms(t),u.logarithmicDepthBufferEnabled){if(this._uLogDepthBufFC){var I=2/(Math.log(e.pickZFar+1)/Math.LN2);A.uniform1f(this._uLogDepthBufFC,I)}this._uZFar&&A.uniform1f(this._uZFar,u.camera.project.far)}if(this._uPickInvisible&&A.uniform1i(this._uPickInvisible,e.pickInvisible),this._uPickZNear&&A.uniform1f(this._uPickZNear,e.pickZNear),this._uPickZFar&&A.uniform1f(this._uPickZFar,e.pickZFar),this._uPickClipPos&&A.uniform2fv(this._uPickClipPos,e.pickClipPos),this._uDrawingBufferSize&&A.uniform2f(this._uDrawingBufferSize,A.drawingBufferWidth,A.drawingBufferHeight),this._uUVDecodeMatrix&&A.uniformMatrix3fv(this._uUVDecodeMatrix,!1,c.uvDecodeMatrix),this._uIntensityRange&&g.filterIntensity&&A.uniform2f(this._uIntensityRange,g.minIntensity,g.maxIntensity),this._uPointSize&&A.uniform1f(this._uPointSize,g.pointSize),this._uNearPlaneHeight){var T="ortho"===u.camera.projection?1:A.drawingBufferHeight/(2*Math.tan(.5*u.camera.perspective.fov*Math.PI/180));A.uniform1f(this._uNearPlaneHeight,T)}if(d){var D=d.colorTexture,S=d.metallicRoughnessTexture,R=d.emissiveTexture,U=d.normalsTexture,L=d.occlusionTexture;this._uColorMap&&D&&(this._program.bindTexture(this._uColorMap,D.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l),this._uMetallicRoughMap&&S&&(this._program.bindTexture(this._uMetallicRoughMap,S.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l),this._uEmissiveMap&&R&&(this._program.bindTexture(this._uEmissiveMap,R.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l),this._uNormalMap&&U&&(this._program.bindTexture(this._uNormalMap,U.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l),this._uAOMap&&L&&(this._program.bindTexture(this._uAOMap,L.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l)}if(v.reflectionMaps.length>0&&v.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,v.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l,e.bindTexture++),v.lightMaps.length>0&&v.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,v.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l,e.bindTexture++),this._withSAO){var O=u.sao,N=O.possible;if(N){var V=A.drawingBufferWidth,Q=A.drawingBufferHeight;ks[0]=V,ks[1]=Q,ks[2]=O.blendCutoff,ks[3]=O.blendFactor,A.uniform4fv(this._uSAOParams,ks),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%l,e.bindTexture++}}if(this._useAlphaCutoff&&A.uniform1f(this._alphaCutoffLocation,d.alphaCutoff),s){var H=this._edges?"edgeColor":"fillColor",G=this._edges?"edgeAlpha":"fillAlpha";if(i===Cs["".concat(this._edges?"EDGES":"SILHOUETTE","_XRAYED")]){var j=u.xrayMaterial._state,z=j[H],W=j[G];A.uniform4f(this._uColor,z[0],z[1],z[2],W)}else if(i===Cs["".concat(this._edges?"EDGES":"SILHOUETTE","_HIGHLIGHTED")]){var X=u.highlightMaterial._state,K=X[H],Z=X[G];A.uniform4f(this._uColor,K[0],K[1],K[2],Z)}else if(i===Cs["".concat(this._edges?"EDGES":"SILHOUETTE","_SELECTED")]){var J=u.selectedMaterial._state,Y=J[H],q=J[G];A.uniform4f(this._uColor,Y[0],Y[1],Y[2],q)}else A.uniform4fv(this._uColor,this._edges?Fs:Ms)}this._draw({state:c,frameCtx:e,incrementDrawState:a}),A.bindVertexArray(null)}}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null,he.memory.programs--}}]),e}(),Ss=function(e){m(i,Ds);var t=y(i);function i(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=n.edges,o=void 0!==s&&s,a=n.useAlphaCutoff,l=void 0!==a&&a;return k(this,i),t.call(this,e,r,{instancing:!1,edges:o,useAlphaCutoff:l})}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;if(this._edges)i.edgeIndicesBuf&&t.drawElements(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0);else{var s=r.pickElementsCount||i.indicesBuf.numItems,o=r.pickElementsOffset?r.pickElementsOffset*i.indicesBuf.itemByteSize:0;t.drawElements(t.TRIANGLES,s,i.indicesBuf.itemType,o),n&&r.drawElements++}}}]),i}(),Rs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e,t=this._scene,i=t._sectionPlanesState,r=t._lightsState,n=i.getNumAllocatedSectionPlanes()>0,s=[];s.push("#version 300 es"),s.push("// Triangles batching draw vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in float flags;"),t.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s,!0),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("uniform vec4 lightAmbient;");for(var o=0,a=r.lights.length;o<a;o++)"ambient"!==(e=r.lights[o]).type&&(s.push("uniform vec4 lightColor"+o+";"),"dir"===e.type&&s.push("uniform vec3 lightDir"+o+";"),"point"===e.type&&s.push("uniform vec3 lightPos"+o+";"),"spot"===e.type&&(s.push("uniform vec3 lightPos"+o+";"),s.push("uniform vec3 lightDir"+o+";")));s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),n&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),s.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),s.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),s.push("float lambertian = 1.0;");for(var l=0,u=r.lights.length;l<u;l++)if("ambient"!==(e=r.lights[l]).type){if("dir"===e.type)"view"===e.space?s.push("viewLightDir = normalize(lightDir"+l+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?s.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):s.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?s.push("viewLightDir = normalize(lightDir"+l+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);")}s.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),s.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}return s.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),s.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching draw fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";");r.push("uniform float sliceThickness;"),r.push("uniform vec4 sliceColor;")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec4 newColor;"),r.push("  newColor = vColor;"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > sliceThickness) { "),r.push("      discard;"),r.push("  }"),r.push("  if (dist > 0.0) { "),r.push("      newColor = sliceColor;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled?(r.push("    float dx = dFdx(vFragDepth);"),r.push("    float dy = dFdy(vFragDepth);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;")):(r.push("    float dx = dFdx(gl_FragCoord.z);"),r.push("    float dy = dFdy(gl_FragCoord.z);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):r.push("   outColor            = newColor;"),r.push("}"),r}}]),i}(),Us=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching flat-shading draw vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._lightsState,i=e._sectionPlanesState,r=i.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching flat-shading draw fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(var s=0,o=i.getNumAllocatedSectionPlanes();s<o;s++)n.push("uniform bool sectionPlaneActive"+s+";"),n.push("uniform vec3 sectionPlanePos"+s+";"),n.push("uniform vec3 sectionPlaneDir"+s+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(var a=0,l=t.lights.length;a<l;a++){var u=t.lights[a];"ambient"!==u.type&&(n.push("uniform vec4 lightColor"+a+";"),"dir"===u.type&&n.push("uniform vec3 lightDir"+a+";"),"point"===u.type&&n.push("uniform vec3 lightPos"+a+";"),"spot"===u.type&&(n.push("uniform vec3 lightPos"+a+";"),n.push("uniform vec3 lightDir"+a+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),r){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(var A=0,c=i.getNumAllocatedSectionPlanes();A<c;A++)n.push("if (sectionPlaneActive"+A+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(var h=0,d=t.lights.length;h<d;h++){var p=t.lights[h];if("ambient"!==p.type){if("dir"===p.type)"view"===p.space?n.push("viewLightDir = normalize(lightDir"+h+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+h+", 0.0)).xyz);");else if("point"===p.type)"view"===p.space?n.push("viewLightDir = -normalize(lightPos"+h+" - vViewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+h+", 0.0)).xyz);");else{if("spot"!==p.type)continue;"view"===p.space?n.push("viewLightDir = normalize(lightDir"+h+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+h+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return n.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled?n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(n.push("    float dx = dFdx(gl_FragCoord.z);"),n.push("    float dy = dFdy(gl_FragCoord.z);"),n.push("    float diff = sqrt(dx*dx+dy*dy);"),n.push("    gl_FragDepth = gl_FragCoord.z + diff;")),n.push("}"),n}}]),i}(),Ls=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 color;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, color.a ));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),n){for(s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),n){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0,a=r.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return i.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = newColor;"),s.push("}"),s}}]),i}(),Os=function(e){m(i,Ss);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!1,edges:!0})}return I(i)}(),Ns=function(e){m(i,Os);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesEmphasisRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// EdgesEmphasisRenderer fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vColor;"),r.push("}"),r}}]),i}(),Vs=function(e){m(i,Os);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!1})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry edges drawing fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vColor;"),r.push("}"),r}}]),i}(),Qs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vPickColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   outColor = vPickColor; "),r.push("}"),r}}]),i}(),Hs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching pick depth fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    outColor = packDepth(zNormalizedDepth); "),r.push("}"),r}}]),i}(),Gs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching pick normals fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vWorldNormal;"),r.push("out highp ivec4 outNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outNormal = ivec4(vWorldNormal * float(".concat(le.MAX_INT,"), 1.0);")),r.push("}"),r}}]),i}(),js=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching occlusion fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}}]),i}(),zs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching depth fragment shader"),r.push("precision highp float;"),r.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec2 vHighPrecisionZW;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),r.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),r.push("}"),r}}]),i}(),Ws=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags         = flags;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry normals fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}}]),i}(),Xs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry shadow vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  int colorFlag = int(flags) & 0xF;"),i.push("  bool visible        = (colorFlag > 0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    outColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}}]),i}(),Ks=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=e._lightsState,r=t.getNumAllocatedSectionPlanes()>0,n=t.clippingCaps,s=[];return s.push("#version 300 es"),s.push("// Triangles batching quality draw vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in vec2 metallicRoughness;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s,!0),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),s.push("out vec4 vViewPosition;"),s.push("out vec3 vViewNormal;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&s.push("out vec3 vWorldNormal;"),r&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;"),n&&s.push("out vec4 vClipPosition;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("vFragDepth = 1.0 + clipPos.w;")),r&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;"),n&&s.push("vClipPosition = clipPos;")),s.push("vViewPosition = viewPosition;"),s.push("vViewNormal = viewNormal;"),s.push("vColor = color;"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&s.push("vWorldNormal = worldNormal.xyz;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,r=e._lightsState,n=i.getNumAllocatedSectionPlanes()>0,s=i.clippingCaps,o=[];o.push("#version 300 es"),o.push("// Triangles batching quality draw fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),o.push("uniform sampler2D uColorMap;"),o.push("uniform sampler2D uMetallicRoughMap;"),o.push("uniform sampler2D uEmissiveMap;"),o.push("uniform sampler2D uNormalMap;"),o.push("uniform sampler2D uAOMap;"),o.push("in vec4 vViewPosition;"),o.push("in vec3 vViewNormal;"),o.push("in vec4 vColor;"),o.push("in vec2 vUV;"),o.push("in vec2 vMetallicRoughness;"),r.lightMaps.length>0&&o.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(o,!0),r.reflectionMaps.length>0&&o.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&o.push("uniform samplerCube lightMap;"),o.push("uniform vec4 lightAmbient;");for(var a=0,l=r.lights.length;a<l;a++){var u=r.lights[a];"ambient"!==u.type&&(o.push("uniform vec4 lightColor"+a+";"),"dir"===u.type&&o.push("uniform vec3 lightDir"+a+";"),"point"===u.type&&o.push("uniform vec3 lightPos"+a+";"),"spot"===u.type&&(o.push("uniform vec3 lightPos"+a+";"),o.push("uniform vec3 lightDir"+a+";")))}if(this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),o.push("uniform float gammaFactor;"),o.push("vec4 linearToLinear( in vec4 value ) {"),o.push("  return value;"),o.push("}"),o.push("vec4 sRGBToLinear( in vec4 value ) {"),o.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),o.push("}"),o.push("vec4 gammaToLinear( in vec4 value) {"),o.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),o.push("}"),t&&(o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),n){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),s&&o.push("in vec4 vClipPosition;");for(var A=0,c=i.getNumAllocatedSectionPlanes();A<c;A++)o.push("uniform bool sectionPlaneActive"+A+";"),o.push("uniform vec3 sectionPlanePos"+A+";"),o.push("uniform vec3 sectionPlaneDir"+A+";")}if(o.push("#define PI 3.14159265359"),o.push("#define RECIPROCAL_PI 0.31830988618"),o.push("#define RECIPROCAL_PI2 0.15915494"),o.push("#define EPSILON 1e-6"),o.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),o.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),o.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),o.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),o.push("              return surf_norm;"),o.push("       }"),o.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),o.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),o.push("      vec2 st0 = dFdx( uv.st );"),o.push("      vec2 st1 = dFdy( uv.st );"),o.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),o.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),o.push("      vec3 N = normalize( surf_norm );"),o.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),o.push("      mat3 tsn = mat3( S, T, N );"),o.push("      return normalize( tsn * mapN );"),o.push("}"),o.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),o.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),o.push("}"),o.push("struct IncidentLight {"),o.push("   vec3 color;"),o.push("   vec3 direction;"),o.push("};"),o.push("struct ReflectedLight {"),o.push("   vec3 diffuse;"),o.push("   vec3 specular;"),o.push("};"),o.push("struct Geometry {"),o.push("   vec3 position;"),o.push("   vec3 viewNormal;"),o.push("   vec3 worldNormal;"),o.push("   vec3 viewEyeDir;"),o.push("};"),o.push("struct Material {"),o.push("   vec3  diffuseColor;"),o.push("   float specularRoughness;"),o.push("   vec3  specularColor;"),o.push("   float shine;"),o.push("};"),o.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),o.push("   float r = ggxRoughness + 0.0001;"),o.push("   return (2.0 / (r * r) - 2.0);"),o.push("}"),o.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),o.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),o.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),o.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),o.push("}"),r.reflectionMaps.length>0&&(o.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),o.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),o.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),o.push("  return envMapColor;"),o.push("}")),o.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),o.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),o.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),o.push("}"),o.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),o.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),o.push("   return 1.0 / ( gl * gv );"),o.push("}"),o.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),o.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),o.push("   return 0.5 / max( gv + gl, EPSILON );"),o.push("}"),o.push("float D_GGX(const in float alpha, const in float dotNH) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),o.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),o.push("}"),o.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),o.push("   float alpha = ( roughness * roughness );"),o.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),o.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),o.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),o.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),o.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),o.push("   vec3  F = F_Schlick( specularColor, dotLH );"),o.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),o.push("   float D = D_GGX( alpha, dotNH );"),o.push("   return F * (G * D);"),o.push("}"),o.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),o.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),o.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),o.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),o.push("   vec4 r = roughness * c0 + c1;"),o.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),o.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),o.push("   return specularColor * AB.x + AB.y;"),o.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(o.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(o.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),o.push("   irradiance *= PI;"),o.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),o.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(o.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),o.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),o.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),o.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),o.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),o.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),o.push("}")),o.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),o.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),o.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),o.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),o.push("}"),o.push("out vec4 outColor;"),o.push("void main(void) {"),n){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(var h=0,d=i.getNumAllocatedSectionPlanes();h<d;h++)o.push("if (sectionPlaneActive"+h+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),o.push("}");s?(o.push("  if (dist > (0.002 * vClipPosition.w)) {"),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&o.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("  return;"),o.push("}")):(o.push("  if (dist > 0.0) { "),o.push("      discard;"),o.push("  }")),o.push("}")}o.push("IncidentLight  light;"),o.push("Material       material;"),o.push("Geometry       geometry;"),o.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),o.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),o.push("float opacity = float(vColor.a) / 255.0;"),o.push("vec3  baseColor = rgb;"),o.push("float specularF0 = 1.0;"),o.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),o.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),o.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),o.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),o.push("baseColor *= colorTexel.rgb;"),o.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),o.push("metallic *= metalRoughTexel.b;"),o.push("roughness *= metalRoughTexel.g;"),o.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),o.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),o.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),o.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),o.push("geometry.position      = vViewPosition.xyz;"),o.push("geometry.viewNormal    = -normalize(viewNormal);"),o.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&o.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&o.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var p=0,f=r.lights.length;p<f;p++){var v=r.lights[p];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?o.push("light.direction =  normalize(lightDir"+p+");"):o.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?o.push("light.direction =  normalize(lightPos"+p+" - vViewPosition.xyz);"):o.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+p+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?o.push("light.direction =  normalize(lightDir"+p+");"):o.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);")}o.push("light.color =  lightColor"+p+".rgb * lightColor"+p+".a;"),o.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return o.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),o.push("float aoFactor = texture(uAOMap, vUV).r;"),o.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),o.push("vec4 fragColor;"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):o.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&o.push("fragColor = linearToGamma(fragColor, gammaFactor);"),o.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}]),i}(),Zs=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick flat normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching pick flat normals fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("in vec4 vWorldPosition;"),i){r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("out highp ivec4 outNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),r.push("}"),r}}]),i}(),Js=function(e){m(i,Ss);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching color texture vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._lightsState,r=e._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=this._useAlphaCutoff,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching color texture fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),o.push("uniform sampler2D uColorMap;"),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),o.push("uniform float gammaFactor;"),o.push("vec4 linearToLinear( in vec4 value ) {"),o.push("  return value;"),o.push("}"),o.push("vec4 sRGBToLinear( in vec4 value ) {"),o.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),o.push("}"),o.push("vec4 gammaToLinear( in vec4 value) {"),o.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),o.push("}"),t&&(o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),n){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(var a=0,l=r.getNumAllocatedSectionPlanes();a<l;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;");for(var u=0,A=i.lights.length;u<A;u++){var c=i.lights[u];"ambient"!==c.type&&(o.push("uniform vec4 lightColor"+u+";"),"dir"===c.type&&o.push("uniform vec3 lightDir"+u+";"),"point"===c.type&&o.push("uniform vec3 lightPos"+u+";"),"spot"===c.type&&(o.push("uniform vec3 lightPos"+u+";"),o.push("uniform vec3 lightDir"+u+";")))}if(s&&o.push("uniform float materialAlphaCutoff;"),o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("in vec2 vUV;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),n){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(var h=0,d=r.getNumAllocatedSectionPlanes();h<d;h++)o.push("if (sectionPlaneActive"+h+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(var p=0,f=i.lights.length;p<f;p++){var v=i.lights[p];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?o.push("viewLightDir = normalize(lightDir"+p+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?o.push("viewLightDir = -normalize(lightPos"+p+" - vViewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+p+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?o.push("viewLightDir = normalize(lightDir"+p+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+p+".rgb * lightColor"+p+".a);")}}return o.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),o.push("vec4 sampleColor = texture(uColorMap, vUV);"),s&&(o.push("if (sampleColor.a < materialAlphaCutoff) {"),o.push("   discard;"),o.push("}")),t&&o.push("sampleColor = sRGBToLinear(sampleColor);"),o.push("vec4 colorTexel = color * sampleColor;"),o.push("float opacity = color.a;"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):o.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&o.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}]),i}(),Ys=le.vec3(),qs=le.vec3(),$s=le.vec3(),eo=le.vec3(),to=le.mat4(),io=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=Ys;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=qs;if(l){var g=$s;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,to),(p=eo)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),o.drawElements(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind(),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),ro=le.vec3(),no=le.vec3(),so=le.vec3(),oo=le.vec3(),ao=le.mat4(),lo=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=ro;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=no;if(l){var g=so;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,ao),(p=oo)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?a.edgeIndicesBuf&&(a.edgeIndicesBuf.bind(),o.drawElements(o.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0),a.edgeIndicesBuf.unbind()):o.drawArrays(o.POINTS,0,a.positionsBuf.numItems),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;var i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),uo=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"eagerCreateRenders",value:function(){this._silhouetteRenderer||(this._silhouetteRenderer=new Ls(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Qs(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Hs(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new io(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new lo(this._scene))}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Rs(this._scene,!1)),this._colorRenderer}},{key:"colorRendererWithSAO",get:function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Rs(this._scene,!0)),this._colorRendererWithSAO}},{key:"flatColorRenderer",get:function(){return this._flatColorRenderer||(this._flatColorRenderer=new Us(this._scene,!1)),this._flatColorRenderer}},{key:"flatColorRendererWithSAO",get:function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Us(this._scene,!0)),this._flatColorRendererWithSAO}},{key:"colorTextureRenderer",get:function(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Js(this._scene,!1)),this._colorTextureRenderer}},{key:"colorTextureRendererWithSAO",get:function(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Js(this._scene,!0)),this._colorTextureRendererWithSAO}},{key:"colorTextureRendererAlphaCutoff",get:function(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new Js(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}},{key:"colorTextureRendererWithSAOAlphaCutoff",get:function(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new Js(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}},{key:"pbrRenderer",get:function(){return this._pbrRenderer||(this._pbrRenderer=new Ks(this._scene,!1)),this._pbrRenderer}},{key:"pbrRendererWithSAO",get:function(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Ks(this._scene,!0)),this._pbrRendererWithSAO}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ls(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new zs(this._scene)),this._depthRenderer}},{key:"normalsRenderer",get:function(){return this._normalsRenderer||(this._normalsRenderer=new Ws(this._scene)),this._normalsRenderer}},{key:"edgesRenderer",get:function(){return this._edgesRenderer||(this._edgesRenderer=new Ns(this._scene)),this._edgesRenderer}},{key:"edgesColorRenderer",get:function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Vs(this._scene)),this._edgesColorRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Qs(this._scene)),this._pickMeshRenderer}},{key:"pickNormalsRenderer",get:function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Gs(this._scene)),this._pickNormalsRenderer}},{key:"pickNormalsFlatRenderer",get:function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Zs(this._scene)),this._pickNormalsFlatRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Hs(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new js(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new Xs(this._scene)),this._shadowRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new lo(this._scene)),this._snapRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new io(this._scene)),this._snapInitRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),Ao={};var co=65536,ho=5e6,po=function(){function e(){k(this,e)}return I(e,[{key:"doublePrecisionEnabled",get:function(){return le.getDoublePrecisionEnabled()},set:function(e){le.setDoublePrecisionEnabled(e)}},{key:"maxDataTextureHeight",get:function(){return co},set:function(e){(e=1024*Math.ceil(e/1024))>4096?e=4096:e<1024&&(e=1024),co=e}},{key:"maxGeometryBatchSize",get:function(){return ho},set:function(e){e<1e5?e=1e5:e>5e6&&(e=5e6),ho=e}}]),e}(),fo=new po,vo=I((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fo.maxGeometryBatchSize;k(this,e),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.offsets=[],this.indices=[],this.edgeIndices=[]})),go=le.mat4(),mo=le.mat4();function _o(e,t,i){for(var r=e.length,n=new Uint16Array(r),s=t[0],o=t[1],a=t[2],l=t[3]-s,u=t[4]-o,A=t[5]-a,c=65525,h=c/l,d=c/u,p=c/A,f=function(e){return e>=0?e:0},v=0;v<r;v+=3)n[v+0]=Math.floor(f(e[v+0]-s)*h),n[v+1]=Math.floor(f(e[v+1]-o)*d),n[v+2]=Math.floor(f(e[v+2]-a)*p);return le.identityMat4(go),le.translationMat4v(t,go),le.identityMat4(mo),le.scalingMat4v([l/c,u/c,A/c],mo),le.mulMat4(go,mo,i),n}function yo(e,t){var i=e[0],r=e[1],n=e[2],s=e[3]-i,o=e[4]-r,a=e[5]-n,l=65525;return le.identityMat4(go),le.translationMat4v(e,go),le.identityMat4(mo),le.scalingMat4v([s/l,o/l,a/l],mo),le.mulMat4(go,mo,t),t}function bo(e,t,i){var r=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),n=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){var s,o;s=(1-Math.abs(n))*(r>=0?1:-1),o=(1-Math.abs(r))*(n>=0?1:-1),r=s,n=o}return new Int8Array([Math[t](127.5*r+(r<0?-1:0)),Math[i](127.5*n+(n<0?-1:0))])}function wo(e){var t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;var r=1-Math.abs(t)-Math.abs(i);r<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));var n=Math.sqrt(t*t+i*i+r*r);return[t/n,i/n,r/n]}var Bo=le.mat4(),xo=le.mat4(),Po=le.vec4([0,0,0,1]),Co=le.vec3(),Mo=le.vec3(),Fo=le.vec3(),ko=le.vec3(),Eo=le.vec3(),Io=le.vec3(),To=le.vec3(),Do=function(){function e(t){k(this,e),this.model=t.model,this.sortId="TrianglesBatchingLayer"+(t.solid?"-solid":"-surface")+(t.autoNormals?"-autonormals":"-normals")+(t.textureSet&&t.textureSet.colorTexture?"-colorTexture":"")+(t.textureSet&&t.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=t.layerIndex,this._renderers=function(e){var t=e.id,i=Ao[t];return i||(i=new uo(e),Ao[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(function(){i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(function(){delete Ao[t],i._destroy()}))),i}(t.model.scene),this._buffer=new vo(t.maxGeometryBatchSize),this._scratchMemory=t.scratchMemory,this._state=new nt({origin:le.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,textureSet:t.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=le.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,t.positionsDecodeMatrix&&(this._state.positionsDecodeMatrix=le.mat4(t.positionsDecodeMatrix)),t.uvDecodeMatrix?(this._state.uvDecodeMatrix=le.mat3(t.uvDecodeMatrix),this._preCompressedUVsExpected=!0):this._preCompressedUVsExpected=!1,t.origin&&this._state.origin.set(t.origin),this.solid=!!t.solid,this.primitive=t.primitive}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"canCreatePortion",value:function(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}},{key:"createPortion",value:function(e,t){if(this._finalized)throw"Already finalized";var i,r=t.positions,n=t.positionsCompressed,s=t.normals,o=t.normalsCompressed,a=t.uv,l=t.uvCompressed,u=t.colors,A=t.colorsCompressed,c=t.indices,h=t.edgeIndices,d=t.color,p=t.metallic,f=t.roughness,v=t.opacity,g=t.meshMatrix,m=t.pickColor,_=this.model.scene,y=this._buffer,b=y.positions.length/3;if(le.expandAABB3(this._modelAABB,t.aabb),this._state.positionsDecodeMatrix){if(!n)throw"positionsCompressed expected";i=n.length/3;for(var w=0,B=n.length;w<B;w++)y.positions.push(n[w])}else{if(!r)throw"positions expected";i=r.length/3;for(var x=0,P=r.length;x<P;x++)y.positions.push(r[x])}if(o&&o.length>0)for(var C=0,M=o.length;C<M;C++)y.normals.push(o[C]);else if(s&&s.length>0){var F=Bo;g?le.inverseMat4(le.transposeMat4(g,xo),F):le.identityMat4(F,F),function(e,t,i,r,n){function s(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var o,a,l,u,A,c=new Float32Array([0,0,0,0]),h=new Float32Array([0,0,0,0]);for(A=0;A<i;A+=3)c[0]=t[A],c[1]=t[A+1],c[2]=t[A+2],le.transformVec3(e,c,h),le.normalizeVec3(h,h),a=o=bo(h,"floor","floor"),l=u=s(h,wo(o)),(l=s(h,wo(o=bo(h,"ceil","floor"))))>u&&(a=o,u=l),(l=s(h,wo(o=bo(h,"floor","ceil"))))>u&&(a=o,u=l),(l=s(h,wo(o=bo(h,"ceil","ceil"))))>u&&(a=o,u=l),r[n+A+0]=a[0],r[n+A+1]=a[1],r[n+A+2]=0}(F,s,s.length,y.normals,y.normals.length)}if(u)for(var k=0,E=u.length;k<E;k+=3)y.colors.push(255*u[k]),y.colors.push(255*u[k+1]),y.colors.push(255*u[k+2]),y.colors.push(255);else if(A)for(var I=0,T=u.length;I<T;I+=3)y.colors.push(u[I]),y.colors.push(u[I+1]),y.colors.push(u[I+2]),y.colors.push(255);else if(d)for(var D=d[0],S=d[1],R=d[2],U=v,L=0;L<i;L++)y.colors.push(D),y.colors.push(S),y.colors.push(R),y.colors.push(U);for(var O=null!=p?p:0,N=null!=f?f:255,V=0;V<i;V++)y.metallicRoughness.push(O),y.metallicRoughness.push(N);if(a&&a.length>0)for(var Q=0,H=a.length;Q<H;Q++)y.uv.push(a[Q]);else if(l&&l.length>0)for(var G=0,j=l.length;G<j;G++)y.uv.push(l[G]);for(var z=0,W=c.length;z<W;z++)y.indices.push(b+c[z]);if(h)for(var X=0,K=h.length;X<K;X++)y.edgeIndices.push(b+h[X]);for(var Z=y.pickColors.length,J=Z,Y=Z+4*i;J<Y;J+=4)y.pickColors.push(m[0]),y.pickColors.push(m[1]),y.pickColors.push(m[2]),y.pickColors.push(m[3]);if(_.entityOffsetsEnabled)for(var q=0;q<i;q++)y.offsets.push(0),y.offsets.push(0),y.offsets.push(0);var $=this._portions.length,ee={vertsBaseIndex:b,numVerts:i,indicesBaseIndex:y.indices.length-c.length,numIndices:c.length};return _.readableGeometryEnabled&&(ee.indices=c,_.entityOffsetsEnabled&&(ee.offset=new Float32Array(3))),this._portions.push(ee),this._numPortions++,this.model.numPortions++,this._numVerts+=ee.numVerts,this._meshes.push(e),$}},{key:"finalize",value:function(){if(!this._finalized){var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){var r=this._state.positionsDecodeMatrix?new Uint16Array(i.positions):_o(i.positions,this._modelAABB,this._state.positionsDecodeMatrix=le.mat4());if(e.positionsBuf=new st(t,t.ARRAY_BUFFER,r,r.length,3,t.STATIC_DRAW),this.model.scene.readableGeometryEnabled)for(var n=0,s=this._portions.length;n<s;n++){var o=this._portions[n],a=3*o.vertsBaseIndex,l=a+3*o.numVerts;o.quantizedPositions=r.slice(a,l)}}if(i.normals.length>0){var u=new Int8Array(i.normals);e.normalsBuf=new st(t,t.ARRAY_BUFFER,u,i.normals.length,3,t.STATIC_DRAW,!0)}if(i.colors.length>0){var A=new Uint8Array(i.colors);e.colorsBuf=new st(t,t.ARRAY_BUFFER,A,i.colors.length,4,t.DYNAMIC_DRAW,!1)}if(i.uv.length>0)if(e.uvDecodeMatrix){e.uvBuf=new st(t,t.ARRAY_BUFFER,i.uv,i.uv.length,2,t.STATIC_DRAW,!1)}else{var c=ft.getUVBounds(i.uv),h=ft.compressUVs(i.uv,c.min,c.max),d=h.quantized;e.uvDecodeMatrix=le.mat3(h.decodeMatrix),e.uvBuf=new st(t,t.ARRAY_BUFFER,d,d.length,2,t.STATIC_DRAW,!1)}if(i.metallicRoughness.length>0){var p=new Uint8Array(i.metallicRoughness);e.metallicRoughnessBuf=new st(t,t.ARRAY_BUFFER,p,i.metallicRoughness.length,2,t.STATIC_DRAW,!1)}if(i.positions.length>0){var f=i.positions.length/3,v=new Float32Array(f);e.flagsBuf=new st(t,t.ARRAY_BUFFER,v,v.length,1,t.DYNAMIC_DRAW,!1)}if(i.pickColors.length>0){var g=new Uint8Array(i.pickColors);e.pickColorsBuf=new st(t,t.ARRAY_BUFFER,g,i.pickColors.length,4,t.STATIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var m=new Float32Array(i.offsets);e.offsetsBuf=new st(t,t.ARRAY_BUFFER,m,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){var _=new Uint32Array(i.indices);e.indicesBuf=new st(t,t.ELEMENT_ARRAY_BUFFER,_,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){var y=new Uint32Array(i.edgeIndices);e.edgeIndicesBuf=new st(t,t.ELEMENT_ARRAY_BUFFER,y,i.edgeIndices.length,1,t.STATIC_DRAW)}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&e.textureSet&&e.textureSet.colorTexture&&e.textureSet.metallicRoughnessTexture),this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}}},{key:"isEmpty",value:function(){return!this._state.indicesBuf}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,!0)}},{key:"flushInitFlags",value:function(){this._setDeferredFlags()}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=e,r=this._portions[i],n=4*r.vertsBaseIndex,s=4*r.numVerts,o=this._scratchMemory.getUInt8Array(s),a=t[0],l=t[1],u=t[2],A=t[3],c=0;c<s;c+=4)o[c+0]=a,o[c+1]=l,o[c+2]=u,o[c+3]=A;this._state.colorsBuf&&this._state.colorsBuf.setData(o,n,s)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this._finalized)throw"Not finalized";var n,s,o=e,a=this._portions[o],l=a.vertsBaseIndex,u=a.numVerts,A=l,c=u,h=!!(t&gs),d=!!(t&ws),p=!!(t&Bs),f=!!(t&xs),v=!!(t&Ps),g=!!(t&_s),m=!!(t&ms);n=!h||m||d||p&&!this.model.scene.highlightMaterial.glowThrough||f&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,s=!h||m?Cs.NOT_RENDERED:f?Cs.SILHOUETTE_SELECTED:p?Cs.SILHOUETTE_HIGHLIGHTED:d?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED;var _=0;_=!h||m?Cs.NOT_RENDERED:f?Cs.EDGES_SELECTED:p?Cs.EDGES_HIGHLIGHTED:d?Cs.EDGES_XRAYED:v?i?Cs.EDGES_COLOR_TRANSPARENT:Cs.EDGES_COLOR_OPAQUE:Cs.NOT_RENDERED;var y=h&&!m&&g?Cs.PICK:Cs.NOT_RENDERED,b=t&ys?1:0;if(r){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(var w=A,B=A+c;w<B;w++){var x=0;x|=n,x|=s<<4,x|=_<<8,x|=y<<12,x|=b<<16,this._deferredFlagValues[w]=x}}else if(this._state.flagsBuf){for(var P=this._scratchMemory.getFloat32Array(c),C=0;C<c;C++){var M=0;M|=n,M|=s<<4,M|=_<<8,M|=y<<12,M|=b<<16,P[C]=M}this._state.flagsBuf.setData(P,A,c)}}},{key:"_setDeferredFlags",value:function(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=e,r=this._portions[i],n=3*r.vertsBaseIndex,s=3*r.numVerts,o=this._scratchMemory.getFloat32Array(s),a=t[0],l=t[1],u=t[2],A=0;A<s;A+=3)o[A+0]=a,o[A+1]=l,o[A+2]=u;this._state.offsetsBuf&&this._state.offsetsBuf.setData(o,n,s),this.model.scene.readableGeometryEnabled&&(r.offset[0]=t[0],r.offset[1]=t[1],r.offset[2]=t[2])}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"getEachVertex",value:function(e,t){if(this.model.scene.readableGeometryEnabled){var i=this._state,r=this._portions[e];if(r){var n=r.quantizedPositions,s=this.model.matrix,o=le.vec4();o.set(i.origin,0),o[3]=1,le.mulMat4v4(s,o,o);for(var a=o[0],l=o[1],u=o[2],A=Po,c=i.positionsDecodeMatrix,h=0,d=n.length;h<d;h+=3)A[0]=n[h],A[1]=n[h+1],A[2]=n[h+2],A[3]=1,le.decompressPosition(A,c),A[3]=1,le.mulMat4v4(s,A,A),A[0]+=a,A[1]+=l,A[2]+=u,t(A)}else this.model.error("portion not found: "+e)}}},{key:"getEachIndex",value:function(e,t){if(this.model.scene.readableGeometryEnabled){var i=this._portions[e];if(i)for(var r=i.indices,n=0,s=r.length;n<s;n++)t(r[n]);else this.model.error("portion not found: "+e)}}},{key:"getElementsCountAndOffset",value:function(e){var t=null,i=null,r=this._portions[e];return r&&(t=r.numIndices,i=r.indicesBaseIndex),{count:t,offset:i}}},{key:"readGeometryData",value:function(e){if(!this._finalized)throw"Not finalized";var t=this._portions[e],i=this._state,r=this.model.matrix,n=i.positionsDecodeMatrix,s=le.vec4();s.set(i.origin,0),s[3]=1,le.mulMat4v4(r,s,s);var o=i.indicesBuf.getData(t.indicesBaseIndex,t.numIndices).map((function(e){return e-t.vertsBaseIndex})),a=le.mulMat4(r,n,new Array(16));a[12]+=s[0],a[13]+=s[1],a[14]+=s[2];var l=i.positionsBuf.getData(t.vertsBaseIndex,t.numVerts);return{indices:o,positions:le.transformPositions3(a,l,new Array(l.length))}}},{key:"drawColorOpaque",value:function(e,t){if(this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions){this._updateBackfaceCull(e,t);var i=this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}}},{key:"_updateBackfaceCull",value:function(e,t){if(true!==t.backfaces){var i=t.gl;i.disable(i.CULL_FACE),t.backfaces=true}}},{key:"drawColorTransparent",value:function(e,t){if(this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions)if(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported)this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT);else if(t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported){this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Cs.COLOR_TRANSPARENT):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}else this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED))}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED))}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED))}},{key:"drawEdgesColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_OPAQUE)}},{key:"drawEdgesColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_TRANSPARENT)}},{key:"drawEdgesHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_HIGHLIGHTED)}},{key:"drawEdgesSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_SELECTED)}},{key:"drawEdgesXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_XRAYED)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawShadow",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK))}},{key:"precisionRayPickSurface",value:function(e,t,i,r,n){if(!this.model.scene.readableGeometryEnabled)return!1;var s=this._state,o=this._portions[e];if(!o)return this.model.error("portion not found: "+e),!1;var a=o.quantizedPositions,l=o.indices,u=s.origin,A=o.offset,c=Co,h=Mo;c.set(u?le.subVec3(t,u,Fo):t),h.set(i),A&&le.subVec3(c,A),le.transformRay(this.model.worldNormalMatrix,c,h,c,h);for(var d=ko,p=Eo,f=Io,v=!1,g=0,m=To,_=0,y=l.length;_<y;_+=3){var b=3*l[_],w=3*l[_+1],B=3*l[_+2];if(d[0]=a[b],d[1]=a[b+1],d[2]=a[b+2],p[0]=a[w],p[1]=a[w+1],p[2]=a[w+2],f[0]=a[B],f[1]=a[B+1],f[2]=a[B+2],le.decompressPosition(d,s.positionsDecodeMatrix),le.decompressPosition(p,s.positionsDecodeMatrix),le.decompressPosition(f,s.positionsDecodeMatrix),le.rayTriangleIntersect(c,h,d,p,f,m)){le.transformPoint3(this.model.worldMatrix,m,m),A&&le.addVec3(m,A),u&&le.addVec3(m,u);var x=Math.abs(le.lenVec3(le.subVec3(m,t,[])));(!v||x>g)&&(g=x,r.set(m),n&&le.triangleNormal(d,p,f,n),v=!0)}}return v&&n&&(le.transformVec3(this.model.worldNormalMatrix,n,n),le.normalizeVec3(n)),v}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}]),e}(),So=function(e){m(i,Ds);var t=y(i);function i(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=n.edges,o=void 0!==s&&s,a=n.useAlphaCutoff,l=void 0!==a&&a;return k(this,i),t.call(this,e,r,{instancing:!0,edges:o,useAlphaCutoff:l})}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;this._edges?i.edgeIndicesBuf&&t.drawElementsInstanced(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0,i.numInstances):(t.drawElementsInstanced(t.TRIANGLES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),n&&r.drawElements++)}}]),i}(),Ro=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e,t,i,r=this._scene,n=r._sectionPlanesState,s=r._lightsState,o=n.getNumAllocatedSectionPlanes()>0,a=[];for(a.push("#version 300 es"),a.push("// Instancing geometry drawing vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec2 normal;"),a.push("in vec4 color;"),a.push("in float flags;"),r.entityOffsetsEnabled&&a.push("in vec3 offset;"),a.push("in vec4 modelMatrixCol0;"),a.push("in vec4 modelMatrixCol1;"),a.push("in vec4 modelMatrixCol2;"),a.push("in vec4 modelNormalMatrixCol0;"),a.push("in vec4 modelNormalMatrixCol1;"),a.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(a,!0),r.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("uniform vec4 lightAmbient;"),e=0,t=s.lights.length;e<t;e++)"ambient"!==(i=s.lights[e]).type&&(a.push("uniform vec4 lightColor"+e+";"),"dir"===i.type&&a.push("uniform vec3 lightDir"+e+";"),"point"===i.type&&a.push("uniform vec3 lightPos"+e+";"),"spot"===i.type&&(a.push("uniform vec3 lightPos"+e+";"),a.push("uniform vec3 lightDir"+e+";")));for(a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),o&&(a.push("out vec4 vWorldPosition;"),a.push("out float vFlags;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("int colorFlag = int(flags) & 0xF;"),a.push("if (colorFlag != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),r.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),a.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),e=0,t=s.lights.length;e<t;e++)if("ambient"!==(i=s.lights[e]).type){if("dir"===i.type)"view"===i.space?a.push("viewLightDir = normalize(lightDir"+e+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?a.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?a.push("viewLightDir = normalize(lightDir"+e+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),r.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),o&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags = flags;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Instancing geometry drawing fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";");r.push("uniform float sliceThickness;"),r.push("uniform vec4 sliceColor;")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec4 newColor;"),r.push("  newColor = vColor;"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > sliceThickness) { "),r.push("      discard;"),r.push("  }"),r.push("  if (dist > 0.0) { "),r.push("      newColor = sliceColor;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled?(r.push("    float dx = dFdx(vFragDepth);"),r.push("    float dy = dFdy(vFragDepth);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;")):(r.push("    float dx = dFdx(gl_FragCoord.z);"),r.push("    float dy = dFdy(gl_FragCoord.z);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor                = vec4(newColor.rgb * ambient, 1.0);")):r.push("    outColor           = newColor;"),r.push("}"),r}}]),i}(),Uo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=i._lightsState,s=r.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Instancing geometry flat-shading drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),i.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(var a=0,l=r.getNumAllocatedSectionPlanes();a<l;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;"),e=0,t=n.lights.length;e<t;e++){var u=n.lights[e];"ambient"!==u.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===u.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===u.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===u.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")))}if(o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),s){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(var A=0,c=r.getNumAllocatedSectionPlanes();A<c;A++)o.push("if (sectionPlaneActive"+A+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+A+".xyz, vWorldPosition.xyz - sectionPlanePos"+A+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}for(o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),e=0,t=n.lights.length;e<t;e++){var h=n.lights[e];if("ambient"!==h.type){if("dir"===h.type)"view"===h.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===h.type)"view"===h.space?o.push("viewLightDir = -normalize(lightPos"+e+" - vViewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==h.type)continue;"view"===h.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return o.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):o.push("    outColor           = fragColor;"),i.logarithmicDepthBufferEnabled?o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(o.push("    float dx = dFdx(gl_FragCoord.z);"),o.push("    float dy = dFdy(gl_FragCoord.z);"),o.push("    float diff = sqrt(dx*dx+dy*dy);"),o.push("    gl_FragDepth = gl_FragCoord.z + diff;")),o.push("}"),o}}]),i}(),Lo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 color;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Instancing fill fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";");r.push("uniform float sliceThickness;"),r.push("uniform vec4 sliceColor;")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec4 newColor;"),r.push("  newColor = vColor;"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > sliceThickness) { "),r.push("      discard;"),r.push("  }"),r.push("  if (dist > 0.0) { "),r.push("      newColor = sliceColor;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = newColor;"),r.push("}"),r}}]),i}(),Oo=function(e){m(i,So);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,{instancing:!0,edges:!0})}return I(i)}(),No=function(e){m(i,Oo);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesEmphasisRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// EdgesEmphasisRenderer fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vColor;"),r.push("}"),r}}]),i}(),Vo=function(e){m(i,Oo);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!1})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesColorRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// EdgesColorRenderer fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vColor;"),r.push("}"),r}}]),i}(),Qo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vPickColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vPickColor; "),r.push("}"),r}}]),i}(),Ho=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry depth fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    outColor = packDepth(zNormalizedDepth); "),r.push("}"),r}}]),i}(),Go=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec2 normal;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("in vec4 modelNormalMatrixCol0;"),i.push("in vec4 modelNormalMatrixCol1;"),i.push("in vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry normals fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vWorldNormal;"),r.push("out highp ivec4 outNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outNormal = ivec4(vWorldNormal * float(".concat(le.MAX_INT,"), 1.0);")),r.push("}"),r}}]),i}(),jo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesInstancingOcclusionRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesInstancingOcclusionRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}}]),i}(),zo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("precision highp float;"),s.push("precision highp int;"),i.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),n)for(s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");if(s.push("in vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),n){for(s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return i.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}}]),i}(),Wo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Instancing geometry depth drawing fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}}]),i}(),Xo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("bool visible = (colorFlag > 0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Instancing geometry depth drawing fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}}]),i}(),Ko={3e3:"linearToLinear",3001:"sRGBToLinear"},Zo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=e._lightsState,r=t.getNumAllocatedSectionPlanes()>0,n=t.clippingCaps,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry quality drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in vec2 metallicRoughness;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("in vec4 modelNormalMatrixCol0;"),s.push("in vec4 modelNormalMatrixCol1;"),s.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(s,!0),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),s.push("out vec4 vViewPosition;"),s.push("out vec3 vViewNormal;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&s.push("out vec3 vWorldNormal;"),r&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;"),n&&s.push("out vec4 vClipPosition;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),s.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),s.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),r&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;"),n&&s.push("vClipPosition = clipPos;")),s.push("vViewPosition = viewPosition;"),s.push("vViewNormal = viewNormal;"),s.push("vColor = color;"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&s.push("vWorldNormal = worldNormal.xyz;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,r=e._lightsState,n=i.getNumAllocatedSectionPlanes()>0,s=i.clippingCaps,o=[];o.push("#version 300 es"),o.push("// Instancing geometry quality drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),o.push("uniform sampler2D uColorMap;"),o.push("uniform sampler2D uMetallicRoughMap;"),o.push("uniform sampler2D uEmissiveMap;"),o.push("uniform sampler2D uNormalMap;"),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),r.reflectionMaps.length>0&&o.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&o.push("uniform samplerCube lightMap;"),o.push("uniform vec4 lightAmbient;");for(var a=0,l=r.lights.length;a<l;a++){var u=r.lights[a];"ambient"!==u.type&&(o.push("uniform vec4 lightColor"+a+";"),"dir"===u.type&&o.push("uniform vec3 lightDir"+a+";"),"point"===u.type&&o.push("uniform vec3 lightPos"+a+";"),"spot"===u.type&&(o.push("uniform vec3 lightPos"+a+";"),o.push("uniform vec3 lightDir"+a+";")))}if(o.push("uniform float gammaFactor;"),o.push("vec4 linearToLinear( in vec4 value ) {"),o.push("  return value;"),o.push("}"),o.push("vec4 sRGBToLinear( in vec4 value ) {"),o.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),o.push("}"),o.push("vec4 gammaToLinear( in vec4 value) {"),o.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),o.push("}"),t&&(o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),n){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),s&&o.push("in vec4 vClipPosition;");for(var A=0,c=i.getNumAllocatedSectionPlanes();A<c;A++)o.push("uniform bool sectionPlaneActive"+A+";"),o.push("uniform vec3 sectionPlanePos"+A+";"),o.push("uniform vec3 sectionPlaneDir"+A+";")}if(o.push("in vec4 vViewPosition;"),o.push("in vec3 vViewNormal;"),o.push("in vec4 vColor;"),o.push("in vec2 vUV;"),o.push("in vec2 vMetallicRoughness;"),r.lightMaps.length>0&&o.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(o,!0),o.push("#define PI 3.14159265359"),o.push("#define RECIPROCAL_PI 0.31830988618"),o.push("#define RECIPROCAL_PI2 0.15915494"),o.push("#define EPSILON 1e-6"),o.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),o.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),o.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),o.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),o.push("              return normalize(surf_norm );"),o.push("       }"),o.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),o.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),o.push("      vec2 st0 = dFdx( uv.st );"),o.push("      vec2 st1 = dFdy( uv.st );"),o.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),o.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),o.push("      vec3 N = normalize( surf_norm );"),o.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),o.push("      mat3 tsn = mat3( S, T, N );"),o.push("      return normalize( tsn * mapN );"),o.push("}"),o.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),o.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),o.push("}"),o.push("struct IncidentLight {"),o.push("   vec3 color;"),o.push("   vec3 direction;"),o.push("};"),o.push("struct ReflectedLight {"),o.push("   vec3 diffuse;"),o.push("   vec3 specular;"),o.push("};"),o.push("struct Geometry {"),o.push("   vec3 position;"),o.push("   vec3 viewNormal;"),o.push("   vec3 worldNormal;"),o.push("   vec3 viewEyeDir;"),o.push("};"),o.push("struct Material {"),o.push("   vec3    diffuseColor;"),o.push("   float   specularRoughness;"),o.push("   vec3    specularColor;"),o.push("   float   shine;"),o.push("};"),o.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),o.push("   float r = ggxRoughness + 0.0001;"),o.push("   return (2.0 / (r * r) - 2.0);"),o.push("}"),o.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),o.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),o.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),o.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),o.push("}"),r.reflectionMaps.length>0&&(o.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),o.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),o.push("   vec3 envMapColor = "+Ko[r.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),o.push("  return envMapColor;"),o.push("}")),o.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),o.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),o.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),o.push("}"),o.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),o.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),o.push("   return 1.0 / ( gl * gv );"),o.push("}"),o.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),o.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),o.push("   return 0.5 / max( gv + gl, EPSILON );"),o.push("}"),o.push("float D_GGX(const in float alpha, const in float dotNH) {"),o.push("   float a2 = ( alpha * alpha );"),o.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),o.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),o.push("}"),o.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),o.push("   float alpha = ( roughness * roughness );"),o.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),o.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),o.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),o.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),o.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),o.push("   vec3  F = F_Schlick( specularColor, dotLH );"),o.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),o.push("   float D = D_GGX( alpha, dotNH );"),o.push("   return F * (G * D);"),o.push("}"),o.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),o.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),o.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),o.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),o.push("   vec4 r = roughness * c0 + c1;"),o.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),o.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),o.push("   return specularColor * AB.x + AB.y;"),o.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(o.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(o.push("   vec3 irradiance = "+Ko[r.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),o.push("   irradiance *= PI;"),o.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),o.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(o.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),o.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),o.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),o.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),o.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),o.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),o.push("}")),o.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),o.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),o.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),o.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),o.push("}"),o.push("out vec4 outColor;"),o.push("void main(void) {"),n){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(var h=0,d=i.getNumAllocatedSectionPlanes();h<d;h++)o.push("if (sectionPlaneActive"+h+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),o.push("}");s?(o.push("  if (dist > (0.002 * vClipPosition.w)) {"),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&o.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("  return;"),o.push("}")):(o.push("  if (dist > 0.0) { "),o.push("      discard;"),o.push("  }")),o.push("}")}o.push("IncidentLight  light;"),o.push("Material       material;"),o.push("Geometry       geometry;"),o.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),o.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),o.push("float opacity = float(vColor.a) / 255.0;"),o.push("vec3  baseColor = rgb;"),o.push("float specularF0 = 1.0;"),o.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),o.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),o.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),o.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),o.push("baseColor *= colorTexel.rgb;"),o.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),o.push("metallic *= metalRoughTexel.b;"),o.push("roughness *= metalRoughTexel.g;"),o.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),o.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),o.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),o.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),o.push("geometry.position      = vViewPosition.xyz;"),o.push("geometry.viewNormal    = -normalize(viewNormal);"),o.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&o.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&o.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var p=0,f=r.lights.length;p<f;p++){var v=r.lights[p];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?o.push("light.direction = normalize(lightDir"+p+");"):o.push("light.direction = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?o.push("light.direction = normalize(lightPos"+p+" - vViewPosition.xyz);"):o.push("light.direction = normalize((viewMatrix * vec4(lightPos"+p+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?o.push("light.direction = normalize(lightDir"+p+");"):o.push("light.direction = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);")}o.push("light.color =  lightColor"+p+".rgb * lightColor"+p+".a;"),o.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return o.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),o.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),o.push("vec4 fragColor;"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):o.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&o.push("fragColor = linearToGamma(fragColor, gammaFactor);"),o.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}]),i}(),Jo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&i.push("out float vFlags;"),i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&i.push("vFlags = flags;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Batched geometry normals fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("in vec4 vWorldPosition;"),i){r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("out highp ivec4 outNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),r.push("}"),r}}]),i}(),Yo=function(e){m(i,So);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){var e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e.gammaOutput,i=e._lightsState,r=e._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=this._useAlphaCutoff,o=[];if(o.push("#version 300 es"),o.push("// Instancing geometry drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),o.push("uniform sampler2D uColorMap;"),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),o.push("uniform float gammaFactor;"),o.push("vec4 linearToLinear( in vec4 value ) {"),o.push("  return value;"),o.push("}"),o.push("vec4 sRGBToLinear( in vec4 value ) {"),o.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),o.push("}"),o.push("vec4 gammaToLinear( in vec4 value) {"),o.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),o.push("}"),t&&(o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),n){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(var a=0,l=r.getNumAllocatedSectionPlanes();a<l;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;");for(var u=0,A=i.lights.length;u<A;u++){var c=i.lights[u];"ambient"!==c.type&&(o.push("uniform vec4 lightColor"+u+";"),"dir"===c.type&&o.push("uniform vec3 lightDir"+u+";"),"point"===c.type&&o.push("uniform vec3 lightPos"+u+";"),"spot"===c.type&&(o.push("uniform vec3 lightPos"+u+";"),o.push("uniform vec3 lightDir"+u+";")))}if(s&&o.push("uniform float materialAlphaCutoff;"),o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("in vec2 vUV;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),n){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(var h=0,d=r.getNumAllocatedSectionPlanes();h<d;h++)o.push("if (sectionPlaneActive"+h+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(var p=0,f=i.lights.length;p<f;p++){var v=i.lights[p];if("ambient"!==v.type){if("dir"===v.type)"view"===v.space?o.push("viewLightDir = normalize(lightDir"+p+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);");else if("point"===v.type)"view"===v.space?o.push("viewLightDir = -normalize(lightPos"+p+" - vViewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+p+", 0.0)).xyz);");else{if("spot"!==v.type)continue;"view"===v.space?o.push("viewLightDir = normalize(lightDir"+p+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+p+".rgb * lightColor"+p+".a);")}}return o.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),o.push("vec4 sampleColor = texture(uColorMap, vUV);"),s&&(o.push("if (sampleColor.a < materialAlphaCutoff) {"),o.push("   discard;"),o.push("}")),t&&o.push("sampleColor = sRGBToLinear(sampleColor);"),o.push("vec4 colorTexel = color * sampleColor;"),o.push("float opacity = color.a;"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):o.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&o.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}]),i}(),qo=le.vec3(),$o=le.vec3(),ea=le.vec3(),ta=le.vec3(),ia=le.mat4(),ra=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.canvas.gl,o=n.camera,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?s.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=qo;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=$o;if(l){var g=le.transformPoint3(A,l,ea);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,ia),(p=ta)[0]=o.eye[0]-v[0],p[1]=o.eye[1]-v[1],p[2]=o.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;s.uniform3fv(this._uCameraEyeRtc,p),s.uniform2fv(this.uVectorA,e.snapVectorA),s.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),s.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),s.uniform3fv(this._uCoordinateScaler,f),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),s.bindBuffer(s.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),s.bufferData(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,s.DYNAMIC_DRAW),s.bindBufferBase(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),s.drawElementsInstanced(s.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind(),s.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),na=le.vec3(),sa=le.vec3(),oa=le.vec3(),aa=le.vec3(),la=le.mat4(),ua=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=na;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=sa;if(l){var g=le.transformPoint3(A,l,oa);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,la),(p=aa)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?a.edgeIndicesBuf&&(a.edgeIndicesBuf.bind(),o.drawElementsInstanced(o.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0,a.numInstances),a.edgeIndicesBuf.unbind()):o.drawArraysInstanced(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),Aa=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"eagerCreateRenders",value:function(){this._silhouetteRenderer||(this._silhouetteRenderer=new Lo(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Qo(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Ho(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new ra(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new ua(this._scene))}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Ro(this._scene,!1)),this._colorRenderer}},{key:"colorRendererWithSAO",get:function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Ro(this._scene,!0)),this._colorRendererWithSAO}},{key:"flatColorRenderer",get:function(){return this._flatColorRenderer||(this._flatColorRenderer=new Uo(this._scene,!1)),this._flatColorRenderer}},{key:"flatColorRendererWithSAO",get:function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Uo(this._scene,!0)),this._flatColorRendererWithSAO}},{key:"colorTextureRenderer",get:function(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Yo(this._scene,!1)),this._colorTextureRenderer}},{key:"colorTextureRendererWithSAO",get:function(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Yo(this._scene,!0)),this._colorTextureRendererWithSAO}},{key:"colorTextureRendererAlphaCutoff",get:function(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new Yo(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}},{key:"colorTextureRendererWithSAOAlphaCutoff",get:function(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new Yo(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}},{key:"pbrRenderer",get:function(){return this._pbrRenderer||(this._pbrRenderer=new Zo(this._scene,!1)),this._pbrRenderer}},{key:"pbrRendererWithSAO",get:function(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Zo(this._scene,!0)),this._pbrRendererWithSAO}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Lo(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new zo(this._scene)),this._depthRenderer}},{key:"normalsRenderer",get:function(){return this._normalsRenderer||(this._normalsRenderer=new Wo(this._scene)),this._normalsRenderer}},{key:"edgesRenderer",get:function(){return this._edgesRenderer||(this._edgesRenderer=new No(this._scene)),this._edgesRenderer}},{key:"edgesColorRenderer",get:function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Vo(this._scene)),this._edgesColorRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Qo(this._scene)),this._pickMeshRenderer}},{key:"pickNormalsRenderer",get:function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Go(this._scene)),this._pickNormalsRenderer}},{key:"pickNormalsFlatRenderer",get:function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Jo(this._scene)),this._pickNormalsFlatRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ho(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new jo(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new Xo(this._scene)),this._shadowRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new ua(this._scene)),this._snapRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new ra(this._scene)),this._snapInitRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),ca={};var ha=new Uint8Array(4),da=new Float32Array(1),pa=le.vec4([0,0,0,1]),fa=new Float32Array(3),va=le.vec3(),ga=le.vec3(),ma=le.vec3(),_a=le.vec3(),ya=le.vec3(),ba=le.vec3(),wa=le.vec3(),Ba=new Float32Array(4),xa=function(){function e(t){k(this,e),this.model=t.model,this.sortId="TrianglesInstancingLayer"+(t.solid?"-solid":"-surface")+(t.normals?"-normals":"-autoNormals"),this.layerIndex=t.layerIndex,this._renderers=function(e){var t=e.id,i=ca[t];return i||(i=new Aa(e),ca[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(function(){i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(function(){delete ca[t],i._destroy()}))),i}(t.model.scene),this._aabb=le.collapseAABB3(),this._state=new nt({numInstances:0,obb:le.OBB3(),origin:le.vec3(),geometry:t.geometry,textureSet:t.textureSet,pbrSupported:!1,positionsDecodeMatrix:t.geometry.positionsDecodeMatrix,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,modelNormalMatrixCol0Buf:null,modelNormalMatrixCol1Buf:null,modelNormalMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=t.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrix=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,t.origin&&this._state.origin.set(t.origin),this._finalized=!1,this.solid=!!t.solid,this.numIndices=t.geometry.numIndices,this.primitive=t.geometry.primitive}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"createPortion",value:function(e,t){var i=t.color,r=t.metallic,n=t.roughness,s=null!==t.opacity&&void 0!==t.opacity?t.opacity:255,o=t.meshMatrix,a=t.pickColor;if(this._finalized)throw"Already finalized";var l=i[0],u=i[1],A=i[2];if(this._colors.push(l),this._colors.push(u),this._colors.push(A),this._colors.push(s),this._metallicRoughness.push(null!=r?r:0),this._metallicRoughness.push(null!=n?n:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.geometry.normals){var c=le.transposeMat4(o,le.mat4()),h=le.inverseMat4(c);this._modelNormalMatrixCol0.push(h[0]),this._modelNormalMatrixCol0.push(h[4]),this._modelNormalMatrixCol0.push(h[8]),this._modelNormalMatrixCol0.push(h[12]),this._modelNormalMatrixCol1.push(h[1]),this._modelNormalMatrixCol1.push(h[5]),this._modelNormalMatrixCol1.push(h[9]),this._modelNormalMatrixCol1.push(h[13]),this._modelNormalMatrixCol2.push(h[2]),this._modelNormalMatrixCol2.push(h[6]),this._modelNormalMatrixCol2.push(h[10]),this._modelNormalMatrixCol2.push(h[14])}this._pickColors.push(a[0]),this._pickColors.push(a[1]),this._pickColors.push(a[2]),this._pickColors.push(a[3]),this._state.numInstances++;var d=this._portions.length,p={};return this.model.scene.readableGeometryEnabled&&(p.matrix=o.slice(),p.inverseMatrix=null,p.normalMatrix=null),this._portions.push(p),this._numPortions++,this.model.numPortions++,this._meshes.push(e),d}},{key:"finalize",value:function(){if(!this._finalized){var e=this._state,t=e.geometry,i=e.textureSet,r=this.model.scene.canvas.gl,n=this._colors.length,s=n/4;if(n>0){e.colorsBuf=new st(r,r.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,r.DYNAMIC_DRAW,!1),this._colors=[]}if(this._metallicRoughness.length>0){var o=new Uint8Array(this._metallicRoughness);e.metallicRoughnessBuf=new st(r,r.ARRAY_BUFFER,o,this._metallicRoughness.length,2,r.STATIC_DRAW,!1)}if(s>0){e.flagsBuf=new st(r,r.ARRAY_BUFFER,new Float32Array(s),s,1,r.DYNAMIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){e.offsetsBuf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,r.DYNAMIC_DRAW,!1),this._offsets=[]}if(t.positionsCompressed&&t.positionsCompressed.length>0){e.positionsBuf=new st(r,r.ARRAY_BUFFER,t.positionsCompressed,t.positionsCompressed.length,3,r.STATIC_DRAW,!1),e.positionsDecodeMatrix=le.mat4(t.positionsDecodeMatrix)}if(t.colorsCompressed&&t.colorsCompressed.length>0){var a=new Uint8Array(t.colorsCompressed);e.colorsBuf=new st(r,r.ARRAY_BUFFER,a,a.length,4,r.STATIC_DRAW,!1)}if(t.uvCompressed&&t.uvCompressed.length>0){var l=t.uvCompressed;e.uvDecodeMatrix=t.uvDecodeMatrix,e.uvBuf=new st(r,r.ARRAY_BUFFER,l,l.length,2,r.STATIC_DRAW,!1)}if(t.indices&&t.indices.length>0&&(e.indicesBuf=new st(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.indices),t.indices.length,1,r.STATIC_DRAW),e.numIndices=t.indices.length),t.edgeIndices&&t.edgeIndices.length>0&&(e.edgeIndicesBuf=new st(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.edgeIndices),t.edgeIndices.length,1,r.STATIC_DRAW)),this._modelMatrixCol0.length>0){var u=!1;e.modelMatrixCol0Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,r.STATIC_DRAW,u),e.modelMatrixCol1Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,r.STATIC_DRAW,u),e.modelMatrixCol2Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,r.STATIC_DRAW,u),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],e.normalsBuf&&(e.modelNormalMatrixCol0Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,r.STATIC_DRAW,u),e.modelNormalMatrixCol1Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,r.STATIC_DRAW,u),e.modelNormalMatrixCol2Buf=new st(r,r.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,r.STATIC_DRAW,u),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){e.pickColorsBuf=new st(r,r.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,r.STATIC_DRAW,!1),this._pickColors=[]}e.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&i&&i.colorTexture&&i.metallicRoughnessTexture),e.colorTextureSupported=!!e.uvBuf&&!!i&&!!i.colorTexture,this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";ha[0]=t[0],ha[1]=t[1],ha[2]=t[2],ha[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(ha,4*e)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r=!!(t&gs),n=!!(t&ws),s=!!(t&Bs),o=!!(t&xs),a=!!(t&Ps),l=!!(t&_s),u=!!(t&ms),A=0;A|=!r||u||n||s&&!this.model.scene.highlightMaterial.glowThrough||o&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.SILHOUETTE_SELECTED:s?Cs.SILHOUETTE_HIGHLIGHTED:n?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED)<<4,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.EDGES_SELECTED:s?Cs.EDGES_HIGHLIGHTED:n?Cs.EDGES_XRAYED:a?i?Cs.EDGES_COLOR_TRANSPARENT:Cs.EDGES_COLOR_OPAQUE:Cs.NOT_RENDERED)<<8,A|=(r&&!u&&l?Cs.PICK:Cs.NOT_RENDERED)<<12,A|=(t&ys?1:0)<<16,da[0]=A,this._state.flagsBuf&&this._state.flagsBuf.setData(da,e)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(fa[0]=t[0],fa[1]=t[1],fa[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(fa,3*e)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"getEachVertex",value:function(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;var i=this._state,r=i.geometry,n=this._portions[e];if(n){var s=r.positionsCompressed,o=this.model.matrix,a=le.vec4();a.set(i.origin,0),a[3]=1,le.mulMat4v4(o,a,a);for(var l=a[0],u=a[1],A=a[2],c=pa,h=n.matrix,d=i.positionsDecodeMatrix,p=0,f=s.length;p<f;p+=3)c[0]=s[p],c[1]=s[p+1],c[2]=s[p+2],le.decompressPosition(c,d),le.transformPoint3(h,c,c),c[3]=1,le.mulMat4v4(o,c,c),c[0]+=l,c[1]+=u,c[2]+=A,t(c)}else this.model.error("portion not found: "+e)}},{key:"getEachIndex",value:function(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;var i=this._state.geometry;if(this._portions[e])for(var r=i.indices,n=0,s=r.length;n<s;n++)t(r[n]);else this.model.error("portion not found: "+e)}},{key:"setMatrix",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=4*e;Ba[0]=t[0],Ba[1]=t[4],Ba[2]=t[8],Ba[3]=t[12],this._state.modelMatrixCol0Buf.setData(Ba,i),Ba[0]=t[1],Ba[1]=t[5],Ba[2]=t[9],Ba[3]=t[13],this._state.modelMatrixCol1Buf.setData(Ba,i),Ba[0]=t[2],Ba[1]=t[6],Ba[2]=t[10],Ba[3]=t[14],this._state.modelMatrixCol2Buf.setData(Ba,i)}},{key:"readGeometryData",value:function(e){if(!this._finalized)throw"Not finalized";var t=this._state,i=this.model.matrix,r=t.modelMatrixCol0Buf.getData(e,1),n=t.modelMatrixCol1Buf.getData(e,1),s=t.modelMatrixCol2Buf.getData(e,1),o=[r[0],n[0],s[0],0,r[1],n[1],s[1],0,r[2],n[2],s[2],0,r[3],n[3],s[3],1],a=t.positionsDecodeMatrix,l=le.vec4();l.set(t.origin,0),l[3]=1,le.mulMat4v4(i,l,l);var u=t.indicesBuf.getData(),A=le.mulMat4(o,a,new Array(16));le.mulMat4(i,A,A),A[12]+=l[0],A[13]+=l[1],A[14]+=l[2];var c=t.positionsBuf.getData();return{indices:u,positions:le.transformPositions3(A,c,new Array(c.length))}}},{key:"drawColorOpaque",value:function(e,t){if(this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions){this._updateBackfaceCull(e,t);var i=this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}}},{key:"_updateBackfaceCull",value:function(e,t){if(true!==t.backfaces){var i=t.gl;i.disable(i.CULL_FACE),t.backfaces=true}}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT))}},{key:"drawDepth",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED))}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED))}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED))}},{key:"drawEdgesColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_OPAQUE)}},{key:"drawEdgesColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_TRANSPARENT)}},{key:"drawEdgesXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_XRAYED)}},{key:"drawEdgesHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_HIGHLIGHTED)}},{key:"drawEdgesSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_SELECTED)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawShadow",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK))}},{key:"precisionRayPickSurface",value:function(e,t,i,r,n){if(!this.model.scene.readableGeometryEnabled)return!1;var s=this._state.geometry,o=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;a.inverseMatrix||(a.inverseMatrix=le.inverseMat4(a.matrix,le.mat4())),n&&!a.normalMatrix&&(a.normalMatrix=le.transposeMat4(a.inverseMatrix,le.mat4()));var l=s.quantizedPositions,u=s.indices,A=o.origin,c=a.offset,h=va,d=ga;h.set(A?le.subVec3(t,A,ma):t),d.set(i),c&&le.subVec3(h,c),le.transformRay(this.model.worldNormalMatrix,h,d,h,d),le.transformRay(a.inverseMatrix,h,d,h,d);for(var p=_a,f=ya,v=ba,g=!1,m=0,_=wa,y=0,b=u.length;y<b;y+=3){var w=3*u[y+0],B=3*u[y+1],x=3*u[y+2];p[0]=l[w],p[1]=l[w+1],p[2]=l[w+2],f[0]=l[B],f[1]=l[B+1],f[2]=l[B+2],v[0]=l[x],v[1]=l[x+1],v[2]=l[x+2];var P=o.geometry.positionsDecodeMatrix;if(le.decompressPosition(p,P),le.decompressPosition(f,P),le.decompressPosition(v,P),le.rayTriangleIntersect(h,d,p,f,v,_)){le.transformPoint3(a.matrix,_,_),le.transformPoint3(this.model.worldMatrix,_,_),c&&le.addVec3(_,c),A&&le.addVec3(_,A);var C=Math.abs(le.lenVec3(le.subVec3(_,t,[])));(!g||C>m)&&(m=C,r.set(_),n&&le.triangleNormal(p,f,v,n),g=!0)}}return g&&n&&(le.transformVec3(a.normalMatrix,n,n),le.transformVec3(this.model.worldNormalMatrix,n,n),le.normalizeVec3(n)),g}},{key:"destroy",value:function(){var e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy(),this._state=null}}]),e}(),Pa=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;t.drawElements(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0),n&&r.drawElements++}}]),i}(),Ca=function(e){m(i,Pa);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Lines batching color fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}}]),i}(),Ma=function(e){m(i,Pa);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Lines batching silhouette fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = color;"),r.push("}"),r}}]),i}(),Fa=le.vec3(),ka=le.vec3(),Ea=le.vec3(),Ia=le.vec3(),Ta=le.mat4(),Da=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=Fa;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=ka;if(l){var g=Ea;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,Ta),(p=Ia)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),o.drawElements(o.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind(),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),Sa=le.vec3(),Ra=le.vec3(),Ua=le.vec3(),La=le.vec3(),Oa=le.mat4(),Na=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=Sa;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=Ra;if(l){var g=Ua;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,Oa),(p=La)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?(a.indicesBuf.bind(),o.drawElements(o.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind()):o.drawArrays(o.POINTS,0,a.positionsBuf.numItems),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;var i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),Va=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Ca(this._scene,!1)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ma(this._scene)),this._silhouetteRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new Da(this._scene,!1)),this._snapInitRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new Na(this._scene)),this._snapRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),Qa={};var Ha=I((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e6;k(this,e),t>5e6&&(t=5e6),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.offsets=[],this.indices=[]})),Ga=function(){function e(t){var i,r,n;k(this,e),this.layerIndex=t.layerIndex,this._renderers=(i=t.model.scene,r=i.id,(n=Qa[r])||(n=new Va(i),Qa[r]=n,n._compile(),i.on("compile",(function(){n._compile()})),i.on("destroyed",(function(){delete Qa[r],n._destroy()}))),n),this.model=t.model,this._buffer=new Ha(t.maxGeometryBatchSize),this._scratchMemory=t.scratchMemory,this._state=new nt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,indicesBuf:null,positionsDecodeMatrix:le.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=le.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,t.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(t.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,t.origin&&(this._state.origin=le.vec3(t.origin)),this.primitive=t.primitive}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"canCreatePortion",value:function(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}},{key:"createPortion",value:function(e,t){if(this._finalized)throw"Already finalized";var i,r=t.positions,n=t.positionsCompressed,s=t.indices,o=t.color,a=t.opacity,l=this._buffer,u=l.positions.length/3;if(le.expandAABB3(this._modelAABB,t.aabb),this._preCompressedPositionsExpected){if(!n)throw"positionsCompressed expected";i=n.length/3;for(var A=0,c=n.length;A<c;A++)l.positions.push(n[A])}else{if(!r)throw"positions expected";i=r.length/3;for(var h=0,d=r.length;h<d;h++)l.positions.push(r[h])}if(o)for(var p=o[0],f=o[1],v=o[2],g=a,m=0;m<i;m++)l.colors.push(p),l.colors.push(f),l.colors.push(v),l.colors.push(g);if(s)for(var _=0,y=s.length;_<y;_++)l.indices.push(s[_]+u);if(this.model.scene.entityOffsetsEnabled)for(var b=0;b<i;b++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);var w=this._portions.length/2;return this._portions.push(u),this._portions.push(i),this._numPortions++,this.model.numPortions++,this._numVerts+=i,this._meshes.push(e),w}},{key:"finalize",value:function(){if(!this._finalized){var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){var r=new Uint16Array(i.positions);e.positionsBuf=new st(t,t.ARRAY_BUFFER,r,i.positions.length,3,t.STATIC_DRAW)}else{var n=_o(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new st(t,t.ARRAY_BUFFER,n,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){var s=new Uint8Array(i.colors);e.colorsBuf=new st(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,!1)}if(i.colors.length>0){var o=i.colors.length/4,a=new Float32Array(o);e.flagsBuf=new st(t,t.ARRAY_BUFFER,a,a.length,1,t.DYNAMIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var l=new Float32Array(i.offsets);e.offsetsBuf=new st(t,t.ARRAY_BUFFER,l,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){var u=new Uint32Array(i.indices);e.indicesBuf=new st(t,t.ELEMENT_ARRAY_BUFFER,u,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,!0)}},{key:"flushInitFlags",value:function(){this._setDeferredFlags()}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],s=this._scratchMemory.getUInt8Array(n),o=t[0],a=t[1],l=t[2],u=t[3],A=0;A<n;A+=4)s[A+0]=o,s[A+1]=a,s[A+2]=l,s[A+3]=u;this._state.colorsBuf.setData(s,r,n)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this._finalized)throw"Not finalized";var n,s,o=2*e,a=this._portions[o],l=this._portions[o+1],u=a,A=l,c=!!(t&gs),h=!!(t&ws),d=!!(t&Bs),p=!!(t&xs),f=!!(t&_s),v=!!(t&ms);n=!c||v||h||d&&!this.model.scene.highlightMaterial.glowThrough||p&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,s=!c||v?Cs.NOT_RENDERED:p?Cs.SILHOUETTE_SELECTED:d?Cs.SILHOUETTE_HIGHLIGHTED:h?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED;var g=c&&!v&&f?Cs.PICK:Cs.NOT_RENDERED,m=t&ys?1:0;if(r){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(var _=u,y=u+A;_<y;_++){var b=0;b|=n,b|=s<<4,b|=g<<12,b|=m<<16,this._deferredFlagValues[_]=b}}else if(this._state.flagsBuf){for(var w=this._scratchMemory.getFloat32Array(A),B=0;B<A;B++){var x=0;x|=n,x|=s<<4,x|=g<<12,x|=m<<16,w[B]=x}this._state.flagsBuf.setData(w,u,A)}}},{key:"_setDeferredFlags",value:function(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*e,r=3*this._portions[i],n=3*this._portions[i+1],s=this._scratchMemory.getFloat32Array(n),o=t[0],a=t[1],l=t[2],u=0;u<n;u+=3)s[u+0]=o,s[u+1]=a,s[u+2]=l;this._state.offsetsBuf.setData(s,r,n)}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawPickMesh",value:function(e){}},{key:"drawPickDepths",value:function(e){}},{key:"drawPickNormals",value:function(e){}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawOcclusion",value:function(e){}},{key:"drawShadow",value:function(e){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}]),e}(),ja=function(e){m(i,Ds);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,{instancing:!0})}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;t.drawElementsInstanced(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),n&&r.drawElements++}}]),i}(),za=function(e){m(i,ja);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines instancing color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),n)for(s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),n){for(s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):s.push("    outColor           = vColor;"),i.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}]),i}(),Wa=function(e){m(i,ja);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 color;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Lines instancing silhouette fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("uniform vec4 color;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = color;"),r.push("}"),r}}]),i}(),Xa=le.vec3(),Ka=le.vec3(),Za=le.vec3();le.vec3();var Ja=le.mat4(),Ya=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.canvas.gl,o=n.camera,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?s.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p=Xa;if(p[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,p[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,p[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(p[0]),e.snapPickCoordinateScale[1]=le.safeInv(p[1]),e.snapPickCoordinateScale[2]=le.safeInv(p[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var f=Ka;if(l){var v=le.transformPoint3(A,l,Za);f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],d=Jt(h,f,Ja),e.snapPickOrigin[0]=f[0],e.snapPickOrigin[1]=f[1],e.snapPickOrigin[2]=f[2]}else d=h,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;s.uniform2fv(this.uVectorA,e.snapVectorA),s.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),s.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),s.uniform3fv(this._uCoordinateScaler,p),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var g=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),s.bindBuffer(s.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),s.bufferData(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,s.DYNAMIC_DRAW),s.bindBufferBase(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var m=2/(Math.log(e.pickZFar+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,m),this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),s.drawElementsInstanced(s.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind(),s.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),qa=le.vec3(),$a=le.vec3(),el=le.vec3();le.vec3();var tl=le.mat4(),il=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p=qa;if(p[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,p[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,p[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(p[0]),e.snapPickCoordinateScale[1]=le.safeInv(p[1]),e.snapPickCoordinateScale[2]=le.safeInv(p[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var f=$a;if(l){var v=le.transformPoint3(A,l,el);f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],d=Jt(h,f,tl),e.snapPickOrigin[0]=f[0],e.snapPickOrigin[1]=f[1],e.snapPickOrigin[2]=f[2]}else d=h,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,p),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var g=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,g+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var m=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,m),this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?(a.indicesBuf.bind(),o.drawElementsInstanced(o.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind()):o.drawArraysInstanced(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),rl=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"eagerCreateRenders",value:function(){this._snapInitRenderer||(this._snapInitRenderer=new Ya(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new il(this._scene))}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new za(this._scene)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Wa(this._scene)),this._silhouetteRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new Ya(this._scene,!1)),this._snapInitRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new il(this._scene)),this._snapRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),nl={};var sl=new Uint8Array(4),ol=new Float32Array(1),al=new Float32Array(3),ll=new Float32Array(4),ul=function(){function e(t){var i,r,n;k(this,e),this.model=t.model,this.material=t.material,this.sortId="LinesInstancingLayer",this.layerIndex=t.layerIndex,this._renderers=(i=t.model.scene,r=i.id,(n=nl[r])||(n=new rl(i),nl[r]=n,n._compile(),i.on("compile",(function(){n._compile()})),i.on("destroyed",(function(){delete nl[r],n._destroy()}))),n),this._aabb=le.collapseAABB3(),this._state=new nt({obb:le.OBB3(),numInstances:0,origin:null,geometry:t.geometry,positionsDecodeMatrix:t.geometry.positionsDecodeMatrix,positionsBuf:null,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=t.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,t.origin&&(this._state.origin=le.vec3(t.origin)),this._finalized=!1,this.primitive=t.primitive}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"createPortion",value:function(e,t){var i=t.color,r=t.opacity,n=t.meshMatrix;if(this._finalized)throw"Already finalized";var s=i[0],o=i[1],a=i[2];i[3],this._colors.push(s),this._colors.push(o),this._colors.push(a),this._colors.push(r),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(n[0]),this._modelMatrixCol0.push(n[4]),this._modelMatrixCol0.push(n[8]),this._modelMatrixCol0.push(n[12]),this._modelMatrixCol1.push(n[1]),this._modelMatrixCol1.push(n[5]),this._modelMatrixCol1.push(n[9]),this._modelMatrixCol1.push(n[13]),this._modelMatrixCol2.push(n[2]),this._modelMatrixCol2.push(n[6]),this._modelMatrixCol2.push(n[10]),this._modelMatrixCol2.push(n[14]),this._state.numInstances++;var l=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),l}},{key:"finalize",value:function(){if(this._finalized)throw"Already finalized";var e=this.model.scene.canvas.gl,t=this._state,i=t.geometry,r=this._colors.length,n=r/4;if(r>0){this._state.colorsBuf=new st(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,!1),this._colors=[]}if(n>0){this._state.flagsBuf=new st(e,e.ARRAY_BUFFER,new Float32Array(n),n,1,e.DYNAMIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]}if(i.colorsCompressed&&i.colorsCompressed.length>0){var s=new Uint8Array(i.colorsCompressed);t.colorsBuf=new st(e,e.ARRAY_BUFFER,s,s.length,4,e.STATIC_DRAW,!1)}if(i.positionsCompressed&&i.positionsCompressed.length>0){t.positionsBuf=new st(e,e.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,e.STATIC_DRAW,!1),t.positionsDecodeMatrix=le.mat4(i.positionsDecodeMatrix)}if(i.indices&&i.indices.length>0&&(t.indicesBuf=new st(e,e.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,e.STATIC_DRAW),t.numIndices=i.indices.length),this._modelMatrixCol0.length>0){var o=!1;this._state.modelMatrixCol0Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,o),this._state.modelMatrixCol1Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,o),this._state.modelMatrixCol2Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,o),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";sl[0]=t[0],sl[1]=t[1],sl[2]=t[2],sl[3]=t[3],this._state.colorsBuf.setData(sl,4*e,4)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r=!!(t&gs),n=!!(t&ws),s=!!(t&Bs),o=!!(t&xs),a=!!(t&Ps),l=!!(t&_s),u=!!(t&ms),A=0;A|=!r||u||n||s&&!this.model.scene.highlightMaterial.glowThrough||o&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.SILHOUETTE_SELECTED:s?Cs.SILHOUETTE_HIGHLIGHTED:n?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED)<<4,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.EDGES_SELECTED:s?Cs.EDGES_HIGHLIGHTED:n?Cs.EDGES_XRAYED:a?i?Cs.EDGES_COLOR_TRANSPARENT:Cs.EDGES_COLOR_OPAQUE:Cs.NOT_RENDERED)<<8,A|=(r&&!u&&l?Cs.PICK:Cs.NOT_RENDERED)<<12,A|=(t&ys?1:0)<<16,ol[0]=A,this._state.flagsBuf.setData(ol,e)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(al[0]=t[0],al[1]=t[1],al[2]=t[2],this._state.offsetsBuf.setData(al,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"setMatrix",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=4*e;ll[0]=t[0],ll[1]=t[4],ll[2]=t[8],ll[3]=t[12],this._state.modelMatrixCol0Buf.setData(ll,i),ll[0]=t[1],ll[1]=t[5],ll[2]=t[9],ll[3]=t[13],this._state.modelMatrixCol1Buf.setData(ll,i),ll[0]=t[2],ll[1]=t[6],ll[2]=t[10],ll[3]=t[14],this._state.modelMatrixCol2Buf.setData(ll,i)}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawOcclusion",value:function(e,t){}},{key:"drawShadow",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){}},{key:"drawPickDepths",value:function(e,t){}},{key:"drawPickNormals",value:function(e,t){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}]),e}(),Al=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;t.drawArrays(t.POINTS,0,i.positionsBuf.numItems),n&&r.drawArrays++}}]),i}(),cl=function(e){m(i,Al);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial,r=[];return r.push("#version 300 es"),r.push("// Points batching color vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),r.push("in vec4 color;"),r.push("in float flags;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vColor;"),r.push("void main(void) {"),r.push("int colorFlag = int(flags) & 0xF;"),r.push("if (colorFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points batching color fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}}]),i}(),hl=function(e){m(i,Al);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points batching silhouette vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),this._addMatricesUniformBlockLines(r),r.push("uniform vec4 color;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("void main(void) {"),r.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),r.push("if (silhouetteFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching silhouette vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),n)for(s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),n){for(s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return i.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}]),i}(),dl=function(e){m(i,Al);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points batching pick mesh vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("in vec4 pickColor;"),r.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(r),this._addRemapClipPosLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vPickColor;"),r.push("void main(void) {"),r.push("int pickFlag = int(flags) >> 12 & 0xF;"),r.push("if (pickFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points batching pick mesh vertex shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vPickColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   outColor = vPickColor; "),r.push("}"),r}}]),i}(),pl=function(e){m(i,Al);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points batched pick depth vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(r),this._addRemapClipPosLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vViewPosition;"),r.push("void main(void) {"),r.push("int pickFlag = int(flags) >> 12 & 0xF;"),r.push("if (pickFlag != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags = flags;")),r.push("vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points batched pick depth fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    outColor = packDepth(zNormalizedDepth); "),r.push("}"),r}}]),i}(),fl=function(e){m(i,Al);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points batching occlusion vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("void main(void) {"),r.push("int colorFlag = int(flags) & 0xF;"),r.push("if (colorFlag != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("  gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("  }"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points batching occlusion fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),r.push("}"),r}}]),i}(),vl=le.vec3(),gl=le.vec3(),ml=le.vec3(),_l=le.vec3(),yl=le.mat4(),bl=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=vl;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=gl;if(l){var g=ml;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,yl),(p=_l)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible),o.uniform1f(this._uPointSize,1);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),o.drawArrays(o.POINTS,0,a.positionsBuf.numItems),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler"),this._uPointSize=e.getLocation("pointSize")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float pointSize;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = pointSize;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),wl=le.vec3(),Bl=le.vec3(),xl=le.vec3(),Pl=le.vec3(),Cl=le.mat4(),Ml=function(e){m(i,Ds);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p,f=wl;if(f[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,f[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,f[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(f[0]),e.snapPickCoordinateScale[1]=le.safeInv(f[1]),e.snapPickCoordinateScale[2]=le.safeInv(f[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var v=Bl;if(l){var g=xl;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],d=Jt(h,v,Cl),(p=Pl)[0]=s.eye[0]-v[0],p[1]=s.eye[1]-v[1],p[2]=s.eye[2]-v[2],e.snapPickOrigin[0]=v[0],e.snapPickOrigin[1]=v[1],e.snapPickOrigin[2]=v[2]}else d=h,p=s.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,f),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var m=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,m+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var _=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,_),this.setSectionPlanesStateUniforms(t),o.drawArrays(o.POINTS,0,a.positionsBuf.numItems),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;var i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),Fl=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new cl(this._scene)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new hl(this._scene)),this._silhouetteRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new dl(this._scene)),this._pickMeshRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new pl(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new fl(this._scene)),this._occlusionRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new bl(this._scene,!1)),this._snapInitRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new Ml(this._scene)),this._snapRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),kl={};var El=function(){function e(t){k(this,e),this.model=t.model,this.sortId="PointsBatchingLayer",this.layerIndex=t.layerIndex,this._renderers=function(e){var t=e.id,i=kl[t];return i||(i=new Fl(e),kl[t]=i,i._compile(),e.on("compile",(function(){i._compile()})),e.on("destroyed",(function(){delete kl[t],i._destroy()}))),i}(t.model.scene);var i=t.maxGeometryBatchSize||5e6,r=function(){var e=[];return{append:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;e.push({data:t,times:i,denormalizeScale:r})},compileBuffer:function(t){var i=0;e.forEach((function(e){i+=e.times*e.data.length}));var r=new t(i),n=0;return e.forEach((function(e){var t=e.data,i=e.denormalizeScale,s=r.subarray(n);if(1===i)s.set(t,0);else for(var o=0;o<t.length;++o)s[o]=t[o]*i;for(var a=t.length,l=e.times*t.length;a<l;){var u=Math.min(a,l-a);s.set(s.subarray(0,u),a),a+=u}n+=a})),r}}};this._buffer={maxVerts:i,positions:r(),colors:r(),pickColors:r(),vertsIndex:0},this._scratchMemory=t.scratchMemory,this._state=new nt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,positionsDecodeMatrix:le.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=le.collapseAABB3(),this._portions=[],this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,t.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(t.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,t.origin&&(this._state.origin=le.vec3(t.origin))}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"canCreatePortion",value:function(e){if(this._finalized)throw"Already finalized";return this._buffer.vertsIndex+e/3<=this._buffer.maxVerts}},{key:"createPortion",value:function(e,t){if(this._finalized)throw"Already finalized";var i=this._buffer,r=this._preCompressedPositionsExpected?t.positionsCompressed:t.positions;if(!r)throw(this._preCompressedPositionsExpected?"positionsCompressed":"positions")+" expected";i.positions.append(r);var n=r.length/3,s=t.color,o=t.colorsCompressed,a=t.colors,l=t.pickColor;o?i.colors.append(o):a?i.colors.append(a,1,255):s&&i.colors.append([s[0],s[1],s[2],1],n),i.pickColors.append(l.slice(0,4),n),le.expandAABB3(this._modelAABB,t.aabb);var u=this._portions.length/2;return this._portions.push(this._buffer.vertsIndex),this._portions.push(n),this._buffer.vertsIndex+=n,this._numPortions++,this.model.numPortions++,this._meshes.push(e),u}},{key:"finalize",value:function(){if(!this._finalized){var e=this._state,t=this.model.scene.canvas.gl,i=this._buffer,r=function(e,i,r){return e.length>0?new st(t,t.ARRAY_BUFFER,e,e.length,i,r):null},n=this._preCompressedPositionsExpected?i.positions.compileBuffer(Uint16Array):_o(i.positions.compileBuffer(Float32Array),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=r(n,3,t.STATIC_DRAW),e.flagsBuf=r(new Float32Array(this._buffer.vertsIndex),1,t.DYNAMIC_DRAW),e.colorsBuf=r(i.colors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.pickColorsBuf=r(i.pickColors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.offsetsBuf=this.model.scene.entityOffsetsEnabled?r(new Float32Array(3*this._buffer.vertsIndex),3,t.DYNAMIC_DRAW):null,this._buffer=null,this._finalized=!0}}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized"}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,r=4*this._portions[i],n=4*this._portions[i+1],s=this._scratchMemory.getUInt8Array(n),o=t[0],a=t[1],l=t[2],u=0;u<n;u+=4)s[u+0]=o,s[u+1]=a,s[u+2]=l;this._state.colorsBuf.setData(s,r,n)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r,n,s=2*e,o=this._portions[s],a=this._portions[s+1],l=this._scratchMemory.getFloat32Array(a),u=!!(t&gs),A=!!(t&ws),c=!!(t&Bs),h=!!(t&xs),d=!!(t&_s),p=!!(t&ms);r=!u||p||A||c&&!this.model.scene.highlightMaterial.glowThrough||h&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,n=!u||p?Cs.NOT_RENDERED:h?Cs.SILHOUETTE_SELECTED:c?Cs.SILHOUETTE_HIGHLIGHTED:A?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED;for(var f=u&&!p&&d?Cs.PICK:Cs.NOT_RENDERED,v=t&ys?1:0,g=0;g<a;g++){var m=0;m|=r,m|=n<<4,m|=f<<12,m|=v<<16,l[g]=m}this._state.flagsBuf.setData(l,o)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*e,r=3*this._portions[i],n=3*this._portions[i+1],s=this._scratchMemory.getFloat32Array(n),o=t[0],a=t[1],l=t[2],u=0;u<n;u+=3)s[u+0]=o,s[u+1]=a,s[u+2]=l;this._state.offsetsBuf.setData(s,r,n)}else this.model.error("Entity#offset not enabled for this Viewer")}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawPickNormals",value:function(e,t){}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawShadow",value:function(e,t){}},{key:"destroy",value:function(){var e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}]),e}(),Il=function(e){m(i,Ds);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,{instancing:!0})}return I(i,[{key:"_draw",value:function(e){var t=this._scene.canvas.gl,i=e.state,r=e.frameCtx,n=e.incrementDrawState;t.drawArraysInstanced(t.POINTS,0,i.positionsBuf.numItems,i.numInstances),n&&r.drawArrays++}}]),i}(),Tl=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{incrementDrawState:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing color vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),r.push("in vec4 color;"),r.push("in float flags;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vColor;"),r.push("void main(void) {"),r.push("int colorFlag = int(flags) & 0xF;"),r.push("if (colorFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points instancing color fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}}]),i}(),Dl=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"drawLayer",value:function(e,t,r){v(x(i.prototype),"drawLayer",this).call(this,e,t,r,{colorUniform:!0})}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing silhouette vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("in vec4 color;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),r.push("uniform vec4 silhouetteColor;"),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vColor;"),r.push("void main(void) {"),r.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),r.push("if (silhouetteFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points instancing silhouette fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vColor;"),r.push("}"),r}}]),i}(),Sl=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing pick mesh vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("in vec4 pickColor;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(r),this._addRemapClipPosLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vPickColor;"),r.push("void main(void) {"),r.push("int pickFlag = int(flags) >> 12 & 0xF;"),r.push("if (pickFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),r.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points instancing pick mesh fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vPickColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("outColor = vPickColor; "),r.push("}"),r}}]),i}(),Rl=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing pick depth vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(r),this._addRemapClipPosLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("out vec4 vViewPosition;"),r.push("void main(void) {"),r.push("int pickFlag = int(flags) >> 12 & 0xF;"),r.push("if (pickFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags = flags;")),r.push("  vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),r.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points instancing pick depth fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    outColor = packDepth(zNormalizedDepth); "),r.push("}"),r}}]),i}(),Ul=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing occlusion vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in vec4 color;"),r.push("in float flags;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("void main(void) {"),r.push("int colorFlag = int(flags) & 0xF;"),r.push("if (colorFlag != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("  vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Points instancing occlusion vertex shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0;n<t.getNumAllocatedSectionPlanes();n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),e.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var s=0;s<t.getNumAllocatedSectionPlanes();s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}}]),i}(),Ll=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,r=[];return r.push("#version 300 es"),r.push("// Points instancing depth vertex shader"),r.push("uniform int renderPass;"),r.push("in vec3 position;"),e.entityOffsetsEnabled&&r.push("in vec3 offset;"),r.push("in float flags;"),r.push("in vec4 modelMatrixCol0;"),r.push("in vec4 modelMatrixCol1;"),r.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(r),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;")),t&&(r.push("out vec4 vWorldPosition;"),r.push("out float vFlags;")),r.push("void main(void) {"),r.push("int colorFlag = int(flags) & 0xF;"),r.push("if (colorFlag != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags = flags;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r}},{key:"_buildFragmentShader",value:function(){var e,t,i=this._scene,r=i._sectionPlanesState,n=r.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing depth vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),n)for(s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");if(s.push("const float   packUpScale = 256. / 255.;"),s.push("const float   unpackDownscale = 255. / 256.;"),s.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),s.push("const float   shiftRight8 = 1.0 / 256.;"),s.push("vec4 packDepthToRGBA( const in float v ) {"),s.push("    vec4 r = vec4( fract( v * packFactors ), v );"),s.push("    r.yzw -= r.xyz * shiftRight8;"),s.push("    return r * packUpScale;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),n){for(s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;"),e=0,t=r.getNumAllocatedSectionPlanes();e<t;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),i.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}]),i}(),Ol=function(e){m(i,Il);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),i.push("uniform float pointSize;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag     = int(flags) & 0xF;"),i.push("bool visible      = (colorFlag > 0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Instancing geometry depth drawing fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }"),i){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r}}]),i}(),Nl=le.vec3(),Vl=le.vec3(),Ql=le.vec3();le.vec3();var Hl=le.mat4(),Gl=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.canvas.gl,o=n.camera,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?s.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p=Nl;if(p[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,p[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,p[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(p[0]),e.snapPickCoordinateScale[1]=le.safeInv(p[1]),e.snapPickCoordinateScale[2]=le.safeInv(p[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var f=Vl;if(l){var v=le.transformPoint3(A,l,Ql);f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],d=Jt(h,f,Hl),e.snapPickOrigin[0]=f[0],e.snapPickOrigin[1]=f[1],e.snapPickOrigin[2]=f[2]}else d=h,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;s.uniform2fv(this.uVectorA,e.snapVectorA),s.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),s.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),s.uniform3fv(this._uCoordinateScaler,p),s.uniform1i(this._uRenderPass,i),s.uniform1i(this._uPickInvisible,e.pickInvisible);var g=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),s.bindBuffer(s.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),s.bufferData(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,s.DYNAMIC_DRAW),s.bindBufferBase(s.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var m=2/(Math.log(e.pickZFar+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,m),this.setSectionPlanesStateUniforms(t),s.drawArraysInstanced(s.POINTS,0,a.positionsBuf.numItems,a.numInstances),s.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),jl=le.vec3(),zl=le.vec3(),Wl=le.vec3();le.vec3();var Xl=le.mat4(),Kl=function(e){m(i,Ds);var t=y(i);function i(e){return k(this,i),t.call(this,e,!1,{instancing:!0})}return I(i,[{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=t.aabb,h=e.pickViewMatrix||s.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));var d,p=jl;if(p[0]=le.safeInv(c[3]-c[0])*le.MAX_INT,p[1]=le.safeInv(c[4]-c[1])*le.MAX_INT,p[2]=le.safeInv(c[5]-c[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(p[0]),e.snapPickCoordinateScale[1]=le.safeInv(p[1]),e.snapPickCoordinateScale[2]=le.safeInv(p[2]),l||0!==u[0]||0!==u[1]||0!==u[2]){var f=zl;if(l){var v=le.transformPoint3(A,l,Wl);f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],d=Jt(h,f,Xl),e.snapPickOrigin[0]=f[0],e.snapPickOrigin[1]=f[1],e.snapPickOrigin[2]=f[2]}else d=h,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,p),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);var g=0;this._matricesUniformBlockBufferData.set(A,0),this._matricesUniformBlockBufferData.set(d,g+=16),this._matricesUniformBlockBufferData.set(s.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);var m=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,m),this.setSectionPlanesStateUniforms(t),o.drawArraysInstanced(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),o.bindVertexArray(null)}}},{key:"_allocate",value:function(){v(x(i.prototype),"_allocate",this).call(this);var e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("if (sectionPlaneActive"+n+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),i}(),Zl=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Tl(this._scene,!1)),this._colorRenderer}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Dl(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new Ll(this._scene)),this._depthRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Sl(this._scene)),this._pickMeshRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Rl(this._scene)),this._pickDepthRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new Ul(this._scene)),this._occlusionRenderer}},{key:"shadowRenderer",get:function(){return this._shadowRenderer||(this._shadowRenderer=new Ol(this._scene)),this._shadowRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new Gl(this._scene,!1)),this._snapInitRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new Kl(this._scene)),this._snapRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}]),e}(),Jl={};var Yl=new Uint8Array(4),ql=new Float32Array(1),$l=new Float32Array(3),eu=new Float32Array(4),tu=function(){function e(t){var i,r,n;k(this,e),this.model=t.model,this.material=t.material,this.sortId="PointsInstancingLayer",this.layerIndex=t.layerIndex,this._renderers=(i=t.model.scene,r=i.id,(n=Jl[r])||(n=new Zl(i),Jl[r]=n,n._compile(),i.on("compile",(function(){n._compile()})),i.on("destroyed",(function(){delete Jl[r],n._destroy()}))),n),this._aabb=le.collapseAABB3(),this._state=new nt({obb:le.OBB3(),numInstances:0,origin:t.origin?le.vec3(t.origin):null,geometry:t.geometry,positionsDecodeMatrix:t.geometry.positionsDecodeMatrix,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=t.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,this.primitive=t.geometry.primitive}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"createPortion",value:function(e,t){var i=t.meshMatrix,r=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(i[0]),this._modelMatrixCol0.push(i[4]),this._modelMatrixCol0.push(i[8]),this._modelMatrixCol0.push(i[12]),this._modelMatrixCol1.push(i[1]),this._modelMatrixCol1.push(i[5]),this._modelMatrixCol1.push(i[9]),this._modelMatrixCol1.push(i[13]),this._modelMatrixCol2.push(i[2]),this._modelMatrixCol2.push(i[6]),this._modelMatrixCol2.push(i[10]),this._modelMatrixCol2.push(i[14]),this._pickColors.push(r[0]),this._pickColors.push(r[1]),this._pickColors.push(r[2]),this._pickColors.push(r[3]),this._state.numInstances++;var n=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),n}},{key:"finalize",value:function(){if(this._finalized)throw"Already finalized";var e=this.model.scene.canvas.gl,t=this._pickColors.length/4,i=this._state,r=i.geometry;if(t>0){i.flagsBuf=new st(e,e.ARRAY_BUFFER,new Float32Array(t),t,1,e.DYNAMIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){i.offsetsBuf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]}if(r.positionsCompressed&&r.positionsCompressed.length>0){i.positionsBuf=new st(e,e.ARRAY_BUFFER,r.positionsCompressed,r.positionsCompressed.length,3,e.STATIC_DRAW,!1),i.positionsDecodeMatrix=le.mat4(r.positionsDecodeMatrix)}if(r.colorsCompressed&&r.colorsCompressed.length>0){var n=new Uint8Array(r.colorsCompressed);i.colorsBuf=new st(e,e.ARRAY_BUFFER,n,n.length,4,e.STATIC_DRAW,!1)}if(this._modelMatrixCol0.length>0){var s=!1;i.modelMatrixCol0Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,s),i.modelMatrixCol1Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,s),i.modelMatrixCol2Buf=new st(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,s),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){i.pickColorsBuf=new st(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]}i.geometry=null,this._finalized=!0}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){if(!this._finalized)throw"Not finalized";Yl[0]=t[0],Yl[1]=t[1],Yl[2]=t[2],this._state.colorsBuf.setData(Yl,3*e)}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){if(!this._finalized)throw"Not finalized";var r=!!(t&gs),n=!!(t&ws),s=!!(t&Bs),o=!!(t&xs),a=!!(t&Ps),l=!!(t&_s),u=!!(t&ms),A=0;A|=!r||u||n||s&&!this.model.scene.highlightMaterial.glowThrough||o&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.SILHOUETTE_SELECTED:s?Cs.SILHOUETTE_HIGHLIGHTED:n?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED)<<4,A|=(!r||u?Cs.NOT_RENDERED:o?Cs.EDGES_SELECTED:s?Cs.EDGES_HIGHLIGHTED:n?Cs.EDGES_XRAYED:a?i?Cs.EDGES_COLOR_TRANSPARENT:Cs.EDGES_COLOR_OPAQUE:Cs.NOT_RENDERED)<<8,A|=(r&&!u&&l?Cs.PICK:Cs.NOT_RENDERED)<<12,A|=(t&ys?255:0)<<16,ql[0]=A,this._state.flagsBuf.setData(ql,e)}},{key:"setOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?($l[0]=t[0],$l[1]=t[1],$l[2]=t[2],this._state.offsetsBuf.setData($l,3*e)):this.model.error("Entity#offset not enabled for this Viewer")}},{key:"setMatrix",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=4*e;eu[0]=t[0],eu[1]=t[4],eu[2]=t[8],eu[3]=t[12],this._state.modelMatrixCol0Buf.setData(eu,i),eu[0]=t[1],eu[1]=t[5],eu[2]=t[9],eu[3]=t[13],this._state.modelMatrixCol1Buf.setData(eu,i),eu[0]=t[2],eu[1]=t[6],eu[2]=t[10],eu[3]=t[14],this._state.modelMatrixCol2Buf.setData(eu,i)}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED)}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED)}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED)}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawShadow",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawPickDepths",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawPickNormals",value:function(e,t){}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK)}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK)}},{key:"destroy",value:function(){var e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}]),e}(),iu=le.vec3(),ru=le.vec3(),nu=le.mat4(),su=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,s=t.model,o=r.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=s.position,c=s.rotationMatrix,h=n.viewMatrix;if(this._program||(this._allocate(),!this.errors)){var d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uPerObjectDecodeMatrix,this._uPerVertexPosition,this.uPerObjectColorAndFlags,this._uPerObjectMatrix);var p=0!==u[0]||0!==u[1]||0!==u[2],f=0!==A[0]||0!==A[1]||0!==A[2];if(p||f){var v=iu;if(p){var g=le.transformPoint3(c,u,ru);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=A[0],v[1]+=A[1],v[2]+=A[2],d=Jt(h,v,nu)}else d=h;if(o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),o.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){var m=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,m)}var _=r._sectionPlanesState.getNumAllocatedSectionPlanes(),y=r._sectionPlanesState.sectionPlanes.length;if(_>0)for(var b=r._sectionPlanesState.sectionPlanes,w=t.layerIndex*y,B=s.renderFlags,x=0;x<_;x++){var P=this._uSectionPlanes[x];if(P)if(x<y){var C=B.sectionPlanesActivePerLayer[w+x];if(o.uniform1i(P.active,C?1:0),C){var M=b[x];if(u){var F=ei(M.dist,M.dir,u,iu,s.matrix);o.uniform3fv(P.pos,F)}else o.uniform3fv(P.pos,M.pos);o.uniform3fv(P.dir,M.dir)}}else o.uniform1i(P.active,0)}a.numIndices8Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,8),o.drawArrays(o.LINES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,16),o.drawArrays(o.LINES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,32),o.drawArrays(o.LINES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)return this.errors=this._program.errors,void console.error(this.errors);var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uPerObjectDecodeMatrix="uPerObjectDecodeMatrix",this.uPerObjectColorAndFlags="uPerObjectColorAndFlags",this._uPerVertexPosition="uPerVertexPosition",this._uPerLineIndices="uPerLineIndices",this._uPerLineObject="uPerLineObject",this._uPerObjectMatrix="uPerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t.camera.project;if(r.bind(),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// LinesDataTextureColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uPerObjectDecodeMatrix;"),i.push("uniform highp sampler2D uPerObjectMatrix;"),i.push("uniform lowp usampler2D uPerObjectColorAndFlags;"),i.push("uniform mediump usampler2D uPerVertexPosition;"),i.push("uniform highp usampler2D uPerLineIndices;"),i.push("uniform mediump usampler2D uPerLineObject;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("  int lineIndex = gl_VertexID / 2;"),i.push("  int h_packed_object_id_index = (lineIndex >> 3) & 4095;"),i.push("  int v_packed_object_id_index = (lineIndex >> 3) >> 12;"),i.push("  int objectIndex = int(texelFetch(uPerLineObject, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("  ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("  uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("  uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("  if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("      return;"),i.push("  } else {"),i.push("      ivec4 packedVertexBase = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("      ivec4 packedLineIndexBaseOffset = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("      int lineIndexBaseOffset = (packedLineIndexBaseOffset.r << 24) + (packedLineIndexBaseOffset.g << 16) + (packedLineIndexBaseOffset.b << 8) + packedLineIndexBaseOffset.a;"),i.push("      int h_index = (lineIndex - lineIndexBaseOffset) & 4095;"),i.push("      int v_index = (lineIndex - lineIndexBaseOffset) >> 12;"),i.push("      ivec3 vertexIndices = ivec3(texelFetch(uPerLineIndices, ivec2(h_index, v_index), 0));"),i.push("      ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("      int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("      int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("      mat4 objectInstanceMatrix = mat4 (texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("      uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("      vec3 position = vec3(texelFetch(uPerVertexPosition, ivec2(indexPositionH, indexPositionV), 0));"),i.push("      uvec4 color = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("      if (color.a == 0u) {"),i.push("          gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("          return;"),i.push("      };"),i.push("      vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("      vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("      vFragDepth = 1.0 + clipPos.w;"),i.push("      isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("      gl_Position = clipPos;"),i.push("      vec4 rgb = vec4(color.rgba);"),i.push("      vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// LinesDataTextureColorRenderer fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;"),r.push("flat in uint vFlags2;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = vFlags2 > 0u;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   outColor            = vColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),ou=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null)}},{key:"eagerCreateRenders",value:function(){}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new su(this._scene,!1)),this._colorRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy()}}]),e}(),au={};var lu=I((function e(){k(this,e),this.positionsCompressed=[],this.lenPositionsCompressed=0,this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perLineNumberPortionId8Bits=[],this.perLineNumberPortionId16Bits=[],this.perLineNumberPortionId32Bits=[]})),uu=function(){function e(){k(this,e),this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerLineIdPortionIds8Bits=null,this.texturePerLineIdPortionIds16Bits=null,this.texturePerLineIdPortionIds32Bits=null,this.texturePerLineIdIndices8Bits=null,this.texturePerLineIdIndices16Bits=null,this.texturePerLineIdIndices32Bits=null,this.textureModelMatrices=null}return I(e,[{key:"finalize",value:function(){this.indicesPerBitnessTextures={8:this.texturePerLineIdIndices8Bits,16:this.texturePerLineIdIndices16Bits,32:this.texturePerLineIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerLineIdPortionIds8Bits,16:this.texturePerLineIdPortionIds16Bits,32:this.texturePerLineIdPortionIds32Bits}}},{key:"bindCommonTextures",value:function(e,t,i,r,n){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,r,3),this.texturePerObjectInstanceMatrices.bindTexture(e,n,4)}},{key:"bindLineIndicesTextures",value:function(e,t,i,r){this.indicesPortionIdsPerBitnessTextures[r].bindTexture(e,t,5),this.indicesPerBitnessTextures[r].bindTexture(e,i,6)}}]),e}(),Au=function(){function e(t,i,r,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;k(this,e),this._gl=t,this._texture=i,this._textureWidth=r,this._textureHeight=n,this._textureData=s}return I(e,[{key:"bindTexture",value:function(e,t,i){return e.bindTexture(t,this,i)}},{key:"bind",value:function(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}},{key:"unbind",value:function(e){}}]),e}(),cu={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalLines:0,totalLines8Bits:0,totalLines16Bits:0,totalLines32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(cu,null,4));var e=0;Object.keys(cu).forEach((function(t){t.startsWith("size")&&(e+=cu[t])})),console.log("Total size ".concat(e," bytes (").concat((e/1e3/1e3).toFixed(2)," MB)")),console.log("Avg bytes / triangle: ".concat((e/cu.totalLines).toFixed(2)));var t={};Object.keys(cu).forEach((function(i){i.startsWith("size")&&(t[i]="".concat((cu[i]/e*100).toFixed(2)," % of total"))})),console.log(JSON.stringify({percentualRamUsage:t},null,4))};var hu=function(){function e(){k(this,e)}return I(e,[{key:"disableBindedTextureFiltering",value:function(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}},{key:"generateTextureForColorsAndFlags",value:function(e,t,i,r,n){var s=t.length;this.numPortions=s;var o=4096,a=Math.ceil(s/512);if(0===a)throw"texture height===0";var l=new Uint8Array(16384*a);cu.sizeDataColorsAndFlags+=l.byteLength,cu.numberOfTextures++;for(var u=0;u<s;u++)l.set(t[u],32*u+0),l.set(i[u],32*u+4),l.set([0,0,0,0],32*u+8),l.set([0,0,0,0],32*u+12),l.set([r[u]>>24&255,r[u]>>16&255,r[u]>>8&255,255&r[u]],32*u+16),l.set([n[u]>>24&255,n[u]>>16&255,n[u]>>8&255,255&n[u]],32*u+20);var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,o,a),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,a,e.RGBA_INTEGER,e.UNSIGNED_BYTE,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,o,a,l)}},{key:"generateTextureForObjectOffsets",value:function(e,t){var i=512,r=Math.ceil(t/i);if(0===r)throw"texture height===0";var n=new Float32Array(1536*r).fill(0);cu.sizeDataTextureOffsets+=n.byteLength,cu.numberOfTextures++;var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,s,i,r,n)}},{key:"generateTextureForInstancingMatrices",value:function(e,t){var i=t.length;if(0===i)throw"num instance matrices===0";var r=2048,n=Math.ceil(i/512),s=new Float32Array(8192*n);cu.numberOfTextures++;for(var o=0;o<t.length;o++)s.set(t[o],16*o);var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGBA,e.FLOAT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,a,r,n,s)}},{key:"generateTextureForPositionsDecodeMatrices",value:function(e,t){var i=t.length;if(0===i)throw"num decode+entity matrices===0";var r=2048,n=Math.ceil(i/512),s=new Float32Array(8192*n);cu.sizeDataPositionDecodeMatrices+=s.byteLength,cu.numberOfTextures++;for(var o=0;o<t.length;o++)s.set(t[o],16*o);var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGBA,e.FLOAT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,a,r,n)}},{key:"generateTextureFor8BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint8Array(r*n*3);cu.sizeDataTextureIndices+=s.byteLength,cu.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_BYTE,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"generateTextureFor16BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint16Array(r*n*3);cu.sizeDataTextureIndices+=s.byteLength,cu.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"generateTextureFor32BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint32Array(r*n*3);cu.sizeDataTextureIndices+=s.byteLength,cu.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_INT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"generateTextureForPositions",value:function(e,t,i){var r=i/3,n=4096,s=Math.ceil(r/n);if(0===s)throw"texture height===0";var o=new Uint16Array(n*s*3);cu.sizeDataTexturePositions+=o.byteLength,cu.numberOfTextures++;for(var a=0,l=0,u=t.length;a<u;a++){var A=t[a];o.set(A,l),l+=A.length}var c=e.createTexture();return e.bindTexture(e.TEXTURE_2D,c),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,n,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,n,s,e.RGB_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,c,n,s)}},{key:"generateTextureForPackedPortionIds",value:function(e,t){if(0===t.length)return{texture:null,textureHeight:0};var i=t.length,r=4096,n=Math.ceil(i/r);if(0===n)throw"texture height===0";var s=new Uint16Array(r*n);s.set(t,0),cu.sizeDataTexturePortionIds+=s.byteLength,cu.numberOfTextures++;var o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RED_INTEGER,e.UNSIGNED_SHORT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,o,r,n)}}]),e}(),du=new po,pu=du.maxDataTextureHeight,fu=new Float32Array(16),vu=new Uint8Array(4),gu=new Float32Array(3),mu=0,_u=le.identityMat4(),yu=function(){function e(t,i){var r,n,s;k(this,e),cu.numberOfLayers++,this._layerNumber=mu++,this.sortId="TriDTX-".concat(this._layerNumber),this.layerIndex=i.layerIndex,this._renderers=(r=t.scene,n=r.id,(s=au[n])||(s=new ou(r),au[n]=s,s._compile(),s.eagerCreateRenders(),r.on("compile",(function(){s._compile(),s.eagerCreateRenders()})),r.on("destroyed",(function(){delete au[n],s._destroy()}))),s),this.model=t,this._buffer=new lu,this._dataTextureState=new uu,this._dataTextureGenerator=new hu,this._state=new nt({origin:le.vec3(i.origin),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=i.primitive,this._finalized=!1}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"canCreatePortion",value:function(e){if(this._finalized)throw"Already finalized";var t=e.buckets.length;this._numPortions+t>65536&&cu.cannotCreatePortion.because10BitsObjectId++;var i=this._numPortions+t<=65536,r=void 0!==e.geometryId&&null!==e.geometryId?"".concat(e.geometryId,"#").concat(0):"".concat(e.id,"#").concat(0);if(!this._bucketGeometries[r]){var n=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits),s=0,o=0;e.buckets.forEach((function(e){s+=e.positionsCompressed.length/3,o+=e.indices.length/2})),(this._state.numVertices+s>4096*pu||n+o>4096*pu)&&cu.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+s<=4096*pu&&n+o<=4096*pu)}return i}},{key:"createPortion",value:function(e,t){var i=this;if(this._finalized)throw"Already finalized";var r=[];t.buckets.forEach((function(e,n){var s=void 0!==t.geometryId&&null!==t.geometryId?"".concat(t.geometryId,"#").concat(n):"".concat(t.id,"#").concat(n),o=i._bucketGeometries[s];o||(o=i._createBucketGeometry(t,e),i._bucketGeometries[s]=o);var a=i._createSubPortion(t,o,e);r.push(a)}));var n=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(r),this.model.numPortions++,this._meshes.push(e),n}},{key:"_createBucketGeometry",value:function(e,t){if(t.indices){var i=8*Math.ceil(t.indices.length/2/8)*2;cu.overheadSizeAlignementIndices+=2*(i-t.indices.length);var r=new Uint32Array(i);r.fill(0),r.set(t.indices),t.indices=r}var n=t.positionsCompressed,s=t.indices,o=this._buffer;o.positionsCompressed.push(n);var a,l=o.lenPositionsCompressed/3,u=n.length/3;o.lenPositionsCompressed+=n.length;var A,c=0;s&&(c=s.length/2,u<=256?(A=o.indices8Bits,a=o.lenIndices8Bits/2,o.lenIndices8Bits+=s.length):u<=65536?(A=o.indices16Bits,a=o.lenIndices16Bits/2,o.lenIndices16Bits+=s.length):(A=o.indices32Bits,a=o.lenIndices32Bits/2,o.lenIndices32Bits+=s.length),A.push(s));return this._state.numVertices+=u,cu.numberOfGeometries++,{vertexBase:l,numVertices:u,numLines:c,indicesBase:a}}},{key:"_createSubPortion",value:function(e,t){var i,r=e.color,n=e.colors,s=e.opacity,o=e.meshMatrix,a=e.pickColor,l=this._buffer,u=this._state;l.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),l.perObjectInstancePositioningMatrices.push(o||_u),l.perObjectSolid.push(!!e.solid),n?l.perObjectColors.push([255*n[0],255*n[1],255*n[2],255]):r&&l.perObjectColors.push([r[0],r[1],r[2],s]),l.perObjectPickColors.push(a),l.perObjectVertexBases.push(t.vertexBase),i=t.numVertices<=256?u.numIndices8Bits:t.numVertices<=65536?u.numIndices16Bits:u.numIndices32Bits,l.perObjectIndexBaseOffsets.push(i/2-t.indicesBase);var A=this._subPortions.length;if(t.numLines>0){var c,h=2*t.numLines;t.numVertices<=256?(c=l.perLineNumberPortionId8Bits,u.numIndices8Bits+=h,cu.totalLines8Bits+=t.numLines):t.numVertices<=65536?(c=l.perLineNumberPortionId16Bits,u.numIndices16Bits+=h,cu.totalLines16Bits+=t.numLines):(c=l.perLineNumberPortionId32Bits,u.numIndices32Bits+=h,cu.totalLines32Bits+=t.numLines),cu.totalLines+=t.numLines;for(var d=0;d<t.numLines;d+=8)c.push(A)}return this._subPortions.push({numVertices:t.numLines}),this._numPortions++,cu.numberOfPortions++,A}},{key:"finalize",value:function(){var e=this;if(!this._finalized){var t=this._state,i=this._dataTextureState,r=this.model.scene.canvas.gl,n=this._buffer;t.gl=r,i.texturePerObjectColorsAndFlags=this._dataTextureGenerator.generateTextureForColorsAndFlags(r,n.perObjectColors,n.perObjectPickColors,n.perObjectVertexBases,n.perObjectIndexBaseOffsets,n.perObjectSolid),i.texturePerObjectInstanceMatrices=this._dataTextureGenerator.generateTextureForInstancingMatrices(r,n.perObjectInstancePositioningMatrices),i.texturePerObjectPositionsDecodeMatrix=this._dataTextureGenerator.generateTextureForPositionsDecodeMatrices(r,n.perObjectPositionsDecodeMatrices),i.texturePerVertexIdCoordinates=this._dataTextureGenerator.generateTextureForPositions(r,n.positionsCompressed,n.lenPositionsCompressed),i.texturePerLineIdPortionIds8Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(r,n.perLineNumberPortionId8Bits),i.texturePerLineIdPortionIds16Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(r,n.perLineNumberPortionId16Bits),i.texturePerLineIdPortionIds32Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(r,n.perLineNumberPortionId32Bits),n.lenIndices8Bits>0&&(i.texturePerLineIdIndices8Bits=this._dataTextureGenerator.generateTextureFor8BitIndices(r,n.indices8Bits,n.lenIndices8Bits)),n.lenIndices16Bits>0&&(i.texturePerLineIdIndices16Bits=this._dataTextureGenerator.generateTextureFor16BitIndices(r,n.indices16Bits,n.lenIndices16Bits)),n.lenIndices32Bits>0&&(i.texturePerLineIdIndices32Bits=this._dataTextureGenerator.generateTextureFor32BitIndices(r,n.indices32Bits,n.lenIndices32Bits)),i.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",(function(){e._deferredSetFlagsDirty&&e._uploadDeferredFlags(),e._numUpdatesInFrame=0}))}}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}},{key:"flushInitFlags",value:function(){this._setDeferredFlags(),this._setDeferredFlags2()}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"_beginDeferredFlags",value:function(){this._deferredSetFlagsActive=!0}},{key:"_uploadDeferredFlags",value:function(){if(this._deferredSetFlagsActive=!1,this._deferredSetFlagsDirty){this._deferredSetFlagsDirty=!1;var e=this.model.scene.canvas.gl,t=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetColor(i[r],t)}},{key:"_subPortionSetColor",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dataTextureState,r=this.model.scene.canvas.gl;vu[0]=t[0],vu[1]=t[1],vu[2]=t[2],vu[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(vu,32*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),r.texSubImage2D(r.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,r.RGBA_INTEGER,r.UNSIGNED_BYTE,vu))}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){for(var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=this._portionToSubPortionsMap[e],s=0,o=n.length;s<o;s++)this._subPortionSetFlags(n[s],t,i,r)}},{key:"_subPortionSetFlags",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this._finalized)throw"Not finalized";var n,s,o=!!(t&gs),a=!!(t&ws),l=!!(t&Bs),u=!!(t&xs),A=!!(t&_s),c=!!(t&ms);n=!o||c||a?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,s=!o||c?Cs.NOT_RENDERED:u?Cs.SILHOUETTE_SELECTED:l?Cs.SILHOUETTE_HIGHLIGHTED:a?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED;var h=o&&!c&&A?Cs.PICK:Cs.NOT_RENDERED,d=this._dataTextureState,p=this.model.scene.canvas.gl;vu[0]=n,vu[1]=s,vu[3]=h,d.texturePerObjectColorsAndFlags._textureData.set(vu,32*e+8),this._deferredSetFlagsActive||r?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),p.bindTexture(p.TEXTURE_2D,d.texturePerObjectColorsAndFlags._texture),p.texSubImage2D(p.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,p.RGBA_INTEGER,p.UNSIGNED_BYTE,vu))}},{key:"_setDeferredFlags",value:function(){}},{key:"_setFlags2",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this._portionToSubPortionsMap[e],n=0,s=r.length;n<s;n++)this._subPortionSetFlags2(r[n],t,i)}},{key:"_subPortionSetFlags2",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._finalized)throw"Not finalized";var r=t&ys?255:0,n=this._dataTextureState,s=this.model.scene.canvas.gl;vu[0]=r,vu[1]=0,vu[2]=1,vu[3]=2,n.texturePerObjectColorsAndFlags._textureData.set(vu,32*e+12),this._deferredSetFlagsActive||i?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,n.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,vu))}},{key:"_setDeferredFlags2",value:function(){}},{key:"setOffset",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetOffset(i[r],t)}},{key:"_subPortionSetOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dataTextureState,r=this.model.scene.canvas.gl;gu[0]=t[0],gu[1]=t[1],gu[2]=t[2],i.texturePerObjectOffsets._textureData.set(gu,3*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectOffsets._texture),r.texSubImage2D(r.TEXTURE_2D,0,0,e,1,1,r.RGB,r.FLOAT,gu))}},{key:"setMatrix",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetMatrix(i[r],t)}},{key:"_subPortionSetMatrix",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dataTextureState,r=this.model.scene.canvas.gl;fu.set(t),i.texturePerObjectInstanceMatrices._textureData.set(fu,16*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),r.texSubImage2D(r.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,r.RGBA,r.FLOAT,fu))}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE)}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT)}},{key:"drawDepth",value:function(e,t){}},{key:"drawNormals",value:function(e,t){}},{key:"drawSilhouetteXRayed",value:function(e,t){}},{key:"drawSilhouetteHighlighted",value:function(e,t){}},{key:"drawSilhouetteSelected",value:function(e,t){}},{key:"drawEdgesColorOpaque",value:function(e,t){}},{key:"drawEdgesColorTransparent",value:function(e,t){}},{key:"drawEdgesHighlighted",value:function(e,t){}},{key:"drawEdgesSelected",value:function(e,t){}},{key:"drawEdgesXRayed",value:function(e,t){}},{key:"drawOcclusion",value:function(e,t){}},{key:"drawShadow",value:function(e,t){}},{key:"setPickMatrices",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){}},{key:"drawPickDepths",value:function(e,t){}},{key:"drawSnapInit",value:function(e,t){}},{key:"drawSnap",value:function(e,t){}},{key:"drawPickNormals",value:function(e,t){}},{key:"destroy",value:function(){if(!this._destroyed){var e=this._state;this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}}]),e}(),bu=le.vec3(),wu=le.vec3(),Bu=le.vec3();le.vec3();var xu=le.vec4(),Pu=le.mat4(),Cu=function(){function e(t,i){k(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,s=t.model,o=r.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=s.position,c=s.rotationMatrix;if(this._program||(this._allocate(),!this.errors)){var h,d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var p=0!==u[0]||0!==u[1]||0!==u[2],f=0!==A[0]||0!==A[1]||0!==A[2];if(p||f){var v=bu;if(p){var g=le.transformPoint3(c,u,wu);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=A[0],v[1]+=A[1],v[2]+=A[2],h=Jt(n.viewMatrix,v,Pu),(d=Bu)[0]=n.eye[0]-v[0],d[1]=n.eye[1]-v[1],d[2]=n.eye[2]-v[2]}else h=n.viewMatrix,d=n.eye;if(o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,h),o.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),o.uniform3fv(this._uCameraEyeRtc,d),o.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){var m=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,m)}var _=r._sectionPlanesState.getNumAllocatedSectionPlanes(),y=r._sectionPlanesState.sectionPlanes.length;if(_>0){var b=r._sectionPlanesState.sectionPlanes,w=t.layerIndex*y,B=s.renderFlags;r.crossSections&&(o.uniform4fv(this._uSliceColor,r.crossSections.sliceColor),o.uniform1f(this._uSliceThickness,r.crossSections.sliceThickness));for(var x=0;x<_;x++){var P=this._uSectionPlanes[x];if(P)if(x<y){var C=B.sectionPlanesActivePerLayer[w+x];if(o.uniform1i(P.active,C?1:0),C){var M=b[x];if(u){var F=ei(M.dist,M.dir,u,bu,s.matrix);o.uniform3fv(P.pos,F)}else o.uniform3fv(P.pos,M.pos);o.uniform3fv(P.dir,M.dir)}}else o.uniform1i(P.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),o.drawArrays(o.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),o.drawArrays(o.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),o.drawArrays(o.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Pr(t,this._buildShader()),this._program.errors)return this.errors=this._program.errors,void console.error(this.errors);var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var n=i.lights,s=0,o=n.length;s<o;s++)switch(n[s].type){case"dir":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=null,this._uLightDir[s]=r.getLocation("lightDir"+s);break;case"point":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=r.getLocation("lightPos"+s),this._uLightDir[s]=null,this._uLightAttenuation[s]=r.getLocation("lightAttenuation"+s);break;case"spot":this._uLightColor[s]=r.getLocation("lightColor"+s),this._uLightPos[s]=r.getLocation("lightPos"+s),this._uLightDir[s]=r.getLocation("lightDir"+s),this._uLightAttenuation[s]=r.getLocation("lightAttenuation"+s)}this._uSceneModelMatrix=r.getLocation("sceneModelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,l=e._sectionPlanesState.getNumAllocatedSectionPlanes();a<l;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=r.getLocation("uCameraEyeRtc"),e.crossSections&&(this._uSliceColor=r.getLocation("sliceColor"),this._uSliceThickness=r.getLocation("sliceThickness"))}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t._lightsState.lights,s=t.camera.project;r.bind(),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(var o=0,a=n.length;o<a;o++){var l=n[o];this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],l.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],l.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],l.dir)}if(this._withSAO){var u=t.sao;if(u.possible){var A=i.drawingBufferWidth,c=i.drawingBufferHeight;xu[0]=A,xu[1]=c,xu[2]=u.blendCutoff,xu[3]=u.blendFactor,i.uniform4fv(this._uSAOParams,xu),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(t.logarithmicDepthBufferEnabled){var h=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,h)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e,t=this._scene,i=t._sectionPlanesState,r=t._lightsState,n=i.getNumAllocatedSectionPlanes()>0,s=[];s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("uniform mat4 sceneModelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),s.push("uniform highp sampler2D uTexturePerObjectMatrix;"),s.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("uniform vec4 lightAmbient;");for(var o=0,a=r.lights.length;o<a;o++)"ambient"!==(e=r.lights[o]).type&&(s.push("uniform vec4 lightColor"+o+";"),"dir"===e.type&&s.push("uniform vec3 lightDir"+o+";"),"point"===e.type&&s.push("uniform vec3 lightPos"+o+";"),"spot"===e.type&&(s.push("uniform vec3 lightPos"+o+";"),s.push("uniform vec3 lightDir"+o+";")));n&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),s.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("} else {"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = sceneModelMatrix * ((objectDecodeAndInstanceMatrix * vec4(position, 1.0))); "),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),s.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),s.push("float lambertian = 1.0;");for(var l=0,u=r.lights.length;l<u;l++)if("ambient"!==(e=r.lights[l]).type){if("dir"===e.type)"view"===e.space?s.push("viewLightDir = normalize(lightDir"+l+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?s.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):s.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?s.push("viewLightDir = normalize(lightDir"+l+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);")}s.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),s.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}return s.push("vec3 rgb = vec3(color.rgb) / 255.0;"),s.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2.r;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// TrianglesDataTextureColorRenderer fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("in vec4 vWorldPosition;"),r.push("flat in uint vFlags2;");for(var n=0,s=t.getNumAllocatedSectionPlanes();n<s;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";");r.push("uniform float sliceThickness;"),r.push("uniform vec4 sliceColor;")}if(r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec4 newColor;"),r.push("  newColor = vColor;"),i){r.push("  bool clippable = vFlags2 > 0u;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > sliceThickness) { "),r.push("      discard;"),r.push("  }"),r.push("  if (dist > 0.0) { "),r.push("      newColor = sliceColor;"),r.push("  }"),r.push("}")}return e.logarithmicDepthBufferEnabled?r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(r.push("    float dx = dFdx(gl_FragCoord.z);"),r.push("    float dy = dFdy(gl_FragCoord.z);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):r.push("   outColor            = newColor;"),r.push("}"),r}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Mu=new Float32Array([1,1,1]),Fu=le.vec3(),ku=le.vec3(),Eu=le.vec3();le.vec3();var Iu=le.mat4(),Tu=function(){function e(t,i){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,s=t.model,o=r.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=s.position,c=s.rotationMatrix,h=n.viewMatrix;if(this._program||(this._allocate(),!this.errors)){var d,p;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),u||0!==A[0]||0!==A[1]||0!==A[2]){var f=Fu;if(u){var v=ku;le.transformPoint3(c,u,v),f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=A[0],f[1]+=A[1],f[2]+=A[2],d=Jt(h,f,Iu),(p=Eu)[0]=n.eye[0]-f[0],p[1]=n.eye[1]-f[1],p[2]=n.eye[2]-f[2]}else d=h,p=n.eye;if(o.uniform3fv(this._uCameraEyeRtc,p),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uWorldMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),i===Cs.SILHOUETTE_XRAYED){var g=r.xrayMaterial._state,m=g.fillColor,_=g.fillAlpha;o.uniform4f(this._uColor,m[0],m[1],m[2],_)}else if(i===Cs.SILHOUETTE_HIGHLIGHTED){var y=r.highlightMaterial._state,b=y.fillColor,w=y.fillAlpha;o.uniform4f(this._uColor,b[0],b[1],b[2],w)}else if(i===Cs.SILHOUETTE_SELECTED){var B=r.selectedMaterial._state,x=B.fillColor,P=B.fillAlpha;o.uniform4f(this._uColor,x[0],x[1],x[2],P)}else o.uniform4fv(this._uColor,Mu);if(r.logarithmicDepthBufferEnabled){var C=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,C)}var M=r._sectionPlanesState.getNumAllocatedSectionPlanes(),F=r._sectionPlanesState.sectionPlanes.length;if(M>0)for(var k=r._sectionPlanesState.sectionPlanes,E=t.layerIndex*F,I=s.renderFlags,T=0;T<M;T++){var D=this._uSectionPlanes[T];if(D)if(T<F){var S=I.sectionPlanesActivePerLayer[E+T];if(o.uniform1i(D.active,S?1:0),S){var R=k[T];if(u){var U=ei(R.dist,R.dir,u,Fu,s.matrix);o.uniform3fv(D.pos,U)}else o.uniform3fv(D.pos,R.pos);o.uniform3fv(D.dir,R.dir)}}else o.uniform1i(D.active,0)}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),o.drawArrays(o.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),o.drawArrays(o.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),o.drawArrays(o.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=t.camera.project;if(this._program.bind(),t.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture silhouette vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = color;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = newColor;"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Du=new Float32Array([0,0,0,1]),Su=le.vec3(),Ru=le.vec3();le.vec3();var Uu=le.mat4(),Lu=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=r.position,c=r.rotationMatrix,h=s.viewMatrix;if(this._program||(this._allocate(t),!this.errors)){var d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var p=0!==u[0]||0!==u[1]||0!==u[2],f=0!==A[0]||0!==A[1]||0!==A[2];if(p||f){var v=Su;if(p){var g=le.transformPoint3(c,u,Ru);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=A[0],v[1]+=A[1],v[2]+=A[2],d=Jt(h,v,Uu)}else d=h;if(o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uProjMatrix,!1,s.projMatrix),i===Cs.EDGES_XRAYED){var m=n.xrayMaterial._state,_=m.edgeColor,y=m.edgeAlpha;o.uniform4f(this._uColor,_[0],_[1],_[2],y)}else if(i===Cs.EDGES_HIGHLIGHTED){var b=n.highlightMaterial._state,w=b.edgeColor,B=b.edgeAlpha;o.uniform4f(this._uColor,w[0],w[1],w[2],B)}else if(i===Cs.EDGES_SELECTED){var x=n.selectedMaterial._state,P=x.edgeColor,C=x.edgeAlpha;o.uniform4f(this._uColor,P[0],P[1],P[2],C)}else o.uniform4fv(this._uColor,Du);var M=n._sectionPlanesState.getNumAllocatedSectionPlanes(),F=n._sectionPlanesState.sectionPlanes.length;if(M>0)for(var k=n._sectionPlanesState.sectionPlanes,E=t.layerIndex*F,I=r.renderFlags,T=0;T<M;T++){var D=this._uSectionPlanes[T];if(D)if(T<F){var S=I.sectionPlanesActivePerLayer[E+T];if(o.uniform1i(D.active,S?1:0),S){var R=k[T];if(u){var U=ei(R.dist,R.dir,u,Su,r.matrix);o.uniform3fv(D.pos,U)}else o.uniform3fv(D.pos,R.pos);o.uniform3fv(D.dir,R.dir)}}else o.uniform1i(D.active,0)}a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),o.drawArrays(o.LINES,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),o.drawArrays(o.LINES,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),o.drawArrays(o.LINES,0,a.numEdgeIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("mat4 matrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer fragment shader"),e.logarithmicDepthBufferEnabled&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = vColor;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = newColor;"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Ou=le.vec3(),Nu=le.vec3(),Vu=le.mat4(),Qu=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=r.position,c=r.rotationMatrix,h=s.viewMatrix;if(this._program||(this._allocate(),!this.errors)){var d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var p=0!==u[0]||0!==u[1]||0!==u[2],f=0!==A[0]||0!==A[1]||0!==A[2];if(p||f){var v=Ou;if(p){var g=le.transformPoint3(c,u,Nu);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=A[0],v[1]+=A[1],v[2]+=A[2],d=Jt(h,v,Vu)}else d=h;o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uProjMatrix,!1,s.projMatrix);var m=n._sectionPlanesState.getNumAllocatedSectionPlanes(),_=n._sectionPlanesState.sectionPlanes.length;if(m>0)for(var y=n._sectionPlanesState.sectionPlanes,b=t.layerIndex*_,w=r.renderFlags,B=0;B<m;B++){var x=this._uSectionPlanes[B];if(x)if(B<_){var P=w.sectionPlanesActivePerLayer[b+B];if(o.uniform1i(x.active,P?1:0),P){var C=y[B];if(u){var M=ei(C.dist,C.dir,u,Ou,r.matrix);o.uniform3fv(x.pos,M)}else o.uniform3fv(x.pos,C.pos);o.uniform3fv(x.dir,C.dir)}}else o.uniform1i(x.active,0)}a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),o.drawArrays(o.LINES,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),o.drawArrays(o.LINES,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),o.drawArrays(o.LINES,0,a.numEdgeIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){var n=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uObjectPerObjectOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vec4 rgb = vec4(color.rgba);"),i.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = vColor;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = newColor;"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Hu=le.vec3(),Gu=le.vec3(),ju=le.vec3(),zu=le.mat4(),Wu=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(t),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e));var r,n,s=t.model,o=s.scene,a=o.camera,l=o.canvas.gl,u=t._state,A=u.textureState,c=t._state.origin,h=s.position,d=s.rotationMatrix,p=e.pickViewMatrix||a.viewMatrix,f=e.pickProjMatrix||a.projMatrix,v=e.pickOrigin||a.eye,g=e.pickProjMatrix?e.pickZFar:a.project.far;A.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var m=0!==c[0]||0!==c[1]||0!==c[2],_=0!==h[0]||0!==h[1]||0!==h[2];if(m||_){var y=Hu;if(m){var b=le.transformPoint3(d,c,Gu);y[0]=b[0],y[1]=b[1],y[2]=b[2]}else y[0]=0,y[1]=0,y[2]=0;y[0]+=h[0],y[1]+=h[1],y[2]+=h[2],r=Jt(p,y,zu),(n=ju)[0]=v[0]-y[0],n[1]=v[1]-y[1],n[2]=v[2]-y[2]}else r=p,n=v;if(l.uniform2fv(this._uPickClipPos,e.pickClipPos),l.uniform2f(this._uDrawingBufferSize,l.drawingBufferWidth,l.drawingBufferHeight),l.uniformMatrix4fv(this._uSceneModelMatrix,!1,d),l.uniformMatrix4fv(this._uViewMatrix,!1,r),l.uniformMatrix4fv(this._uProjMatrix,!1,f),l.uniform3fv(this._uCameraEyeRtc,n),l.uniform1i(this._uRenderPass,i),o.logarithmicDepthBufferEnabled){var w=2/(Math.log(g+1)/Math.LN2);l.uniform1f(this._uLogDepthBufFC,w)}var B=o._sectionPlanesState.getNumAllocatedSectionPlanes(),x=o._sectionPlanesState.sectionPlanes.length;if(B>0)for(var P=o._sectionPlanesState.sectionPlanes,C=t.layerIndex*x,M=s.renderFlags,F=0;F<B;F++){var k=this._uSectionPlanes[F];if(k)if(F<x){var E=M.sectionPlanesActivePerLayer[C+F];if(l.uniform1i(k.active,E?1:0),E){var I=P[F];if(c){var T=ei(I.dist,I.dir,c,Hu,s.matrix);l.uniform3fv(k.pos,T)}else l.uniform3fv(k.pos,I.pos);l.uniform3fv(k.dir,I.dir)}}else l.uniform1i(k.active,0)}u.numIndices8Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),l.drawArrays(l.TRIANGLES,0,u.numIndices8Bits)),u.numIndices16Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),l.drawArrays(l.TRIANGLES,0,u.numIndices16Bits)),u.numIndices32Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),l.drawArrays(l.TRIANGLES,0,u.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(e){var t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("smooth out vec4 vWorldPosition;"),i.push("flat out uvec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uvec4 vFlags2;");for(var r=0;r<e._sectionPlanesState.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<e._sectionPlanesState.getNumAllocatedSectionPlanes();r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outPickColor = vPickColor; "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),Xu=le.vec3(),Ku=le.vec3(),Zu=le.vec3();le.vec3();var Ju=le.mat4(),Yu=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r,n,s=t.model,o=s.scene,a=o.camera,l=o.canvas.gl,u=t._state,A=u.textureState,c=t._state.origin,h=s.position,d=s.rotationMatrix,p=e.pickViewMatrix||a.viewMatrix,f=e.pickProjMatrix||a.projMatrix,v=e.pickOrigin||a.eye,g=e.pickProjMatrix?e.pickZFar:a.project.far;if(this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),A.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),c||0!==h[0]||0!==h[1]||0!==h[2]){var m=Xu;if(c){var _=Ku;le.transformPoint3(d,c,_),m[0]=_[0],m[1]=_[1],m[2]=_[2]}else m[0]=0,m[1]=0,m[2]=0;m[0]+=h[0],m[1]+=h[1],m[2]+=h[2],r=Jt(p,m,Ju),(n=Zu)[0]=v[0]-m[0],n[1]=v[1]-m[1],n[2]=v[2]-m[2],e.snapPickOrigin[0]=m[0],e.snapPickOrigin[1]=m[1],e.snapPickOrigin[2]=m[2]}else r=p,n=v,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;if(l.uniform3fv(this._uCameraEyeRtc,n),l.uniform1i(this._uRenderPass,i),l.uniform1i(this._uPickInvisible,e.pickInvisible),l.uniform2fv(this._uPickClipPos,e.pickClipPos),l.uniform2f(this._uDrawingBufferSize,l.drawingBufferWidth,l.drawingBufferHeight),l.uniform1f(this._uPickZNear,e.pickZNear),l.uniform1f(this._uPickZFar,e.pickZFar),l.uniformMatrix4fv(this._uSceneModelMatrix,!1,d),l.uniformMatrix4fv(this._uViewMatrix,!1,r),l.uniformMatrix4fv(this._uProjMatrix,!1,f),o.logarithmicDepthBufferEnabled){var y=2/(Math.log(g+1)/Math.LN2);l.uniform1f(this._uLogDepthBufFC,y)}var b=o._sectionPlanesState.getNumAllocatedSectionPlanes(),w=o._sectionPlanesState.sectionPlanes.length;if(b>0)for(var B=o._sectionPlanesState.sectionPlanes,x=t.layerIndex*w,P=s.renderFlags,C=0;C<b;C++){var M=this._uSectionPlanes[C];if(M)if(C<w){var F=P.sectionPlanesActivePerLayer[x+C];if(l.uniform1i(M.active,F?1:0),F){var k=B[C];if(c){var E=ei(k.dist,k.dir,c,Xu,s.matrix);l.uniform3fv(M.pos,E)}else l.uniform3fv(M.pos,k.pos);l.uniform3fv(M.dir,k.dir)}}else l.uniform1i(M.active,0)}u.numIndices8Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),l.drawArrays(l.TRIANGLES,0,u.numIndices8Bits)),u.numIndices16Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),l.drawArrays(l.TRIANGLES,0,u.numIndices16Bits)),u.numIndices32Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),l.drawArrays(l.TRIANGLES,0,u.numIndices32Bits)),e.drawElements++}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0;r<e._sectionPlanesState.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outPackedDepth;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<e._sectionPlanesState.getNumAllocatedSectionPlanes();r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outPackedDepth = packDepth(zNormalizedDepth); "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),qu=le.vec3(),$u=le.vec3(),eA=le.vec3(),tA=le.vec3();le.vec3();var iA=le.mat4(),rA=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r,n,s=t.model,o=s.scene,a=o.camera,l=o.canvas.gl,u=t._state,A=u.textureState,c=t._state.origin,h=s.position,d=s.rotationMatrix,p=t.aabb,f=e.pickViewMatrix||a.viewMatrix,v=qu;v[0]=le.safeInv(p[3]-p[0])*le.MAX_INT,v[1]=le.safeInv(p[4]-p[1])*le.MAX_INT,v[2]=le.safeInv(p[5]-p[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(v[0]),e.snapPickCoordinateScale[1]=le.safeInv(v[1]),e.snapPickCoordinateScale[2]=le.safeInv(v[2]),A.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var g=0!==c[0]||0!==c[1]||0!==c[2],m=0!==h[0]||0!==h[1]||0!==h[2];if(g||m){var _=$u;if(g){var y=le.transformPoint3(d,c,eA);_[0]=y[0],_[1]=y[1],_[2]=y[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],r=Jt(f,_,iA),(n=tA)[0]=a.eye[0]-_[0],n[1]=a.eye[1]-_[1],n[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else r=f,n=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;l.uniform3fv(this._uCameraEyeRtc,n),l.uniform2fv(this.uVectorA,e.snapVectorA),l.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),l.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),l.uniform3fv(this._uCoordinateScaler,v),l.uniform1i(this._uRenderPass,i),l.uniform1i(this._uPickInvisible,e.pickInvisible),l.uniformMatrix4fv(this._uSceneModelMatrix,!1,d),l.uniformMatrix4fv(this._uViewMatrix,!1,r),l.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);var b=2/(Math.log(e.pickZFar+1)/Math.LN2);l.uniform1f(this._uLogDepthBufFC,b);var w=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(w>0)for(var x=o._sectionPlanesState.sectionPlanes,P=t.layerIndex*B,C=s.renderFlags,M=0;M<w;M++){var F=this._uSectionPlanes[M];if(F)if(M<B){var k=C.sectionPlanesActivePerLayer[P+M];if(l.uniform1i(F.active,k?1:0),k){var E=x[M];if(c){var I=ei(E.dist,E.dir,c,qu,s.matrix);l.uniform3fv(F.pos,I)}else l.uniform3fv(F.pos,E.pos);l.uniform3fv(F.dir,E.dir)}}else l.uniform1i(F.active,0)}var T="edge"===e.snapMode?l.LINES:l.POINTS;u.numEdgeIndices8Bits>0&&(A.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),l.drawArrays(T,0,u.numEdgeIndices8Bits)),u.numEdgeIndices16Bits>0&&(A.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),l.drawArrays(T,0,u.numEdgeIndices16Bits)),u.numEdgeIndices32Bits>0&&(A.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),l.drawArrays(T,0,u.numEdgeIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this.uVectorA=i.getLocation("uSnapVectorA"),this.uInverseVectorAB=i.getLocation("uSnapInvVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uSnapVectorA;"),i.push("uniform vec2 uSnapInvVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uSnapVectorA.x) * uSnapInvVectorAB.x;"),i.push("    float y = (clipPos.y - uSnapVectorA.y) * uSnapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vViewPosition = clipPos;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, uLayerNumber);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),nA=le.vec3(),sA=le.vec3(),oA=le.vec3(),aA=le.vec3();le.vec3();var lA=le.mat4(),uA=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());var r,n,s=t.model,o=s.scene,a=o.camera,l=o.canvas.gl,u=t._state,A=u.textureState,c=t._state.origin,h=s.position,d=s.rotationMatrix,p=t.aabb,f=e.pickViewMatrix||a.viewMatrix,v=nA;v[0]=le.safeInv(p[3]-p[0])*le.MAX_INT,v[1]=le.safeInv(p[4]-p[1])*le.MAX_INT,v[2]=le.safeInv(p[5]-p[2])*le.MAX_INT,e.snapPickCoordinateScale[0]=le.safeInv(v[0]),e.snapPickCoordinateScale[1]=le.safeInv(v[1]),e.snapPickCoordinateScale[2]=le.safeInv(v[2]),A.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var g=0!==c[0]||0!==c[1]||0!==c[2],m=0!==h[0]||0!==h[1]||0!==h[2];if(g||m){var _=sA;if(g){var y=oA;le.transformPoint3(d,c,y),_[0]=y[0],_[1]=y[1],_[2]=y[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],r=Jt(f,_,lA),(n=aA)[0]=a.eye[0]-_[0],n[1]=a.eye[1]-_[1],n[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else r=f,n=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;l.uniform3fv(this._uCameraEyeRtc,n),l.uniform2fv(this._uVectorA,e.snapVectorA),l.uniform2fv(this._uInverseVectorAB,e.snapInvVectorAB),l.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),l.uniform3fv(this._uCoordinateScaler,v),l.uniform1i(this._uRenderPass,i),l.uniform1i(this._uPickInvisible,e.pickInvisible),l.uniformMatrix4fv(this._uSceneWorldModelMatrix,!1,d),l.uniformMatrix4fv(this._uViewMatrix,!1,r),l.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);var b=2/(Math.log(e.pickZFar+1)/Math.LN2);l.uniform1f(this._uLogDepthBufFC,b);var w=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(w>0)for(var x=o._sectionPlanesState.sectionPlanes,P=t.layerIndex*B,C=s.renderFlags,M=0;M<w;M++){var F=this._uSectionPlanes[M];if(F)if(M<B){var k=C.sectionPlanesActivePerLayer[P+M];if(l.uniform1i(F.active,k?1:0),k){var E=x[M];if(c){var I=ei(E.dist,E.dir,c,nA,s.matrix);l.uniform3fv(F.pos,I)}else l.uniform3fv(F.pos,E.pos);l.uniform3fv(F.dir,E.dir)}}else l.uniform1i(F.active,0)}u.numIndices8Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),l.drawArrays(l.TRIANGLES,0,u.numIndices8Bits)),u.numIndices16Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),l.drawArrays(l.TRIANGLES,0,u.numIndices16Bits)),u.numIndices32Bits>0&&(A.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),l.drawArrays(l.TRIANGLES,0,u.numIndices32Bits)),e.drawElements++}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneWorldModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this._uVectorA=i.getLocation("uVectorAB"),this._uInverseVectorAB=i.getLocation("uInverseVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}}},{key:"_bindProgram",value:function(){this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uVectorAB;"),i.push("uniform vec2 uInverseVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uVectorAB.x) * uInverseVectorAB.x;"),i.push("    float y = (clipPos.y - uVectorAB.y) * uInverseVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  } else {"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, - uLayerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),AA=le.vec3(),cA=le.vec3(),hA=le.vec3();le.vec3();var dA=le.mat4(),pA=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=r.position,c=r.rotationMatrix,h=e.pickViewMatrix||s.viewMatrix;if(this._program||(this._allocate(t),!this.errors)){var d,p;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),u||0!==A[0]||0!==A[1]||0!==A[2]){var f=AA;if(u){var v=cA;le.transformPoint3(c,u,v),f[0]=v[0],f[1]=v[1],f[2]=v[2]}else f[0]=0,f[1]=0,f[2]=0;f[0]+=A[0],f[1]+=A[1],f[2]+=A[2],d=Jt(h,f,dA),(p=hA)[0]=s.eye[0]-f[0],p[1]=s.eye[1]-f[1],p[2]=s.eye[2]-f[2]}else d=h,p=s.eye;o.uniform3fv(this._uCameraEyeRtc,p),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uWorldMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uProjMatrix,!1,s.projMatrix);var g=n._sectionPlanesState.getNumAllocatedSectionPlanes(),m=n._sectionPlanesState.sectionPlanes.length;if(g>0)for(var _=n._sectionPlanesState.sectionPlanes,y=t.layerIndex*m,b=r.renderFlags,w=0;w<g;w++){var B=this._uSectionPlanes[w];if(B)if(w<m){var x=b.sectionPlanesActivePerLayer[y+w];if(o.uniform1i(B.active,x?1:0),x){var P=_[w];if(u){var C=ei(P.dist,P.dir,u,AA,r.matrix);o.uniform3fv(B.pos,C)}else o.uniform3fv(B.pos,P.pos);o.uniform3fv(B.dir,P.dir)}}else o.uniform1i(B.active,0)}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),o.drawArrays(o.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),o.drawArrays(o.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),o.drawArrays(o.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(){var e=this._scene;e.canvas.gl,e.camera.project,this._program.bind()}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureOcclusionRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  } else {"),i.push("      vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureColorRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0;r<e.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),fA=le.vec3(),vA=le.vec3(),gA=le.vec3();le.vec3();var mA=le.mat4(),_A=function(){function e(t){k(this,e),this._scene=t,this._allocate(),this._hash=this._getHash()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,s=t.model,o=r.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=s.position,c=s.rotationMatrix;if(this._program||(this._allocate(),!this.errors)){var h,d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var p=0!==u[0]||0!==u[1]||0!==u[2],f=0!==A[0]||0!==A[1]||0!==A[2];if(p||f){var v=fA;if(p){var g=le.transformPoint3(c,u,vA);v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=A[0],v[1]+=A[1],v[2]+=A[2],h=Jt(n.viewMatrix,v,mA),(d=gA)[0]=n.eye[0]-v[0],d[1]=n.eye[1]-v[1],d[2]=n.eye[2]-v[2]}else h=n.viewMatrix,d=n.eye;if(o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,h),o.uniformMatrix4fv(this._uProjMatrix,!1,n.projMatrix),o.uniform3fv(this._uCameraEyeRtc,d),o.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){var m=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,m)}var _=r._sectionPlanesState.getNumAllocatedSectionPlanes(),y=r._sectionPlanesState.sectionPlanes.length;if(_>0)for(var b=r._sectionPlanesState.sectionPlanes,w=t.layerIndex*y,B=s.renderFlags,x=0;x<_;x++){var P=this._uSectionPlanes[x];if(P)if(x<y){var C=B.sectionPlanesActivePerLayer[w+x];if(o.uniform1i(P.active,C?1:0),C){var M=b[x];if(u){var F=ei(M.dist,M.dir,u,fA,s.matrix);o.uniform3fv(P.pos,F)}else o.uniform3fv(P.pos,M.pos);o.uniform3fv(P.dir,M.dir)}}else o.uniform1i(P.active,0)}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),o.drawArrays(o.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),o.drawArrays(o.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),o.drawArrays(o.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t.camera.project;if(r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture draw vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out highp vec2 vHighPrecisionZW;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in highp vec2 vHighPrecisionZW;"),i.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),i.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),yA=le.vec3(),bA=le.vec3(),wA=le.vec3();le.vec3();var BA=le.mat4(),xA=function(){function e(t){k(this,e),this._scene=t,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){return this._scene._sectionPlanesState.getHash()}},{key:"drawLayer",value:function(e,t,i){var r=t.model,n=r.scene,s=n.camera,o=n.canvas.gl,a=t._state,l=t._state.origin,u=r.position,A=r.rotationMatrix,c=s.viewMatrix;if(this._program||(this._allocate(t),!this.errors)){var h,d;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t));var p=0!==l[0]||0!==l[1]||0!==l[2],f=0!==u[0]||0!==u[1]||0!==u[2];if(p||f){var v=yA;if(p){var g=bA;le.transformPoint3(A,l,g),v[0]=g[0],v[1]=g[1],v[2]=g[2]}else v[0]=0,v[1]=0,v[2]=0;v[0]+=u[0],v[1]+=u[1],v[2]+=u[2],h=Jt(c,v,BA),(d=wA)[0]=s.eye[0]-v[0],d[1]=s.eye[1]-v[1],d[2]=s.eye[2]-v[2]}else h=c,d=s.eye;o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uWorldMatrix,!1,A),o.uniformMatrix4fv(this._uViewMatrix,!1,h),o.uniformMatrix4fv(this._uProjMatrix,!1,s.projMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),o.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var m=n._sectionPlanesState.getNumAllocatedSectionPlanes(),_=n._sectionPlanesState.sectionPlanes.length;if(m>0)for(var y=n._sectionPlanesState.sectionPlanes,b=t.layerIndex*_,w=r.renderFlags,B=0;B<m;B++){var x=this._uSectionPlanes[B];if(x)if(B<_){var P=w.sectionPlanesActivePerLayer[b+B];if(o.uniform1i(x.active,P?1:0),P){var C=y[B];if(l){var M=ei(C.dist,C.dir,l,yA,r.matrix);o.uniform3fv(x.pos,M)}else o.uniform3fv(x.pos,C.pos);o.uniform3fv(x.dir,C.dir)}}else o.uniform1i(x.active,0)}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.objectDecodeAndInstanceMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),o.drawElements(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}}},{key:"_bindProgram",value:function(){var e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,r)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 objectDecodeAndInstanceMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(var r=0;r<e._sectionPlanesState.getNumAllocatedSectionPlanes();r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var n=0;n<e._sectionPlanesState.getNumAllocatedSectionPlanes();n++)i.push("      if (sectionPlaneActive"+n+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&Cr.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),PA=le.vec3(),CA=le.vec3(),MA=le.vec3();le.vec3(),le.vec4();var FA=le.mat4(),kA=function(){function e(t,i){k(this,e),this._scene=t,this._withSAO=i,this._hash=this._getHash(),this._allocate()}return I(e,[{key:"getValid",value:function(){return this._hash===this._getHash()}},{key:"_getHash",value:function(){var e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}},{key:"drawLayer",value:function(e,t,i){var r=this._scene,n=r.camera,s=t.model,o=r.canvas.gl,a=t._state,l=a.textureState,u=t._state.origin,A=s.position,c=s.rotationMatrix;if(this._program||(this._allocate(),!this.errors)){e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a));var h,d,p=e.pickViewMatrix||n.viewMatrix,f=e.pickProjMatrix||n.projMatrix,v=e.pickOrigin||n.eye,g=e.pickProjMatrix?e.pickZFar:n.project.far;l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);var m=0!==u[0]||0!==u[1]||0!==u[2],_=0!==A[0]||0!==A[1]||0!==A[2];if(m||_){var y=PA;if(m){var b=le.transformPoint3(c,u,CA);y[0]=b[0],y[1]=b[1],y[2]=b[2]}else y[0]=0,y[1]=0,y[2]=0;y[0]+=A[0],y[1]+=A[1],y[2]+=A[2],h=Jt(p,y,FA),(d=MA)[0]=v[0]-y[0],d[1]=v[1]-y[1],d[2]=v[2]-y[2]}else h=p,d=v;if(o.uniform2fv(this._uPickClipPos,e.pickClipPos),o.uniform2f(this._uDrawingBufferSize,o.drawingBufferWidth,o.drawingBufferHeight),o.uniformMatrix4fv(this._uSceneModelMatrix,!1,c),o.uniformMatrix4fv(this._uViewMatrix,!1,h),o.uniformMatrix4fv(this._uProjMatrix,!1,f),o.uniform3fv(this._uCameraEyeRtc,d),o.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){var w=2/(Math.log(g+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,w)}var B=r._sectionPlanesState.getNumAllocatedSectionPlanes(),x=r._sectionPlanesState.sectionPlanes.length;if(B>0)for(var P=r._sectionPlanesState.sectionPlanes,C=t.layerIndex*x,M=s.renderFlags,F=0;F<B;F++){var k=this._uSectionPlanes[F];if(k)if(F<x){var E=M.sectionPlanesActivePerLayer[C+F];if(o.uniform1i(k.active,E?1:0),E){var I=P[F];if(u){var T=ei(I.dist,I.dir,u,PA,s.matrix);o.uniform3fv(k.pos,T)}else o.uniform3fv(k.pos,I.pos);o.uniform3fv(k.dir,I.dir)}}else o.uniform1i(k.active,0)}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),o.drawArrays(o.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),o.drawArrays(o.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),o.drawArrays(o.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}}},{key:"_allocate",value:function(){var e=this._scene,t=e.canvas.gl;if(this._program=new Pr(t,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}}},{key:"_bindProgram",value:function(e){var t=this._scene,i=t.canvas.gl,r=this._program,n=t.camera.project;if(r.bind(),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(n.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}}},{key:"_buildShader",value:function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}},{key:"_buildVertexShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// trianglesDatatextureNormalsRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}},{key:"_buildFragmentShader",value:function(){var e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTexturePickNormalsRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),t){i.push("flat in uint vFlags2;");for(var r=0,n=e._sectionPlanesState.getNumAllocatedSectionPlanes();r<n;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("out highp ivec4 outNormal;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("  outNormal = ivec4(worldNormal * float(".concat(le.MAX_INT,"), 1.0);")),i.push("}"),i}},{key:"webglContextRestored",value:function(){this._program=null}},{key:"destroy",value:function(){this._program&&this._program.destroy(),this._program=null}}]),e}(),EA=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"_compile",value:function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}},{key:"eagerCreateRenders",value:function(){this._silhouetteRenderer||(this._silhouetteRenderer=new Tu(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Wu(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Yu(this._scene)),this._pickNormalsRenderer||(this._pickNormalsRenderer=new kA(this._scene)),this._snapRenderer||(this._snapRenderer=new rA(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new uA(this._scene)),this._snapRenderer||(this._snapRenderer=new rA(this._scene))}},{key:"colorRenderer",get:function(){return this._colorRenderer||(this._colorRenderer=new Cu(this._scene,!1)),this._colorRenderer}},{key:"colorRendererWithSAO",get:function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Cu(this._scene,!0)),this._colorRendererWithSAO}},{key:"colorQualityRendererWithSAO",get:function(){return this._colorQualityRendererWithSAO}},{key:"silhouetteRenderer",get:function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Tu(this._scene)),this._silhouetteRenderer}},{key:"depthRenderer",get:function(){return this._depthRenderer||(this._depthRenderer=new _A(this._scene)),this._depthRenderer}},{key:"normalsRenderer",get:function(){return this._normalsRenderer||(this._normalsRenderer=new xA(this._scene)),this._normalsRenderer}},{key:"edgesRenderer",get:function(){return this._edgesRenderer||(this._edgesRenderer=new Lu(this._scene)),this._edgesRenderer}},{key:"edgesColorRenderer",get:function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Qu(this._scene)),this._edgesColorRenderer}},{key:"pickMeshRenderer",get:function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Wu(this._scene)),this._pickMeshRenderer}},{key:"pickNormalsRenderer",get:function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new kA(this._scene)),this._pickNormalsRenderer}},{key:"pickNormalsFlatRenderer",get:function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new kA(this._scene)),this._pickNormalsFlatRenderer}},{key:"pickDepthRenderer",get:function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Yu(this._scene)),this._pickDepthRenderer}},{key:"snapRenderer",get:function(){return this._snapRenderer||(this._snapRenderer=new rA(this._scene)),this._snapRenderer}},{key:"snapInitRenderer",get:function(){return this._snapInitRenderer||(this._snapInitRenderer=new uA(this._scene)),this._snapInitRenderer}},{key:"occlusionRenderer",get:function(){return this._occlusionRenderer||(this._occlusionRenderer=new pA(this._scene)),this._occlusionRenderer}},{key:"_destroy",value:function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}]),e}(),IA={};var TA=I((function e(){k(this,e),this.positionsCompressed=[],this.lenPositionsCompressed=0,this.metallicRoughness=[],this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.edgeIndices8Bits=[],this.lenEdgeIndices8Bits=0,this.edgeIndices16Bits=[],this.lenEdgeIndices16Bits=0,this.edgeIndices32Bits=[],this.lenEdgeIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]})),DA=function(){function e(){k(this,e),this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureModelMatrices=null}return I(e,[{key:"finalize",value:function(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}},{key:"bindCommonTextures",value:function(e,t,i,r,n){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,r,3),this.texturePerObjectInstanceMatrices.bindTexture(e,n,4)}},{key:"bindTriangleIndicesTextures",value:function(e,t,i,r){this.indicesPortionIdsPerBitnessTextures[r].bindTexture(e,t,5),this.indicesPerBitnessTextures[r].bindTexture(e,i,6)}},{key:"bindEdgeIndicesTextures",value:function(e,t,i,r){this.edgeIndicesPortionIdsPerBitnessTextures[r].bindTexture(e,t,5),this.edgeIndicesPerBitnessTextures[r].bindTexture(e,i,6)}}]),e}(),SA={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(SA,null,4));var e=0;Object.keys(SA).forEach((function(t){t.startsWith("size")&&(e+=SA[t])})),console.log("Total size ".concat(e," bytes (").concat((e/1e3/1e3).toFixed(2)," MB)")),console.log("Avg bytes / triangle: ".concat((e/SA.totalPolygons).toFixed(2)));var t={};Object.keys(SA).forEach((function(i){i.startsWith("size")&&(t[i]="".concat((SA[i]/e*100).toFixed(2)," % of total"))})),console.log(JSON.stringify({percentualRamUsage:t},null,4))};var RA=function(){function e(){k(this,e)}return I(e,[{key:"disableBindedTextureFiltering",value:function(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}},{key:"createTextureForColorsAndFlags",value:function(e,t,i,r,n,s,o){var a=t.length;this.numPortions=a;var l=4096,u=Math.ceil(a/512);if(0===u)throw"texture height===0";var A=new Uint8Array(16384*u);SA.sizeDataColorsAndFlags+=A.byteLength,SA.numberOfTextures++;for(var c=0;c<a;c++)A.set(t[c],32*c+0),A.set(i[c],32*c+4),A.set([0,0,0,0],32*c+8),A.set([0,0,0,0],32*c+12),A.set([r[c]>>24&255,r[c]>>16&255,r[c]>>8&255,255&r[c]],32*c+16),A.set([n[c]>>24&255,n[c]>>16&255,n[c]>>8&255,255&n[c]],32*c+20),A.set([s[c]>>24&255,s[c]>>16&255,s[c]>>8&255,255&s[c]],32*c+24),A.set([o[c]?1:0,0,0,0],32*c+28);var h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,l,u),e.texSubImage2D(e.TEXTURE_2D,0,0,0,l,u,e.RGBA_INTEGER,e.UNSIGNED_BYTE,A,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,h,l,u,A)}},{key:"createTextureForObjectOffsets",value:function(e,t){var i=512,r=Math.ceil(t/i);if(0===r)throw"texture height===0";var n=new Float32Array(1536*r).fill(0);SA.sizeDataTextureOffsets+=n.byteLength,SA.numberOfTextures++;var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,s,i,r,n)}},{key:"createTextureForInstancingMatrices",value:function(e,t){var i=t.length;if(0===i)throw"num instance matrices===0";var r=2048,n=Math.ceil(i/512),s=new Float32Array(8192*n);SA.numberOfTextures++;for(var o=0;o<t.length;o++)s.set(t[o],16*o);var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGBA,e.FLOAT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,a,r,n,s)}},{key:"createTextureForPositionsDecodeMatrices",value:function(e,t){var i=t.length;if(0===i)throw"num decode+entity matrices===0";var r=2048,n=Math.ceil(i/512),s=new Float32Array(8192*n);SA.sizeDataPositionDecodeMatrices+=s.byteLength,SA.numberOfTextures++;for(var o=0;o<t.length;o++)s.set(t[o],16*o);var a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGBA,e.FLOAT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,a,r,n)}},{key:"createTextureFor8BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint8Array(r*n*3);SA.sizeDataTextureIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_BYTE,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureFor16BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint16Array(r*n*3);SA.sizeDataTextureIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_SHORT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureFor32BitIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/3/r);if(0===n)throw"texture height===0";var s=new Uint32Array(r*n*3);SA.sizeDataTextureIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RGB_INTEGER,e.UNSIGNED_INT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureFor8BitsEdgeIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/2/r);if(0===n)throw"texture height===0";var s=new Uint8Array(r*n*2);SA.sizeDataTextureEdgeIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RG_INTEGER,e.UNSIGNED_BYTE,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureFor16BitsEdgeIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/2/r);if(0===n)throw"texture height===0";var s=new Uint16Array(r*n*2);SA.sizeDataTextureEdgeIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RG_INTEGER,e.UNSIGNED_SHORT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureFor32BitsEdgeIndices",value:function(e,t,i){if(0===i)return{texture:null,textureHeight:0};var r=4096,n=Math.ceil(i/2/r);if(0===n)throw"texture height===0";var s=new Uint32Array(r*n*2);SA.sizeDataTextureEdgeIndices+=s.byteLength,SA.numberOfTextures++;for(var o=0,a=0,l=t.length;o<l;o++){var u=t[o];s.set(u,a),a+=u.length}var A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RG_INTEGER,e.UNSIGNED_INT,s,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Au(e,A,r,n)}},{key:"createTextureForPositions",value:function(e,t,i){var r=i/3,n=4096,s=Math.ceil(r/n);if(0===s)throw"texture height===0";var o=new Uint16Array(n*s*3);SA.sizeDataTexturePositions+=o.byteLength,SA.numberOfTextures++;for(var a=0,l=0,u=t.length;a<u;a++){var A=t[a];o.set(A,l),l+=A.length}var c=e.createTexture();return e.bindTexture(e.TEXTURE_2D,c),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,n,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,n,s,e.RGB_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,c,n,s)}},{key:"createTextureForPackedPortionIds",value:function(e,t){if(0===t.length)return{texture:null,textureHeight:0};var i=t.length,r=4096,n=Math.ceil(i/r);if(0===n)throw"texture height===0";var s=new Uint16Array(r*n);s.set(t,0),SA.sizeDataTexturePortionIds+=s.byteLength,SA.numberOfTextures++;var o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,r,n),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,n,e.RED_INTEGER,e.UNSIGNED_SHORT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Au(e,o,r,n)}}]),e}(),UA=new po,LA=UA.maxDataTextureHeight,OA=le.vec4(),NA=new Float32Array(16),VA=new Uint8Array(4),QA=new Float32Array(3),HA=0,GA=le.identityMat4(),jA=function(){function e(t,i){var r,n,s;k(this,e),SA.numberOfLayers++,this._layerNumber=HA++,this.sortId="TriDTX-".concat(this._layerNumber),this.layerIndex=i.layerIndex,this._renderers=(r=t.scene,n=r.id,(s=IA[n])||(s=new EA(r),IA[n]=s,s._compile(),s.eagerCreateRenders(),r.on("compile",(function(){s._compile(),s.eagerCreateRenders()})),r.on("destroyed",(function(){delete IA[n],s._destroy()}))),s),this.model=t,this._buffer=new TA,this._dtxState=new DA,this._dtxTextureFactory=new RA,this._state=new nt({origin:le.vec3(i.origin),metallicRoughnessBuf:null,textureState:this._dtxState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries={}),this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=le.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=i.primitive,this._finalized=!1}return I(e,[{key:"aabb",get:function(){if(this.aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._meshes.length;e<t;e++)le.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}},{key:"canCreatePortion",value:function(e){if(this._finalized)throw"Already finalized";var t=e.buckets.length;this._numPortions+t>65536&&SA.cannotCreatePortion.because10BitsObjectId++;var i=this._numPortions+t<=65536,r=void 0!==e.geometryId&&null!==e.geometryId?"".concat(e.geometryId,"#").concat(0):"".concat(e.id,"#").concat(0);if(!this._bucketGeometries[r]){var n=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits),s=0,o=0;e.buckets.forEach((function(e){s+=e.positionsCompressed.length/3,o+=e.indices.length/3})),(this._state.numVertices+s>4096*LA||n+o>4096*LA)&&SA.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+s<=4096*LA&&n+o<=4096*LA)}return i}},{key:"createPortion",value:function(e,t){var i=this;if(this._finalized)throw"Already finalized";var r=[];t.buckets.forEach((function(e,n){var s=void 0!==t.geometryId&&null!==t.geometryId?"".concat(t.geometryId,"#").concat(n):"".concat(t.id,"#").concat(n),o=i._bucketGeometries[s];o||(o=i._createBucketGeometry(t,e),i._bucketGeometries[s]=o);var a=i._createSubPortion(t,o,e);r.push(a)}));var n=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(r),this.model.numPortions++,this._meshes.push(e),n}},{key:"_createBucketGeometry",value:function(e,t){if(t.indices){var i=8*Math.ceil(t.indices.length/3/8)*3;SA.overheadSizeAlignementIndices+=2*(i-t.indices.length);var r=new Uint32Array(i);r.fill(0),r.set(t.indices),t.indices=r}if(t.edgeIndices){var n=8*Math.ceil(t.edgeIndices.length/2/8)*2;SA.overheadSizeAlignementEdgeIndices+=2*(n-t.edgeIndices.length);var s=new Uint32Array(n);s.fill(0),s.set(t.edgeIndices),t.edgeIndices=s}var o=t.positionsCompressed,a=t.indices,l=t.edgeIndices,u=this._buffer;u.positionsCompressed.push(o);var A,c=u.lenPositionsCompressed/3,h=o.length/3;u.lenPositionsCompressed+=o.length;var d,p,f=0;a&&(f=a.length/3,h<=256?(d=u.indices8Bits,A=u.lenIndices8Bits/3,u.lenIndices8Bits+=a.length):h<=65536?(d=u.indices16Bits,A=u.lenIndices16Bits/3,u.lenIndices16Bits+=a.length):(d=u.indices32Bits,A=u.lenIndices32Bits/3,u.lenIndices32Bits+=a.length),d.push(a));var v,g=0;l&&(g=l.length/2,h<=256?(v=u.edgeIndices8Bits,p=u.lenEdgeIndices8Bits/2,u.lenEdgeIndices8Bits+=l.length):h<=65536?(v=u.edgeIndices16Bits,p=u.lenEdgeIndices16Bits/2,u.lenEdgeIndices16Bits+=l.length):(v=u.edgeIndices32Bits,p=u.lenEdgeIndices32Bits/2,u.lenEdgeIndices32Bits+=l.length),v.push(l));return this._state.numVertices+=h,SA.numberOfGeometries++,{vertexBase:c,numVertices:h,numTriangles:f,numEdges:g,indicesBase:A,edgeIndicesBase:p}}},{key:"_createSubPortion",value:function(e,t,i,r){var n=e.color;e.metallic,e.roughness;var s,o,a=e.colors,l=e.opacity,u=e.meshMatrix,A=e.pickColor,c=this._buffer,h=this._state;c.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),c.perObjectInstancePositioningMatrices.push(u||GA),c.perObjectSolid.push(!!e.solid),a?c.perObjectColors.push([255*a[0],255*a[1],255*a[2],255]):n&&c.perObjectColors.push([n[0],n[1],n[2],l]),c.perObjectPickColors.push(A),c.perObjectVertexBases.push(t.vertexBase),s=t.numVertices<=256?h.numIndices8Bits:t.numVertices<=65536?h.numIndices16Bits:h.numIndices32Bits,c.perObjectIndexBaseOffsets.push(s/3-t.indicesBase),o=t.numVertices<=256?h.numEdgeIndices8Bits:t.numVertices<=65536?h.numEdgeIndices16Bits:h.numEdgeIndices32Bits,c.perObjectEdgeIndexBaseOffsets.push(o/2-t.edgeIndicesBase);var d=this._subPortions.length;if(t.numTriangles>0){var p,f=3*t.numTriangles;t.numVertices<=256?(p=c.perTriangleNumberPortionId8Bits,h.numIndices8Bits+=f,SA.totalPolygons8Bits+=t.numTriangles):t.numVertices<=65536?(p=c.perTriangleNumberPortionId16Bits,h.numIndices16Bits+=f,SA.totalPolygons16Bits+=t.numTriangles):(p=c.perTriangleNumberPortionId32Bits,h.numIndices32Bits+=f,SA.totalPolygons32Bits+=t.numTriangles),SA.totalPolygons+=t.numTriangles;for(var v=0;v<t.numTriangles;v+=8)p.push(d)}if(t.numEdges>0){var g,m=2*t.numEdges;t.numVertices<=256?(g=c.perEdgeNumberPortionId8Bits,h.numEdgeIndices8Bits+=m,SA.totalEdges8Bits+=t.numEdges):t.numVertices<=65536?(g=c.perEdgeNumberPortionId16Bits,h.numEdgeIndices16Bits+=m,SA.totalEdges16Bits+=t.numEdges):(g=c.perEdgeNumberPortionId32Bits,h.numEdgeIndices32Bits+=m,SA.totalEdges32Bits+=t.numEdges),SA.totalEdges+=t.numEdges;for(var _=0;_<t.numEdges;_+=8)g.push(d)}return this._subPortions.push({numVertices:t.numTriangles}),this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries[d]={indices:i.indices,positionsCompressed:i.positionsCompressed,positionsDecodeMatrix:e.positionsDecodeMatrix,meshMatrix:e.meshMatrix}),this._numPortions++,SA.numberOfPortions++,d}},{key:"finalize",value:function(){var e=this;if(!this._finalized){var t=this._state,i=this._dtxState,r=this.model.scene.canvas.gl,n=this._buffer;t.gl=r,i.texturePerObjectColorsAndFlags=this._dtxTextureFactory.createTextureForColorsAndFlags(r,n.perObjectColors,n.perObjectPickColors,n.perObjectVertexBases,n.perObjectIndexBaseOffsets,n.perObjectEdgeIndexBaseOffsets,n.perObjectSolid),i.texturePerObjectInstanceMatrices=this._dtxTextureFactory.createTextureForInstancingMatrices(r,n.perObjectInstancePositioningMatrices),i.texturePerObjectPositionsDecodeMatrix=this._dtxTextureFactory.createTextureForPositionsDecodeMatrices(r,n.perObjectPositionsDecodeMatrices),i.texturePerVertexIdCoordinates=this._dtxTextureFactory.createTextureForPositions(r,n.positionsCompressed,n.lenPositionsCompressed),i.texturePerPolygonIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perTriangleNumberPortionId8Bits),i.texturePerPolygonIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perTriangleNumberPortionId16Bits),i.texturePerPolygonIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perTriangleNumberPortionId32Bits),n.perEdgeNumberPortionId8Bits.length>0&&(i.texturePerEdgeIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perEdgeNumberPortionId8Bits)),n.perEdgeNumberPortionId16Bits.length>0&&(i.texturePerEdgeIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perEdgeNumberPortionId16Bits)),n.perEdgeNumberPortionId32Bits.length>0&&(i.texturePerEdgeIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(r,n.perEdgeNumberPortionId32Bits)),n.lenIndices8Bits>0&&(i.texturePerPolygonIdIndices8Bits=this._dtxTextureFactory.createTextureFor8BitIndices(r,n.indices8Bits,n.lenIndices8Bits)),n.lenIndices16Bits>0&&(i.texturePerPolygonIdIndices16Bits=this._dtxTextureFactory.createTextureFor16BitIndices(r,n.indices16Bits,n.lenIndices16Bits)),n.lenIndices32Bits>0&&(i.texturePerPolygonIdIndices32Bits=this._dtxTextureFactory.createTextureFor32BitIndices(r,n.indices32Bits,n.lenIndices32Bits)),n.lenEdgeIndices8Bits>0&&(i.texturePerPolygonIdEdgeIndices8Bits=this._dtxTextureFactory.createTextureFor8BitsEdgeIndices(r,n.edgeIndices8Bits,n.lenEdgeIndices8Bits)),n.lenEdgeIndices16Bits>0&&(i.texturePerPolygonIdEdgeIndices16Bits=this._dtxTextureFactory.createTextureFor16BitsEdgeIndices(r,n.edgeIndices16Bits,n.lenEdgeIndices16Bits)),n.lenEdgeIndices32Bits>0&&(i.texturePerPolygonIdEdgeIndices32Bits=this._dtxTextureFactory.createTextureFor32BitsEdgeIndices(r,n.edgeIndices32Bits,n.lenEdgeIndices32Bits)),i.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",(function(){e._deferredSetFlagsDirty&&e._uploadDeferredFlags(),e._numUpdatesInFrame=0}))}}},{key:"isEmpty",value:function(){return 0===this._numPortions}},{key:"initFlags",value:function(e,t,i){t&gs&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Bs&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&ws&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&xs&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&ys&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Ps&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&_s&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&ms&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}},{key:"flushInitFlags",value:function(){this._setDeferredFlags(),this._setDeferredFlags2()}},{key:"setVisible",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&gs?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}},{key:"setHighlighted",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Bs?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}},{key:"setXRayed",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ws?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}},{key:"setSelected",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&xs?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}},{key:"setEdges",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&Ps?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}},{key:"setClippable",value:function(e,t){if(!this._finalized)throw"Not finalized";t&ys?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}},{key:"_beginDeferredFlags",value:function(){this._deferredSetFlagsActive=!0}},{key:"_uploadDeferredFlags",value:function(){if(this._deferredSetFlagsActive=!1,this._deferredSetFlagsDirty){this._deferredSetFlagsDirty=!1;var e=this.model.scene.canvas.gl,t=this._dtxState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}}},{key:"setCulled",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&ms?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}},{key:"setCollidable",value:function(e,t){if(!this._finalized)throw"Not finalized"}},{key:"setPickable",value:function(e,t,i){if(!this._finalized)throw"Not finalized";t&_s?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}},{key:"setColor",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetColor(i[r],t)}},{key:"_subPortionSetColor",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dtxState,r=this.model.scene.canvas.gl;VA[0]=t[0],VA[1]=t[1],VA[2]=t[2],VA[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(VA,32*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),r.texSubImage2D(r.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,r.RGBA_INTEGER,r.UNSIGNED_BYTE,VA))}},{key:"setTransparent",value:function(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}},{key:"_setFlags",value:function(e,t,i){for(var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=this._portionToSubPortionsMap[e],s=0,o=n.length;s<o;s++)this._subPortionSetFlags(n[s],t,i,r)}},{key:"_subPortionSetFlags",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this._finalized)throw"Not finalized";var n,s,o=!!(t&gs),a=!!(t&ws),l=!!(t&Bs),u=!!(t&xs),A=!!(t&Ps),c=!!(t&_s),h=!!(t&ms);n=!o||h||a||l&&!this.model.scene.highlightMaterial.glowThrough||u&&!this.model.scene.selectedMaterial.glowThrough?Cs.NOT_RENDERED:i?Cs.COLOR_TRANSPARENT:Cs.COLOR_OPAQUE,s=!o||h?Cs.NOT_RENDERED:u?Cs.SILHOUETTE_SELECTED:l?Cs.SILHOUETTE_HIGHLIGHTED:a?Cs.SILHOUETTE_XRAYED:Cs.NOT_RENDERED;var d=0;d=!o||h?Cs.NOT_RENDERED:u?Cs.EDGES_SELECTED:l?Cs.EDGES_HIGHLIGHTED:a?Cs.EDGES_XRAYED:A?i?Cs.EDGES_COLOR_TRANSPARENT:Cs.EDGES_COLOR_OPAQUE:Cs.NOT_RENDERED;var p=o&&!h&&c?Cs.PICK:Cs.NOT_RENDERED,f=this._dtxState,v=this.model.scene.canvas.gl;VA[0]=n,VA[1]=s,VA[2]=d,VA[3]=p,f.texturePerObjectColorsAndFlags._textureData.set(VA,32*e+8),this._deferredSetFlagsActive||r?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),v.bindTexture(v.TEXTURE_2D,f.texturePerObjectColorsAndFlags._texture),v.texSubImage2D(v.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,v.RGBA_INTEGER,v.UNSIGNED_BYTE,VA))}},{key:"_setDeferredFlags",value:function(){}},{key:"_setFlags2",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this._portionToSubPortionsMap[e],n=0,s=r.length;n<s;n++)this._subPortionSetFlags2(r[n],t,i)}},{key:"_subPortionSetFlags2",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._finalized)throw"Not finalized";var r=t&ys?255:0,n=this._dtxState,s=this.model.scene.canvas.gl;VA[0]=r,VA[1]=0,VA[2]=1,VA[3]=2,n.texturePerObjectColorsAndFlags._textureData.set(VA,32*e+12),this._deferredSetFlagsActive||i?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,n.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,VA))}},{key:"_setDeferredFlags2",value:function(){}},{key:"setOffset",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetOffset(i[r],t)}},{key:"_subPortionSetOffset",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dtxState,r=this.model.scene.canvas.gl;QA[0]=t[0],QA[1]=t[1],QA[2]=t[2],i.texturePerObjectOffsets._textureData.set(QA,3*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectOffsets._texture),r.texSubImage2D(r.TEXTURE_2D,0,0,e,1,1,r.RGB,r.FLOAT,QA))}},{key:"setMatrix",value:function(e,t){for(var i=this._portionToSubPortionsMap[e],r=0,n=i.length;r<n;r++)this._subPortionSetMatrix(i[r],t)}},{key:"_subPortionSetMatrix",value:function(e,t){if(!this._finalized)throw"Not finalized";var i=this._dtxState,r=this.model.scene.canvas.gl;NA.set(t),i.texturePerObjectInstanceMatrices._textureData.set(NA,16*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),r.bindTexture(r.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),r.texSubImage2D(r.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,r.RGBA,r.FLOAT,NA))}},{key:"getEachVertex",value:function(e,t){if(this.model.scene.readableGeometryEnabled){var i=this._state,r=this._portionToSubPortionsMap[e];if(r)for(var n=0,s=r.length;n<s;n++){var o=r[n],a=this._subPortionReadableGeometries[o],l=a.positionsCompressed,u=a.positionsDecodeMatrix;a.meshMatrix;for(var A=i.origin,c=A[0],h=A[1],d=A[2],p=OA,f=0,v=l.length;f<v;f+=3)p[0]=l[f],p[1]=l[f+1],p[2]=l[f+2],p[3]=1,le.decompressPosition(p,u),le.mulMat4v4(this.model.worldMatrix,p,p),p[0]+=c,p[1]+=h,p[2]+=d,t(p)}else this.model.error("portion not found: "+e)}}},{key:"getEachIndex",value:function(e,t){if(this.model.scene.readableGeometryEnabled){var i=this._portionToSubPortionsMap[e];if(i)for(var r=0,n=i.length;r<n;r++)for(var s=i[r],o=this._subPortionReadableGeometries[s].indices,a=0,l=o.length;a<l;a++)t(o[a]);else this.model.error("portion not found: "+e)}}},{key:"drawColorOpaque",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Cs.COLOR_OPAQUE):this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"_updateBackfaceCull",value:function(e,t){if(true!==t.backfaces){var i=t.gl;i.disable(i.CULL_FACE),t.backfaces=true}}},{key:"drawColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Cs.COLOR_TRANSPARENT))}},{key:"drawDepth",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawSilhouetteXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_XRAYED))}},{key:"drawSilhouetteHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_HIGHLIGHTED))}},{key:"drawSilhouetteSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Cs.SILHOUETTE_SELECTED))}},{key:"drawEdgesColorOpaque",value:function(e,t){this.model.scene.logarithmicDepthBufferEnabled?this.model.scene._loggedWarning||(console.log("Edge enhancement for SceneModel data texture layers currently disabled with logarithmic depth buffer"),this.model.scene._loggedWarning=!0):this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_OPAQUE)}},{key:"drawEdgesColorTransparent",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Cs.EDGES_COLOR_TRANSPARENT)}},{key:"drawEdgesHighlighted",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_HIGHLIGHTED)}},{key:"drawEdgesSelected",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_SELECTED)}},{key:"drawEdgesXRayed",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Cs.EDGES_XRAYED)}},{key:"drawOcclusion",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"drawShadow",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Cs.COLOR_OPAQUE))}},{key:"setPickMatrices",value:function(e,t){}},{key:"drawPickMesh",value:function(e,t){0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickDepths",value:function(e,t){0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnapInit",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawSnap",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Cs.PICK))}},{key:"drawPickNormals",value:function(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsRenderer&&this._renderers.pickNormalsRenderer.drawLayer(t,this,Cs.PICK))}},{key:"destroy",value:function(){if(!this._destroyed){var e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}}]),e}(),zA=function(){function e(t){k(this,e),this.id=t.id,this.colorTexture=t.colorTexture,this.alphaCutoff=t.alphaCutoff,this.metallicRoughnessTexture=t.metallicRoughnessTexture,this.normalsTexture=t.normalsTexture,this.emissiveTexture=t.emissiveTexture,this.occlusionTexture=t.occlusionTexture}return I(e,[{key:"destroy",value:function(){}}]),e}(),WA=function(){function e(t){k(this,e),this.id=t.id,this.texture=t.texture}return I(e,[{key:"destroy",value:function(){this.texture&&(this.texture.destroy(),this.texture=null)}}]),e}(),XA={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},KA=function(){function e(t,i,r){k(this,e),this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=t,this.onProgress=i,this.onError=r}return I(e,[{key:"itemStart",value:function(e){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}},{key:"itemEnd",value:function(e){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())}},{key:"itemError",value:function(e){void 0!==this.onError&&this.onError(e)}},{key:"resolveURL",value:function(e){return this.urlModifier?this.urlModifier(e):e}},{key:"setURLModifier",value:function(e){return this.urlModifier=e,this}},{key:"addHandler",value:function(e,t){return this.handlers.push(e,t),this}},{key:"removeHandler",value:function(e){var t=this.handlers.indexOf(e);return-1!==t&&this.handlers.splice(t,2),this}},{key:"getHandler",value:function(e){for(var t=0,i=this.handlers.length;t<i;t+=2){var r=this.handlers[t],n=this.handlers[t+1];if(r.global&&(r.lastIndex=0),r.test(e))return n}return null}}]),e}(),ZA=new KA,JA=function(){function e(t){k(this,e),this.manager=void 0!==t?t:ZA,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}return I(e,[{key:"load",value:function(){}},{key:"loadAsync",value:function(e,t){var i=this;return new Promise((function(r,n){i.load(e,r,t,n)}))}},{key:"parse",value:function(){}},{key:"setCrossOrigin",value:function(e){return this.crossOrigin=e,this}},{key:"setWithCredentials",value:function(e){return this.withCredentials=e,this}},{key:"setPath",value:function(e){return this.path=e,this}},{key:"setResourcePath",value:function(e){return this.resourcePath=e,this}},{key:"setRequestHeader",value:function(e){return this.requestHeader=e,this}}]),e}(),YA={},qA=function(e){m(i,JA);var t=y(i);function i(e){return k(this,i),t.call(this,e)}return I(i,[{key:"load",value:function(e,t,i,r){var n=this;void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var s=XA.get(e);if(void 0!==s)return this.manager.itemStart(e),Fe.scheduleTask((function(){t&&t(s),n.manager.itemEnd(e)}),0),s;if(void 0===YA[e]){YA[e]=[],YA[e].push({onLoad:t,onProgress:i,onError:r});var o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,l=this.responseType;fetch(o).then((function(t){if(200===t.status||0===t.status){if(0===t.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body.getReader)return t;var i=YA[e],r=t.body.getReader(),n=t.headers.get("Content-Length"),s=n?parseInt(n):0,o=0!==s,a=0,l=new ReadableStream({start:function(e){!function t(){r.read().then((function(r){var n=r.done,l=r.value;if(n)e.close();else{a+=l.byteLength;for(var u=new ProgressEvent("progress",{lengthComputable:o,loaded:a,total:s}),A=0,c=i.length;A<c;A++){var h=i[A];h.onProgress&&h.onProgress(u)}e.enqueue(l),t()}}))}()}});return new Response(l)}throw Error('fetch for "'.concat(t.url,'" responded with ').concat(t.status,": ").concat(t.statusText))})).then((function(e){switch(l){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((function(e){return(new DOMParser).parseFromString(e,a)}));case"json":return e.json();default:if(void 0===a)return e.text();var t=/charset="?([^;"\s]*)"?/i.exec(a),i=t&&t[1]?t[1].toLowerCase():void 0,r=new TextDecoder(i);return e.arrayBuffer().then((function(e){return r.decode(e)}))}})).then((function(t){XA.add(e,t);var i=YA[e];delete YA[e];for(var r=0,n=i.length;r<n;r++){var s=i[r];s.onLoad&&s.onLoad(t)}})).catch((function(t){var i=YA[e];if(void 0===i)throw n.manager.itemError(e),t;delete YA[e];for(var r=0,s=i.length;r<s;r++){var o=i[r];o.onError&&o.onError(t)}n.manager.itemError(e)})).finally((function(){n.manager.itemEnd(e)})),this.manager.itemStart(e)}else YA[e].push({onLoad:t,onProgress:i,onError:r})}},{key:"setResponseType",value:function(e){return this.responseType=e,this}},{key:"setMimeType",value:function(e){return this.mimeType=e,this}}]),i}(),$A=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;k(this,e),this.pool=t,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}return I(e,[{key:"_initWorker",value:function(e){if(!this.workers[e]){var t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}},{key:"_getIdleWorker",value:function(){for(var e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}},{key:"_onMessage",value:function(e,t){var i=this.workersResolve[e];if(i&&i(t),this.queue.length){var r=this.queue.shift(),n=r.resolve,s=r.msg,o=r.transfer;this.workersResolve[e]=n,this.workers[e].postMessage(s,o)}else this.workerStatus^=1<<e}},{key:"setWorkerCreator",value:function(e){this.workerCreator=e}},{key:"setWorkerLimit",value:function(e){this.pool=e}},{key:"postMessage",value:function(e,t){var i=this;return new Promise((function(r){var n=i._getIdleWorker();-1!==n?(i._initWorker(n),i.workerStatus|=1<<n,i.workersResolve[n]=r,i.workers[n].postMessage(e,t)):i.queue.push({resolve:r,msg:e,transfer:t})}))}},{key:"destroy",value:function(){this.workers.forEach((function(e){return e.terminate()})),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}]),e}(),ec=0,tc=function(){function e(t){var i=t.viewer,r=t.transcoderPath,n=t.workerLimit;k(this,e),this._transcoderPath=r||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new $A,this._workerSourceURL="",n&&this._workerPool.setWorkerLimit(n);var s=i.capabilities;this._workerConfig={astcSupported:s.astcSupported,etc1Supported:s.etc1Supported,etc2Supported:s.etc2Supported,dxtSupported:s.dxtSupported,bptcSupported:s.bptcSupported,pvrtcSupported:s.pvrtcSupported},this._supportedFileTypes=["xkt2"]}return I(e,[{key:"_init",value:function(){var t=this;if(!this._transcoderPending){var i=new qA;i.setPath(this._transcoderPath),i.setWithCredentials(this.withCredentials);var r=i.loadAsync("basis_transcoder.js"),n=new qA;n.setPath(this._transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);var s=n.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([r,s]).then((function(i){var r=C(i,2),n=r[0],s=r[1],o=e.BasisWorker.toString(),a=["/* constants */","let _EngineFormat = "+JSON.stringify(e.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(e.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(e.BasisFormat),"/* basis_transcoder.js */",n,"/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join("\n");t._workerSourceURL=URL.createObjectURL(new Blob([a])),t._transcoderBinary=s,t._workerPool.setWorkerCreator((function(){var e=new Worker(t._workerSourceURL),i=t._transcoderBinary.slice(0);return e.postMessage({type:"init",config:t._workerConfig,transcoderBinary:i},[i]),e}))})),ec>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),ec++}return this._transcoderPending}},{key:"transcode",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise((function(n,s){var o=r;i._init().then((function(){return i._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:o},e)})).then((function(e){var i=e.data,r=i.mipmaps,o=(i.width,i.height,i.format),a=i.type,l=i.error,u=i.dfdTransferFn,A=i.dfdFlags;if("error"===a)return s(l);t.setCompressedData({mipmaps:r,props:{format:o,minFilter:1===r.length?1006:1008,magFilter:1===r.length?1006:1008,encoding:2===u?3001:3e3,premultiplyAlpha:!!(1&A)}}),n()}))}))}},{key:"destroy",value:function(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),ec--}}]),e}();tc.BasisFormat={ETC1S:0,UASTC_4x4:1},tc.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},tc.EngineFormat={RGBAFormat:1023,RGBA_ASTC_4x4_Format:37808,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:37496,RGBA_PVRTC_4BPPV1_Format:35842,RGBA_S3TC_DXT5_Format:33779,RGB_ETC1_Format:36196,RGB_ETC2_Format:37492,RGB_PVRTC_4BPPV1_Format:35840,RGB_S3TC_DXT1_Format:33776},tc.BasisWorker=function(){var e,t,i,r=_EngineFormat,n=_TranscoderFormat,s=_BasisFormat;self.addEventListener("message",(function(o){var A,c=o.data;switch(c.type){case"init":e=c.config,A=c.transcoderBinary,t=new Promise((function(e){i={wasmBinary:A,onRuntimeInitialized:e},BASIS(i)})).then((function(){i.initializeBasis(),void 0===i.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((function(){try{for(var t=function(t){var o=new i.KTX2File(new Uint8Array(t));function A(){o.close(),o.delete()}if(!o.isValid())throw A(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");var c=o.isUASTC()?s.UASTC_4x4:s.ETC1S,h=o.getWidth(),d=o.getHeight(),p=o.getLevels(),f=o.getHasAlpha(),v=o.getDFDTransferFunc(),g=o.getDFDFlags(),m=function(t,i,o,A){for(var c,h,d=t===s.ETC1S?a:l,p=0;p<d.length;p++){var f=d[p];if(e[f.if]&&(f.basisFormat.includes(t)&&!(A&&f.transcoderFormat.length<2)&&(!f.needsPowerOfTwo||u(i)&&u(o))))return{transcoderFormat:c=f.transcoderFormat[A?1:0],engineFormat:h=f.engineFormat[A?1:0]}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),c=n.RGBA32,h=r.RGBAFormat,{transcoderFormat:c,engineFormat:h}}(c,h,d,f),_=m.transcoderFormat,y=m.engineFormat;if(!h||!d||!p)throw A(),new Error("KTX2TextureTranscoder: Invalid texture");if(!o.startTranscoding())throw A(),new Error("KTX2TextureTranscoder: .startTranscoding failed");for(var b=[],w=0;w<p;w++){var B=o.getImageLevelInfo(w,0,0),x=B.origWidth,P=B.origHeight,C=new Uint8Array(o.getImageTranscodedSizeInBytes(w,0,0,_));if(!o.transcodeImage(C,w,0,0,_,0,-1,-1))throw A(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");b.push({data:C,width:x,height:P})}return A(),{width:h,height:d,hasAlpha:f,mipmaps:b,format:y,dfdTransferFn:v,dfdFlags:g}}(c.buffers[0]),o=t.width,A=t.height,h=t.hasAlpha,d=t.mipmaps,p=t.format,f=t.dfdTransferFn,v=t.dfdFlags,g=[],m=0;m<d.length;++m)g.push(d[m].data.buffer);self.postMessage({type:"transcode",id:c.id,width:o,height:A,hasAlpha:h,mipmaps:d,format:p,dfdTransferFn:f,dfdFlags:v},g)}catch(e){console.error("[KTX2TextureTranscoder.BasisWorker]: ".concat(e)),self.postMessage({type:"error",id:c.id,error:e.message})}}))}}));var o=[{if:"astcSupported",basisFormat:[s.UASTC_4x4],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[n.BC1,n.BC3],engineFormat:[r.RGB_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[n.ETC1],engineFormat:[r.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=o.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=o.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function u(e){return e<=2||0==(e&e-1)&&0!==e}};var ic={};function rc(e){var t=e.scene.id,i=ic[t];return i||(i=new tc({viewer:e}),ic[t]=i,e.scene.on("destroyed",(function(){delete ic[t],i.destroy()}))),i}
/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 *
 * This file takes a geometry given by { positionsCompressed, indices }, and returns
 * equivalent { positionsCompressed, indices } arrays but which only contain unique
 * positionsCompressed.
 *
 * The time is O(N logN) with the number of positionsCompressed due to a pre-sorting
 * step, but is much more GC-friendly and actually faster than the classic O(N)
 * approach based in keeping a hash-based LUT to identify unique positionsCompressed.
 */var nc=null;function sc(e,t){for(var i,r=0;r<3;r++)if(0!=(i=nc[3*e+r]-nc[3*t+r]))return i;return 0}var oc=null;function ac(e){var t=e.positionsCompressed,i=e.indices,r=e.edgeIndices;!function(e){if(!(null!==oc&&oc.length>=e)){oc=new Uint32Array(e);for(var t=0;t<e;t++)oc[t]=t}}(t.length/3);var n=oc.slice(0,t.length/3),s=oc.slice(0,t.length/3);nc=t,n.sort(sc);var o=0;s[n[0]]=0;for(var a=1,l=n.length;a<l;a++)0!==sc(n[a],n[a-1])&&o++,s[n[a]]=o;var u=new Uint16Array(3*(o+1));u[3*(o=0)+0]=t[3*n[0]+0],u[3*o+1]=t[3*n[0]+1],u[3*o+2]=t[3*n[0]+2];for(var A=1,c=n.length;A<c;A++)0!==sc(n[A],n[A-1])&&(u[3*++o+0]=t[3*n[A]+0],u[3*o+1]=t[3*n[A]+1],u[3*o+2]=t[3*n[A]+2]),s[n[A]]=o;nc=null;for(var h=new Uint32Array(i.length),d=0,p=i.length;d<p;d++)h[d]=s[i[d]];for(var f=new Uint32Array(r.length),v=0,g=r.length;v<g;v++)f[v]=s[r[v]];return[u,h,f]}
/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 **/var lc=null;function uc(e,t){var i,r,n,s,o,a,l=3*e,u=3*t,A=Math.min(i=lc[l],r=lc[l+1],n=lc[l+2]),c=Math.min(s=lc[u],o=lc[u+1],a=lc[u+2]);if(A!==c)return A-c;var h=Math.max(i,r,n),d=Math.max(s,o,a);return h!==d?h-d:0}function Ac(e,t){for(var i=new Int32Array(e.length/3),r=0,n=i.length;r<n;r++)i[r]=r;lc=new Int32Array(e.length);for(var s=0,o=e.length;s<o;s++)lc[s]=e[s]>>t;i.sort(uc);for(var a=new Int32Array(e.length),l=0,u=i.length;l<u;l++)a[3*l+0]=e[3*i[l]+0],a[3*l+1]=e[3*i[l]+1],a[3*l+2]=e[3*i[l]+2];return a}var cc=null;function hc(e,t){var i=cc[2*e]-cc[2*t];return 0!==i?i:cc[2*e+1]-cc[2*t+1]}function dc(e){if(0===(e||[]).length)return[];for(var t=new Int32Array(e.length/2),i=0,r=t.length;i<r;i++)t[i]=i;for(var n=0,s=e.length;n<s;n+=2)if(e[n]>e[n+1]){var o=e[n];e[n]=e[n+1],e[n+1]=o}cc=new Int32Array(e),t.sort(hc);for(var a=new Int32Array(e.length),l=0,u=t.length;l<u;l++)a[2*l+0]=e[2*t[l]+0],a[2*l+1]=e[2*t[l]+1];return a}function pc(e,t){var i={},r={};e.forEach((function(e){for(var t=e.indices,n=e.edgeIndices,s=e.positionsCompressed,o=0,a=t.length;o<a;o+=3){var l=s[3*t[o]]+"_"+s[3*t[o]+1]+"_"+s[3*t[o]+2]+"/"+s[3*t[o+1]]+"_"+s[3*t[o+1]+1]+"_"+s[3*t[o+1]+2]+"/"+s[3*t[o+2]]+"_"+s[3*t[o+2]+1]+"_"+s[3*t[o+2]+2];i[l]=!0}e.edgeIndices.length/2;for(var u=0,A=n.length;u<A;u+=2){var c=s[3*n[u]]+"_"+s[3*n[u]+1]+"_"+s[3*n[u]+2]+"/"+s[3*n[u+1]]+"_"+s[3*n[u+1]+1]+"_"+s[3*n[u+1]+2]+"/";r[c]=!0}}));var n=t.indices;t.edgeIndices;for(var s=t.positionsCompressed,o=0,a=n.length;o<a;o+=3){var l=s[3*n[o]]+"_"+s[3*n[o]+1]+"_"+s[3*n[o]+2]+"/"+s[3*n[o+1]]+"_"+s[3*n[o+1]+1]+"_"+s[3*n[o+1]+2]+"/"+s[3*n[o+2]]+"_"+s[3*n[o+2]+1]+"_"+s[3*n[o+2]+2];if(!(l in i))throw console.log("Not found "+l),"Ohhhh!"}}var fc=new Float32Array([0,0,0]),vc=new Uint16Array([0,0,0]);le.OBB3();var gc=function(){function e(t,i,r,n,s,o){k(this,e),this._isObject=i,this.scene=t.scene,this.model=t,this.isSceneModelEntity=!0,this.meshes=n,this._numPrimitives=0,this._capMaterial=null;for(var a=0,l=this.meshes.length;a<l;a++){var u=this.meshes[a];u.parent=this,u.entity=this,this._numPrimitives+=u.numPrimitives}this.id=r,this.originalSystemId=le.unglobalizeObjectId(t.id,r),this._flags=s,this._aabb=le.AABB3(),this._aabbDirty=!0,this._offset=le.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._lodCullable=!!o,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&t.scene._registerObject(this)}return I(e,[{key:"_transformDirty",value:function(){this._aabbDirty=!0,this.model._transformDirty()}},{key:"_sceneModelDirty",value:function(){this._aabbDirty=!0;for(var e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._sceneModelDirty()}},{key:"aabb",get:function(){if(this._aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this.meshes.length;e<t;e++)le.expandAABB3(this._aabb,this.meshes[e].aabb);this._aabbDirty=!1}return this._aabb}},{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return!1}},{key:"isObject",get:function(){return this._isObject}},{key:"numPrimitives",get:function(){return this._numPrimitives}},{key:"numTriangles",get:function(){return this._numPrimitives}},{key:"visible",get:function(){return this._getFlag(gs)},set:function(e){if(!!(this._flags&gs)!==e){this._flags=e?this._flags|gs:this._flags&~gs;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}},{key:"highlighted",get:function(){return this._getFlag(Bs)},set:function(e){if(!!(this._flags&Bs)!==e){this._flags=e?this._flags|Bs:this._flags&~Bs;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}},{key:"xrayed",get:function(){return this._getFlag(ws)},set:function(e){if(!!(this._flags&ws)!==e){this._flags=e?this._flags|ws:this._flags&~ws;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}},{key:"selected",get:function(){return this._getFlag(xs)},set:function(e){if(!!(this._flags&xs)!==e){this._flags=e?this._flags|xs:this._flags&~xs;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}},{key:"edges",get:function(){return this._getFlag(Ps)},set:function(e){if(!!(this._flags&Ps)!==e){this._flags=e?this._flags|Ps:this._flags&~Ps;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}},{key:"culledVFC",get:function(){return!!this._culledVFC},set:function(e){this._culledVFC=e,this._setCulled()}},{key:"culledLOD",get:function(){return!!this._culledLOD},set:function(e){this._culledLOD=e,this._setCulled()}},{key:"culled",get:function(){return!!this._culled},set:function(e){this._culled=e,this._setCulled()}},{key:"_setCulled",value:function(){var e=!!this._culled||!(!this._culledLOD||!this._lodCullable)||!!this._culledVFC;if(!!(this._flags&ms)!==e){this._flags=e?this._flags|ms:this._flags&~ms;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}},{key:"clippable",get:function(){return this._getFlag(ys)},set:function(e){if(!!(this._flags&ys)!==e){this._flags=e?this._flags|ys:this._flags&~ys;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}},{key:"collidable",get:function(){return this._getFlag(bs)},set:function(e){if(!!(this._flags&bs)!==e){this._flags=e?this._flags|bs:this._flags&~bs;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}},{key:"pickable",get:function(){return this._getFlag(_s)},set:function(e){if(!!(this._flags&_s)!==e){this._flags=e?this._flags|_s:this._flags&~_s;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}},{key:"colorize",get:function(){if(0===this.meshes.length)return null;var e=this.meshes[0]._colorize;return fc[0]=e[0]/255,fc[1]=e[1]/255,fc[2]=e[2]/255,fc},set:function(e){if(e){vc[0]=Math.floor(255*e[0]),vc[1]=Math.floor(255*e[1]),vc[2]=Math.floor(255*e[2]);for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(vc)}else for(var r=0,n=this.meshes.length;r<n;r++)this.meshes[r]._setColorize(null);if(this._isObject){var s=!!e;this.scene._objectColorizeUpdated(this,s),this._colorizeUpdated=s}this.model.glRedraw()}},{key:"opacity",get:function(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1},set:function(e){if(0!==this.meshes.length){var t=null!=e,i=this.meshes[0]._colorize[3],r=255;if(t){if(e<0?e=0:e>1&&(e=1),i===(r=Math.floor(255*e)))return}else if(i===(r=255))return;for(var n=0,s=this.meshes.length;n<s;n++)this.meshes[n]._setOpacity(r,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}}},{key:"offset",get:function(){return this._offset},set:function(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setOffset(this._offset);this._aabbDirty=!0,this.model._aabbDirty=!0,this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model.glRedraw()}},{key:"saoEnabled",get:function(){return this.model.saoEnabled}},{key:"capMaterial",get:function(){return this._capMaterial},set:function(e){this.scene.readableGeometryEnabled&&(this._capMaterial=e instanceof mn?e:null,this.scene._capMaterialUpdated(this.id,this.model.id))}},{key:"getEachVertex",value:function(e){for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachVertex(e)}},{key:"getEachIndex",value:function(e){for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachIndex(e)}},{key:"getGeometryData",value:function(){for(var e=0,t=[],i=[],r=0,n=this.meshes.length;r<n;r++){var s=this.meshes[r];if(s.layer.readGeometryData){for(var o=s.layer.readGeometryData(s.portionId),a=0,l=o.indices.length;a<l;a++)i.push(o.indices[a]+e);for(var u=0,A=o.positions.length;u<A;u++)t.push(o.positions[u]);e+=o.positions.length/3}}return{indices:i,positions:t}}},{key:"volume",get:function(){for(var e=0,t=0,i=this.meshes.length;t<i;t++){var r=this.meshes[t].volume;if(r<0)return-1;e+=r}return e}},{key:"surfaceArea",get:function(){for(var e=0,t=0,i=this.meshes.length;t<i;t++){var r=this.meshes[t].surfaceArea;r>=0&&(e+=r)}return e>0?e:-1}},{key:"_getFlag",value:function(e){return!!(this._flags&e)}},{key:"_finalize",value:function(){var e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._finalize(this._flags)}},{key:"_finalize2",value:function(){for(var e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}},{key:"_destroy",value:function(){var e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._deRegisterVisibleObject(this),this.xrayed&&e._deRegisterXRayedObject(this),this.selected&&e._deRegisterSelectedObject(this),this.highlighted&&e._deRegisterHighlightedObject(this),this._colorizeUpdated&&this.scene._deRegisterColorizedObject(this),this._opacityUpdated&&this.scene._deRegisterOpacityObject(this),!this._offset||0===this._offset[0]&&0===this._offset[1]&&0===this._offset[2]||this.scene._deRegisterOffsetObject(this));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._destroy();e._aabbDirty=!0}}]),e}(),mc=le.vec4(4),_c=le.vec4(),yc=le.vec4(),bc=le.vec3([1,0,0]),wc=le.vec3([0,1,0]),Bc=le.vec3([0,0,1]);le.vec3(3),le.vec3(3);var xc=le.identityMat4(),Pc=function(){function e(t){k(this,e),this._model=t.model,this.id=t.id,this._parentTransform=t.parent,this._childTransforms=[],this._meshes=[],this._scale=new Float32Array([1,1,1]),this._quaternion=le.identityQuaternion(new Float32Array(4)),this._rotation=new Float32Array(3),this._position=new Float32Array(3),this._localMatrix=le.identityMat4(new Float32Array(16)),this._worldMatrix=le.identityMat4(new Float32Array(16)),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),t.parent&&t.parent._addChildTransform(this)}return I(e,[{key:"_addChildTransform",value:function(e){this._childTransforms.push(e),e._parentTransform=this,e._transformDirty(),e._setSubtreeAABBsDirty(this)}},{key:"_addMesh",value:function(e){this._meshes.push(e),e.transform=this}},{key:"parentTransform",get:function(){return this._parentTransform}},{key:"meshes",get:function(){return this._meshes}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._model.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),le.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._model.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),le.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._model.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._model.glRedraw()}},{key:"matrix",get:function(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=le.identityMat4()),le.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix},set:function(e){this._localMatrix||(this._localMatrix=le.identityMat4()),this._localMatrix.set(e||xc),le.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._transformDirty(),this._model.glRedraw()}},{key:"worldMatrix",get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},{key:"rotate",value:function(e,t){return mc[0]=e[0],mc[1]=e[1],mc[2]=e[2],mc[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(mc,_c),le.mulQuaternions(this.quaternion,_c,yc),this.quaternion=yc,this._setLocalMatrixDirty(),this._model.glRedraw(),this}},{key:"rotateOnWorldAxis",value:function(e,t){return mc[0]=e[0],mc[1]=e[1],mc[2]=e[2],mc[3]=t*le.DEGTORAD,le.angleAxisToQuaternion(mc,_c),le.mulQuaternions(_c,this.quaternion,_c),this}},{key:"rotateX",value:function(e){return this.rotate(bc,e)}},{key:"rotateY",value:function(e){return this.rotate(wc,e)}},{key:"rotateZ",value:function(e){return this.rotate(Bc,e)}},{key:"translate",value:function(e){return this._position[0]+=e[0],this._position[1]+=e[1],this._position[2]+=e[2],this._setLocalMatrixDirty(),this._model.glRedraw(),this}},{key:"translateX",value:function(e){return this._position[0]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}},{key:"translateY",value:function(e){return this._position[1]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}},{key:"translateZ",value:function(e){return this._position[2]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}},{key:"_setLocalMatrixDirty",value:function(){this._localMatrixDirty=!0,this._transformDirty()}},{key:"_transformDirty",value:function(){this._worldMatrixDirty=!0;for(var e=0,t=this._childTransforms.length;e<t;e++){var i=this._childTransforms[e];if(i._transformDirty(),i._meshes&&i._meshes.length>0)for(var r=i._meshes,n=0,s=r.length;n<s;n++)r[n]._transformDirty()}if(this._meshes&&this._meshes.length>0)for(var o=this._meshes,a=0,l=o.length;a<l;a++)o[a]._transformDirty()}},{key:"_buildWorldMatrix",value:function(){var e=this.matrix;if(this._parentTransform)le.mulMat4(this._parentTransform.worldMatrix,e,this._worldMatrix);else for(var t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}},{key:"_setSubtreeAABBsDirty",value:function(e){if(e._aabbDirty=!0,e._childTransforms)for(var t=0,i=e._childTransforms.length;t<i;t++)this._setSubtreeAABBsDirty(e._childTransforms[t])}}]),e}(),Cc=le.vec3(),Mc=le.OBB3(),Fc=le.vec4(),kc=le.vec3([1,1,1]),Ec=le.vec3([0,0,0]);le.vec3([0,0,0]);var Ic=le.identityQuaternion(),Tc=le.identityMat4(),Dc=new Uint8Array([255,255,255]),Sc=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).renderOrder=n.renderOrder||0,r._dtxEnabled=r.scene.dtxEnabled&&!1!==n.dtxEnabled,r._enableVertexWelding=!1,r._enableIndexBucketing=!1,r._vboBatchingLayerScratchMemory=vs(),r._textureTranscoder=n.textureTranscoder||rc(r.scene.viewer),r._maxGeometryBatchSize=n.maxGeometryBatchSize,r._aabb=le.collapseAABB3(),r._aabbDirty=!0,r._quantizationRanges={},r._vboInstancingLayers={},r._vboBatchingLayers={},r._dtxLayers={},r._meshList=[],r.layerList=[],r._layersToFinalize=[],r._entityList=[],r._entitiesToFinalize=[],r._geometries={},r._dtxBuckets={},r._textures={},r._textureSets={},r._transforms={},r._meshes={},r._unusedMeshes={},r._entities={},r.renderFlags=new sn,r.numGeometries=0,r.numPortions=0,r.numVisibleLayerPortions=0,r.numTransparentLayerPortions=0,r.numXRayedLayerPortions=0,r.numHighlightedLayerPortions=0,r.numSelectedLayerPortions=0,r.numEdgesLayerPortions=0,r.numPickableLayerPortions=0,r.numClippableLayerPortions=0,r.numCulledLayerPortions=0,r.numEntities=0,r._numTriangles=0,r._numLines=0,r._numPoints=0,r._layersFinalized=!1,r._edgeThreshold=n.edgeThreshold||10,r._origin=le.vec3(n.origin||[0,0,0]),r._position=le.vec3(n.position||[0,0,0]),r._rotation=le.vec3(n.rotation||[0,0,0]),r._quaternion=le.vec4(n.quaternion||[0,0,0,1]),r._conjugateQuaternion=le.vec4(n.quaternion||[0,0,0,1]),n.rotation&&le.eulerToQuaternion(r._rotation,"XYZ",r._quaternion),r._scale=le.vec3(n.scale||[1,1,1]),r._worldRotationMatrix=le.mat4(),r._worldRotationMatrixConjugate=le.mat4(),r._matrix=le.mat4(),r._matrixDirty=!0,r._rebuildMatrices(),r._worldNormalMatrix=le.mat4(),le.inverseMat4(r._matrix,r._worldNormalMatrix),le.transposeMat4(r._worldNormalMatrix),(n.matrix||n.position||n.rotation||n.scale||n.quaternion)&&(r._viewMatrix=le.mat4(),r._viewNormalMatrix=le.mat4(),r._viewMatrixDirty=!0,r._matrixNonIdentity=!0),r._opacity=1,r._colorize=[1,1,1],r._saoEnabled=!1!==n.saoEnabled,r._pbrEnabled=!1!==n.pbrEnabled,r._colorTextureEnabled=!1!==n.colorTextureEnabled,r._isModel=n.isModel,r._isModel&&r.scene._registerModel(w(r)),r._onCameraViewMatrix=r.scene.camera.on("matrix",(function(){r._viewMatrixDirty=!0})),r._meshesWithDirtyMatrices=[],r._numMeshesWithDirtyMatrices=0,r._onTick=r.scene.on("tick",(function(){for(;r._numMeshesWithDirtyMatrices>0;)r._meshesWithDirtyMatrices[--r._numMeshesWithDirtyMatrices]._updateMatrix()})),r._createDefaultTextureSet(),r.visible=n.visible,r.culled=n.culled,r.pickable=n.pickable,r.clippable=n.clippable,r.collidable=n.collidable,r.castsShadow=n.castsShadow,r.receivesShadow=n.receivesShadow,r.xrayed=n.xrayed,r.highlighted=n.highlighted,r.selected=n.selected,r.edges=n.edges,r.colorize=n.colorize,r.opacity=n.opacity,r.backfaces=n.backfaces,r}return I(i,[{key:"_meshMatrixDirty",value:function(e){this._meshesWithDirtyMatrices[this._numMeshesWithDirtyMatrices++]=e}},{key:"_createDefaultTextureSet",value:function(){var e=new WA({id:"defaultColorTexture",texture:new Pn({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new WA({id:"defaultMetalRoughTexture",texture:new Pn({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),i=new WA({id:"defaultNormalsTexture",texture:new Pn({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),r=new WA({id:"defaultEmissiveTexture",texture:new Pn({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),n=new WA({id:"defaultOcclusionTexture",texture:new Pn({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures.defaultColorTexture=e,this._textures.defaultMetalRoughTexture=t,this._textures.defaultNormalsTexture=i,this._textures.defaultEmissiveTexture=r,this._textures.defaultOcclusionTexture=n,this._textureSets.defaultTextureSet=new zA({id:"defaultTextureSet",model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:i,emissiveTexture:r,occlusionTexture:n})}},{key:"isPerformanceModel",get:function(){return!0}},{key:"transforms",get:function(){return this._transforms}},{key:"textures",get:function(){return this._textures}},{key:"textureSets",get:function(){return this._textureSets}},{key:"meshes",get:function(){return this._meshes}},{key:"objects",get:function(){return this._entities}},{key:"origin",get:function(){return this._origin}},{key:"position",get:function(){return this._position},set:function(e){this._position.set(e||[0,0,0]),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation.set(e||[0,0,0]),le.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}},{key:"quaternion",get:function(){return this._quaternion},set:function(e){this._quaternion.set(e||[0,0,0,1]),le.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}},{key:"scale",get:function(){return this._scale},set:function(e){}},{key:"matrix",get:function(){return this._rebuildMatrices(),this._matrix},set:function(e){this._matrix.set(e||Tc),le.decomposeMat4(this._matrix,this._position,this._quaternion,this._scale),le.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._matrixDirty=!1,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}},{key:"rotationMatrix",get:function(){return this._rebuildMatrices(),this._worldRotationMatrix}},{key:"_rebuildMatrices",value:function(){this._matrixDirty&&(le.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),le.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),le.quaternionToRotationMat4(this._conjugateQuaternion,this._worldRotationMatrixConjugate),le.scaleMat4v(this._scale,this._worldRotationMatrix),le.scaleMat4v(this._scale,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),le.translateMat4v(this._position,this._matrix),this._matrixDirty=!1,this._viewMatrixDirty=!0)}},{key:"rotationMatrixConjugate",get:function(){return this._rebuildMatrices(),this._worldRotationMatrixConjugate}},{key:"_setWorldMatrixDirty",value:function(){this._matrixDirty=!0,this._aabbDirty=!0}},{key:"_transformDirty",value:function(){this._matrixDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0}},{key:"_sceneModelDirty",value:function(){this.scene._aabbDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._matrixDirty=!0;for(var e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._sceneModelDirty()}},{key:"worldMatrix",get:function(){return this.matrix}},{key:"worldNormalMatrix",get:function(){return this._worldNormalMatrix}},{key:"_rebuildViewMatrices",value:function(){this._rebuildMatrices(),this._viewMatrixDirty&&(le.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),le.inverseMat4(this._viewMatrix,this._viewNormalMatrix),le.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1)}},{key:"viewMatrix",get:function(){return this._viewMatrix?(this._rebuildViewMatrices(),this._viewMatrix):this.scene.camera.viewMatrix}},{key:"viewNormalMatrix",get:function(){return this._viewNormalMatrix?(this._rebuildViewMatrices(),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}},{key:"backfaces",get:function(){return this._backfaces},set:function(e){e=!!e,this._backfaces=e,this.glRedraw()}},{key:"entityList",get:function(){return this._entityList}},{key:"isEntity",get:function(){return!0}},{key:"isModel",get:function(){return this._isModel}},{key:"isObject",get:function(){return!1}},{key:"aabb",get:function(){if(this._aabbDirty){le.collapseAABB3(this._aabb);for(var e=0,t=this._entityList.length;e<t;e++)le.expandAABB3(this._aabb,this._entityList[e].aabb);this._aabbDirty=!1}return this._aabb}},{key:"numTriangles",get:function(){return this._numTriangles}},{key:"numLines",get:function(){return this._numLines}},{key:"numPoints",get:function(){return this._numPoints}},{key:"visible",get:function(){return this.numVisibleLayerPortions>0},set:function(e){e=!1!==e,this._visible=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].visible=e;this.glRedraw()}},{key:"xrayed",get:function(){return this.numXRayedLayerPortions>0},set:function(e){e=!!e,this._xrayed=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].xrayed=e;this.glRedraw()}},{key:"highlighted",get:function(){return this.numHighlightedLayerPortions>0},set:function(e){e=!!e,this._highlighted=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].highlighted=e;this.glRedraw()}},{key:"selected",get:function(){return this.numSelectedLayerPortions>0},set:function(e){e=!!e,this._selected=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].selected=e;this.glRedraw()}},{key:"edges",get:function(){return this.numEdgesLayerPortions>0},set:function(e){e=!!e,this._edges=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].edges=e;this.glRedraw()}},{key:"culled",get:function(){return this._culled},set:function(e){e=!!e,this._culled=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].culled=e;this.glRedraw()}},{key:"clippable",get:function(){return this._clippable},set:function(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].clippable=e;this.glRedraw()}},{key:"collidable",get:function(){return this._collidable},set:function(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].collidable=e}},{key:"pickable",get:function(){return this.numPickableLayerPortions>0},set:function(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].pickable=e}},{key:"colorize",get:function(){return this._colorize},set:function(e){this._colorize=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].colorize=e}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity=e;for(var t=0,i=this._entityList.length;t<i;t++)this._entityList[t].opacity=e}},{key:"castsShadow",get:function(){return this._castsShadow},set:function(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}},{key:"receivesShadow",get:function(){return this._receivesShadow},set:function(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}},{key:"saoEnabled",get:function(){return this._saoEnabled}},{key:"pbrEnabled",get:function(){return this._pbrEnabled}},{key:"colorTextureEnabled",get:function(){return this._colorTextureEnabled}},{key:"isDrawable",get:function(){return!0}},{key:"isStateSortable",get:function(){return!1}},{key:"xrayMaterial",get:function(){return this.scene.xrayMaterial}},{key:"highlightMaterial",get:function(){return this.scene.highlightMaterial}},{key:"selectedMaterial",get:function(){return this.scene.selectedMaterial}},{key:"edgeMaterial",get:function(){return this.scene.edgeMaterial}},{key:"getPickViewMatrix",value:function(e){return this._viewMatrix?this._viewMatrix:e}},{key:"createQuantizationRange",value:function(e){void 0!==e.id&&null!==e.id?e.aabb?this.error("[createQuantizationRange] Config missing: aabb"):this._quantizationRanges[e.id]?this.error("[createQuantizationRange] QuantizationRange already created: "+e.id):this._quantizationRanges[e.id]={id:e.id,aabb:e.aabb,matrix:yo(e.aabb,le.mat4())}:this.error("[createQuantizationRange] Config missing: id")}},{key:"createGeometry",value:function(e){if(void 0!==e.id&&null!==e.id)if(this._geometries[e.id])this.error("[createGeometry] Geometry already created: "+e.id);else if(void 0!==e.primitive&&null!==e.primitive||(e.primitive="triangles"),"points"===e.primitive||"lines"===e.primitive||"triangles"===e.primitive||"solid"===e.primitive||"surface"===e.primitive){if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("[createGeometry] Param expected: `positions`,  `positionsCompressed' or 'buckets"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("[createGeometry] Param expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.positionsDecodeMatrix&&e.positionsDecodeBoundary)return this.error("[createGeometry] Only one of these params expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("[createGeometry] Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!(e.buckets||e.indices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)){var t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&"points"!==e.primitive)return this.error("[createGeometry] Param expected: indices (required for '".concat(e.primitive,"' primitive type)")),null;if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=yo(e.positionsDecodeBoundary,le.mat4())),e.positions){var i=le.collapseAABB3();e.positionsDecodeMatrix=le.mat4(),le.expandAABB3Points3(i,e.positions),e.positionsCompressed=_o(e.positions,i,e.positionsDecodeMatrix),e.aabb=i}else if(e.positionsCompressed){var r=le.collapseAABB3();e.positionsDecodeMatrix=new Float64Array(e.positionsDecodeMatrix),e.positionsCompressed=new Uint16Array(e.positionsCompressed),le.expandAABB3Points3(r,e.positionsCompressed),ft.decompressAABB(r,e.positionsDecodeMatrix),e.aabb=r}else if(e.buckets){var n=le.collapseAABB3();this._dtxBuckets[e.id]=e.buckets;for(var s=0,o=e.buckets.length;s<o;s++){var a=e.buckets[s];a.positions?le.expandAABB3Points3(n,a.positions):a.positionsCompressed&&le.expandAABB3Points3(n,a.positionsCompressed)}e.positionsDecodeMatrix&&ft.decompressAABB(n,e.positionsDecodeMatrix),e.aabb=n}if(e.colorsCompressed&&e.colorsCompressed.length>0)e.colorsCompressed=new Uint8Array(e.colorsCompressed);else if(e.colors&&e.colors.length>0){for(var l=e.colors,u=new Uint8Array(l.length),A=0,c=l.length;A<c;A++)u[A]=255*l[A];e.colorsCompressed=u}if(e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=ot(e.positions,e.indices,null,5):e.edgeIndices=ot(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.uv){var h=ft.getUVBounds(e.uv),d=ft.compressUVs(e.uv,h.min,h.max);e.uvCompressed=d.quantized,e.uvDecodeMatrix=d.decodeMatrix}else e.uvCompressed&&(e.uvCompressed=new Uint16Array(e.uvCompressed),e.uvDecodeMatrix=new Float64Array(e.uvDecodeMatrix));e.normals&&(e.normals=null),this._geometries[e.id]=e,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}else this.error("[createGeometry] Unsupported value for 'primitive': '".concat(e.primitive,"' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'."));else this.error("[createGeometry] Config missing: id")}},{key:"createTexture",value:function(e){var t=this,i=e.id;if(null!=i)if(this._textures[i])this.error("[createTexture] Texture already created: "+i);else{if(!e.src&&!e.image&&!e.buffers)return this.error("[createTexture] Param expected: `src`, `image' or 'buffers'"),null;var r=e.minFilter||1008;1006!==r&&1007!==r&&1008!==r&&1005!==r&&1004!==r&&(this.error("[createTexture] Unsupported value for 'minFilter' - \n            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, \n            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter."),r=1008);var n=e.magFilter||1006;1006!==n&&1003!==n&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),n=1006);var s=e.wrapS||1e3;1001!==s&&1002!==s&&1e3!==s&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),s=1e3);var o=e.wrapT||1e3;1001!==o&&1002!==o&&1e3!==o&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=1e3);var a=e.wrapR||1e3;1001!==a&&1002!==a&&1e3!==a&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),a=1e3);var l=e.encoding||3e3;3e3!==l&&3001!==l&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),l=3e3);var u=new Pn({gl:this.scene.canvas.gl,minFilter:r,magFilter:n,wrapS:s,wrapT:o,wrapR:a,encoding:l});if(e.preloadColor&&u.setPreloadColor(e.preloadColor),e.image){var A=e.image;if(A.crossOrigin="Anonymous",A.compressed){var c=A.data;u.setCompressedData({mipmaps:c,props:{format:c[0].format,minFilter:r,magFilter:n}})}else u.setImage(A,{minFilter:r,magFilter:n,wrapS:s,wrapT:o,wrapR:a,flipY:e.flipY,encoding:l})}else if(e.src){var h=e.src.split(".").pop();switch(h){case"jpeg":case"jpg":case"png":case"gif":var d=new Image;d.onload=function(){u.setImage(d,{minFilter:r,magFilter:n,wrapS:s,wrapT:o,wrapR:a,flipY:e.flipY,encoding:l}),t.glRedraw()},d.src=e.src;break;default:this._textureTranscoder?ge.loadArraybuffer(e.src,(function(e){e.byteLength?t._textureTranscoder.transcode([e],u).then((function(){t.glRedraw()})):t.error("[createTexture] Can't create texture from 'src': file data is zero length")}),(function(e){this.error("[createTexture] Can't create texture from 'src': ".concat(e))})):this.error("[createTexture] Can't create texture from 'src' - SceneModel needs to be configured with a TextureTranscoder for this file type ('".concat(h,"')"))}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,u).then((function(){t.glRedraw()})):this.error("[createTexture] Can't create texture from 'buffers' - SceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[i]=new WA({id:i,texture:u})}else this.error("[createTexture] Config missing: id")}},{key:"createTextureSet",value:function(e){var t=e.id;if(null!=t){if(!this._textureSets[t]){var i,r,n,s,o;if(void 0!==e.colorTextureId&&null!==e.colorTextureId){if(!(i=this._textures[e.colorTextureId]))return void this.error("[createTextureSet] Texture not found: ".concat(e.colorTextureId," - ensure that you create it first with createTexture()"))}else i=this._textures.defaultColorTexture;if(void 0!==e.metallicRoughnessTextureId&&null!==e.metallicRoughnessTextureId){if(!(r=this._textures[e.metallicRoughnessTextureId]))return void this.error("[createTextureSet] Texture not found: ".concat(e.metallicRoughnessTextureId," - ensure that you create it first with createTexture()"))}else r=this._textures.defaultMetalRoughTexture;if(void 0!==e.normalsTextureId&&null!==e.normalsTextureId){if(!(n=this._textures[e.normalsTextureId]))return void this.error("[createTextureSet] Texture not found: ".concat(e.normalsTextureId," - ensure that you create it first with createTexture()"))}else n=this._textures.defaultNormalsTexture;if(void 0!==e.emissiveTextureId&&null!==e.emissiveTextureId){if(!(s=this._textures[e.emissiveTextureId]))return void this.error("[createTextureSet] Texture not found: ".concat(e.emissiveTextureId," - ensure that you create it first with createTexture()"))}else s=this._textures.defaultEmissiveTexture;if(void 0!==e.occlusionTextureId&&null!==e.occlusionTextureId){if(!(o=this._textures[e.occlusionTextureId]))return void this.error("[createTextureSet] Texture not found: ".concat(e.occlusionTextureId," - ensure that you create it first with createTexture()"))}else o=this._textures.defaultOcclusionTexture;var a=new zA({id:t,model:this,colorTexture:i,alphaCutoff:e.alphaCutoff,metallicRoughnessTexture:r,normalsTexture:n,emissiveTexture:s,occlusionTexture:o});return this._textureSets[t]=a,a}this.error("[createTextureSet] Texture set already created: ".concat(t))}else this.error("[createTextureSet] Config missing: id")}},{key:"createTransform",value:function(e){if(void 0!==e.id&&null!==e.id)if(this._transforms[e.id])this.error("[createTransform] SceneModel already has a transform with this ID: ".concat(e.id));else{var t;if(!e.parentTransformId||(t=this._transforms[e.parentTransformId])){var i=new Pc({id:e.id,model:this,parent:t,matrix:e.matrix,position:e.position,scale:e.scale,rotation:e.rotation,quaternion:e.quaternion});return this._transforms[i.id]=i,i}this.error("[createTransform] SceneModel.createTransform() config missing: id")}else this.error("[createTransform] SceneModel.createTransform() config missing: id")}},{key:"createMesh",value:function(e){if(void 0===e.id||null===e.id)return this.error("[createMesh] SceneModel.createMesh() config missing: id"),!1;if(this._meshes[e.id])return this.error("[createMesh] SceneModel already has a mesh with this ID: ".concat(e.id)),!1;if(!(void 0!==e.geometryId)){if(void 0!==e.primitive&&null!==e.primitive||(e.primitive="triangles"),"points"!==e.primitive&&"lines"!==e.primitive&&"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)return this.error("Unsupported value for 'primitive': '".concat(primitive,"'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.")),!1;if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("Param expected: 'positions',  'positionsCompressed' or `buckets`  ('geometryId' is absent)"),!1;if(e.positions&&(e.positionsDecodeMatrix||e.positionsDecodeBoundary))return this.error("Illegal params: 'positions' not expected with 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("Param expected: 'positionsCompressed' should be accompanied by 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: 'uvCompressed' should be accompanied by `uvDecodeMatrix` ('geometryId' is absent)"),!1;if(!(e.buckets||e.indices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)){var t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&"points"!==e.primitive)return e.indices=this._createDefaultIndices(numIndices),this.error("Param expected: indices (required for '".concat(e.primitive,"' primitive type)")),!1;if((e.matrix||e.position||e.rotation||e.scale)&&(e.positionsCompressed||e.positionsDecodeBoundary))return this.error("Unexpected params: 'matrix', 'rotation', 'scale', 'position' not allowed with 'positionsCompressed'"),!1;var i=!(!this._dtxEnabled||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||e.textureSetId);if(e.origin=e.origin?le.addVec3(this._origin,e.origin,le.vec3()):this._origin,e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){var r=e.scale||kc,n=e.position||Ec;e.rotation?(le.eulerToQuaternion(e.rotation,"XYZ",Fc),e.meshMatrix=le.composeMat4(n,Fc,r,le.mat4())):e.meshMatrix=le.composeMat4(n,e.quaternion||Ic,r,le.mat4())}if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=yo(e.positionsDecodeBoundary,le.mat4())),i){if(e.type=2,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Dc,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.positions){var s=le.vec3(),o=[];qt(e.positions,o,s)&&(e.positions=o,e.origin=le.addVec3(e.origin,s,s))}if(e.positions){var a=le.collapseAABB3();e.positionsDecodeMatrix=le.mat4(),le.expandAABB3Points3(a,e.positions),e.positionsCompressed=_o(e.positions,a,e.positionsDecodeMatrix),e.aabb=a}else if(e.positionsCompressed){var l=le.collapseAABB3();le.expandAABB3Points3(l,e.positionsCompressed),ft.decompressAABB(l,e.positionsDecodeMatrix),e.aabb=l}if(e.buckets){for(var u=le.collapseAABB3(),A=0,c=e.buckets.length;A<c;A++){var h=e.buckets[A];h.positions?le.expandAABB3Points3(u,h.positions):h.positionsCompressed&&le.expandAABB3Points3(u,h.positionsCompressed)}e.positionsDecodeMatrix&&ft.decompressAABB(u,e.positionsDecodeMatrix),e.aabb=u}e.meshMatrix&&(le.AABB3ToOBB3(e.aabb,Mc),le.transformOBB3(e.meshMatrix,Mc),le.OBB3ToAABB3(Mc,e.aabb)),e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=ot(e.positions,e.indices,null,2):e.edgeIndices=ot(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.buckets||(e.buckets=Rc(e,this._enableVertexWelding&&this._enableIndexBucketing))}else{if(e.type=1,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.metallic=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,e.roughness=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,e.positions){var d=[];qt(e.positions,d,Cc)&&(e.positions=d,e.origin=le.addVec3(e.origin,Cc,le.vec3()))}if(e.positions){var p=le.collapseAABB3();e.meshMatrix&&(le.transformPositions3(e.meshMatrix,e.positions,e.positions),e.meshMatrix=null),le.expandAABB3Points3(p,e.positions),e.aabb=p}else{var f=le.collapseAABB3();le.expandAABB3Points3(f,e.positionsCompressed),ft.decompressAABB(f,e.positionsDecodeMatrix),e.aabb=f}if(e.meshMatrix&&(le.AABB3ToOBB3(e.aabb,Mc),le.transformOBB3(e.meshMatrix,Mc),le.OBB3ToAABB3(Mc,e.aabb)),e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=ot(e.positions,e.indices,null,2):e.edgeIndices=ot(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId],!e.textureSet))return this.error("[createMesh] Texture set not found: ".concat(e.textureSetId," - ensure that you create it first with createTextureSet()")),!1}}else{if(e.positions||e.positionsCompressed||e.indices||e.edgeIndices||e.normals||e.normalsCompressed||e.uv||e.uvCompressed||e.positionsDecodeMatrix)return this.error("Mesh geometry parameters not expected when instancing a geometry (not expected: positions, positionsCompressed, indices, edgeIndices, normals, normalsCompressed, uv, uvCompressed, positionsDecodeMatrix)"),!1;if(e.geometry=this._geometries[e.geometryId],!e.geometry)return this.error("[createMesh] Geometry not found: ".concat(e.geometryId," - ensure that you create it first with createGeometry()")),!1;if(e.origin=e.origin?le.addVec3(this._origin,e.origin,le.vec3()):this._origin,e.positionsDecodeMatrix=e.geometry.positionsDecodeMatrix,e.transformId){if(e.transform=this._transforms[e.transformId],!e.transform)return this.error("[createMesh] Transform not found: ".concat(e.transformId," - ensure that you create it first with createTransform()")),!1;e.aabb=e.geometry.aabb}else{if(e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){var v=e.scale||kc,g=e.position||Ec;e.rotation?(le.eulerToQuaternion(e.rotation,"XYZ",Fc),e.meshMatrix=le.composeMat4(g,Fc,v,le.mat4())):e.meshMatrix=le.composeMat4(g,e.quaternion||Ic,v,le.mat4())}le.AABB3ToOBB3(e.geometry.aabb,Mc),le.transformOBB3(e.meshMatrix,Mc),e.aabb=le.OBB3ToAABB3(Mc,le.AABB3())}if(!(!this._dtxEnabled||"triangles"!==e.geometry.primitive&&"solid"!==e.geometry.primitive&&"surface"!==e.geometry.primitive||e.textureSetId)){e.type=2,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Dc,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255;var m=this._dtxBuckets[e.geometryId];m||(m=Rc(e.geometry,this._enableVertexWelding,this._enableIndexBucketing),this._dtxBuckets[e.geometryId]=m),e.buckets=m}else e.type=0,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Dc,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.metallic=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,e.roughness=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId])}return e.numPrimitives=this._getNumPrimitives(e),this._createMesh(e)}},{key:"_createDefaultIndices",value:function(e){for(var t=[],i=0;i<e;i++)t.push(i);return t}},{key:"_createMesh",value:function(e){var t=new ds(this,e.id,e.color,e.opacity,e.transform,e.textureSet);t.pickId=this.scene._renderer.getPickID(t);var i=t.pickId,r=i>>24&255,n=i>>16&255,s=i>>8&255,o=255&i;switch(e.pickColor=new Uint8Array([o,s,n,r]),e.solid="solid"===e.primitive,t.origin=le.vec3(e.origin),e.type){case 2:t.layer=this._getDTXLayer(e),t.aabb=e.aabb;break;case 1:t.layer=this._getVBOBatchingLayer(e),t.aabb=e.aabb;break;case 0:t.layer=this._getVBOInstancingLayer(e),t.aabb=e.aabb}return e.transform&&(e.meshMatrix=e.transform.worldMatrix),t.portionId=t.layer.createPortion(t,e),t.numPrimitives=e.numPrimitives,this._meshes[e.id]=t,this._unusedMeshes[e.id]=t,this._meshList.push(t),t}},{key:"_getNumPrimitives",value:function(e){var t=0;switch(e.geometry?e.geometry.primitive:e.primitive){case"triangles":case"solid":case"surface":switch(e.type){case 2:for(var i=0,r=e.buckets.length;i<r;i++)t+=e.buckets[i].indices.length;break;case 1:t+=e.indices.length;break;case 0:t+=e.geometry.indices.length}return Math.round(t/3);case"points":switch(e.type){case 2:for(var n=0,s=e.buckets.length;n<s;n++)t+=e.buckets[n].positionsCompressed.length;break;case 1:t+=e.positions?e.positions.length:e.positionsCompressed.length;break;case 0:var o=e.geometry;t+=o.positions?o.positions.length:o.positionsCompressed.length}return Math.round(t);case"lines":case"line-strip":switch(e.type){case 2:for(var a=0,l=e.buckets.length;a<l;a++)t+=e.buckets[a].indices.length;break;case 1:t+=e.indices.length;break;case 0:t+=e.geometry.indices.length}return Math.round(t/2)}return 0}},{key:"_getDTXLayer",value:function(e){var t=e.origin,i=e.geometry?e.geometry.primitive:e.primitive,r=".".concat(i,".").concat(Math.round(t[0]),".").concat(Math.round(t[1]),".").concat(Math.round(t[2])),n=this._dtxLayers[r];if(n){if(n.canCreatePortion(e))return n;delete this._dtxLayers[r],n=null}switch(i){case"triangles":case"solid":case"surface":n=new jA(this,{layerIndex:0,origin:t,primitive:i});break;case"lines":n=new yu(this,{layerIndex:0,origin:t,primitive:i});break;default:return}return this._dtxLayers[r]=n,this.layerList.push(n),this._layersToFinalize.push(n),n}},{key:"_getVBOBatchingLayer",value:function(e){var t=this,i=e.origin;e.renderLayer;var r=e.positionsDecodeMatrix||e.positionsDecodeBoundary?this._createHashStringFromMatrix(e.positionsDecodeMatrix||e.positionsDecodeBoundary):"-",n=e.textureSetId||"-",s="".concat(Math.round(i[0]),".").concat(Math.round(i[1]),".").concat(Math.round(i[2]),".").concat(e.primitive,".").concat(r,".").concat(n),o=this._vboBatchingLayers[s];if(o)return o;for(var a=e.textureSet;!o;){switch(e.primitive){case"triangles":case"solid":case"surface":o=new Do({model:t,textureSet:a,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===e.primitive,autoNormals:!0,primitive:e.primitive});break;case"lines":o=new Ga({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive});break;case"points":o=new El({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive})}var l=e.positionsCompressed?e.positionsCompressed.length:e.positions.length;("points"===e.primitive?o.canCreatePortion(l):o.canCreatePortion(l,e.indices.length))||(o.finalize(),delete this._vboBatchingLayers[s],o=null)}return this._vboBatchingLayers[s]=o,this.layerList.push(o),this._layersToFinalize.push(o),o}},{key:"_createHashStringFromMatrix",value:function(e){for(var t=e.join(""),i=0,r=0;r<t.length;r++){i=(i<<5)-i+t.charCodeAt(r),i|=0}return(i>>>0).toString(16)}},{key:"_getVBOInstancingLayer",value:function(e){var t=this,i=e.origin,r=e.textureSetId||"-",n=e.geometryId,s="".concat(Math.round(i[0]),".").concat(Math.round(i[1]),".").concat(Math.round(i[2]),".").concat(r,".").concat(n),o=this._vboInstancingLayers[s];if(o)return o;for(var a=e.textureSet,l=e.geometry;!o;)switch(l.primitive){case"triangles":case"surface":o=new xa({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0,solid:!1});break;case"solid":o=new xa({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0,solid:!0});break;case"lines":o=new ul({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0});break;case"points":o=new tu({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0})}return this._vboInstancingLayers[s]=o,this.layerList.push(o),this._layersToFinalize.push(o),o}},{key:"createEntity",value:function(e){if(void 0===e.id?e.id=le.createUUID():this.scene.components[e.id]&&(this.error("Scene already has a Component with this ID: ".concat(e.id," - will assign random ID")),e.id=le.createUUID()),void 0!==e.meshIds){var t=0;return this._visible&&!1!==e.visible&&(t|=gs),this._pickable&&!1!==e.pickable&&(t|=_s),this._culled&&!1!==e.culled&&(t|=ms),this._clippable&&!1!==e.clippable&&(t|=ys),this._collidable&&!1!==e.collidable&&(t|=bs),this._edges&&!1!==e.edges&&(t|=Ps),this._xrayed&&!1!==e.xrayed&&(t|=ws),this._highlighted&&!1!==e.highlighted&&(t|=Bs),this._selected&&!1!==e.selected&&(t|=xs),e.flags=t,this._createEntity(e)}this.error("Config missing: meshIds")}},{key:"_createEntity",value:function(e){for(var t=[],i=0,r=e.meshIds.length;i<r;i++){var n=e.meshIds[i],s=this._meshes[n];s?s.parent?this.error('Mesh with ID "'.concat(n,'" already belongs to object with ID "').concat(s.parent.id,'" - ignoring this mesh')):(t.push(s),delete this._unusedMeshes[n]):this.error('Mesh with this ID not found: "'.concat(n,'" - ignoring this mesh'))}var o=new gc(this,e.isObject,e.id,t,e.flags,!0);return this._entityList.push(o),this._entities[e.id]=o,this._entitiesToFinalize.push(o),this.numEntities++,o}},{key:"preFinalize",value:function(){if(this.destroyed)return!1;if(0===this._layersToFinalize.length)return!1;this._createDummyEntityForUnusedMeshes();for(var e=0,t=this._layersToFinalize.length;e<t;e++){this._layersToFinalize[e].finalize()}this._vboBatchingLayers={},this._vboInstancingLayers={},this._dtxLayers={},this._layersToFinalize=[];for(var i=0,r=this._entitiesToFinalize.length;i<r;i++){this._entitiesToFinalize[i]._finalize()}for(var n=0,s=this._entitiesToFinalize.length;n<s;n++){this._entitiesToFinalize[n]._finalize2()}this._entitiesToFinalize=[],this.scene._aabbDirty=!0,this._viewMatrixDirty=!0,this._matrixDirty=!0,this._aabbDirty=!0,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.position=this._position,this.layerList.sort((function(e,t){return e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0}));for(var o=0,a=this.layerList.length;o<a;o++){this.layerList[o].layerIndex=o}this.glRedraw(),this._layersFinalized=!0}},{key:"finalize",value:function(){this.destroyed||(this.preFinalize(),this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={})}},{key:"stateSortCompare",value:function(e,t){}},{key:"rebuildRenderFlags",value:function(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}},{key:"_updateRenderFlagsVisibleLayers",value:function(){var e=this.renderFlags;e.numLayers=this.layerList.length,e.numVisibleLayers=0;for(var t=0,i=this.layerList.length;t<i;t++){var r=this.layerList[t];this._getActiveSectionPlanesForLayer(r)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}},{key:"_createDummyEntityForUnusedMeshes",value:function(){var e=Object.keys(this._unusedMeshes);if(e.length>0){var t="".concat(this.id,"-").concat(le.createUUID());this.warn('Creating dummy SceneModelEntity "'.concat(t,'" for unused SceneMeshes: [').concat(e.join(","),"]")),this.createEntity({id:t,meshIds:e,isObject:!0})}this._unusedMeshes={}}},{key:"_getActiveSectionPlanesForLayer",value:function(e){var t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,r=i.length,n=e.layerIndex*r;if(r>0)for(var s=0;s<r;s++){i[s].active?(t.sectionPlanesActivePerLayer[n+s]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[n+s]=!1}return!0}},{key:"_updateRenderFlags",value:function(){if(0!==this.numVisibleLayerPortions&&this.numCulledLayerPortions!==this.numPortions){var e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){var t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0)this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0));if(this.numSelectedLayerPortions>0){var i=this.scene.selectedMaterial._state;i.fill&&(i.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){var r=this.scene.highlightMaterial._state;r.fill&&(r.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}},{key:"drawColorOpaque",value:function(e,t){for(var i=this.renderFlags,r=0,n=i.visibleLayers.length;r<n;r++){var s=i.visibleLayers[r];this.layerList[s].drawColorOpaque(i,e)}}},{key:"drawColorTransparent",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawColorTransparent(t,e)}}},{key:"drawDepth",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawDepth(t,e)}}},{key:"drawNormals",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawNormals(t,e)}}},{key:"drawSilhouetteXRayed",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawSilhouetteXRayed(t,e)}}},{key:"drawSilhouetteHighlighted",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawSilhouetteHighlighted(t,e)}}},{key:"drawSilhouetteSelected",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawSilhouetteSelected(t,e)}}},{key:"drawEdgesColorOpaque",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawEdgesColorOpaque(t,e)}}},{key:"drawEdgesColorTransparent",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawEdgesColorTransparent(t,e)}}},{key:"drawEdgesXRayed",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawEdgesXRayed(t,e)}}},{key:"drawEdgesHighlighted",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawEdgesHighlighted(t,e)}}},{key:"drawEdgesSelected",value:function(e){for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawEdgesSelected(t,e)}}},{key:"drawOcclusion",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawOcclusion(t,e)}}},{key:"drawShadow",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawShadow(t,e)}}},{key:"setPickMatrices",value:function(e,t){if(0!==this._numVisibleLayerPortions)for(var i=this.renderFlags,r=0,n=i.visibleLayers.length;r<n;r++){var s=i.visibleLayers[r],o=this.layerList[s];o.setPickMatrices&&o.setPickMatrices(e,t)}}},{key:"drawPickMesh",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawPickMesh(t,e)}}},{key:"drawPickDepths",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawPickDepths(t,e)}}},{key:"drawPickNormals",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i];this.layerList[n].drawPickNormals(t,e)}}},{key:"drawSnapInit",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i],s=this.layerList[n];s.drawSnapInit&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,s.drawSnapInit(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}},{key:"drawSnap",value:function(e){if(0!==this.numVisibleLayerPortions)for(var t=this.renderFlags,i=0,r=t.visibleLayers.length;i<r;i++){var n=t.visibleLayers[i],s=this.layerList[n];s.drawSnap&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,s.drawSnap(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}},{key:"destroy",value:function(){for(var e in this._vboBatchingLayers)this._vboBatchingLayers.hasOwnProperty(e)&&this._vboBatchingLayers[e].destroy();for(var t in this._vboBatchingLayers={},this._vboInstancingLayers)this._vboInstancingLayers.hasOwnProperty(t)&&this._vboInstancingLayers[t].destroy();this._vboInstancingLayers={},this.scene.camera.off(this._onCameraViewMatrix),this.scene.off(this._onTick);for(var r=0,n=this.layerList.length;r<n;r++)this.layerList[r].destroy();this.layerList=[];for(var s=0,o=this._entityList.length;s<o;s++)this._entityList[s]._destroy();this._layersToFinalize={},this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._meshes={},this._entities={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==fs&&0==--fs&&ps._clear(),v(x(i.prototype),"destroy",this).call(this)}}]),i}();function Rc(e,t,i){var r,n,s,o;if(t||i){var a=C(ac({positionsCompressed:e.positionsCompressed,indices:e.indices,edgeIndices:e.edgeIndices}),3);r=a[0],n=a[1],s=a[2]}else r=e.positionsCompressed,n=e.indices,s=e.edgeIndices;i?o=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.positionsCompressed||[],n=Ac(e.indices||[],t),s=dc(e.edgeIndices||[]);function o(e,t){if(e>t){var i=e;e=t,t=i}function r(i,r){return i!==e?e-i:r!==t?t-r:0}for(var n=0,o=(s.length>>1)-1;n<=o;){var a=o+n>>1,l=r(s[2*a],s[2*a+1]);if(l>0)n=a+1;else{if(!(l<0))return a;o=a-1}}return-n-1}var a=new Int32Array(s.length/2);a.fill(0);var l=r.length/3;if(l>8*(1<<t))return[e];var u=new Int32Array(l);u.fill(-1);var A=[];function c(){u.fill(-1);var e={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<t)-t,numPositions:0,bucketNumber:A.length};return A.push(e),e}for(var h=c(),d=0,p=n.length;d<p;d+=3){var f=0,v=n[d],g=n[d+1],m=n[d+2];if(-1===u[v]&&f++,-1===u[g]&&f++,-1===u[m]&&f++,f+h.numPositions>h.maxNumPositions&&(h=c()),h.bucketNumber>8)return[e];-1===u[v]&&(u[v]=h.numPositions++,h.positionsCompressed.push(r[3*v]),h.positionsCompressed.push(r[3*v+1]),h.positionsCompressed.push(r[3*v+2])),-1===u[g]&&(u[g]=h.numPositions++,h.positionsCompressed.push(r[3*g]),h.positionsCompressed.push(r[3*g+1]),h.positionsCompressed.push(r[3*g+2])),-1===u[m]&&(u[m]=h.numPositions++,h.positionsCompressed.push(r[3*m]),h.positionsCompressed.push(r[3*m+1]),h.positionsCompressed.push(r[3*m+2])),h.indices.push(u[v]),h.indices.push(u[g]),h.indices.push(u[m]);var _=void 0;(_=o(v,g))>=0&&0===a[_]&&(a[_]=1,h.edgeIndices.push(u[s[2*_]]),h.edgeIndices.push(u[s[2*_+1]])),(_=o(v,m))>=0&&0===a[_]&&(a[_]=1,h.edgeIndices.push(u[s[2*_]]),h.edgeIndices.push(u[s[2*_+1]])),(_=o(g,m))>=0&&0===a[_]&&(a[_]=1,h.edgeIndices.push(u[s[2*_]]),h.edgeIndices.push(u[s[2*_+1]]))}var y=t/8*2,b=t/8,w=2*r.length+(n.length+s.length)*y,B=0;return r.length,A.forEach((function(e){B+=2*e.positionsCompressed.length+(e.indices.length+e.edgeIndices.length)*b,e.positionsCompressed.length})),B>w?[e]:(i&&pc(A,e),A)}({positionsCompressed:r,indices:n,edgeIndices:s},r.length/3>65536?16:8):o=[{positionsCompressed:r,indices:n,edgeIndices:s}];return o}var Uc=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,e,n))._positions=n.positions||[],n.indices)r._indices=n.indices;else{r._indices=[];for(var s=0,o=r._positions.length/3-1;s<o;s+=2)r._indices.push(s),r._indices.push(s+1)}return r._color=n.color||[1,1,1],r._opacity=n.opacity||1,r._sceneModel=new Sc(w(r),{isModel:!1}),r._sceneModel.createMesh({id:"linesMesh",primitive:"lines",positions:r._positions,indices:r._indices,color:r._color,opacity:r._opacity}),r._sceneModel.createEntity({meshIds:["linesMesh"],visible:n.visible,clippable:n.clippable,collidable:n.collidable}),r._sceneModel.finalize(),r.scene._lineSetCreated(w(r)),r}return I(i,[{key:"visible",get:function(){return this._sceneModel.visible},set:function(e){this._sceneModel.visible=e}},{key:"positions",get:function(){return this._positions}},{key:"indices",get:function(){return this._indices}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene._lineSetDestroyed(this)}}]),i}(),Lc=function(e){m(i,Ie);var t=y(i);function i(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),t.call(this,e,r)}return I(i,[{key:"type",get:function(){return"Light"}},{key:"isLight",get:function(){return!0}}]),i}(),Oc=function(e){m(i,Lc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state={type:"ambient",color:le.vec3([.7,.7,.7]),intensity:1},r.color=n.color,r.intensity=n.intensity,r.scene._lightCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"AmbientLight"}},{key:"color",get:function(){return this._state.color},set:function(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}},{key:"intensity",get:function(){return this._state.intensity},set:function(e){this._state.intensity=void 0!==e?e:1,this.glRedraw()}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene._lightDestroyed(this)}}]),i}(),Nc=function(){function e(t,i,r){k(this,e),r=r||{},this.gl=i,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=r.size,this._hasDepthTexture=!!r.depthTexture}return I(e,[{key:"setSize",value:function(e){this.size=e}},{key:"webglContextRestored",value:function(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}},{key:"bind",value:function(){if(this._touch.apply(this,arguments),!this.bound){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}}},{key:"createTexture",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=this.gl,n=r.createTexture();return r.bindTexture(r.TEXTURE_2D,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),i?r.texStorage2D(r.TEXTURE_2D,1,i,e,t):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,null),n}},{key:"_touch",value:function(){var e,t,i=this,r=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=r.drawingBufferWidth,t=r.drawingBufferHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;this.buffer.textures.forEach((function(e){return r.deleteTexture(e)})),r.deleteFramebuffer(this.buffer.framebuf),r.deleteRenderbuffer(this.buffer.renderbuf)}for(var n,s=[],o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];a.length>0?s.push.apply(s,f(a.map((function(r){return i.createTexture(e,t,r)})))):s.push(this.createTexture(e,t)),this._hasDepthTexture&&(n=r.createTexture(),r.bindTexture(r.TEXTURE_2D,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT32F,e,t,0,r.DEPTH_COMPONENT,r.FLOAT,null));var u=r.createRenderbuffer();r.bindRenderbuffer(r.RENDERBUFFER,u),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT32F,e,t);var A=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,A);for(var c=0;c<s.length;c++)r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+c,r.TEXTURE_2D,s[c],0);if(a.length>0&&r.drawBuffers(s.map((function(e,t){return r.COLOR_ATTACHMENT0+t}))),this._hasDepthTexture?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,n,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,u),r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,A),!r.isFramebuffer(A))throw"Invalid framebuffer";r.bindFramebuffer(r.FRAMEBUFFER,null);var h=r.checkFramebufferStatus(r.FRAMEBUFFER);switch(h){case r.FRAMEBUFFER_COMPLETE:break;case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case r.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+h}this.buffer={framebuf:A,renderbuf:u,texture:s[0],textures:s,depthTexture:n,width:e,height:t},this.bound=!1}},{key:"clear",value:function(){if(!this.bound)throw"Render buffer not bound";var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"read",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Uint8Array,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,a=e,l=this.buffer.height?this.buffer.height-t-1:this.gl.drawingBufferHeight-t,u=new n(s),A=this.gl;return A.readBuffer(A.COLOR_ATTACHMENT0+o),A.readPixels(a,l,1,1,i||A.RGBA,r||A.UNSIGNED_BYTE,u,0),u}},{key:"readArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Uint8Array,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=new i(this.buffer.width*this.buffer.height*r),o=this.gl;return o.readBuffer(o.COLOR_ATTACHMENT0+n),o.readPixels(0,0,this.buffer.width,this.buffer.height,e||o.RGBA,t||o.UNSIGNED_BYTE,s,0),s}},{key:"readImageAsCanvas",value:function(){var e=this.gl,t=this._getImageDataCache(),i=t.pixelData,r=t.canvas,n=t.imageData,s=t.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,i);for(var o=this.buffer.width,a=this.buffer.height,l=a/2|0,u=4*o,A=new Uint8Array(4*o),c=0;c<l;++c){var h=c*u,d=(a-c-1)*u;A.set(i.subarray(h,h+u)),i.copyWithin(h,d,d+u),i.set(A,d)}return n.data.set(i),s.putImageData(n,0,0),r}},{key:"readImage",value:function(e){var t=this.gl,i=this._getImageDataCache(),r=i.pixelData,n=i.canvas,s=i.imageData,o=i.context,a=this.buffer,l=a.width,u=a.height;t.readPixels(0,0,l,u,t.RGBA,t.UNSIGNED_BYTE,r),s.data.set(r),o.putImageData(s,0,0),o.save(),o.globalCompositeOperation="copy",o.scale(1,-1),o.drawImage(n,0,-u,l,u),o.restore();var A=e.format||"png";return"jpeg"!==A&&"png"!==A&&"bmp"!==A&&(console.error("Unsupported image format: '"+A+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),A="png"),n.toDataURL("image/".concat(A))}},{key:"_getImageDataCache",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Uint8Array,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=this.buffer.width,r=this.buffer.height,n=this._imageDataCache;if(n&&(n.width===i&&n.height===r||(this._imageDataCache=null,n=null)),!n){var s=document.createElement("canvas"),o=s.getContext("2d");s.width=i,s.height=r,n={pixelData:new e(i*r*t),canvas:s,context:o,imageData:o.createImageData(i,r),width:i,height:r},this._imageDataCache=n}return n.context.resetTransform(),n}},{key:"unbind",value:function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}},{key:"getTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(i){return!(!t.buffer||!t.buffer.textures[e])&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.textures[e]),!0)},unbind:function(i){t.buffer&&t.buffer.textures[e]&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}},{key:"hasDepthTexture",value:function(){return this._hasDepthTexture}},{key:"getDepthTexture",value:function(){if(!this._hasDepthTexture)return null;var e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.depthTexture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0)},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}},{key:"destroy",value:function(){if(this.allocated){var e=this.gl;this.buffer.textures.forEach((function(t){return e.deleteTexture(t)})),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}]),e}(),Vc=function(e){m(i,Lc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n))._shadowRenderBuf=null,r._shadowViewMatrix=null,r._shadowProjMatrix=null,r._shadowViewMatrixDirty=!0,r._shadowProjMatrixDirty=!0;var s=r.scene.camera,o=r.scene.canvas;return r._onCameraViewMatrix=s.on("viewMatrix",(function(){r._shadowViewMatrixDirty=!0})),r._onCameraProjMatrix=s.on("projMatrix",(function(){r._shadowProjMatrixDirty=!0})),r._onCanvasBoundary=o.on("boundary",(function(){r._shadowProjMatrixDirty=!0})),r._state=new nt({type:"dir",dir:le.vec3([1,1,1]),color:le.vec3([.7,.7,.8]),intensity:1,space:n.space||"view",castsShadow:!1,getShadowViewMatrix:function(){if(r._shadowViewMatrixDirty){r._shadowViewMatrix||(r._shadowViewMatrix=le.identityMat4());var e=r.scene.camera,t=r._state.dir,i=e.look,n=[i[0]-t[0],i[1]-t[1],i[2]-t[2]];le.lookAtMat4v(n,i,[0,1,0],r._shadowViewMatrix),r._shadowViewMatrixDirty=!1}return r._shadowViewMatrix},getShadowProjMatrix:function(){return r._shadowProjMatrixDirty&&(r._shadowProjMatrix||(r._shadowProjMatrix=le.identityMat4()),le.orthoMat4c(-40,40,-40,40,-40,80,r._shadowProjMatrix),r._shadowProjMatrixDirty=!1),r._shadowProjMatrix},getShadowRenderBuf:function(){return r._shadowRenderBuf||(r._shadowRenderBuf=new Nc(r.scene.canvas.canvas,r.scene.canvas.gl,{size:[1024,1024]})),r._shadowRenderBuf}}),r.dir=n.dir,r.color=n.color,r.intensity=n.intensity,r.castsShadow=n.castsShadow,r.scene._lightCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"DirLight"}},{key:"dir",get:function(){return this._state.dir},set:function(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}},{key:"color",get:function(){return this._state.color},set:function(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}},{key:"intensity",get:function(){return this._state.intensity},set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}},{key:"castsShadow",get:function(){return this._state.castsShadow},set:function(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}},{key:"destroy",value:function(){var e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),v(x(i.prototype),"destroy",this).call(this),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}]),i}(),Qc=function(e){m(i,Lc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i);var s=w(r=t.call(this,e,n));r._shadowRenderBuf=null,r._shadowViewMatrix=null,r._shadowProjMatrix=null,r._shadowViewMatrixDirty=!0,r._shadowProjMatrixDirty=!0;var o=r.scene.camera,a=r.scene.canvas;return r._onCameraViewMatrix=o.on("viewMatrix",(function(){r._shadowViewMatrixDirty=!0})),r._onCameraProjMatrix=o.on("projMatrix",(function(){r._shadowProjMatrixDirty=!0})),r._onCanvasBoundary=a.on("boundary",(function(){r._shadowProjMatrixDirty=!0})),r._state=new nt({type:"point",pos:le.vec3([1,1,1]),color:le.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:n.space||"view",castsShadow:!1,getShadowViewMatrix:function(){if(s._shadowViewMatrixDirty){s._shadowViewMatrix||(s._shadowViewMatrix=le.identityMat4());var e=s._state.pos,t=o.look,i=o.up;le.lookAtMat4v(e,t,i,s._shadowViewMatrix),s._shadowViewMatrixDirty=!1}return s._shadowViewMatrix},getShadowProjMatrix:function(){if(s._shadowProjMatrixDirty){s._shadowProjMatrix||(s._shadowProjMatrix=le.identityMat4());var e=s.scene.canvas.canvas;le.perspectiveMat4(Math.PI/180*70,e.clientWidth/e.clientHeight,.1,500,s._shadowProjMatrix),s._shadowProjMatrixDirty=!1}return s._shadowProjMatrix},getShadowRenderBuf:function(){return s._shadowRenderBuf||(s._shadowRenderBuf=new Nc(s.scene.canvas.canvas,s.scene.canvas.gl,{size:[1024,1024]})),s._shadowRenderBuf}}),r.pos=n.pos,r.color=n.color,r.intensity=n.intensity,r.constantAttenuation=n.constantAttenuation,r.linearAttenuation=n.linearAttenuation,r.quadraticAttenuation=n.quadraticAttenuation,r.castsShadow=n.castsShadow,r.scene._lightCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"PointLight"}},{key:"pos",get:function(){return this._state.pos},set:function(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}},{key:"color",get:function(){return this._state.color},set:function(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}},{key:"intensity",get:function(){return this._state.intensity},set:function(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}},{key:"constantAttenuation",get:function(){return this._state.attenuation[0]},set:function(e){this._state.attenuation[0]=e||0,this.glRedraw()}},{key:"linearAttenuation",get:function(){return this._state.attenuation[1]},set:function(e){this._state.attenuation[1]=e||0,this.glRedraw()}},{key:"quadraticAttenuation",get:function(){return this._state.attenuation[2]},set:function(e){this._state.attenuation[2]=e||0,this.glRedraw()}},{key:"castsShadow",get:function(){return this._state.castsShadow},set:function(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}},{key:"destroy",value:function(){var e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),v(x(i.prototype),"destroy",this).call(this),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}]),i}();function Hc(e){return 0==(e&e-1)}function Gc(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}var jc=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i);var s=(r=t.call(this,e,n)).scene.canvas.gl;return r._state=new nt({texture:new Pn({gl:s,target:s.TEXTURE_CUBE_MAP}),flipY:r._checkFlipY(n.minFilter),encoding:r._checkEncoding(n.encoding),minFilter:1008,magFilter:1006,wrapS:1001,wrapT:1001,mipmaps:!0}),r._src=n.src,r._images=[],r._loadSrc(n.src),he.memory.textures++,r}return I(i,[{key:"type",get:function(){return"CubeTexture"}},{key:"_checkFlipY",value:function(e){return!!e}},{key:"_checkEncoding",value:function(e){return 3e3!==(e=e||3e3)&&3001!==e&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=3e3),e}},{key:"_webglContextRestored",value:function(){this.scene.canvas.gl,this._state.texture=null,this._src&&this._loadSrc(this._src)}},{key:"_loadSrc",value:function(e){var t=this,i=this.scene.canvas.gl;this._images=[];for(var r=!1,n=0,s=function(s){var o,a,l=new Image;l.onload=(o=l,a=s,function(){if(!r&&(o=function(e){if(!Hc(e.width)||!Hc(e.height)){var t=document.createElement("canvas");t.width=Gc(e.width),t.height=Gc(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}(o),t._images[a]=o,6==++n)){var e=t._state.texture;e||(e=new Pn({gl:i,target:i.TEXTURE_CUBE_MAP}),t._state.texture=e),e.setImage(t._images,t._state),t.fire("loaded",t._src,!1),t.glRedraw()}}),l.onerror=function(){r=!0},l.src=e[s]},o=0;o<e.length;o++)s(o)}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.texture&&this._state.texture.destroy(),he.memory.textures--,this._state.destroy()}}]),i}(),zc=function(e){m(i,jc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).scene._lightsState.addReflectionMap(r._state),r.scene._reflectionMapCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"ReflectionMap"}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene._reflectionMapDestroyed(this)}}]),i}(),Wc=function(e){m(i,jc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).scene._lightMapCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"LightMap"}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this.scene._lightMapDestroyed(this)}}]),i}(),Xc=le.vec4(),Kc=le.vec4(),Zc=function(e){m(i,Ie);var t=y(i);function i(e,r){var n;return k(this,i),(n=t.call(this,e,r))._entity=null,n._visible=null,n._worldPos=le.vec3(),n._origin=le.vec3(),n._rtcPos=le.vec3(),n._viewPos=le.vec3(),n._canvasPos=le.vec2(),n._occludable=!1,n._onCameraViewMatrix=n.scene.camera.on("matrix",(function(){n._viewPosDirty=!0,n._needUpdate()})),n._onCameraProjMatrix=n.scene.camera.on("projMatrix",(function(){n._canvasPosDirty=!0,n._needUpdate()})),n._onEntityDestroyed=null,n._onEntityModelDestroyed=null,n._renderer.addMarker(w(n)),n.entity=r.entity,n.worldPos=r.worldPos,n.occludable=r.occludable,n}return I(i,[{key:"_update",value:function(){if(this._viewPosDirty&&(le.transformPoint3(this.scene.camera.viewMatrix,this._worldPos,this._viewPos),this._viewPosDirty=!1,this._canvasPosDirty=!0,this.fire("viewPos",this._viewPos)),this._canvasPosDirty){Xc.set(this._viewPos),Xc[3]=1,le.transformPoint4(this.scene.camera.projMatrix,Xc,Kc);var e=this.scene.canvas.boundary;this._canvasPos[0]=Math.floor((1+Kc[0]/Kc[3])*e[2]/2),this._canvasPos[1]=Math.floor((1-Kc[1]/Kc[3])*e[3]/2),this._canvasPosDirty=!1,this.fire("canvasPos",this._canvasPos)}}},{key:"_setVisible",value:function(e){this._visible,this._visible=e,this.fire("visible",this._visible)}},{key:"entity",get:function(){return this._entity},set:function(e){var t=this;this._entity!==e&&(this._cleanupDestroyedHandlers(),this._entity=e,this._entity&&(this._entity.isSceneModelEntity?this._onEntityModelDestroyed=this._entity.model.on("destroyed",(function(){t._entity=null,t._onEntityModelDestroyed=null})):this._onEntityDestroyed=this._entity.on("destroyed",(function(){t._entity=null,t._onEntityDestroyed=null}))),this.fire("entity",this._entity,!0))}},{key:"occludable",get:function(){return this._occludable},set:function(e){(e=!!e)!==this._occludable&&(this._occludable=e,this._occludable&&this._renderer.markerWorldPosUpdated(this))}},{key:"worldPos",get:function(){return this._worldPos},set:function(e){this._worldPos.set(e||[0,0,0]),Yt(this._worldPos,this._origin,this._rtcPos),this._occludable&&this._renderer.markerWorldPosUpdated(this),this._viewPosDirty=!0,this.fire("worldPos",this._worldPos),this._needUpdate()}},{key:"origin",get:function(){return this._origin}},{key:"rtcPos",get:function(){return this._rtcPos}},{key:"viewPos",get:function(){return this._update(),this._viewPos}},{key:"canvasPos",get:function(){return this._update(),this._canvasPos}},{key:"visible",get:function(){return!!this._visible}},{key:"destroy",value:function(){this.fire("destroyed",!0),this.scene.camera.off(this._onCameraViewMatrix),this.scene.camera.off(this._onCameraProjMatrix),this._cleanupDestroyedHandlers(),this._renderer.removeMarker(this),v(x(i.prototype),"destroy",this).call(this)}},{key:"_cleanupDestroyedHandlers",value:function(){this._entity&&(null!==this._onEntityDestroyed&&(this._entity.model?this._entity.model.off(this._onEntityDestroyed):this._entity.off(this._onEntityDestroyed),this._onEntityDestroyed=null),null!==this._onEntityModelDestroyed&&(this._entity.model&&this._entity.model.off(this._onEntityModelDestroyed),this._onEntityModelDestroyed=null))}}]),i}(),Jc=function(e){m(i,Zc);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,{entity:n.entity,occludable:n.occludable,worldPos:n.worldPos}))._occluded=!1,r._visible=!0,r._src=null,r._image=null,r._pos=le.vec3(),r._origin=le.vec3(),r._rtcPos=le.vec3(),r._dir=le.vec3(),r._size=1,r._imageSize=le.vec2(),r._texture=new In(w(r),{src:n.src}),r._geometry=new mt(w(r),{primitive:"triangles",positions:[3,3,0,-3,3,0,-3,-3,0,3,-3,0],normals:[-1,0,0,-1,0,0,-1,0,0,-1,0,0],uv:[1,-1,0,-1,0,0,1,0],indices:[0,1,2,0,2,3]}),r._mesh=new vn(w(r),{geometry:r._geometry,material:new bn(w(r),{ambient:[.9,.3,.9],shininess:30,diffuseMap:r._texture,backfaces:!0}),scale:[1,1,1],position:n.worldPos,rotation:[90,0,0],billboard:"spherical",occluder:!1}),r.visible=!0,r.collidable=n.collidable,r.clippable=n.clippable,r.pickable=n.pickable,r.opacity=n.opacity,r.size=n.size,n.image?r.image=n.image:r.src=n.src,r}return I(i,[{key:"_setVisible",value:function(e){this._occluded=!e,this._mesh.visible=this._visible&&!this._occluded,v(x(i.prototype),"_setVisible",this).call(this,e)}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible=null==e||e,this._mesh.visible=this._visible&&!this._occluded}},{key:"image",get:function(){return this._image},set:function(e){this._image=e,this._image&&(this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}},{key:"src",get:function(){return this._src},set:function(e){var t=this;if(this._src=e,this._src){this._image=null;var i=new Image;i.onload=function(){t._texture.image=i,t._imageSize[0]=i.width,t._imageSize[1]=i.height,t._updatePlaneSizeFromImage()},i.src=this._src}}},{key:"size",get:function(){return this._size},set:function(e){this._size=null==e?1:e,this._image&&this._updatePlaneSizeFromImage()}},{key:"collidable",get:function(){return this._mesh.collidable},set:function(e){this._mesh.collidable=!1!==e}},{key:"clippable",get:function(){return this._mesh.clippable},set:function(e){this._mesh.clippable=!1!==e}},{key:"pickable",get:function(){return this._mesh.pickable},set:function(e){this._mesh.pickable=!1!==e}},{key:"opacity",get:function(){return this._mesh.opacity},set:function(e){this._mesh.opacity=e}},{key:"_updatePlaneSizeFromImage",value:function(){var e=.5*this._size,t=this._imageSize[0],i=this._imageSize[1],r=i/t;this._geometry.positions=t>i?[e,e*r,0,-e,e*r,0,-e,-e*r,0,e,-e*r,0]:[e/r,e,0,-e/r,e,0,-e/r,-e,0,e/r,-e,0]}}]),i}(),Yc=function(){function e(t){k(this,e),this._eye=le.vec3(),this._look=le.vec3(),this._up=le.vec3(),this._projection={},t&&this.saveCamera(t)}return I(e,[{key:"saveCamera",value:function(e){var t=e.camera,i=t.project;switch(this._eye.set(t.eye),this._look.set(t.look),this._up.set(t.up),t.projection){case"perspective":this._projection={projection:"perspective",fov:i.fov,fovAxis:i.fovAxis,near:i.near,far:i.far};break;case"ortho":this._projection={projection:"ortho",scale:i.scale,near:i.near,far:i.far};break;case"frustum":this._projection={projection:"frustum",left:i.left,right:i.right,top:i.top,bottom:i.bottom,near:i.near,far:i.far};break;case"custom":this._projection={projection:"custom",matrix:i.matrix.slice()}}}},{key:"restoreCamera",value:function(e,t){var i=e.camera,r=this._projection;function n(){switch(r.type){case"perspective":i.perspective.fov=r.fov,i.perspective.fovAxis=r.fovAxis,i.perspective.near=r.near,i.perspective.far=r.far;break;case"ortho":i.ortho.scale=r.scale,i.ortho.near=r.near,i.ortho.far=r.far;break;case"frustum":i.frustum.left=r.left,i.frustum.right=r.right,i.frustum.top=r.top,i.frustum.bottom=r.bottom,i.frustum.near=r.near,i.frustum.far=r.far;break;case"custom":i.customProjection.matrix=r.matrix}}t?e.viewer.cameraFlight.flyTo({eye:this._eye,look:this._look,up:this._up,orthoScale:r.scale,projection:r.projection},(function(){n(),t()})):(i.eye=this._eye,i.look=this._look,i.up=this._up,n(),i.projection=r.projection)}}]),e}(),qc=le.vec3(),$c=function(){function e(t){if(k(this,e),this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,t){var i=t.metaScene.scene;this.saveObjects(i,t)}}return I(e,[{key:"saveObjects",value:function(e,t,i){this.numObjects=0,this._mask=i?ge.apply(i,{}):null;for(var r=!i||i.visible,n=!i||i.edges,s=!i||i.xrayed,o=!i||i.highlighted,a=!i||i.selected,l=!i||i.clippable,u=!i||i.pickable,A=!i||i.colorize,c=!i||i.opacity,h=t.metaObjects,d=e.objects,p=0,f=h.length;p<f;p++){var v=d[h[p].id];if(v){if(r&&(this.objectsVisible[p]=v.visible),n&&(this.objectsEdges[p]=v.edges),s&&(this.objectsXrayed[p]=v.xrayed),o&&(this.objectsHighlighted[p]=v.highlighted),a&&(this.objectsSelected[p]=v.selected),l&&(this.objectsClippable[p]=v.clippable),u&&(this.objectsPickable[p]=v.pickable),A){var g=v.colorize;this.objectsColorize[3*p+0]=g[0],this.objectsColorize[3*p+1]=g[1],this.objectsColorize[3*p+2]=g[2]}c&&(this.objectsOpacity[p]=v.opacity),this.numObjects++}}}},{key:"restoreObjects",value:function(e,t){for(var i=this._mask,r=!i||i.visible,n=!i||i.edges,s=!i||i.xrayed,o=!i||i.highlighted,a=!i||i.selected,l=!i||i.clippable,u=!i||i.pickable,A=!i||i.colorize,c=!i||i.opacity,h=t.metaObjects,d=e.objects,p=0,f=h.length;p<f;p++){var v=d[h[p].id];v&&(r&&(v.visible=this.objectsVisible[p]),n&&(v.edges=this.objectsEdges[p]),s&&(v.xrayed=this.objectsXrayed[p]),o&&(v.highlighted=this.objectsHighlighted[p]),a&&(v.selected=this.objectsSelected[p]),l&&(v.clippable=this.objectsClippable[p]),u&&(v.pickable=this.objectsPickable[p]),A&&(qc[0]=this.objectsColorize[3*p+0],qc[1]=this.objectsColorize[3*p+1],qc[2]=this.objectsColorize[3*p+2],v.colorize=qc),c&&(v.opacity=this.objectsOpacity[p]))}}}]),e}(),eh=le.vec3(),th=function(){function e(){k(this,e),this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsHasColorize=[],this.objectsOpacity=[],this.numObjects=0}return I(e,[{key:"saveObjects",value:function(e,t){this.numObjects=0,this._mask=t?ge.apply(t,{}):null;var i=e.objects,r=!t||t.visible,n=!t||t.edges,s=!t||t.xrayed,o=!t||t.highlighted,a=!t||t.selected,l=!t||t.clippable,u=!t||t.pickable,A=!t||t.colorize,c=!t||t.opacity;for(var h in i)if(i.hasOwnProperty(h)){var d=i[h],p=this.numObjects;if(r&&(this.objectsVisible[p]=d.visible),n&&(this.objectsEdges[p]=d.edges),s&&(this.objectsXrayed[p]=d.xrayed),o&&(this.objectsHighlighted[p]=d.highlighted),a&&(this.objectsSelected[p]=d.selected),l&&(this.objectsClippable[p]=d.clippable),u&&(this.objectsPickable[p]=d.pickable),A){var f=d.colorize;f?(this.objectsColorize[3*p+0]=f[0],this.objectsColorize[3*p+1]=f[1],this.objectsColorize[3*p+2]=f[2],this.objectsHasColorize[p]=!0):this.objectsHasColorize[p]=!1}c&&(this.objectsOpacity[p]=d.opacity),this.numObjects++}}},{key:"restoreObjects",value:function(e){var t=this._mask,i=!t||t.visible,r=!t||t.edges,n=!t||t.xrayed,s=!t||t.highlighted,o=!t||t.selected,a=!t||t.clippable,l=!t||t.pickable,u=!t||t.colorize,A=!t||t.opacity,c=0,h=e.objects;for(var d in h)if(h.hasOwnProperty(d)){var p=h[d];i&&(p.visible=this.objectsVisible[c]),r&&(p.edges=this.objectsEdges[c]),n&&(p.xrayed=this.objectsXrayed[c]),s&&(p.highlighted=this.objectsHighlighted[c]),o&&(p.selected=this.objectsSelected[c]),a&&(p.clippable=this.objectsClippable[c]),l&&(p.pickable=this.objectsPickable[c]),u&&(this.objectsHasColorize[c]?(eh[0]=this.objectsColorize[3*c+0],eh[1]=this.objectsColorize[3*c+1],eh[2]=this.objectsColorize[3*c+2],p.colorize=eh):p.colorize=null),A&&(p.opacity=this.objectsOpacity[c]),c++}}}]),e}(),ih=function(e){m(i,ze);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).v0=n.v0,r.v1=n.v1,r.v2=n.v2,r.v3=n.v3,r.t=n.t,r}return I(i,[{key:"v0",get:function(){return this._v0},set:function(e){this._v0=e||le.vec3([0,0,0])}},{key:"v1",get:function(){return this._v1},set:function(e){this._v1=e||le.vec3([0,0,0])}},{key:"v2",get:function(){return this._v2},set:function(e){this._v2=e||le.vec3([0,0,0])}},{key:"v3",get:function(){return this._v3},set:function(e){this.fire("v3",this._v3=e||le.vec3([0,0,0]))}},{key:"t",get:function(){return this._t},set:function(e){e=e||0,this._t=e<0?0:e>1?1:e}},{key:"point",get:function(){return this.getPoint(this._t)}},{key:"getPoint",value:function(e){var t=le.vec3();return t[0]=le.b3(e,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),t[1]=le.b3(e,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),t[2]=le.b3(e,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),t}},{key:"getJSON",value:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}}]),i}(),rh=function(e){m(i,ze);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._cachedLengths=[],r._dirty=!0,r._curves=[],r._t=0,r._dirtySubs=[],r._destroyedSubs=[],r.curves=n.curves||[],r.t=n.t,r}return I(i,[{key:"addCurve",value:function(e){this._curves.push(e),this._dirty=!0}},{key:"curves",get:function(){return this._curves},set:function(e){var t,i,r;for(e=e||[],i=0,r=this._curves.length;i<r;i++)(t=this._curves[i]).off(this._dirtySubs[i]),t.off(this._destroyedSubs[i]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var n=this;function s(){n._dirty=!0}function o(){var e=this.id;for(i=0,r=n._curves.length;i<r;i++)if(n._curves[i].id===e)return n._curves=n._curves.slice(i,i+1),n._dirtySubs=n._dirtySubs.slice(i,i+1),n._destroyedSubs=n._destroyedSubs.slice(i,i+1),void(n._dirty=!0)}for(i=0,r=e.length;i<r;i++){if(t=e[i],ge.isNumeric(t)||ge.isString(t)){var a=t;if(!(t=this.scene.components[a])){this.error("Component not found: "+_inQuotes(a));continue}}var l=t.type;"xeokit.SplineCurve"===l||"xeokit.Path"===l||"xeokit.CubicBezierCurve"===l||"xeokit.QuadraticBezierCurve"===l?(this._curves.push(t),this._dirtySubs.push(t.on("dirty",s)),this._destroyedSubs.push(t.once("destroyed",o))):this.error("Component "+_inQuotes(t.id)+" is not a xeokit.SplineCurve, xeokit.Path or xeokit.QuadraticBezierCurve")}this._dirty=!0}},{key:"t",get:function(){return this._t},set:function(e){e=e||0,this._t=e<0?0:e>1?1:e}},{key:"point",get:function(){return this.getPoint(this._t)}},{key:"length",get:function(){var e=this._getCurveLengths();return e[e.length-1]}},{key:"getPoint",value:function(e){for(var t,i=e*this.length,r=this._getCurveLengths(),n=0;n<r.length;){if(r[n]>=i){var s=1-(r[n]-i)/(t=this._curves[n]).length;return t.getPointAt(s)}n++}return null}},{key:"_getCurveLengths",value:function(){if(!this._dirty)return this._cachedLengths;var e,t=[],i=0,r=this._curves.length;for(e=0;e<r;e++)i+=this._curves[e].length,t.push(i);return this._cachedLengths=t,this._dirty=!1,t}},{key:"_getJSON",value:function(){for(var e=[],t=0,i=this._curves.length;t<i;t++)e.push(this._curves[t].id);return{curves:e,t:this._t}}},{key:"destroy",value:function(){var e,t,r;for(v(x(i.prototype),"destroy",this).call(this),e=0,t=this._curves.length;e<t;e++)(r=this._curves[e]).off(this._dirtySubs[e]),r.off(this._destroyedSubs[e])}}]),i}(),nh=function(e){m(i,ze);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).v0=n.v0,r.v1=n.v1,r.v2=n.v2,r.t=n.t,r}return I(i,[{key:"v0",get:function(){return this._v0},set:function(e){this._v0=e||le.vec3([0,0,0])}},{key:"v1",get:function(){return this._v1},set:function(e){this._v1=e||le.vec3([0,0,0])}},{key:"v2",get:function(){return this._v2},set:function(e){this._v2=e||le.vec3([0,0,0])}},{key:"t",get:function(){return this._t},set:function(e){e=e||0,this._t=e<0?0:e>1?1:e}},{key:"point",get:function(){return this.getPoint(this._t)}},{key:"getPoint",value:function(e){var t=le.vec3();return t[0]=le.b2(e,this._v0[0],this._v1[0],this._v2[0]),t[1]=le.b2(e,this._v0[1],this._v1[1],this._v2[1]),t[2]=le.b2(e,this._v0[2],this._v1[2],this._v2[2]),t}},{key:"getJSON",value:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}}}]),i}(),sh=function(e){m(i,Sc);var t=y(i);function i(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),t.call(this,e,r)}return I(i)}(),oh=le.vec3(),ah=le.vec3(),lh=le.vec4(),uh=le.vec3([0,0,-1]),Ah=le.vec3([0,0,1]),ch=le.vec3([0,1,0]),hh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({active:!0,pos:le.vec3(),quaternion:le.vec4(),roll:0,dir:le.vec3(),dist:0}),r.active=n.active,r.pos=n.pos,r.dir=n.dir,r.scene._sectionPlaneCreated(w(r)),r}return I(i,[{key:"type",get:function(){return"SectionPlane"}},{key:"active",get:function(){return this._state.active},set:function(e){this._state.active=!1!==e,this.glRedraw(),this.fire("active",this._state.active),this.scene.fire("sectionPlaneUpdated",this)}},{key:"pos",get:function(){return this._state.pos},set:function(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-le.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos),this.scene.fire("sectionPlaneUpdated",this)}},{key:"quaternion",get:function(){return this._state.quaternion},set:function(e){this._state.quaternion.set(e||[0,0,0,-1]),le.vec3ApplyQuaternion(this._state.quaternion,Ah,this._state.dir);var t=le.vec3ApplyQuaternion(this._state.quaternion,ch,oh),i=le.vec3PairToQuaternion(Ah,this._state.dir,lh),r=le.vec3ApplyQuaternion(i,ch,ah),n=Math.acos(Math.min(1,le.dotVec3(t,r))),s=Math.sign(le.dotVec3(this._state.dir,le.cross3Vec3(t,r,ah)));this._state.roll=s*n,this._onDirUpdated()}},{key:"roll",get:function(){return this._state.roll},set:function(e){this._state.roll=e||0,this._onDirRollUpdated()}},{key:"dir",get:function(){return this._state.dir},set:function(e){this._state.dir.set(e||uh),this._onDirRollUpdated()}},{key:"_onDirRollUpdated",value:function(){le.vec3PairToQuaternion(Ah,this._state.dir,this._state.quaternion),lh[0]=0,lh[1]=0,lh[2]=-1,lh[3]=this._state.roll,le.angleAxisToQuaternion(lh,lh),le.mulQuaternions(this._state.quaternion,lh,this._state.quaternion),this._onDirUpdated()}},{key:"_onDirUpdated",value:function(){this._state.dist=-le.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir),this.scene.fire("sectionPlaneUpdated",this)}},{key:"dist",get:function(){return this._state.dist}},{key:"flipDir",value:function(){le.mulVec3Scalar(this._state.dir,-1,this._state.dir),this.dir=this._state.dir}},{key:"destroy",value:function(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),dh=function(){function e(){k(this,e)}return I(e,[{key:"transcode",value:function(e,t){}},{key:"destroy",value:function(){}}]),e}(),ph=function(){function e(){k(this,e),this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1,this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._canvasPos=new Int16Array([0,0]),this._snappedCanvasPos=new Int16Array([0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}return I(e,[{key:"canvasPos",get:function(){return this._gotCanvasPos?this._canvasPos:null},set:function(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}},{key:"origin",get:function(){return this._gotOrigin?this._origin:null},set:function(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}},{key:"direction",get:function(){return this._gotDirection?this._direction:null},set:function(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}},{key:"indices",get:function(){return this.entity&&this._gotIndices?this._indices:null},set:function(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}},{key:"localPos",get:function(){return this.entity&&this._gotLocalPos?this._localPos:null},set:function(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}},{key:"snappedCanvasPos",get:function(){return this._gotSnappedCanvasPos?this._snappedCanvasPos:null},set:function(e){e?(this._snappedCanvasPos[0]=e[0],this._snappedCanvasPos[1]=e[1],this._gotSnappedCanvasPos=!0):this._gotSnappedCanvasPos=!1}},{key:"worldPos",get:function(){return this._gotWorldPos?this._worldPos:null},set:function(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}},{key:"viewPos",get:function(){return this.entity&&this._gotViewPos?this._viewPos:null},set:function(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}},{key:"bary",get:function(){return this.entity&&this._gotBary?this._bary:null},set:function(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}},{key:"worldNormal",get:function(){return this.entity&&this._gotWorldNormal?this._worldNormal:null},set:function(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}},{key:"uv",get:function(){return this.entity&&this._gotUV?this._uv:null},set:function(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}},{key:"snapped",get:function(){return this.snappedToEdge||this.snappedToVertex}},{key:"reset",value:function(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotSnappedCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1}}]),e}(),fh={isIphoneSafari:function(){var e=window.navigator.userAgent,t=/iPhone/i.test(e),i=/Safari/i.test(e)&&!/Chrome/i.test(e);return t&&i},isIphoneOrIpadSafari:function(){var e=window.navigator.userAgent,t=/iPhone|iPad/i.test(e)||/Macintosh/i.test(e)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2,i=/Safari/i.test(e)&&!/Chrome/i.test(e);return t&&i},isTouchDevice:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.mxMaxTouchPoints>0}},vh=function(){function e(t,i,r){k(this,e),this.id=r&&r.id?r.id:t,this.viewer=i,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,i.addPlugin(this)}return I(e,[{key:"scheduleTask",value:function(e){Fe.scheduleTask(e,null)}},{key:"fire",value:function(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);var r,n=this._eventSubs[e];if(n)for(var s in n)n.hasOwnProperty(s)&&(r=n[s],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}},{key:"on",value:function(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Z),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});var r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);var n=this._subIdMap.addItem();r[n]={callback:t,scope:i||this},this._subIdEvents[n]=e;var s=this._events[e];return void 0!==s&&t.call(i||this,s),n}},{key:"off",value:function(e){if(null!=e&&this._subIdEvents){var t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];var i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}}},{key:"once",value:function(e,t,i){var r=this,n=this.on(e,(function(e){r.off(n),t.call(i||this,e)}),i)}},{key:"hasSubs",value:function(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}},{key:"log",value:function(e){console.log("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"warn",value:function(e){console.warn("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"error",value:function(e){console.error("[xeokit plugin ".concat(this.id,"]: ").concat(e))}},{key:"send",value:function(e,t){}},{key:"destroy",value:function(){this.viewer.removePlugin(this)}}]),e}(),gh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._canvas=n.canvas,r._element=null,r._isCustom=!1,n.elementId&&(r._element=document.getElementById(n.elementId),r._element?r._adjustPosition():r.error("Can't find given Spinner HTML element: '"+n.elementId+"' - will automatically create default element")),r._element||r._createDefaultSpinner(),r.processes=0,r}return I(i,[{key:"type",get:function(){return"Spinner"}},{key:"_createDefaultSpinner",value:function(){this._injectDefaultCSS();var e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}},{key:"_injectDefaultCSS",value:function(){var e="xeokit-spinner-css";if(!document.getElementById(e)){var t=document.createElement("style");t.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",t.id=e,document.body.appendChild(t)}}},{key:"_adjustPosition",value:function(){if(!this._isCustom){var e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}}},{key:"processes",get:function(){return this._processes},set:function(e){if(e=e||0,this._processes!==e&&!(e<0)){var t=this._processes;this._processes=e;var i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}}},{key:"_destroy",value:function(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);var e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}]),i}(),mh=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_h=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n))._backgroundColor=le.vec3([n.backgroundColor?n.backgroundColor[0]:1,n.backgroundColor?n.backgroundColor[1]:1,n.backgroundColor?n.backgroundColor[2]:1]),r._backgroundColorFromAmbientLight=!!n.backgroundColorFromAmbientLight,r.canvas=n.canvas,r.gl=null,r.webgl2=!1,r.transparent=!!n.transparent,r.contextAttr=n.contextAttr||{},r.contextAttr.alpha=r.transparent,r.contextAttr.preserveDrawingBuffer=!!r.contextAttr.preserveDrawingBuffer,r.contextAttr.stencil=!1,r.contextAttr.premultipliedAlpha=!!r.contextAttr.premultipliedAlpha,r.contextAttr.antialias=!1!==r.contextAttr.antialias,r.resolutionScale=n.resolutionScale,r.canvas.width=Math.round(r.canvas.clientWidth*r._resolutionScale),r.canvas.height=Math.round(r.canvas.clientHeight*r._resolutionScale),r.boundary=[r.canvas.offsetLeft,r.canvas.offsetTop,r.canvas.clientWidth,r.canvas.clientHeight],r._initWebGL(n);var s=w(r);r.canvas.addEventListener("webglcontextlost",r._webglcontextlostListener=function(e){console.time("webglcontextrestored"),s.scene._webglContextLost(),s.fire("webglcontextlost"),e.preventDefault()},!1),r.canvas.addEventListener("webglcontextrestored",r._webglcontextrestoredListener=function(e){s._initWebGL(),s.gl&&(s.scene._webglContextRestored(s.gl),s.fire("webglcontextrestored",s.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);var o=!0,a=new ResizeObserver((function(e){var t,i=p(e);try{for(i.s();!(t=i.n()).done;){t.value.contentBoxSize&&(o=!0)}}catch(e){i.e(e)}finally{i.f()}}));return a.observe(r.canvas),r._tick=r.scene.on("tick",(function(){o&&(o=!1,s.canvas.width=Math.round(s.canvas.clientWidth*s._resolutionScale),s.canvas.height=Math.round(s.canvas.clientHeight*s._resolutionScale),s.boundary[0]=s.canvas.offsetLeft,s.boundary[1]=s.canvas.offsetTop,s.boundary[2]=s.canvas.clientWidth,s.boundary[3]=s.canvas.clientHeight,s.fire("boundary",s.boundary))})),r._spinner=new gh(r.scene,{canvas:r.canvas,elementId:n.spinnerElementId}),r}return I(i,[{key:"type",get:function(){return"Canvas"}},{key:"backgroundColorFromAmbientLight",get:function(){return this._backgroundColorFromAmbientLight},set:function(e){this._backgroundColorFromAmbientLight=!1!==e,this.glRedraw()}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){if((e=e||1)!==this._resolutionScale){this._resolutionScale=e;var t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw()}}},{key:"spinner",get:function(){return this._spinner}},{key:"_createCanvas",value:function(){var e="xeokit-canvas-"+le.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r.height="100%",r.width="100%",r.padding="0",r.margin="0",r.background="rgba(0,0,0,0);",r.float="left",r.left="0",r.top="0",r.position="absolute",r.opacity="1.0",r["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}},{key:"_getElementXY",value:function(e){for(var t=0,i=0;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}},{key:"_initWebGL",value:function(){if(!this.gl)for(var e=0;!this.gl&&e<mh.length;e++)try{this.gl=this.canvas.getContext(mh[e],this.contextAttr)}catch(e){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));var t=this.gl,i="__",r=t.activeTexture;t.activeTexture=function(e){i!==e&&(i=e,r.call(this,e))};var n={},s=t.bindTexture;t.bindTexture=function(e,t){n[i]!==t&&(n[i]=t,s.call(this,e,t))},this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl,WebGL2RenderingContext)}},{key:"getSnapshot",value:function(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}},{key:"readPixels",value:function(e,t,i,r){return this.scene._renderer.readPixels(e,t,i,r)}},{key:"loseWebGLContext",value:function(){this.canvas.loseContext&&this.canvas.loseContext()}},{key:"destroy",value:function(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,v(x(i.prototype),"destroy",this).call(this)}}]),i}(),yh=function(){function e(t){k(this,e),this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}return I(e,[{key:"reset",value:function(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.pickElementsCount=null,this.pickElementsOffset=null,this.lineWidth=1,this.snapPickLayerParams={},this.snapPickLayerNumber=0,this.snapPickCoordinateScale=le.vec3(),this.snapPickOrigin=le.vec3()}},{key:"getRTCViewMatrix",value:function(e,t){var i=this._rtcViewMats[e];return i||(i=this._getNewMat(),Jt(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}},{key:"getRTCPickViewMatrix",value:function(e,t){var i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();var r=this.pickViewMatrix||this._scene.camera.viewMatrix;Jt(r,t,i),this._rtcPickViewMats[e]=i}return i}},{key:"_getNewMat",value:function(){var e=this._matPool[this._matPoolNextFreeIndex];return e||(e=le.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}]),e}(),bh=function(){function e(t,i){k(this,e),this.scene=t,this.aabb=le.AABB3(),this.origin=le.vec3(i),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}return I(e,[{key:"addMarker",value:function(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}},{key:"markerWorldPosUpdated",value:function(e){if(this.markers[e.id]){var t=this.markerIndices[e.id];this.positions[3*t+0]=e.worldPos[0],this.positions[3*t+1]=e.worldPos[1],this.positions[3*t+2]=e.worldPos[2],this.positionsDirty=!0}}},{key:"removeMarker",value:function(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}},{key:"update",value:function(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}},{key:"_buildMarkerList",value:function(){for(var e in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}},{key:"_buildPositions",value:function(){for(var e=0,t=0;t<this.numMarkers;t++)if(this.markerList[t]){var i=this.markerList[t].rtcPos;this.positions[e++]=i[0],this.positions[e++]=i[1],this.positions[e++]=i[2],this.indices[t]=t}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}},{key:"_buildAABB",value:function(){var e=this.aabb;le.collapseAABB3(e),le.expandAABB3Points3(e,this.positions);var t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}},{key:"_buildVBOs",value:function(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(new Float32Array(this.positions));this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}var e=this.scene.canvas.gl,t=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new st(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new st(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}},{key:"_buildOcclusionTestList",value:function(){var e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,r=i[2],n=i[3],s=0;this.lenOcclusionTestList=0;for(var o=0;o<this.numMarkers;o++){var a=this.markerList[o];if(a.viewPos[2]>-t)a._setVisible(!1);else{var l=a.canvasPos,u=l[0],A=l[1];u+10<0||A+10<0||u-10>r||A-10>n?a._setVisible(!1):!a.entity||a.entity.visible?a.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=a,this.pixels[s++]=u,this.pixels[s++]=A):a._setVisible(!0):a._setVisible(!1)}}}},{key:"_updateActiveSectionPlanes",value:function(){var e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(var i=0;i<t;i++){var r=e[i];if(r.active){var n=le.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===n)return void(this.culledBySectionPlanes=!0);var s=0===n;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}},{key:"destroy",value:function(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}]),e}(),wh=le.vec3([1,0,0]),Bh=le.vec3(),xh=function(){function e(t,i){var r=this;k(this,e),this._scene=t,this._renderBufferManager=i,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(function(){r._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(function(){r._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(function(){r._occlusionTestListDirty=!0}))}return I(e,[{key:"addMarker",value:function(e){var t=e.origin.join(),i=this._occlusionLayers[t];i||(i=new bh(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}},{key:"markerWorldPosUpdated",value:function(e){var t=this._markersToOcclusionLayersMap[e.id];if(t){var i=e.origin.join();if(i!==t.originHash){1===t.numMarkers?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);var r=this._occlusionLayers[i];r||(r=new bh(this._scene,e.origin),this._occlusionLayers[i]=r,this._occlusionLayersListDirty=!0),r.addMarker(e),this._markersToOcclusionLayersMap[e.id]=r}else t.markerWorldPosUpdated(e)}}},{key:"removeMarker",value:function(e){var t=e.origin.join(),i=this._occlusionLayers[t];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}},{key:"needOcclusionTest",get:function(){return this._occlusionTestListDirty}},{key:"bindRenderBuf",value:function(){var e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(var t=0,i=this._occlusionLayersList.length;t<i;t++){this._occlusionLayersList[t].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}},{key:"_buildOcclusionLayersList",value:function(){var e=0;for(var t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}},{key:"_buildShaderSource",value:function(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}},{key:"_buildVertexShaderSource",value:function(){var e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// OcclusionTester vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = 20.0;"),e.logarithmicDepthBufferEnabled?i.push("vFragDepth = 1.0 + clipPos.w;"):e.markerZOffset<0&&i.push("clipPos.z += "+e.markerZOffset+";"),i.push("   gl_Position = clipPos;"),i.push("}"),i}},{key:"_buildFragmentShaderSource",value:function(){var e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,r=[];if(r.push("#version 300 es"),r.push("// OcclusionTester fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),i){r.push("in vec4 vWorldPosition;");for(var n=0;n<t.sectionPlanes.length;n++)r.push("uniform bool sectionPlaneActive"+n+";"),r.push("uniform vec3 sectionPlanePos"+n+";"),r.push("uniform vec3 sectionPlaneDir"+n+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  float dist = 0.0;");for(var s=0;s<t.sectionPlanes.length;s++)r.push("if (sectionPlaneActive"+s+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),r.push("}"),r}},{key:"_buildProgram",value:function(){this._program&&this._program.destroy();var e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Pr(t,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var n=0,s=i.sectionPlanes.length;n<s;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}}},{key:"drawMarkers",value:function(){var e=this._scene,t=e.canvas.gl,i=this._program,r=e._sectionPlanesState,n=e.camera,s=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),e.logarithmicDepthBufferEnabled){var o=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,o)}for(var a=0,l=this._occlusionLayersList.length;a<l;a++){var u=this._occlusionLayersList[a];if(u.update(),!u.culledBySectionPlanes){var A=u.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,Jt(n.viewMatrix,A));var c=r.sectionPlanes.length;if(c>0)for(var h=r.sectionPlanes,d=0;d<c;d++){var p=this._uSectionPlanes[d];if(p){var f=u.sectionPlanesActive[d];if(t.uniform1i(p.active,f?1:0),f){var v=h[d];t.uniform3fv(p.pos,ei(v.dist,v.dir,A,Bh)),t.uniform3fv(p.dir,v.dir)}}}this._aPosition.bindArrayBuffer(u.positionsBuf);var g=u.indicesBuf;g.bind(),t.drawElements(t.POINTS,g.numItems,g.itemType,0)}}}},{key:"doOcclusionTest",value:function(){for(var e=this._scene.canvas.resolutionScale,t=255*wh[0],i=255*wh[1],r=255*wh[2],n=0,s=this._occlusionLayersList.length;n<s;n++)for(var o=this._occlusionLayersList[n],a=0;a<o.lenOcclusionTestList;a++){var l=o.occlusionTestList[a],u=2*a,A=this._readPixelBuf.read(Math.round(o.pixels[u]*e),Math.round(o.pixels[u+1]*e)),c=A[0]===t&&A[1]===i&&A[2]===r;l._setVisible(c)}}},{key:"unbindRenderBuf",value:function(){this._readPixelBuf.unbind()}},{key:"destroy",value:function(){if(!this.destroyed){for(var e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}]),e}(),Ph=le.vec2(),Ch=function(){function e(t){k(this,e),this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}return I(e,[{key:"init",value:function(){this._rebuild=!0}},{key:"render",value:function(e){var t=this;if(this._build(),!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var e=!0;t._scene.camera.on("projMatrix",(function(){e=!0}));var i=le.mat4();return function(){return e&&le.inverseMat4(n.camera.projMatrix,i),i}}());var i=this._scene.canvas.gl,r=this._program,n=this._scene,s=n.sao,o=i.drawingBufferWidth,a=i.drawingBufferHeight,l=n.camera.project._state,u=l.near,A=l.far,c=l.matrix,h=this._getInverseProjectMat(),d=Math.random(),p="perspective"===n.camera.projection;Ph[0]=o,Ph[1]=a,i.viewport(0,0,o,a),i.clearColor(0,0,0,1),i.disable(i.DEPTH_TEST),i.disable(i.BLEND),i.frontFace(i.CCW),i.clear(i.COLOR_BUFFER_BIT),r.bind(),i.uniform1f(this._uCameraNear,u),i.uniform1f(this._uCameraFar,A),i.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),i.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,h),i.uniform1i(this._uPerspective,p),i.uniform1f(this._uScale,s.scale*(A/5)),i.uniform1f(this._uIntensity,s.intensity),i.uniform1f(this._uBias,s.bias),i.uniform1f(this._uKernelRadius,s.kernelRadius),i.uniform1f(this._uMinResolution,s.minResolution),i.uniform2fv(this._uViewport,Ph),i.uniform1f(this._uRandomSeed,d);var f=e.getDepthTexture();r.bindTexture(this._uDepthTexture,f,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}}},{key:"_build",value:function(){var e=!1,t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),e||this._rebuild){this._rebuild=!1;var i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new Pr(i,{vertex:["#version 300 es\n                    precision highp float;\n                    precision highp int;\n                    \n                    in vec3 aPosition;\n                    in vec2 aUV;            \n                    \n                    out vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:["#version 300 es      \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ".concat(this._numSamples,"\n                #define NUM_RINGS 4              \n            \n                in vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                out vec4 outColor;\n   \n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \toutColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }")]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var r=new Float32Array([1,1,0,1,0,0,1,0]),n=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new st(i,i.ARRAY_BUFFER,n,n.length,3,i.STATIC_DRAW),this._uvBuf=new st(i,i.ARRAY_BUFFER,r,r.length,2,i.STATIC_DRAW),this._indicesBuf=new st(i,i.ELEMENT_ARRAY_BUFFER,s,s.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}}},{key:"destroy",value:function(){this._program&&(this._program.destroy(),this._program=null)}}]),e}(),Mh=new Float32Array(Dh(17,[0,1])),Fh=new Float32Array(Dh(17,[1,0])),kh=new Float32Array(function(e,t){for(var i=[],r=0;r<=e;r++)i.push(Th(r,t));return i}(17,4)),Eh=new Float32Array(2),Ih=function(){function e(t){k(this,e),this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}return I(e,[{key:"init",value:function(){var e=this._scene.canvas.gl;if(this._program=new Pr(e,{vertex:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                in vec3 aPosition;\n                in vec2 aUV;\n                uniform vec2 uViewport;\n                out vec2 vUV;\n                out vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS ".concat(16,"\n\n                in vec2        vUV;\n                in vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                out vec4 outColor;\n        \n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    outColor = packFloatToRGBA(occlusionSum / weightSum);\n                }")]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),r=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new st(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new st(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new st(e,e.ELEMENT_ARRAY_BUFFER,r,r.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}},{key:"render",value:function(e,t,i){var r=this;if(!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var e=!0;r._scene.camera.on("projMatrix",(function(){e=!0}));var t=le.mat4();return function(){return e&&le.inverseMat4(o.camera.projMatrix,t),t}}());var n=this._scene.canvas.gl,s=this._program,o=this._scene,a=n.drawingBufferWidth,l=n.drawingBufferHeight,u=o.camera.project._state,A=u.near,c=u.far;n.viewport(0,0,a,l),n.clearColor(0,0,0,1),n.enable(n.DEPTH_TEST),n.disable(n.BLEND),n.frontFace(n.CCW),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),s.bind(),Eh[0]=a,Eh[1]=l,n.uniform2fv(this._uViewport,Eh),n.uniform1f(this._uCameraNear,A),n.uniform1f(this._uCameraFar,c),n.uniform1f(this._uDepthCutoff,.01),0===i?n.uniform2fv(this._uSampleOffsets,Fh):n.uniform2fv(this._uSampleOffsets,Mh),n.uniform1fv(this._uSampleWeights,kh);var h=e.getDepthTexture(),d=t.getTexture();s.bindTexture(this._uDepthTexture,h,0),s.bindTexture(this._uOcclusionTexture,d,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),n.drawElements(n.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}}},{key:"destroy",value:function(){this._program.destroy()}}]),e}();function Th(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)}function Dh(e,t){for(var i=[],r=0;r<=e;r++)i.push(t[0]*r),i.push(t[1]*r);return i}var Sh=function(){function e(t){k(this,e),this.scene=t,this._renderBuffersBasic={},this._renderBuffersScaled={}}return I(e,[{key:"getRenderBuffer",value:function(e,t){var i=1===this.scene.canvas.resolutionScale?this._renderBuffersBasic:this._renderBuffersScaled,r=i[e];return r||(r=new Nc(this.scene.canvas.canvas,this.scene.canvas.gl,t),i[e]=r),r}},{key:"destroy",value:function(){for(var e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(var t in this._renderBuffersScaled)this._renderBuffersScaled[t].destroy()}}]),e}(),Rh=le.vec3([0,0,0]),Uh=function(e,t){t=t||{};var i=new yh(e),r=e.canvas.canvas,n=e.canvas.gl,s=!!t.transparent,o=t.alphaDepthMask,a=new Z({}),l={},u={},A=[],c=[],h=[],d=!0,p=!0,f=!0,v=!0,g=!0,m=!0,_=!0,y=!0,b=new Sh(e),w=!1,B=new Ch(e),x=new Ih(e);function P(){d&&(!function(){for(var e in l)if(l.hasOwnProperty(e)){var t=l[e],i=t.drawableMap,r=t.drawableListPreCull,n=0;for(var s in i)i.hasOwnProperty(s)&&(r[n++]=i[s]);r.length=n}}(),d=!1,p=!0),p&&(!function(){var e=0;for(var t in l)if(l.hasOwnProperty(t))for(var i=l[t].drawableListPreCull,r=0,n=i.length;r<n;r++){var s=i[r];A[e++]=s}A.length=e,A.sort((function(e,t){return e.renderOrder-t.renderOrder}))}(),p=!1,f=!0),f&&function(){for(var e=0,t=0,i=0,r=A.length;i<r;i++){var n=A[i];n.rebuildRenderFlags(),n.renderFlags.culled||(n.isUI?h[t++]=n:c[e++]=n)}c.length=e,h.length=t}()}function C(e){if(e.castsShadow){var t=e.getShadowRenderBuf();if(t){for(var r in t.bind(),i.reset(),i.backfaces=!0,i.frontface=!0,i.shadowViewMatrix=e.getShadowViewMatrix(),i.shadowProjMatrix=e.getShadowProjMatrix(),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,1),n.enable(n.DEPTH_TEST),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),l)if(l.hasOwnProperty(r))for(var s=l[r].drawableList,o=0,a=s.length;o<a;o++){var u=s[o];!1!==u.visible&&u.castsShadow&&u.drawShadow&&(u.renderFlags.colorOpaque&&u.drawShadow(i))}t.unbind()}}}function M(t,r,s,o,l,u){var A=e.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=u.origin,i.pickViewMatrix=s,i.pickProjMatrix=o,i.pickInvisible=!!l.pickInvisible,i.pickClipPos=[D(r[0]*A,n.drawingBufferWidth),S(r[1]*A,n.drawingBufferHeight)],n.viewport(0,0,1,1),n.depthMask(!0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var d=l.includeEntityIds,p=l.excludeEntityIds,f=function(e){for(var t=0,r=e.length;t<r;t++){var n=e[t];!0!==n.culled&&!1!==n.visible&&(!n.drawPickMesh||!0!==l.pickInvisible&&!1===n.visible||!1===n.pickable||d&&!d[n.id]||p&&p[n.id]||n.drawPickMesh(i))}};f(c),h.length>0&&(n.clear(n.DEPTH_BUFFER_BIT),f(h));var v=t.read(0,0),g=v[0]+(v[1]<<8)+(v[2]<<16)+(v[3]<<24);if(!(g<0))return a.items[g]}function F(t,r,s,o,a,l){if(r.drawPickTriangles){var u=e.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=l.origin,i.pickViewMatrix=o,i.pickProjMatrix=a,i.pickClipPos=[D(s[0]*u,n.drawingBufferWidth),S(s[1]*u,n.drawingBufferHeight)],n.viewport(0,0,1,1),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),r.drawPickTriangles(i);var A=t.read(0,0),c=A[0]+256*A[1]+256*A[2]*256+256*A[3]*256*256;c*=3,l.primIndex=c}}this.scene=e,this._occlusionTester=null,this.capabilities={astcSupported:!!wn(n,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!wn(n,"WEBGL_compressed_texture_etc"),dxtSupported:!!wn(n,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!wn(n,"EXT_texture_compression_bptc"),pvrtcSupported:!(!wn(n,"WEBGL_compressed_texture_pvrtc")&&!wn(n,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(e){v=e,f=!0},this.setEdgesEnabled=function(e){g=e,f=!0},this.setSAOEnabled=function(e){m=e,f=!0},this.setPBREnabled=function(e){_=e,f=!0},this.setColorTextureEnabled=function(e){y=e,f=!0},this.needStateSort=function(){p=!0},this.shadowsDirty=function(){},this.imageDirty=function(){f=!0},this.webglContextLost=function(){},this.webglContextRestored=function(e){B.init(),x.init(),f=!0},this.addDrawable=function(e,t){var i=t.type;if(i){var r=l[i];r||(r={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},l[i]=r),r.count++,r.drawableMap[e]=t,u[e]=t,d=!0}else console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring")},this.removeDrawable=function(e){var t=u[e];if(t){var i=t.type,r=l[i];--r.count<=0?delete l[i]:delete r.drawableMap[e],delete u[e],d=!0}else console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring")},this.getPickID=function(e){return a.addItem(e)},this.putPickID=function(e){a.removeItem(e)},this.clear=function(t){if(n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),s)n.clearColor(1,1,1,1);else{var i=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;n.clearColor(i[0],i[1],i[2],1)}n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)},this.needsRender=function(){return f||d||p},this.render=function(t){(t=t||{}).force&&(f=!0),P(),f&&(!function(t){var r=e.sao;m&&r.possible&&function(t){var r=e.sao,s=b.getRenderBuffer("saoDepth",{depthTexture:!0});s.bind(),s.clear(),function(e){i.reset(),i.pass=e.pass,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.enable(n.CULL_FACE),n.depthMask(!0),!1!==e.clear&&n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);for(var t=0,r=c.length;t<r;t++){var s=c[t];!0!==s.culled&&!1!==s.visible&&s.drawDepth&&s.saoEnabled&&(s.renderFlags.colorOpaque&&s.drawDepth(i))}}(t),s.unbind();var o=b.getRenderBuffer("saoOcclusion");if(o.bind(),o.clear(),B.render(s),o.unbind(),r.blur){var a=b.getRenderBuffer("saoOcclusion2");a.bind(),a.clear(),x.render(s,o,0),a.unbind(),o.bind(),o.clear(),x.render(s,a,1),o.unbind()}}(t);(function(){for(var t=e._lightsState.lights,i=0,r=t.length;i<r;i++){var n=t[i];n.castsShadow&&C(n)}})(),function(t){var r=[],a=[],l=[],u=[],A=[],d=[],p=[],f=[],w=[],B=[],x=[],P=[],C=[],M=[],F=[],k=[],E=e._lightsState.getAmbientColorAndIntensity();if(i.reset(),i.pass=t.pass,i.withSAO=!1,i.pbrEnabled=_&&!!e.pbrEnabled,i.colorTextureEnabled=y&&!!e.colorTextureEnabled,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),s)n.clearColor(0,0,0,0);else{var I=e.canvas.backgroundColorFromAmbientLight?E:e.canvas.backgroundColor;n.clearColor(I[0],I[1],I[2],1)}n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.enable(n.CULL_FACE),n.depthMask(!0),n.lineWidth(1),i.lineWidth=1;var T,D,S=e.sao.possible;if(m&&S){var R=b.getRenderBuffer("saoOcclusion");i.occlusionTexture=R?R.getTexture():null}else i.occlusionTexture=null;var U=Date.now();!1!==t.clear&&n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var L=function(t){for(var c=0,h=0,_=0,y=0,b=0,E=0,I=0,R=0,U=0,L=0,O=0,N=0,V=0,Q=0,H=0,G=0,j=0,z=t.length;j<z;j++)if(!0!==(D=t[j]).culled&&!1!==D.visible){var W=D.renderFlags;W.colorOpaque&&(m&&S&&D.saoEnabled?r[c++]=D:D.drawColorOpaque(i)),v&&W.colorTransparent&&(l[_++]=D),W.xrayedSilhouetteTransparent&&(p[I++]=D),W.xrayedSilhouetteOpaque&&(A[b++]=D),W.highlightedSilhouetteTransparent&&(x[O++]=D),W.highlightedSilhouetteOpaque&&(w[U++]=D),W.selectedSilhouetteTransparent&&(F[H++]=D),W.selectedSilhouetteOpaque&&(C[V++]=D),D.edges&&g&&(W.edgesOpaque&&(a[h++]=D),W.edgesTransparent&&(u[y++]=D),W.selectedEdgesTransparent&&(k[G++]=D),W.selectedEdgesOpaque&&(M[Q++]=D),W.xrayedEdgesTransparent&&(f[R++]=D),W.xrayedEdgesOpaque&&(d[E++]=D),W.highlightedEdgesTransparent&&(P[N++]=D),W.highlightedEdgesOpaque&&(B[L++]=D))}if(c>0)for(i.withSAO=!0,T=0;T<c;T++)r[T].drawColorOpaque(i);if(h>0)for(T=0;T<h;T++)a[T].drawEdgesColorOpaque(i);if(b>0)for(T=0;T<b;T++)A[T].drawSilhouetteXRayed(i);if(E>0)for(T=0;T<E;T++)d[T].drawEdgesXRayed(i);if(I>0||R>0||_>0||y>0){if(n.enable(n.CULL_FACE),n.enable(n.BLEND),s?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):(n.blendEquation(n.FUNC_ADD),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,o||n.depthMask(!1),(_>0||y>0)&&n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),y>0)for(T=0;T<y;T++)(D=u[T]).drawEdgesColorTransparent(i);if(_>0){var X=i.pickOrigin||e.camera.eye;l.length=_;var K=l.map((function(e){return{drawable:e,distSq:le.distVec3(e.origin||Rh,X)}}));for(K.sort((function(e,t){return t.distSq-e.distSq})),T=0;T<_;T++)K[T].drawable.drawColorTransparent(i)}if(R>0)for(T=0;T<R;T++)f[T].drawEdgesXRayed(i);if(I>0)for(T=0;T<I;T++)p[T].drawSilhouetteXRayed(i);n.disable(n.BLEND),o||n.depthMask(!0)}if(U>0||L>0){if(i.lastProgramId=null,e.highlightMaterial.glowThrough&&n.clear(n.DEPTH_BUFFER_BIT),L>0)for(T=0;T<L;T++)B[T].drawEdgesHighlighted(i);if(U>0)for(T=0;T<U;T++)w[T].drawSilhouetteHighlighted(i)}if(O>0||N>0||U>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),s?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.CULL_FACE),N>0)for(T=0;T<N;T++)P[T].drawEdgesHighlighted(i);if(O>0)for(T=0;T<O;T++)x[T].drawSilhouetteHighlighted(i);n.disable(n.BLEND)}if(V>0||Q>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&n.clear(n.DEPTH_BUFFER_BIT),Q>0)for(T=0;T<Q;T++)M[T].drawEdgesSelected(i);if(V>0)for(T=0;T<V;T++)C[T].drawSilhouetteSelected(i)}if(H>0||G>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.CULL_FACE),n.enable(n.BLEND),s?(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)):n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),G>0)for(T=0;T<G;T++)k[T].drawEdgesSelected(i);if(H>0)for(T=0;T<H;T++)F[T].drawSilhouetteSelected(i);n.disable(n.BLEND)}};L(c),h.length>0&&(n.clear(n.DEPTH_BUFFER_BIT),L(h));var O=Date.now(),N=he.frame;N.renderTime=(O-U)/1e3,N.drawElements=i.drawElements,N.drawArrays=i.drawArrays,N.useProgram=i.useProgram,N.bindTexture=i.bindTexture,N.bindArray=i.bindArray;for(var V=Cr.MAX_TEXTURE_IMAGE_UNITS,Q=0;Q<V;Q++)n.activeTexture(n.TEXTURE0+Q);n.bindTexture(n.TEXTURE_CUBE_MAP,null),n.bindTexture(n.TEXTURE_2D,null);for(var H=Cr.MAX_VERTEX_ATTRIBS,G=0;G<H;G++)n.disableVertexAttribArray(G)}(t)}(t),he.frame.frameCount++,f=!1)},this.pick=function(){var t=le.vec3();le.mat4();var i=le.mat4(),n=le.vec3(),s=le.vec3([0,1,0]),o=new ph,a=le.vec2(),u=le.vec3(),A=le.vec3(),c=le.vec3();return le.vec3(),le.vec3(),function(h){var d,p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o;p.reset(),P();var f=null,v=null,g=null;for(var m in p.pickSurface=h.pickSurface,h.canvasPos?(u[0]=h.canvasPos[0],u[1]=h.canvasPos[1],f=e.camera.viewMatrix,v=e.camera.projMatrix,g=e.camera.projection,a[0]=e.camera.project.near,a[1]=e.camera.project.far,p.canvasPos=h.canvasPos):(h.matrix?(f=h.matrix,v=e.camera.projMatrix,g=e.camera.projection,a[0]=e.camera.project.near,a[1]=e.camera.project.far):(A.set(h.origin||[0,0,0]),c.set(h.direction||[0,0,1]),d=le.addVec3(A,c,t),n[0]=Math.random(),n[1]=Math.random(),n[2]=Math.random(),le.normalizeVec3(n),le.cross3Vec3(c,n,s),f=le.lookAtMat4v(A,d,s,i),v=e.camera.ortho.matrix,g="ortho",a[0]=e.camera.ortho.near,a[1]=e.camera.ortho.far,p.origin=A,p.direction=c),u[0]=.5*r.clientWidth,u[1]=.5*r.clientHeight),l)if(l.hasOwnProperty(m))for(var _=l[m].drawableList,y=0,w=_.length;y<w;y++){var B=_[y];B.setPickMatrices&&B.setPickMatrices(f,v)}var x=b.getRenderBuffer("pick",{size:[1,1]});x.bind();var C=M(x,u,f,v,h,p);if(!C)return x.unbind(),null;var k=C.delegatePickedEntity?C.delegatePickedEntity():C;return k?(h.pickSurface&&(C.canPickTriangle&&C.canPickTriangle()?(F(x,C,u,f,v,p),C.pickTriangleSurface(f,v,g,p),p.pickSurfacePrecision=!1):C.canPickWorldPos&&C.canPickWorldPos()&&(E(x,C,u,f,v,a,p),!1!==h.pickSurfaceNormal&&R(x,C,u,f,v,p),p.pickSurfacePrecision=!1)),x.unbind(),p.entity=k,p):(x.unbind(),null)}}();var k,E=function(){var t=le.vec4(),s=le.vec4(),o=le.vec4(),a=le.vec4(),l=le.vec4(),u=le.mat4(),A=le.mat4(),c=le.mat4();return function(h,d,p,f,v,g,m){var _=e.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=m.origin,i.pickViewMatrix=f,i.pickProjMatrix=v,i.pickZNear=g[0],i.pickZFar=g[1],i.pickElementsCount=d.pickElementsCount,i.pickElementsOffset=d.pickElementsOffset,i.pickClipPos=[D(p[0]*_,n.drawingBufferWidth),S(p[1]*_,n.drawingBufferHeight)],n.viewport(0,0,1,1),n.clearColor(0,0,0,0),n.depthMask(!0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),d.drawPickDepths(i);var y,b=function(e){var t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],i=[1/16777216,1/65536,1/256,1];return le.dotVec4(t,i)}(h.read(0,0)),w=(p[0]-r.clientWidth/2)/(r.clientWidth/2),B=-(p[1]-r.clientHeight/2)/(r.clientHeight/2),x=d.origin;if(x){var P=Jt(f,x,u);y=le.mulMat4(v,P,A)}else y=le.mulMat4(v,f,A);var C=le.inverseMat4(y,c);t[0]=w,t[1]=B,t[2]=-1,t[3]=1;var M=le.transformVec4(C,t);M=le.mulVec4Scalar(M,1/M[3]),s[0]=w,s[1]=B,s[2]=1,s[3]=1;var F=le.transformVec4(C,s);F=le.mulVec4Scalar(F,1/F[3]);var k=le.subVec3(F,M,o),E=le.addVec3(M,le.mulVec4Scalar(k,b,a),l);x&&le.addVec3(E,x),m.worldPos=E}}();function I(e){e.snapPickLayerParams=[],e.snapPickLayerNumber=0;for(var t=0,i=c.length;t<i;t++){var r=c[t];r.drawSnapInit&&!r.culled&&r.visible&&r.pickable&&r.drawSnapInit(e)}return e.snapPickLayerParams}function T(e){e.snapPickLayerParams=e.snapPickLayerParams||[],e.snapPickLayerNumber=e.snapPickLayerParams.length;for(var t=0,i=c.length;t<i;t++){var r=c[t];r.drawSnapInit&&r.drawSnap&&!r.culled&&r.visible&&r.pickable&&r.drawSnap(e)}return e.snapPickLayerParams}function D(e,t){return e/t*2-1}function S(e,t){return 1-e/t*2}function R(t,r,s,o,a,l){var u=e.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickOrigin=l.origin,i.pickViewMatrix=o,i.pickProjMatrix=a,i.pickClipPos=[D(s[0]*u,n.drawingBufferWidth),S(s[1]*u,n.drawingBufferHeight)];var A=b.getRenderBuffer("pick-normal",{size:[3,3]});A.bind(n.RGBA32I),n.viewport(0,0,A.size[0],A.size[1]),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.DEPTH_BUFFER_BIT),n.clearBufferiv(n.COLOR,0,new Int32Array([0,0,0,0])),r.drawPickNormals(i);var c=A.read(1,1,n.RGBA_INTEGER,n.INT,Int32Array,4);A.unbind();var h=[c[0]/le.MAX_INT,c[1]/le.MAX_INT,c[2]/le.MAX_INT];le.normalizeVec3(h),l.worldNormal=h}this.snapPick=(k=new ph,function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:k,s=t.canvasPos,o=t.origin,u=t.direction,A=t.snapRadius,c=t.snapToVertex,h=t.snapToEdge;if(!c&&!h)return this.pick({canvasPos:s,pickSurface:!0});var d=e.canvas.resolutionScale;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickZNear=e.camera.project.near,i.pickZFar=e.camera.project.far;var p=A||30,f=b.getRenderBuffer("uniquePickColors-aabs-".concat(p),{depthTexture:!0,size:[2*p+1,2*p+1]});i.snapVectorA=[s?D(s[0]*d,n.drawingBufferWidth):0,s?S(s[1]*d,n.drawingBufferHeight):0],i.snapInvVectorAB=[n.drawingBufferWidth/(2*p),n.drawingBufferHeight/(2*p)],f.bind(n.RGBA32I,n.RGBA32I,n.RGBA8UI),n.viewport(0,0,f.size[0],f.size[1]),n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.disable(n.CULL_FACE),n.depthMask(!0),n.disable(n.BLEND),n.depthFunc(n.LEQUAL),n.clear(n.DEPTH_BUFFER_BIT),n.clearBufferiv(n.COLOR,0,new Int32Array([0,0,0,0])),n.clearBufferiv(n.COLOR,1,new Int32Array([0,0,0,0])),n.clearBufferuiv(n.COLOR,2,new Uint32Array([0,0,0,0])),i.pickViewMatrix=s?e.camera.viewMatrix:le.lookAtMat4v(o,le.addVec3(o,u,le.vec3()),le.vec3([0,1,0]),le.mat4());var v=e.camera.projMatrix;for(var g in l)if(l.hasOwnProperty(g))for(var m=l[g].drawableList,_=0,y=m.length;_<y;_++){var w=m[_];w.setPickMatrices&&w.setPickMatrices(i.pickViewMatrix,v)}n.drawBuffers([n.COLOR_ATTACHMENT0,n.COLOR_ATTACHMENT1,n.COLOR_ATTACHMENT2]);var B=I(i),x=[];i.snapPickLayerParams=x,n.depthMask(!1),n.drawBuffers([n.COLOR_ATTACHMENT0]),c&&h?(i.snapMode="edge",T(i),i.snapMode="vertex",i.snapPickLayerNumber++,T(i)):(i.snapMode=c?"vertex":"edge",T(i)),n.depthMask(!0);var P=f.readArray(n.RGBA_INTEGER,n.INT,Int32Array,4),C=f.readArray(n.RGBA_INTEGER,n.INT,Int32Array,4,1),M=f.readArray(n.RGBA_INTEGER,n.UNSIGNED_INT,Uint32Array,4,2);f.unbind();var F=null,E=null,R=null,U=p,L=p,O=4*U+L*f.size[0]*4,N=P.slice(O,O+4),V=C.slice(O,O+4),Q=M.slice(O,O+4);if(0!==N[3]){var H=B[Math.abs(N[3])%B.length],G=H.origin,j=H.coordinateScale;F=[N[0]*j[0]+G[0],N[1]*j[1]+G[1],N[2]*j[2]+G[2]],E=le.normalizeVec3([V[0]/le.MAX_INT,V[1]/le.MAX_INT,V[2]/le.MAX_INT]);var z=Q[0]+(Q[1]<<8)+(Q[2]<<16)+(Q[3]<<24);R=a.items[z]}for(var W=[],X=0;X<P.length;X+=4)if(P[X+3]>0){var K=Math.floor(X/4),Z=f.size[0],J=K%Z-Math.floor(Z/2),Y=Math.floor(K/Z)-Math.floor(Z/2),q=Math.sqrt(Math.pow(J,2)+Math.pow(Y,2));W.push({x:J,y:Y,dist:q,isVertex:c&&h?P[X+3]>x.length/2:c,result:[P[X+0],P[X+1],P[X+2],P[X+3]],normal:[C[X+0],C[X+1],C[X+2],C[X+3]],id:[M[X+0],M[X+1],M[X+2],M[X+3]]})}var $=null,ee=null,te=null,ie=null;if(W.length>0){W.sort((function(e,t){return e.isVertex!==t.isVertex?e.isVertex?-1:1:e.dist-t.dist})),ie=W[0].isVertex?"vertex":"edge";var re=W[0].result,ne=W[0].normal,se=W[0].id,oe=x[re[3]],ae=oe.origin,ue=oe.coordinateScale;ee=le.normalizeVec3([ne[0]/le.MAX_INT,ne[1]/le.MAX_INT,ne[2]/le.MAX_INT]),$=[re[0]*ue[0]+ae[0],re[1]*ue[1]+ae[1],re[2]*ue[2]+ae[2]],te=a.items[se[0]+(se[1]<<8)+(se[2]<<16)+(se[3]<<24)]}if(null===F&&null==$)return null;var Ae=null;null!==$&&(Ae=e.camera.projectWorldPos($));var ce=te&&te.delegatePickedEntity?te.delegatePickedEntity():te;return!ce&&R&&(R=R.delegatePickedEntity?R.delegatePickedEntity():R),r.reset(),r.snappedToEdge="edge"===ie,r.snappedToVertex="vertex"===ie,r.worldPos=$||F,r.worldNormal=ee||E,r.entity=ce||R,r.canvasPos=s||e.camera.projectWorldPos(F||$),r.snappedCanvasPos=Ae||s,r}),this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new xh(e,b),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e)},this.removeMarker=function(e){this._occlusionTester.removeMarker(e)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){P(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.disable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);for(var e=0,t=c.length;e<t;e++){var r=c[e];r.drawOcclusion&&!0!==r.culled&&!1!==r.visible&&!1!==r.pickable&&r.drawOcclusion(i)}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(e,t,i,r){var n,s,o,a,l=b.getRenderBuffer("snapshot");for(l.bind(),l.clear(),this.render({force:!0,opaqueOnly:r}),s=0;s<i;s++)o=2*s,a=4*s,n=l.read(e[o],e[o+1]),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];l.unbind(),f=!0},this.beginSnapshot=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=b.getRenderBuffer("snapshot");e.width&&e.height&&t.setSize([e.width,e.height]),t.bind(),t.clear(),w=!0},this.renderSnapshot=function(){w&&(b.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),f=!0)},this.readSnapshot=function(e){return b.getRenderBuffer("snapshot").readImage(e)},this.readSnapshotAsCanvas=function(){return b.getRenderBuffer("snapshot").readImageAsCanvas()},this.endSnapshot=function(){w&&(b.getRenderBuffer("snapshot").unbind(),w=!1)},this.destroy=function(){l={},u={},b.destroy(),B.destroy(),x.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}},Lh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).KEY_BACKSPACE=8,r.KEY_TAB=9,r.KEY_ENTER=13,r.KEY_SHIFT=16,r.KEY_CTRL=17,r.KEY_ALT=18,r.KEY_PAUSE_BREAK=19,r.KEY_CAPS_LOCK=20,r.KEY_ESCAPE=27,r.KEY_PAGE_UP=33,r.KEY_PAGE_DOWN=34,r.KEY_END=35,r.KEY_HOME=36,r.KEY_LEFT_ARROW=37,r.KEY_UP_ARROW=38,r.KEY_RIGHT_ARROW=39,r.KEY_DOWN_ARROW=40,r.KEY_INSERT=45,r.KEY_DELETE=46,r.KEY_NUM_0=48,r.KEY_NUM_1=49,r.KEY_NUM_2=50,r.KEY_NUM_3=51,r.KEY_NUM_4=52,r.KEY_NUM_5=53,r.KEY_NUM_6=54,r.KEY_NUM_7=55,r.KEY_NUM_8=56,r.KEY_NUM_9=57,r.KEY_A=65,r.KEY_B=66,r.KEY_C=67,r.KEY_D=68,r.KEY_E=69,r.KEY_F=70,r.KEY_G=71,r.KEY_H=72,r.KEY_I=73,r.KEY_J=74,r.KEY_K=75,r.KEY_L=76,r.KEY_M=77,r.KEY_N=78,r.KEY_O=79,r.KEY_P=80,r.KEY_Q=81,r.KEY_R=82,r.KEY_S=83,r.KEY_T=84,r.KEY_U=85,r.KEY_V=86,r.KEY_W=87,r.KEY_X=88,r.KEY_Y=89,r.KEY_Z=90,r.KEY_LEFT_WINDOW=91,r.KEY_RIGHT_WINDOW=92,r.KEY_SELECT_KEY=93,r.KEY_NUMPAD_0=96,r.KEY_NUMPAD_1=97,r.KEY_NUMPAD_2=98,r.KEY_NUMPAD_3=99,r.KEY_NUMPAD_4=100,r.KEY_NUMPAD_5=101,r.KEY_NUMPAD_6=102,r.KEY_NUMPAD_7=103,r.KEY_NUMPAD_8=104,r.KEY_NUMPAD_9=105,r.KEY_MULTIPLY=106,r.KEY_ADD=107,r.KEY_SUBTRACT=109,r.KEY_DECIMAL_POINT=110,r.KEY_DIVIDE=111,r.KEY_F1=112,r.KEY_F2=113,r.KEY_F3=114,r.KEY_F4=115,r.KEY_F5=116,r.KEY_F6=117,r.KEY_F7=118,r.KEY_F8=119,r.KEY_F9=120,r.KEY_F10=121,r.KEY_F11=122,r.KEY_F12=123,r.KEY_NUM_LOCK=144,r.KEY_SCROLL_LOCK=145,r.KEY_SEMI_COLON=186,r.KEY_EQUAL_SIGN=187,r.KEY_COMMA=188,r.KEY_DASH=189,r.KEY_PERIOD=190,r.KEY_FORWARD_SLASH=191,r.KEY_GRAVE_ACCENT=192,r.KEY_OPEN_BRACKET=219,r.KEY_BACK_SLASH=220,r.KEY_CLOSE_BRACKET=221,r.KEY_SINGLE_QUOTE=222,r.KEY_SPACE=32,r.MOUSE_LEFT_BUTTON=260,r.MOUSE_MIDDLE_BUTTON=261,r.MOUSE_RIGHT_BUTTON=262,r.element=n.element,r.altDown=!1,r.ctrlDown=!1,r.mouseDownLeft=!1,r.mouseDownMiddle=!1,r.mouseDownRight=!1,r.keyDown=[],r.enabled=!0,r.keyboardEnabled=!0,r.mouseover=!1,r.mouseCanvasPos=le.vec2(),r._keyboardEventsElement=n.keyboardEventsElement||document,r._bindEvents(),r}return I(i,[{key:"_bindEvents",value:function(){var e=this;if(!this._eventsBound){this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=function(t){e.enabled&&e.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===e.KEY_CTRL?e.ctrlDown=!0:t.keyCode===e.KEY_ALT?e.altDown=!0:t.keyCode===e.KEY_SHIFT&&(e.shiftDown=!0),e.keyDown[t.keyCode]=!0,e.fire("keydown",t.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=function(t){e.enabled&&e.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===e.KEY_CTRL?e.ctrlDown=!1:t.keyCode===e.KEY_ALT?e.altDown=!1:t.keyCode===e.KEY_SHIFT&&(e.shiftDown=!1),e.keyDown[t.keyCode]=!1,e.fire("keyup",t.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=function(t){e.enabled&&(e.mouseover=!0,e._getMouseCanvasPos(t),e.fire("mouseenter",e.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=function(t){e.enabled&&(e.mouseover=!1,e._getMouseCanvasPos(t),e.fire("mouseleave",e.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!0;break;case 2:e.mouseDownMiddle=!0;break;case 3:e.mouseDownRight=!0}e._getMouseCanvasPos(t),e.element.focus(),e.fire("mousedown",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(t){if(e.enabled){switch(t.which){case 1:e.mouseDownLeft=!1;break;case 2:e.mouseDownMiddle=!1;break;case 3:e.mouseDownRight=!1}e.fire("mouseup",e.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=function(t){if(e.enabled){switch(t.which){case 1:case 3:e.mouseDownLeft=!1,e.mouseDownRight=!1;break;case 2:e.mouseDownMiddle=!1}e._getMouseCanvasPos(t),e.fire("click",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=function(t){if(e.enabled){switch(t.which){case 1:case 3:e.mouseDownLeft=!1,e.mouseDownRight=!1;break;case 2:e.mouseDownMiddle=!1}e._getMouseCanvasPos(t),e.fire("dblclick",e.mouseCanvasPos,!0),e.mouseover&&t.preventDefault()}});var t=this.scene.tickify((function(){return e.fire("mousemove",e.mouseCanvasPos,!0)}));this.element.addEventListener("mousemove",this._mouseMoveListener=function(i){e.enabled&&(e._getMouseCanvasPos(i),t(),e.mouseover&&i.preventDefault())}),this.element.addEventListener("contextmenu",this._contextmenuListener=function(t){e.enabled&&(e._getMouseCanvasPos(t),e.fire("contextmenu",e.mouseCanvasPos,!0))});var i=this.scene.tickify((function(t){e.fire("mousewheel",t,!0)}));this.element.addEventListener("wheel",this._mouseWheelListener=function(t,r){if(e.enabled){var n=Math.max(-1,Math.min(1,40*-t.deltaY));i(n)}},{passive:!0});var r,n;this.on("mousedown",(function(e){r=e[0],n=e[1]})),this.on("mouseup",(function(t){r>=t[0]-2&&r<=t[0]+2&&n>=t[1]-2&&n<=t[1]+2&&e.fire("mouseclicked",t,!0)})),this.element.addEventListener("touchstart",this._touchstartListener=function(t){e.enabled&&f(t.changedTouches).forEach((function(t){e.fire("touchstart",[t.identifier,e._getTouchCanvasPos(t)],!0)}))}),this.element.addEventListener("touchend",this._touchendListener=function(t){e.enabled&&f(t.changedTouches).forEach((function(t){e.fire("touchend",[t.identifier,e._getTouchCanvasPos(t)],!0)}))}),this._eventsBound=!0}}},{key:"_unbindEvents",value:function(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("contextmenu",this._contextmenuListener),this.element.removeEventListener("wheel",this._mouseWheelListener),this.element.removeEventListener("touchstart",this._touchstartListener),this.element.removeEventListener("touchend",this._touchendListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}},{key:"_getTouchCanvasPos",value:function(e){for(var t=e.target,i=0,r=0;t.offsetParent;)i+=t.offsetLeft,r+=t.offsetTop,t=t.offsetParent;return[e.pageX-i,e.pageY-r]}},{key:"_getMouseCanvasPos",value:function(e){if(e){var t=e.target.getBoundingClientRect();this.mouseCanvasPos[0]=e.clientX-t.left,this.mouseCanvasPos[1]=e.clientY-t.top}else e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y}},{key:"setEnabled",value:function(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}},{key:"getEnabled",value:function(){return this.enabled}},{key:"setKeyboardEnabled",value:function(e){this.keyboardEnabled=e}},{key:"getKeyboardEnabled",value:function(){return this.keyboardEnabled}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._unbindEvents()}}]),i}(),Oh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({boundary:[0,0,100,100]}),r.boundary=n.boundary,r.autoBoundary=n.autoBoundary,r}return I(i,[{key:"type",get:function(){return"Viewport"}},{key:"boundary",get:function(){return this._state.boundary},set:function(e){if(!this._autoBoundary){if(!e){var t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}},{key:"autoBoundary",get:function(){return this._autoBoundary},set:function(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){var t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}},{key:"_getState",value:function(){return this._state}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Nh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).camera=e,r._state=new nt({matrix:le.mat4(),inverseMatrix:le.mat4(),transposedMatrix:le.mat4(),near:.1,far:1e4}),r._inverseMatrixDirty=!0,r._transposedMatrixDirty=!0,r._fov=60,r._canvasResized=r.scene.canvas.on("boundary",r._needUpdate,w(r)),r.fov=n.fov,r.fovAxis=n.fovAxis,r.near=n.near,r.far=n.far,r}return I(i,[{key:"type",get:function(){return"Perspective"}},{key:"_update",value:function(){var e=this.scene.canvas.boundary,t=e[2]/e[3],i=this._fovAxis,r=this._fov;("x"===i||"min"===i&&t<1||"max"===i&&t>1)&&(r/=t),r=Math.min(r,120),le.perspectiveMat4(r*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.camera._updateScheduled=!0,this.fire("matrix",this._state.matrix)}},{key:"fov",get:function(){return this._fov},set:function(e){(e=null!=e?e:60)!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}},{key:"near",get:function(){return this._state.near},set:function(e){var t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}},{key:"far",get:function(){return this._state.far},set:function(e){var t=null!=e?e:1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(le.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(le.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var s=this.scene.canvas.canvas,o=s.offsetWidth/2,a=s.offsetHeight/2;return i[0]=(e[0]-o)/o,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,le.mulMat4v4(this.inverseMatrix,i,r),le.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,le.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}]),i}(),Vh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).camera=e,r._state=new nt({matrix:le.mat4(),inverseMatrix:le.mat4(),transposedMatrix:le.mat4(),near:.1,far:1e4}),r._inverseMatrixDirty=!0,r._transposedMatrixDirty=!0,r.scale=n.scale,r.near=n.near,r.far=n.far,r._onCanvasBoundary=r.scene.canvas.on("boundary",r._needUpdate,w(r)),r}return I(i,[{key:"type",get:function(){return"Ortho"}},{key:"_update",value:function(){var e,t,i,r,n=this.scene,s=.5*this._scale,o=n.canvas.boundary,a=o[2],l=o[3],u=a/l;a>l?(e=-s,t=s,i=s/u,r=-s/u):(e=-s*u,t=s*u,i=s,r=-s),le.orthoMat4c(e,t,r,i,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"scale",get:function(){return this._scale},set:function(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}},{key:"near",get:function(){return this._state.near},set:function(e){var t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}},{key:"far",get:function(){return this._state.far},set:function(e){var t=null!=e?e:1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(le.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(le.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var s=this.scene.canvas.canvas,o=s.offsetWidth/2,a=s.offsetHeight/2;return i[0]=(e[0]-o)/o,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,le.mulMat4v4(this.inverseMatrix,i,r),le.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,le.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}]),i}(),Qh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).camera=e,r._state=new nt({matrix:le.mat4(),inverseMatrix:le.mat4(),transposedMatrix:le.mat4(),near:.1,far:1e4}),r._left=-1,r._right=1,r._bottom=-1,r._top=1,r._inverseMatrixDirty=!0,r._transposedMatrixDirty=!0,r.left=n.left,r.right=n.right,r.bottom=n.bottom,r.top=n.top,r.near=n.near,r.far=n.far,r}return I(i,[{key:"type",get:function(){return"Frustum"}},{key:"_update",value:function(){le.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"left",get:function(){return this._left},set:function(e){this._left=null!=e?e:-1,this._needUpdate(0),this.fire("left",this._left)}},{key:"right",get:function(){return this._right},set:function(e){this._right=null!=e?e:1,this._needUpdate(0),this.fire("right",this._right)}},{key:"top",get:function(){return this._top},set:function(e){this._top=null!=e?e:1,this._needUpdate(0),this.fire("top",this._top)}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=null!=e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}},{key:"near",get:function(){return this._state.near},set:function(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}},{key:"far",get:function(){return this._state.far},set:function(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(le.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(le.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var s=this.scene.canvas.canvas,o=s.offsetWidth/2,a=s.offsetHeight/2;return i[0]=(e[0]-o)/o,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,le.mulMat4v4(this.inverseMatrix,i,r),le.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,le.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),Hh=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).camera=e,r._state=new nt({matrix:le.mat4(),inverseMatrix:le.mat4(),transposedMatrix:le.mat4()}),r._inverseMatrixDirty=!0,r._transposedMatrixDirty=!1,r.matrix=n.matrix,r}return I(i,[{key:"type",get:function(){return"CustomProjection"}},{key:"matrix",get:function(){return this._state.matrix},set:function(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}},{key:"inverseMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(le.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}},{key:"transposedMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(le.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}},{key:"unproject",value:function(e,t,i,r,n){var s=this.scene.canvas.canvas,o=s.offsetWidth/2,a=s.offsetHeight/2;return i[0]=(e[0]-o)/o,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,le.mulMat4v4(this.inverseMatrix,i,r),le.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,le.mulMat4v4(this.camera.inverseViewMatrix,r,n),n}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),Gh=le.vec3(),jh=le.vec3(),zh=le.vec3(),Wh=le.vec3(),Xh=le.vec3(),Kh=le.vec3(),Zh=le.vec4(),Jh=le.vec4(),Yh=le.vec4(),qh=le.mat4(),$h=le.mat4(),ed=le.vec3(),td=le.vec3(),id=le.vec3(),rd=le.vec3(),nd=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({offsetEyeFromLook:!0,deviceMatrix:le.mat4(),hasDeviceMatrix:!1,matrix:le.mat4(),normalMatrix:le.mat4(),inverseMatrix:le.mat4()}),r._perspective=new Nh(w(r)),r._ortho=new Vh(w(r)),r._frustum=new Qh(w(r)),r._customProjection=new Hh(w(r)),r._project=r._perspective,r._eye=le.vec3([0,0,10]),r._look=le.vec3([0,0,0]),r._up=le.vec3([0,1,0]),r._worldUp=le.vec3([0,1,0]),r._worldRight=le.vec3([1,0,0]),r._worldForward=le.vec3([0,0,-1]),r.deviceMatrix=n.deviceMatrix,r.eye=n.eye,r.look=n.look,r.up=n.up,r.worldAxis=n.worldAxis,r.gimbalLock=n.gimbalLock,r.constrainPitch=n.constrainPitch,r.projection=n.projection,r._perspective.on("matrix",(function(){"perspective"===r._projectionType&&r.fire("projMatrix",r._perspective.matrix)})),r._ortho.on("matrix",(function(){"ortho"===r._projectionType&&r.fire("projMatrix",r._ortho.matrix)})),r._frustum.on("matrix",(function(){"frustum"===r._projectionType&&r.fire("projMatrix",r._frustum.matrix)})),r._customProjection.on("matrix",(function(){"customProjection"===r._projectionType&&r.fire("projMatrix",r._customProjection.matrix)})),r}return I(i,[{key:"type",get:function(){return"Camera"}},{key:"_update",value:function(){var e,t=this._state;"ortho"===this.projection&&this._state.offsetEyeFromLook?(le.subVec3(this._eye,this._look,ed),le.normalizeVec3(ed,td),le.mulVec3Scalar(td,1e3,id),le.addVec3(this._look,id,rd),e=rd):e=this._eye,t.hasDeviceMatrix?(le.lookAtMat4v(e,this._look,this._up,$h),le.mulMat4(t.deviceMatrix,$h,t.matrix)):le.lookAtMat4v(e,this._look,this._up,t.matrix),le.inverseMat4(this._state.matrix,this._state.inverseMatrix),le.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}},{key:"orbitYaw",value:function(e){var t=le.subVec3(this._eye,this._look,Gh);le.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,qh),t=le.transformPoint3(qh,t,jh),this.eye=le.addVec3(this._look,t,zh),this.up=le.transformPoint3(qh,this._up,Wh)}},{key:"orbitPitch",value:function(e){if(!(this._constrainPitch&&(e=le.dotVec3(this._up,this._worldUp)/le.DEGTORAD)<1)){var t=le.subVec3(this._eye,this._look,Gh),i=le.cross3Vec3(le.normalizeVec3(t,jh),le.normalizeVec3(this._up,zh));le.rotationMat4v(.0174532925*e,i,qh),t=le.transformPoint3(qh,t,Wh),this.up=le.transformPoint3(qh,this._up,Xh),this.eye=le.addVec3(t,this._look,Kh)}}},{key:"yaw",value:function(e){var t=le.subVec3(this._look,this._eye,Gh);le.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,qh),t=le.transformPoint3(qh,t,jh),this.look=le.addVec3(t,this._eye,zh),this._gimbalLock&&(this.up=le.transformPoint3(qh,this._up,Wh))}},{key:"pitch",value:function(e){if(!(this._constrainPitch&&(e=le.dotVec3(this._up,this._worldUp)/le.DEGTORAD)<1)){var t=le.subVec3(this._look,this._eye,Gh),i=le.cross3Vec3(le.normalizeVec3(t,jh),le.normalizeVec3(this._up,zh));le.rotationMat4v(.0174532925*e,i,qh),this.up=le.transformPoint3(qh,this._up,Kh),t=le.transformPoint3(qh,t,Wh),this.look=le.addVec3(t,this._eye,Xh)}}},{key:"pan",value:function(e){var t,i=le.subVec3(this._eye,this._look,Gh),r=[0,0,0];if(0!==e[0]){var n=le.cross3Vec3(le.normalizeVec3(i,[]),le.normalizeVec3(this._up,jh));t=le.mulVec3Scalar(n,e[0]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]}0!==e[1]&&(t=le.mulVec3Scalar(le.normalizeVec3(this._up,zh),e[1]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]),0!==e[2]&&(t=le.mulVec3Scalar(le.normalizeVec3(i,Wh),e[2]),r[0]+=t[0],r[1]+=t[1],r[2]+=t[2]),this.eye=le.addVec3(this._eye,r,Xh),this.look=le.addVec3(this._look,r,Kh)}},{key:"zoom",value:function(e){var t=le.subVec3(this._eye,this._look,Gh),i=Math.abs(le.lenVec3(t,jh)),r=Math.abs(i+e);if(!(r<.5)){var n=le.normalizeVec3(t,zh);this.eye=le.addVec3(this._look,le.mulVec3Scalar(n,r),Wh)}}},{key:"eye",get:function(){return this._eye},set:function(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}},{key:"look",get:function(){return this._look},set:function(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}},{key:"up",get:function(){return this._up},set:function(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}},{key:"deviceMatrix",get:function(){return this._state.deviceMatrix},set:function(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}},{key:"worldAxis",get:function(){return this._worldAxis},set:function(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=le.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}},{key:"worldUp",get:function(){return this._worldUp}},{key:"xUp",get:function(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}},{key:"yUp",get:function(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}},{key:"zUp",get:function(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}},{key:"worldRight",get:function(){return this._worldRight}},{key:"worldForward",get:function(){return this._worldForward}},{key:"gimbalLock",get:function(){return this._gimbalLock},set:function(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}},{key:"constrainPitch",set:function(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}},{key:"eyeLookDist",get:function(){return le.lenVec3(le.subVec3(this._look,this._eye,Gh))}},{key:"matrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"viewMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},{key:"normalMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},{key:"viewNormalMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},{key:"inverseViewMatrix",get:function(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}},{key:"projMatrix",get:function(){return this[this.projection].matrix}},{key:"perspective",get:function(){return this._perspective}},{key:"ortho",get:function(){return this._ortho}},{key:"frustum",get:function(){return this._frustum}},{key:"customProjection",get:function(){return this._customProjection}},{key:"projection",get:function(){return this._projectionType},set:function(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}},{key:"project",get:function(){return this._project}},{key:"offsetEyeFromLook",get:function(){return this._state.offsetEyeFromLook},set:function(e){this._state.offsetEyeFromLook=e,this._needUpdate(0)}},{key:"projectWorldPos",value:function(e){var t=Zh,i=Jh,r=Yh;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,le.mulMat4v4(this.viewMatrix,t,i),le.mulMat4v4(this.projMatrix,i,r),le.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1;var n=this.scene.canvas.canvas,s=n.offsetWidth/2,o=n.offsetHeight/2;return[r[0]*s+s,r[1]*o+o]}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),sd={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}},od=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._units="meters",r._scale=1,r._origin=le.vec3([0,0,0]),r.units=n.units,r.scale=n.scale,r.origin=n.origin,r}return I(i,[{key:"unitsInfo",get:function(){return sd}},{key:"units",get:function(){return this._units},set:function(e){e||(e="meters"),sd[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}},{key:"scale",get:function(){return this._scale},set:function(e){(e=e||1)<=0?this.error("scale value should be larger than zero"):(this._scale=e,this.fire("scale",this._scale))}},{key:"origin",get:function(){return this._origin},set:function(e){if(!e)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}},{key:"worldToRealPos",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec3(3);t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}},{key:"realToWorldPos",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:le.vec3(3);return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}]),i}(),ad=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._supported=Cr.SUPPORTED_EXTENSIONS.OES_standard_derivatives,r.enabled=n.enabled,r.kernelRadius=n.kernelRadius,r.intensity=n.intensity,r.bias=n.bias,r.scale=n.scale,r.minResolution=n.minResolution,r.numSamples=n.numSamples,r.blur=n.blur,r.blendCutoff=n.blendCutoff,r.blendFactor=n.blendFactor,r}return I(i,[{key:"supported",get:function(){return this._supported}},{key:"enabled",get:function(){return this._enabled},set:function(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}},{key:"possible",get:function(){if(!this._supported)return!1;if(!this._enabled)return!1;var e=this.scene.camera.projection;return"customProjection"!==e&&"frustum"!==e}},{key:"active",get:function(){return this._active}},{key:"kernelRadius",get:function(){return this._kernelRadius},set:function(e){null==e&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}},{key:"intensity",get:function(){return this._intensity},set:function(e){null==e&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}},{key:"bias",get:function(){return this._bias},set:function(e){null==e&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}},{key:"scale",get:function(){return this._scale},set:function(e){null==e&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}},{key:"minResolution",get:function(){return this._minResolution},set:function(e){null==e&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}},{key:"numSamples",get:function(){return this._numSamples},set:function(e){null==e&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}},{key:"blur",get:function(){return this._blur},set:function(e){e=!1!==e,this._blur!==e&&(this._blur=e,this.glRedraw())}},{key:"blendCutoff",get:function(){return this._blendCutoff},set:function(e){null==e&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}},{key:"blendFactor",get:function(){return this._blendFactor},set:function(e){null==e&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}(),ld=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n)).sliceColor=n.sliceColor,r.sliceThickness=n.sliceThickness,r}return I(i,[{key:"sliceThickness",get:function(){return this._sliceThickness},set:function(e){null==e&&(e=0),this._sliceThickness!==e&&(this._sliceThickness=e,this.glRedraw())}},{key:"sliceColor",get:function(){return this._sliceColor},set:function(e){null==e&&(e=[0,0,0,1]),this._sliceColor!==e&&(this._sliceColor=e,this.glRedraw())}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}(),ud={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}},Ad=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),n.preset?(r.preset=n.preset,void 0!==n.pointSize&&(r.pointSize=n.pointSize),void 0!==n.roundPoints&&(r.roundPoints=n.roundPoints),void 0!==n.perspectivePoints&&(r.perspectivePoints=n.perspectivePoints),void 0!==n.minPerspectivePointSize&&(r.minPerspectivePointSize=n.minPerspectivePointSize),void 0!==n.maxPerspectivePointSize&&(r.maxPerspectivePointSize=n.minPerspectivePointSize)):(r._preset="default",r.pointSize=n.pointSize,r.roundPoints=n.roundPoints,r.perspectivePoints=n.perspectivePoints,r.minPerspectivePointSize=n.minPerspectivePointSize,r.maxPerspectivePointSize=n.maxPerspectivePointSize),r.filterIntensity=n.filterIntensity,r.minIntensity=n.minIntensity,r.maxIntensity=n.maxIntensity,r}return I(i,[{key:"type",get:function(){return"PointsMaterial"}},{key:"presets",get:function(){return ud}},{key:"pointSize",get:function(){return this._state.pointSize},set:function(e){this._state.pointSize=e||2,this.glRedraw()}},{key:"roundPoints",get:function(){return this._state.roundPoints},set:function(e){e=!1!==e,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"perspectivePoints",get:function(){return this._state.perspectivePoints},set:function(e){e=!1!==e,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"minPerspectivePointSize",get:function(){return this._state.minPerspectivePointSize},set:function(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}},{key:"maxPerspectivePointSize",get:function(){return this._state.maxPerspectivePointSize},set:function(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}},{key:"filterIntensity",get:function(){return this._state.filterIntensity},set:function(e){e=!1!==e,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}},{key:"minIntensity",get:function(){return this._state.minIntensity},set:function(e){this._state.minIntensity=null!=e?e:0,this.glRedraw()}},{key:"maxIntensity",get:function(){return this._state.maxIntensity},set:function(e){this._state.maxIntensity=null!=e?e:1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=ud[e];t?(this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ud).join(", "))}}},{key:"hash",get:function(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}(),cd={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}},hd=function(e){m(i,mn);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e,n))._state=new nt({type:"LinesMaterial",lineWidth:null}),n.preset?(r.preset=n.preset,void 0!==n.lineWidth&&(r.lineWidth=n.lineWidth)):(r._preset="default",r.lineWidth=n.lineWidth),r}return I(i,[{key:"type",get:function(){return"LinesMaterial"}},{key:"presets",get:function(){return cd}},{key:"lineWidth",get:function(){return this._state.lineWidth},set:function(e){this._state.lineWidth=e||1,this.glRedraw()}},{key:"preset",get:function(){return this._preset},set:function(e){if(e=e||"default",this._preset!==e){var t=cd[e];t?(this.lineWidth=t.lineWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(cd).join(", "))}}},{key:"hash",get:function(){return[""+this.lineWidth].join(";")}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._state.destroy()}}]),i}();function dd(e,t){var i,r,n,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,o=t&&t.length,a=o?t[0]*s:e.length,l=pd(e,0,a,s,!0),u=[];if(!l||l.next===l.prev)return u;if(o&&(l=bd(e,t,l,s)),e.length>80*s){i=1/0,r=1/0;for(var A=-1/0,c=-1/0,h=s;h<a;h+=s){var d=e[h],p=e[h+1];d<i&&(i=d),p<r&&(r=p),d>A&&(A=d),p>c&&(c=p)}n=0!==(n=Math.max(A-i,c-r))?32767/n:0}return vd(l,u,s,i,r,n,0),u}function pd(e,t,i,r,n){var s;if(n===function(e,t,i,r){for(var n=0,s=t,o=i-r;s<i;s+=r)n+=(e[o]-e[s])*(e[s+1]+e[o+1]),o=s;return n}(e,t,i,r)>0)for(var o=t;o<i;o+=r)s=Ld(o/r|0,e[o],e[o+1],s);else for(var a=i-r;a>=t;a-=r)s=Ld(a/r|0,e[a],e[a+1],s);return s&&Id(s,s.next)&&(Od(s),s=s.next),s}function fd(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!Id(r,r.next)&&0!==Ed(r.prev,r,r.next))r=r.next;else{if(Od(r),(r=t=r.prev)===r.next)break;i=!0}}while(i||r!==t);return t}function vd(e,t,i,r,n,s,o){if(e){!o&&s&&function(e,t,i,r){var n=e;do{0===n.z&&(n.z=Pd(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,i=1;do{var r=e,n=void 0;e=null;var s=null;for(t=0;r;){t++;for(var o=r,a=0,l=0;l<i&&(a++,o=o.nextZ);l++);for(var u=i;a>0||u>0&&o;)0!==a&&(0===u||!o||r.z<=o.z)?(n=r,r=r.nextZ,a--):(n=o,o=o.nextZ,u--),s?s.nextZ=n:e=n,n.prevZ=s,s=n;r=o}s.nextZ=null,i*=2}while(t>1)}(n)}(e,r,n,s);for(var a=e;e.prev!==e.next;){var l=e.prev,u=e.next;if(s?md(e,r,n,s):gd(e))t.push(l.i,e.i,u.i),Od(e),e=u.next,a=u.next;else if((e=u)===a){o?1===o?vd(e=_d(fd(e),t),t,i,r,n,s,2):2===o&&yd(e,t,i,r,n,s):vd(fd(e),t,i,r,n,s,1);break}}}}function gd(e){var t=e.prev,i=e,r=e.next;if(Ed(t,i,r)>=0)return!1;for(var n=t.x,s=i.x,o=r.x,a=t.y,l=i.y,u=r.y,A=Math.min(n,s,o),c=Math.min(a,l,u),h=Math.max(n,s,o),d=Math.max(a,l,u),p=r.next;p!==t;){if(p.x>=A&&p.x<=h&&p.y>=c&&p.y<=d&&Fd(n,a,s,l,o,u,p.x,p.y)&&Ed(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function md(e,t,i,r){var n=e.prev,s=e,o=e.next;if(Ed(n,s,o)>=0)return!1;for(var a=n.x,l=s.x,u=o.x,A=n.y,c=s.y,h=o.y,d=Math.min(a,l,u),p=Math.min(A,c,h),f=Math.max(a,l,u),v=Math.max(A,c,h),g=Pd(d,p,t,i,r),m=Pd(f,v,t,i,r),_=e.prevZ,y=e.nextZ;_&&_.z>=g&&y&&y.z<=m;){if(_.x>=d&&_.x<=f&&_.y>=p&&_.y<=v&&_!==n&&_!==o&&Fd(a,A,l,c,u,h,_.x,_.y)&&Ed(_.prev,_,_.next)>=0)return!1;if(_=_.prevZ,y.x>=d&&y.x<=f&&y.y>=p&&y.y<=v&&y!==n&&y!==o&&Fd(a,A,l,c,u,h,y.x,y.y)&&Ed(y.prev,y,y.next)>=0)return!1;y=y.nextZ}for(;_&&_.z>=g;){if(_.x>=d&&_.x<=f&&_.y>=p&&_.y<=v&&_!==n&&_!==o&&Fd(a,A,l,c,u,h,_.x,_.y)&&Ed(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;y&&y.z<=m;){if(y.x>=d&&y.x<=f&&y.y>=p&&y.y<=v&&y!==n&&y!==o&&Fd(a,A,l,c,u,h,y.x,y.y)&&Ed(y.prev,y,y.next)>=0)return!1;y=y.nextZ}return!0}function _d(e,t){var i=e;do{var r=i.prev,n=i.next.next;!Id(r,n)&&Td(r,i,i.next,n)&&Rd(r,n)&&Rd(n,r)&&(t.push(r.i,i.i,n.i),Od(i),Od(i.next),i=e=n),i=i.next}while(i!==e);return fd(i)}function yd(e,t,i,r,n,s){var o=e;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&kd(o,a)){var l=Ud(o,a);return o=fd(o,o.next),l=fd(l,l.next),vd(o,t,i,r,n,s,0),void vd(l,t,i,r,n,s,0)}a=a.next}o=o.next}while(o!==e)}function bd(e,t,i,r){for(var n=[],s=0,o=t.length;s<o;s++){var a=pd(e,t[s]*r,s<o-1?t[s+1]*r:e.length,r,!1);a===a.next&&(a.steiner=!0),n.push(Cd(a))}n.sort(wd);for(var l=0;l<n.length;l++)i=Bd(n[l],i);return i}function wd(e,t){var i=e.x-t.x;0===i&&(0===(i=e.y-t.y)&&(i=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)));return i}function Bd(e,t){var i=function(e,t){var i,r=t,n=e.x,s=e.y,o=-1/0;if(Id(e,r))return r;do{if(Id(e,r.next))return r.next;if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=n&&a>o&&(o=a,i=r.x<r.next.x?r:r.next,a===n))return i}r=r.next}while(r!==t);if(!i)return null;var l=i,u=i.x,A=i.y,c=1/0;r=i;do{if(n>=r.x&&r.x>=u&&n!==r.x&&Md(s<A?n:o,s,u,A,s<A?o:n,s,r.x,r.y)){var h=Math.abs(s-r.y)/(n-r.x);Rd(r,e)&&(h<c||h===c&&(r.x>i.x||r.x===i.x&&xd(i,r)))&&(i=r,c=h)}r=r.next}while(r!==l);return i}(e,t);if(!i)return t;var r=Ud(i,e);return fd(r,r.next),fd(i,i.next)}function xd(e,t){return Ed(e.prev,e,t.prev)<0&&Ed(t.next,e,e.next)<0}function Pd(e,t,i,r,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Cd(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function Md(e,t,i,r,n,s,o,a){return(n-o)*(t-a)>=(e-o)*(s-a)&&(e-o)*(r-a)>=(i-o)*(t-a)&&(i-o)*(s-a)>=(n-o)*(r-a)}function Fd(e,t,i,r,n,s,o,a){return!(e===o&&t===a)&&Md(e,t,i,r,n,s,o,a)}function kd(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Td(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(Rd(e,t)&&Rd(t,e)&&function(e,t){var i=e,r=!1,n=(e.x+t.x)/2,s=(e.y+t.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&n<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(Ed(e.prev,e,t.prev)||Ed(e,t.prev,t))||Id(e,t)&&Ed(e.prev,e,e.next)>0&&Ed(t.prev,t,t.next)>0)}function Ed(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function Id(e,t){return e.x===t.x&&e.y===t.y}function Td(e,t,i,r){var n=Sd(Ed(e,t,i)),s=Sd(Ed(e,t,r)),o=Sd(Ed(i,r,e)),a=Sd(Ed(i,r,t));return n!==s&&o!==a||(!(0!==n||!Dd(e,i,t))||(!(0!==s||!Dd(e,r,t))||(!(0!==o||!Dd(i,e,r))||!(0!==a||!Dd(i,t,r)))))}function Dd(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function Sd(e){return e>0?1:e<0?-1:0}function Rd(e,t){return Ed(e.prev,e,e.next)<0?Ed(e,t,e.next)>=0&&Ed(e,e.prev,t)>=0:Ed(e,t,e.prev)<0||Ed(e,e.next,t)<0}function Ud(e,t){var i=Nd(e.i,e.x,e.y),r=Nd(t.i,t.x,t.y),n=e.next,s=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,s.next=r,r.prev=s,r}function Ld(e,t,i,r){var n=Nd(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function Od(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Nd(e,t,i){return{i:e,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}var Vd=[0,1,0],Qd=[1,0,0],Hd=le.vec3(),Gd=le.vec3(),jd=le.vec3(),zd=le.vec3(),Wd=le.vec3();function Xd(e,t){return Math.abs(e[0]-t[0])<1e-6&&Math.abs(e[1]-t[1])<1e-6&&Math.abs(e[2]-t[2])<1e-6}var Kd=function(){function e(t){k(this,e),this.scene=t,this._resourcesAllocated=!1}return I(e,[{key:"_onCapMaterialUpdated",value:function(e,t){var i=this;if(!this._resourcesAllocated){this._resourcesAllocated=!0,this._sectionPlanes=[],this._sceneModelsData={},this._dirtyMap={},this._prevIntersectionModelsMap={},this._sectionPlaneTimeout=null,this._updateTimeout=null;var r=function(e){var t=function(){i._setAllDirty(!0),i._update()};i._sectionPlanes.push(e),e.on("pos",t),e.on("dir",t),e.on("active",t),e.once("destroyed",function(){var t=e.id;t&&(i._sectionPlanes=i._sectionPlanes.filter((function(e){return e.id!==t})),i._update())}.bind(i))};for(var n in this.scene.sectionPlanes)r(this.scene.sectionPlanes[n]);this._onSectionPlaneCreated=this.scene.on("sectionPlaneCreated",r),this._onTick=this.scene.on("tick",(function(){var e=!1;for(var t in i._sceneModelsData)i.scene.models[t]?i._sceneModelsData[t].visible!==!!i.scene.models[t].visible&&(i._sceneModelsData[t].visible=!!i.scene.models[t].visible,e=!0):(delete i._sceneModelsData[t],e=!0);e&&i._update()}))}this._dirtyMap[t]||(this._dirtyMap[t]=new Map),this._dirtyMap[t].set(e,!0),this._update()}},{key:"_update",value:function(){var e=this;clearTimeout(this._updateTimeout),this._deletePreviousModels(),this._updateTimeout=setTimeout((function(){clearTimeout(e._updateTimeout);var t=Object.values(e.scene.models).filter((function(e){return e.visible}));e._addHatches(t,e._sectionPlanes.filter((function(e){return e.active}))),e._setAllDirty(!1)}),100)}},{key:"_setAllDirty",value:function(e){var t=this,i=function(i){t._dirtyMap[i].forEach((function(r,n){return t._dirtyMap[i].set(n,e)}))};for(var r in this._dirty)i(r)}},{key:"_addHatches",value:function(e,t){var i=this;t.forEach((function(t){e.forEach((function(e){if(i._doesPlaneIntersectBoundingBox(e.aabb,t)&&i._dirtyMap[e.id]){var r=new Map,n=e.objects,s=[le.vec3(),le.vec3(),le.vec3()];i._dirtyMap[e.id].forEach((function(o,a){if(o){var l=n[a];if(i._doesPlaneIntersectBoundingBox(l.aabb,t)){if(!i._sceneModelsData[e.id]){var u=e.aabb;i._sceneModelsData[e.id]={verticesMap:new Map,indicesMap:new Map,modelOrigin:le.vec3([(u[0]+u[3])/2,(u[1]+u[4])/2,(u[2]+u[5])/2])}}var A=i._sceneModelsData[e.id],c=A.modelOrigin;if(!A.verticesMap.has(a)){var h=l.meshes[0].isSolid(),d=[],p=[];h&&l.capMaterial&&(l.getEachVertex((function(e){return d.push(e[0]-c[0],e[1]-c[1],e[2]-c[2])})),l.getEachIndex((function(e){return p.push(e)}))),A.verticesMap.set(a,d),A.indicesMap.set(a,p)}for(var f=A.verticesMap.get(a),v=A.indicesMap.get(a),g=-le.dotVec3(le.subVec3(t.pos,c,Hd),t.dir),m=[],_=v.length,y=0;y<_;y+=3){for(var b=0;b<3;b++){var w=3*v[y+b];s[b][0]=f[w],s[b][1]=f[w+1],s[b][2]=f[w+2]}if(s[0][0]||s[0][1]||s[0][2]){for(var B=[],x=0;x<3;x++){var P=s[x],C=s[(x+1)%3],M=g+le.dotVec3(t.dir,P),F=g+le.dotVec3(t.dir,C);if(!(M*F>0)){var k=-M/(F-M);B.push(le.lerpVec3(k,0,1,P,C,le.vec3()))}}2===B.length&&m.push(B)}}m.length>0&&r.set(a,m)}}}));var o=new Map;r.forEach((function(e,t){o.set(t,[[e[0]]]),e.splice(0,1);for(var i=0;e.length>0;){for(var n=o.get(t)[i][o.get(t)[i].length-1][1],s=!1,a=0;a<e.length;a++){var l=C(e[a],2),u=l[0],A=l[1];if(Xd(n,u)){o.get(t)[i].push(e[a]),e.splice(a,1),s=!0;break}if(Xd(n,A)){o.get(t)[i].push([A,u]),e.splice(a,1),s=!0;break}}if(!s&&Xd(n,o.get(t)[i][0][0])&&e.length>1)o.get(t).push([r.get(t)[0]]),e.splice(0,1),i++;else if(!s)break}}));var a=new Map;o.forEach((function(e,r){for(var n=[],s=function(r){n.push([]),e[r].forEach((function(e){n[r].push([i._projectTo2D(e[0],t.dir),i._projectTo2D(e[1],t.dir)])}))},o=0;o<e.length;o++)s(o);a.set(r,n)}));var l,u=new Map;a.forEach((function(r,n){var s=i._sceneModelsData[e.id].modelOrigin;l=[];for(var o=r,a=[],A=new Set,c=0;c<o.length;c++)if(!A.has(c)){var h=[o[c]];A.add(c);for(var d=c+1;d<o.length;d++)A.has(d)||(i._isLoopInside(o[c],o[d])||i._isLoopInside(o[d],o[c]))&&(h.push(o[d]),A.add(d));a.push(h)}a.forEach((function(e){var r=[],n=[],o=0,a=e.map((function(e){for(var t=0,i=0;i<e.length;i++){var r=(i+1)%e.length;t+=e[i][0][0]*e[r][0][1],t-=e[r][0][0]*e[i][0][1]}return Math.abs(t)/2})),u=a.indexOf(Math.max.apply(Math,f(a)));e[u].forEach((function(e){r.push(e[0][0],e[0][1]),o+=2}));for(var A=0;A<e.length;A++)A!==u&&(n.push(o/2),e[A].forEach((function(e){r.push(e[0][0],e[0][1]),o+=2})));for(var c=dd(r,n),h=[],d=0;d<c.length;d+=3){for(var p=[],v=0;v<3;v++){var g=2*c[d+v],m=[r[g],r[g+1]],_=i._convertTo3D(m,t,s);p.push(_)}h.push(p)}l.push(h)})),u.set(n,l)}));var A=new Map;u.forEach((function(e,t){l=[],e.forEach((function(e){var t=new Map,i=[],r=[],n=0;e.forEach((function(e){var s=[];e.forEach((function(e){var r="".concat(e[0].toFixed(6),",").concat(e[1].toFixed(6),",").concat(e[2].toFixed(6));t.has(r)?s.push(t.get(r)):(i.push(e[0],e[1],e[2]),t.set(r,n),s.push(n),n++)})),r.push.apply(r,s)})),l.push({positions:i,indices:r})})),A.set(t,l)})),i._prevIntersectionModelsMap[e.id]||(i._prevIntersectionModelsMap[e.id]=new Map),le.mulVec3Scalar(t.dir,.001,Wd),A.forEach((function(r,n){var s,o=i._sceneModelsData[e.id].modelOrigin,a=new Array(r.size),l=0;(r.forEach((function(r,s){var u=r.positions,A=r.indices;u.length;var c=le.buildNormals(u,A),h=i._createUVs(u,t,o);a[l++]=new vn(i.scene,{id:"".concat(t.id,"-").concat(n,"-").concat(s),geometry:new mt(i.scene,{primitive:"triangles",positions:u,indices:A,normals:c,uv:h}),origin:le.addVec3(o,Wd,Hd),position:[0,0,0],rotation:[0,0,0],material:e.objects[n].capMaterial})})),i._prevIntersectionModelsMap[e.id].has(n))?(s=i._prevIntersectionModelsMap[e.id].get(n)).push.apply(s,a):i._prevIntersectionModelsMap[e.id].set(n,a)}))}}))}))}},{key:"_doesPlaneIntersectBoundingBox",value:function(e,t){for(var i=[e[0],e[1],e[2]],r=[e[3],e[4],e[5]],n=!1,s=!1,o=0,a=[[i[0],i[1],i[2]],[r[0],i[1],i[2]],[i[0],r[1],i[2]],[r[0],r[1],i[2]],[i[0],i[1],r[2]],[r[0],i[1],r[2]],[i[0],r[1],r[2]],[r[0],r[1],r[2]]];o<a.length;o++){var l=a[o],u=t.dist+le.dotVec3(t.dir,l);if(u>0&&(n=!0),u<0&&(s=!0),n&&s)return!0}return!1}},{key:"_buildLines",value:function(e){var t=this;for(var i in e)for(var r=0;r<e[i].length;r++){var n=e[i][r];n.length<=0||n.forEach((function(e,i){new vn(t.scene,{clippable:!1,geometry:new mt(t.scene,Lt({startPoint:e[0],endPoint:e[1]})),material:new bn(t.scene,{emissive:[1,0,0]})})}))}}},{key:"_projectTo2D",value:function(e,t){var i;i=Math.abs(t[0])>Math.abs(t[1])?[-t[2],0,t[0]]:[0,t[2],-t[1]],i=le.normalizeVec3(i);var r=le.vec3(t),n=le.cross3Vec3(r,i),s=le.normalizeVec3(n);return[le.dotVec3(e,i),le.dotVec3(e,s)]}},{key:"_isLoopInside",value:function(e,t){for(var i=e[0][0],r=!1,n=0,s=t.length-1;n<t.length;s=n++){var o=t[n][0][0],a=t[n][0][1],l=t[s][0][0],u=t[s][0][1];a>i[1]!=u>i[1]&&i[0]<(l-o)*(i[1]-a)/(u-a)+o&&(r=!r)}return r}},{key:"_convertTo3D",value:function(e,t,i){var r,n=t.dir,s=t.pos;r=Math.abs(n[0])>Math.abs(n[1])?[-n[2],0,n[0]]:[0,n[2],-n[1]],r=le.normalizeVec3(r);var o=le.vec3(n),a=le.cross3Vec3(o,r),l=le.normalizeVec3(a),u=e[0],A=e[1],c=[r[0]*u+l[0]*A,r[1]*u+l[1]*A,r[2]*u+l[2]*A],h=le.dotVec3(n,[s[0]-c[0]-i[0],s[1]-c[1]-i[1],s[2]-c[2]-i[2]]);return[c[0]+n[0]*h,c[1]+n[1]*h,c[2]+n[2]*h]}},{key:"_deletePreviousModels",value:function(){var e=this,t=function(t){e._prevIntersectionModelsMap[t].forEach((function(i,r){e._dirtyMap[t].get(r)&&(i.forEach((function(e){e.destroy()})),e._prevIntersectionModelsMap[t].delete(r))})),e._prevIntersectionModelsMap[t].size<=0&&delete e._prevIntersectionModelsMap[t]};for(var i in this._prevIntersectionModelsMap)t(i)}},{key:"_createUVs",value:function(e,t,i){var r=t.pos,n=Hd;n.set(t.dir),le.normalizeVec3(n);for(var s=Gd,o=[],a=0;a<e.length;a+=3){s[0]=e[a]+i[0],s[1]=e[a+1]+i[1],s[2]=e[a+2]+i[2];var l=le.subVec3(s,r,jd),u=le.dotVec3(l,n);le.subVec3(s,le.mulVec3Scalar(n,u,jd),s);var A=Math.abs(le.dotVec3(n,Vd))<.999?le.cross3Vec3(n,Vd,jd):Qd,c=le.cross3Vec3(n,A,jd);le.normalizeVec3(c,c);var h=le.subVec3(s,r,s);o.push(le.dotVec3(h,le.normalizeVec3(le.cross3Vec3(c,n,zd))),le.dotVec3(h,c))}return o}},{key:"destroy",value:function(){this._deletePreviousModels(),this._resourcesAllocated&&(this.scene.off(this._onModelLoaded),this.scene.off(this._onModelUnloaded),this.scene.off(this._onSectionPlaneCreated),this.scene.off(this._onTick))}}]),e}();function Zd(e,t){for(var i,r,n={},s=0,o=t.length;s<o;s++)i=t[s],(r=e.components[i])?r.isEntity?n[i]=!0:e.warn("pick(): Component is not an Entity: "+i):e.warn("pick(): Component not found: "+i);return n}var Jd=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),r=t.call(this,null,n);var s=n.canvasElement||document.querySelector("#".concat(n.canvasId));if(!(s instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";r._tickifiedFunctions={};var o=!!n.transparent,a=!!n.alphaDepthMask;return r._aabbDirty=!0,r._readableGeometry=!!n.readableGeometryEnabled,r.viewer=e,r.occlusionTestCountdown=0,r.loading=0,r.startTime=(new Date).getTime(),r.models={},r.objects={},r._numObjects=0,r.visibleObjects={},r._numVisibleObjects=0,r.xrayedObjects={},r._numXRayedObjects=0,r.highlightedObjects={},r._numHighlightedObjects=0,r.selectedObjects={},r._numSelectedObjects=0,r.colorizedObjects={},r._numColorizedObjects=0,r.opacityObjects={},r._numOpacityObjects=0,r.offsetObjects={},r._numOffsetObjects=0,r._modelIds=null,r._objectIds=null,r._visibleObjectIds=null,r._xrayedObjectIds=null,r._highlightedObjectIds=null,r._selectedObjectIds=null,r._colorizedObjectIds=null,r._opacityObjectIds=null,r._offsetObjectIds=null,r._collidables={},r._compilables={},r._needRecompile=!1,r.types={},r.components={},r.sectionPlanes={},r.lights={},r.lightMaps={},r.reflectionMaps={},r.bitmaps={},r.lineSets={},r.realWorldOffset=n.realWorldOffset||new Float64Array([0,0,0]),r.canvas=new _h(w(r),{dontClear:!0,canvas:s,spinnerElementId:n.spinnerElementId,transparent:o,webgl2:!1!==n.webgl2,contextAttr:n.contextAttr||{},backgroundColor:n.backgroundColor,backgroundColorFromAmbientLight:n.backgroundColorFromAmbientLight,premultipliedAlpha:n.premultipliedAlpha}),r.canvas.on("boundary",(function(){r.glRedraw()})),r.canvas.on("webglContextFailed",(function(){alert("xeokit failed to find WebGL!")})),r._renderer=new Uh(w(r),{transparent:o,alphaDepthMask:a}),r._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1,this._numCachedSectionPlanes=0;var e=null;this.getHash=function(){if(e)return e;var t=this.getNumAllocatedSectionPlanes();if(this.sectionPlanes,0===t)return this.hash=";";for(var i=[],r=0,n=t;r<n;r++)i.push("cp");return i.push(";"),e=i.join("")},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null},this.removeSectionPlane=function(t){for(var i=0,r=this.sectionPlanes.length;i<r;i++)if(this.sectionPlanes[i].id===t.id)return this.sectionPlanes.splice(i,1),void(e=null)},this.setNumCachedSectionPlanes=function(t){this._numCachedSectionPlanes=t,e=null},this.getNumCachedSectionPlanes=function(){return this._numCachedSectionPlanes},this.getNumAllocatedSectionPlanes=function(){var e=this.sectionPlanes.length;return e>this._numCachedSectionPlanes?e:this._numCachedSectionPlanes}},r._sectionPlanesState.setNumCachedSectionPlanes(n.numCachedSectionPlanes||0),r._lightsState=new function(){var e=le.vec4([0,0,0,0]),t=le.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];var i=null,r=null;this.getHash=function(){if(i)return i;for(var e,t=[],r=this.lights,n=0,s=r.length;n<s;n++)e=r[n],t.push("/"),t.push(e.type),t.push("world"===e.space?"w":"v"),e.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join("")},this.addLight=function(e){this.lights.push(e),r=null,i=null},this.removeLight=function(e){for(var t=0,n=this.lights.length;t<n;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),r&&r.id===e.id&&(r=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(var t=0,r=this.reflectionMaps.length;t<r;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(var t=0,r=this.lightMaps.length;t<r;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!r)for(var i=0,n=this.lights.length;i<n;i++){var s=this.lights[i];if("ambient"===s.type){r=s;break}}if(r){var o=r.color,a=r.intensity;return t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=a,t}return e}},r.input=new Lh(w(r),{dontClear:!0,element:r.canvas.canvas,keyboardEventsElement:n.keyboardEventsElement}),r.metrics=new od(w(r),{units:n.units,scale:n.scale,origin:n.origin}),r.sao=new ad(w(r),{enabled:n.saoEnabled}),r.crossSections=new ld(w(r),{}),r.ticksPerRender=n.ticksPerRender,r.ticksPerOcclusionTest=n.ticksPerOcclusionTest,r.passes=n.passes,r.clearEachPass=n.clearEachPass,r.gammaInput=n.gammaInput,r.gammaOutput=n.gammaOutput,r.gammaFactor=n.gammaFactor,r._entityOffsetsEnabled=!!n.entityOffsetsEnabled,r._logarithmicDepthBufferEnabled=!!n.logarithmicDepthBufferEnabled,r._dtxEnabled=!1!==n.dtxEnabled,r._pbrEnabled=!!n.pbrEnabled,r._colorTextureEnabled=!1!==n.colorTextureEnabled,r._dtxEnabled=!!n.dtxEnabled,r._markerZOffset=n.markerZOffset,Fe._addScene(w(r)),r._initDefaults(),r._viewport=new Oh(w(r),{id:"default.viewport",autoBoundary:!0,dontClear:!0}),r._camera=new nd(w(r),{id:"default.camera",dontClear:!0}),r._sectionCaps=new Kd(w(r)),new Oc(w(r),{color:[1,1,1],intensity:.7}),new Vc(w(r),{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new Vc(w(r),{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),r._camera.on("dirty",(function(){r._renderer.imageDirty()})),r}return I(i,[{key:"type",get:function(){return"Scene"}},{key:"_initDefaults",value:function(){}},{key:"_addComponent",value:function(e){if(e.id&&this.components[e.id]&&(this.error("Component "+ge.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=le.createUUID();this.components[e.id]=e;var t=e.type,i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}},{key:"_removeComponent",value:function(e){var t=e.id,i=e.type;delete this.components[t];var r=this.types[i];r&&(delete r[t],ge.isEmptyObject(r)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}},{key:"_capMaterialUpdated",value:function(e,t){this._sectionCaps._onCapMaterialUpdated(e,t)}},{key:"_sectionPlaneCreated",value:function(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}},{key:"_bitmapCreated",value:function(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}},{key:"_lineSetCreated",value:function(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}},{key:"_lightCreated",value:function(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}},{key:"_lightMapCreated",value:function(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}},{key:"_reflectionMapCreated",value:function(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}},{key:"_sectionPlaneDestroyed",value:function(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}},{key:"_bitmapDestroyed",value:function(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}},{key:"_lineSetDestroyed",value:function(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}},{key:"_lightDestroyed",value:function(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}},{key:"_lightMapDestroyed",value:function(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}},{key:"_reflectionMapDestroyed",value:function(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}},{key:"_registerModel",value:function(e){this.models[e.id]=e,this._modelIds=null}},{key:"_deregisterModel",value:function(e){var t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}},{key:"_registerObject",value:function(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}},{key:"_deregisterObject",value:function(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}},{key:"_objectVisibilityUpdated",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}},{key:"_deRegisterVisibleObject",value:function(e){delete this.visibleObjects[e.id],this._numVisibleObjects--,this._visibleObjectIds=null}},{key:"_objectXRayedUpdated",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,t&&this.fire("objectXRayed",e,!0)}},{key:"_deRegisterXRayedObject",value:function(e){delete this.xrayedObjects[e.id],this._numXRayedObjects--,this._xrayedObjectIds=null}},{key:"_objectHighlightedUpdated",value:function(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}},{key:"_deRegisterHighlightedObject",value:function(e){delete this.highlightedObjects[e.id],this._numHighlightedObjects--,this._highlightedObjectIds=null}},{key:"_objectSelectedUpdated",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,t&&this.fire("objectSelected",e,!0)}},{key:"_deRegisterSelectedObject",value:function(e){delete this.selectedObjects[e.id],this._numSelectedObjects--,this._selectedObjectIds=null}},{key:"_objectColorizeUpdated",value:function(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}},{key:"_deRegisterColorizedObject",value:function(e){delete this.colorizedObjects[e.id],this._numColorizedObjects--,this._colorizedObjectIds=null}},{key:"_objectOpacityUpdated",value:function(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}},{key:"_deRegisterOpacityObject",value:function(e){delete this.opacityObjects[e.id],this._numOpacityObjects--,this._opacityObjectIds=null}},{key:"_objectOffsetUpdated",value:function(e,t){!t||0===t[0]&&0===t[1]&&0===t[2]?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}},{key:"_deRegisterOffsetObject",value:function(e){delete this.offsetObjects[e.id],this._numOffsetObjects--,this._offsetObjectIds=null}},{key:"_webglContextLost",value:function(){for(var e in this.canvas.spinner.processes++,this.components)if(this.components.hasOwnProperty(e)){var t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}},{key:"_webglContextRestored",value:function(){var e=this.canvas.gl;for(var t in this.components)if(this.components.hasOwnProperty(t)){var i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}},{key:"capabilities",get:function(){return this._renderer.capabilities}},{key:"entityOffsetsEnabled",get:function(){return this._entityOffsetsEnabled}},{key:"readableGeometryEnabled",get:function(){return this._readableGeometry}},{key:"pickSurfacePrecisionEnabled",get:function(){return this._readableGeometry}},{key:"logarithmicDepthBufferEnabled",get:function(){return this._logarithmicDepthBufferEnabled}},{key:"numCachedSectionPlanes",get:function(){return this._sectionPlanesState.getNumCachedSectionPlanes()},set:function(e){e=e||0,this._sectionPlanesState.getNumCachedSectionPlanes()!==e&&(this._sectionPlanesState.setNumCachedSectionPlanes(e),this._needRecompile=!0,this.glRedraw())}},{key:"pbrEnabled",get:function(){return this._pbrEnabled},set:function(e){this._pbrEnabled=!!e,this.glRedraw()}},{key:"dtxEnabled",get:function(){return this._dtxEnabled},set:function(e){e=!!e,this._dtxEnabled!==e&&(this._dtxEnabled=e)}},{key:"colorTextureEnabled",get:function(){return this._colorTextureEnabled},set:function(e){this._colorTextureEnabled=!!e,this.glRedraw()}},{key:"markerZOffset",get:function(){return null==this._markerZOffset?-.001:this._markerZOffset}},{key:"doOcclusionTest",value:function(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}},{key:"render",value:function(e){e&&Fe.runTasks();var t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e||this._renderer.needsRender()){t.sceneId=this.id;var i,r,n=this._passes,s=this._clearEachPass;for(i=0;i<n;i++)t.pass=i,this.fire("rendering",t,!0),r=s||0===i,this._renderer.render({pass:i,clear:r,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}}},{key:"compile",value:function(){this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1)}},{key:"_recompile",value:function(){for(var e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}},{key:"_saveAmbientColor",value:function(){var e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{var t=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=le.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}},{key:"modelIds",get:function(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}},{key:"numObjects",get:function(){return this._numObjects}},{key:"objectIds",get:function(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}},{key:"numVisibleObjects",get:function(){return this._numVisibleObjects}},{key:"visibleObjectIds",get:function(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}},{key:"numXRayedObjects",get:function(){return this._numXRayedObjects}},{key:"xrayedObjectIds",get:function(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}},{key:"numHighlightedObjects",get:function(){return this._numHighlightedObjects}},{key:"highlightedObjectIds",get:function(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}},{key:"numSelectedObjects",get:function(){return this._numSelectedObjects}},{key:"selectedObjectIds",get:function(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}},{key:"numColorizedObjects",get:function(){return this._numColorizedObjects}},{key:"colorizedObjectIds",get:function(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}},{key:"opacityObjectIds",get:function(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}},{key:"offsetObjectIds",get:function(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}},{key:"ticksPerRender",get:function(){return this._ticksPerRender},set:function(e){null==e?e=1:(!ge.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}},{key:"ticksPerOcclusionTest",get:function(){return this._ticksPerOcclusionTest},set:function(e){null==e?e=20:(!ge.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}},{key:"passes",get:function(){return this._passes},set:function(e){null==e?e=1:(!ge.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}},{key:"clearEachPass",get:function(){return this._clearEachPass},set:function(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}},{key:"gammaInput",get:function(){return this._renderer.gammaInput},set:function(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}},{key:"gammaOutput",get:function(){return this._renderer.gammaOutput},set:function(e){(e=!!e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}},{key:"gammaFactor",get:function(){return this._renderer.gammaFactor},set:function(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}},{key:"geometry",get:function(){return this.components["default.geometry"]||Pt(mt)}},{key:"material",get:function(){return this.components["default.material"]||new bn(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}},{key:"xrayMaterial",get:function(){return this.components["default.xrayMaterial"]||new zn(this,{id:"default.xrayMaterial",fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,dontClear:!0})}},{key:"highlightMaterial",get:function(){return this.components["default.highlightMaterial"]||new zn(this,{id:"default.highlightMaterial",fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1,dontClear:!0})}},{key:"selectedMaterial",get:function(){return this.components["default.selectedMaterial"]||new zn(this,{id:"default.selectedMaterial",fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1,dontClear:!0})}},{key:"edgeMaterial",get:function(){return this.components["default.edgeMaterial"]||new Xn(this,{id:"default.edgeMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}},{key:"pointsMaterial",get:function(){return this.components["default.pointsMaterial"]||new Ad(this,{id:"default.pointsMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,dontClear:!0})}},{key:"linesMaterial",get:function(){return this.components["default.linesMaterial"]||new hd(this,{id:"default.linesMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,dontClear:!0})}},{key:"viewport",get:function(){return this._viewport}},{key:"camera",get:function(){return this._camera}},{key:"center",get:function(){if(this._aabbDirty||!this._center){var e=this.aabb;this._center||(this._center=le.vec3()),this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}},{key:"aabb",get:function(){if(this._aabbDirty){this._aabb||(this._aabb=le.AABB3());var e,t,i=le.MAX_DOUBLE,r=le.MAX_DOUBLE,n=le.MAX_DOUBLE,s=le.MIN_DOUBLE,o=le.MIN_DOUBLE,a=le.MIN_DOUBLE,l=this._collidables,u=!1;for(var A in l)if(l.hasOwnProperty(A)){if(!1===(t=l[A]).collidable)continue;(e=t.aabb)[0]<i&&(i=e[0]),e[1]<r&&(r=e[1]),e[2]<n&&(n=e[2]),e[3]>s&&(s=e[3]),e[4]>o&&(o=e[4]),e[5]>a&&(a=e[5]),u=!0}u||(i=-100,r=-100,n=-100,s=100,o=100,a=100),this._aabb[0]=i,this._aabb[1]=r,this._aabb[2]=n,this._aabb[3]=s,this._aabb[4]=o,this._aabb[5]=a,this._aabbDirty=!1,this._center=null}return this._aabb}},{key:"_setAABBDirty",value:function(){this._aabbDirty=!0,this.fire("boundary")}},{key:"pick",value:function(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.matrix||e.origin&&e.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");var i=e.includeEntities||e.include;i&&(e.includeEntityIds=Zd(this,i));var r=e.excludeEntities||e.exclude;return r&&(e.excludeEntityIds=Zd(this,r)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=e.snapToEdge||e.snapToVertex?this._renderer.snapPick(e,t):this._renderer.pick(e,t))&&t.entity&&t.entity.fire&&t.entity.fire("picked",t),t}},{key:"snapPick",value:function(e){if(void 0===this._warnSnapPickDeprecated&&(this._warnSnapPickDeprecated=!0,this.warn("Scene.snapPick() is deprecated since v2.4.2 - use Scene.pick() instead")),e.canvasPos)return this._renderer.snapPick(e);this.error("Scene.snapPick() canvasPos parameter expected")}},{key:"clear",value:function(){var e;for(var t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}},{key:"clearLights",value:function(){for(var e=Object.keys(this.lights),t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}},{key:"clearSectionPlanes",value:function(){for(var e=Object.keys(this.sectionPlanes),t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}},{key:"clearBitmaps",value:function(){for(var e=Object.keys(this.bitmaps),t=0,i=e.length;t<i;t++)this.bitmaps[e[t]].destroy()}},{key:"clearLines",value:function(){for(var e=Object.keys(this.lineSets),t=0,i=e.length;t<i;t++)this.lineSets[e[t]].destroy()}},{key:"getAABB",value:function(e){if(void 0===e)return this.aabb;if(ge.isString(e)){var t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e]}if(0===e.length)return this.aabb;var i,r=le.MAX_DOUBLE,n=le.MAX_DOUBLE,s=le.MAX_DOUBLE,o=le.MIN_DOUBLE,a=le.MIN_DOUBLE,l=le.MIN_DOUBLE;if(this.withObjects(e,(function(e){if(e.collidable){var t=e.aabb;t[0]<r&&(r=t[0]),t[1]<n&&(n=t[1]),t[2]<s&&(s=t[2]),t[3]>o&&(o=t[3]),t[4]>a&&(a=t[4]),t[5]>l&&(l=t[5]),i=!0}})),i){var u=le.AABB3();return u[0]=r,u[1]=n,u[2]=s,u[3]=o,u[4]=a,u[5]=l,u}return this.aabb}},{key:"setObjectsVisible",value:function(e,t){return this.withObjects(e,(function(e){var i=e.visible!==t;return e.visible=t,i}))}},{key:"setObjectsCollidable",value:function(e,t){return this.withObjects(e,(function(e){var i=e.collidable!==t;return e.collidable=t,i}))}},{key:"setObjectsCulled",value:function(e,t){return this.withObjects(e,(function(e){var i=e.culled!==t;return e.culled=t,i}))}},{key:"setObjectsSelected",value:function(e,t){return this.withObjects(e,(function(e){var i=e.selected!==t;return e.selected=t,i}))}},{key:"setObjectsHighlighted",value:function(e,t){return this.withObjects(e,(function(e){var i=e.highlighted!==t;return e.highlighted=t,i}))}},{key:"setObjectsXRayed",value:function(e,t){return this.withObjects(e,(function(e){var i=e.xrayed!==t;return e.xrayed=t,i}))}},{key:"setObjectsEdges",value:function(e,t){return this.withObjects(e,(function(e){var i=e.edges!==t;return e.edges=t,i}))}},{key:"setObjectsColorized",value:function(e,t){return this.withObjects(e,(function(e){e.colorize=t}))}},{key:"setObjectsOpacity",value:function(e,t){return this.withObjects(e,(function(e){var i=e.opacity!==t;return e.opacity=t,i}))}},{key:"setObjectsPickable",value:function(e,t){return this.withObjects(e,(function(e){var i=e.pickable!==t;return e.pickable=t,i}))}},{key:"setObjectsOffset",value:function(e,t){this.withObjects(e,(function(e){e.offset=t}))}},{key:"withObjects",value:function(e,t){ge.isString(e)&&(e=[e]);for(var i=!1,r=0,n=e.length;r<n;r++){var s=e[r],o=this.objects[s];if(o)i=t(o)||i;else for(var a=this.modelIds,l=0,u=a.length;l<u;l++){var A=a[l],c=le.globalizeObjectId(A,s);(o=this.objects[c])&&(i=t(o)||i)}}return i}},{key:"tickify",value:function(e){var t=e.toString();if(t in this._tickifiedFunctions)return this._tickifiedFunctions[t].wrapperFunc;var i,r=0,n=0,s=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];i=t,n++},o=this.on("tick",(function(){n>r&&(r=n,e.apply(void 0,f(i)))}));return this._tickifiedFunctions[t]={tickSubId:o,wrapperFunc:s},s}},{key:"destroy",value:function(){for(var e in v(x(i.prototype),"destroy",this).call(this),this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this._sectionCaps.destroy(),this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._sectionCaps=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}]),i}(),Yd=le.vec4(),qd=le.vec4(),$d=le.vec3(),ep=le.vec3(),tp=le.vec3(),ip=le.vec4(),rp=le.vec4(),np=le.vec4(),sp=function(){function e(t){k(this,e),this._scene=t}return I(e,[{key:"dollyToCanvasPos",value:function(e,t,i){var r=!1,n=this._scene.camera;if(e){var s=le.subVec3(e,n.eye,$d);r=le.lenVec3(s)<i}if("perspective"===n.projection){n.ortho.scale=n.ortho.scale-i;var o=this._unproject(t,ip),a=le.subVec3(o,n.eye,np),l=le.mulVec3Scalar(le.normalizeVec3(a),-i,[]);if(n.eye=[n.eye[0]-l[0],n.eye[1]-l[1],n.eye[2]-l[2]],n.look=[n.look[0]-l[0],n.look[1]-l[1],n.look[2]-l[2]],e){var u=le.subVec3(e,n.eye,$d),A=le.lenVec3(u),c=le.mulVec3Scalar(le.normalizeVec3(le.subVec3(n.look,n.eye,ep)),A);n.look=[n.eye[0]+c[0],n.eye[1]+c[1],n.eye[2]+c[2]]}}else if("ortho"===n.projection){var h=this._unproject(t,ip);n.ortho.scale=n.ortho.scale-i,n.ortho._update();var d=this._unproject(t,rp),p=le.subVec3(d,h,np),f=le.mulVec3Scalar(le.normalizeVec3(le.subVec3(n.look,n.eye,$d)),-i,ep),v=le.addVec3(p,f,tp);n.eye=[n.eye[0]-v[0],n.eye[1]-v[1],n.eye[2]-v[2]],n.look=[n.look[0]-v[0],n.look[1]-v[1],n.look[2]-v[2]]}return r}},{key:"_unproject",value:function(e,t){var i=this._scene.camera,r=i.project.transposedMatrix,n=r.subarray(8,12),s=r.subarray(12),o=[0,0,-1,1],a=le.dotVec4(o,n)/le.dotVec4(o,s);return i.project.unproject(e,a,Yd,qd,t),t}},{key:"destroy",value:function(){}}]),e}(),op=le.vec3(),ap=le.vec3(),lp=le.vec3(),up=le.vec4(),Ap=le.vec4(),cp=le.vec4(),hp=Math.PI-.001,dp=function(){function e(t,i){var r=this;k(this,e),this._scene=t,this._configs=i,this._pivotWorldPos=le.vec3(),this._cameraOffset=le.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=le.vec3(),this._rtcPos=le.vec3(),this._pivotViewPos=le.vec4(),this._pivotProjPos=le.vec4(),this._pivotCanvasPos=le.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(function(){r._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(function(){r._cameraDirty=!0})),this._onTick=this._scene.on("tick",(function(){r.updatePivotElement(),r.updatePivotSphere()}))}return I(e,[{key:"createPivotSphere",value:function(){var e=this.getPivotPos(),t=le.vec3();le.decomposeMat4(le.inverseMat4(this._scene.viewer.camera.viewMatrix,le.mat4()),t,le.vec4(),le.vec3());var i=le.distVec3(t,e),r=Math.tan(Math.PI/500)*i*this._pivotSphereSize;"ortho"==this._scene.camera.projection&&(r/=this._scene.camera.ortho.scale/2),Yt(e,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new bt(this._scene,It({radius:r})),this._pivotSphere=new vn(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}},{key:"destroyPivotSphere",value:function(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}},{key:"updatePivotElement",value:function(){var e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){le.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,le.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);var i=t.boundary,r=i[2],n=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*r/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*n/2);var s=t._lastBoundingClientRect;if(!s||t._canvasSizeChanged){var o=t.canvas;s=t._lastBoundingClientRect=o.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(s.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(s.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}},{key:"updatePivotSphere",value:function(){this._pivoting&&this._pivotSphere&&(Yt(this.getPivotPos(),this._rtcCenter,this._rtcPos),le.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}},{key:"setPivotElement",value:function(e){this._pivotElement=e}},{key:"enablePivotSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.destroyPivotSphere(),this._pivotSphereEnabled=!0,e.size&&(this._pivotSphereSize=e.size);var t=e.color||[1,0,0];this._pivotSphereMaterial=new bn(this._scene,{emissive:t,ambient:t,specular:[0,0,0],diffuse:[0,0,0]})}},{key:"disablePivotSphere",value:function(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}},{key:"startPivot",value:function(){var e=this._scene.camera,t=le.lookAtMat4v(e.eye,e.look,e.up);le.transformPoint3(t,this.getPivotPos(),this._cameraOffset);var i=this.getPivotPos();this._cameraOffset[2]+=le.distVec3(e.eye,i),t=le.inverseMat4(t);var r=le.transformVec3(t,this._cameraOffset),n=le.vec3();if(le.subVec3(e.eye,i,n),le.addVec3(n,r),e.zUp){var s=n[1];n[1]=n[2],n[2]=s}this._radius=le.lenVec3(n),this._polar=Math.acos(n[1]/this._radius),this._azimuth=Math.atan2(n[0],n[2]),this._pivoting=!0}},{key:"_cameraLookingDownwards",value:function(){var e=this._scene.camera,t=le.normalizeVec3(le.subVec3(e.look,e.eye,op)),i=le.cross3Vec3(t,e.worldUp,ap);return le.sqLenVec3(i)<=1e-4}},{key:"getPivoting",value:function(){return this._pivoting}},{key:"setPivotPos",value:function(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}},{key:"setCanvasPivotPos",value:function(e){var t=this._scene.camera,i=Math.abs(le.distVec3(this._scene.center,t.eye)),r=t.project.transposedMatrix,n=r.subarray(8,12),s=r.subarray(12),o=[0,0,-1,1],a=le.dotVec4(o,n)/le.dotVec4(o,s),l=up;t.project.unproject(e,a,Ap,cp,l);var u=le.normalizeVec3(le.subVec3(l,t.eye,op)),A=le.addVec3(t.eye,le.mulVec3Scalar(u,i,ap),lp);this.setPivotPos(A)}},{key:"getPivotPos",value:function(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}},{key:"continuePivot",value:function(e,t){if(this._pivoting&&(0!==e||0!==t)){var i=this._scene.camera,r=-e,n=-t;1===i.worldUp[2]&&(r=-r),this._azimuth+=.01*-r;var s=n<0,o=n>0,a=Math.abs(this._polar-.001)<.005,l=Math.abs(this._polar-hp)<.005,u=this._polar+.01*n;u=a&&s?.001:l&&o?hp:le.clamp(u,.001,hp),this._polar=u;var A=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){var c=A[1];A[1]=A[2],A[2]=c}var h=le.lenVec3(le.subVec3(i.look,i.eye,le.vec3())),d=this.getPivotPos();le.addVec3(A,d);var p=le.lookAtMat4v(A,d,i.worldUp);p=le.inverseMat4(p);var f=le.transformVec3(p,this._cameraOffset);p[12]-=f[0],p[13]-=f[1],p[14]-=f[2];var v=[p[8],p[9],p[10]];i.eye=[p[12],p[13],p[14]],le.subVec3(i.eye,le.mulVec3Scalar(v,h),i.look),i.up=[p[4],p[5],p[6]],this.showPivot()}}},{key:"showPivot",value:function(){this._shown||(this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0)}},{key:"hidePivot",value:function(){this._shown&&(this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1)}},{key:"endPivot",value:function(){this._pivoting=!1}},{key:"destroy",value:function(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}]),e}(),pp=function(){function e(t,i){k(this,e),this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},this._configs=i,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick=!1,this.pickCursorPos=le.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._lastHash=null,this._needFireEvents=0}return I(e,[{key:"update",value:function(){if(this._configs.pointerEnabled&&(this.schedulePickEntity||this.schedulePickSurface)){var e="".concat(~~this.pickCursorPos[0],"-").concat(~~this.pickCursorPos[1],"-").concat(this.scheduleSnapOrPick,"-").concat(this.schedulePickSurface,"-").concat(this.schedulePickEntity);if(this._lastHash!==e){this.picked=!1,this.pickedSurface=!1,this.snappedOrPicked=!1,this.hoveredSnappedOrSurfaceOff=!1;var t=this._cameraControl.hasSubs("hoverSurface");if(this.scheduleSnapOrPick){var i=this._scene.pick({canvasPos:this.pickCursorPos,snapRadius:this._configs.snapRadius,snapToVertex:this._configs.snapToVertex,snapToEdge:this._configs.snapToEdge});i&&(i.snappedToEdge||i.snappedToVertex)?(this.snapPickResult=i,this.snappedOrPicked=!0,this._needFireEvents++):(this.schedulePickSurface=!0,this.snapPickResult=null)}if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){var r=this.pickResult.canvasPos;if(r[0]===this.pickCursorPos[0]&&r[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents+=t?1:0,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.hoveredSnappedOrSurfaceOff=!0,void(this.scheduleSnapOrPick=!1)}if(this.schedulePickEntity&&this.pickResult&&(this.pickResult.canvasPos||this.pickResult.snappedCanvasPos)){var n=this.pickResult.canvasPos||this.pickResult.snappedCanvasPos;if(n[0]===this.pickCursorPos[0]&&n[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface||this.scheduleSnapOrPick&&!this.snapPickResult?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult?(this.picked=!0,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.pickedSurface=!0,this._needFireEvents++):this.scheduleSnapOrPick&&(this.hoveredSnappedOrSurfaceOff=!0,this._needFireEvents++)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents++)),this.scheduleSnapOrPick=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1}}}},{key:"fireEvents",value:function(){if(0!==this._needFireEvents){if(this.hoveredSnappedOrSurfaceOff&&this._cameraControl.fire("hoverSnapOrSurfaceOff",{canvasPos:this.pickCursorPos,pointerPos:this.pickCursorPos},!0),this.snappedOrPicked)if(this.snapPickResult){var e=new ph;e.entity=this.snapPickResult.entity,e.snappedToVertex=this.snapPickResult.snappedToVertex,e.snappedToEdge=this.snapPickResult.snappedToEdge,e.worldPos=this.snapPickResult.worldPos,e.canvasPos=this.pickCursorPos,e.snappedCanvasPos=this.snapPickResult.snappedCanvasPos,this._cameraControl.fire("hoverSnapOrSurface",e,!0),this.snapPickResult=null}else this._cameraControl.fire("hoverSnapOrSurface",this.pickResult,!0);if(this.picked&&this.pickResult&&(this.pickResult.entity||this.pickResult.worldPos)){if(this.pickResult.entity){var t=this.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=t)}this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=0}}}]),e}(),fp=le.vec2(),vp=function(e,t,i){if(e){var r=t.getBoundingClientRect();i[0]=e.clientX-r.left,i[1]=e.clientY-r.top}else e=window.event,i[0]=e.x,i[1]=e.y;return i},gp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o,a,l,u=i.pickController,A=i.cameraControl,c=0,h=0,d=0,p=0,f=!1,v=le.vec3(),g=!0,m=this._scene.canvas.canvas,_=[];function y(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];b(),e&&w()}function b(){c=n.pointerCanvasPos[0],h=n.pointerCanvasPos[1],d=n.pointerCanvasPos[0],p=n.pointerCanvasPos[1]}function w(){u.pickCursorPos=n.pointerCanvasPos,u.schedulePickSurface=!0,u.update(),u.picked&&u.pickedSurface&&u.pickResult&&u.pickResult.worldPos?(f=!0,v.set(u.pickResult.worldPos)):f=!1}document.addEventListener("keydown",this._documentKeyDownHandler=function(e){if(r.active&&r.pointerEnabled&&t.input.keyboardEnabled){var i=e.keyCode;_[i]=!0}}),document.addEventListener("keyup",this._documentKeyUpHandler=function(e){if(r.active&&r.pointerEnabled&&t.input.keyboardEnabled){var i=e.keyCode;_[i]=!1}}),document.addEventListener("visibilitychange",this._onVisibilityChange=function(){_.splice(0)}),window.addEventListener("blur",this._onBlur=function(){_.splice(0)}),m.addEventListener("mousedown",this._mouseDownHandler=function(e){if(r.active&&r.pointerEnabled)switch(e.which){case 1:_[t.input.KEY_SHIFT]||r.planView?(o=!0,_[t.input.MOUSE_LEFT_BUTTON]=!0,y()):(o=!0,_[t.input.MOUSE_LEFT_BUTTON]=!0,y(!1));break;case 2:a=!0,_[t.input.MOUSE_MIDDLE_BUTTON]=!0,y();break;case 3:l=!0,_[t.input.MOUSE_RIGHT_BUTTON]=!0,r.panRightClick&&y()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=function(e){if(r.active&&r.pointerEnabled&&(o||a||l)){var i=t.canvas.boundary,u=i[2],d=i[3],p=n.pointerCanvasPos[0],g=n.pointerCanvasPos[1],m=r.planView||A._isKeyDownForAction(A.MOUSE_PAN,_),y=A._isKeyDownForAction(A.MOUSE_ROTATE,_),b=document.pointerLockElement?e.movementX:p-c,w=document.pointerLockElement?e.movementY:g-h;if(m){var B=t.camera;if("perspective"===B.projection){var x=Math.abs(f?le.lenVec3(le.subVec3(v,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(B.perspective.fov/2*Math.PI/180);s.panDeltaX+=1.5*b*x/d,s.panDeltaY+=1.5*w*x/d}else s.panDeltaX+=.5*B.ortho.scale*(b/d),s.panDeltaY+=.5*B.ortho.scale*(w/d)}else y&&(r.planView||(r.firstPerson?(s.rotateDeltaY-=b/u*r.dragRotationRate/2,s.rotateDeltaX+=w/d*(r.dragRotationRate/4)):(s.rotateDeltaY-=b/u*(1.5*r.dragRotationRate),s.rotateDeltaX+=w/d*(1.5*r.dragRotationRate))));c=p,h=g}}),m.addEventListener("mousemove",this._canvasMouseMoveHandler=function(e){r.active&&r.pointerEnabled&&n.mouseover&&(g=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(e){if(r.active&&r.pointerEnabled)switch(e.which){case 1:case 2:case 3:o=!1,a=!1,l=!1,_[t.input.MOUSE_LEFT_BUTTON]=!1,_[t.input.MOUSE_MIDDLE_BUTTON]=!1,_[t.input.MOUSE_RIGHT_BUTTON]=!1}}),m.addEventListener("mouseup",this._mouseUpHandler=function(e){if(r.active&&r.pointerEnabled){if(3===e.which){vp(e,m,fp);var t=fp[0],n=fp[1];Math.abs(t-d)<3&&Math.abs(n-p)<3&&i.cameraControl.fire("rightClick",{pagePos:[Math.round(e.pageX),Math.round(e.pageY)],canvasPos:fp,event:e},!0)}m.style.removeProperty("cursor")}}),m.addEventListener("mouseenter",this._mouseEnterHandler=function(){r.active&&r.pointerEnabled});var B=1/60,x=null;m.addEventListener("wheel",this._mouseWheelHandler=function(e){if(r.active&&r.pointerEnabled&&r.zoomOnMouseWheel&&A._isKeyDownForAction(A.MOUSE_DOLLY,_)){var t=performance.now()/1e3,i=null!==x?t-x:0;x=t,i>.05&&(i=.05),i<B&&(i=B);var o=Math.max(-1,Math.min(1,40*-e.deltaY));if(0!==o){var a=o/Math.abs(o);s.dollyDelta+=-a*i*r.mouseWheelDollyRate,g&&(0===n.pointerCanvasPos[0]&&0===n.pointerCanvasPos[1]&&vp(e,m,n.pointerCanvasPos),n.followPointerDirty=!0,g=!1)}}},{passive:!0})}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("blur",this._onBlur),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}]),e}(),mp=le.vec3(),_p=le.vec3(),yp=le.vec3(),bp=le.vec3(),wp=le.vec3(),Bp={eye:le.vec3(),look:le.vec3(),up:le.vec3()},xp=function(){function e(t,i,r,n){k(this,e),this._scene=t;var s=i.cameraControl,o=t.camera;this._onSceneKeyDown=t.input.on("keydown",(function(){if(r.active&&r.pointerEnabled&&t.input.keyboardEnabled&&(!r.keyboardEnabledOnlyIfMouseover||n.mouseover)){var e=s._isKeyDownForAction(s.AXIS_VIEW_RIGHT),a=s._isKeyDownForAction(s.AXIS_VIEW_BACK),l=s._isKeyDownForAction(s.AXIS_VIEW_LEFT),u=s._isKeyDownForAction(s.AXIS_VIEW_FRONT),A=s._isKeyDownForAction(s.AXIS_VIEW_TOP),c=s._isKeyDownForAction(s.AXIS_VIEW_BOTTOM);if(e||a||l||u||A||c){var h=t.aabb,d=le.getAABB3Diag(h);le.getAABB3Center(h,mp);var p=Math.abs(d/Math.tan(i.cameraFlight.fitFOV*le.DEGTORAD)),f=1.1*d;Bp.orthoScale=f,e?(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldRight,p,_p),wp)),Bp.look.set(mp),Bp.up.set(o.worldUp)):a?(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldForward,p,_p),wp)),Bp.look.set(mp),Bp.up.set(o.worldUp)):l?(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldRight,-p,_p),wp)),Bp.look.set(mp),Bp.up.set(o.worldUp)):u?(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldForward,-p,_p),wp)),Bp.look.set(mp),Bp.up.set(o.worldUp)):A?(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldUp,p,_p),wp)),Bp.look.set(mp),Bp.up.set(le.normalizeVec3(le.mulVec3Scalar(o.worldForward,1,yp),bp))):c&&(Bp.eye.set(le.addVec3(mp,le.mulVec3Scalar(o.worldUp,-p,_p),wp)),Bp.look.set(mp),Bp.up.set(le.normalizeVec3(le.mulVec3Scalar(o.worldForward,-1,yp)))),!r.firstPerson&&r.followPointer&&i.pivotController.setPivotPos(mp),i.cameraFlight.duration>0?i.cameraFlight.flyTo(Bp,(function(){i.pivotController.getPivoting()&&r.followPointer&&i.pivotController.showPivot()})):(i.cameraFlight.jumpTo(Bp),i.pivotController.getPivoting()&&r.followPointer&&i.pivotController.showPivot())}}}))}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){this._scene.input.off(this._onSceneKeyDown)}}]),e}(),Pp=function(){function e(t,i,r,n,s){var o=this;k(this,e),this._scene=t;var a=i.pickController,l=i.pivotController,u=i.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null,this._lastClickedWorldPos=null;var A=!1,c=!1,h=this._scene.canvas.canvas,d=function(e){var r;e&&e.worldPos&&(r=e.worldPos);var n=e&&e.entity?e.entity.aabb:t.aabb;if(r){var s=t.camera;le.subVec3(s.eye,s.look,[]),i.cameraFlight.flyTo({aabb:n})}else i.cameraFlight.flyTo({aabb:n})},p=t.tickify(this._canvasMouseMoveHandler=function(e){if(r.active&&r.pointerEnabled&&!A&&!c){if(u.hasSubs("rayMove")){var i=le.vec3(),s=le.vec3();le.canvasPosToWorldRay(t.canvas.canvas,t.camera.viewMatrix,t.camera.projMatrix,t.camera.projection,n.pointerCanvasPos,i,s),u.fire("rayMove",{canvasPos:n.pointerCanvasPos,ray:{origin:i,direction:s,canvasPos:n.pointerCanvasPos}},!0)}var l=u.hasSubs("hover"),h=u.hasSubs("hoverEnter"),d=u.hasSubs("hoverOut"),p=u.hasSubs("hoverOff"),f=u.hasSubs("hoverSurface"),v=u.hasSubs("hoverSnapOrSurface");if(l||h||d||p||f||v)if(a.pickCursorPos=n.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=f,a.scheduleSnapOrPick=v,a.update(),a.pickResult){if(a.pickResult.entity){var g=a.pickResult.entity.id;o._lastPickedEntityId!==g&&(void 0!==o._lastPickedEntityId&&u.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),u.fire("hoverEnter",a.pickResult,!0),o._lastPickedEntityId=g)}u.fire("hover",a.pickResult,!0),(a.pickResult.worldPos||a.pickResult.snappedWorldPos)&&u.fire("hoverSurface",a.pickResult,!0)}else void 0!==o._lastPickedEntityId&&(u.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),o._lastPickedEntityId=void 0),u.fire("hoverOff",{canvasPos:a.pickCursorPos},!0)}});h.addEventListener("mousemove",p),h.addEventListener("mousedown",this._canvasMouseDownHandler=function(e){if(1===e.which&&(A=!0),3===e.which&&(c=!0),1===e.which&&r.active&&r.pointerEnabled&&(n.mouseDownClientX=e.clientX,n.mouseDownClientY=e.clientY,n.mouseDownCursorX=n.pointerCanvasPos[0],n.mouseDownCursorY=n.pointerCanvasPos[1],!r.firstPerson&&r.followPointer&&(a.pickCursorPos=n.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),1===e.which))){var i=a.pickResult;i&&i.worldPos?(l.setPivotPos(i.worldPos),l.startPivot(),o._lastClickedWorldPos=i.worldPos.slice()):(r.smartPivot?l.setCanvasPivotPos(n.pointerCanvasPos):o._lastClickedWorldPos?l.setPivotPos(o._lastClickedWorldPos):l.setPivotPos(t.camera.look),l.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(e){1===e.which&&(A=!1),3===e.which&&(c=!1),l.getPivoting()&&l.endPivot()}),h.addEventListener("mouseup",this._canvasMouseUpHandler=function(e){if(r.active&&r.pointerEnabled&&(1===e.which&&(l.hidePivot(),!(Math.abs(e.clientX-n.mouseDownClientX)>3||Math.abs(e.clientY-n.mouseDownClientY)>3)))){var s=u.hasSubs("picked"),A=u.hasSubs("pickedNothing"),c=u.hasSubs("pickedSurface"),h=u.hasSubs("doublePicked"),p=u.hasSubs("doublePickedSurface"),f=u.hasSubs("doublePickedNothing");if(!(r.doublePickFlyTo||h||p||f))return(s||A||c)&&(a.pickCursorPos=n.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=c,a.update(),a.pickResult?(u.fire("picked",a.pickResult,!0),a.pickedSurface&&u.fire("pickedSurface",a.pickResult,!0)):u.fire("pickedNothing",{canvasPos:n.pointerCanvasPos},!0)),void(o._clicks=0);if(o._clicks++,1===o._clicks){a.pickCursorPos=n.pointerCanvasPos,a.schedulePickEntity=r.doublePickFlyTo,a.schedulePickSurface=c,a.update();var v=a.pickResult,g=a.pickedSurface;o._timeout=setTimeout((function(){v?(u.fire("picked",v,!0),g&&(u.fire("pickedSurface",v,!0),!r.firstPerson&&r.followPointer&&(i.pivotController.setPivotPos(v.worldPos),i.pivotController.startPivot()&&i.pivotController.showPivot()))):u.fire("pickedNothing",{canvasPos:n.pointerCanvasPos},!0),o._clicks=0}),r.doubleClickTimeFrame)}else{if(null!==o._timeout&&(window.clearTimeout(o._timeout),o._timeout=null),a.pickCursorPos=n.pointerCanvasPos,a.schedulePickEntity=r.doublePickFlyTo||h||p,a.schedulePickSurface=a.schedulePickEntity&&p,a.update(),a.pickResult){if(u.fire("doublePicked",a.pickResult,!0),a.pickedSurface&&u.fire("doublePickedSurface",a.pickResult,!0),r.doublePickFlyTo&&(d(a.pickResult),!r.firstPerson&&r.followPointer)){var m=a.pickResult.entity.aabb,_=le.getAABB3Center(m);i.pivotController.setPivotPos(_),i.pivotController.startPivot()&&i.pivotController.showPivot()}}else if(u.fire("doublePickedNothing",{canvasPos:n.pointerCanvasPos},!0),r.doublePickFlyTo&&(d(),!r.firstPerson&&r.followPointer)){var y=t.aabb,b=le.getAABB3Center(y);i.pivotController.setPivotPos(b),i.pivotController.startPivot()&&i.pivotController.showPivot()}o._clicks=0}}},!1)}return I(e,[{key:"reset",value:function(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}]),e}(),Cp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o=t.input,a=[];t.canvas.canvas;var l=!0;this._onSceneMouseMove=o.on("mousemove",(function(){l=!0})),this._onSceneKeyDown=o.on("keydown",(function(e){r.active&&r.pointerEnabled&&t.input.keyboardEnabled&&(r.keyboardEnabledOnlyIfMouseover&&!n.mouseover||(a[e]=!0))})),this._onSceneKeyUp=o.on("keyup",(function(e){r.active&&r.pointerEnabled&&t.input.keyboardEnabled&&(a[e]=!1,i.pivotController.getPivoting()&&i.pivotController.endPivot())})),document.addEventListener("visibilitychange",this._onVisibilityChange=function(){a.splice(0)}),window.addEventListener("blur",this._onBlur=function(){a.splice(0)}),this._onTick=t.on("tick",(function(e){if(r.active&&r.pointerEnabled&&t.input.keyboardEnabled&&(!r.keyboardEnabledOnlyIfMouseover||n.mouseover)){var u=i.cameraControl,A=e.deltaTime/1e3;if(!r.planView){var c=u._isKeyDownForAction(u.ROTATE_Y_POS,a),h=u._isKeyDownForAction(u.ROTATE_Y_NEG,a),d=u._isKeyDownForAction(u.ROTATE_X_POS,a),p=u._isKeyDownForAction(u.ROTATE_X_NEG,a),f=A*r.keyboardRotationRate;(c||h||d||p)&&(!r.firstPerson&&r.followPointer&&i.pivotController.startPivot(),c?s.rotateDeltaY+=f:h&&(s.rotateDeltaY-=f),d?s.rotateDeltaX+=f:p&&(s.rotateDeltaX-=f),!r.firstPerson&&r.followPointer&&i.pivotController.startPivot())}if(!a[o.KEY_CTRL]&&!a[o.KEY_ALT]){var v=u._isKeyDownForAction(u.DOLLY_BACKWARDS,a),g=u._isKeyDownForAction(u.DOLLY_FORWARDS,a);if(v||g){var m=A*r.keyboardDollyRate;!r.firstPerson&&r.followPointer&&i.pivotController.startPivot(),g?s.dollyDelta-=m:v&&(s.dollyDelta+=m),l&&(n.followPointerDirty=!0,l=!1)}}var _=u._isKeyDownForAction(u.PAN_FORWARDS,a),y=u._isKeyDownForAction(u.PAN_BACKWARDS,a),b=u._isKeyDownForAction(u.PAN_LEFT,a),w=u._isKeyDownForAction(u.PAN_RIGHT,a),B=u._isKeyDownForAction(u.PAN_UP,a),x=u._isKeyDownForAction(u.PAN_DOWN,a),P=(a[o.KEY_ALT]?.3:1)*A*r.keyboardPanRate;(_||y||b||w||B||x)&&(!r.firstPerson&&r.followPointer&&i.pivotController.startPivot(),x?s.panDeltaY+=P:B&&(s.panDeltaY+=-P),w?s.panDeltaX+=-P:b&&(s.panDeltaX+=P),y?s.panDeltaZ+=P:_&&(s.panDeltaZ+=-P))}}))}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("blur",this._onBlur),this._scene.input.off(this._onSceneKeyUp)}}]),e}(),Mp=le.vec3(),Fp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o=t.camera,a=i.pickController,l=i.pivotController,u=i.panController,A=i.cameraControl,c=1,h=1,d=null;this._onTick=t.on("tick",(function(){if(r.active&&r.pointerEnabled){var e="default";if(Math.abs(s.dollyDelta)<.001&&(s.dollyDelta=0),Math.abs(s.rotateDeltaX)<.001&&(s.rotateDeltaX=0),Math.abs(s.rotateDeltaY)<.001&&(s.rotateDeltaY=0),0===s.rotateDeltaX&&0===s.rotateDeltaY||(s.dollyDelta=0),r.followPointer){if(--c<=0&&(c=1,0!==s.dollyDelta)){if(0===s.rotateDeltaY&&0===s.rotateDeltaX&&r.followPointer&&n.followPointerDirty&&(a.pickCursorPos=n.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?d=a.pickResult.worldPos:(h=1,d=null),n.followPointerDirty=!1),d){var i=Math.abs(le.lenVec3(le.subVec3(d,t.camera.eye,Mp)));h=i/r.dollyProximityThreshold}h<r.dollyMinSpeed&&(h=r.dollyMinSpeed)}}else h=1,d=null;var p=s.dollyDelta*h;if(0===s.rotateDeltaY&&0===s.rotateDeltaX||(!r.firstPerson&&r.followPointer&&l.getPivoting()?(l.continuePivot(s.rotateDeltaY,s.rotateDeltaX),l.showPivot()):(0!==s.rotateDeltaX&&(r.firstPerson?o.pitch(-s.rotateDeltaX):o.orbitPitch(s.rotateDeltaX)),0!==s.rotateDeltaY&&(r.firstPerson?o.yaw(s.rotateDeltaY):o.orbitYaw(s.rotateDeltaY))),s.rotateDeltaX*=r.rotationInertia,s.rotateDeltaY*=r.rotationInertia,e=A._cursors.rotate),Math.abs(s.panDeltaX)<.001&&(s.panDeltaX=0),Math.abs(s.panDeltaY)<.001&&(s.panDeltaY=0),Math.abs(s.panDeltaZ)<.001&&(s.panDeltaZ=0),0!==s.panDeltaX||0!==s.panDeltaY||0!==s.panDeltaZ){var f,v,g=le.vec3();if(g[0]=s.panDeltaX,g[1]=s.panDeltaY,g[2]=s.panDeltaZ,r.constrainVertical){o.xUp?(f=o.eye[0],v=o.look[0]):o.yUp?(f=o.eye[1],v=o.look[1]):o.zUp&&(f=o.eye[2],v=o.look[2]),o.pan(g);var m=o.eye,_=o.look;o.xUp?(m[0]=f,_[0]=v):o.yUp?(m[1]=f,_[1]=v):o.zUp&&(m[2]=f,_[2]=v),o.eye=m,o.look=_}else o.pan(g);e=A._cursors.pan}if(s.panDeltaX*=r.panInertia,s.panDeltaY*=r.panInertia,s.panDeltaZ*=r.panInertia,0!==p){if(e=p<0?A._cursors.dollyForward:A._cursors.dollyBackward,r.firstPerson){var y,b;if(r.constrainVertical&&(o.xUp?(y=o.eye[0],b=o.look[0]):o.yUp?(y=o.eye[1],b=o.look[1]):o.zUp&&(y=o.eye[2],b=o.look[2])),r.followPointer)u.dollyToCanvasPos(d,n.pointerCanvasPos,-p)&&(n.followPointerDirty=!0);else o.pan([0,0,p]),o.ortho.scale=o.ortho.scale-p;if(r.constrainVertical){var w=o.eye,B=o.look;o.xUp?(w[0]=y,B[0]=b):o.yUp?(w[1]=y,B[1]=b):o.zUp&&(w[2]=y,B[2]=b),o.eye=w,o.look=B}}else if(r.planView){if(r.followPointer)u.dollyToCanvasPos(d,n.pointerCanvasPos,-p)&&(n.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+p,o.zoom(p)}else{if(r.followPointer)u.dollyToCanvasPos(d,n.pointerCanvasPos,-p)&&(n.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+p,o.zoom(p)}s.dollyDelta*=r.dollyInertia}a.fireEvents(),document.body.style.cursor=e}}))}return I(e,[{key:"destroy",value:function(){this._scene.off(this._onTick)}}]),e}(),kp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=function(){n.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=function(){n.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=function(e){Ep(e,o,n.pointerCanvasPos),n.mouseover=!0}),o.addEventListener("mousedown",this._mouseDownHandler=function(e){r.active&&r.pointerEnabled&&(Ep(e,o,n.pointerCanvasPos),n.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=function(e){r.active&&r.pointerEnabled})}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}]),e}();function Ep(e,t,i){if(e){var r=t.getBoundingClientRect(),n=r.left,s=r.top;i[0]=e.clientX-n,i[1]=e.clientY-s}else e=window.event,i[0]=e.x,i[1]=e.y;return i}var Ip=function(e,t,i){if(e){var r=t.getBoundingClientRect();i[0]=e.clientX-r.left,i[1]=e.clientY-r.top}else e=window.event,i[0]=e.x,i[1]=e.y;return i},Tp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o=i.pickController,a=i.pivotController,l=le.vec2(),u=le.vec2(),A=le.vec2(),c=le.vec2(),h=[],d=this._scene.canvas.canvas,p=0,f=!1;this._onTick=t.on("tick",(function(){f=!1})),d.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){if(r.active&&r.pointerEnabled){e.preventDefault();var i=e.touches,s=e.changedTouches;for(n.touchStartTime=Date.now(),1===i.length&&1===s.length&&(Ip(i[0],d,l),r.followPointer&&(o.pickCursorPos=l,o.schedulePickSurface=!0,o.update(),r.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(a.setPivotPos(o.pickResult.worldPos),!r.firstPerson&&a.startPivot()&&a.showPivot()):(r.smartPivot?a.setCanvasPivotPos(n.pointerCanvasPos):a.setPivotPos(t.camera.look),!r.firstPerson&&a.startPivot()&&a.showPivot()))));h.length<i.length;)h.push(le.vec2());for(var u=0,A=i.length;u<A;++u)Ip(i[u],d,h[u]);p=i.length}}),d.addEventListener("touchend",this._canvasTouchEndHandler=function(){a.getPivoting()&&(a.endPivot(),a.hidePivot())}),d.addEventListener("touchmove",this._canvasTouchMoveHandler=function(e){if(r.active&&r.pointerEnabled&&(e.stopPropagation(),e.preventDefault(),!f)){f=!0;var i=t.canvas.boundary,a=i[2],l=i[3],v=e.touches;if(e.touches.length===p){if(1===p){Ip(v[0],d,u),le.subVec2(u,h[0],c);var g=c[0],m=c[1];if(null!==n.longTouchTimeout&&(Math.abs(g)>r.longTapRadius||Math.abs(m)>r.longTapRadius)&&(clearTimeout(n.longTouchTimeout),n.longTouchTimeout=null),r.planView){var _=t.camera;if("perspective"===_.projection){var y=Math.abs(t.camera.eyeLookDist)*Math.tan(_.perspective.fov/2*Math.PI/180);s.panDeltaX+=g*y/l*r.touchPanRate,s.panDeltaY+=m*y/l*r.touchPanRate}else s.panDeltaX+=.5*_.ortho.scale*(g/l)*r.touchPanRate,s.panDeltaY+=.5*_.ortho.scale*(m/l)*r.touchPanRate}else s.rotateDeltaY-=g/a*(1*r.dragRotationRate),s.rotateDeltaX+=m/l*(1.5*r.dragRotationRate)}else if(2===p){var b=v[0],w=v[1];Ip(b,d,u),Ip(w,d,A);var B=le.geometricMeanVec2(h[0],h[1]),x=le.geometricMeanVec2(u,A),P=le.vec2();le.subVec2(B,x,P);var C=P[0],M=P[1],F=t.camera,k=le.distVec2([b.pageX,b.pageY],[w.pageX,w.pageY]),E=(le.distVec2(h[0],h[1])-k)*r.touchDollyRate;if(s.dollyDelta=E,n.followPointerDirty=!0,Math.abs(E)<1)if("perspective"===F.projection){var I=o.pickResult?o.pickResult.worldPos:t.center,T=Math.abs(le.lenVec3(le.subVec3(I,t.camera.eye,[])))*Math.tan(F.perspective.fov/2*Math.PI/180);s.panDeltaX-=C*T/l*r.touchPanRate,s.panDeltaY-=M*T/l*r.touchPanRate}else s.panDeltaX-=.5*F.ortho.scale*(C/l)*r.touchPanRate,s.panDeltaY-=.5*F.ortho.scale*(M/l)*r.touchPanRate;n.pointerCanvasPos=x}for(var D=0;D<p;++D)Ip(v[D],d,h[D])}}})}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}]),e}(),Dp=function(e,t){if(e){for(var i=e.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-n}else e=window.event,t[0]=e.x,t[1]=e.y;return t},Sp=function(){function e(t,i,r,n,s){k(this,e),this._scene=t;var o,a=i.pickController,l=i.cameraControl,u=[],A=new Float32Array(2),c=-1,h=-1,d=this._scene.canvas.canvas,p=function(e){var r;e&&e.worldPos&&(r=e.worldPos);var n=e?e.entity.aabb:t.aabb;if(r){var s=t.camera;le.subVec3(s.eye,s.look,[]),i.cameraFlight.flyTo({aabb:n})}else i.cameraFlight.flyTo({aabb:n})};d.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){if(r.active&&r.pointerEnabled){null!==n.longTouchTimeout&&(clearTimeout(n.longTouchTimeout),n.longTouchTimeout=null);var t=e.touches,s=e.changedTouches;if(o=Date.now(),1===t.length&&1===s.length){c=o,Dp(t[0],A);var a=A[0],l=A[1],h=t[0].pageX,d=t[0].pageY;n.longTouchTimeout=setTimeout((function(){r.active&&r.pointerEnabled&&i.cameraControl.fire("rightClick",{pagePos:[Math.round(h),Math.round(d)],canvasPos:[Math.round(a),Math.round(l)],event:e},!0),n.longTouchTimeout=null}),r.longTapTimeout)}else c=-1;for(;u.length<t.length;)u.push(new Float32Array(2));for(var p=0,f=t.length;p<f;++p)Dp(t[p],u[p]);u.length=t.length}},{passive:!0}),d.addEventListener("touchend",this._canvasTouchEndHandler=function(e){if(r.active&&r.pointerEnabled){var t=Date.now(),i=e.touches,s=e.changedTouches,o=l.hasSubs("pickedSurface");null!==n.longTouchTimeout&&(clearTimeout(n.longTouchTimeout),n.longTouchTimeout=null),0===i.length&&1===s.length&&c>-1&&t-c<150&&(h>-1&&c-h<325?(Dp(s[0],a.pickCursorPos),a.schedulePickEntity=!0,a.schedulePickSurface=o,a.update(),a.pickResult?(a.pickResult.touchInput=!0,l.fire("doublePicked",a.pickResult),a.pickedSurface&&l.fire("doublePickedSurface",a.pickResult),r.doublePickFlyTo&&p(a.pickResult)):(l.fire("doublePickedNothing"),r.doublePickFlyTo&&p()),h=-1):le.distVec2(u[0],A)<4&&(Dp(s[0],a.pickCursorPos),a.schedulePickEntity=!0,a.schedulePickSurface=o,a.update(),a.pickResult?(a.pickResult.touchInput=!0,l.fire("picked",a.pickResult),a.pickedSurface&&l.fire("pickedSurface",a.pickResult)):l.fire("pickedNothing"),h=t),c=-1),u.length=i.length;for(var d=0,f=i.length;d<f;++d)u[d][0]=i[d].pageX,u[d][1]=i[d].pageY}},{passive:!0})}return I(e,[{key:"reset",value:function(){}},{key:"destroy",value:function(){var e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}]),e}(),Rp=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e,n)).PAN_LEFT=0,r.PAN_RIGHT=1,r.PAN_UP=2,r.PAN_DOWN=3,r.PAN_FORWARDS=4,r.PAN_BACKWARDS=5,r.ROTATE_X_POS=6,r.ROTATE_X_NEG=7,r.ROTATE_Y_POS=8,r.ROTATE_Y_NEG=9,r.DOLLY_FORWARDS=10,r.DOLLY_BACKWARDS=11,r.AXIS_VIEW_RIGHT=12,r.AXIS_VIEW_BACK=13,r.AXIS_VIEW_LEFT=14,r.AXIS_VIEW_FRONT=15,r.AXIS_VIEW_TOP=16,r.AXIS_VIEW_BOTTOM=17,r.MOUSE_PAN=18,r.MOUSE_ROTATE=19,r.MOUSE_DOLLY=20,r._keyMap={},r.scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},r._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,zoomOnMouseWheel:!0,snapToVertex:true,snapToEdge:true,snapRadius:30,keyboardEnabledOnlyIfMouseover:!0,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},r._states={pointerCanvasPos:le.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:le.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},r._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};var s=r.scene;return r._controllers={cameraControl:w(r),pickController:new pp(w(r),r._configs),pivotController:new dp(s,r._configs),panController:new sp(s),cameraFlight:new et(w(r),{duration:.5})},r._handlers=[new kp(r.scene,r._controllers,r._configs,r._states,r._updates),new Tp(r.scene,r._controllers,r._configs,r._states,r._updates),new gp(r.scene,r._controllers,r._configs,r._states,r._updates),new xp(r.scene,r._controllers,r._configs,r._states,r._updates),new Pp(r.scene,r._controllers,r._configs,r._states,r._updates),new Sp(r.scene,r._controllers,r._configs,r._states,r._updates),new Cp(r.scene,r._controllers,r._configs,r._states,r._updates)],r._cursors={dollyForward:"zoom-in",dollyBackward:"zoom-out",rotate:"grabbing",pan:"move"},r._cameraUpdater=new Fp(r.scene,r._controllers,r._configs,r._states,r._updates),r.navMode=n.navMode,n.planView&&(r.planView=n.planView),r.constrainVertical=n.constrainVertical,n.keyboardLayout?r.keyboardLayout=n.keyboardLayout:r.keyMap=n.keyMap,r.doublePickFlyTo=n.doublePickFlyTo,r.panRightClick=n.panRightClick,r.active=n.active,r.followPointer=n.followPointer,r.rotationInertia=n.rotationInertia,r.keyboardPanRate=n.keyboardPanRate,r.touchPanRate=n.touchPanRate,r.keyboardRotationRate=n.keyboardRotationRate,r.dragRotationRate=n.dragRotationRate,r.touchDollyRate=n.touchDollyRate,r.dollyInertia=n.dollyInertia,r.dollyProximityThreshold=n.dollyProximityThreshold,r.dollyMinSpeed=n.dollyMinSpeed,r.panInertia=n.panInertia,r.pointerEnabled=!0,r.keyboardDollyRate=n.keyboardDollyRate,r.mouseWheelDollyRate=n.mouseWheelDollyRate,r}return I(i,[{key:"keyMap",get:function(){return this._keyMap},set:function(e){if(e=e||"qwerty",ge.isString(e)){var t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[]}this._keyMap=i}else{var r=e;this._keyMap=r}}},{key:"_areAllKeysDown",value:function(e,t){if(!t||t.length<=0)return!0;if(!e)return!1;for(var i=0,r=t.length;i<r;i++){if(!e[t[i]])return!1}return!0}},{key:"_isAnyOtherKeyDown",value:function(e,t){for(var i=0,r=e.length;i<r;i++)if(e[i])if(Array.isArray(t)){if(t.indexOf(i)<0)return!0}else if(i!==t)return!0;return!1}},{key:"_isMouseAction",value:function(e){switch(e){case this.MOUSE_ROTATE:case this.MOUSE_DOLLY:case this.MOUSE_PAN:return!0;default:return!1}}},{key:"_isKeyDownForAction",value:function(e,t){var i=this._keyMap[e];if(!i)return!1;if(0===i.length&&this._isMouseAction(e))return!0;t||(t=this.scene.input.keyDown);for(var r=0,n=i.length;r<n;r++){var s=i[r];if(Array.isArray(s)){if(this._areAllKeysDown(t,s)&&!this._isAnyOtherKeyDown(t,s))return!0}else if(t[s]&&!this._isAnyOtherKeyDown(t,s))return!0}return!1}},{key:"pivotElement",set:function(e){this._controllers.pivotController.setPivotElement(e)}},{key:"active",get:function(){return this._configs.active},set:function(e){e=!1!==e,this._configs.active=e,this._handlers[1]._active=e,this._handlers[5]._active=e}},{key:"snapToVertex",get:function(){return this._configs.snapToVertex},set:function(e){this._configs.snapToVertex=!!e}},{key:"snapToEdge",get:function(){return this._configs.snapToEdge},set:function(e){this._configs.snapToEdge=!!e}},{key:"snapRadius",get:function(){return this._configs.snapRadius},set:function(e){e=e||30,this._configs.snapRadius=e}},{key:"keyboardEnabledOnlyIfMouseover",get:function(){return this._configs.keyboardEnabledOnlyIfMouseover},set:function(e){this._configs.keyboardEnabledOnlyIfMouseover=!!e}},{key:"navMode",get:function(){return this._configs.navMode},set:function(e){"firstPerson"!==(e=e||"orbit")&&"orbit"!==e&&"planView"!==e&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson="firstPerson"===e,this._configs.planView="planView"===e,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}},{key:"pointerEnabled",get:function(){return this._configs.pointerEnabled},set:function(e){this._reset(),this._configs.pointerEnabled=!!e}},{key:"setCursorStyle",value:function(e,t){Object.prototype.hasOwnProperty.call(this._cursors,e)?this._cursors=h(h({},this._cursors),{},d({},e,t)):console.warn("Action '".concat(e,"' is not valid for cursor styles."))}},{key:"getCursorStyle",value:function(e){return this._cursors[e]||null}},{key:"_reset",value:function(){for(var e=0,t=this._handlers.length;e<t;e++){var i=this._handlers[e];i.reset&&i.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}},{key:"followPointer",get:function(){return this._configs.followPointer},set:function(e){this._configs.followPointer=!1!==e}},{key:"pivotPos",get:function(){return this._controllers.pivotController.getPivotPos()},set:function(e){this._controllers.pivotController.setPivotPos(e)}},{key:"dollyToPointer",get:function(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer},set:function(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}},{key:"panToPointer",get:function(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1},set:function(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}},{key:"planView",get:function(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView},set:function(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}},{key:"firstPerson",get:function(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson},set:function(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}},{key:"constrainVertical",get:function(){return this._configs.constrainVertical},set:function(e){this._configs.constrainVertical=!!e}},{key:"doublePickFlyTo",get:function(){return this._configs.doublePickFlyTo},set:function(e){this._configs.doublePickFlyTo=!1!==e}},{key:"panRightClick",get:function(){return this._configs.panRightClick},set:function(e){this._configs.panRightClick=!1!==e;var t=this._keyMap[this.MOUSE_PAN];if(t&&t.length>0)for(var i=this.scene.input,r=0,n=t.length;r<n;r++)this._configs.panRightClick&&t[r]===i.MOUSE_MIDDLE_BUTTON?this._keyMap[this.MOUSE_PAN][r]=i.MOUSE_RIGHT_BUTTON:this._configs.panRightClick||t[r]!==i.MOUSE_RIGHT_BUTTON||(this._keyMap[this.MOUSE_PAN][r]=i.MOUSE_MIDDLE_BUTTON)}},{key:"rotationInertia",get:function(){return this._configs.rotationInertia},set:function(e){this._configs.rotationInertia=null!=e?e:0}},{key:"keyboardPanRate",get:function(){return this._configs.keyboardPanRate},set:function(e){this._configs.keyboardPanRate=null!=e?e:5}},{key:"touchPanRate",get:function(){return this._configs.touchPanRate},set:function(e){this._configs.touchPanRate=null!=e?e:1}},{key:"keyboardRotationRate",get:function(){return this._configs.keyboardRotationRate},set:function(e){this._configs.keyboardRotationRate=null!=e?e:90}},{key:"dragRotationRate",get:function(){return this._configs.dragRotationRate},set:function(e){this._configs.dragRotationRate=null!=e?e:360}},{key:"keyboardDollyRate",get:function(){return this._configs.keyboardDollyRate},set:function(e){this._configs.keyboardDollyRate=null!=e?e:15}},{key:"touchDollyRate",get:function(){return this._configs.touchDollyRate},set:function(e){this._configs.touchDollyRate=null!=e?e:.2}},{key:"mouseWheelDollyRate",get:function(){return this._configs.mouseWheelDollyRate},set:function(e){this._configs.mouseWheelDollyRate=null!=e?e:100}},{key:"dollyInertia",get:function(){return this._configs.dollyInertia},set:function(e){this._configs.dollyInertia=null!=e?e:0}},{key:"dollyProximityThreshold",get:function(){return this._configs.dollyProximityThreshold},set:function(e){this._configs.dollyProximityThreshold=null!=e?e:35}},{key:"dollyMinSpeed",get:function(){return this._configs.dollyMinSpeed},set:function(e){this._configs.dollyMinSpeed=null!=e?e:.04}},{key:"panInertia",get:function(){return this._configs.panInertia},set:function(e){this._configs.panInertia=null!=e?e:.5}},{key:"keyboardLayout",get:function(){return this._configs.keyboardLayout},set:function(e){"qwerty"!==(e=e||"qwerty")&&"azerty"!==e&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}},{key:"enablePivotSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._controllers.pivotController.enablePivotSphere(e)}},{key:"disablePivotSphere",value:function(){this._controllers.pivotController.disablePivotSphere()}},{key:"smartPivot",get:function(){return this._configs.smartPivot},set:function(e){this._configs.smartPivot=!1!==e}},{key:"doubleClickTimeFrame",get:function(){return this._configs.doubleClickTimeFrame},set:function(e){this._configs.doubleClickTimeFrame=null!=e?e:250}},{key:"zoomOnMouseWheel",get:function(){return this._configs.zoomOnMouseWheel},set:function(e){this._configs.zoomOnMouseWheel=!!e}},{key:"destroy",value:function(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),v(x(i.prototype),"destroy",this).call(this)}},{key:"_destroyHandlers",value:function(){for(var e=0,t=this._handlers.length;e<t;e++){var i=this._handlers[e];i.destroy&&i.destroy()}}},{key:"_destroyControllers",value:function(){for(var e=0,t=this._controllers.length;e<t;e++){var i=this._controllers[e];i.destroy&&i.destroy()}}}]),i}(),Up=I((function e(t,i,r,n,s){k(this,e),this.name=t,this.type=r,this.value=i,this.valueType=n,this.description=s})),Lp=I((function e(t){if(k(this,e),this.id=t.id,this.originalSystemId=t.originalSystemId,this.metaModels=[],this.name=t.name,this.type=t.type,this.properties=[],t.properties)for(var i=t.properties,r=0,n=i.length;r<n;r++){var s=i[r];Number.isInteger(s)?this.properties.push(s):this.properties.push(new Up(s.name,s.value,s.type,s.valueType,s.description))}})),Op=function(){function e(t){k(this,e),this.metaModels=[],this.id=t.id,this.parentId=t.parentId,this.parent=null,this.originalSystemId=t.originalSystemId,this.name=t.name,this.type=t.type,this.propertySetIds=t.propertySetIds,this.propertySets=[],this.attributes=t.attributes||{},void 0!==t.external&&null!==t.external&&(this.external=t.external)}return I(e,[{key:"metaModel",get:function(){return 1==this.metaModels.length?this.metaModels[0]:null}},{key:"getObjectIDsInSubtree",value:function(){var e=[];return function t(i){if(i){e.push(i.id);var r=i.children;if(r)for(var n=0,s=r.length;n<s;n++)t(r[n])}}(this),e}},{key:"withMetaObjectsInSubtree",value:function(e){!function t(i){if(i){e(i);var r=i.children;if(r)for(var n=0,s=r.length;n<s;n++)t(r[n])}}(this)}},{key:"getObjectIDsInSubtreeByType",value:function(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i]]=e[i];var n=[];return function e(i){if(i){t[i.type]&&n.push(i.id);var r=i.children;if(r)for(var s=0,o=r.length;s<o;s++)e(r[s])}}(this),n}},{key:"getJSON",value:function(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}]),e}(),Np=function(){function e(t){k(this,e),this.id=t.id,this.projectId=t.projectId,this.revisionId=t.revisionId,this.author=t.author,this.createdAt=t.createdAt,this.creatingApplication=t.creatingApplication,this.schema=t.schema,this.metaScene=t.metaScene,this.propertySets=[],this.rootMetaObjects=[],this.metaObjects={},this.graph=t.graph||{},this.metaScene.metaModels[this.id]=this,this._propertyLookup=[],this.finalized=!1}return I(e,[{key:"rootMetaObject",get:function(){return 1===this.rootMetaObjects.length?this.rootMetaObjects[0]:null}},{key:"loadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.finalized)throw"MetaScene already finalized - can't add more data";this._globalizeIDs(e,t);var i=this.metaScene,r=e.properties;if(r)for(var n=0,s=r.length;n<s;n++)this._propertyLookup.push(r[n]);if(e.propertySets)for(var o=0,a=e.propertySets.length;o<a;o++){var l=e.propertySets[o];l.properties||(l.properties=[]);var u=i.propertySets[l.id];u||(u=new Lp({id:l.id,originalSystemId:l.originalSystemId||l.id,type:l.type,name:l.name,properties:l.properties}),i.propertySets[u.id]=u),u.metaModels.push(this),this.propertySets.push(u)}if(e.metaObjects)for(var A=0,c=e.metaObjects.length;A<c;A++){var h=e.metaObjects[A],d=h.id,p=i.metaObjects[d];if(!p){var f=h.type,v=h.originalSystemId,g=h.propertySets||h.propertySetIds;p=new Op({id:d,originalSystemId:v,parentId:h.parent,type:f,name:h.name,attributes:h.attributes,propertySetIds:g,external:h.external}),this.metaScene.metaObjects[d]=p,p.metaModels=[]}this.metaObjects[d]=p,h.parent||(this.rootMetaObjects.push(p),i.rootMetaObjects[d]=p),p.metaModels.push(this)}}},{key:"_decompressProperties",value:function(e,t){for(var i=[],r=0,n=t.length;r<n;r++){var s=t[r];if(Number.isInteger(s)){var o=e[s];o?t[r]=o:i.push(s)}}i.length>0&&console.error("[MetaModel._decompressProperties] Properties not found: ".concat(i))}},{key:"finalize",value:function(){if(this.finalized)throw"MetaScene already finalized - can't re-finalize";var e=this.metaScene;for(var t in e.metaObjects){var i=e.metaObjects[t];if(i.children&&(i.children=[]),i.propertySets&&(i.propertySets=[]),i.propertySetIds)for(var r=0,n=i.propertySetIds.length;r<n;r++){var s=i.propertySetIds[r],o=e.propertySets[s];i.propertySets.push(o)}}for(var a in e.metaObjects){var l=e.metaObjects[a];if(l.parentId){var u=e.metaObjects[l.parentId];u&&(l.parent=u,(u.children||(u.children=[])).push(l))}}for(var A in e.metaObjects){e.metaObjects[A].metaModels=[]}for(var c in e.metaModels){var h=e.metaModels[c];for(var d in h.metaObjects){h.metaObjects[d].metaModels.push(h)}}for(var p in e.metaObjectsByType={},e.metaObjects){var f=e.metaObjects[p],v=f.type;(e.metaObjectsByType[v]||(e.metaObjectsByType[v]={}))[p]=f}if(this.propertySets)for(var g=0,m=this.propertySets.length;g<m;g++){var _=this.propertySets[g];this._decompressProperties(this._propertyLookup,_.properties)}this._propertyLookup=[],this.finalized=!0,this.metaScene.fire("metaModelCreated",this.id)}},{key:"getJSON",value:function(){for(var e={id:this.id,projectId:this.projectId,author:this.author,createdAt:this.createdAt,schema:this.schema,creatingApplication:this.creatingApplication,metaObjects:[],propertySets:[]},t=Object.values(this.metaObjects),i=0,r=t.length;i<r;i++){var n=t[i],s={id:n.id,originalSystemId:n.originalSystemId,extId:n.extId,type:n.type,name:n.name};n.parent&&(s.parent=n.parent.id),n.attributes&&(s.attributes=n.attributes),n.propertySetIds&&(s.propertySetIds=n.propertySetIds),e.metaObjects.push(s)}for(var o=0,a=this.propertySets.length;o<a;o++){for(var l=this.propertySets[o],u={id:l.id,originalSystemId:l.originalSystemId,extId:l.extId,type:l.type,name:l.name,propertyies:[]},A=0,c=l.properties.length;A<c;A++){var h=l.properties[A],d={id:h.id,description:h.description,type:h.type,name:h.name,value:h.value,valueType:h.valueType};u.properties.push(d)}e.propertySets.push(u)}return e}},{key:"_globalizeIDs",value:function(e,t){var i=!!t.globalizeObjectIds;if(e.metaObjects)for(var r=0,n=e.metaObjects.length;r<n;r++){var s=e.metaObjects[r];if(s.originalSystemId=s.id,s.parent&&(s.originalParentSystemId=s.parent),i&&(s.id=le.globalizeObjectId(this.id,s.id),s.parent&&(s.parent=le.globalizeObjectId(this.id,s.parent))),i){var o=s.propertySetIds;if(o){for(var a=[],l=0,u=o.length;l<u;l++)a.push(le.globalizeObjectId(this.id,o[l]));s.propertySetIds=a,s.originalSystemPropertySetIds=o}}else s.originalSystemPropertySetIds=s.propertySetIds}if(e.propertySets)for(var A=0,c=e.propertySets.length;A<c;A++){var h=e.propertySets[A];h.originalSystemId=h.id,i&&(h.id=le.globalizeObjectId(this.id,h.id))}}}]),e}(),Vp=function(){function e(t,i){k(this,e),this.viewer=t,this.scene=i,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._eventSubs={}}return I(e,[{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"off",value:function(e){}},{key:"createMetaModel",value:function(e,t){var i=new Np({metaScene:this,id:e,projectId:t.projectId||"none",revisionId:t.revisionId||"none",author:t.author||"none",createdAt:t.createdAt||"none",creatingApplication:t.creatingApplication||"none",schema:t.schema||"none",propertySets:[]});return i.loadData(t),i.finalize(),i}},{key:"destroyMetaModel",value:function(e){var t=this.metaModels[e];if(t){if(t.propertySets)for(var i=0,r=t.propertySets.length;i<r;i++){var n=t.propertySets[i];if(1===n.metaModels.length&&n.metaModels[0].id===e)delete this.propertySets[n.id];else{for(var s=[],o=0,a=n.metaModels.length;o<a;o++)n.metaModels[o].id!==e&&s.push(n.metaModels[o]);n.metaModels=s}}if(t.metaObjects)for(var l in t.metaObjects){var u=t.metaObjects[l];1===u.metaModels.length&&u.metaModels[0].id===e?(delete this.metaObjects[l],u.parent||delete this.rootMetaObjects[l]):u.metaModels=u.metaModels.filter((function(t){return t.id!==e}))}for(var A in this.metaObjects){var c=this.metaObjects[A];if(c.children&&(c.children=[]),c.propertySets&&(c.propertySets=[]),c.propertySetIds)for(var h=0,d=c.propertySetIds.length;h<d;h++){var p=c.propertySetIds[h],f=this.propertySets[p];c.propertySets.push(f)}}for(var v in this.metaObjectsByType={},this.metaObjects){var g=this.metaObjects[v],m=g.type;g.children&&(g.children=null),(this.metaObjectsByType[m]||(this.metaObjectsByType[m]={}))[v]=g}for(var _ in this.metaObjects){var y=this.metaObjects[_];if(y.parentId){var b=this.metaObjects[y.parentId];b&&(y.parent=b,(b.children||(b.children=[])).push(y))}}for(var w in delete this.metaModels[e],this.metaObjects){this.metaObjects[w].metaModels=[]}for(var B in this.metaModels){var x=this.metaModels[B];for(var P in x.metaObjects){x.metaObjects[P].metaModels.push(x)}}this.fire("metaModelDestroyed",e)}}},{key:"getObjectIDsByType",value:function(e){var t=this.metaObjectsByType[e];return t?Object.keys(t):[]}},{key:"getObjectIDsInSubtree",value:function(e,t,i){var r=[],n=this.metaObjects[e],s=t&&t.length>0?Qp(t):null,o=i&&i.length>0?Qp(i):null;return function e(t){if(t){var i=!0;(o&&o[t.type]||s&&!s[t.type])&&(i=!1),i&&r.push(t.id);var n=t.children;if(n)for(var a=0,l=n.length;a<l;a++)e(n[a])}}(n),r}},{key:"withMetaObjectsInSubtree",value:function(e,t){var i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}]),e}();function Qp(e){for(var t={},i=0,r=e.length;i<r;i++)t[e[i]]=!0;return t}function Hp(e,t,i,r){return Gp.apply(this,arguments)}function Gp(){return(Gp=A(l().mark((function e(t,i,r,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n._parse(t,i,r,n));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function jp(e,t){if(!e)throw new Error(t||"loader assertion failed.")}var zp=Boolean("object"!==("undefined"==typeof process?"undefined":P(process))||"[object process]"!==String(process)||process.browser),Wp="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Wp&&parseFloat(Wp[1]);var Xp=globalThis,Kp=globalThis.process||{};function Zp(){var e;return!("object"===("undefined"==typeof process?"undefined":P(process))&&"[object process]"===String(process)&&!(null!==(e=process)&&void 0!==e&&e.browser))||function(e){var t,i;if("undefined"!=typeof window&&"renderer"===(null===(t=window.process)||void 0===t?void 0:t.type))return!0;if("undefined"!=typeof process&&Boolean(null===(i=process.versions)||void 0===i?void 0:i.electron))return!0;var r="undefined"!=typeof navigator&&navigator.userAgent,n=e||r;return Boolean(n&&n.indexOf("Electron")>=0)}()}function Jp(e){try{var t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),t}catch(e){return null}}var Yp,qp=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";k(this,e),this.storage=Jp(r),this.id=t,this.config=i,this._loadConfiguration()}return I(e,[{key:"getConfiguration",value:function(){return this.config}},{key:"setConfiguration",value:function(e){if(Object.assign(this.config,e),this.storage){var t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}},{key:"_loadConfiguration",value:function(){var e={};if(this.storage){var t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}]),e}();!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(Yp||(Yp={}));function $p(e){return"string"!=typeof e?e:(e=e.toUpperCase(),Yp[e]||Yp.WHITE)}function ef(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"],r=Object.getPrototypeOf(e),n=Object.getOwnPropertyNames(r),s=e,o=p(n);try{var a=function(){var r=t.value,n=s[r];"function"==typeof n&&(i.find((function(e){return r===e}))||(s[r]=n.bind(e)))};for(o.s();!(t=o.n()).done;)a()}catch(e){o.e(e)}finally{o.f()}}function tf(e,t){if(!e)throw new Error(t||"Assertion failed")}function rf(){var e,t,i;if(Zp()&&Xp.performance)e=null==Xp||null===(t=Xp.performance)||void 0===t||null===(i=t.now)||void 0===i?void 0:i.call(t);else if("hrtime"in Kp){var r,n=null==Kp||null===(r=Kp.hrtime)||void 0===r?void 0:r.call(Kp);e=1e3*n[0]+n[1]/1e6}else e=Date.now();return e}var nf={debug:Zp()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},sf={enabled:!0,level:0};function of(){}var af={},lf={once:!0},uf=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""},i=t.id;k(this,e),this.VERSION="4.1.0",this._startTs=rf(),this._deltaTs=rf(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=i,this.userData={},this._storage=new qp("__probe-".concat(this.id,"__"),sf),this.timeStamp("".concat(this.id," started")),ef(this),Object.seal(this)}return I(e,[{key:"level",get:function(){return this.getLevel()},set:function(e){this.setLevel(e)}},{key:"isEnabled",value:function(){return this._storage.config.enabled}},{key:"getLevel",value:function(){return this._storage.config.level}},{key:"getTotal",value:function(){return Number((rf()-this._startTs).toPrecision(10))}},{key:"getDelta",value:function(){return Number((rf()-this._deltaTs).toPrecision(10))}},{key:"priority",get:function(){return this.level},set:function(e){this.level=e}},{key:"getPriority",value:function(){return this.level}},{key:"enable",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._storage.setConfiguration({enabled:e}),this}},{key:"setLevel",value:function(e){return this._storage.setConfiguration({level:e}),this}},{key:"get",value:function(e){return this._storage.config[e]}},{key:"set",value:function(e,t){this._storage.setConfiguration(d({},e,t))}},{key:"settings",value:function(){console.table?console.table(this._storage.config):console.log(this._storage.config)}},{key:"assert",value:function(e,t){if(!e)throw new Error(t||"Assertion failed")}},{key:"warn",value:function(e){return this._getLogFunction(0,e,nf.warn,arguments,lf)}},{key:"error",value:function(e){return this._getLogFunction(0,e,nf.error,arguments)}},{key:"deprecated",value:function(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}},{key:"removed",value:function(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}},{key:"probe",value:function(e,t){return this._getLogFunction(e,t,nf.log,arguments,{time:!0,once:!0})}},{key:"log",value:function(e,t){return this._getLogFunction(e,t,nf.debug,arguments)}},{key:"info",value:function(e,t){return this._getLogFunction(e,t,console.info,arguments)}},{key:"once",value:function(e,t){return this._getLogFunction(e,t,nf.debug||nf.info,arguments,lf)}},{key:"table",value:function(e,t,i){return t?this._getLogFunction(e,t,console.table||of,i&&[i],{tag:hf(t)}):of}},{key:"time",value:function(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}},{key:"timeEnd",value:function(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}},{key:"timeStamp",value:function(e,t){return this._getLogFunction(e,t,console.timeStamp||of)}},{key:"group",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1},r=cf({logLevel:e,message:t,opts:i}),n=i.collapsed;return r.method=(n?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}},{key:"groupCollapsed",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}},{key:"groupEnd",value:function(e){return this._getLogFunction(e,"",console.groupEnd||of)}},{key:"withGroup",value:function(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}},{key:"trace",value:function(){console.trace&&console.trace()}},{key:"_shouldLog",value:function(e){return this.isEnabled()&&this.getLevel()>=Af(e)}},{key:"_getLogFunction",value:function(e,t,i,r,n){if(this._shouldLog(e)){var s;n=cf({logLevel:e,message:t,args:r,opts:n}),tf(i=i||n.method),n.total=this.getTotal(),n.delta=this.getDelta(),this._deltaTs=rf();var o=n.tag||n.message;if(n.once&&o){if(af[o])return of;af[o]=rf()}return t=function(e,t,i){if("string"==typeof t){var r=i.time?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,i=Math.max(t-e.length,0);return"".concat(" ".repeat(i)).concat(e)}((n=i.total)<10?"".concat(n.toFixed(2),"ms"):n<100?"".concat(n.toFixed(1),"ms"):n<1e3?"".concat(n.toFixed(0),"ms"):"".concat((n/1e3).toFixed(2),"s")):"";t=function(e,t,i){if(!Zp&&"string"==typeof e){if(t){var r=$p(t);e="[".concat(r,"m").concat(e,"[39m")}if(i){var n=$p(i);e="[".concat(n+10,"m").concat(e,"[49m")}}return e}(t=i.time?"".concat(e,": ").concat(r,"  ").concat(t):"".concat(e,": ").concat(t),i.color,i.background)}var n;return t}(this.id,n.message,n),(s=i).bind.apply(s,[console,t].concat(f(n.args)))}return of}}]),e}();function Af(e){if(!e)return 0;var t;switch(P(e)){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return tf(Number.isFinite(t)&&t>=0),t}function cf(e){var t=e.logLevel,i=e.message;e.logLevel=Af(t);for(var r=e.args?Array.from(e.args):[];r.length&&r.shift()!==i;);switch(P(t)){case"string":case"function":void 0!==i&&r.unshift(i),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());var n=P(e.message);return tf("string"===n||"object"===n),Object.assign(e,{args:r},e.opts)}function hf(e){for(var t in e)for(var i in e[t])return i||"untitled";return"empty"}uf.VERSION="4.1.0";var df="4.3.3"[0]>="0"&&"4.3.3"[0]<="9"?"v".concat("4.3.3"):"";var pf=function(){var e=new uf({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=e,globalThis.loaders.version=df,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=e,e}();function ff(e,t){return vf(e||{},t)}function vf(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(i>3)return t;for(var r=h({},e),n=0,s=Object.entries(t);n<s.length;n++){var o=C(s[n],2),a=o[0],l=o[1];l&&"object"===P(l)&&!Array.isArray(l)?r[a]=vf(r[a]||{},t[a],i+1):r[a]=t[a]}return r}function gf(e){var t;globalThis.loaders||(globalThis.loaders={}),(t=globalThis.loaders).modules||(t.modules={}),Object.assign(globalThis.loaders.modules,e)}function mf(e){var t,i;return(null===(t=globalThis.loaders)||void 0===t||null===(i=t.modules)||void 0===i?void 0:i[e])||null}var _f,yf=(null!==(_f=globalThis._loadersgl_)&&void 0!==_f&&_f.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version);function bf(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}var wf="object"!==("undefined"==typeof process?"undefined":P(process))||"[object process]"!==String(process)||process.browser,Bf="function"==typeof importScripts,xf="undefined"!=typeof window&&void 0!==window.orientation,Pf="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Pf&&parseFloat(Pf[1]);var Cf=function(){function e(t,i){var r=this;k(this,e),d(this,"name",void 0),d(this,"workerThread",void 0),d(this,"isRunning",!0),d(this,"result",void 0),d(this,"_resolve",(function(){})),d(this,"_reject",(function(){})),this.name=t,this.workerThread=i,this.result=new Promise((function(e,t){r._resolve=e,r._reject=t}))}return I(e,[{key:"postMessage",value:function(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}},{key:"done",value:function(e){bf(this.isRunning),this.isRunning=!1,this._resolve(e)}},{key:"error",value:function(e){bf(this.isRunning),this.isRunning=!1,this._reject(e)}}]),e}(),Mf=function(){function e(){k(this,e)}return I(e,[{key:"terminate",value:function(){}}]),e}(),Ff=new Map;function kf(e){bf(e.source&&!e.url||!e.source&&e.url);var t=Ff.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return Ef((t=e,"try {\n  importScripts('".concat(t,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var t}(e.url),Ff.set(e.url,t)),e.source&&(t=Ef(e.source),Ff.set(e.source,t))),bf(t),t}function Ef(e){var t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function If(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2?arguments[2]:void 0,r=i||new Set;if(e){if(Tf(e))r.add(e);else if(Tf(e.buffer))r.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"===P(e))for(var n in e)If(e[n],t,r)}else;return void 0===i?Array.from(r):[]}function Tf(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}var Df=function(){},Sf=function(){function e(t){k(this,e),d(this,"name",void 0),d(this,"source",void 0),d(this,"url",void 0),d(this,"terminated",!1),d(this,"worker",void 0),d(this,"onMessage",void 0),d(this,"onError",void 0),d(this,"_loadableURL","");var i=t.name,r=t.source,n=t.url;bf(r||n),this.name=i,this.source=r,this.url=n,this.onMessage=Df,this.onError=function(e){return console.log(e)},this.worker=wf?this._createBrowserWorker():this._createNodeWorker()}return I(e,[{key:"destroy",value:function(){this.onMessage=Df,this.onError=Df,this.worker.terminate(),this.terminated=!0}},{key:"isRunning",get:function(){return Boolean(this.onMessage)}},{key:"postMessage",value:function(e,t){t=t||If(e),this.worker.postMessage(e,t)}},{key:"_getErrorFromErrorEvent",value:function(e){var t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}},{key:"_createBrowserWorker",value:function(){var e=this;this._loadableURL=kf({source:this.source,url:this.url});var t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=function(t){t.data?e.onMessage(t.data):e.onError(new Error("No data received"))},t.onerror=function(t){e.onError(e._getErrorFromErrorEvent(t)),e.terminated=!0},t.onmessageerror=function(e){return console.error(e)},t}},{key:"_createNodeWorker",value:function(){var e,t=this;if(this.url){var i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new Mf(i,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Mf(this.source,{eval:!0})}return e.on("message",(function(e){t.onMessage(e)})),e.on("error",(function(e){t.onError(e)})),e.on("exit",(function(e){})),e}}],[{key:"isSupported",value:function(){return"undefined"!=typeof Worker&&wf||void 0!==Mf&&!wf}}]),e}(),Rf=function(){function e(t){k(this,e),d(this,"name","unnamed"),d(this,"source",void 0),d(this,"url",void 0),d(this,"maxConcurrency",1),d(this,"maxMobileConcurrency",1),d(this,"onDebug",(function(){})),d(this,"reuseWorkers",!0),d(this,"props",{}),d(this,"jobQueue",[]),d(this,"idleQueue",[]),d(this,"count",0),d(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}var t,i;return I(e,[{key:"destroy",value:function(){this.idleQueue.forEach((function(e){return e.destroy()})),this.isDestroyed=!0}},{key:"setProps",value:function(e){this.props=h(h({},this.props),e),void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}},{key:"startJob",value:(i=A(l().mark((function e(t){var i,r,n,s=this,o=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.length>1&&void 0!==o[1]?o[1]:function(e,t,i){return e.done(i)},r=o.length>2&&void 0!==o[2]?o[2]:function(e,t){return e.error(t)},n=new Promise((function(e){return s.jobQueue.push({name:t,onMessage:i,onError:r,onStart:e}),s})),this._startQueuedJob(),e.next=6,n;case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"_startQueuedJob",value:(t=A(l().mark((function e(){var t,i,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.jobQueue.length){e.next=2;break}return e.abrupt("return");case 2:if(t=this._getAvailableWorker()){e.next=5;break}return e.abrupt("return");case 5:if(!(i=this.jobQueue.shift())){e.next=23;break}return this.onDebug({message:"Starting job",name:i.name,workerThread:t,backlog:this.jobQueue.length}),r=new Cf(i.name,t),t.onMessage=function(e){return i.onMessage(r,e.type,e.payload)},t.onError=function(e){return i.onError(r,e)},i.onStart(r),e.prev=12,e.next=15,r.result;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(12),console.error("Worker exception: ".concat(e.t0));case 20:return e.prev=20,this.returnWorkerToQueue(t),e.finish(20);case 23:case"end":return e.stop()}}),e,this,[[12,17,20,23]])}))),function(){return t.apply(this,arguments)})},{key:"returnWorkerToQueue",value:function(e){!wf||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}},{key:"_getAvailableWorker",value:function(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;var e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new Sf({name:e,source:this.source,url:this.url})}return null}},{key:"_getMaxConcurrency",value:function(){return xf?this.maxMobileConcurrency:this.maxConcurrency}}],[{key:"isSupported",value:function(){return Sf.isSupported()}}]),e}(),Uf={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:function(){}},Lf=function(){function e(t){k(this,e),d(this,"props",void 0),d(this,"workerPools",new Map),this.props=h({},Uf),this.setProps(t),this.workerPools=new Map}return I(e,[{key:"destroy",value:function(){var e,t=p(this.workerPools.values());try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(e){t.e(e)}finally{t.f()}this.workerPools=new Map}},{key:"setProps",value:function(e){this.props=h(h({},this.props),e);var t,i=p(this.workerPools.values());try{for(i.s();!(t=i.n()).done;){t.value.setProps(this._getWorkerPoolProps())}}catch(e){i.e(e)}finally{i.f()}}},{key:"getWorkerPool",value:function(e){var t=e.name,i=e.source,r=e.url,n=this.workerPools.get(t);return n||((n=new Rf({name:t,source:i,url:r})).setProps(this._getWorkerPoolProps()),this.workerPools.set(t,n)),n}},{key:"_getWorkerPoolProps",value:function(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}],[{key:"isSupported",value:function(){return Sf.isSupported()}},{key:"getWorkerFarm",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e._workerFarm=e._workerFarm||new e({}),e._workerFarm.setProps(t),e._workerFarm}}]),e}();function Of(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t[e.id]||{},r="".concat(e.id,wf?"-worker.js":"-worker-node.js"),n=i.workerUrl;if(n||"compression"!==e.id||(n=t.workerUrl),"test"===t._workerType&&(n=wf?"modules/".concat(e.module,"/dist/").concat(r):"modules/".concat(e.module,"/src/workers/").concat(e.id,"-worker-node.ts")),!n){var s=e.version;"latest"===s&&(s="latest");var o=s?"@".concat(s):"";n="https://unpkg.com/@loaders.gl/".concat(e.module).concat(o,"/dist/").concat(r)}return bf(n),n}function Nf(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yf;bf(e,"no worker provided");var i=e.version;return!(!t||!i)}d(Lf,"_workerFarm",void 0);var Vf={};function Qf(e){return Hf.apply(this,arguments)}function Hf(){return Hf=A(l().mark((function e(t){var i,r,n,s=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=s.length>1&&void 0!==s[1]?s[1]:null,r=s.length>2&&void 0!==s[2]?s[2]:{},n=s.length>3&&void 0!==s[3]?s[3]:null,i&&(t=Gf(t,i,r,n)),Vf[t]=Vf[t]||jf(t),e.next=7,Vf[t];case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)}))),Hf.apply(this,arguments)}function Gf(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!i.useLocalLibraries&&e.startsWith("http"))return e;r=r||e;var n=i.modules||{};return n[r]?n[r]:wf?i.CDN?(bf(i.CDN.startsWith("http")),"".concat(i.CDN,"/").concat(t,"@").concat(yf,"/dist/libs/").concat(r)):Bf?"../src/libs/".concat(r):"modules/".concat(t,"/src/libs/").concat(r):"modules/".concat(t,"/dist/libs/").concat(r)}function jf(e){return zf.apply(this,arguments)}function zf(){return(zf=A(l().mark((function e(t){var i,r,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.endsWith("wasm")){e.next=4;break}return e.next=3,Xf(t);case 3:case 9:return e.abrupt("return",e.sent);case 4:if(wf){e.next=16;break}return e.prev=5,i=globalThis.loaders||{},r=i.requireFromFile,e.next=9,null==r?void 0:r(t);case 12:return e.prev=12,e.t0=e.catch(5),console.error(e.t0),e.abrupt("return",null);case 16:if(!Bf){e.next=18;break}return e.abrupt("return",importScripts(t));case 18:return e.next=20,Zf(t);case 20:return n=e.sent,e.abrupt("return",Wf(n,t));case 22:case"end":return e.stop()}}),e,null,[[5,12]])})))).apply(this,arguments)}function Wf(e,t){if(!wf){var i=(globalThis.loaders||{}).requireFromString;return null==i?void 0:i(e,t)}if(Bf)return eval.call(globalThis,e),null;var r=document.createElement("script");r.id=t;try{r.appendChild(document.createTextNode(e))}catch(t){r.text=e}return document.body.appendChild(r),null}function Xf(e){return Kf.apply(this,arguments)}function Kf(){return(Kf=A(l().mark((function e(t){var i,r,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=globalThis.loaders||{},r=i.readFileAsArrayBuffer,!wf&&r&&!t.startsWith("http")){e.next=8;break}return e.next=4,fetch(t);case 4:return n=e.sent,e.next=7,n.arrayBuffer();case 7:case 10:return e.abrupt("return",e.sent);case 8:return e.next=10,r(t);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Zf(e){return Jf.apply(this,arguments)}function Jf(){return(Jf=A(l().mark((function e(t){var i,r,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=globalThis.loaders||{},r=i.readFileAsText,!wf&&r&&!t.startsWith("http")){e.next=8;break}return e.next=4,fetch(t);case 4:return n=e.sent,e.next=7,n.text();case 7:case 10:return e.abrupt("return",e.sent);case 8:return e.next=10,r(t);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Yf(e,t){return!!Lf.isSupported()&&(!!(wf||null!=t&&t._nodeWorkers)&&(e.worker&&(null==t?void 0:t.worker)))}function qf(e,t,i,r,n){return $f.apply(this,arguments)}function $f(){return $f=A(l().mark((function e(t,i,r,n,s){var o,a,u,A,c,h;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.id,a=Of(t,r),u=Lf.getWorkerFarm(r),A=u.getWorkerPool({name:o,url:a}),r=JSON.parse(JSON.stringify(r)),n=JSON.parse(JSON.stringify(n||{})),e.next=8,A.startJob("process-on-worker",ev.bind(null,s));case 8:return(c=e.sent).postMessage("process",{input:i,options:r,context:n}),e.next=12,c.result;case 12:return h=e.sent,e.next=15,h.result;case 15:return e.abrupt("return",e.sent);case 16:case"end":return e.stop()}}),e)}))),$f.apply(this,arguments)}function ev(e,t,i,r){return tv.apply(this,arguments)}function tv(){return(tv=A(l().mark((function e(t,i,r,n){var s,o,a,u,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next="done"===e.t0?3:"error"===e.t0?5:"process"===e.t0?7:20;break;case 3:return i.done(n),e.abrupt("break",21);case 5:return i.error(new Error(n.error)),e.abrupt("break",21);case 7:return s=n.id,o=n.input,a=n.options,e.prev=8,e.next=11,t(o,a);case 11:u=e.sent,i.postMessage("done",{id:s,result:u}),e.next=19;break;case 15:e.prev=15,e.t1=e.catch(8),A=e.t1 instanceof Error?e.t1.message:"unknown error",i.postMessage("error",{id:s,error:A});case 19:return e.abrupt("break",21);case 20:console.warn("parse-with-worker unknown message ".concat(r));case 21:case"end":return e.stop()}}),e,null,[[8,15]])})))).apply(this,arguments)}function iv(e,t,i){if(e.byteLength<=t+i)return"";for(var r=new DataView(e),n="",s=0;s<i;s++)n+=String.fromCharCode(r.getUint8(t+s));return n}function rv(e){try{return JSON.parse(e)}catch(t){throw new Error('Failed to parse JSON from data starting with "'.concat(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return iv(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return iv(e,0,t)}return""}(e),'"'))}}function nv(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return sv(t)}function sv(e){var t,i=e.map((function(e){return e instanceof ArrayBuffer?new Uint8Array(e):e})),r=i.reduce((function(e,t){return e+t.byteLength}),0),n=new Uint8Array(r),s=0,o=p(i);try{for(o.s();!(t=o.n()).done;){var a=t.value;n.set(a,s),s+=a.byteLength}}catch(e){o.e(e)}finally{o.f()}return n.buffer}function ov(e,t,i){var r=void 0!==i?new Uint8Array(e).subarray(t,t+i):new Uint8Array(e).subarray(t);return new Uint8Array(r).buffer}function av(e,t){return jp(e>=0),jp(t>0),e+(t-1)&~(t-1)}function lv(e,t,i){var r;if(e instanceof ArrayBuffer)r=new Uint8Array(e);else{var n=e.byteOffset,s=e.byteLength;r=new Uint8Array(e.buffer||e.arrayBuffer,n,s)}return t.set(r,i),i+av(r.byteLength,4)}function uv(e){return Av.apply(this,arguments)}function Av(){return(Av=A(l().mark((function e(t){var i,r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=[],r=!1,n=!1,e.prev=3,o=U(t);case 5:return e.next=7,o.next();case 7:if(!(r=!(a=e.sent).done)){e.next=13;break}u=a.value,i.push(u);case 10:r=!1,e.next=5;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),n=!0,s=e.t0;case 19:if(e.prev=19,e.prev=20,!r||null==o.return){e.next=24;break}return e.next=24,o.return();case 24:if(e.prev=24,!n){e.next=27;break}throw s;case 27:return e.finish(24);case 28:return e.finish(19);case 29:return e.abrupt("return",nv.apply(void 0,i));case 30:case"end":return e.stop()}}),e,null,[[3,15,19,29],[20,,24,28]])})))).apply(this,arguments)}var cv={};function hv(e){for(var t in cv)if(e.startsWith(t)){var i=cv[t];e=e.replace(t,i)}return e.startsWith("http://")||e.startsWith("https://")||(e="".concat("").concat(e)),e}function dv(e){if((t=e)&&"object"===P(t)&&t.isBuffer)return e;var t;if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e){var i=e;return(new TextEncoder).encode(i).buffer}if(e&&"object"===P(e)&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}function pv(e){var t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}var fv=function(e){return"function"==typeof e},vv=function(e){return null!==e&&"object"===P(e)},gv=function(e){return vv(e)&&e.constructor==={}.constructor},mv=function(e){return Boolean(e)&&"function"==typeof e[Symbol.iterator]},_v=function(e){return e&&"function"==typeof e[Symbol.asyncIterator]},yv=function(e){return"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json},bv=function(e){return"undefined"!=typeof Blob&&e instanceof Blob},wv=function(e){return function(e){return"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||vv(e)&&fv(e.tee)&&fv(e.cancel)&&fv(e.getReader)}(e)||function(e){return vv(e)&&fv(e.read)&&fv(e.pipe)&&function(e){return"boolean"==typeof e}(e.readable)}(e)},Bv=function(e){m(i,o(Error));var t=y(i);function i(e,r){var n;return k(this,i),d(w(n=t.call(this,e)),"reason",void 0),d(w(n),"url",void 0),d(w(n),"response",void 0),n.reason=r.reason,n.url=r.url,n.response=r.response,n}return I(i)}(),xv=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Pv=/^([-\w.]+\/[-\w.+]+)/;function Cv(e,t){return e.toLowerCase()===t.toLowerCase()}function Mv(e){var t=xv.exec(e);return t?t[1]:""}var Fv=/\?.*/;function kv(e){return e.replace(Fv,"")}function Ev(e){if(e.length<50)return e;var t=e.slice(e.length-15),i=e.substr(0,32);return"".concat(i,"...").concat(t)}function Iv(e){return yv(e)?e.url:bv(e)?e.name||"":"string"==typeof e?e:""}function Tv(e){if(yv(e)){var t=e,i=t.headers.get("content-type")||"",r=kv(t.url);return function(e){var t=Pv.exec(e);return t?t[1]:e}(i)||Mv(r)}return bv(e)?e.type||"":"string"==typeof e?Mv(e):""}function Dv(e){return yv(e)?e.headers["content-length"]||-1:bv(e)?e.size:"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}function Sv(e){return Rv.apply(this,arguments)}function Rv(){return(Rv=A(l().mark((function e(t){var i,r,n,s,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!yv(t)){e.next=2;break}return e.abrupt("return",t);case 2:return i={},(r=Dv(t))>=0&&(i["content-length"]=String(r)),n=Iv(t),(s=Tv(t))&&(i["content-type"]=s),e.next=10,Vv(t);case 10:return(o=e.sent)&&(i["x-first-bytes"]=o),"string"==typeof t&&(t=(new TextEncoder).encode(t)),a=new Response(t,{headers:i}),Object.defineProperty(a,"url",{value:n}),e.abrupt("return",a);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Uv(e){return Lv.apply(this,arguments)}function Lv(){return(Lv=A(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.ok){e.next=5;break}return e.next=3,Ov(t);case 3:throw e.sent;case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ov(e){return Nv.apply(this,arguments)}function Nv(){return(Nv=A(l().mark((function e(t){var i,r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=Ev(t.url),r=(r="Failed to fetch resource (".concat(t.status,") ").concat(t.statusText,": ").concat(i)).length>100?"".concat(r.slice(0,100),"..."):r,n={reason:t.statusText,url:t.url,response:t},e.prev=4,s=t.headers.get("Content-Type"),t.bodyUsed||null==s||!s.includes("application/json")){e.next=12;break}return e.next=9,t.json();case 9:e.t0=e.sent,e.next=15;break;case 12:return e.next=14,t.text();case 14:e.t0=e.sent;case 15:n.reason=e.t0,e.next=20;break;case 18:e.prev=18,e.t1=e.catch(4);case 20:return e.abrupt("return",new Bv(r,n));case 21:case"end":return e.stop()}}),e,null,[[4,18]])})))).apply(this,arguments)}function Vv(e){return Qv.apply(this,arguments)}function Qv(){return(Qv=A(l().mark((function e(t){var i,r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=5,"string"!=typeof t){e.next=3;break}return e.abrupt("return","data:,".concat(t.slice(0,i)));case 3:if(!(t instanceof Blob)){e.next=8;break}return r=t.slice(0,5),e.next=7,new Promise((function(e){var t=new FileReader;t.onload=function(t){var i;return e(null==t||null===(i=t.target)||void 0===i?void 0:i.result)},t.readAsDataURL(r)}));case 7:return e.abrupt("return",e.sent);case 8:if(!(t instanceof ArrayBuffer)){e.next=12;break}return n=t.slice(0,i),s=Hv(n),e.abrupt("return","data:base64,".concat(s));case 12:return e.abrupt("return",null);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Hv(e){for(var t="",i=new Uint8Array(e),r=0;r<i.byteLength;r++)t+=String.fromCharCode(i[r]);return btoa(t)}function Gv(e){return!function(e){return e.startsWith("http:")||e.startsWith("https:")}(e)&&!function(e){return e.startsWith("data:")}(e)}function jv(e,t){return zv.apply(this,arguments)}function zv(){return(zv=A(l().mark((function e(t,i){var r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t){e.next=8;break}if(!Gv(r=hv(t))){e.next=5;break}if(null===(n=globalThis.loaders)||void 0===n||!n.fetchNode){e.next=5;break}return e.abrupt("return",null===(s=globalThis.loaders)||void 0===s?void 0:s.fetchNode(r,i));case 5:return e.next=7,fetch(r,i);case 7:case 10:return e.abrupt("return",e.sent);case 8:return e.next=10,Sv(t);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Wv=new uf({id:"loaders.gl"}),Xv=function(){function e(){k(this,e)}return I(e,[{key:"log",value:function(){return function(){}}},{key:"info",value:function(){return function(){}}},{key:"warn",value:function(){return function(){}}},{key:"error",value:function(){return function(){}}}]),e}(),Kv={fetch:null,mimeType:void 0,nothrow:!1,log:new(function(){function e(){k(this,e),d(this,"console",void 0),this.console=console}return I(e,[{key:"log",value:function(){for(var e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return(e=this.console.log).bind.apply(e,[this.console].concat(i))}},{key:"info",value:function(){for(var e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return(e=this.console.info).bind.apply(e,[this.console].concat(i))}},{key:"warn",value:function(){for(var e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return(e=this.console.warn).bind.apply(e,[this.console].concat(i))}},{key:"error",value:function(){for(var e,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return(e=this.console.error).bind.apply(e,[this.console].concat(i))}}]),e}()),useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:zp,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Zv={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Jv(){globalThis.loaders=globalThis.loaders||{};var e=globalThis.loaders;return e._state||(e._state={}),e._state}function Yv(){var e=Jv();return e.globalOptions=e.globalOptions||h({},Kv),e.globalOptions}function qv(e,t,i,r){return i=i||[],function(e,t){$v(e,null,Kv,Zv,t);var i,r=p(t);try{for(r.s();!(i=r.n()).done;){var n=i.value,s=e&&e[n.id]||{},o=n.options&&n.options[n.id]||{},a=n.deprecatedOptions&&n.deprecatedOptions[n.id]||{};$v(s,n.id,o,a,t)}}catch(e){r.e(e)}finally{r.f()}}(e,i=Array.isArray(i)?i:[i]),function(e,t,i){var r=h({},e.options||{});(function(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)})(r,i),null===r.log&&(r.log=new Xv);return tg(r,Yv()),tg(r,t),r}(t,e,r)}function $v(e,t,i,r,n){var s=t||"Top level",o=t?"".concat(t,"."):"";for(var a in e){var l=!t&&vv(e[a]);if(!(a in i)&&!("baseUri"===a&&!t)&&!("workerUrl"===a&&t))if(a in r)Wv.warn("".concat(s," loader option '").concat(o).concat(a,"' no longer supported, use '").concat(r[a],"'"))();else if(!l){var u=eg(a,n);Wv.warn("".concat(s," loader option '").concat(o).concat(a,"' not recognized. ").concat(u))()}}}function eg(e,t){var i,r=e.toLowerCase(),n="",s=p(t);try{for(s.s();!(i=s.n()).done;){var o=i.value;for(var a in o.options){if(e===a)return"Did you mean '".concat(o.id,".").concat(a,"'?");var l=a.toLowerCase();(r.startsWith(l)||l.startsWith(r))&&(n=n||"Did you mean '".concat(o.id,".").concat(a,"'?"))}}}catch(e){s.e(e)}finally{s.f()}return n}function tg(e,t){for(var i in t)if(i in t){var r=t[i];gv(r)&&gv(e[i])?e[i]=h(h({},e[i]),t[i]):e[i]=t[i]}}function ig(e){var t;return!!e&&(Array.isArray(e)&&(e=e[0]),Array.isArray(null===(t=e)||void 0===t?void 0:t.extensions))}function rg(e){var t,i,r;return jp(e,"null loader"),jp(ig(e),"invalid loader"),Array.isArray(e)&&(r=e[1],e=h(h({},e=e[0]),{},{options:h(h({},e.options),r)})),(null!==(t=e)&&void 0!==t&&t.parseTextSync||null!==(i=e)&&void 0!==i&&i.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}function ng(){return(e=Jv()).loaderRegistry=e.loaderRegistry||[],e.loaderRegistry;var e}var sg=/\.([^.]+)$/;function og(e){return ag.apply(this,arguments)}function ag(){return ag=A(l().mark((function e(t){var i,r,n,s,o=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=o.length>1&&void 0!==o[1]?o[1]:[],r=o.length>2?o[2]:void 0,n=o.length>3?o[3]:void 0,Ag(t)){e.next=5;break}return e.abrupt("return",null);case 5:if(!(s=lg(t,i,h(h({},r),{},{nothrow:!0}),n))){e.next=8;break}return e.abrupt("return",s);case 8:if(!bv(t)){e.next=13;break}return e.next=11,t.slice(0,10).arrayBuffer();case 11:t=e.sent,s=lg(t,i,r,n);case 13:if(s||null!=r&&r.nothrow){e.next=15;break}throw new Error(cg(t));case 15:return e.abrupt("return",s);case 16:case"end":return e.stop()}}),e)}))),ag.apply(this,arguments)}function lg(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;if(!Ag(e))return null;if(t&&!Array.isArray(t))return rg(t);var n,s=[];(t&&(s=s.concat(t)),null!=i&&i.ignoreRegisteredLoaders)||(n=s).push.apply(n,f(ng()));hg(s);var o=ug(e,s,i,r);if(!(o||null!=i&&i.nothrow))throw new Error(cg(e));return o}function ug(e,t,i,r){var n,s=Iv(e),o=Tv(e),a=kv(s)||(null==r?void 0:r.url),l=null,u="";(null!=i&&i.mimeType&&(l=dg(t,null==i?void 0:i.mimeType),u="match forced by supplied MIME type ".concat(null==i?void 0:i.mimeType)),l=l||function(e,t){var i=t&&sg.exec(t),r=i&&i[1];return r?function(e,t){t=t.toLowerCase();var i,r=p(e);try{for(r.s();!(i=r.n()).done;){var n,s=i.value,o=p(s.extensions);try{for(o.s();!(n=o.n()).done;){if(n.value.toLowerCase()===t)return s}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return null}(e,r):null}(t,a),u=u||(l?"matched url ".concat(a):""),l=l||dg(t,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||function(e,t){if(!t)return null;var i,r=p(e);try{for(r.s();!(i=r.n()).done;){var n=i.value;if("string"==typeof t){if(pg(t,n))return n}else if(ArrayBuffer.isView(t)){if(fg(t.buffer,t.byteOffset,n))return n}else if(t instanceof ArrayBuffer){if(fg(t,0,n))return n}}}catch(e){r.e(e)}finally{r.f()}return null}(t,e),u=u||(l?"matched initial data ".concat(vg(e)):""),null!=i&&i.fallbackMimeType&&(l=l||dg(t,null==i?void 0:i.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):"")),u)&&pf.log(1,"selectLoader selected ".concat(null===(n=l)||void 0===n?void 0:n.name,": ").concat(u,"."));return l}function Ag(e){return!(e instanceof Response&&204===e.status)}function cg(e){var t=Iv(e),i=Tv(e),r="No valid loader found (";r+=t?"".concat(pv(t),", "):"no url provided, ",r+="MIME type: ".concat(i?'"'.concat(i,'"'):"not provided",", ");var n=e?vg(e):"";return r+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",r+=")"}function hg(e){var t,i=p(e);try{for(i.s();!(t=i.n()).done;){rg(t.value)}}catch(e){i.e(e)}finally{i.f()}}function dg(e,t){var i,r=p(e);try{for(r.s();!(i=r.n()).done;){var n,s=i.value;if(null!==(n=s.mimeTypes)&&void 0!==n&&n.some((function(e){return Cv(t,e)})))return s;if(Cv(t,"application/x.".concat(s.id)))return s}}catch(e){r.e(e)}finally{r.f()}return null}function pg(e,t){return t.testText?t.testText(e):(Array.isArray(t.tests)?t.tests:[t.tests]).some((function(t){return e.startsWith(t)}))}function fg(e,t,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some((function(i){return function(e,t,i,r){if(r instanceof ArrayBuffer)return function(e,t,i){if(i=i||e.byteLength,e.byteLength<i||t.byteLength<i)return!1;for(var r=new Uint8Array(e),n=new Uint8Array(t),s=0;s<r.length;++s)if(r[s]!==n[s])return!1;return!0}(r,e,r.byteLength);switch(P(r)){case"function":return r(e);case"string":return r===gg(e,t,r.length);default:return!1}}(e,t,0,i)}))}function vg(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return gg(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){var i=0;return gg(e,i,t)}return""}function gg(e,t,i){if(e.byteLength<t+i)return"";for(var r=new DataView(e),n="",s=0;s<i;s++)n+=String.fromCharCode(r.getUint8(t+s));return n}function mg(e,t){var i,n,s,o,a;return l().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=(null==t?void 0:t.chunkSize)||262144,n=0,s=new TextEncoder;case 3:if(!(n<e.length)){r.next=11;break}return o=Math.min(e.length-n,i),a=e.slice(n,n+o),n+=o,r.next=9,s.encode(a);case 9:r.next=3;break;case 11:case"end":return r.stop()}}),r)}function _g(e){var t,i,r,s,o,a,u,A=arguments;return l().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:t=A.length>1&&void 0!==A[1]?A[1]:{},i=t.chunkSize,r=void 0===i?262144:i,s=0;case 3:if(!(s<e.byteLength)){n.next=14;break}return o=Math.min(e.byteLength-s,r),a=new ArrayBuffer(o),u=new Uint8Array(e,s,o),new Uint8Array(a).set(u),s+=o,n.next=12,a;case 12:n.next=3;break;case 14:case"end":return n.stop()}}),n)}function yg(){return(yg=D(l().mark((function e(t,i){var r,n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=(null==i?void 0:i.chunkSize)||1048576,n=0;case 2:if(!(n<t.size)){e.next=12;break}return s=n+r,e.next=6,T(t.slice(n,s).arrayBuffer());case 6:return o=e.sent,n=s,e.next=10,o;case 10:e.next=2;break;case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bg(e,t){return zp?function(e,t){return wg.apply(this,arguments)}(e,t):function(e,t){return Bg.apply(this,arguments)}(e)}function wg(){return(wg=D(l().mark((function e(t,i){var r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.getReader(),e.prev=1;case 2:return s=n||r.read(),null!=i&&i._streamReadAhead&&(n=r.read()),e.next=7,T(s);case 7:if(o=e.sent,a=o.done,u=o.value,!a){e.next=12;break}return e.abrupt("return");case 12:return e.next=14,dv(u);case 14:e.next=2;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(1),r.releaseLock();case 21:case"end":return e.stop()}}),e,null,[[1,18]])})))).apply(this,arguments)}function Bg(){return(Bg=D(l().mark((function e(t,i){var r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!1,n=!1,e.prev=2,o=U(t);case 4:return e.next=6,T(o.next());case 6:if(!(r=!(a=e.sent).done)){e.next=13;break}return u=a.value,e.next=10,dv(u);case 10:r=!1,e.next=4;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(2),n=!0,s=e.t0;case 19:if(e.prev=19,e.prev=20,!r||null==o.return){e.next=24;break}return e.next=24,T(o.return());case 24:if(e.prev=24,!n){e.next=27;break}throw s;case 27:return e.finish(24);case 28:return e.finish(19);case 29:case"end":return e.stop()}}),e,null,[[2,15,19,29],[20,,24,28]])})))).apply(this,arguments)}function xg(e,t){if("string"==typeof e)return mg(e,t);if(e instanceof ArrayBuffer)return _g(e,t);if(bv(e))return function(e,t){return yg.apply(this,arguments)}(e,t);if(wv(e))return bg(e,t);if(yv(e))return bg(e.body,t);throw new Error("makeIterator")}var Pg="Cannot convert supplied data type";function Cg(e,t,i){if(t.text&&"string"==typeof e)return e;var r;if((r=e)&&"object"===P(r)&&r.isBuffer&&(e=e.buffer),e instanceof ArrayBuffer){var n=e;return t.text&&!t.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(e);var s=e.buffer,o=e.byteLength||e.length;return 0===e.byteOffset&&o===s.byteLength||(s=s.slice(e.byteOffset,e.byteOffset+o)),s}throw new Error(Pg)}function Mg(e,t,i){return Fg.apply(this,arguments)}function Fg(){return(Fg=A(l().mark((function e(t,i,r){var n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t instanceof ArrayBuffer||ArrayBuffer.isView(t),"string"!=typeof t&&!n){e.next=3;break}return e.abrupt("return",Cg(t,i));case 3:if(!bv(t)){e.next=7;break}return e.next=6,Sv(t);case 6:t=e.sent;case 7:if(!yv(t)){e.next=21;break}return s=t,e.next=11,Uv(s);case 11:if(!i.binary){e.next=17;break}return e.next=14,s.arrayBuffer();case 14:e.t0=e.sent,e.next=20;break;case 17:return e.next=19,s.text();case 19:e.t0=e.sent;case 20:return e.abrupt("return",e.t0);case 21:if(wv(t)&&(t=xg(t,r)),!mv(t)&&!_v(t)){e.next=24;break}return e.abrupt("return",uv(t));case 24:throw new Error(Pg);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function kg(e,t){var i=Yv(),r=e||i;return"function"==typeof r.fetch?r.fetch:vv(r.fetch)?function(e){return jv(e,r.fetch)}:null!=t&&t.fetch?null==t?void 0:t.fetch:jv}function Eg(e,t,i){if(i)return i;var r,n,s=h({fetch:kg(t,e)},e);if(s.url){var o=kv(s.url);s.baseUrl=o,s.queryString=function(e){var t=e.match(Fv);return t&&t[0]}(s.url),s.filename=pv(o),s.baseUrl=(n=(r=o)?r.lastIndexOf("/"):-1)>=0?r.substr(0,n):""}return Array.isArray(s.loaders)||(s.loaders=null),s}function Ig(e,t){if(e&&!Array.isArray(e))return e;var i;if(e&&(i=Array.isArray(e)?e:[e]),t&&t.loaders){var r=Array.isArray(t.loaders)?t.loaders:[t.loaders];i=i?[].concat(f(i),f(r)):r}return i&&i.length?i:void 0}function Tg(e,t,i,r){return Dg.apply(this,arguments)}function Dg(){return(Dg=A(l().mark((function e(t,i,r,n){var s,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!i||Array.isArray(i)||ig(i)||(n=void 0,r=i,i=void 0),e.next=3,t;case 3:return t=e.sent,r=r||{},s=Iv(t),o=Ig(i,n),e.next=10,og(t,o,r);case 10:if(a=e.sent){e.next=13;break}return e.abrupt("return",null);case 13:return r=qv(r,a,o,s),n=Eg({url:s,_parse:Tg,loaders:o},r,n||null),e.next=17,Sg(a,t,r,n);case 17:return e.abrupt("return",e.sent);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Sg(e,t,i,r){return Rg.apply(this,arguments)}function Rg(){return(Rg=A(l().mark((function e(t,i,r,n){var s,o,a,u,A,c,h,d,p;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Nf(t),r=ff(t.options,r),yv(i)&&(o=(s=i).ok,a=s.redirected,u=s.status,A=s.statusText,c=s.type,h=s.url,d=Object.fromEntries(s.headers.entries()),n.response={headers:d,ok:o,redirected:a,status:u,statusText:A,type:c,url:h}),e.next=5,Mg(i,t,r);case 5:if(i=e.sent,!(p=t).parseTextSync||"string"!=typeof i){e.next=9;break}return e.abrupt("return",p.parseTextSync(i,r,n));case 9:if(!Yf(t,r)){e.next=13;break}return e.next=12,qf(t,i,r,n,Tg);case 12:case 16:case 20:return e.abrupt("return",e.sent);case 13:if(!p.parseText||"string"!=typeof i){e.next=17;break}return e.next=16,p.parseText(i,r,n);case 17:if(!p.parse){e.next=21;break}return e.next=20,p.parse(i,r,n);case 21:throw bf(!p.parseSync),new Error("".concat(t.id," loader - no parser found and worker is disabled"));case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ug(e){for(var t=1/0,i=1/0,r=1/0,n=-1/0,s=-1/0,o=-1/0,a=e.POSITION?e.POSITION.value:[],l=a&&a.length,u=0;u<l;u+=3){var A=a[u],c=a[u+1],h=a[u+2];t=A<t?A:t,i=c<i?c:i,r=h<r?h:r,n=A>n?A:n,s=c>s?c:s,o=h>o?h:o}return[[t,i,r],[n,s,o]]}function Lg(e,t,i){var r=function(e){switch(e.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}(t.value),n=i||function(e){var t={};"byteOffset"in e&&(t.byteOffset=e.byteOffset.toString(10));"byteStride"in e&&(t.byteStride=e.byteStride.toString(10));"normalized"in e&&(t.normalized=e.normalized.toString());return t}(t);return{name:e,type:{type:"fixed-size-list",listSize:t.size,children:[{name:"value",type:r}]},nullable:!1,metadata:n}}function Og(e){var t=[];for(var i in e){var r=e[i];t.push(Lg(i,r))}return t}var Ng=null===(e=globalThis.loaders)||void 0===e?void 0:e.parseImageNode,Vg="undefined"!=typeof Image,Qg="undefined"!=typeof ImageBitmap,Hg=Boolean(Ng),Gg=!!zp||Hg;function jg(e){var t=function(e){if("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&e instanceof Image)return"image";if(e&&"object"===P(e)&&e.data&&e.width&&e.height)return"data";return null}(e);if(!t)throw new Error("Not an image");return t}function zg(e){switch(jg(e)){case"data":return e;case"image":case"imagebitmap":var t=document.createElement("canvas"),i=t.getContext("2d");if(!i)throw new Error("getImageData");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}var Wg=/^data:image\/svg\+xml/,Xg=/\.svg((\?|#).*)?$/;function Kg(e){return e&&(Wg.test(e)||Xg.test(e))}function Zg(e,t){if(Kg(t)){var i=(new TextDecoder).decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(i=unescape(encodeURIComponent(i)))}catch(e){throw new Error(e.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return Jg(e,t)}function Jg(e,t){if(Kg(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}function Yg(e,t,i){return qg.apply(this,arguments)}function qg(){return(qg=A(l().mark((function e(t,i,r){var n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Zg(t,r),s=self.URL||self.webkitURL,o="string"!=typeof n&&s.createObjectURL(n),e.prev=3,e.next=6,$g(o||n,i);case 6:return e.abrupt("return",e.sent);case 7:return e.prev=7,o&&s.revokeObjectURL(o),e.finish(7);case 10:case"end":return e.stop()}}),e,null,[[3,,7,10]])})))).apply(this,arguments)}function $g(e,t){return em.apply(this,arguments)}function em(){return em=A(l().mark((function e(t,i){var r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=new Image).src=t,!(i.image&&i.image.decode&&r.decode)){e.next=6;break}return e.next=5,r.decode();case 5:return e.abrupt("return",r);case 6:return e.next=8,new Promise((function(e,t){try{r.onload=function(){return e(r)},r.onerror=function(e){var i=e instanceof Error?e.message:"error";t(new Error(i))}}catch(e){t(e)}}));case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)}))),em.apply(this,arguments)}var tm={},im=!0;function rm(e,t,i){return nm.apply(this,arguments)}function nm(){return(nm=A(l().mark((function e(t,i,r){var n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Kg(r)){e.next=7;break}return e.next=3,Yg(t,i,r);case 3:s=e.sent,n=s,e.next=8;break;case 7:n=Jg(t,r);case 8:return o=i&&i.imagebitmap,e.next=11,sm(n,o);case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function sm(e){return om.apply(this,arguments)}function om(){return om=A(l().mark((function e(t){var i,r=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!am(i=r.length>1&&void 0!==r[1]?r[1]:null)&&im||(i=null),!i){e.next=13;break}return e.prev=3,e.next=6,createImageBitmap(t,i);case 6:return e.abrupt("return",e.sent);case 9:e.prev=9,e.t0=e.catch(3),console.warn(e.t0),im=!1;case 13:return e.next=15,createImageBitmap(t);case 15:return e.abrupt("return",e.sent);case 16:case"end":return e.stop()}}),e,null,[[3,9]])}))),om.apply(this,arguments)}function am(e){for(var t in e||tm)return!1;return!0}function lm(e){return function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=um(t),n=0;n<r.length;++n)if(r[n]!==e[n+i])return!1;return!0}(e,"ftyp",4)?0==(96&e[8])?null:function(e){switch((t=e,i=8,r=12,String.fromCharCode.apply(String,f(t.slice(i,r)))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var t,i,r}(e):null}function um(e){return f(e).map((function(e){return e.charCodeAt(0)}))}function Am(e){var t=cm(e);return function(e){var t=cm(e);if(!(t.byteLength>=24&&2303741511===t.getUint32(0,false)))return null;return{mimeType:"image/png",width:t.getUint32(16,false),height:t.getUint32(20,false)}}(t)||function(e){var t=cm(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,false)&&255===t.getUint8(2)))return null;var i=function(){for(var e=new Set([65499,65476,65484,65501,65534]),t=65504;t<65520;++t)e.add(t);var i=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:e,sofMarkers:i}}(),r=i.tableMarkers,n=i.sofMarkers,s=2;for(;s+9<t.byteLength;){var o=t.getUint16(s,false);if(n.has(o))return{mimeType:"image/jpeg",height:t.getUint16(s+5,false),width:t.getUint16(s+7,false)};if(!r.has(o))return null;s+=2,s+=t.getUint16(s,false)}return null}(t)||function(e){var t=cm(e);if(!(t.byteLength>=10&&1195984440===t.getUint32(0,false)))return null;return{mimeType:"image/gif",width:t.getUint16(6,true),height:t.getUint16(8,true)}}(t)||function(e){var t=cm(e);if(!(t.byteLength>=14&&16973===t.getUint16(0,false)&&t.getUint32(2,true)===t.byteLength))return null;return{mimeType:"image/bmp",width:t.getUint32(18,true),height:t.getUint32(22,true)}}(t)||function(e){var t=lm(new Uint8Array(e instanceof DataView?e.buffer:e));if(!t)return null;return{mimeType:t.mimeType,width:0,height:0}}(t)}function cm(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}function hm(e,t){return dm.apply(this,arguments)}function dm(){return dm=A(l().mark((function e(t,i){var r,n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Am(t)||{},s=n.mimeType,jp(o=null===(r=globalThis.loaders)||void 0===r?void 0:r.parseImageNode),e.next=5,o(t,s);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)}))),dm.apply(this,arguments)}function pm(){return(pm=A(l().mark((function e(t,i,r){var n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=(i=i||{}).image||{},s=n.type||"auto",o=(r||{}).url,a=fm(s),e.t0=a,e.next="imagebitmap"===e.t0?8:"image"===e.t0?12:"data"===e.t0?16:20;break;case 8:return e.next=10,rm(t,i,o);case 10:return u=e.sent,e.abrupt("break",21);case 12:return e.next=14,Yg(t,i,o);case 14:return u=e.sent,e.abrupt("break",21);case 16:return e.next=18,hm(t);case 18:return u=e.sent,e.abrupt("break",21);case 20:jp(!1);case 21:return"data"===s&&(u=zg(u)),e.abrupt("return",u);case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function fm(e){switch(e){case"auto":case"data":return function(){if(Qg)return"imagebitmap";if(Vg)return"image";if(Gg)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(e){switch(e){case"auto":return Qg||Vg||Gg;case"imagebitmap":return Qg;case"image":return Vg;case"data":return Gg;default:throw new Error("@loaders.gl/images: image ".concat(e," not supported in this environment"))}}(e),e}}var vm={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.3",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:function(e,t,i){return pm.apply(this,arguments)},tests:[function(e){return Boolean(Am(new DataView(e)))}],options:{image:{type:"auto",decode:!0}}},gm={};function mm(e){if(void 0===gm[e]){var t=zp?function(e){switch(e){case"image/avif":case"image/webp":return function(e){try{return 0===document.createElement("canvas").toDataURL(e).indexOf("data:".concat(e))}catch(e){return!1}}(e);default:return!0}}(e):function(e){var t,i,r=["image/png","image/jpeg","image/gif"],n=(null===(t=globalThis.loaders)||void 0===t?void 0:t.imageFormatsNode)||r,s=null===(i=globalThis.loaders)||void 0===i?void 0:i.parseImageNode;return Boolean(s)&&n.includes(e)}(e);gm[e]=t}return gm[e]}function _m(e,t){if(!e)throw new Error(t||"assert failed: gltf")}var ym={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},bm={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},wm=["SCALAR","VEC2","VEC3","VEC4"],Bm=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],xm=new Map(Bm),Pm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Cm={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Mm={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Fm(e){return wm[e-1]||wm[0]}function km(e){var t=xm.get(e.constructor);if(!t)throw new Error("Illegal typed array");return t}function Em(e,t){var i=Mm[e.componentType],r=Pm[e.type],n=Cm[e.componentType],s=e.count*r,o=e.count*r*n;return _m(o>=0&&o<=t.byteLength),{ArrayType:i,length:s,byteLength:o,componentByteSize:bm[e.componentType],numberOfComponentsInElement:ym[e.type]}}function Im(e,t,i){var r=e.bufferViews[i];_m(r);var n=t[r.buffer];_m(n);var s=(r.byteOffset||0)+n.byteOffset;return new Uint8Array(n.arrayBuffer,s,r.byteLength)}var Tm=function(){function e(t){k(this,e),d(this,"gltf",void 0),d(this,"sourceBuffers",void 0),d(this,"byteLength",void 0),this.gltf={json:(null==t?void 0:t.json)||{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]},buffers:(null==t?void 0:t.buffers)||[],images:(null==t?void 0:t.images)||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}return I(e,[{key:"json",get:function(){return this.gltf.json}},{key:"getApplicationData",value:function(e){return this.json[e]}},{key:"getExtraData",value:function(e){return(this.json.extras||{})[e]}},{key:"hasExtension",value:function(e){var t=this.getUsedExtensions().find((function(t){return t===e})),i=this.getRequiredExtensions().find((function(t){return t===e}));return"string"==typeof t||"string"==typeof i}},{key:"getExtension",value:function(e){var t=this.getUsedExtensions().find((function(t){return t===e})),i=this.json.extensions||{};return t?i[e]:null}},{key:"getRequiredExtension",value:function(e){var t=this.getRequiredExtensions().find((function(t){return t===e}));return t?this.getExtension(e):null}},{key:"getRequiredExtensions",value:function(){return this.json.extensionsRequired||[]}},{key:"getUsedExtensions",value:function(){return this.json.extensionsUsed||[]}},{key:"getRemovedExtensions",value:function(){return this.json.extensionsRemoved||[]}},{key:"getObjectExtension",value:function(e,t){return(e.extensions||{})[t]}},{key:"getScene",value:function(e){return this.getObject("scenes",e)}},{key:"getNode",value:function(e){return this.getObject("nodes",e)}},{key:"getSkin",value:function(e){return this.getObject("skins",e)}},{key:"getMesh",value:function(e){return this.getObject("meshes",e)}},{key:"getMaterial",value:function(e){return this.getObject("materials",e)}},{key:"getAccessor",value:function(e){return this.getObject("accessors",e)}},{key:"getTexture",value:function(e){return this.getObject("textures",e)}},{key:"getSampler",value:function(e){return this.getObject("samplers",e)}},{key:"getImage",value:function(e){return this.getObject("images",e)}},{key:"getBufferView",value:function(e){return this.getObject("bufferViews",e)}},{key:"getBuffer",value:function(e){return this.getObject("buffers",e)}},{key:"getObject",value:function(e,t){if("object"===P(t))return t;var i=this.json[e]&&this.json[e][t];if(!i)throw new Error("glTF file error: Could not find ".concat(e,"[").concat(t,"]"));return i}},{key:"getTypedArrayForBufferView",value:function(e){var t=(e=this.getBufferView(e)).buffer,i=this.gltf.buffers[t];_m(i);var r=(e.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,r,e.byteLength)}},{key:"getTypedArrayForAccessor",value:function(e){var t=this.getAccessor(e);return function(e,t,i){var r,n,s="number"==typeof i?null===(r=e.accessors)||void 0===r?void 0:r[i]:i;if(!s)throw new Error("No gltf accessor ".concat(JSON.stringify(i)));var o=null===(n=e.bufferViews)||void 0===n?void 0:n[s.bufferView||0];if(!o)throw new Error("No gltf buffer view for accessor ".concat(o));var a=t[o.buffer],l=a.arrayBuffer,u=(a.byteOffset||0)+(s.byteOffset||0)+(o.byteOffset||0),A=Em(s,o),c=A.ArrayType,h=A.length,d=A.componentByteSize,p=A.numberOfComponentsInElement,f=d*p,v=o.byteStride||f;if(void 0===o.byteStride||o.byteStride===f)return new c(l,u,h);for(var g=new c(h),m=0;m<s.count;m++){var _=new c(l,u+m*v,p);g.set(_,m*p)}return g}(this.gltf.json,this.gltf.buffers,t)}},{key:"getTypedArrayForImageData",value:function(e){e=this.getAccessor(e);var t=this.getBufferView(e.bufferView),i=this.getBuffer(t.buffer).data,r=t.byteOffset||0;return new Uint8Array(i,r,t.byteLength)}},{key:"addApplicationData",value:function(e,t){return this.json[e]=t,this}},{key:"addExtraData",value:function(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}},{key:"addObjectExtension",value:function(e,t,i){return e.extensions=e.extensions||{},e.extensions[t]=i,this.registerUsedExtension(t),this}},{key:"setObjectExtension",value:function(e,t,i){(e.extensions||{})[t]=i}},{key:"removeObjectExtension",value:function(e,t){var i=(null==e?void 0:e.extensions)||{};if(i[t]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];var r=this.json.extensionsRemoved;r.includes(t)||r.push(t)}delete i[t]}},{key:"addExtension",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _m(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}},{key:"addRequiredExtension",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _m(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}},{key:"registerUsedExtension",value:function(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((function(t){return t===e}))||this.json.extensionsUsed.push(e)}},{key:"registerRequiredExtension",value:function(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((function(t){return t===e}))||this.json.extensionsRequired.push(e)}},{key:"removeExtension",value:function(e){var t;if(null!==(t=this.json.extensions)&&void 0!==t&&t[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];var i=this.json.extensionsRemoved;i.includes(e)||i.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}},{key:"setDefaultScene",value:function(e){this.json.scene=e}},{key:"addScene",value:function(e){var t=e.nodeIndices;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}},{key:"addNode",value:function(e){var t=e.meshIndex,i=e.matrix;this.json.nodes=this.json.nodes||[];var r={mesh:t};return i&&(r.matrix=i),this.json.nodes.push(r),this.json.nodes.length-1}},{key:"addMesh",value:function(e){var t=e.attributes,i=e.indices,r=e.material,n=e.mode,s=void 0===n?4:n,o={primitives:[{attributes:this._addAttributes(t),mode:s}]};if(i){var a=this._addIndices(i);o.primitives[0].indices=a}return Number.isFinite(r)&&(o.primitives[0].material=r),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}},{key:"addPointCloud",value:function(e){var t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}},{key:"addImage",value:function(e,t){var i=Am(e),r=t||(null==i?void 0:i.mimeType),n={bufferView:this.addBufferView(e),mimeType:r};return this.json.images=this.json.images||[],this.json.images.push(n),this.json.images.length-1}},{key:"addBufferView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.byteLength,r=e.byteLength;_m(Number.isFinite(r)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);var n={buffer:t,byteOffset:i,byteLength:r};return this.byteLength+=av(r,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(n),this.json.bufferViews.length-1}},{key:"addAccessor",value:function(e,t){var i={bufferView:e,type:Fm(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}},{key:"addBinaryBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{size:3},i=this.addBufferView(e),r={min:t.min,max:t.max};r.min&&r.max||(r=this._getAccessorMinMax(e,t.size));var n={size:t.size,componentType:km(e),count:Math.round(e.length/t.size),min:r.min,max:r.max};return this.addAccessor(i,Object.assign(n,t))}},{key:"addTexture",value:function(e){var t={source:e.imageIndex};return this.json.textures=this.json.textures||[],this.json.textures.push(t),this.json.textures.length-1}},{key:"addMaterial",value:function(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}},{key:"createBinaryChunk",value:function(){var e,t,i,r=this.byteLength,n=new ArrayBuffer(r),s=new Uint8Array(n),o=0,a=p(this.sourceBuffers||[]);try{for(a.s();!(i=a.n()).done;){o=lv(i.value,s,o)}}catch(e){a.e(e)}finally{a.f()}null!==(e=this.json)&&void 0!==e&&null!==(t=e.buffers)&&void 0!==t&&t[0]?this.json.buffers[0].byteLength=r:this.json.buffers=[{byteLength:r}],this.gltf.binary=n,this.sourceBuffers=[n],this.gltf.buffers=[{arrayBuffer:n,byteOffset:0,byteLength:n.byteLength}]}},{key:"_removeStringFromArray",value:function(e,t){for(var i=!0;i;){var r=e.indexOf(t);r>-1?e.splice(r,1):i=!1}}},{key:"_addAttributes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={};for(var i in e){var r=e[i],n=this._getGltfAttributeName(i),s=this.addBinaryBuffer(r.value,r);t[n]=s}return t}},{key:"_addIndices",value:function(e){return this.addBinaryBuffer(e,{size:1})}},{key:"_getGltfAttributeName",value:function(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}},{key:"_getAccessorMinMax",value:function(e,t){var i={min:null,max:null};if(e.length<t)return i;i.min=[],i.max=[];var r,n=p(e.subarray(0,t));try{for(n.s();!(r=n.n()).done;){var s=r.value;i.min.push(s),i.max.push(s)}}catch(e){n.e(e)}finally{n.f()}for(var o=t;o<e.length;o+=t)for(var a=0;a<t;a++)i.min[0+a]=Math.min(i.min[0+a],e[o+a]),i.max[0+a]=Math.max(i.max[0+a],e[o+a]);return i}}]),e}();function Dm(e){return(e%1+1)%1}var Sm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},Rm={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},Um={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function Lm(e,t){return Um[t]*Sm[e]}function Om(e,t,i,r){if("UINT8"!==i&&"UINT16"!==i&&"UINT32"!==i&&"UINT64"!==i)return null;var n=Nm(e.getTypedArrayForBufferView(t),"SCALAR",i,r+1);return n instanceof BigInt64Array||n instanceof BigUint64Array?null:n}function Nm(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,n=Sm[t],s=Rm[i],o=Um[i],a=r*n,l=a*o,u=e.buffer,A=e.byteOffset;if(A%o!=0){var c=new Uint8Array(u);u=c.slice(A,A+l).buffer,A=0}return new s(u,A,a)}function Vm(e,t,i){var r,n,s="TEXCOORD_".concat(t.texCoord||0),o=i.attributes[s],a=e.getTypedArrayForAccessor(o),l=e.gltf.json,u=t.index,A=null===(r=l.textures)||void 0===r||null===(n=r[u])||void 0===n?void 0:n.source;if(void 0!==A){var c,h,d,p=null===(c=l.images)||void 0===c||null===(h=c[A])||void 0===h?void 0:h.mimeType,f=null===(d=e.gltf.images)||void 0===d?void 0:d[A];if(f&&void 0!==f.width){for(var v=[],g=0;g<a.length;g+=2){var m=Hm(f,p,a,g,t.channels);v.push(m)}return v}}return[]}function Qm(e,t,i,r,n){if(null!=i&&i.length){var s,o=[],a=p(i);try{var l=function(){var e=s.value,t=r.findIndex((function(t){return t===e}));-1===t&&(t=r.push(e)-1),o.push(t)};for(a.s();!(s=a.n()).done;)l()}catch(e){a.e(e)}finally{a.f()}var u=new Uint32Array(o),A=e.gltf.buffers.push({arrayBuffer:u.buffer,byteOffset:u.byteOffset,byteLength:u.byteLength})-1,c=e.addBufferView(u,A,0),h=e.addAccessor(c,{size:1,componentType:km(u),count:u.length});n.attributes[t]=h}}function Hm(e,t,i,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[0],s={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},o=i[r],a=i[r+1],l=1;!t||-1===t.indexOf("image/jpeg")&&-1===t.indexOf("image/png")||(l=4);var u,A=Gm(o,a,e,l),c=0,h=p(n);try{for(h.s();!(u=h.n()).done;){var d=u.value,f="number"==typeof d?Object.values(s)[d]:s[d],v=A+f.offset,g=zg(e);if(g.data.length<=v)throw new Error("".concat(g.data.length," <= ").concat(v));var m=g.data[v];c|=m<<f.shift}}catch(e){h.e(e)}finally{h.f()}return c}function Gm(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,n=i.width,s=Dm(e)*(n-1),o=Math.round(s),a=i.height,l=Dm(t)*(a-1),u=Math.round(l),A=i.components?i.components:r,c=(u*n+o)*A;return c}function jm(e,t,i,r,n){for(var s=[],o=0;o<t;o++){var a=i[o],l=i[o+1]-i[o];if(l+a>r)break;var u=a/n,A=l/n;s.push(e.slice(u,u+A))}return s}function zm(e,t,i){for(var r=[],n=0;n<t;n++){var s=n*i;r.push(e.slice(s,s+i))}return r}function Wm(e,t,i,r){if(i)throw new Error("Not implemented - arrayOffsets for strings is specified");if(r){for(var n=[],s=new TextDecoder("utf8"),o=0,a=0;a<e;a++){var l=r[a+1]-r[a];if(l+o<=t.length){var u=t.subarray(o,l+o),A=s.decode(u);n.push(A),o+=l}}return n}return[]}function Xm(){return(Xm=A(l().mark((function e(t,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Km(new Tm(t),i);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Km(e,t){var i=e.gltf.json;if(i.meshes){var r,n=p(i.meshes);try{for(n.s();!(r=n.n()).done;){var s,o=p(r.value.primitives);try{for(o.s();!(s=o.n()).done;){Zm(e,s.value,t)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){n.e(e)}finally{n.f()}}}function Zm(e,t,i){var r,n;if(null!=i&&null!==(r=i.gltf)&&void 0!==r&&r.loadBuffers){var s=null===(n=t.extensions)||void 0===n?void 0:n.EXT_mesh_features,o=null==s?void 0:s.featureIds;if(o){var a,l=p(o);try{for(l.s();!(a=l.n()).done;){var u,A=a.value,c=void 0;if(void 0!==A.attribute){var h="_FEATURE_ID_".concat(A.attribute),d=t.attributes[h];c=e.getTypedArrayForAccessor(d)}else c=void 0!==A.texture&&null!=i&&null!==(u=i.gltf)&&void 0!==u&&u.loadImages?Vm(e,A.texture,t):[];A.data=c}}catch(e){l.e(e)}finally{l.f()}}}}function Jm(e,t){var i,r=null===(i=t.extensions)||void 0===i?void 0:i.EXT_mesh_features;if(r){var n=r.featureIds;n.forEach((function(i,r){if(i.data){var s=function(e){var t,i="_FEATURE_ID_",r=Object.keys(e).filter((function(e){return 0===e.indexOf(i)})),n=-1,s=p(r);try{for(s.s();!(t=s.n()).done;){var o=t.value,a=Number(o.substring(i.length));a>n&&(n=a)}}catch(e){s.e(e)}finally{s.f()}return n++,{accessorKey:"".concat(i).concat(n),index:n}}(t.attributes),o=s.accessorKey,a=s.index,l=new Uint32Array(i.data);n[r]={featureCount:l.length,propertyTable:i.propertyTable,attribute:a},e.gltf.buffers.push({arrayBuffer:l.buffer,byteOffset:l.byteOffset,byteLength:l.byteLength});var u=e.addBufferView(l),A=e.addAccessor(u,{size:1,componentType:km(l),count:l.length});t.attributes[o]=A}}))}}var Ym=Object.freeze({__proto__:null,name:"EXT_mesh_features",decode:function(e,t){return Xm.apply(this,arguments)},encode:function(e,t){var i=new Tm(e);return function(e,t){var i=e.gltf.json.meshes;if(!i)return;var r,n=p(i);try{for(n.s();!(r=n.n()).done;){var s,o=p(r.value.primitives);try{for(o.s();!(s=o.n()).done;){Jm(e,s.value)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){n.e(e)}finally{n.f()}}(i),i.createBinaryChunk(),i.gltf},createExtMeshFeatures:function(e,t,i,r){t.extensions||(t.extensions={});var n=t.extensions.EXT_mesh_features;n||(n={featureIds:[]},t.extensions.EXT_mesh_features=n);var s=n.featureIds,o={featureCount:i.length,propertyTable:r,data:i};s.push(o),e.addObjectExtension(t,"EXT_mesh_features",n)}});function qm(){return(qm=A(l().mark((function e(t,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:$m(new Tm(t),i);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $m(e,t){var i,r;if(null!==(i=t.gltf)&&void 0!==i&&i.loadBuffers){var n=e.getExtension("EXT_structural_metadata");n&&(null!==(r=t.gltf)&&void 0!==r&&r.loadImages&&function(e,t){var i=t.propertyTextures,r=e.gltf.json;if(i&&r.meshes){var n,s=p(r.meshes);try{for(s.s();!(n=s.n()).done;){var o,a=p(n.value.primitives);try{for(a.s();!(o=a.n()).done;){t_(e,i,o.value,t)}}catch(e){a.e(e)}finally{a.f()}}}catch(e){s.e(e)}finally{s.f()}}}(e,n),function(e,t){var i=t.schema;if(!i)return;var r=i.classes,n=t.propertyTables;if(r&&n)for(var s in r){var o=e_(n,s);o&&r_(e,i,o)}}(e,n))}}function e_(e,t){var i,r=p(e);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.class===t)return n}}catch(e){r.e(e)}finally{r.f()}return null}function t_(e,t,i,r){var n;if(t){var s=null===(n=i.extensions)||void 0===n?void 0:n.EXT_structural_metadata,o=null==s?void 0:s.propertyTextures;if(o){var a,l=p(o);try{for(l.s();!(a=l.n()).done;){i_(e,t[a.value],i,r)}}catch(e){l.e(e)}finally{l.f()}}}}function i_(e,t,i,r){if(t.properties){r.dataAttributeNames||(r.dataAttributeNames=[]);var n=t.class;for(var s in t.properties){var o,a="".concat(n,"_").concat(s),l=null===(o=t.properties)||void 0===o?void 0:o[s];if(l){l.data||(l.data=[]);var u=l.data,A=Vm(e,l,i);null!==A&&(Qm(e,a,A,u,i),l.data=u,r.dataAttributeNames.push(a))}}}}function r_(e,t,i){var r,n=null===(r=t.classes)||void 0===r?void 0:r[i.class];if(!n)throw new Error("Incorrect data in the EXT_structural_metadata extension: no schema class with name ".concat(i.class));var s=i.count;for(var o in n.properties){var a,l=n.properties[o],u=null===(a=i.properties)||void 0===a?void 0:a[o];if(u){var A=n_(e,t,l,s,u);u.data=A}}}function n_(e,t,i,r,n){var s=[],o=n.values,a=e.getTypedArrayForBufferView(o),l=function(e,t,i,r){if(t.array&&void 0===t.count&&void 0!==i.arrayOffsets)return Om(e,i.arrayOffsets,i.arrayOffsetType||"UINT32",r);return null}(e,i,n,r),u=function(e,t,i){if(void 0!==t.stringOffsets)return Om(e,t.stringOffsets,t.stringOffsetType||"UINT32",i);return null}(e,n,r);switch(i.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":s=function(e,t,i,r){var n,s=e.array,o=e.count,a=Lm(e.type,e.componentType),l=i.byteLength/a;n=e.componentType?Nm(i,e.type,e.componentType,l):i;if(s)return r?jm(n,t,r,i.length,a):o?zm(n,t,o):[];return n}(i,r,a,l);break;case"BOOLEAN":throw new Error("Not implemented - classProperty.type=".concat(i.type));case"STRING":s=Wm(r,a,l,u);break;case"ENUM":s=function(e,t,i,r,n){var s,o=t.enumType;if(!o)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");var a=null===(s=e.enums)||void 0===s?void 0:s[o];if(!a)throw new Error("Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ".concat(o));var l=a.valueType||"UINT16",u=Lm(t.type,l),A=r.byteLength/u,c=Nm(r,t.type,l,A);c||(c=r);if(t.array){if(n)return function(e){for(var t=e.valuesData,i=e.numberOfElements,r=e.arrayOffsets,n=e.valuesDataBytesLength,s=e.elementSize,o=e.enumEntry,a=[],l=0;l<i;l++){var u=r[l],A=r[l+1]-r[l];if(A+u>n)break;var c=s_(t,u/s,A/s,o);a.push(c)}return a}({valuesData:c,numberOfElements:i,arrayOffsets:n,valuesDataBytesLength:r.length,elementSize:u,enumEntry:a});var h=t.count;return h?function(e,t,i,r){for(var n=[],s=0;s<t;s++){var o=s_(e,i*s,i,r);n.push(o)}return n}(c,i,h,a):[]}return s_(c,0,i,a)}(t,i,r,a,l);break;default:throw new Error("Unknown classProperty type ".concat(i.type))}return s}function s_(e,t,i,r){for(var n=[],s=0;s<i;s++)if(e instanceof BigInt64Array||e instanceof BigUint64Array)n.push("");else{var o=o_(r,e[t+s]);o?n.push(o.name):n.push("")}return n}function o_(e,t){var i,r=p(e.values);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.value===t)return n}}catch(e){r.e(e)}finally{r.f()}return null}function a_(e,t,i){for(var r in e.properties){var n=e.properties[r].data;if(n){var s=t.properties[r];if(s){var o=A_(n,s,i);e.properties[r]=o}}}}function l_(e,t,i){var r,n=null!=i?i:{id:"schema_id"},s={properties:{}},o=p(e);try{for(o.s();!(r=o.n()).done;){var a=r.value,l={type:a.elementType,componentType:a.componentType};s.properties[a.name]=l}}catch(e){o.e(e)}finally{o.f()}return n.classes={},n.classes[t]=s,n}function u_(e,t,i){var r,n,s={class:t,count:0},o=0,a=null===(r=i.classes)||void 0===r?void 0:r[t],l=p(e);try{for(l.s();!(n=l.n()).done;){var u=n.value;if(0===o&&(o=u.values.length),o!==u.values.length&&u.values.length)throw new Error("Illegal values in attributes");(null==a?void 0:a.properties[u.name])&&(s.properties||(s.properties={}),s.properties[u.name]={values:0,data:u.values})}}catch(e){l.e(e)}finally{l.f()}return s.count=o,s}function A_(e,t,i){var r={values:0};if("STRING"===t.type){var n=function(e){var t,i=new TextEncoder,r=[],n=0,s=p(e);try{for(s.s();!(t=s.n()).done;){var o=t.value,a=i.encode(o);n+=a.length,r.push(a)}}catch(e){s.e(e)}finally{s.f()}for(var l=new Uint8Array(n),u=[],A=0,c=0,h=r;c<h.length;c++){var d=h[c];l.set(d,A),u.push(A),A+=d.length}u.push(A);var f=new Uint32Array(u);return{stringData:l,stringOffsets:f}}(e),s=n.stringData,o=n.stringOffsets;r.stringOffsets=h_(o,i),r.values=h_(s,i)}else if("SCALAR"===t.type&&t.componentType){var a=function(e,t){var i,r=[],n=p(e);try{for(n.s();!(i=n.n()).done;){var s=i.value;r.push(Number(s))}}catch(e){n.e(e)}finally{n.f()}var o=c_[t];if(!o)throw new Error("Illegal component type");return new o(r)}(e,t.componentType);r.values=h_(a,i)}return r}var c_={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function h_(e,t){return t.gltf.buffers.push({arrayBuffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength}),t.addBufferView(e)}var d_=Object.freeze({__proto__:null,name:"EXT_structural_metadata",decode:function(e,t){return qm.apply(this,arguments)},encode:function(e,t){var i=new Tm(e);return function(e,t){var i=e.getExtension("EXT_structural_metadata");if(!i)return;if(i.propertyTables){var r,n=p(i.propertyTables);try{for(n.s();!(r=n.n()).done;){var s,o,a=r.value,l=a.class,u=null===(s=i.schema)||void 0===s||null===(o=s.classes)||void 0===o?void 0:o[l];a.properties&&u&&a_(a,u,e)}}catch(e){n.e(e)}finally{n.f()}}}(i),i.createBinaryChunk(),i.gltf},createExtStructuralMetadata:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"schemaClassId",r=e.getExtension("EXT_structural_metadata");r||(r=e.addExtension("EXT_structural_metadata")),r.schema=l_(t,i,r.schema);var n=u_(t,i,r.schema);return r.propertyTables||(r.propertyTables=[]),r.propertyTables.push(n)-1}});function p_(){return(p_=A(l().mark((function e(t,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f_(new Tm(t),i);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function f_(e,t){var i,r;if(null!==(i=t.gltf)&&void 0!==i&&i.loadBuffers){var n=e.getExtension("EXT_feature_metadata");n&&(null!==(r=t.gltf)&&void 0!==r&&r.loadImages&&function(e,t){var i=t.schema;if(!i)return;var r=i.classes,n=t.featureTextures;if(r&&n)for(var s in r){var o=r[s],a=g_(n,s);a&&__(e,a,o)}}(e,n),function(e,t){var i=t.schema;if(!i)return;var r=i.classes,n=t.featureTables;if(r&&n)for(var s in r){var o=v_(n,s);o&&m_(e,i,o)}}(e,n))}}function v_(e,t){for(var i in e){var r=e[i];if(r.class===t)return r}return null}function g_(e,t){for(var i in e){var r=e[i];if(r.class===t)return r}return null}function m_(e,t,i){var r;if(i.class){var n=null===(r=t.classes)||void 0===r?void 0:r[i.class];if(!n)throw new Error("Incorrect data in the EXT_structural_metadata extension: no schema class with name ".concat(i.class));var s=i.count;for(var o in n.properties){var a,l=n.properties[o],u=null===(a=i.properties)||void 0===a?void 0:a[o];if(u){var A=y_(e,t,l,s,u);u.data=A}}}}function __(e,t,i){var r=t.class;for(var n in i.properties){var s,o=null==t||null===(s=t.properties)||void 0===s?void 0:s[n];if(o){var a=b_(e,o,r);o.data=a}}}function y_(e,t,i,r,n){var s,o,a=[],l=n.bufferView,u=e.getTypedArrayForBufferView(l),A=function(e,t,i,r){if("ARRAY"===t.type&&void 0===t.componentCount&&void 0!==i.arrayOffsetBufferView)return Om(e,i.arrayOffsetBufferView,i.offsetType||"UINT32",r);return null}(e,i,n,r),c=function(e,t,i,r){if(void 0!==i.stringOffsetBufferView)return Om(e,i.stringOffsetBufferView,i.offsetType||"UINT32",r);return null}(e,0,n,r);return"STRING"===i.type||"STRING"===i.componentType?a=Wm(r,u,A,c):((o=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"]).includes((s=i).type)||void 0!==s.componentType&&o.includes(s.componentType))&&(a=function(e,t,i,r){var n="ARRAY"===e.type,s=e.componentCount,o="SCALAR",a=e.componentType||e.type,l=Lm(o,a),u=i.byteLength/l,A=Nm(i,o,a,u);if(n)return r?jm(A,t,r,i.length,l):s?zm(A,t,s):[];return A}(i,r,u,A)),a}function b_(e,t,i){var r=e.gltf.json;if(!r.meshes)return[];var n,s=[],o=p(r.meshes);try{for(o.s();!(n=o.n()).done;){var a,l=p(n.value.primitives);try{for(l.s();!(a=l.n()).done;){w_(e,i,t,s,a.value)}}catch(e){l.e(e)}finally{l.f()}}}catch(e){o.e(e)}finally{o.f()}return s}function w_(e,t,i,r,n){var s=Vm(e,h({channels:i.channels},i.texture),n);s&&Qm(e,t,s,r,n)}var B_,x_,P_=Object.freeze({__proto__:null,name:"EXT_feature_metadata",decode:function(e,t){return p_.apply(this,arguments)}}),C_="basis_transcoder.js",M_="basis_transcoder.wasm",F_="basis_encoder.js",k_="basis_encoder.wasm";function E_(e){return I_.apply(this,arguments)}function I_(){return(I_=A(l().mark((function e(t){var i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(gf(t.modules),!(i=mf("basis"))){e.next=4;break}return e.abrupt("return",i);case 4:return B_||(B_=T_(t)),e.next=7,B_;case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T_(e){return D_.apply(this,arguments)}function D_(){return(D_=A(l().mark((function e(t){var i,r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=null,r=null,e.t0=Promise,e.next=5,Qf(C_,"textures",t);case 5:return e.t1=e.sent,e.next=8,Qf(M_,"textures",t);case 8:return e.t2=e.sent,e.t3=[e.t1,e.t2],e.next=12,e.t0.all.call(e.t0,e.t3);case 12:return n=e.sent,s=C(n,2),i=s[0],r=s[1],i=i||globalThis.BASIS,e.next=19,S_(i,r);case 19:return e.abrupt("return",e.sent);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S_(e,t){var i={};return t&&(i.wasmBinary=t),new Promise((function(t){e(i).then((function(e){var i=e.BasisFile;(0,e.initializeBasis)(),t({BasisFile:i})}))}))}function R_(e){return U_.apply(this,arguments)}function U_(){return(U_=A(l().mark((function e(t){var i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=t.modules||{}).basisEncoder){e.next=3;break}return e.abrupt("return",i.basisEncoder);case 3:return x_=x_||L_(t),e.next=6,x_;case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function L_(e){return O_.apply(this,arguments)}function O_(){return(O_=A(l().mark((function e(t){var i,r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=null,r=null,e.t0=Promise,e.next=5,Qf(F_,"textures",t);case 5:return e.t1=e.sent,e.next=8,Qf(k_,"textures",t);case 8:return e.t2=e.sent,e.t3=[e.t1,e.t2],e.next=12,e.t0.all.call(e.t0,e.t3);case 12:return n=e.sent,s=C(n,2),i=s[0],r=s[1],i=i||globalThis.BASIS,e.next=19,N_(i,r);case 19:return e.abrupt("return",e.sent);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function N_(e,t){var i={};return t&&(i.wasmBinary=t),new Promise((function(t){e(i).then((function(e){var i=e.BasisFile,r=e.KTX2File,n=e.initializeBasis,s=e.BasisEncoder;n(),t({BasisFile:i,KTX2File:r,BasisEncoder:s})}))}))}var V_=["","WEBKIT_","MOZ_"],Q_={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"},H_=null;function G_(e){if(!H_){e=e||function(){try{return document.createElement("canvas").getContext("webgl")}catch(e){return null}}()||void 0,H_=new Set;var t,i=p(V_);try{for(i.s();!(t=i.n()).done;){var r=t.value;for(var n in Q_)if(e&&e.getExtension("".concat(r).concat(n))){var s=Q_[n];H_.add(s)}}}catch(e){i.e(e)}finally{i.f()}}return H_}var j_=[171,75,84,88,32,50,48,187,13,10,26,10];function z_(e){var t=new Uint8Array(e);return!(t.byteLength<j_.length||t[0]!==j_[0]||t[1]!==j_[1]||t[2]!==j_[2]||t[3]!==j_[3]||t[4]!==j_[4]||t[5]!==j_[5]||t[6]!==j_[6]||t[7]!==j_[7]||t[8]!==j_[8]||t[9]!==j_[9]||t[10]!==j_[10]||t[11]!==j_[11])}var W_={etc1:{basisFormat:0,compressed:!0,format:36196},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:33776},bc3:{basisFormat:3,compressed:!0,format:33779},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:35840},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:35842},"astc-4x4":{basisFormat:10,compressed:!0,format:37808},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};function X_(){return(X_=A(l().mark((function e(t,i){var r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("auto"!==i.basis.containerFormat){e.next=11;break}if(!z_(t)){e.next=6;break}return e.next=4,R_(i);case 4:return r=e.sent,e.abrupt("return",J_(r.KTX2File,t,i));case 6:return e.next=8,E_(i);case 8:return n=e.sent,s=n.BasisFile,e.abrupt("return",K_(s,t,i));case 11:e.t0=i.basis.module,e.next="encoder"===e.t0?14:(e.t0,22);break;case 14:return e.next=16,R_(i);case 16:o=e.sent,e.t1=i.basis.containerFormat,e.next="ktx2"===e.t1?20:(e.t1,21);break;case 20:return e.abrupt("return",J_(o.KTX2File,t,i));case 21:return e.abrupt("return",K_(o.BasisFile,t,i));case 22:return e.next=24,E_(i);case 24:return a=e.sent,u=a.BasisFile,e.abrupt("return",K_(u,t,i));case 27:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function K_(e,t,i){var r=new e(new Uint8Array(t));try{if(!r.startTranscoding())throw new Error("Failed to start basis transcoding");for(var n=r.getNumImages(),s=[],o=0;o<n;o++){for(var a=r.getNumLevels(o),l=[],u=0;u<a;u++)l.push(Z_(r,o,u,i));s.push(l)}return s}finally{r.close(),r.delete()}}function Z_(e,t,i,r){var n=e.getImageWidth(t,i),s=e.getImageHeight(t,i),o=e.getHasAlpha(),a=q_(r,o),l=a.compressed,u=a.format,A=a.basisFormat,c=e.getImageTranscodedSizeInBytes(t,i,A),h=new Uint8Array(c);if(!e.transcodeImage(h,t,i,A,0,0))throw new Error("failed to start Basis transcoding");return{width:n,height:s,data:h,compressed:l,format:u,hasAlpha:o}}function J_(e,t,i){var r=new e(new Uint8Array(t));try{if(!r.startTranscoding())throw new Error("failed to start KTX2 transcoding");for(var n=r.getLevels(),s=[],o=0;o<n;o++)s.push(Y_(r,o,i));return[s]}finally{r.close(),r.delete()}}function Y_(e,t,i){var r=e.getImageLevelInfo(t,0,0),n=r.alphaFlag,s=r.height,o=r.width,a=q_(i,n),l=a.compressed,u=a.format,A=a.basisFormat,c=e.getImageTranscodedSizeInBytes(t,0,0,A),h=new Uint8Array(c);if(!e.transcodeImage(h,t,0,0,A,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:o,height:s,data:h,compressed:l,levelSize:c,hasAlpha:n,format:u}}function q_(e,t){var i=e&&e.basis&&e.basis.format;return"auto"===i&&(i=$_()),"object"===P(i)&&(i=t?i.alpha:i.noAlpha),i=i.toLowerCase(),W_[i]}function $_(){var e=G_();return e.has("astc")?"astc-4x4":e.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:e.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:e.has("etc1")?"etc1":e.has("etc2")?"etc2":"rgb565"}var ey=h(h({},{dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:"4.3.3",worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}}),{},{parse:function(e,t){return X_.apply(this,arguments)}});function ty(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"".concat(String.fromCharCode(e.getUint8(t+0))).concat(String.fromCharCode(e.getUint8(t+1))).concat(String.fromCharCode(e.getUint8(t+2))).concat(String.fromCharCode(e.getUint8(t+3)))}function iy(e,t,i){jp(e.header.byteLength>20);var r=t.getUint32(i+0,true),n=t.getUint32(i+4,true);return i+=8,jp(0===n),ny(e,t,i,r),i+=r,i+=sy(e,t,i,e.header.byteLength)}function ry(e,t,i,r){return jp(e.header.byteLength>20),function(e,t,i,r){for(;i+8<=e.header.byteLength;){var n=t.getUint32(i+0,true),s=t.getUint32(i+4,true);switch(i+=8,s){case 1313821514:ny(e,t,i,n);break;case 5130562:sy(e,t,i,n);break;case 0:r.strict||ny(e,t,i,n);break;case 1:r.strict||sy(e,t,i,n)}i+=av(n,4)}}(e,t,i,r),i+e.header.byteLength}function ny(e,t,i,r){var n=new Uint8Array(t.buffer,i,r),s=new TextDecoder("utf8").decode(n);return e.json=JSON.parse(s),av(r,4)}function sy(e,t,i,r){return e.header.hasBinChunk=!0,e.binChunks.push({byteOffset:i,byteLength:r,arrayBuffer:t.buffer}),av(r,4)}function oy(e,t){if(e.startsWith("data:")||e.startsWith("http:")||e.startsWith("https:"))return e;var i=t.baseUri||t.uri;if(!i)throw new Error("'baseUri' must be provided to resolve relative url ".concat(e));return i.substr(0,i.lastIndexOf("/")+1)+e}var ay,ly="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",uy="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",Ay=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),cy=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),hy={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},dy={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};function py(e,t,i,r,n){return fy.apply(this,arguments)}function fy(){return fy=A(l().mark((function e(t,i,r,n,s){var o,a,u=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=u.length>5&&void 0!==u[5]?u[5]:"NONE",e.next=3,vy();case 3:by(a=e.sent,a.exports[dy[s]],t,i,r,n,a.exports[hy[o||"NONE"]]);case 5:case"end":return e.stop()}}),e)}))),fy.apply(this,arguments)}function vy(){return gy.apply(this,arguments)}function gy(){return(gy=A(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ay||(ay=my()),e.abrupt("return",ay);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function my(){return _y.apply(this,arguments)}function _y(){return(_y=A(l().mark((function e(){var t,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=ly,WebAssembly.validate(Ay)&&(t=uy,console.log("Warning: meshopt_decoder is using experimental SIMD support")),e.next=4,WebAssembly.instantiate(yy(t),{});case 4:return i=e.sent,e.next=7,i.instance.exports.__wasm_call_ctors();case 7:return e.abrupt("return",i.instance);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yy(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;++i){var r=e.charCodeAt(i);t[i]=r>96?r-71:r>64?r-65:r>47?r+4:r>46?63:62}for(var n=0,s=0;s<e.length;++s)t[n++]=t[s]<60?cy[t[s]]:64*(t[s]-60)+t[++s];return t.buffer.slice(0,n)}function by(e,t,i,r,n,s,o){var a=e.exports.sbrk,l=r+3&-4,u=a(l*n),A=a(s.length),c=new Uint8Array(e.exports.memory.buffer);c.set(s,A);var h=t(u,r,n,A,s.length);if(0===h&&o&&o(u,l,n),i.set(c.subarray(u,u+r*n)),a(u-a(0)),0!==h)throw new Error("Malformed buffer data: ".concat(h))}function wy(){return(wy=A(l().mark((function e(t,i){var r,n,s,o,a,u,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=new Tm(t),null!=i&&null!==(r=i.gltf)&&void 0!==r&&r.decompressMeshes&&null!==(n=i.gltf)&&void 0!==n&&n.loadBuffers){e.next=3;break}return e.abrupt("return");case 3:o=[],a=p(t.json.bufferViews||[]);try{for(a.s();!(u=a.n()).done;)A=u.value,o.push(By(s,A))}catch(e){a.e(e)}finally{a.f()}return e.next=8,Promise.all(o);case 8:s.removeExtension("EXT_meshopt_compression");case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function By(e,t){return xy.apply(this,arguments)}function xy(){return(xy=A(l().mark((function e(t,i){var r,n,s,o,a,u,A,c,h,d,p,f,v,g;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t.getObjectExtension(i,"EXT_meshopt_compression"))){e.next=9;break}return n=r.byteOffset,s=void 0===n?0:n,o=r.byteLength,a=void 0===o?0:o,u=r.byteStride,A=r.count,c=r.mode,h=r.filter,d=void 0===h?"NONE":h,p=r.buffer,f=t.gltf.buffers[p],v=new Uint8Array(f.arrayBuffer,f.byteOffset+s,a),g=new Uint8Array(t.gltf.buffers[i.buffer].arrayBuffer,i.byteOffset,i.byteLength),e.next=8,py(g,A,u,v,c,d);case 8:t.removeObjectExtension(i,"EXT_meshopt_compression");case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Py=Object.freeze({__proto__:null,name:"EXT_meshopt_compression",decode:function(e,t){return wy.apply(this,arguments)}});var Cy=Object.freeze({__proto__:null,name:"EXT_texture_webp",preprocess:function(e,t){var i=new Tm(e);if(mm("image/webp")){var r,n=p(i.json.textures||[]);try{for(n.s();!(r=n.n()).done;){var s=r.value,o=i.getObjectExtension(s,"EXT_texture_webp");o&&(s.source=o.source),i.removeObjectExtension(s,"EXT_texture_webp")}}catch(e){n.e(e)}finally{n.f()}i.removeExtension("EXT_texture_webp")}else if(i.getRequiredExtensions().includes("EXT_texture_webp"))throw new Error("gltf: Required extension ".concat("EXT_texture_webp"," not supported by browser"))}});var My=Object.freeze({__proto__:null,name:"KHR_texture_basisu",preprocess:function(e,t){var i,r=new Tm(e),n=p(r.json.textures||[]);try{for(n.s();!(i=n.n()).done;){var s=i.value,o=r.getObjectExtension(s,"KHR_texture_basisu");o&&(s.source=o.source,r.removeObjectExtension(s,"KHR_texture_basisu"))}}catch(e){n.e(e)}finally{n.f()}r.removeExtension("KHR_texture_basisu")}}),Fy={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:"4.3.3",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"===("undefined"==typeof WebAssembly?"undefined":P(WebAssembly))?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function ky(e,t,i){var r=Iy(t.metadata),n=[],s=function(e){var t={};for(var i in e){var r=e[i];t[r.name||"undefined"]=r}return t}(t.attributes);for(var o in e){var a=Ey(o,e[o],s[o]);n.push(a)}if(i){var l=Ey("indices",i);n.push(l)}return{fields:n,metadata:r}}function Ey(e,t,i){return Lg(e,t,i?Iy(i.metadata):void 0)}function Iy(e){var t={};for(var i in e)t["".concat(i,".string")]=JSON.stringify(e[i]);return t}var Ty={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},Dy={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},Sy=function(){function e(t){k(this,e),d(this,"draco",void 0),d(this,"decoder",void 0),d(this,"metadataQuerier",void 0),this.draco=t,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}return I(e,[{key:"destroy",value:function(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}},{key:"parseSync",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=new this.draco.DecoderBuffer;i.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);var r=this.decoder.GetEncodedGeometryType(i),n=r===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{var s;switch(r){case this.draco.TRIANGULAR_MESH:s=this.decoder.DecodeBufferToMesh(i,n);break;case this.draco.POINT_CLOUD:s=this.decoder.DecodeBufferToPointCloud(i,n);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!s.ok()||!n.ptr){var o="DRACO decompression failed: ".concat(s.error_msg());throw new Error(o)}var a=this._getDracoLoaderData(n,r,t),l=this._getMeshData(n,a,t),u=Ug(l.attributes),A=ky(l.attributes,a,l.indices),c=h(h({loader:"draco",loaderData:a,header:{vertexCount:n.num_points(),boundingBox:u}},l),{},{schema:A});return c}finally{this.draco.destroy(i),n&&this.draco.destroy(n)}}},{key:"_getDracoLoaderData",value:function(e,t,i){var r=this._getTopLevelMetadata(e),n=this._getDracoAttributes(e,i);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:r,attributes:n}}},{key:"_getDracoAttributes",value:function(e,t){for(var i={},r=0;r<e.num_attributes();r++){var n=this.decoder.GetAttribute(e,r),s=this._getAttributeMetadata(e,r);i[n.unique_id()]={unique_id:n.unique_id(),attribute_type:n.attribute_type(),data_type:n.data_type(),num_components:n.num_components(),byte_offset:n.byte_offset(),byte_stride:n.byte_stride(),normalized:n.normalized(),attribute_index:r,metadata:s};var o=this._getQuantizationTransform(n,t);o&&(i[n.unique_id()].quantization_transform=o);var a=this._getOctahedronTransform(n,t);a&&(i[n.unique_id()].octahedron_transform=a)}return i}},{key:"_getMeshData",value:function(e,t,i){var r=this._getMeshAttributes(t,e,i);if(!r.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?"triangle-strip"===i.topology?{topology:"triangle-strip",mode:4,attributes:r,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:r,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:r}}},{key:"_getMeshAttributes",value:function(e,t,i){for(var r={},n=0,s=Object.values(e.attributes);n<s.length;n++){var o=s[n],a=this._deduceAttributeName(o,i);o.name=a;var l=this._getAttributeValues(t,o);if(l){var u=l.value,A=l.size;r[a]={value:u,size:A,byteOffset:o.byte_offset,byteStride:o.byte_stride,normalized:o.normalized}}}return r}},{key:"_getTriangleListIndices",value:function(e){var t=3*e.num_faces(),i=4*t,r=this.draco._malloc(i);try{return this.decoder.GetTrianglesUInt32Array(e,i,r),new Uint32Array(this.draco.HEAPF32.buffer,r,t).slice()}finally{this.draco._free(r)}}},{key:"_getTriangleStripIndices",value:function(e){var t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(e){for(var t=e.size(),i=new Int32Array(t),r=0;r<t;r++)i[r]=e.GetValue(r);return i}(t)}finally{this.draco.destroy(t)}}},{key:"_getAttributeValues",value:function(e,t){var i=Dy[t.data_type];if(!i)return console.warn("DRACO: Unsupported attribute type ".concat(t.data_type)),null;var r,n=t.num_components,s=e.num_points()*n,o=s*i.BYTES_PER_ELEMENT,a=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32;default:return e.DT_INVALID}}(this.draco,i),l=this.draco._malloc(o);try{var u=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,u,a,o,l),r=new i(this.draco.HEAPF32.buffer,l,s).slice()}finally{this.draco._free(l)}return{value:r,size:n}}},{key:"_deduceAttributeName",value:function(e,t){for(var i=e.unique_id,r=0,n=Object.entries(t.extraAttributes||{});r<n.length;r++){var s=C(n[r],2),o=s[0];if(s[1]===i)return o}var a=e.attribute_type;for(var l in Ty){if(this.draco[l]===a)return Ty[l]}var u=t.attributeNameEntry||"name";return e.metadata[u]?e.metadata[u].string:"CUSTOM_ATTRIBUTE_".concat(i)}},{key:"_getTopLevelMetadata",value:function(e){var t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}},{key:"_getAttributeMetadata",value:function(e,t){var i=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(i)}},{key:"_getDracoMetadata",value:function(e){if(!e||!e.ptr)return{};for(var t={},i=this.metadataQuerier.NumEntries(e),r=0;r<i;r++){var n=this.metadataQuerier.GetEntryName(e,r);t[n]=this._getDracoMetadataField(e,n)}return t}},{key:"_getDracoMetadataField",value:function(e,t){var i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,i);var r=function(e){for(var t=e.size(),i=new Int32Array(t),r=0;r<t;r++)i[r]=e.GetValue(r);return i}(i);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:r}}finally{this.draco.destroy(i)}}},{key:"_disableAttributeTransforms",value:function(e){var t,i=e.quantizedAttributes,r=void 0===i?[]:i,n=e.octahedronAttributes,s=void 0===n?[]:n,o=p([].concat(f(r),f(s)));try{for(o.s();!(t=o.n()).done;){var a=t.value;this.decoder.SkipAttributeTransform(this.draco[a])}}catch(e){o.e(e)}finally{o.f()}}},{key:"_getQuantizationTransform",value:function(e,t){var i=this,r=t.quantizedAttributes,n=void 0===r?[]:r,s=e.attribute_type();if(n.map((function(e){return i.decoder[e]})).includes(s)){var o=new this.draco.AttributeQuantizationTransform;try{if(o.InitFromAttribute(e))return{quantization_bits:o.quantization_bits(),range:o.range(),min_values:new Float32Array([1,2,3]).map((function(e){return o.min_value(e)}))}}finally{this.draco.destroy(o)}}return null}},{key:"_getOctahedronTransform",value:function(e,t){var i=this,r=t.octahedronAttributes,n=void 0===r?[]:r,s=e.attribute_type();if(n.map((function(e){return i.decoder[e]})).includes(s)){var o=new this.draco.AttributeQuantizationTransform;try{if(o.InitFromAttribute(e))return{quantization_bits:o.quantization_bits()}}finally{this.draco.destroy(o)}}return null}}]),e}();var Ry,Uy="https://www.gstatic.com/draco/versioned/decoders/".concat("1.5.6"),Ly="draco_wasm_wrapper.js",Oy="draco_decoder.wasm",Ny="draco_decoder.js",Vy="draco_encoder.js",Qy=(d(t={},Ly,"".concat(Uy,"/").concat(Ly)),d(t,Oy,"".concat(Uy,"/").concat(Oy)),d(t,Ny,"".concat(Uy,"/").concat(Ny)),d(t,Vy,"https://raw.githubusercontent.com/google/draco/".concat("1.4.1","/javascript/").concat(Vy)),t);function Hy(e){return Gy.apply(this,arguments)}function Gy(){return(Gy=A(l().mark((function e(t){var i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=t.modules||{}).draco3d?Ry||(Ry=i.draco3d.createDecoderModule({}).then((function(e){return{draco:e}}))):Ry||(Ry=jy(t)),e.next=4,Ry;case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function jy(e){return zy.apply(this,arguments)}function zy(){return(zy=A(l().mark((function e(t){var i,r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.draco&&t.draco.decoderType,e.next="js"===e.t0?3:(e.t0,7);break;case 3:return e.next=5,Qf(Qy[Ny],"draco",t,Ny);case 5:return i=e.sent,e.abrupt("break",21);case 7:return e.t1=Promise,e.next=10,Qf(Qy[Ly],"draco",t,Ly);case 10:return e.t2=e.sent,e.next=13,Qf(Qy[Oy],"draco",t,Oy);case 13:return e.t3=e.sent,e.t4=[e.t2,e.t3],e.next=17,e.t1.all.call(e.t1,e.t4);case 17:n=e.sent,s=C(n,2),i=s[0],r=s[1];case 21:return i=i||globalThis.DracoDecoderModule,e.next=24,Wy(i,r);case 24:return e.abrupt("return",e.sent);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Wy(e,t){var i={};return t&&(i.wasmBinary=t),new Promise((function(t){e(h(h({},i),{},{onModuleLoaded:function(e){return t({draco:e})}}))}))}var Xy=h(h({},Fy),{},{parse:function(e,t){return Ky.apply(this,arguments)}});function Ky(){return(Ky=A(l().mark((function e(t,i){var r,n,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Hy(i);case 2:return r=e.sent,n=r.draco,s=new Sy(n),e.prev=5,e.abrupt("return",s.parseSync(t,null==i?void 0:i.draco));case 7:return e.prev=7,s.destroy(),e.finish(7);case 10:case"end":return e.stop()}}),e,null,[[5,,7,10]])})))).apply(this,arguments)}function Zy(e){var t={};for(var i in e){var r=e[i];if("indices"!==i){var n=Jy(r);t[i]=n}}return t}function Jy(e){var t=function(e){var t=e,i=1,r=0;e&&e.value&&(t=e.value,i=e.size||1);t&&(ArrayBuffer.isView(t)||(t=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)return null;if(Array.isArray(e))return new t(e);if(i&&!(e instanceof t))return new t(e);return e}(t,Float32Array)),r=t.length/i);return{buffer:t,size:i,count:r}}(e),i=t.buffer,r=t.size;return{value:i,size:r,byteOffset:0,count:t.count,type:Fm(r),componentType:km(i)}}function Yy(){return(Yy=A(l().mark((function e(t,i,r){var n,s,o,a,u,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=i&&null!==(n=i.gltf)&&void 0!==n&&n.decompressMeshes){e.next=2;break}return e.abrupt("return");case 2:s=new Tm(t),o=[],a=p(ib(s));try{for(a.s();!(u=a.n()).done;)A=u.value,s.getObjectExtension(A,"KHR_draco_mesh_compression")&&o.push(qy(s,A,i,r))}catch(e){a.e(e)}finally{a.f()}return e.next=8,Promise.all(o);case 8:s.removeExtension("KHR_draco_mesh_compression");case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function qy(e,t,i,r){return $y.apply(this,arguments)}function $y(){return($y=A(l().mark((function e(t,i,r,n){var s,o,a,u,A,c,d,p,f,v,g,m,_;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.getObjectExtension(i,"KHR_draco_mesh_compression")){e.next=3;break}return e.abrupt("return");case 3:return o=t.getTypedArrayForBufferView(s.bufferView),a=ov(o.buffer,o.byteOffset),delete(u=h({},r))["3d-tiles"],e.next=9,Hp(a,Xy,u,n);case 9:for(A=e.sent,c=Zy(A.attributes),d=0,p=Object.entries(c);d<p.length;d++)f=C(p[d],2),v=f[0],g=f[1],v in i.attributes&&(m=i.attributes[v],null!=(_=t.getAccessor(m))&&_.min&&null!=_&&_.max&&(g.min=_.min,g.max=_.max));i.attributes=c,A.indices&&(i.indices=Jy(A.indices)),t.removeObjectExtension(i,"KHR_draco_mesh_compression"),tb(i);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function eb(e,t){var i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;if(!n.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");var o=n.DracoWriter.encodeSync({attributes:e}),a=null==s||null===(i=s.parseSync)||void 0===i?void 0:i.call(s,{attributes:e}),l=n._addFauxAttributes(a.attributes),u=n.addBufferView(o),A={primitives:[{attributes:l,mode:r,extensions:d({},"KHR_draco_mesh_compression",{bufferView:u,attributes:l})}]};return A}function tb(e){if(!e.attributes&&Object.keys(e.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function ib(e){var t,i,r,n,o,a;return l().wrap((function(s){for(;;)switch(s.prev=s.next){case 0:t=p(e.json.meshes||[]),s.prev=1,t.s();case 3:if((i=t.n()).done){s.next=24;break}r=i.value,n=p(r.primitives),s.prev=6,n.s();case 8:if((o=n.n()).done){s.next=14;break}return a=o.value,s.next=12,a;case 12:s.next=8;break;case 14:s.next=19;break;case 16:s.prev=16,s.t0=s.catch(6),n.e(s.t0);case 19:return s.prev=19,n.f(),s.finish(19);case 22:s.next=3;break;case 24:s.next=29;break;case 26:s.prev=26,s.t1=s.catch(1),t.e(s.t1);case 29:return s.prev=29,t.f(),s.finish(29);case 32:case"end":return s.stop()}}),s,null,[[1,26,29,32],[6,16,19,22]])}var rb=Object.freeze({__proto__:null,name:"KHR_draco_mesh_compression",preprocess:function(e,t,i){var r,n=new Tm(e),s=p(ib(n));try{for(s.s();!(r=s.n()).done;){var o=r.value;n.getObjectExtension(o,"KHR_draco_mesh_compression")}}catch(e){s.e(e)}finally{s.f()}},decode:function(e,t,i){return Yy.apply(this,arguments)},encode:function(e){var t,i=new Tm(e),r=p(i.json.meshes||[]);try{for(r.s();!(t=r.n()).done;){var n=t.value;eb(n),i.addRequiredExtension("KHR_draco_mesh_compression")}}catch(e){r.e(e)}finally{r.f()}}});globalThis.mathgl=globalThis.mathgl||{config:h({},{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1})};var nb=globalThis.mathgl.config;function sb(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.precision,r=void 0===i?nb.precision:i;return e=lb(e),"".concat(parseFloat(e.toPrecision(r)))}function ob(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function ab(e,t,i){var r=nb.EPSILON;i&&(nb.EPSILON=i);try{if(e===t)return!0;if(ob(e)&&ob(t)){if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(!ab(e[n],t[n]))return!1;return!0}return e&&e.equals?e.equals(t):t&&t.equals?t.equals(e):"number"==typeof e&&"number"==typeof t&&Math.abs(e-t)<=nb.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{nb.EPSILON=r}}function lb(e){return Math.round(e/nb.EPSILON)*nb.EPSILON}var ub=function(e){m(i,o(Array));var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"fromArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}},{key:"toArray",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}},{key:"toObject",value:function(e){return e}},{key:"from",value:function(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}},{key:"to",value:function(e){return e===this?this:ob(e)?this.toArray(e):this.toObject(e)}},{key:"toTarget",value:function(e){return e?this.to(e):this}},{key:"toFloat32Array",value:function(){return new Float32Array(this)}},{key:"toString",value:function(){return this.formatString(nb)}},{key:"formatString",value:function(e){for(var t="",i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+sb(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}},{key:"equals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(!ab(this[t],e[t]))return!1;return!0}},{key:"exactEquals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}},{key:"negate",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}},{key:"lerp",value:function(e,t,i){if(void 0===i)return this.lerp(this,e,t);for(var r=0;r<this.ELEMENTS;++r){var n=e[r],s="number"==typeof t?t:t[r];this[r]=n+i*(s-n)}return this.check()}},{key:"min",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}},{key:"max",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}},{key:"clamp",value:function(e,t){for(var i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}},{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=0,n=t;r<n.length;r++)for(var s=n[r],o=0;o<this.ELEMENTS;++o)this[o]+=s[o];return this.check()}},{key:"subtract",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=0,n=t;r<n.length;r++)for(var s=n[r],o=0;o<this.ELEMENTS;++o)this[o]-=s[o];return this.check()}},{key:"scale",value:function(e){if("number"==typeof e)for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(var i=0;i<this.ELEMENTS&&i<e.length;++i)this[i]*=e[i];return this.check()}},{key:"multiplyByScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"check",value:function(){if(nb.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}},{key:"validate",value:function(){for(var e=this.length===this.ELEMENTS,t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}},{key:"sub",value:function(e){return this.subtract(e)}},{key:"setScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}},{key:"addScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}},{key:"subScalar",value:function(e){return this.addScalar(-e)}},{key:"multiplyScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"divideScalar",value:function(e){return this.multiplyByScalar(1/e)}},{key:"clampScalar",value:function(e,t){for(var i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}},{key:"elements",get:function(){return this}}]),i}();function Ab(e,t){if(e.length!==t)return!1;for(var i=0;i<e.length;++i)if(!Number.isFinite(e[i]))return!1;return!0}function cb(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(JSON.stringify(e)));return e}function hb(e,t){if(!e)throw new Error("math.gl assertion ".concat(t))}var db=function(e){m(i,ub);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"x",get:function(){return this[0]},set:function(e){this[0]=cb(e)}},{key:"y",get:function(){return this[1]},set:function(e){this[1]=cb(e)}},{key:"len",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"magnitude",value:function(){return this.len()}},{key:"lengthSquared",value:function(){for(var e=0,t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}},{key:"magnitudeSquared",value:function(){return this.lengthSquared()}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSquared(e))}},{key:"distanceSquared",value:function(e){for(var t=0,i=0;i<this.ELEMENTS;++i){var r=this[i]-e[i];t+=r*r}return cb(t)}},{key:"dot",value:function(e){for(var t=0,i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return cb(t)}},{key:"normalize",value:function(){var e=this.magnitude();if(0!==e)for(var t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}},{key:"multiply",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=0,n=t;r<n.length;r++)for(var s=n[r],o=0;o<this.ELEMENTS;++o)this[o]*=s[o];return this.check()}},{key:"divide",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=0,n=t;r<n.length;r++)for(var s=n[r],o=0;o<this.ELEMENTS;++o)this[o]/=s[o];return this.check()}},{key:"lengthSq",value:function(){return this.lengthSquared()}},{key:"distanceTo",value:function(e){return this.distance(e)}},{key:"distanceToSquared",value:function(e){return this.distanceSquared(e)}},{key:"getComponent",value:function(e){return hb(e>=0&&e<this.ELEMENTS,"index is out of range"),cb(this[e])}},{key:"setComponent",value:function(e,t){return hb(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}},{key:"addVectors",value:function(e,t){return this.copy(e).add(t)}},{key:"subVectors",value:function(e,t){return this.copy(e).subtract(t)}},{key:"multiplyVectors",value:function(e,t){return this.copy(e).multiply(t)}},{key:"addScaledVector",value:function(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}]),i}(),pb="undefined"!=typeof Float32Array?Float32Array:Array;function fb(e,t,i){var r=t[0],n=t[1],s=t[2];return e[0]=r*i[0]+n*i[3]+s*i[6],e[1]=r*i[1]+n*i[4]+s*i[7],e[2]=r*i[2]+n*i[5]+s*i[8],e}!function(){var e,t=(e=new pb(2),pb!=Float32Array&&(e[0]=0,e[1]=0),e)}(),function(){var e,t=(e=new pb(3),pb!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e)}();var vb,gb,mb=[0,0,0],_b=function(e){m(i,db);var t=y(i);function i(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return k(this,i),e=t.call(this,-0,-0,-0),1===arguments.length&&ob(r)?e.copy(r):(nb.debug&&(cb(r),cb(n),cb(s)),e[0]=r,e[1]=n,e[2]=s),e}return I(i,[{key:"set",value:function(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}},{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}},{key:"fromObject",value:function(e){return nb.debug&&(cb(e.x),cb(e.y),cb(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}},{key:"toObject",value:function(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}},{key:"ELEMENTS",get:function(){return 3}},{key:"z",get:function(){return this[2]},set:function(e){this[2]=cb(e)}},{key:"angle",value:function(e){return function(e,t){var i=e[0],r=e[1],n=e[2],s=t[0],o=t[1],a=t[2],l=Math.sqrt((i*i+r*r+n*n)*(s*s+o*o+a*a)),u=l&&function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(e,t)/l;return Math.acos(Math.min(Math.max(u,-1),1))}(this,e)}},{key:"cross",value:function(e){return function(e,t,i){var r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o}(this,this,e),this.check()}},{key:"rotateX",value:function(e){var t=e.radians,i=e.origin;return function(e,t,i,r){var n=[],s=[];n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[0],s[1]=n[1]*Math.cos(r)-n[2]*Math.sin(r),s[2]=n[1]*Math.sin(r)+n[2]*Math.cos(r),e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2]}(this,this,void 0===i?mb:i,t),this.check()}},{key:"rotateY",value:function(e){var t=e.radians,i=e.origin;return function(e,t,i,r){var n=[],s=[];n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[2]*Math.sin(r)+n[0]*Math.cos(r),s[1]=n[1],s[2]=n[2]*Math.cos(r)-n[0]*Math.sin(r),e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2]}(this,this,void 0===i?mb:i,t),this.check()}},{key:"rotateZ",value:function(e){var t=e.radians,i=e.origin;return function(e,t,i,r){var n=[],s=[];n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[0]*Math.cos(r)-n[1]*Math.sin(r),s[1]=n[0]*Math.sin(r)+n[1]*Math.cos(r),s[2]=n[2],e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2]}(this,this,void 0===i?mb:i,t),this.check()}},{key:"transform",value:function(e){return this.transformAsPoint(e)}},{key:"transformAsPoint",value:function(e){return function(e,t,i){var r=t[0],n=t[1],s=t[2],o=i[3]*r+i[7]*n+i[11]*s+i[15];o=o||1,e[0]=(i[0]*r+i[4]*n+i[8]*s+i[12])/o,e[1]=(i[1]*r+i[5]*n+i[9]*s+i[13])/o,e[2]=(i[2]*r+i[6]*n+i[10]*s+i[14])/o}(this,this,e),this.check()}},{key:"transformAsVector",value:function(e){return function(e,t,i){var r=t[0],n=t[1],s=t[2],o=i[3]*r+i[7]*n+i[11]*s||1;e[0]=(i[0]*r+i[4]*n+i[8]*s)/o,e[1]=(i[1]*r+i[5]*n+i[9]*s)/o,e[2]=(i[2]*r+i[6]*n+i[10]*s)/o}(this,this,e),this.check()}},{key:"transformByMatrix3",value:function(e){return fb(this,this,e),this.check()}},{key:"transformByMatrix2",value:function(e){return function(e,t,i){var r=t[0],n=t[1];e[0]=i[0]*r+i[2]*n,e[1]=i[1]*r+i[3]*n,e[2]=t[2]}(this,this,e),this.check()}},{key:"transformByQuaternion",value:function(e){return function(e,t,i){var r=i[0],n=i[1],s=i[2],o=i[3],a=t[0],l=t[1],u=t[2],A=n*u-s*l,c=s*a-r*u,h=r*l-n*a,d=n*h-s*c,p=s*A-r*h,f=r*c-n*A,v=2*o;A*=v,c*=v,h*=v,d*=2,p*=2,f*=2,e[0]=a+A+d,e[1]=l+c+p,e[2]=u+h+f}(this,this,e),this.check()}}],[{key:"ZERO",get:function(){return vb||(vb=new i(0,0,0),Object.freeze(vb)),vb}}]),i}(),yb=function(e){m(i,ub);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"toString",value:function(){var e="[";if(nb.printRowMajor){e+="row-major:";for(var t=0;t<this.RANK;++t)for(var i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(var r=0;r<this.ELEMENTS;++r)e+=" ".concat(this[r])}return e+="]"}},{key:"getElementIndex",value:function(e,t){return t*this.RANK+e}},{key:"getElement",value:function(e,t){return this[t*this.RANK+e]}},{key:"setElement",value:function(e,t,i){return this[t*this.RANK+e]=cb(i),this}},{key:"getColumn",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array(this.RANK).fill(-0),i=e*this.RANK,r=0;r<this.RANK;++r)t[r]=this[i+r];return t}},{key:"setColumn",value:function(e,t){for(var i=e*this.RANK,r=0;r<this.RANK;++r)this[i+r]=t[r];return this}}]),i}();function bb(e,t,i){var r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],u=t[6],A=t[7],c=t[8],h=i[0],d=i[1],p=i[2],f=i[3],v=i[4],g=i[5],m=i[6],_=i[7],y=i[8];return e[0]=h*r+d*o+p*u,e[1]=h*n+d*a+p*A,e[2]=h*s+d*l+p*c,e[3]=f*r+v*o+g*u,e[4]=f*n+v*a+g*A,e[5]=f*s+v*l+g*c,e[6]=m*r+_*o+y*u,e[7]=m*n+_*a+y*A,e[8]=m*s+_*l+y*c,e}function wb(e,t,i){var r=i[0],n=i[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=n*t[3],e[4]=n*t[4],e[5]=n*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}!function(e){e[e.COL0ROW0=0]="COL0ROW0",e[e.COL0ROW1=1]="COL0ROW1",e[e.COL0ROW2=2]="COL0ROW2",e[e.COL1ROW0=3]="COL1ROW0",e[e.COL1ROW1=4]="COL1ROW1",e[e.COL1ROW2=5]="COL1ROW2",e[e.COL2ROW0=6]="COL2ROW0",e[e.COL2ROW1=7]="COL2ROW1",e[e.COL2ROW2=8]="COL2ROW2"}(gb||(gb={}));var Bb,xb=Object.freeze([1,0,0,0,1,0,0,0,1]),Pb=function(e){m(i,yb);var t=y(i);function i(e){for(var r,n=arguments.length,s=new Array(n>1?n-1:0),o=1;o<n;o++)s[o-1]=arguments[o];return k(this,i),r=t.call(this,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?r.copy(e):s.length>0?r.copy([e].concat(s)):r.identity(),r}return I(i,[{key:"ELEMENTS",get:function(){return 9}},{key:"RANK",get:function(){return 3}},{key:"INDICES",get:function(){return gb}},{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}},{key:"identity",value:function(){return this.copy(xb)}},{key:"fromObject",value:function(e){return this.check()}},{key:"fromQuaternion",value:function(e){return function(e,t){var i=t[0],r=t[1],n=t[2],s=t[3],o=i+i,a=r+r,l=n+n,u=i*o,A=r*o,c=r*a,h=n*o,d=n*a,p=n*l,f=s*o,v=s*a,g=s*l;e[0]=1-c-p,e[3]=A-g,e[6]=h+v,e[1]=A+g,e[4]=1-u-p,e[7]=d-f,e[2]=h-v,e[5]=d+f,e[8]=1-u-c}(this,e),this.check()}},{key:"set",value:function(e,t,i,r,n,s,o,a,l){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this[4]=n,this[5]=s,this[6]=o,this[7]=a,this[8]=l,this.check()}},{key:"setRowMajor",value:function(e,t,i,r,n,s,o,a,l){return this[0]=e,this[1]=r,this[2]=o,this[3]=t,this[4]=n,this[5]=a,this[6]=i,this[7]=s,this[8]=l,this.check()}},{key:"determinant",value:function(){return function(e){var t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],o=e[5],a=e[6],l=e[7],u=e[8];return t*(u*s-o*l)+i*(-u*n+o*a)+r*(l*n-s*a)}(this)}},{key:"transpose",value:function(){return function(e,t){if(e===t){var i=t[1],r=t[2],n=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=n}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}},{key:"invert",value:function(){return function(e,t){var i=t[0],r=t[1],n=t[2],s=t[3],o=t[4],a=t[5],l=t[6],u=t[7],A=t[8],c=A*o-a*u,h=-A*s+a*l,d=u*s-o*l,p=i*c+r*h+n*d;p&&(p=1/p,e[0]=c*p,e[1]=(-A*r+n*u)*p,e[2]=(a*r-n*o)*p,e[3]=h*p,e[4]=(A*i-n*l)*p,e[5]=(-a*i+n*s)*p,e[6]=d*p,e[7]=(-u*i+r*l)*p,e[8]=(o*i-r*s)*p)}(this,this),this.check()}},{key:"multiplyLeft",value:function(e){return bb(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return bb(this,this,e),this.check()}},{key:"rotate",value:function(e){return function(e,t,i){var r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],u=t[6],A=t[7],c=t[8],h=Math.sin(i),d=Math.cos(i);e[0]=d*r+h*o,e[1]=d*n+h*a,e[2]=d*s+h*l,e[3]=d*o-h*r,e[4]=d*a-h*n,e[5]=d*l-h*s,e[6]=u,e[7]=A,e[8]=c}(this,this,e),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?wb(this,this,e):wb(this,this,[e,e]),this.check()}},{key:"translate",value:function(e){return function(e,t,i){var r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],u=t[6],A=t[7],c=t[8],h=i[0],d=i[1];e[0]=r,e[1]=n,e[2]=s,e[3]=o,e[4]=a,e[5]=l,e[6]=h*r+d*o+u,e[7]=h*n+d*a+A,e[8]=h*s+d*l+c}(this,this,e),this.check()}},{key:"transform",value:function(e,t){var i;switch(e.length){case 2:i=function(e,t,i){var r=t[0],n=t[1];return e[0]=i[0]*r+i[3]*n+i[6],e[1]=i[1]*r+i[4]*n+i[7],e}(t||[-0,-0],e,this);break;case 3:i=fb(t||[-0,-0,-0],e,this);break;case 4:i=function(e,t,i){var r=t[0],n=t[1],s=t[2];return e[0]=i[0]*r+i[3]*n+i[6]*s,e[1]=i[1]*r+i[4]*n+i[7]*s,e[2]=i[2]*r+i[5]*n+i[8]*s,e[3]=t[3],e}(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(nb.debug&&!Ab(e,t))throw new Error("math.gl: ".concat(i," some fields set to invalid numbers'"))}(i,e.length),i}},{key:"transformVector",value:function(e,t){return this.transform(e,t)}},{key:"transformVector2",value:function(e,t){return this.transform(e,t)}},{key:"transformVector3",value:function(e,t){return this.transform(e,t)}}],[{key:"IDENTITY",get:function(){return Fb()}},{key:"ZERO",get:function(){return Mb()}}]),i}(),Cb=null;function Mb(){return Bb||(Bb=new Pb([0,0,0,0,0,0,0,0,0]),Object.freeze(Bb)),Bb}function Fb(){return Cb||(Cb=new Pb,Object.freeze(Cb)),Cb}var kb=new _b,Eb=new Pb,Ib=new Pb;function Tb(){return(Tb=A(l().mark((function e(t,i){var r,n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new Tm(t),n.hasExtension("KHR_texture_transform")&&null!==(r=i.gltf)&&void 0!==r&&r.loadBuffers){e.next=4;break}return e.abrupt("return");case 4:for(s=t.json.materials||[],o=0;o<s.length;o++)Db(o,t);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Db(e,t){for(var i,r,n,s=null===(i=t.json.materials)||void 0===i?void 0:i[e],o=[],a=0,l=[null==s||null===(r=s.pbrMetallicRoughness)||void 0===r?void 0:r.baseColorTexture,null==s?void 0:s.emissiveTexture,null==s?void 0:s.normalTexture,null==s?void 0:s.occlusionTexture,null==s||null===(n=s.pbrMetallicRoughness)||void 0===n?void 0:n.metallicRoughnessTexture];a<l.length;a++){var u,A=l[a];A&&null!=A&&null!==(u=A.extensions)&&void 0!==u&&u.KHR_texture_transform&&Sb(t,e,A,o)}}function Sb(e,t,i,r){var n=function(e,t){var i,r=null===(i=e.extensions)||void 0===i?void 0:i.KHR_texture_transform,n=e.texCoord,s=void 0===n?0:n,o=r.texCoord,a=void 0===o?s:o;if(-1===t.findIndex((function(e){var t=C(e,2),i=t[0],r=t[1];return i===s&&r===a}))){var l=function(e){var t=e.offset,i=void 0===t?[0,0]:t,r=e.rotation,n=void 0===r?0:r,s=e.scale,o=void 0===s?[1,1]:s,a=(new Pb).set(1,0,0,0,1,0,i[0],i[1],1),l=Eb.set(Math.cos(n),Math.sin(n),0,-Math.sin(n),Math.cos(n),0,0,0,1),u=Ib.set(o[0],0,0,0,o[1],0,0,0,1);return a.multiplyRight(l).multiplyRight(u)}(r);return s!==a&&(e.texCoord=a),t.push([s,a]),{originalTexCoord:s,texCoord:a,matrix:l}}return null}(i,r);if(n){var s,o=p(e.json.meshes||[]);try{for(o.s();!(s=o.n()).done;){var a,l=p(s.value.primitives);try{for(l.s();!(a=l.n()).done;){var u=a.value,A=u.material;Number.isFinite(A)&&t===A&&Rb(e,u,n)}}catch(e){l.e(e)}finally{l.f()}}}catch(e){o.e(e)}finally{o.f()}}}function Rb(e,t,i){var r=i.originalTexCoord,n=i.texCoord,s=i.matrix,o=t.attributes["TEXCOORD_".concat(r)];if(Number.isFinite(o)){var a,l=null===(a=e.json.accessors)||void 0===a?void 0:a[o];if(l&&l.bufferView){var u,A=null===(u=e.json.bufferViews)||void 0===u?void 0:u[l.bufferView];if(A){for(var c=e.buffers[A.buffer],h=c.arrayBuffer,d=(c.byteOffset||0)+(l.byteOffset||0)+(A.byteOffset||0),p=Em(l,A),f=p.ArrayType,v=p.length,g=bm[l.componentType],m=ym[l.type],_=A.byteStride||g*m,y=new Float32Array(v),b=0;b<l.count;b++){var w=new f(h,d+b*_,2);kb.set(w[0],w[1],1),kb.transformByMatrix3(s),y.set([kb[0],kb[1]],b*m)}r===n?function(e,t,i,r){e.componentType=5126,i.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength}),t.buffer=i.length-1,t.byteLength=r.buffer.byteLength,t.byteOffset=0,delete t.byteStride}(l,A,e.buffers,y):function(e,t,i,r,n){r.buffers.push({arrayBuffer:n.buffer,byteOffset:0,byteLength:n.buffer.byteLength});var s=r.json.bufferViews;if(!s)return;s.push({buffer:r.buffers.length-1,byteLength:n.buffer.byteLength,byteOffset:0});var o=r.json.accessors;if(!o)return;o.push({bufferView:(null==s?void 0:s.length)-1,byteOffset:0,componentType:5126,count:t.count,type:"VEC2"}),i.attributes["TEXCOORD_".concat(e)]=o.length-1}(n,l,t,e,y)}}}}var Ub=Object.freeze({__proto__:null,name:"KHR_texture_transform",decode:function(e,t){return Tb.apply(this,arguments)}});function Lb(){return(Lb=A(l().mark((function e(t){var i,r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=new Tm(t),r=i.json,(n=i.getExtension("KHR_lights_punctual"))&&(i.json.lights=n.lights,i.removeExtension("KHR_lights_punctual")),s=p(r.nodes||[]);try{for(s.s();!(o=s.n()).done;)a=o.value,(u=i.getObjectExtension(a,"KHR_lights_punctual"))&&(a.light=u.light),i.removeObjectExtension(a,"KHR_lights_punctual")}catch(e){s.e(e)}finally{s.f()}case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ob(){return(Ob=A(l().mark((function e(t){var i,r,n,s,o,a,u;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=new Tm(t),(r=i.json).lights&&(_m(!(n=i.addExtension("KHR_lights_punctual")).lights),n.lights=r.lights,delete r.lights),i.json.lights){s=p(i.json.lights);try{for(s.s();!(o=s.n()).done;)a=o.value,u=a.node,i.addObjectExtension(u,"KHR_lights_punctual",a)}catch(e){s.e(e)}finally{s.f()}delete i.json.lights}case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Nb(){return(Nb=A(l().mark((function e(t){var i,r,n,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=new Tm(t),r=i.json,n=p(r.materials||[]);try{for(n.s();!(s=n.n()).done;)o=s.value,o.extensions&&o.extensions.KHR_materials_unlit&&(o.unlit=!0),i.removeObjectExtension(o,"KHR_materials_unlit")}catch(e){n.e(e)}finally{n.f()}i.removeExtension("KHR_materials_unlit");case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Vb(){return(Vb=A(l().mark((function e(t){var i,r,n,s,o,a,u,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=new Tm(t),r=i.json,n=i.getExtension("KHR_techniques_webgl")){s=Hb(n,i),o=p(r.materials||[]);try{for(o.s();!(a=o.n()).done;)u=a.value,(A=i.getObjectExtension(u,"KHR_techniques_webgl"))&&(u.technique=Object.assign({},A,s[A.technique]),u.technique.values=Gb(u.technique,i)),i.removeObjectExtension(u,"KHR_techniques_webgl")}catch(e){o.e(e)}finally{o.f()}i.removeExtension("KHR_techniques_webgl")}case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qb(){return(Qb=A(l().mark((function e(t,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Hb(e,t){var i=e.programs,r=void 0===i?[]:i,n=e.shaders,s=void 0===n?[]:n,o=e.techniques,a=void 0===o?[]:o,l=new TextDecoder;return s.forEach((function(e){if(!Number.isFinite(e.bufferView))throw new Error("KHR_techniques_webgl: no shader code");e.code=l.decode(t.getTypedArrayForBufferView(e.bufferView))})),r.forEach((function(e){e.fragmentShader=s[e.fragmentShader],e.vertexShader=s[e.vertexShader]})),a.forEach((function(e){e.program=r[e.program]})),a}function Gb(e,t){var i=Object.assign({},e.values);return Object.keys(e.uniforms||{}).forEach((function(t){e.uniforms[t].value&&!(t in i)&&(i[t]=e.uniforms[t].value)})),Object.keys(i).forEach((function(e){"object"===P(i[e])&&void 0!==i[e].index&&(i[e].texture=t.getTexture(i[e].index))})),i}var jb=[d_,Ym,Py,Cy,My,rb,Object.freeze({__proto__:null,name:"KHR_lights_punctual",decode:function(e){return Lb.apply(this,arguments)},encode:function(e){return Ob.apply(this,arguments)}}),Object.freeze({__proto__:null,name:"KHR_materials_unlit",decode:function(e){return Nb.apply(this,arguments)},encode:function(e){var t=new Tm(e),i=t.json;if(t.materials){var r,n=p(i.materials||[]);try{for(n.s();!(r=n.n()).done;){var s=r.value;s.unlit&&(delete s.unlit,t.addObjectExtension(s,"KHR_materials_unlit",{}),t.addExtension("KHR_materials_unlit"))}}catch(e){n.e(e)}finally{n.f()}}}}),Object.freeze({__proto__:null,name:"KHR_techniques_webgl",decode:function(e){return Vb.apply(this,arguments)},encode:function(e,t){return Qb.apply(this,arguments)}}),Ub,P_];function zb(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,n=jb.filter((function(e){return Kb(e.name,i)})),s=p(n);try{for(s.s();!(t=s.n()).done;){var o,a=t.value;null===(o=a.preprocess)||void 0===o||o.call(a,e,i,r)}}catch(e){s.e(e)}finally{s.f()}}function Wb(e){return Xb.apply(this,arguments)}function Xb(){return Xb=A(l().mark((function e(t){var i,r,n,s,o,a,u,A=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=A.length>1&&void 0!==A[1]?A[1]:{},r=A.length>2?A[2]:void 0,n=jb.filter((function(e){return Kb(e.name,i)})),s=p(n),e.prev=4,s.s();case 6:if((o=s.n()).done){e.next=12;break}return u=o.value,e.next=10,null===(a=u.decode)||void 0===a?void 0:a.call(u,t,i,r);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),s.e(e.t0);case 17:return e.prev=17,s.f(),e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[4,14,17,20]])}))),Xb.apply(this,arguments)}function Kb(e,t){var i,r=(null==t||null===(i=t.gltf)||void 0===i?void 0:i.excludeExtensions)||{};return!(e in r&&!r[e])}var Zb={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},Jb={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"},Yb=function(){function e(){k(this,e),d(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}),d(this,"json",void 0)}return I(e,[{key:"normalize",value:function(e,t){this.json=e.json;var i=e.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn("glTF: Unknown version ".concat(i.asset.version))}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(i),this._convertTopLevelObjectsToArrays(i),function(e){var t,i=new Tm(e),r=i.json,n=p(r.images||[]);try{for(n.s();!(t=n.n()).done;){var s=t.value,o=i.getObjectExtension(s,"KHR_binary_glTF");o&&Object.assign(s,o),i.removeObjectExtension(s,"KHR_binary_glTF")}}catch(e){n.e(e)}finally{n.f()}r.buffers&&r.buffers[0]&&delete r.buffers[0].uri,i.removeExtension("KHR_binary_glTF")}(e),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}},{key:"_addAsset",value:function(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}},{key:"_convertTopLevelObjectsToArrays",value:function(e){for(var t in Zb)this._convertTopLevelObjectToArray(e,t)}},{key:"_convertTopLevelObjectToArray",value:function(e,t){var i=e[t];if(i&&!Array.isArray(i))for(var r in e[t]=[],i){var n=i[r];n.id=n.id||r;var s=e[t].length;e[t].push(n),this.idToIndexMap[t][r]=s}}},{key:"_convertObjectIdsToArrayIndices",value:function(e){for(var t in Zb)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));var i,r=p(e.textures);try{for(r.s();!(i=r.n()).done;){var n=i.value;this._convertTextureIds(n)}}catch(e){r.e(e)}finally{r.f()}var s,o=p(e.meshes);try{for(o.s();!(s=o.n()).done;){var a=s.value;this._convertMeshIds(a)}}catch(e){o.e(e)}finally{o.f()}var l,u=p(e.nodes);try{for(u.s();!(l=u.n()).done;){var A=l.value;this._convertNodeIds(A)}}catch(e){u.e(e)}finally{u.f()}var c,h=p(e.scenes);try{for(h.s();!(c=h.n()).done;){var d=c.value;this._convertSceneIds(d)}}catch(e){h.e(e)}finally{h.f()}}},{key:"_convertTextureIds",value:function(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}},{key:"_convertMeshIds",value:function(e){var t,i=p(e.primitives);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.attributes,s=r.indices,o=r.material;for(var a in n)n[a]=this._convertIdToIndex(n[a],"accessor");s&&(r.indices=this._convertIdToIndex(s,"accessor")),o&&(r.material=this._convertIdToIndex(o,"material"))}}catch(e){i.e(e)}finally{i.f()}}},{key:"_convertNodeIds",value:function(e){var t=this;e.children&&(e.children=e.children.map((function(e){return t._convertIdToIndex(e,"node")}))),e.meshes&&(e.meshes=e.meshes.map((function(e){return t._convertIdToIndex(e,"mesh")})))}},{key:"_convertSceneIds",value:function(e){var t=this;e.nodes&&(e.nodes=e.nodes.map((function(e){return t._convertIdToIndex(e,"node")})))}},{key:"_convertIdsToIndices",value:function(e,t){e[t]||(console.warn("gltf v1: json doesn't contain attribute ".concat(t)),e[t]=[]);var i,r=p(e[t]);try{for(r.s();!(i=r.n()).done;){var n=i.value;for(var s in n){var o=n[s],a=this._convertIdToIndex(o,s);n[s]=a}}}catch(e){r.e(e)}finally{r.f()}}},{key:"_convertIdToIndex",value:function(e,t){var i=Jb[t];if(i in this.idToIndexMap){var r=this.idToIndexMap[i][e];if(!Number.isFinite(r))throw new Error("gltf v1: failed to resolve ".concat(t," with id ").concat(e));return r}return e}},{key:"_updateObjects",value:function(e){var t,i=p(this.json.buffers);try{for(i.s();!(t=i.n()).done;){delete t.value.type}}catch(e){i.e(e)}finally{i.f()}}},{key:"_updateMaterial",value:function(e){var t,i=p(e.materials);try{var r=function(){var i,r,n,s=t.value;s.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};var o=(null===(i=s.values)||void 0===i?void 0:i.tex)||(null===(r=s.values)||void 0===r?void 0:r.texture2d_0)||(null===(n=s.values)||void 0===n?void 0:n.diffuseTex),a=e.textures.findIndex((function(e){return e.id===o}));-1!==a&&(s.pbrMetallicRoughness.baseColorTexture={index:a})};for(i.s();!(t=i.n()).done;)r()}catch(e){i.e(e)}finally{i.f()}}}]),e}();function qb(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(new Yb).normalize(e,t)}function $b(e,t){return ew.apply(this,arguments)}function ew(){return ew=A(l().mark((function e(t,i){var r,n,s,o,a,u,A=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=A.length>2&&void 0!==A[2]?A[2]:0,a=A.length>3?A[3]:void 0,u=A.length>4?A[4]:void 0,tw(t,i,o,a),qb(t,{normalize:null==a||null===(r=a.gltf)||void 0===r?void 0:r.normalize}),zb(t,a,u),null==a||null===(n=a.gltf)||void 0===n||!n.loadBuffers||!t.json.buffers){e.next=9;break}return e.next=9,iw(t,a,u);case 9:if(null==a||null===(s=a.gltf)||void 0===s||!s.loadImages){e.next=12;break}return e.next=12,nw(t,a,u);case 12:return e.next=14,Wb(t,a,u);case 14:return e.abrupt("return",t);case 15:case"end":return e.stop()}}),e)}))),ew.apply(this,arguments)}function tw(e,t,i,r){(r.uri&&(e.baseUri=r.uri),t instanceof ArrayBuffer&&!function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new DataView(e),n=i.magic,s=void 0===n?1735152710:n,o=r.getUint32(t,!1);return o===s||1735152710===o}(t,i,r))&&(t=(new TextDecoder).decode(t));if("string"==typeof t)e.json=rv(t);else if(t instanceof ArrayBuffer){var n={};i=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new DataView(t),n=ty(r,i+0),s=r.getUint32(i+4,!0),o=r.getUint32(i+8,!0);switch(Object.assign(e,{header:{byteOffset:i,byteLength:o,hasBinChunk:!1},type:n,version:s,json:{},binChunks:[]}),i+=12,e.version){case 1:return iy(e,r,i);case 2:return ry(e,r,i,{});default:throw new Error("Invalid GLB version ".concat(e.version,". Only supports version 1 and 2."))}}(n,t,i,r.glb),_m("glTF"===n.type,"Invalid GLB magic string ".concat(n.type)),e._glb=n,e.json=n.json}else _m(!1,"GLTF: must be ArrayBuffer or string");var s=e.json.buffers||[];if(e.buffers=new Array(s.length).fill(null),e._glb&&e._glb.header.hasBinChunk){var o=e._glb.binChunks;e.buffers[0]={arrayBuffer:o[0].arrayBuffer,byteOffset:o[0].byteOffset,byteLength:o[0].byteLength}}var a=e.json.images||[];e.images=new Array(a.length).fill({})}function iw(e,t,i){return rw.apply(this,arguments)}function rw(){return(rw=A(l().mark((function e(t,i,r){var n,s,o,a,u,A,c,h;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.json.buffers||[],s=0;case 2:if(!(s<n.length)){e.next=22;break}if(!(o=n[s]).uri){e.next=18;break}return _m(r.fetch),A=oy(o.uri,i),e.next=10,null==r||null===(a=r.fetch)||void 0===a?void 0:a.call(r,A);case 10:return c=e.sent,e.next=13,null==c||null===(u=c.arrayBuffer)||void 0===u?void 0:u.call(c);case 13:h=e.sent,t.buffers[s]={arrayBuffer:h,byteOffset:0,byteLength:h.byteLength},delete o.uri,e.next=19;break;case 18:null===t.buffers[s]&&(t.buffers[s]={arrayBuffer:new ArrayBuffer(o.byteLength),byteOffset:0,byteLength:o.byteLength});case 19:++s,e.next=2;break;case 22:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function nw(e,t,i){return sw.apply(this,arguments)}function sw(){return(sw=A(l().mark((function e(t,i,r){var n,s,o,a,u,A;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ow(t),s=t.json.images||[],o=[],a=p(n);try{for(a.s();!(u=a.n()).done;)A=u.value,o.push(aw(t,s[A],A,i,r))}catch(e){a.e(e)}finally{a.f()}return e.next=7,Promise.all(o);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ow(e){var t,i=new Set,r=p(e.json.textures||[]);try{for(r.s();!(t=r.n()).done;){var n=t.value;void 0!==n.source&&i.add(n.source)}}catch(e){r.e(e)}finally{r.f()}return Array.from(i).sort()}function aw(e,t,i,r,n){return lw.apply(this,arguments)}function lw(){return(lw=A(l().mark((function e(t,i,r,n,s){var o,a,u,A,c,d;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.uri||i.hasOwnProperty("bufferView")){e.next=10;break}return a=oy(i.uri,n),u=s.fetch,e.next=5,u(a);case 5:return A=e.sent,e.next=8,A.arrayBuffer();case 8:o=e.sent,i.bufferView={data:o};case 10:return Number.isFinite(i.bufferView)&&(c=Im(t.json,t.buffers,i.bufferView),o=ov(c.buffer,c.byteOffset,c.byteLength)),_m(o,"glTF image has no data"),e.next=14,Hp(o,[vm,ey],h(h({},n),{},{mimeType:i.mimeType,basis:n.basis||{format:$_()}}),s);case 14:(d=e.sent)&&d[0]&&(d={compressed:!0,mipmaps:!1,width:d[0].width,height:d[0].height,data:d[0]}),t.images=t.images||[],t.images[r]=d;case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var uw={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:"4.3.3",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:function(e){return Aw.apply(this,arguments)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}};function Aw(){return Aw=A(l().mark((function e(t){var i,r,n,s,o,a=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=a.length>1&&void 0!==a[1]?a[1]:{},r=a.length>2?a[2]:void 0,(i=h(h({},uw.options),i)).gltf=h(h({},uw.options.gltf),i.gltf),n=i.byteOffset,s=void 0===n?0:n,o={},e.next=8,$b(o,t,s,i,r);case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)}))),Aw.apply(this,arguments)}var cw={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},hw={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},dw=10240,pw=10241,fw=10242,vw=10243,gw=10497,mw=9986,_w={magFilter:dw,minFilter:pw,wrapS:fw,wrapT:vw},yw=(d(i={},dw,9729),d(i,pw,mw),d(i,fw,gw),d(i,vw,gw),i);var bw=function(){function e(){k(this,e),d(this,"baseUri",""),d(this,"jsonUnprocessed",void 0),d(this,"json",void 0),d(this,"buffers",[]),d(this,"images",[])}return I(e,[{key:"postProcess",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e.json,r=e.buffers,n=void 0===r?[]:r,s=e.images,o=void 0===s?[]:s,a=e.baseUri,l=void 0===a?"":a;return _m(i),this.baseUri=l,this.buffers=n,this.images=o,this.jsonUnprocessed=i,this.json=this._resolveTree(e.json,t),this.json}},{key:"_resolveTree",value:function(e){var t=this,i=h({},e);return this.json=i,e.bufferViews&&(i.bufferViews=e.bufferViews.map((function(e,i){return t._resolveBufferView(e,i)}))),e.images&&(i.images=e.images.map((function(e,i){return t._resolveImage(e,i)}))),e.samplers&&(i.samplers=e.samplers.map((function(e,i){return t._resolveSampler(e,i)}))),e.textures&&(i.textures=e.textures.map((function(e,i){return t._resolveTexture(e,i)}))),e.accessors&&(i.accessors=e.accessors.map((function(e,i){return t._resolveAccessor(e,i)}))),e.materials&&(i.materials=e.materials.map((function(e,i){return t._resolveMaterial(e,i)}))),e.meshes&&(i.meshes=e.meshes.map((function(e,i){return t._resolveMesh(e,i)}))),e.nodes&&(i.nodes=e.nodes.map((function(e,i){return t._resolveNode(e,i)})),i.nodes=i.nodes.map((function(e,i){return t._resolveNodeChildren(e)}))),e.skins&&(i.skins=e.skins.map((function(e,i){return t._resolveSkin(e,i)}))),e.scenes&&(i.scenes=e.scenes.map((function(e,i){return t._resolveScene(e,i)}))),"number"==typeof this.json.scene&&i.scenes&&(i.scene=i.scenes[this.json.scene]),i}},{key:"getScene",value:function(e){return this._get(this.json.scenes,e)}},{key:"getNode",value:function(e){return this._get(this.json.nodes,e)}},{key:"getSkin",value:function(e){return this._get(this.json.skins,e)}},{key:"getMesh",value:function(e){return this._get(this.json.meshes,e)}},{key:"getMaterial",value:function(e){return this._get(this.json.materials,e)}},{key:"getAccessor",value:function(e){return this._get(this.json.accessors,e)}},{key:"getCamera",value:function(e){return this._get(this.json.cameras,e)}},{key:"getTexture",value:function(e){return this._get(this.json.textures,e)}},{key:"getSampler",value:function(e){return this._get(this.json.samplers,e)}},{key:"getImage",value:function(e){return this._get(this.json.images,e)}},{key:"getBufferView",value:function(e){return this._get(this.json.bufferViews,e)}},{key:"getBuffer",value:function(e){return this._get(this.json.buffers,e)}},{key:"_get",value:function(e,t){if("object"===P(t))return t;var i=e&&e[t];return i||console.warn("glTF file error: Could not find ".concat(e,"[").concat(t,"]")),i}},{key:"_resolveScene",value:function(e,t){var i=this;return h(h({},e),{},{id:e.id||"scene-".concat(t),nodes:(e.nodes||[]).map((function(e){return i.getNode(e)}))})}},{key:"_resolveNode",value:function(e,t){var i=this,r=h(h({},e),{},{id:(null==e?void 0:e.id)||"node-".concat(t)});return void 0!==e.mesh&&(r.mesh=this.getMesh(e.mesh)),void 0!==e.camera&&(r.camera=this.getCamera(e.camera)),void 0!==e.skin&&(r.skin=this.getSkin(e.skin)),void 0!==e.meshes&&e.meshes.length&&(r.mesh=e.meshes.reduce((function(e,t){var r=i.getMesh(t);return e.id=r.id,e.primitives=e.primitives.concat(r.primitives),e}),{primitives:[]})),r}},{key:"_resolveNodeChildren",value:function(e){var t=this;return e.children&&(e.children=e.children.map((function(e){return t.getNode(e)}))),e}},{key:"_resolveSkin",value:function(e,t){var i="number"==typeof e.inverseBindMatrices?this.getAccessor(e.inverseBindMatrices):void 0;return h(h({},e),{},{id:e.id||"skin-".concat(t),inverseBindMatrices:i})}},{key:"_resolveMesh",value:function(e,t){var i=this,r=h(h({},e),{},{id:e.id||"mesh-".concat(t),primitives:[]});return e.primitives&&(r.primitives=e.primitives.map((function(e){var t=h(h({},e),{},{attributes:{},indices:void 0,material:void 0}),r=e.attributes;for(var n in r)t.attributes[n]=i.getAccessor(r[n]);return void 0!==e.indices&&(t.indices=i.getAccessor(e.indices)),void 0!==e.material&&(t.material=i.getMaterial(e.material)),t}))),r}},{key:"_resolveMaterial",value:function(e,t){var i=h(h({},e),{},{id:e.id||"material-".concat(t)});if(i.normalTexture&&(i.normalTexture=h({},i.normalTexture),i.normalTexture.texture=this.getTexture(i.normalTexture.index)),i.occlusionTexture&&(i.occlusionTexture=h({},i.occlusionTexture),i.occlusionTexture.texture=this.getTexture(i.occlusionTexture.index)),i.emissiveTexture&&(i.emissiveTexture=h({},i.emissiveTexture),i.emissiveTexture.texture=this.getTexture(i.emissiveTexture.index)),i.emissiveFactor||(i.emissiveFactor=i.emissiveTexture?[1,1,1]:[0,0,0]),i.pbrMetallicRoughness){i.pbrMetallicRoughness=h({},i.pbrMetallicRoughness);var r=i.pbrMetallicRoughness;r.baseColorTexture&&(r.baseColorTexture=h({},r.baseColorTexture),r.baseColorTexture.texture=this.getTexture(r.baseColorTexture.index)),r.metallicRoughnessTexture&&(r.metallicRoughnessTexture=h({},r.metallicRoughnessTexture),r.metallicRoughnessTexture.texture=this.getTexture(r.metallicRoughnessTexture.index))}return i}},{key:"_resolveAccessor",value:function(e,t){var i,r,n=(i=e.componentType,hw[i]),s=(r=e.type,cw[r]),o=n*s,a=h(h({},e),{},{id:e.id||"accessor-".concat(t),bytesPerComponent:n,components:s,bytesPerElement:o,value:void 0,bufferView:void 0,sparse:void 0});if(void 0!==e.bufferView&&(a.bufferView=this.getBufferView(e.bufferView)),a.bufferView){var l=a.bufferView.buffer,u=Em(a,a.bufferView),A=u.ArrayType,c=u.byteLength,d=(a.bufferView.byteOffset||0)+(a.byteOffset||0)+l.byteOffset,p=l.arrayBuffer.slice(d,d+c);a.bufferView.byteStride&&(p=this._getValueFromInterleavedBuffer(l,d,a.bufferView.byteStride,a.bytesPerElement,a.count)),a.value=new A(p)}return a}},{key:"_getValueFromInterleavedBuffer",value:function(e,t,i,r,n){for(var s=new Uint8Array(n*r),o=0;o<n;o++){var a=t+o*i;s.set(new Uint8Array(e.arrayBuffer.slice(a,a+r)),o*r)}return s.buffer}},{key:"_resolveTexture",value:function(e,t){return h(h({},e),{},{id:e.id||"texture-".concat(t),sampler:"number"==typeof e.sampler?this.getSampler(e.sampler):{id:"default-sampler",parameters:yw},source:"number"==typeof e.source?this.getImage(e.source):void 0})}},{key:"_resolveSampler",value:function(e,t){var i=h(h({id:e.id||"sampler-".concat(t)},e),{},{parameters:{}});for(var r in i){var n=this._enumSamplerParameter(r);void 0!==n&&(i.parameters[n]=i[r])}return i}},{key:"_enumSamplerParameter",value:function(e){return _w[e]}},{key:"_resolveImage",value:function(e,t){var i=h(h({},e),{},{id:e.id||"image-".concat(t),image:null,bufferView:void 0!==e.bufferView?this.getBufferView(e.bufferView):void 0}),r=this.images[t];return r&&(i.image=r),i}},{key:"_resolveBufferView",value:function(e,t){var i=e.buffer,r=this.buffers[i].arrayBuffer,n=this.buffers[i].byteOffset||0;return e.byteOffset&&(n+=e.byteOffset),h(h({id:"bufferView-".concat(t)},e),{},{buffer:this.buffers[i],data:new Uint8Array(r,n,e.byteLength)})}},{key:"_resolveCamera",value:function(e,t){return h(h({},e),{},{id:e.id||"camera-".concat(t)})}}]),e}();var ww={dataType:null,batchType:null,name:"LAS",id:"las",module:"las",version:"4.3.3",worker:!0,extensions:["las","laz"],mimeTypes:["application/octet-stream"],text:!0,binary:!0,tests:["LAS"],options:{las:{shape:"mesh",fp64:!1,skip:1,colorDepth:8}}};function Bw(){var e,t=void 0!==t?t:{},i={};for(e in t)t.hasOwnProperty(e)&&(i[e]=t[e]);var r,n,s,o;r="object"===("undefined"==typeof window?"undefined":P(window)),n="function"==typeof importScripts,s="object"===("undefined"==typeof process?"undefined":P(process))&&"object"===P(process.versions)&&"string"==typeof process.versions.node,o=!r&&!s&&!n;var a,l,u,A,c,h="";if(s){if(n)h=require("path").dirname(h)+"/";else{var d="undefined"!=typeof __dirname?__dirname:"";h=d+"/"}a=function(e,t){var i=dt(e);return i?t?i:i.toString():(A||(A=require("fs")),c||(c=require("path")),e=c.normalize(e),A.readFileSync(e,t?null:"utf8"))},u=function(e){var t=a(e,!0);return t.buffer||(t=new Uint8Array(t)),m(t.buffer),t},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),"undefined"!=typeof module&&(module.exports=t),process.on("uncaughtException",(function(e){if(!(e instanceof Ft))throw e})),process.on("unhandledRejection",X),t.inspect=function(){return"[Emscripten Module object]"}}else o?("undefined"!=typeof read&&(a=function(e){var t=dt(e);return t?ct(t):read(e)}),u=function(e){var t;return(t=dt(e))?t:"function"==typeof readbuffer?new Uint8Array(readbuffer(e)):(m("object"===P(t=read(e,"binary"))),t)},"undefined"!=typeof scriptArgs&&scriptArgs,"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)):(r||n)&&(n?h=self.location.href:document.currentScript&&(h=document.currentScript.src),h=0!==h.indexOf("blob:")?h.substr(0,h.lastIndexOf("/")+1):"",a=function(e){try{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText}catch(t){var i=dt(e);if(i)return ct(i);throw t}},n&&(u=function(e){try{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}catch(t){var i=dt(e);if(i)return i;throw t}}),l=function(e,t,i){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){if(200==r.status||0==r.status&&r.response)t(r.response);else{var n=dt(e);n?t(n.buffer):i()}},r.onerror=i,r.send(null)});var p=t.print||console.log.bind(console),f=t.printErr||console.warn.bind(console);for(e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);i=null,t.arguments,t.thisProgram,t.quit,new Array(0);var v=0;t.wasmBinary,t.noExitRuntime;var g=!1;function m(e,t){e||X("Assertion failed: "+t)}var _="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function y(e,t){return e?function(e,t,i){for(var r=t+i,n=t;e[n]&&!(n>=r);)++n;if(n-t>16&&e.subarray&&_)return _.decode(e.subarray(t,n));for(var s="";t<n;){var o=e[t++];if(128&o){var a=63&e[t++];if(192!=(224&o)){var l=63&e[t++];if((o=224==(240&o)?(15&o)<<12|a<<6|l:(7&o)<<18|a<<12|l<<6|63&e[t++])<65536)s+=String.fromCharCode(o);else{var u=o-65536;s+=String.fromCharCode(55296|u>>10,56320|1023&u)}}else s+=String.fromCharCode((31&o)<<6|a)}else s+=String.fromCharCode(o)}return s}(B,e,t):""}var b,w,B,x,C,M,F,k,E,I="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function T(e,t){for(var i=e,r=i>>1,n=r+t/2;!(r>=n)&&C[r];)++r;if((i=r<<1)-e>32&&I)return I.decode(B.subarray(e,i));for(var s=0,o="";;){var a=x[e+2*s>>1];if(0==a||s==t/2)return o;++s,o+=String.fromCharCode(a)}}function D(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var r=t,n=(i-=2)<2*e.length?i/2:e.length,s=0;s<n;++s){var o=e.charCodeAt(s);x[t>>1]=o,t+=2}return x[t>>1]=0,t-r}function S(e){return 2*e.length}function R(e,t){for(var i=0,r="";!(i>=t/4);){var n=M[e+4*i>>2];if(0==n)break;if(++i,n>=65536){var s=n-65536;r+=String.fromCharCode(55296|s>>10,56320|1023&s)}else r+=String.fromCharCode(n)}return r}function U(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var r=t,n=r+i-4,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343)o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s);if(M[t>>2]=o,(t+=4)+4>n)break}return M[t>>2]=0,t-r}function L(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&++i,t+=4}return t}var O,N=t.INITIAL_MEMORY||167772160;function V(e){for(;e.length>0;){var i=e.shift();if("function"!=typeof i){var r=i.func;"number"==typeof r?void 0===i.arg?t.dynCall_v(r):t.dynCall_vi(r,i.arg):r(void 0===i.arg?null:i.arg)}else i(t)}}N=(b=t.buffer?t.buffer:new ArrayBuffer(N)).byteLength,b=O=b,t.HEAP8=w=new Int8Array(O),t.HEAP16=x=new Int16Array(O),t.HEAP32=M=new Int32Array(O),t.HEAPU8=B=new Uint8Array(O),t.HEAPU16=C=new Uint16Array(O),t.HEAPU32=F=new Uint32Array(O),t.HEAPF32=k=new Float32Array(O),t.HEAPF64=E=new Float64Array(O),M[5544]=5265264;var Q=[],H=[],G=[],j=[];var z=0,W=null;function X(e){throw t.onAbort&&t.onAbort(e),p(e+=""),f(e),g=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info."}t.preloadedImages={},t.preloadedAudios={};var K=null;var Z="data:application/octet-stream;base64,";function J(e){return t=e,i=Z,String.prototype.startsWith?t.startsWith(i):0===t.indexOf(i);var t,i}H.push({func:function(){wt()}}),K="data:application/octet-stream;base64,AAAAAAAAAAAPDg0MCwoJCA4AAQMGCgoJDQECBAcLCwoMAwQFCAwMCwsGBwgJDQ0MCgoLDA0ODg0JCgsMDQ4PDggJCgsMDQ4PAAECAwQFBgcBAAECAwQFBgIBAAECAwQFAwIBAAECAwQEAwIBAAECAwUEAwIBAAECBgUEAwIBAAEHBgUEAwIBAMgPAAAoDQAAEBAAACAQAADIDwAAUA0AABAQAAAgEAAAEQAKABEREQAAAAAFAAAAAAAACQAAAAALAAAAAAAAAAARAA8KERERAwoHAAEACQsLAAAJBgsAAAsABhEAAAAREREAAAAAAAAAAAAAAAAAAAAACwAAAAAAAAAAEQAKChEREQAKAAACAAkLAAAACQALAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAAAAAAAwAAAAADAAAAAAJDAAAAAAADAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAANAAAABA0AAAAACQ4AAAAAAA4AAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAADwAAAAAPAAAAAAkQAAAAAAAQAAAQAAASAAAAEhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABIAAAASEhIAAAAAAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAKAAAAAAoAAAAACQsAAAAAAAsAAAsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAAAAAAADAAAAAAMAAAAAAkMAAAAAAAMAAAMAAAwMTIzNDU2Nzg5QUJDREVGGRJEOwI/LEcUPTMwChsGRktFNw9JDo4XA0AdPGkrNh9KLRwBICUpIQgMFRYiLhA4Pgs0MRhkdHV2L0EJfzkRI0MyQomKiwUEJignDSoeNYwHGkiTE5SVAAAAAAAAAAAASWxsZWdhbCBieXRlIHNlcXVlbmNlAERvbWFpbiBlcnJvcgBSZXN1bHQgbm90IHJlcHJlc2VudGFibGUATm90IGEgdHR5AFBlcm1pc3Npb24gZGVuaWVkAE9wZXJhdGlvbiBub3QgcGVybWl0dGVkAE5vIHN1Y2ggZmlsZSBvciBkaXJlY3RvcnkATm8gc3VjaCBwcm9jZXNzAEZpbGUgZXhpc3RzAFZhbHVlIHRvbyBsYXJnZSBmb3IgZGF0YSB0eXBlAE5vIHNwYWNlIGxlZnQgb24gZGV2aWNlAE91dCBvZiBtZW1vcnkAUmVzb3VyY2UgYnVzeQBJbnRlcnJ1cHRlZCBzeXN0ZW0gY2FsbABSZXNvdXJjZSB0ZW1wb3JhcmlseSB1bmF2YWlsYWJsZQBJbnZhbGlkIHNlZWsAQ3Jvc3MtZGV2aWNlIGxpbmsAUmVhZC1vbmx5IGZpbGUgc3lzdGVtAERpcmVjdG9yeSBub3QgZW1wdHkAQ29ubmVjdGlvbiByZXNldCBieSBwZWVyAE9wZXJhdGlvbiB0aW1lZCBvdXQAQ29ubmVjdGlvbiByZWZ1c2VkAEhvc3QgaXMgZG93bgBIb3N0IGlzIHVucmVhY2hhYmxlAEFkZHJlc3MgaW4gdXNlAEJyb2tlbiBwaXBlAEkvTyBlcnJvcgBObyBzdWNoIGRldmljZSBvciBhZGRyZXNzAEJsb2NrIGRldmljZSByZXF1aXJlZABObyBzdWNoIGRldmljZQBOb3QgYSBkaXJlY3RvcnkASXMgYSBkaXJlY3RvcnkAVGV4dCBmaWxlIGJ1c3kARXhlYyBmb3JtYXQgZXJyb3IASW52YWxpZCBhcmd1bWVudABBcmd1bWVudCBsaXN0IHRvbyBsb25nAFN5bWJvbGljIGxpbmsgbG9vcABGaWxlbmFtZSB0b28gbG9uZwBUb28gbWFueSBvcGVuIGZpbGVzIGluIHN5c3RlbQBObyBmaWxlIGRlc2NyaXB0b3JzIGF2YWlsYWJsZQBCYWQgZmlsZSBkZXNjcmlwdG9yAE5vIGNoaWxkIHByb2Nlc3MAQmFkIGFkZHJlc3MARmlsZSB0b28gbGFyZ2UAVG9vIG1hbnkgbGlua3MATm8gbG9ja3MgYXZhaWxhYmxlAFJlc291cmNlIGRlYWRsb2NrIHdvdWxkIG9jY3VyAFN0YXRlIG5vdCByZWNvdmVyYWJsZQBQcmV2aW91cyBvd25lciBkaWVkAE9wZXJhdGlvbiBjYW5jZWxlZABGdW5jdGlvbiBub3QgaW1wbGVtZW50ZWQATm8gbWVzc2FnZSBvZiBkZXNpcmVkIHR5cGUASWRlbnRpZmllciByZW1vdmVkAERldmljZSBub3QgYSBzdHJlYW0ATm8gZGF0YSBhdmFpbGFibGUARGV2aWNlIHRpbWVvdXQAT3V0IG9mIHN0cmVhbXMgcmVzb3VyY2VzAExpbmsgaGFzIGJlZW4gc2V2ZXJlZABQcm90b2NvbCBlcnJvcgBCYWQgbWVzc2FnZQBGaWxlIGRlc2NyaXB0b3IgaW4gYmFkIHN0YXRlAE5vdCBhIHNvY2tldABEZXN0aW5hdGlvbiBhZGRyZXNzIHJlcXVpcmVkAE1lc3NhZ2UgdG9vIGxhcmdlAFByb3RvY29sIHdyb25nIHR5cGUgZm9yIHNvY2tldABQcm90b2NvbCBub3QgYXZhaWxhYmxlAFByb3RvY29sIG5vdCBzdXBwb3J0ZWQAU29ja2V0IHR5cGUgbm90IHN1cHBvcnRlZABOb3Qgc3VwcG9ydGVkAFByb3RvY29sIGZhbWlseSBub3Qgc3VwcG9ydGVkAEFkZHJlc3MgZmFtaWx5IG5vdCBzdXBwb3J0ZWQgYnkgcHJvdG9jb2wAQWRkcmVzcyBub3QgYXZhaWxhYmxlAE5ldHdvcmsgaXMgZG93bgBOZXR3b3JrIHVucmVhY2hhYmxlAENvbm5lY3Rpb24gcmVzZXQgYnkgbmV0d29yawBDb25uZWN0aW9uIGFib3J0ZWQATm8gYnVmZmVyIHNwYWNlIGF2YWlsYWJsZQBTb2NrZXQgaXMgY29ubmVjdGVkAFNvY2tldCBub3QgY29ubmVjdGVkAENhbm5vdCBzZW5kIGFmdGVyIHNvY2tldCBzaHV0ZG93bgBPcGVyYXRpb24gYWxyZWFkeSBpbiBwcm9ncmVzcwBPcGVyYXRpb24gaW4gcHJvZ3Jlc3MAU3RhbGUgZmlsZSBoYW5kbGUAUmVtb3RlIEkvTyBlcnJvcgBRdW90YSBleGNlZWRlZABObyBtZWRpdW0gZm91bmQAV3JvbmcgbWVkaXVtIHR5cGUATm8gZXJyb3IgaW5mb3JtYXRpb24AAAAAAADgFgAAmRgAAGAQAAAAAAAA4BYAAEIZAABgEAAAAAAAAOAWAAAqGgAASA8AAAAAAAC4FgAANBsAAOAWAACfGgAAMAoAAAAAAADgFgAAaRsAAEgPAAAAAAAA4BYAAIobAABIDwAAAAAAALgWAAAPHAAA4BYAAHwcAABIDwAAAAAAAOAWAACVHAAASA8AAAAAAADgFgAAHh0AAEgPAAAAAAAA4BYAAHcdAABIDwAAAAAAAOAWAACQHQAASA8AAAAAAADgFgAAQh4AAEgPAAAAAAAA4BYAAIceAABgEAAAAAAAAOAWAACkHwAASA8AAAAAAAC4FgAAZyAAAOAWAADkHwAA8AoAAAAAAADgFgAAjyAAAGAQAAAAAAAAuBYAAMMiAADgFgAAAiIAABgLAAAAAAAA4BYAAOEiAABgEAAAAAAAAOAWAADQJAAAGAsAAAAAAADgFgAAkSUAAGAQAAAAAAAA4BYAAIAnAAAYCwAAAAAAAOAWAAA9KAAAYBAAAAAAAADgFgAAJCoAABgLAAAAAAAA4BYAAOkqAABgEAAAAAAAAOAWAADgLAAA8AoAAAAAAADgFgAAui0AAGAQAAAAAAAA4BYAANsvAADwCgAAAAAAAOAWAADTMAAAYBAAAAAAAADgFgAAMDMAAPAKAAAAAAAA4BYAACQ0AABgEAAAAAAAAOAWAAB5NgAA8AoAAAAAAADgFgAAizcAAGAQAAAAAAAA4BYAABw6AABgEAAAAAAAAOAWAACdOgAAYBAAAAAAAADgFgAAXjsAAPAKAAAAAAAA4BYAALU7AABgEAAAAAAAAOAWAADMPAAAGAsAAAAAAADgFgAATz0AAGAQAAAAAAAA4BYAAL4+AAAYCwAAAAAAAOAWAABBPwAAYBAAAAAAAADgFgAAsEAAABgLAAAAAAAA4BYAADNBAABgEAAAAAAAAOAWAACiQgAAGAsAAAAAAADgFgAAJUMAAGAQAAAAAAAA4BYAAJREAAAYCwAAAAAAAOAWAAAXRQAAYBAAAAAAAADgFgAAhkYAABgLAAAAAAAA4BYAAAlHAABgEAAAAAAAALgWAAB4SAAAiBcAAIBIAAAAAAAAIA0AAIgXAACJSAAAAQAAACANAAC4FgAAqkgAAIgXAAC6SAAAAAAAAEgNAACIFwAAy0gAAAEAAABIDQAAuBYAABhMAAC4FgAAN0wAALgWAABWTAAAuBYAAHVMAAC4FgAAlEwAALgWAACzTAAAuBYAANJMAAC4FgAA8UwAALgWAAAQTQAAuBYAAC9NAAC4FgAATk0AALgWAABtTQAAuBYAAIxNAACkFwAAn00AAAAAAAABAAAA8A0AAAAAAAC4FgAA4U0AAKQXAAAHTgAAAAAAAAEAAADwDQAAAAAAAKQXAABJTgAAAAAAAAEAAADwDQAAAAAAAKQXAACITgAAAAAAAAEAAADwDQAAAAAAAKQXAADHTgAAAAAAAAEAAADwDQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALgWAADNTwAA4BYAAC1QAAAADwAAAAAAAOAWAADaTwAAEA8AAAAAAAC4FgAA+08AAOAWAAAIUAAA8A4AAAAAAADgFgAAhlAAAOgOAAAAAAAA4BYAAJNQAADoDgAAAAAAAOAWAACjUAAA6A4AAAAAAADgFgAAtVAAADgPAAAAAAAA4BYAAMZQAAA4DwAAAAAAAOAWAADXUAAAAA8AAAAAAADgFgAA+VAAAHgPAAAAAAAA4BYAAB1RAAAADwAAAAAAAOAWAABCUQAAeA8AAAAAAADgFgAAjlEAAAAPAAAAAAAAbBcAALZRAABsFwAAuFEAAGwXAAC7UQAAbBcAAL1RAABsFwAAv1EAAGwXAADBUQAAbBcAAMNRAABsFwAAxVEAAGwXAADHUQAAbBcAAMlRAABsFwAAy1EAAGwXAADNUQAAbBcAAM9RAABsFwAA0VEAAOAWAADTUQAA8A4AAAAAAADgFgAARlIAAOgOAAAAAAAAuBYAAGJSAACkFwAAe1IAAAAAAAABAAAAWBAAAAAAAADgFgAA9FIAAIgQAAAAAAAA4BYAABdTAACYEAAAAAAAALgWAAAuUwAA4BYAAHBTAACIEAAAAAAAAOAWAACSUwAASA8AAAAAAAAAAAAAAAoAAAEAAAACAAAAAwAAAAEAAAAEAAAAAAAAABAKAAABAAAABQAAAAYAAAACAAAABwAAAAAAAAAgCgAACAAAAAkAAAABAAAAAAAAADgKAAAKAAAACwAAAAIAAAABAAAADAAAAA0AAAACAAAAAwAAAAMAAAAAAAAASAoAAAgAAAAOAAAAAQAAAAAAAABYCgAACAAAAA8AAAABAAAAAAAAAIAKAAAIAAAAEAAAAAEAAAAAAAAAcAoAAAgAAAARAAAAAQAAAAAAAACQCgAACAAAABIAAAABAAAAAAAAAKAKAAAIAAAAEwAAAAEAAAAAAAAAsAoAAAgAAAAUAAAAAQAAAAAAAADACgAACAAAABUAAAABAAAAAAAAANAKAAABAAAAFgAAABcAAAAEAAAAGAAAAAAAAADgCgAACAAAABkAAAABAAAAAAAAAPgKAAAFAAAAGgAAABsAAAAAAAAA8AoAAAEAAAAcAAAAHQAAAAAAAAAICwAAAQAAAB4AAAAfAAAABgAAACAAAAAAAAAAIAsAACEAAAAiAAAABwAAAAgAAAAAAAAAGAsAACMAAAAkAAAABwAAAAkAAAAAAAAAMAsAAAEAAAAlAAAAJgAAAAoAAAAnAAAAAAAAAEALAAAoAAAAKQAAAAcAAAALAAAAAAAAAFALAAABAAAAKgAAACsAAAAMAAAALAAAAAAAAABgCwAALQAAAC4AAAAHAAAADQAAAAAAAABwCwAAAQAAAC8AAAAwAAAADgAAADEAAAAAAAAAgAsAADIAAAAzAAAABwAAAA8AAAAAAAAAkAsAAAEAAAA0AAAANQAAABAAAAA2AAAAAAAAAKALAAARAAAANwAAADgAAAAAAAAAsAsAAAEAAAA5AAAAOgAAABIAAAA7AAAAAAAAAMALAAATAAAAPAAAAD0AAAAAAAAA0AsAAAEAAAA+AAAAPwAAABQAAABAAAAAAAAAAOALAAAVAAAAQQAAAEIAAAAAAAAA8AsAAAEAAABDAAAARAAAABYAAABFAAAAAAAAAAAMAAAXAAAARgAAAEcAAAAAAAAAEAwAAAEAAABIAAAASQAAABgAAABKAAAAAAAAACAMAAABAAAASwAAAEwAAAAZAAAATQAAAAAAAAAwDAAAAQAAAE4AAABPAAAAGgAAAFAAAAAAAAAAQAwAABsAAABRAAAAUgAAAAAAAABQDAAAAQAAAFMAAABUAAAAHAAAAFUAAAAAAAAAYAwAAFYAAABXAAAABwAAAB0AAAAAAAAAcAwAAAEAAABYAAAAWQAAAB4AAABaAAAAAAAAAIAMAABbAAAAXAAAAAcAAAAfAAAAAAAAAJAMAAABAAAAXQAAAF4AAAAgAAAAXwAAAAAAAACgDAAAYAAAAGEAAAAHAAAAIQAAAAAAAACwDAAAAQAAAGIAAABjAAAAIgAAAGQAAAAAAAAAwAwAAGUAAABmAAAABwAAACMAAAAAAAAA0AwAAAEAAABnAAAAaAAAACQAAABpAAAAAAAAAOAMAABqAAAAawAAAAcAAAAlAAAAAAAAAPAMAAABAAAAbAAAAG0AAAAmAAAAbgAAAAAAAAAADQAAbwAAAHAAAAAHAAAAJwAAAAAAAAAQDQAAAQAAAHEAAAByAAAAKAAAAHMAAAAoDQAAyA8AACgNAAAIEAAAEBAAACgNAABQDQAAyA8AAFANAAAgEAAAyA8AAFANAAAIEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABsVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwDgAAdAAAAHUAAAB2AAAAdwAAAAIAAAABAAAAAQAAAAEAAAAAAAAAGA8AAHQAAAB4AAAAdgAAAHcAAAACAAAAAgAAAAIAAAACAAAAAAAAACgPAAB5AAAAegAAAAQAAAAAAAAAOA8AAHsAAAB8AAAABQAAAAAAAABIDwAACAAAAH0AAAABAAAAAAAAAFgPAAB7AAAAfgAAAAUAAAAAAAAAaA8AAHsAAAB/AAAABQAAAAAAAAC4DwAAdAAAAIAAAAB2AAAAdwAAAAMAAAAAAAAAiA8AAHQAAACBAAAAdgAAAHcAAAAEAAAAAAAAADgQAAB0AAAAggAAAHYAAAB3AAAAAgAAAAMAAAADAAAAAwAAAAAAAABIEAAAgwAAAIQAAAAGAAAAAAAAAHgQAACFAAAAhgAAAAcAAAABAAAABQAAAAYAAAACAAAAAAAAAKAQAACFAAAAhwAAAAgAAAADAAAABQAAAAYAAAAEAAAA4BcAAAQYAAAAAAAAsBAAAIgAAACJAAAAAQAAAExBU1ppcABvcGVuAGdldFBvaW50AGdldENvdW50AER5bmFtaWNMQVNaaXAAYWRkRmllbGRGbG9hdGluZwBhZGRGaWVsZFNpZ25lZABhZGRGaWVsZFVuc2lnbmVkAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRU5TXzE0ZGVmYXVsdF9kZWxldGVJUzNfRUVOU185YWxsb2NhdG9ySVMzX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJUzdfRUVOU185YWxsb2NhdG9ySVM3X0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFAExBU0YATjZsYXN6aXAxM2ludmFsaWRfbWFnaWNFAGFsbG9jYXRvcjxUPjo6YWxsb2NhdGUoc2l6ZV90IG4pICduJyBleGNlZWRzIG1heGltdW0gc3VwcG9ydGVkIHNpemUARmlsZSBtYWdpYyBpcyBub3QgdmFsaWQATlN0M19fMjEwX19mdW5jdGlvbjZfX2Z1bmNJWk42bGFzemlwMmlvNnJlYWRlcjEwYmFzaWNfZmlsZUlOUzJfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRTExX3ZhbGlkYXRvcnNFdkVVbFJOUzNfNmhlYWRlckVFX05TXzlhbGxvY2F0b3JJU0JfRUVGdlNBX0VFRQBOU3QzX18yMTBfX2Z1bmN0aW9uNl9fYmFzZUlGdlJONmxhc3ppcDJpbzZoZWFkZXJFRUVFAE42bGFzemlwMjFvbGRfc3R5bGVfY29tcHJlc3Npb25FAE42bGFzemlwMTRub3RfY29tcHJlc3NlZEUAVGhlIGZpbGUgc2VlbXMgdG8gaGF2ZSBvbGQgc3R5bGUgY29tcHJlc3Npb24gd2hpY2ggaXMgbm90IHN1cHBvcnRlZABUaGUgZmlsZSBkb2Vzbid0IHNlZW0gdG8gYmUgY29tcHJlc3NlZABaTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUUxMV92YWxpZGF0b3JzRXZFVWxSTlMwXzZoZWFkZXJFRV8AbGFzemlwIGVuY29kZWQATjZsYXN6aXAxM25vX2xhc3ppcF92bHJFAE42bGFzemlwMjVsYXN6aXBfZm9ybWF0X3Vuc3VwcG9ydGVkRQBPbmx5IExBU3ppcCBQT0lOVFdJU0UgQ0hVTktFRCBkZWNvbXByZXNzb3IgaXMgc3VwcG9ydGVkAE5vIExBU3ppcCBWTFIgd2FzIGZvdW5kIGluIHRoZSBWTFJzIHNlY3Rpb24ATjZsYXN6aXAyMmNodW5rX3RhYmxlX3JlYWRfZXJyb3JFAENodW5rIHRhYmxlIG9mZnNldCA9PSAtMSBpcyBub3Qgc3VwcG9ydGVkIGF0IHRoaXMgdGltZQBONmxhc3ppcDEzbm90X3N1cHBvcnRlZEUATjZsYXN6aXAyNnVua25vd25fY2h1bmtfdGFibGVfZm9ybWF0RQBjaHVua19zaXplID09IHVpbnQubWF4IGlzIG5vdCBzdXBwb3J0ZWQgYXQgdGhpcyB0aW1lLgBUaGVyZSB3YXMgYSBwcm9ibGVtIHJlYWRpbmcgdGhlIGNodW5rIHRhYmxlAFRoZSBjaHVuayB0YWJsZSB2ZXJzaW9uIG51bWJlciBpcyB1bmtub3duAE42bGFzemlwMTFlbmRfb2ZfZmlsZUUAUmVhY2hlZCBFbmQgb2YgZmlsZQBJbnZhbGlkIG51bWJlciBvZiBzeW1ib2xzAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVM5X0VFTlNfOWFsbG9jYXRvcklTOV9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRUVFAE42bGFzemlwMTl1bmtub3duX3NjaGVtYV90eXBlRQBUaGUgTEFaIHNjaGVtYSBpcyBub3QgcmVjb2duaXplZABONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2ZpZWxkX2RlY29tcHJlc3NvcklOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyMGR5bmFtaWNfZGVjb21wcmVzc29yRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19maWVsZF9kZWNvbXByZXNzb3JJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU0NfRUVOU185YWxsb2NhdG9ySVNDX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19maWVsZF9kZWNvbXByZXNzb3JJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzVmaWVsZElOUzBfM2xhczdwb2ludDEwRU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNDX0VFRUVFRQBONmxhc3ppcDdmb3JtYXRzMTBiYXNlX2ZpZWxkRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTSV9FRU5TXzlhbGxvY2F0b3JJU0lfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl81ZmllbGRJTlMyXzNsYXM3cG9pbnQxMEVOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMF81ZmllbGRJTlMwXzNsYXM3Z3BzdGltZUVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczdncHN0aW1lRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNFX0VFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU0lfRUVOU185YWxsb2NhdG9ySVNJX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfNWZpZWxkSU5TMl8zbGFzN2dwc3RpbWVFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFRUUATjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfNWZpZWxkSU5TMF8zbGFzM3JnYkVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczNyZ2JFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTSV9FRU5TXzlhbGxvY2F0b3JJU0lfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl81ZmllbGRJTlMyXzNsYXMzcmdiRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNFX0VFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzVmaWVsZElOUzBfM2xhczEwZXh0cmFieXRlc0VOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczEwZXh0cmFieXRlc0VOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVNJX0VFTlNfOWFsbG9jYXRvcklTSV9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczEwZXh0cmFieXRlc0VOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzBfNWZpZWxkSU5TMF8zbGFzN3BvaW50MTBFTlMwXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0RfRUVFRUVFRUVFAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTS19FRU5TXzlhbGxvY2F0b3JJU0tfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRUVFRUVFRUUATjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMwXzVmaWVsZElOUzBfM2xhczdwb2ludDEwRU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNEX0VFRUVOU0JfSU5TQ183Z3BzdGltZUVOU0VfSVNIX0VFRUVFRUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU05fRUVOU185YWxsb2NhdG9ySVNOX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyMWR5bmFtaWNfZGVjb21wcmVzc29yMUlOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMF8xOXJlY29yZF9kZWNvbXByZXNzb3JJSk5TMF81ZmllbGRJTlMwXzNsYXM3cG9pbnQxMEVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRF9FRUVFTlNCX0lOU0NfM3JnYkVOU0VfSVNIX0VFRUVFRUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV8zcmdiRU5TR19JU0pfRUVFRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTTl9FRU5TXzlhbGxvY2F0b3JJU05fRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRU5TRF9JTlNFXzNyZ2JFTlNHX0lTSl9FRUVFRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzBfNWZpZWxkSU5TMF8zbGFzN3BvaW50MTBFTlMwXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0RfRUVFRU5TQl9JTlNDXzdncHN0aW1lRU5TRV9JU0hfRUVFRU5TQl9JTlNDXzNyZ2JFTlNFX0lTS19FRUVFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyMWR5bmFtaWNfZGVjb21wcmVzc29yMUlOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl8xOXJlY29yZF9kZWNvbXByZXNzb3JJSk5TMl81ZmllbGRJTlMyXzNsYXM3cG9pbnQxMEVOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRl9FRUVFTlNEX0lOU0VfN2dwc3RpbWVFTlNHX0lTSl9FRUVFTlNEX0lOU0VfM3JnYkVOU0dfSVNNX0VFRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU1FfRUVOU185YWxsb2NhdG9ySVNRX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVOU0RfSU5TRV8zcmdiRU5TR19JU01fRUVFRUVFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUDEwYnVmX3N0cmVhbU5TXzE0ZGVmYXVsdF9kZWxldGVJUzFfRUVOU185YWxsb2NhdG9ySVMxX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJMTBidWZfc3RyZWFtRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTNV9FRU5TXzlhbGxvY2F0b3JJUzVfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZmllbGRfZGVjb21wcmVzc29ySU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRUVFAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2ZpZWxkX2RlY29tcHJlc3NvcklOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVM4X0VFTlNfOWFsbG9jYXRvcklTOF9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZmllbGRfZGVjb21wcmVzc29ySU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJaU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWlFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWlOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElpRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElpTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJaUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJak5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWpFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWpOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElqRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElqTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJakVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJYU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWFFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWFOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElhRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElhTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJYUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJc05TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSXNFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSXNOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElzRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElzTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJc0VFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJaE5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWhFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWhOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZEloRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZEloTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJaEVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJdE5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSXRFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSXROUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZEl0RUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZEl0TlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJdEVFRUVFRUVFADZMQVNaaXAAUDZMQVNaaXAAUEs2TEFTWmlwAGlpAHYAdmkAdmlpaWkAdmlpaQBpaWkAMTNEeW5hbWljTEFTWmlwAFAxM0R5bmFtaWNMQVNaaXAAUEsxM0R5bmFtaWNMQVNaaXAAdm9pZABib29sAGNoYXIAc2lnbmVkIGNoYXIAdW5zaWduZWQgY2hhcgBzaG9ydAB1bnNpZ25lZCBzaG9ydABpbnQAdW5zaWduZWQgaW50AGxvbmcAdW5zaWduZWQgbG9uZwBmbG9hdABkb3VibGUAc3RkOjpzdHJpbmcAc3RkOjpiYXNpY19zdHJpbmc8dW5zaWduZWQgY2hhcj4Ac3RkOjp3c3RyaW5nAHN0ZDo6dTE2c3RyaW5nAHN0ZDo6dTMyc3RyaW5nAGVtc2NyaXB0ZW46OnZhbABlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxjaGFyPgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxzaWduZWQgY2hhcj4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dW5zaWduZWQgY2hhcj4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8c2hvcnQ+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PHVuc2lnbmVkIHNob3J0PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxpbnQ+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PHVuc2lnbmVkIGludD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8bG9uZz4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dW5zaWduZWQgbG9uZz4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8aW50OF90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzx1aW50OF90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxpbnQxNl90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzx1aW50MTZfdD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8aW50MzJfdD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dWludDMyX3Q+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PGZsb2F0PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxkb3VibGU+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PGxvbmcgZG91YmxlPgBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0llRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJZEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWZFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0ltRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJbEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWpFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0lpRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJdEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SXNFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0loRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJYUVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWNFRQBOMTBlbXNjcmlwdGVuM3ZhbEUATlN0M19fMjEyYmFzaWNfc3RyaW5nSURpTlNfMTFjaGFyX3RyYWl0c0lEaUVFTlNfOWFsbG9jYXRvcklEaUVFRUUATlN0M19fMjIxX19iYXNpY19zdHJpbmdfY29tbW9uSUxiMUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJRHNOU18xMWNoYXJfdHJhaXRzSURzRUVOU185YWxsb2NhdG9ySURzRUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJd05TXzExY2hhcl90cmFpdHNJd0VFTlNfOWFsbG9jYXRvckl3RUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJaE5TXzExY2hhcl90cmFpdHNJaEVFTlNfOWFsbG9jYXRvckloRUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJY05TXzExY2hhcl90cmFpdHNJY0VFTlNfOWFsbG9jYXRvckljRUVFRQAtKyAgIDBYMHgAKG51bGwpAC0wWCswWCAwWC0weCsweCAweABpbmYASU5GAG5hbgBOQU4ALgB0ZXJtaW5hdGluZyB3aXRoICVzIGV4Y2VwdGlvbiBvZiB0eXBlICVzOiAlcwB0ZXJtaW5hdGluZyB3aXRoICVzIGV4Y2VwdGlvbiBvZiB0eXBlICVzAHRlcm1pbmF0aW5nIHdpdGggJXMgZm9yZWlnbiBleGNlcHRpb24AdGVybWluYXRpbmcAdW5jYXVnaHQAU3Q5ZXhjZXB0aW9uAE4xMF9fY3h4YWJpdjExNl9fc2hpbV90eXBlX2luZm9FAFN0OXR5cGVfaW5mbwBOMTBfX2N4eGFiaXYxMjBfX3NpX2NsYXNzX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTE3X19jbGFzc190eXBlX2luZm9FAHRlcm1pbmF0ZV9oYW5kbGVyIHVuZXhwZWN0ZWRseSByZXR1cm5lZABzdGQ6OmJhZF9hbGxvYwBTdDliYWRfYWxsb2MAU3QxMWxvZ2ljX2Vycm9yAFN0MTNydW50aW1lX2Vycm9yAFN0MTJsZW5ndGhfZXJyb3IAU3QxMm91dF9vZl9yYW5nZQBOMTBfX2N4eGFiaXYxMTdfX3BiYXNlX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTE5X19wb2ludGVyX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTIwX19mdW5jdGlvbl90eXBlX2luZm9FAE4xMF9fY3h4YWJpdjEyOV9fcG9pbnRlcl90b19tZW1iZXJfdHlwZV9pbmZvRQBQdXJlIHZpcnR1YWwgZnVuY3Rpb24gY2FsbGVkIQBOMTBfX2N4eGFiaXYxMjNfX2Z1bmRhbWVudGFsX3R5cGVfaW5mb0UAdgBEbgBiAGMAaABhAHMAdABpAGoAbABtAGYAZABOMTBfX2N4eGFiaXYxMjFfX3ZtaV9jbGFzc190eXBlX2luZm9FAF9fY3hhX2d1YXJkX2FjcXVpcmUgZGV0ZWN0ZWQgcmVjdXJzaXZlIGluaXRpYWxpemF0aW9uAHN0ZDo6YmFkX2Z1bmN0aW9uX2NhbGwATlN0M19fMjE3YmFkX2Z1bmN0aW9uX2NhbGxFAE5TdDNfXzIxNF9fc2hhcmVkX2NvdW50RQBOU3QzX18yMTlfX3NoYXJlZF93ZWFrX2NvdW50RQBtdXRleCBsb2NrIGZhaWxlZABiYXNpY19zdHJpbmcAdW5zcGVjaWZpZWQgZ2VuZXJpY19jYXRlZ29yeSBlcnJvcgBVbmtub3duIGVycm9yICVkAGdlbmVyaWMATlN0M19fMjI0X19nZW5lcmljX2Vycm9yX2NhdGVnb3J5RQBOU3QzX18yMTJfX2RvX21lc3NhZ2VFAE5TdDNfXzIxNGVycm9yX2NhdGVnb3J5RQB1bnNwZWNpZmllZCBzeXN0ZW1fY2F0ZWdvcnkgZXJyb3IAc3lzdGVtAE5TdDNfXzIyM19fc3lzdGVtX2Vycm9yX2NhdGVnb3J5RQBOU3QzX18yMTJzeXN0ZW1fZXJyb3JFADogAHZlY3Rvcg==";var Y={};function q(e){e&&Y[e].refcount++}function $(e){if(!e||Y[e])return e;for(var t in Y)for(var i=+t,r=Y[i].adjusted,n=r.length,s=0;s<n;s++)if(r[s]===e)return i;return e}function ee(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var te=void 0;function ie(e){for(var t="",i=e;B[i];)t+=te[B[i++]];return t}var re={},ne={},se={};function oe(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function ae(e,t){return e=oe(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function le(e,t){var i=ae(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var ue=void 0;function Ae(e){throw new ue(e)}var ce=void 0;function he(e){throw new ce(e)}function de(e,t,i){function r(t){var r=i(t);r.length!==e.length&&he("Mismatched type converter count");for(var n=0;n<e.length;++n)pe(e[n],r[n])}e.forEach((function(e){se[e]=t}));var n=new Array(t.length),s=[],o=0;t.forEach((function(e,t){ne.hasOwnProperty(e)?n[t]=ne[e]:(s.push(e),re.hasOwnProperty(e)||(re[e]=[]),re[e].push((function(){n[t]=ne[e],++o===s.length&&r(n)})))})),0===s.length&&r(n)}function pe(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||Ae('type "'+r+'" must have a positive integer typeid pointer'),ne.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;Ae("Cannot register type '"+r+"' twice")}if(ne[e]=t,delete se[e],re.hasOwnProperty(e)){var n=re[e];delete re[e],n.forEach((function(e){e()}))}}function fe(e){if(!(this instanceof Fe))return!1;if(!(e instanceof Fe))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,r=e.$$.ptrType.registeredClass,n=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;r.baseClass;)n=r.upcast(n),r=r.baseClass;return t===r&&i===n}function ve(e){Ae(e.$$.ptrType.registeredClass.name+" instance already deleted")}var ge=!1;function me(e){}function _e(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function ye(e){return"undefined"==typeof FinalizationGroup?(ye=function(e){return e},e):(ge=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?_e(i):console.warn("object already deleted: "+i.ptr)}})),ye=function(e){return ge.register(e,e.$$,e.$$),e},me=function(e){ge.unregister(e.$$)},ye(e))}function be(){if(this.$$.ptr||ve(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=ye(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function we(){this.$$.ptr||ve(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Ae("Object already scheduled for deletion"),me(this),_e(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function Be(){return!this.$$.ptr}var xe=void 0,Pe=[];function Ce(){for(;Pe.length;){var e=Pe.pop();e.$$.deleteScheduled=!1,e.delete()}}function Me(){return this.$$.ptr||ve(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Ae("Object already scheduled for deletion"),Pe.push(this),1===Pe.length&&xe&&xe(Ce),this.$$.deleteScheduled=!0,this}function Fe(){}var ke={};function Ee(e,t,i){if(void 0===e[t].overloadTable){var r=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||Ae("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[r.argCount]=r}}function Ie(e,t,i,r,n,s,o,a){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=r,this.baseClass=n,this.getActualType=s,this.upcast=o,this.downcast=a,this.pureVirtualFunctions=[]}function Te(e,t,i){for(;t!==i;)t.upcast||Ae("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function De(e,t){if(null===t)return this.isReference&&Ae("null is not a valid "+this.name),0;t.$$||Ae('Cannot pass "'+lt(t)+'" as a '+this.name),t.$$.ptr||Ae("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return Te(t.$$.ptr,i,this.registeredClass)}function Se(e,t){var i;if(null===t)return this.isReference&&Ae("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||Ae('Cannot pass "'+lt(t)+'" as a '+this.name),t.$$.ptr||Ae("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&Ae("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var r=t.$$.ptrType.registeredClass;if(i=Te(t.$$.ptr,r,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&Ae("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:Ae("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var n=t.clone();i=this.rawShare(i,at((function(){n.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:Ae("Unsupporting sharing policy")}return i}function Re(e,t){if(null===t)return this.isReference&&Ae("null is not a valid "+this.name),0;t.$$||Ae('Cannot pass "'+lt(t)+'" as a '+this.name),t.$$.ptr||Ae("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&Ae("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return Te(t.$$.ptr,i,this.registeredClass)}function Ue(e){return this.fromWireType(F[e>>2])}function Le(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Oe(e){this.rawDestructor&&this.rawDestructor(e)}function Ne(e){null!==e&&e.delete()}function Ve(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var r=Ve(e,t,i.baseClass);return null===r?null:i.downcast(r)}function Qe(){return Object.keys(je).length}function He(){var e=[];for(var t in je)je.hasOwnProperty(t)&&e.push(je[t]);return e}function Ge(e){xe=e,Pe.length&&xe&&xe(Ce)}var je={};function ze(e,t){return t=function(e,t){for(void 0===t&&Ae("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),je[t]}function We(e,t){return t.ptrType&&t.ptr||he("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&he("Both smartPtrType and smartPtr must be specified"),t.count={value:1},ye(Object.create(e,{$$:{value:t}}))}function Xe(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=ze(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var r=i.clone();return this.destructor(e),r}function n(){return this.isSmartPointer?We(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):We(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var s,o=this.registeredClass.getActualType(t),a=ke[o];if(!a)return n.call(this);s=this.isConst?a.constPointerType:a.pointerType;var l=Ve(t,this.registeredClass,s.registeredClass);return null===l?n.call(this):this.isSmartPointer?We(s.registeredClass.instancePrototype,{ptrType:s,ptr:l,smartPtrType:this,smartPtr:e}):We(s.registeredClass.instancePrototype,{ptrType:s,ptr:l})}function Ke(e,t,i,r,n,s,o,a,l,u,A){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=r,this.isSmartPointer=n,this.pointeeType=s,this.sharingPolicy=o,this.rawGetPointee=a,this.rawConstructor=l,this.rawShare=u,this.rawDestructor=A,n||void 0!==t.baseClass?this.toWireType=Se:r?(this.toWireType=De,this.destructorFunction=null):(this.toWireType=Re,this.destructorFunction=null)}function Ze(e,i){e=ie(e);var r=function(t){for(var r=[],n=1;n<e.length;++n)r.push("a"+n);var s="return function "+("dynCall_"+e+"_"+i)+"("+r.join(", ")+") {\n";return s+="    return dynCall(rawFunction"+(r.length?", ":"")+r.join(", ")+");\n",s+="};\n",new Function("dynCall","rawFunction",s)(t,i)}(t["dynCall_"+e]);return"function"!=typeof r&&Ae("unknown function pointer with signature "+e+": "+i),r}var Je=void 0;function Ye(e){var t=gt(e),i=ie(t);return mt(t),i}function qe(e,t){var i=[],r={};throw t.forEach((function e(t){r[t]||ne[t]||(se[t]?se[t].forEach(e):(i.push(t),r[t]=!0))})),new Je(e+": "+i.map(Ye).join([", "]))}function $e(e,t){for(var i=[],r=0;r<e;r++)i.push(M[(t>>2)+r]);return i}function et(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function tt(e,t,i,r,n){var s=t.length;s<2&&Ae("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var o=null!==t[1]&&null!==i,a=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){a=!0;break}var u="void"!==t[0].name,A="",c="";for(l=0;l<s-2;++l)A+=(0!==l?", ":"")+"arg"+l,c+=(0!==l?", ":"")+"arg"+l+"Wired";var h="return function "+oe(e)+"("+A+") {\nif (arguments.length !== "+(s-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(s-2)+" args!');\n}\n";a&&(h+="var destructors = [];\n");var d=a?"destructors":"null",p=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],f=[Ae,r,n,et,t[0],t[1]];o&&(h+="var thisWired = classParam.toWireType("+d+", this);\n");for(l=0;l<s-2;++l)h+="var arg"+l+"Wired = argType"+l+".toWireType("+d+", arg"+l+"); // "+t[l+2].name+"\n",p.push("argType"+l),f.push(t[l+2]);if(o&&(c="thisWired"+(c.length>0?", ":"")+c),h+=(u?"var rv = ":"")+"invoker(fn"+(c.length>0?", ":"")+c+");\n",a)h+="runDestructors(destructors);\n";else for(l=o?1:2;l<t.length;++l){var v=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(h+=v+"_dtor("+v+"); // "+t[l].name+"\n",p.push(v+"_dtor"),f.push(t[l].destructorFunction))}return u&&(h+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h+="}\n",p.push(h),function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+P(e)+" which is not a function");var i=ae(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var r=new i,n=e.apply(r,t);return n instanceof Object?n:r}(Function,p).apply(null,f)}var it=[],rt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function nt(e){e>4&&0==--rt[e].refcount&&(rt[e]=void 0,it.push(e))}function st(){for(var e=0,t=5;t<rt.length;++t)void 0!==rt[t]&&++e;return e}function ot(){for(var e=5;e<rt.length;++e)if(void 0!==rt[e])return rt[e];return null}function at(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=it.length?it.pop():rt.length;return rt[t]={refcount:1,value:e},t}}function lt(e){if(null===e)return"null";var t=P(e);return"object"===t||"array"===t||"function"===t?e.toString():""+e}function ut(e,t){switch(t){case 2:return function(e){return this.fromWireType(k[e>>2])};case 3:return function(e){return this.fromWireType(E[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function At(e,t,i){switch(t){case 0:return i?function(e){return w[e]}:function(e){return B[e]};case 1:return i?function(e){return x[e>>1]}:function(e){return C[e>>1]};case 2:return i?function(e){return M[e>>2]}:function(e){return F[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function ct(e){for(var t=[],i=0;i<e.length;i++){var r=e[i];r>255&&(r&=255),t.push(String.fromCharCode(r))}return t.join("")}!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);te=e}(),ue=t.BindingError=le(Error,"BindingError"),ce=t.InternalError=le(Error,"InternalError"),Fe.prototype.isAliasOf=fe,Fe.prototype.clone=be,Fe.prototype.delete=we,Fe.prototype.isDeleted=Be,Fe.prototype.deleteLater=Me,Ke.prototype.getPointee=Le,Ke.prototype.destructor=Oe,Ke.prototype.argPackAdvance=8,Ke.prototype.readValueFromPointer=Ue,Ke.prototype.deleteObject=Ne,Ke.prototype.fromWireType=Xe,t.getInheritedInstanceCount=Qe,t.getLiveInheritedInstances=He,t.flushPendingDeletes=Ce,t.setDelayFunction=Ge,Je=t.UnboundTypeError=le(Error,"UnboundTypeError"),t.count_emval_handles=st,t.get_first_emval=ot;var ht="function"==typeof atob?atob:function(e){var t,i,r,n,s,o,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",u=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{t=a.indexOf(e.charAt(u++))<<2|(n=a.indexOf(e.charAt(u++)))>>4,i=(15&n)<<4|(s=a.indexOf(e.charAt(u++)))>>2,r=(3&s)<<6|(o=a.indexOf(e.charAt(u++))),l+=String.fromCharCode(t),64!==s&&(l+=String.fromCharCode(i)),64!==o&&(l+=String.fromCharCode(r))}while(u<e.length);return l};function dt(e){if(J(e))return function(e){if("boolean"==typeof s&&s){var t;try{t=Buffer.from(e,"base64")}catch(i){t=new Buffer(e,"base64")}return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}try{for(var i=ht(e),r=new Uint8Array(i.length),n=0;n<i.length;++n)r[n]=i.charCodeAt(n);return r}catch(e){throw new Error("Converting base64 string to bytes failed.")}}(e.slice(Z.length))}var pt={A:function(e,t,i){B.copyWithin(e,t,t+i)},B:function(e){X("OOM")},C:function(){X("trap!")},D:22368,a:X,b:function(e){v=e},c:function(){return v},d:function(e){return _t(e)},e:function(e){var t=Y[e];return t&&!t.caught&&(t.caught=!0,vt.uncaught_exceptions--),t&&(t.rethrown=!1),q($(e)),e},f:function(e,t,i){throw Y[e]={ptr:e,adjusted:[e],type:t,destructor:i,refcount:0,caught:!1,rethrown:!1},"uncaught_exception"in vt?vt.uncaught_exceptions++:vt.uncaught_exceptions=1,e},g:function(){return vt.uncaught_exceptions},h:q,i:$,j:function(){},k:function(e,t,i,r,n){var s=ee(i);pe(e,{name:t=ie(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:n},argPackAdvance:8,readValueFromPointer:function(e){var r;if(1===i)r=w;else if(2===i)r=x;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);r=M}return this.fromWireType(r[e>>s])},destructorFunction:null})},l:function(e,i,r,n,s,o,a,l,u,A,c,h,d){c=ie(c),o=Ze(s,o),l&&(l=Ze(a,l)),A&&(A=Ze(u,A)),d=Ze(h,d);var p=oe(c);!function(e,i,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].overloadTable&&void 0!==t[e].overloadTable[r])&&Ae("Cannot register public name '"+e+"' twice"),Ee(t,e,e),t.hasOwnProperty(r)&&Ae("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].overloadTable[r]=i):(t[e]=i,void 0!==r&&(t[e].numArguments=r))}(p,(function(){qe("Cannot construct "+c+" due to unbound types",[n])})),de([e,i,r],n?[n]:[],(function(i){var r,s;i=i[0],s=n?(r=i.registeredClass).instancePrototype:Fe.prototype;var a=ae(p,(function(){if(Object.getPrototypeOf(this)!==u)throw new ue("Use 'new' to construct "+c);if(void 0===h.constructor_body)throw new ue(c+" has no accessible constructor");var e=h.constructor_body[arguments.length];if(void 0===e)throw new ue("Tried to invoke ctor of "+c+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(h.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),u=Object.create(s,{constructor:{value:a}});a.prototype=u;var h=new Ie(c,a,u,d,r,o,l,A),f=new Ke(c,h,!0,!1,!1),v=new Ke(c+"*",h,!1,!1,!1),g=new Ke(c+" const*",h,!1,!0,!1);return ke[e]={pointerType:v,constPointerType:g},function(e,i,r){t.hasOwnProperty(e)||he("Replacing nonexistant public symbol"),void 0!==t[e].overloadTable&&void 0!==r?t[e].overloadTable[r]=i:(t[e]=i,t[e].argCount=r)}(p,a),[f,v,g]}))},m:function(e,t,i,r,n,s){m(t>0);var o=$e(t,i);n=Ze(r,n);var a=[s],l=[];de([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ue("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){qe("Cannot construct "+e.name+" due to unbound types",o)},de([],o,(function(r){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&Ae(i+" called with "+arguments.length+" arguments, expected "+(t-1)),l.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=r[e].toWireType(l,arguments[e-1]);var s=n.apply(null,a);return et(l),r[0].fromWireType(s)},[]})),[]}))},n:function(e,t,i,r,n,s,o,a){var l=$e(i,r);t=ie(t),s=Ze(n,s),de([],[e],(function(e){var r=(e=e[0]).name+"."+t;function n(){qe("Cannot call "+r+" due to unbound types",l)}a&&e.registeredClass.pureVirtualFunctions.push(t);var u=e.registeredClass.instancePrototype,A=u[t];return void 0===A||void 0===A.overloadTable&&A.className!==e.name&&A.argCount===i-2?(n.argCount=i-2,n.className=e.name,u[t]=n):(Ee(u,t,r),u[t].overloadTable[i-2]=n),de([],l,(function(n){var a=tt(r,n,e,s,o);return void 0===u[t].overloadTable?(a.argCount=i-2,u[t]=a):u[t].overloadTable[i-2]=a,[]})),[]}))},o:function(e,t){pe(e,{name:t=ie(t),fromWireType:function(e){var t=rt[e].value;return nt(e),t},toWireType:function(e,t){return at(t)},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:null})},p:function(e,t,i){var r=ee(i);pe(e,{name:t=ie(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+lt(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:ut(t,r),destructorFunction:null})},q:function(e,t,i,r,n){t=ie(t),-1===n&&(n=4294967295);var s=ee(i),o=function(e){return e};if(0===r){var a=32-8*i;o=function(e){return e<<a>>>a}}var l=-1!=t.indexOf("unsigned");pe(e,{name:t,fromWireType:o,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+lt(i)+'" to '+this.name);if(i<r||i>n)throw new TypeError('Passing a number "'+lt(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+n+"]!");return l?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:At(t,s,0!==r),destructorFunction:null})},r:function(e,t,i){var r=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function n(e){var t=F,i=t[e>>=2],n=t[e+1];return new r(b,n,i)}pe(e,{name:i=ie(i),fromWireType:n,argPackAdvance:8,readValueFromPointer:n},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var i="std::string"===(t=ie(t));pe(e,{name:t,fromWireType:function(e){var t,r=F[e>>2];if(i)for(var n=e+4,s=0;s<=r;++s){var o=e+4+s;if(0==B[o]||s==r){var a=y(n,o-n);void 0===t?t=a:(t+=String.fromCharCode(0),t+=a),n=o+1}}else{var l=new Array(r);for(s=0;s<r;++s)l[s]=String.fromCharCode(B[e+4+s]);t=l.join("")}return mt(e),t},toWireType:function(e,t){var r;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n="string"==typeof t;n||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||Ae("Cannot pass non-string to std::string"),r=i&&n?function(){return function(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++i)),r<=127?++t:t+=r<=2047?2:r<=65535?3:4}return t}(t)}:function(){return t.length};var s=r(),o=_t(4+s+1);if(F[o>>2]=s,i&&n)(function(e,t,i,r){if(!(r>0))return 0;for(var n=i,s=i+r-1,o=0;o<e.length;++o){var a=e.charCodeAt(o);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++o)),a<=127){if(i>=s)break;t[i++]=a}else if(a<=2047){if(i+1>=s)break;t[i++]=192|a>>6,t[i++]=128|63&a}else if(a<=65535){if(i+2>=s)break;t[i++]=224|a>>12,t[i++]=128|a>>6&63,t[i++]=128|63&a}else{if(i+3>=s)break;t[i++]=240|a>>18,t[i++]=128|a>>12&63,t[i++]=128|a>>6&63,t[i++]=128|63&a}}t[i]=0})(t,B,o+4,s+1);else if(n)for(var a=0;a<s;++a){var l=t.charCodeAt(a);l>255&&(mt(o),Ae("String has UTF-16 code units that do not fit in 8 bits")),B[o+4+a]=l}else for(a=0;a<s;++a)B[o+4+a]=t[a];return null!==e&&e.push(mt,o),o},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){mt(e)}})},t:function(e,t,i){var r,n,s,o,a;i=ie(i),2===t?(r=T,n=D,o=S,s=function(){return C},a=1):4===t&&(r=R,n=U,o=L,s=function(){return F},a=2),pe(e,{name:i,fromWireType:function(e){for(var i,n=F[e>>2],o=s(),l=e+4,u=0;u<=n;++u){var A=e+4+u*t;if(0==o[A>>a]||u==n){var c=r(l,A-l);void 0===i?i=c:(i+=String.fromCharCode(0),i+=c),l=A+t}}return mt(e),i},toWireType:function(e,r){"string"!=typeof r&&Ae("Cannot pass non-string to C++ string type "+i);var s=o(r),l=_t(4+s+t);return F[l>>2]=s>>a,n(r,l+4,s+t),null!==e&&e.push(mt,l),l},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){mt(e)}})},u:function(e,t){pe(e,{isVoid:!0,name:t=ie(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},v:nt,w:at,x:function(){X()},y:lt,z:function(){return B.length}},ft=function(e,t,i){"use asm";var r=new e.Int8Array(i),n=new e.Int16Array(i),s=new e.Int32Array(i),o=new e.Uint8Array(i),a=new e.Uint16Array(i),l=new e.Float32Array(i),u=new e.Float64Array(i),A=t.D|0,c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0.0,_=e.Math.imul,y=e.Math.clz32,b=t.a,w=t.b,B=t.c,x=t.d,P=t.e,C=t.f,M=t.g,F=t.h,k=t.i,E=t.j,I=t.k,T=t.l,D=t.m,S=t.n,R=t.o,U=t.p,L=t.q,O=t.r,N=t.s,V=t.t,Q=t.u,H=t.v,G=t.w,j=t.x,z=t.y,W=t.z,X=t.A,K=t.B,Z=t.C,J=22384,Y=5265264,q=0.0;function $(){Jc();Yc()}function ee(){te(0);return}function te(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0;e=J;J=J+16|0;t=e+8|0;i=e;dA();h=fA()|0;o=vA()|0;n=mA()|0;a=_A()|0;l=yA()|0;u=bA()|0;A=MA()|0;c=FA()|0;r=FA()|0;T(n|0,a|0,l|0,u|0,A|0,9,c|0,h|0,r|0,o|0,6204,kA()|0,138);IA(1);s[i>>2]=5;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];OA(6211,t);s[i>>2]=3;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];KA(6216,t);s[i>>2]=10;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];ic(6225,t);Ac();o=hc()|0;r=dc()|0;h=fc()|0;c=vc()|0;A=gc()|0;u=bA()|0;l=MA()|0;a=FA()|0;n=FA()|0;T(h|0,c|0,A|0,u|0,l|0,11,a|0,o|0,n|0,r|0,6234,kA()|0,139);xc(2);s[i>>2]=6;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];Ic(6211,t);s[i>>2]=4;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];Oc(6248,t);s[i>>2]=5;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];Oc(6265,t);s[i>>2]=6;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];Oc(6280,t);s[i>>2]=7;s[i+4>>2]=0;s[t>>2]=s[i>>2];s[t+4>>2]=s[i+4>>2];jc(6216,t);J=e;return}function ie(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0,l=0;r=J;J=J+32|0;a=r+16|0;n=r+8|0;l=r;o=Zf(20)|0;Ae(o,t,i);s[l>>2]=0;s[a>>2]=s[l>>2];he(n,o,a);t=s[n>>2]|0;s[n>>2]=s[e>>2];s[e>>2]=t;t=n+4|0;i=e+4|0;o=s[t>>2]|0;s[t>>2]=s[i>>2];s[i>>2]=o;de(n);i=Zf(352)|0;ce(i,s[e>>2]|0);o=e+8|0;s[l>>2]=0;s[a>>2]=s[l>>2];we(n,i,a);i=s[n>>2]|0;s[n>>2]=s[o>>2];s[o>>2]=i;o=n+4|0;i=e+12|0;t=s[o>>2]|0;s[o>>2]=s[i>>2];s[i>>2]=t;Be(n);J=r;return}function re(e,t){e=e|0;t=t|0;Ki(s[e+8>>2]|0,t);return}function ne(e){e=e|0;e=(Sa(s[e+8>>2]|0)|0)+107|0;return o[e>>0]|o[e+1>>0]<<8|o[e+2>>0]<<16|o[e+3>>0]<<24|0}function se(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0,l=0;r=J;J=J+32|0;o=r+16|0;n=r+8|0;a=r;l=Zf(12)|0;Ra(l,t,i);s[a>>2]=0;s[o>>2]=s[a>>2];Na(n,l,o);l=s[n>>2]|0;s[n>>2]=s[e>>2];s[e>>2]=l;l=n+4|0;i=e+4|0;t=s[l>>2]|0;s[l>>2]=s[i>>2];s[i>>2]=t;Va(n);i=e+8|0;t=Zf(12)|0;Ua(t,s[e>>2]|0);s[a>>2]=0;s[o>>2]=s[a>>2];Wa(n,t,o);t=s[n>>2]|0;s[n>>2]=s[i>>2];s[i>>2]=t;t=n+4|0;a=e+12|0;l=s[t>>2]|0;s[t>>2]=s[a>>2];s[a>>2]=l;Xa(n);La(n,s[i>>2]|0);i=e+16|0;a=s[n>>2]|0;l=n+4|0;t=s[l>>2]|0;s[n>>2]=0;s[l>>2]=0;s[o>>2]=s[i>>2];s[i>>2]=a;i=e+20|0;s[o+4>>2]=s[i>>2];s[i>>2]=t;Oa(o);Oa(n);J=r;return}function oe(e,t){e=e|0;t=t|0;var i=0;e=e+16|0;i=s[e>>2]|0;e:do{if(i|0)switch(t|0){case 4:{hl(i);break e}case 8:{dl(i);dl(s[e>>2]|0);break e}default:break e}}while(0);return}function ae(e,t){e=e|0;t=t|0;var i=0;i=e+16|0;e=s[i>>2]|0;e:do{if(e|0){switch(t|0){case 1:{$l(e);break e}case 2:{eu(e);break e}case 8:{hl(e);e=s[i>>2]|0;break}case 4:break;default:break e}hl(e)}}while(0);return}function le(e,t){e=e|0;t=t|0;var i=0;i=e+16|0;e=s[i>>2]|0;e:do{if(e|0){switch(t|0){case 1:{Ru(e);break e}case 2:{Uu(e);break e}case 8:{dl(e);e=s[i>>2]|0;break}case 4:break;default:break e}dl(e)}}while(0);return}function ue(e,t){e=e|0;t=t|0;e=s[e+16>>2]|0;if(e|0)Qg[s[s[e>>2]>>2]&63](e,t)|0;return}function Ae(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;s[e+4>>2]=i;s[e+8>>2]=0;r[e+12>>0]=0;r[e+13>>0]=0;s[e+16>>2]=0;return}function ce(e,t){e=e|0;t=t|0;s[e>>2]=t;Oe(e+4|0,t);Ne(e+247|0);s[e+288>>2]=0;s[e+292>>2]=0;s[e+296>>2]=0;Ve(e+300|0);t=e+312|0;s[t>>2]=0;s[t+4>>2]=0;s[t+8>>2]=0;s[t+12>>2]=0;Qe(e+328|0);He(e);return}function he(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4296;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;pe(e,r);J=i;return}function de(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function pe(e,t){e=e|0;t=t|0;return}function fe(e){e=e|0;P(e|0)|0;tf()}function ve(e){e=e|0;ov(e);$p(e);return}function ge(e){e=e|0;e=s[e+12>>2]|0;if(e|0)$p(e);return}function me(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==6407?e+12|0:0)|0}function _e(e){e=e|0;ye(e,16);return}function ye(e,t){e=e|0;t=t|0;be(e);return}function be(e){e=e|0;$p(e);return}function we(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4324;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;xe(e,r);J=i;return}function Be(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function xe(e,t){e=e|0;t=t|0;return}function Pe(e){e=e|0;ov(e);$p(e);return}function Ce(e){e=e|0;e=s[e+12>>2]|0;if(e|0){ke(e);$p(e)}return}function Me(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==6605?e+12|0:0)|0}function Fe(e){e=e|0;ye(e,16);return}function ke(e){e=e|0;Ee(e+320|0);Ie(e+312|0);Te(e+300|0);Ue(e+288|0);De(e+247|0);Se(e+4|0);return}function Ee(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Ie(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Te(e){e=e|0;Re(e);return}function De(e){e=e|0;e=e+34|0;e=o[e>>0]|o[e+1>>0]<<8|o[e+2>>0]<<16|o[e+3>>0]<<24;if(e|0)Yf(e);return}function Se(e){e=e|0;Le(s[e+12>>2]|0);return}function Re(e){e=e|0;var t=0,i=0;t=s[e>>2]|0;i=t;if(t|0){s[e+4>>2]=i;ye(t,(s[e+8>>2]|0)-i|0)}return}function Ue(e){e=e|0;var t=0,i=0;t=s[e>>2]|0;i=t;if(t|0){s[e+4>>2]=i;ye(t,(s[e+8>>2]|0)-i|0)}return}function Le(e){e=e|0;Zv(s[e+-4>>2]|0);return}function Oe(e,t){e=e|0;t=t|0;s[e>>2]=t;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=Ge(1048576)|0;return}function Ne(e){e=e|0;var t=0;t=e+32|0;r[t>>0]=0;r[t+1>>0]=0;e=e+34|0;r[e>>0]=0;r[e+1>>0]=0;r[e+2>>0]=0;r[e+3>>0]=0;return}function Ve(e){e=e|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;return}function Qe(e){e=e|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;e=e+16|0;s[e>>2]=-1;s[e+4>>2]=-1;return}function He(e){e=e|0;var t=0,i=0,n=0,o=0,a=0,l=0;l=J;J=J+64|0;o=l+32|0;i=l+56|0;t=l+16|0;a=l;je(s[e>>2]|0,i,4);rt(o,i,i+4|0);i=it(6693)|0;n=r[o+11>>0]|0;if((i|0)==((n<<24>>24<0?s[o+4>>2]|0:n&255)|0)){n=(xv(o,0,-1,6693,i)|0)==0;_v(o);if(n){i=s[e>>2]|0;s[t>>2]=0;s[t+4>>2]=0;s[t+8>>2]=0;s[t+12>>2]=0;s[o>>2]=s[t>>2];s[o+4>>2]=s[t+4>>2];s[o+8>>2]=s[t+8>>2];s[o+12>>2]=s[t+12>>2];We(i,o);i=e+20|0;je(s[e>>2]|0,i,227);Xe(e,i);n=Ke()|0;t=s[n>>2]|0;n=s[n+4>>2]|0;if((t|0)!=(n|0))do{Ze(o,t);Je(o,i);Ye(o);t=t+24|0}while((t|0)!=(n|0));qe(e);$e(e);et(s[e>>2]|0);n=s[e>>2]|0;t=(s[e+116>>2]|0)+8|0;i=a;s[i>>2]=0;s[i+4>>2]=0;i=a+8|0;s[i>>2]=t;s[i+4>>2]=0;s[o>>2]=s[a>>2];s[o+4>>2]=s[a+4>>2];s[o+8>>2]=s[a+8>>2];s[o+12>>2]=s[a+12>>2];We(n,o);tt(e+4|0);J=l;return}}else _v(o);l=x(8)|0;ze(l);C(l|0,2592,8)}function Ge(e){e=e|0;var t=0;t=Kv(e+68|0)|0;e=t+68&-64;s[e+-4>>2]=t;return e|0}function je(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0,A=0;l=e+13|0;if(!(r[l>>0]|0)){a=e+4|0;n=s[a>>2]|0;u=e+8|0;o=s[u>>2]|0;A=n-o|0;i=(A|0)<(i|0)?A:i;if(i){hg(t|0,(s[e>>2]|0)+o|0,i|0)|0;o=s[u>>2]|0;n=s[a>>2]|0}A=o+i|0;s[u>>2]=A;s[e+16>>2]=i;if((A|0)>=(n|0))r[l>>0]=1}else r[e+12>>0]=1;return}function ze(e){e=e|0;pv(e,6791);s[e>>2]=4352;return}function We(e,t){e=e|0;t=t|0;var i=0,n=0,o=0;o=t+8|0;t=s[o>>2]|0;o=s[o+4>>2]|0;i=s[e+4>>2]|0;n=((i|0)<0)<<31>>31;if((o|0)<(n|0)|(o|0)==(n|0)&t>>>0<i>>>0)s[e+8>>2]=t;else r[e+12>>0]=1;return}function Xe(e,t){e=e|0;t=t|0;var i=0.0,n=0.0,s=0,o=0.0,a=0,l=0.0,c=0,h=0.0,d=0,p=0.0;d=t+179|0;r[A>>0]=r[d>>0];r[A+1>>0]=r[d+1>>0];r[A+2>>0]=r[d+2>>0];r[A+3>>0]=r[d+3>>0];r[A+4>>0]=r[d+4>>0];r[A+5>>0]=r[d+5>>0];r[A+6>>0]=r[d+6>>0];r[A+7>>0]=r[d+7>>0];h=+u[A>>3];a=t+187|0;r[A>>0]=r[a>>0];r[A+1>>0]=r[a+1>>0];r[A+2>>0]=r[a+2>>0];r[A+3>>0]=r[a+3>>0];r[A+4>>0]=r[a+4>>0];r[A+5>>0]=r[a+5>>0];r[A+6>>0]=r[a+6>>0];r[A+7>>0]=r[a+7>>0];p=+u[A>>3];e=t+195|0;r[A>>0]=r[e>>0];r[A+1>>0]=r[e+1>>0];r[A+2>>0]=r[e+2>>0];r[A+3>>0]=r[e+3>>0];r[A+4>>0]=r[e+4>>0];r[A+5>>0]=r[e+5>>0];r[A+6>>0]=r[e+6>>0];r[A+7>>0]=r[e+7>>0];o=+u[A>>3];c=t+203|0;r[A>>0]=r[c>>0];r[A+1>>0]=r[c+1>>0];r[A+2>>0]=r[c+2>>0];r[A+3>>0]=r[c+3>>0];r[A+4>>0]=r[c+4>>0];r[A+5>>0]=r[c+5>>0];r[A+6>>0]=r[c+6>>0];r[A+7>>0]=r[c+7>>0];l=+u[A>>3];s=t+211|0;r[A>>0]=r[s>>0];r[A+1>>0]=r[s+1>>0];r[A+2>>0]=r[s+2>>0];r[A+3>>0]=r[s+3>>0];r[A+4>>0]=r[s+4>>0];r[A+5>>0]=r[s+5>>0];r[A+6>>0]=r[s+6>>0];r[A+7>>0]=r[s+7>>0];i=+u[A>>3];t=t+219|0;r[A>>0]=r[t>>0];r[A+1>>0]=r[t+1>>0];r[A+2>>0]=r[t+2>>0];r[A+3>>0]=r[t+3>>0];r[A+4>>0]=r[t+4>>0];r[A+5>>0]=r[t+5>>0];r[A+6>>0]=r[t+6>>0];r[A+7>>0]=r[t+7>>0];n=+u[A>>3];u[A>>3]=p;r[d>>0]=r[A>>0];r[d+1>>0]=r[A+1>>0];r[d+2>>0]=r[A+2>>0];r[d+3>>0]=r[A+3>>0];r[d+4>>0]=r[A+4>>0];r[d+5>>0]=r[A+5>>0];r[d+6>>0]=r[A+6>>0];r[d+7>>0]=r[A+7>>0];u[A>>3]=h;r[c>>0]=r[A>>0];r[c+1>>0]=r[A+1>>0];r[c+2>>0]=r[A+2>>0];r[c+3>>0]=r[A+3>>0];r[c+4>>0]=r[A+4>>0];r[c+5>>0]=r[A+5>>0];r[c+6>>0]=r[A+6>>0];r[c+7>>0]=r[A+7>>0];u[A>>3]=l;r[a>>0]=r[A>>0];r[a+1>>0]=r[A+1>>0];r[a+2>>0]=r[A+2>>0];r[a+3>>0]=r[A+3>>0];r[a+4>>0]=r[A+4>>0];r[a+5>>0]=r[A+5>>0];r[a+6>>0]=r[A+6>>0];r[a+7>>0]=r[A+7>>0];u[A>>3]=o;r[s>>0]=r[A>>0];r[s+1>>0]=r[A+1>>0];r[s+2>>0]=r[A+2>>0];r[s+3>>0]=r[A+3>>0];r[s+4>>0]=r[A+4>>0];r[s+5>>0]=r[A+5>>0];r[s+6>>0]=r[A+6>>0];r[s+7>>0]=r[A+7>>0];u[A>>3]=n;r[e>>0]=r[A>>0];r[e+1>>0]=r[A+1>>0];r[e+2>>0]=r[A+2>>0];r[e+3>>0]=r[A+3>>0];r[e+4>>0]=r[A+4>>0];r[e+5>>0]=r[A+5>>0];r[e+6>>0]=r[A+6>>0];r[e+7>>0]=r[A+7>>0];u[A>>3]=i;r[t>>0]=r[A>>0];r[t+1>>0]=r[A+1>>0];r[t+2>>0]=r[A+2>>0];r[t+3>>0]=r[A+3>>0];r[t+4>>0]=r[A+4>>0];r[t+5>>0]=r[A+5>>0];r[t+6>>0]=r[A+6>>0];r[t+7>>0]=r[A+7>>0];return}function Ke(){var e=0,t=0,i=0,n=0,o=0,a=0,l=0,u=0;o=J;J=J+48|0;i=o+24|0;n=o;e=o+44|0;if((r[21440]|0)==0?Uf(21440)|0:0){s[5374]=0;s[5375]=0;s[5376]=0;jf(21440)}if((r[21448]|0)==0?Uf(21448)|0:0)jf(21448);if((s[5374]|0)==(s[5375]|0)){lv(21508);if((s[5374]|0)==(s[5375]|0)){r[i>>0]=r[e>>0]|0;ot(n,i);e=s[5375]|0;do{if(e>>>0>=(s[5376]|0)>>>0){e=((e-(s[5374]|0)|0)/24|0)+1|0;t=pt(21496)|0;if(t>>>0<e>>>0)Xv(21496);else{a=s[5374]|0;u=((s[5376]|0)-a|0)/24|0;l=u<<1;ct(i,u>>>0<t>>>1>>>0?l>>>0<e>>>0?e:l:t,((s[5375]|0)-a|0)/24|0,21504);t=i+8|0;ut(s[t>>2]|0,n);s[t>>2]=(s[t>>2]|0)+24;ht(21496,i);dt(i);break}}else{at(i,21496,1);u=i+4|0;ut(s[u>>2]|0,n);s[u>>2]=(s[u>>2]|0)+24;lt(i)}}while(0);Ye(n)}uv(21508)}J=o;return 21496}function Ze(e,t){e=e|0;t=t|0;var i=0,r=0;i=t+16|0;r=s[i>>2]|0;do{if(r){if((t|0)==(r|0)){r=At(e)|0;s[e+16>>2]=r;i=s[i>>2]|0;zg[s[(s[i>>2]|0)+12>>2]&15](i,r);break}else{s[e+16>>2]=Ng[s[(s[r>>2]|0)+8>>2]&15](r)|0;break}}else s[e+16>>2]=0}while(0);return}function Je(e,t){e=e|0;t=t|0;e=s[e+16>>2]|0;if(!e){t=x(4)|0;s[t>>2]=0;Et(t);C(t|0,4168,131)}else{zg[s[(s[e>>2]|0)+24>>2]&15](e,t);return}}function Ye(e){e=e|0;var t=0;t=s[e+16>>2]|0;if((e|0)!=(t|0)){if(t|0)jg[s[(s[t>>2]|0)+20>>2]&255](t)}else jg[s[(s[t>>2]|0)+16>>2]&255](t);return}function qe(e){e=e|0;var t=0,i=0,n=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;v=J;J=J+96|0;l=v+16|0;p=v;c=v+72|0;u=s[e>>2]|0;h=a[e+114>>1]|0;d=p;s[d>>2]=0;s[d+4>>2]=0;d=p+8|0;s[d>>2]=h;s[d+4>>2]=0;s[l>>2]=s[p>>2];s[l+4>>2]=s[p+4>>2];s[l+8>>2]=s[p+8>>2];s[l+12>>2]=s[p+12>>2];We(u,l);u=e+120|0;e:do{if(s[u>>2]|0){A=l+2|0;h=l+16|0;d=l+20|0;p=l+18|0;i=0;while(1){if(!(It(s[e>>2]|0)|0))break e;if(Tt(s[e>>2]|0)|0)break e;je(s[e>>2]|0,l,54);t=7277;n=A;while(1){if((r[n>>0]|0)!=(r[t>>0]|0))break;n=n+1|0;if((n|0)==(h|0)){f=8;break}else t=t+1|0}if((f|0)==8?(f=0,(o[p>>0]|o[p+1>>0]<<8)<<16>>16==22204):0)break;St(s[e>>2]|0,(o[d>>0]|o[d+1>>0]<<8)&65535,0,1);i=i+1|0;if(i>>>0>=(s[u>>2]|0)>>>0)break e}p=(o[d>>0]|o[d+1>>0]<<8)&65535;f=Jf(p)|0;je(s[e>>2]|0,f,p);Dt(e,f);$p(f);f=e+125|0;Ut(c,e+247|0,(o[f>>0]|o[f+1>>0]<<8)&65535);Lt(e+300|0,c)|0;Te(c);J=v;return}}while(0);v=x(8)|0;Rt(v);C(v|0,2672,8)}function $e(e){e=e|0;var t=0,i=0,r=0,n=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;d=J;J=J+176|0;n=d+40|0;a=d+24|0;t=d+16|0;r=d;A=d+152|0;c=d+136|0;h=d+56|0;u=s[e>>2]|0;l=e+116|0;p=s[l>>2]|0;i=a;s[i>>2]=0;s[i+4>>2]=0;i=a+8|0;s[i>>2]=p;s[i+4>>2]=0;s[n>>2]=s[a>>2];s[n+4>>2]=s[a+4>>2];s[n+8>>2]=s[a+8>>2];s[n+12>>2]=s[a+12>>2];We(u,n);u=t;s[u>>2]=0;s[u+4>>2]=0;je(s[e>>2]|0,t,8);if(!(It(s[e>>2]|0)|0)){p=x(8)|0;qt(p);C(p|0,2704,8)}i=t;t=s[i>>2]|0;i=s[i+4>>2]|0;if((t|0)==-1&(i|0)==-1){p=x(8)|0;$t(p,7488);C(p|0,2720,8)}p=s[e>>2]|0;u=r;s[u>>2]=0;s[u+4>>2]=0;u=r+8|0;s[u>>2]=t;s[u+4>>2]=i;s[n>>2]=s[r>>2];s[n+4>>2]=s[r+4>>2];s[n+8>>2]=s[r+8>>2];s[n+12>>2]=s[r+12>>2];We(p,n);if(!(It(s[e>>2]|0)|0)){p=x(8)|0;qt(p);C(p|0,2704,8)}je(s[e>>2]|0,n,8);if(!(It(s[e>>2]|0)|0)){p=x(8)|0;qt(p);C(p|0,2704,8)}if(s[n>>2]|0){p=x(8)|0;ei(p);C(p|0,2736,8)}a=e+288|0;u=e+292|0;s[u>>2]=s[a>>2];p=e+259|0;if((o[p>>0]|o[p+1>>0]<<8|o[p+2>>0]<<16|o[p+3>>0]<<24|0)==-1){p=x(8)|0;$t(p,7606);C(p|0,2720,8)}r=n+4|0;ti(a,(s[r>>2]|0)+1|0);p=s[a>>2]|0;s[p>>2]=(s[l>>2]|0)+8;s[p+4>>2]=0;if((s[r>>2]|0)>>>0>1){Oe(A,s[e>>2]|0);ii(c,A);ri(h,32,2,8,0);ni(c);si(h);if(!(s[r>>2]|0)){a=s[a>>2]|0;i=a}else{i=1;do{if(i>>>0>1)t=s[(s[a>>2]|0)+(i+-1<<3)>>2]|0;else t=0;l=oi(h,c,t,1)|0;t=s[a>>2]|0;p=t+(i<<3)|0;s[p>>2]=l;s[p+4>>2]=((l|0)<0)<<31>>31;i=i+1|0}while(i>>>0<=(s[r>>2]|0)>>>0);i=t;a=t}t=s[u>>2]|0;if(t-i>>3>>>0>1){n=t-a>>3;r=a;t=1;i=s[r>>2]|0;r=s[r+4>>2]|0;do{p=a+(t<<3)|0;u=p;i=ig(s[u>>2]|0,s[u+4>>2]|0,i|0,r|0)|0;r=B()|0;s[p>>2]=i;s[p+4>>2]=r;t=t+1|0}while(t>>>0<n>>>0)}ai(h);li(c);Se(A)}J=d;return}function et(e){e=e|0;r[e+12>>0]=0;r[e+13>>0]=0;return}function tt(e){e=e|0;s[e+8>>2]=0;s[e+4>>2]=0;return}function it(e){e=e|0;return Zd(e)|0}function rt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0,A=0;l=J;J=J+16|0;o=t;a=l;n=i-o|0;if(n>>>0>4294967279)fv(e);if(n>>>0<11)r[e+11>>0]=n;else{A=n+16&-16;u=Zf(A)|0;s[e>>2]=u;s[e+8>>2]=A|-2147483648;s[e+4>>2]=n;e=u}if((t|0)!=(i|0)){o=i-o|0;n=e;while(1){nt(n,t);t=t+1|0;if((t|0)==(i|0))break;else n=n+1|0}e=e+o|0}r[a>>0]=0;nt(e,a);J=l;return}function nt(e,t){e=e|0;t=t|0;r[e>>0]=r[t>>0]|0;return}function st(e){e=e|0;ff(e);$p(e);return}function ot(e,t){e=e|0;t=t|0;s[e>>2]=4372;s[e+16>>2]=e;return}function at(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+(i*24|0);return}function lt(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function ut(e,t){e=e|0;t=t|0;var i=0,r=0;i=t+16|0;r=s[i>>2]|0;do{if(r){if((t|0)==(r|0)){r=At(e)|0;s[e+16>>2]=r;i=s[i>>2]|0;zg[s[(s[i>>2]|0)+12>>2]&15](i,r);break}else{s[e+16>>2]=r;s[i>>2]=0;break}}else s[e+16>>2]=0}while(0);return}function At(e){e=e|0;return e|0}function ct(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>178956970){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t*24|0)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i*24|0)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t*24|0);return}function ht(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0;l=s[e>>2]|0;u=e+4|0;i=s[u>>2]|0;a=t+4|0;if((i|0)==(l|0)){n=a;o=e;r=s[a>>2]|0;i=l}else{r=s[a>>2]|0;do{i=i+-24|0;ut(r+-24|0,i);r=(s[a>>2]|0)+-24|0;s[a>>2]=r}while((i|0)!=(l|0));n=a;o=e;i=s[e>>2]|0}s[o>>2]=r;s[n>>2]=i;l=t+8|0;a=s[u>>2]|0;s[u>>2]=s[l>>2];s[l>>2]=a;l=e+8|0;u=t+12|0;e=s[l>>2]|0;s[l>>2]=s[u>>2];s[u>>2]=e;s[t>>2]=s[n>>2];return}function dt(e){e=e|0;var t=0,i=0,r=0,n=0;i=s[e+4>>2]|0;r=e+8|0;t=s[r>>2]|0;if((t|0)!=(i|0))do{n=t+-24|0;s[r>>2]=n;Ye(n);t=s[r>>2]|0}while((t|0)!=(i|0));t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function pt(e){e=e|0;return 178956970}function ft(e){e=e|0;$p(e);return}function vt(e){e=e|0;e=Zf(8)|0;s[e>>2]=4372;return e|0}function gt(e,t){e=e|0;t=t|0;s[t>>2]=4372;return}function mt(e){e=e|0;return}function _t(e){e=e|0;ye(e,8);return}function yt(e,t){e=e|0;t=t|0;xt(e+4|0,t);return}function bt(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==7183?e+4|0:0)|0}function wt(e){e=e|0;return 2664}function Bt(e){e=e|0;return}function xt(e,t){e=e|0;t=t|0;Pt(e,t);return}function Pt(e,t){e=e|0;t=t|0;var i=0,n=0;e=t+104|0;t=o[e>>0]|0;i=t>>>7;n=t>>>6&1;if((i|0)==1&(n|0)!=0){n=x(8)|0;Ct(n);C(n|0,2632,8)}if((i|0)==(n|0)){n=x(8)|0;Mt(n);C(n|0,2648,8)}else{r[e>>0]=t&63;return}}function Ct(e){e=e|0;pv(e,7076);s[e>>2]=4416;return}function Mt(e){e=e|0;pv(e,7144);s[e>>2]=4436;return}function Ft(e){e=e|0;ff(e);$p(e);return}function kt(e){e=e|0;ff(e);$p(e);return}function Et(e){e=e|0;s[e>>2]=6092;return}function It(e){e=e|0;var t=0;t=e+12|0;e=(r[t>>0]|0)==0;r[t>>0]=0;return e|0}function Tt(e){e=e|0;return(r[e+13>>0]|0)!=0|0}function Dt(e,t){e=e|0;t=t|0;e=e+247|0;Ot(e,t);if((o[e>>0]|o[e+1>>0]<<8)<<16>>16==2)return;else{t=x(8)|0;Nt(t);C(t|0,2688,8)}}function St(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var o=0,a=0;switch(n|0){case 0:break;case 2:{n=s[e+4>>2]|0;t=ig(ig(t|0,i|0,-1,-1)|0,B()|0,n|0,((n|0)<0)<<31>>31|0)|0;i=B()|0;break}case 1:{n=s[e+8>>2]|0;t=ig(n|0,((n|0)<0)<<31>>31|0,t|0,i|0)|0;i=B()|0;break}default:{i=0;t=0}}o=s[e+4>>2]|0;a=((o|0)<0)<<31>>31;n=e+12|0;if((i|0)<0|((i|0)>(a|0)|(i|0)==(a|0)&t>>>0>=o>>>0))r[n>>0]=1;else{r[n>>0]=0;s[e+8>>2]=t}return}function Rt(e){e=e|0;pv(e,7410);s[e>>2]=4476;return}function Ut(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,s=0,a=0,l=0,u=0,A=0;a=J;J=J+16|0;s=a;Ve(e);n=t+32|0;if((o[n>>0]|o[n+1>>0]<<8)<<16>>16){r=t+34|0;t=0;do{u=o[r>>0]|o[r+1>>0]<<8|o[r+2>>0]<<16|o[r+3>>0]<<24;A=u+(t*6|0)|0;l=u+(t*6|0)+2|0;u=u+(t*6|0)+4|0;Gt(s,(o[A>>0]|o[A+1>>0]<<8)&65535,(o[l>>0]|o[l+1>>0]<<8)&65535,(o[u>>0]|o[u+1>>0]<<8)&65535);Ht(e,s);i=i-((o[l>>0]|o[l+1>>0]<<8)&65535)|0;t=t+1|0}while(t>>>0<((o[n>>0]|o[n+1>>0]<<8)&65535)>>>0)}if((i|0)<0){A=x(8)|0;Nt(A);C(A|0,2688,8)}if(i|0){Gt(s,0,i,2);Ht(e,s)}J=a;return}function Lt(e,t){e=e|0;t=t|0;var i=0,n=0;i=J;J=J+16|0;n=i+1|0;r[n>>0]=r[i>>0]|0;Jt(e,t,n);J=i;return e|0}function Ot(e,t){e=e|0;t=t|0;var i=0,n=0,s=0,a=0,l=0,u=0,A=0;n=t+2|0;a=o[t>>0]|o[t+1>>0]<<8;r[e>>0]=a;r[e+1>>0]=a>>8;a=e+2|0;n=o[n>>0]|o[n+1>>0]<<8;r[a>>0]=n;r[a+1>>0]=n>>8;r[e+4>>0]=r[t+4>>0]|0;a=t+6|0;r[e+5>>0]=r[t+5>>0]|0;n=t+8|0;i=e+6|0;a=o[a>>0]|o[a+1>>0]<<8;r[i>>0]=a;r[i+1>>0]=a>>8;i=t+12|0;a=e+8|0;n=o[n>>0]|o[n+1>>0]<<8|o[n+2>>0]<<16|o[n+3>>0]<<24;r[a>>0]=n;r[a+1>>0]=n>>8;r[a+2>>0]=n>>16;r[a+3>>0]=n>>24;a=e+12|0;i=o[i>>0]|o[i+1>>0]<<8|o[i+2>>0]<<16|o[i+3>>0]<<24;r[a>>0]=i;r[a+1>>0]=i>>8;r[a+2>>0]=i>>16;r[a+3>>0]=i>>24;a=t+16|0;i=a;i=o[i>>0]|o[i+1>>0]<<8|o[i+2>>0]<<16|o[i+3>>0]<<24;a=a+4|0;a=o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24;n=e+16|0;l=n;r[l>>0]=i;r[l+1>>0]=i>>8;r[l+2>>0]=i>>16;r[l+3>>0]=i>>24;n=n+4|0;r[n>>0]=a;r[n+1>>0]=a>>8;r[n+2>>0]=a>>16;r[n+3>>0]=a>>24;n=t+32|0;a=t+24|0;l=a;l=o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24;a=a+4|0;a=o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24;i=e+24|0;s=i;r[s>>0]=l;r[s+1>>0]=l>>8;r[s+2>>0]=l>>16;r[s+3>>0]=l>>24;i=i+4|0;r[i>>0]=a;r[i+1>>0]=a>>8;r[i+2>>0]=a>>16;r[i+3>>0]=a>>24;i=t+34|0;a=e+32|0;n=o[n>>0]|o[n+1>>0]<<8;r[a>>0]=n;r[a+1>>0]=n>>8;s=e+34|0;e=o[s>>0]|o[s+1>>0]<<8|o[s+2>>0]<<16|o[s+3>>0]<<24;if(!e)e=n;else{Yf(e);e=o[a>>0]|o[a+1>>0]<<8}n=Jf((e&65535)*6|0)|0;r[s>>0]=n;r[s+1>>0]=n>>8;r[s+2>>0]=n>>16;r[s+3>>0]=n>>24;if(e<<16>>16?(e=t+36|0,l=o[i>>0]|o[i+1>>0]<<8,r[n>>0]=l,r[n+1>>0]=l>>8,t=t+38|0,l=n+2|0,e=o[e>>0]|o[e+1>>0]<<8,r[l>>0]=e,r[l+1>>0]=e>>8,l=n+4|0,t=o[t>>0]|o[t+1>>0]<<8,r[l>>0]=t,r[l+1>>0]=t>>8,((o[a>>0]|o[a+1>>0]<<8)&65535)>1):0){e=1;do{t=i;i=i+6|0;l=o[s>>0]|o[s+1>>0]<<8|o[s+2>>0]<<16|o[s+3>>0]<<24;u=t+8|0;n=l+(e*6|0)|0;A=o[i>>0]|o[i+1>>0]<<8;r[n>>0]=A;r[n+1>>0]=A>>8;t=t+10|0;n=l+(e*6|0)+2|0;u=o[u>>0]|o[u+1>>0]<<8;r[n>>0]=u;r[n+1>>0]=u>>8;l=l+(e*6|0)+4|0;t=o[t>>0]|o[t+1>>0]<<8;r[l>>0]=t;r[l+1>>0]=t>>8;e=e+1|0}while(e>>>0<((o[a>>0]|o[a+1>>0]<<8)&65535)>>>0)}return}function Nt(e){e=e|0;pv(e,7354);s[e>>2]=4456;return}function Vt(e){e=e|0;ff(e);$p(e);return}function Qt(e){e=e|0;ff(e);$p(e);return}function Ht(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0;l=J;J=J+32|0;n=l;o=e+4|0;i=s[o>>2]|0;a=e+8|0;do{if((i|0)==(s[a>>2]|0)){i=((i-(s[e>>2]|0)|0)/12|0)+1|0;r=Zt(e)|0;if(r>>>0<i>>>0)Xv(e);else{u=s[e>>2]|0;A=((s[a>>2]|0)-u|0)/12|0;a=A<<1;Wt(n,A>>>0<r>>>1>>>0?a>>>0<i>>>0?i:a:r,((s[o>>2]|0)-u|0)/12|0,e+8|0);a=n+8|0;o=s[a>>2]|0;s[o>>2]=s[t>>2];s[o+4>>2]=s[t+4>>2];s[o+8>>2]=s[t+8>>2];s[a>>2]=(s[a>>2]|0)+12;Xt(e,n);Kt(n);break}}else{jt(n,e,1);A=n+4|0;u=s[A>>2]|0;s[u>>2]=s[t>>2];s[u+4>>2]=s[t+4>>2];s[u+8>>2]=s[t+8>>2];s[A>>2]=(s[A>>2]|0)+12;zt(n)}}while(0);J=l;return}function Gt(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;s[e>>2]=t;s[e+4>>2]=i;s[e+8>>2]=r;return}function jt(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+(i*12|0);return}function zt(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function Wt(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>357913941){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t*12|0)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i*12|0)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t*12|0);return}function Xt(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;r=s[e>>2]|0;a=e+4|0;o=t+4|0;n=(s[a>>2]|0)-r|0;i=(s[o>>2]|0)+(((n|0)/-12|0)*12|0)|0;s[o>>2]=i;if((n|0)>0){cg(i|0,r|0,n|0)|0;r=o;i=s[o>>2]|0}else r=o;o=s[e>>2]|0;s[e>>2]=i;s[r>>2]=o;o=t+8|0;n=s[a>>2]|0;s[a>>2]=s[o>>2];s[o>>2]=n;o=e+8|0;a=t+12|0;e=s[o>>2]|0;s[o>>2]=s[a>>2];s[a>>2]=e;s[t>>2]=s[r>>2];return}function Kt(e){e=e|0;var t=0,i=0,r=0;t=s[e+4>>2]|0;i=e+8|0;r=s[i>>2]|0;if((r|0)!=(t|0))s[i>>2]=r+(~(((r+-12-t|0)>>>0)/12|0)*12|0);t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function Zt(e){e=e|0;return 357913941}function Jt(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;Yt(e);s[e>>2]=s[t>>2];i=t+4|0;s[e+4>>2]=s[i>>2];r=t+8|0;s[e+8>>2]=s[r>>2];s[r>>2]=0;s[i>>2]=0;s[t>>2]=0;return}function Yt(e){e=e|0;var t=0,i=0,r=0,n=0;t=s[e>>2]|0;i=t;if(t|0){r=e+4|0;s[r>>2]=i;n=e+8|0;ye(t,(s[n>>2]|0)-i|0);s[n>>2]=0;s[r>>2]=0;s[e>>2]=0}return}function qt(e){e=e|0;pv(e,7660);s[e>>2]=4496;return}function $t(e,t){e=e|0;t=t|0;pv(e,t);s[e>>2]=4516;return}function ei(e){e=e|0;pv(e,7704);s[e>>2]=4536;return}function ti(e,t){e=e|0;t=t|0;var i=0,r=0,n=0;i=e+4|0;n=s[e>>2]|0;r=(s[i>>2]|0)-n>>3;if(r>>>0>=t>>>0){if(r>>>0>t>>>0)s[i>>2]=n+(t<<3)}else hi(e,t-r|0);return}function ii(e,t){e=e|0;t=t|0;s[e>>2]=t;s[e+4>>2]=0;s[e+8>>2]=-1;return}function ri(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var o=0;s[e+4>>2]=t;s[e+8>>2]=i;s[e+12>>2]=r;s[e+16>>2]=n;s[e+36>>2]=0;s[e+40>>2]=0;s[e+44>>2]=0;Bi(e+48|0);s[e+68>>2]=0;s[e+72>>2]=0;s[e+76>>2]=0;do{if(!n){i=e+20|0;if((t+-1|0)>>>0<31){s[i>>2]=t;n=1<<t;s[e+24>>2]=n;i=n>>>1;s[e+28>>2]=0-i;i=n+-1-i|0;break}else{s[i>>2]=32;s[e+24>>2]=0;s[e+28>>2]=-2147483648;i=2147483647;break}}else{r=e+20|0;s[r>>2]=0;s[e+24>>2]=n;i=n;o=0;while(1){i=i>>>1;t=o+1|0;if(!i)break;else o=t}s[r>>2]=(1<<o|0)==(n|0)?o:t;i=n>>>1;s[e+28>>2]=0-i;i=n+-1-i|0}}while(0);s[e+32>>2]=i;s[e>>2]=0;return}function ni(e){e=e|0;var t=0;t=((Ci(s[e>>2]|0)|0)&255)<<24;t=((Ci(s[e>>2]|0)|0)&255)<<16|t;t=t|((Ci(s[e>>2]|0)|0)&255)<<8;s[e+4>>2]=t|(Ci(s[e>>2]|0)|0)&255;return}function si(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0,_=0;v=J;J=J+64|0;p=v+44|0;f=v;A=e+36|0;c=e+40|0;e:do{if((s[A>>2]|0)==(s[c>>2]|0)){h=e+8|0;t:do{if(!(s[h>>2]|0))d=e+20|0;else{n=e+20|0;o=e+44|0;a=p+4|0;l=e+44|0;u=p+8|0;r=0;while(1){Ii(f,(s[n>>2]|0)+1|0,0,0);t=s[c>>2]|0;if(t>>>0<(s[o>>2]|0)>>>0){Ti(p,A,1);Si(s[a>>2]|0,f);s[a>>2]=(s[a>>2]|0)+44;Di(p)}else{t=((t-(s[A>>2]|0)|0)/44|0)+1|0;i=Oi(A)|0;if(i>>>0<t>>>0)break;g=s[A>>2]|0;_=((s[o>>2]|0)-g|0)/44|0;m=_<<1;Ri(p,_>>>0<i>>>1>>>0?m>>>0<t>>>0?t:m:i,((s[c>>2]|0)-g|0)/44|0,l);Si(s[u>>2]|0,f);s[u>>2]=(s[u>>2]|0)+44;Ui(A,p);Li(p)}Pi(f);r=r+1|0;if(r>>>0>=(s[h>>2]|0)>>>0){d=n;break t}}Xv(A)}}while(0);if(s[d>>2]|0){a=e+12|0;l=e+68|0;u=e+72|0;A=e+76|0;c=p+4|0;n=e+76|0;o=p+8|0;r=1;while(1){t=s[a>>2]|0;Ii(f,1<<(r>>>0>t>>>0?t:r),0,0);t=s[u>>2]|0;if(t>>>0<(s[A>>2]|0)>>>0){Ti(p,l,1);Si(s[c>>2]|0,f);s[c>>2]=(s[c>>2]|0)+44;Di(p)}else{t=((t-(s[l>>2]|0)|0)/44|0)+1|0;i=Oi(l)|0;if(i>>>0<t>>>0)break;_=s[l>>2]|0;g=((s[A>>2]|0)-_|0)/44|0;m=g<<1;Ri(p,g>>>0<i>>>1>>>0?m>>>0<t>>>0?t:m:i,((s[u>>2]|0)-_|0)/44|0,n);Si(s[o>>2]|0,f);s[o>>2]=(s[o>>2]|0)+44;Ui(l,p);Li(p)}Pi(f);r=r+1|0;if(r>>>0>(s[d>>2]|0)>>>0)break e}Xv(l)}}}while(0);J=v;return}function oi(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;i=(Qi(e,t,(s[e+36>>2]|0)+(r*44|0)|0)|0)+i|0;t=s[e+24>>2]|0;if((i|0)<0)return i+t|0;else return i-(i>>>0<t>>>0?0:t)|0;return 0}function ai(e){e=e|0;xi(e+68|0);xi(e+36|0);return}function li(e){e=e|0;return}function ui(e){e=e|0;ff(e);$p(e);return}function Ai(e){e=e|0;ff(e);$p(e);return}function ci(e){e=e|0;ff(e);$p(e);return}function hi(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0;l=J;J=J+32|0;n=l;o=e+8|0;a=e+4|0;i=s[a>>2]|0;do{if((s[o>>2]|0)-i>>3>>>0<t>>>0){i=(i-(s[e>>2]|0)>>3)+t|0;r=yi(e)|0;if(r>>>0<i>>>0)Xv(e);else{u=s[e>>2]|0;A=(s[o>>2]|0)-u|0;o=A>>2;pi(n,A>>3>>>0<r>>>1>>>0?o>>>0<i>>>0?i:o:r,(s[a>>2]|0)-u>>3,e+8|0);fi(n,t);vi(e,n);gi(n);break}}else di(e,t)}while(0);J=l;return}function di(e,t){e=e|0;t=t|0;var i=0,r=0,n=0;n=J;J=J+16|0;r=n;mi(r,e,t);e=r+4|0;t=s[e>>2]|0;i=s[r+8>>2]|0;if((t|0)!=(i|0)){i=i+-8-t|0;dg(t|0,0,i+8&-8|0)|0;s[e>>2]=t+((i>>>3)+1<<3)}_i(r);J=n;return}function pi(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>536870911){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t<<3)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i<<3)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t<<3);return}function fi(e,t){e=e|0;t=t|0;var i=0,r=0;r=J;J=J+16|0;i=r;bi(i,e+8|0,t);e=s[i>>2]|0;t=s[i+4>>2]|0;if((e|0)!=(t|0)){t=t+-8-e|0;dg(e|0,0,t+8&-8|0)|0;s[i>>2]=e+((t>>>3)+1<<3)}wi(i);J=r;return}function vi(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;r=s[e>>2]|0;a=e+4|0;o=t+4|0;n=(s[a>>2]|0)-r|0;i=(s[o>>2]|0)+(0-(n>>3)<<3)|0;s[o>>2]=i;if((n|0)>0){cg(i|0,r|0,n|0)|0;r=o;i=s[o>>2]|0}else r=o;o=s[e>>2]|0;s[e>>2]=i;s[r>>2]=o;o=t+8|0;n=s[a>>2]|0;s[a>>2]=s[o>>2];s[o>>2]=n;o=e+8|0;a=t+12|0;e=s[o>>2]|0;s[o>>2]=s[a>>2];s[a>>2]=e;s[t>>2]=s[r>>2];return}function gi(e){e=e|0;var t=0,i=0,r=0;t=s[e+4>>2]|0;i=e+8|0;r=s[i>>2]|0;if((r|0)!=(t|0))s[i>>2]=r+(~((r+-8-t|0)>>>3)<<3);t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function mi(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+(i<<3);return}function _i(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function yi(e){e=e|0;return 536870911}function bi(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=s[t>>2];s[e+4>>2]=(s[t>>2]|0)+(i<<3);s[e+8>>2]=t;return}function wi(e){e=e|0;s[s[e+8>>2]>>2]=s[e>>2];return}function Bi(e){e=e|0;s[e+12>>2]=1;s[e+16>>2]=2;s[e+8>>2]=4096;s[e+4>>2]=4;s[e>>2]=4;return}function xi(e){e=e|0;var t=0,i=0,r=0;i=s[e>>2]|0;if(i|0){r=e+4|0;t=s[r>>2]|0;if((t|0)==(i|0))t=i;else{do{t=t+-44|0;Pi(t)}while((t|0)!=(i|0));t=s[e>>2]|0}s[r>>2]=i;ye(t,(s[e+8>>2]|0)-t|0)}return}function Pi(e){e=e|0;var t=0;t=s[e+8>>2]|0;if(t|0)Le(t);t=s[e+12>>2]|0;if(t|0)Le(t);t=s[e+16>>2]|0;if(t|0)Le(t);return}function Ci(e){e=e|0;var t=0,i=0;i=e+4|0;t=s[i>>2]|0;if((t|0)>=(s[e+8>>2]|0)){Mi(e);t=s[i>>2]|0}e=s[e+12>>2]|0;s[i>>2]=t+1;return r[e+t>>0]|0}function Mi(e){e=e|0;var t=0;s[e+4>>2]=0;je(s[e>>2]|0,s[e+12>>2]|0,1048576);t=Fi(s[e>>2]|0)|0;s[e+8>>2]=t;if(!t){t=x(8)|0;ki(t);C(t|0,2752,8)}else return}function Fi(e){e=e|0;return s[e+16>>2]|0}function ki(e){e=e|0;pv(e,7769);s[e>>2]=4556;return}function Ei(e){e=e|0;ff(e);$p(e);return}function Ii(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var o=0,a=0,l=0;s[e>>2]=t;r[e+4>>0]=i&1;a=e+8|0;s[a>>2]=0;l=e+12|0;s[l>>2]=0;o=e+16|0;s[o>>2]=0;if((t+-2|0)>>>0>2046){e=x(8)|0;pv(e,7789);C(e|0,3912,8)}s[e+32>>2]=t+-1;if(t>>>0>16&(i^1)){i=3;while(1){if(1<<i+2>>>0<t>>>0)i=i+1|0;else break}t=1<<i;s[e+36>>2]=t;s[e+40>>2]=15-i;s[o>>2]=Ge((t<<2)+8|0)|0;t=s[e>>2]|0}else{s[o>>2]=0;s[e+40>>2]=0;s[e+36>>2]=0}s[a>>2]=Ge(t<<2)|0;o=Ge(s[e>>2]<<2)|0;s[l>>2]=o;s[e+20>>2]=0;t=s[e>>2]|0;i=e+24|0;s[i>>2]=t;t=(t|0)!=0;if(!n){if(t){t=0;do{s[o+(t<<2)>>2]=1;t=t+1|0}while(t>>>0<(s[e>>2]|0)>>>0)}}else if(t){t=0;do{s[o+(t<<2)>>2]=s[n+(t<<2)>>2];t=t+1|0}while(t>>>0<(s[e>>2]|0)>>>0)}Vi(e);n=((s[e>>2]|0)+6|0)>>>1;s[i>>2]=n;s[e+28>>2]=n;return}function Ti(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+(i*44|0);return}function Di(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function Si(e,t){e=e|0;t=t|0;var i=0;s[e>>2]=s[t>>2];r[e+4>>0]=r[t+4>>0]|0;i=t+8|0;s[e+8>>2]=s[i>>2];s[e+12>>2]=s[t+12>>2];s[e+16>>2]=s[t+16>>2];s[e+20>>2]=s[t+20>>2];s[e+24>>2]=s[t+24>>2];s[e+28>>2]=s[t+28>>2];s[e+32>>2]=s[t+32>>2];s[e+36>>2]=s[t+36>>2];s[e+40>>2]=s[t+40>>2];s[i>>2]=0;s[i+4>>2]=0;s[i+8>>2]=0;return}function Ri(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>97612893){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t*44|0)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i*44|0)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t*44|0);return}function Ui(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0;l=s[e>>2]|0;u=e+4|0;i=s[u>>2]|0;a=t+4|0;if((i|0)==(l|0)){n=a;o=e;r=s[a>>2]|0;i=l}else{r=s[a>>2]|0;do{i=i+-44|0;Ni(r+-44|0,i);r=(s[a>>2]|0)+-44|0;s[a>>2]=r}while((i|0)!=(l|0));n=a;o=e;i=s[e>>2]|0}s[o>>2]=r;s[n>>2]=i;l=t+8|0;a=s[u>>2]|0;s[u>>2]=s[l>>2];s[l>>2]=a;l=e+8|0;u=t+12|0;e=s[l>>2]|0;s[l>>2]=s[u>>2];s[u>>2]=e;s[t>>2]=s[n>>2];return}function Li(e){e=e|0;var t=0,i=0,r=0,n=0;i=s[e+4>>2]|0;r=e+8|0;t=s[r>>2]|0;if((t|0)!=(i|0))do{n=t+-44|0;s[r>>2]=n;Pi(n);t=s[r>>2]|0}while((t|0)!=(i|0));t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function Oi(e){e=e|0;return 97612893}function Ni(e,t){e=e|0;t=t|0;var i=0,n=0,o=0,a=0;i=s[t>>2]|0;s[e>>2]=i;r[e+4>>0]=r[t+4>>0]|0;s[e+20>>2]=s[t+20>>2];s[e+24>>2]=s[t+24>>2];s[e+28>>2]=s[t+28>>2];s[e+32>>2]=s[t+32>>2];a=e+36|0;s[a>>2]=s[t+36>>2];s[e+40>>2]=s[t+40>>2];i=i<<2;n=Ge(i)|0;s[e+8>>2]=n;o=s[e>>2]|0;if(o|0)hg(n|0,s[t+8>>2]|0,o<<2|0)|0;i=Ge(i)|0;s[e+12>>2]=i;n=s[e>>2]|0;if(n|0)hg(i|0,s[t+12>>2]|0,n<<2|0)|0;i=s[a>>2]|0;if(i){n=Ge((i<<2)+8|0)|0;s[e+16>>2]=n;i=(s[a>>2]<<2)+8|0;if(i|0)hg(n|0,s[t+16>>2]|0,i|0)|0}else s[e+16>>2]=0;return}function Vi(e){e=e|0;var t=0,i=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;v=e+24|0;o=e+20|0;t=(s[o>>2]|0)+(s[v>>2]|0)|0;s[o>>2]=t;if(t>>>0>32768){s[o>>2]=0;if(!(s[e>>2]|0))t=0;else{n=s[e+12>>2]|0;i=0;do{d=n+(i<<2)|0;t=((s[d>>2]|0)+1|0)>>>1;s[d>>2]=t;t=(s[o>>2]|0)+t|0;s[o>>2]=t;i=i+1|0}while(i>>>0<(s[e>>2]|0)>>>0)}}d=2147483648/(t>>>0)|0;do{if((r[e+4>>0]|0)==0?(p=e+36|0,(s[p>>2]|0)!=0):0){if(s[e>>2]|0){u=s[e+8>>2]|0;A=s[e+12>>2]|0;c=e+40|0;h=e+16|0;t=0;a=0;l=0;do{i=(_(a,d)|0)>>>16;s[u+(l<<2)>>2]=i;a=(s[A+(l<<2)>>2]|0)+a|0;i=i>>>(s[c>>2]|0);if(t>>>0<i>>>0){n=l+-1|0;o=s[h>>2]|0;do{t=t+1|0;s[o+(t<<2)>>2]=n}while((t|0)!=(i|0));t=i}l=l+1|0}while(l>>>0<(s[e>>2]|0)>>>0);i=s[h>>2]|0;s[i>>2]=0;if(t>>>0>(s[p>>2]|0)>>>0){t=e;break}}else{i=s[e+16>>2]|0;s[i>>2]=0;t=0}do{t=t+1|0;s[i+(t<<2)>>2]=(s[e>>2]|0)+-1}while(t>>>0<=(s[p>>2]|0)>>>0);t=e}else f=7}while(0);if((f|0)==7)if(!(s[e>>2]|0))t=e;else{n=s[e+8>>2]|0;o=s[e+12>>2]|0;t=0;i=0;do{s[n+(t<<2)>>2]=(_(i,d)|0)>>>16;i=(s[o+(t<<2)>>2]|0)+i|0;t=t+1|0}while(t>>>0<(s[e>>2]|0)>>>0);t=e}f=((s[v>>2]|0)*5|0)>>>2;p=(s[t>>2]<<3)+48|0;f=f>>>0>p>>>0?p:f;s[v>>2]=f;s[e+28>>2]=f;return}function Qi(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;i=Hi(t,i)|0;s[e>>2]=i;do{if(i){if(i>>>0>=32){i=s[e+28>>2]|0;break}r=s[e+12>>2]|0;if(i>>>0>r>>>0){r=i-r|0;i=Hi(t,(s[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;r=i<<r|(Gi(t,r)|0)}else r=Hi(t,(s[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;i=s[e>>2]|0;if((r|0)<(1<<i+-1|0)){i=r+1+(-1<<i)|0;break}else{i=r+1|0;break}}else i=ji(t,e+48|0)|0}while(0);return i|0}function Hi(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;d=e+8|0;h=s[d>>2]|0;n=s[t+16>>2]|0;if(n){r=e+4|0;i=s[r>>2]|0;c=h>>>15;s[d>>2]=c;u=(i>>>0)/(c>>>0)|0;l=u>>>(s[t+40>>2]|0);o=s[n+(l<<2)>>2]|0;l=(s[n+(l+1<<2)>>2]|0)+1|0;a=o+1|0;A=s[t+8>>2]|0;if(l>>>0>a>>>0){n=o;o=l;do{a=(o+n|0)>>>1;l=(s[A+(a<<2)>>2]|0)>>>0>u>>>0;n=l?n:a;o=l?a:o;a=n+1|0}while(o>>>0>a>>>0);o=n}n=_(s[A+(o<<2)>>2]|0,c)|0;if((o|0)==(s[t+32>>2]|0))a=h;else a=_(s[A+(a<<2)>>2]|0,c)|0}else{A=h>>>15;s[d>>2]=A;l=s[t>>2]|0;c=s[t+8>>2]|0;r=e+4|0;i=s[r>>2]|0;u=l>>>1;n=0;a=h;o=0;do{p=_(s[c+(u<<2)>>2]|0,A)|0;h=p>>>0>i>>>0;a=h?p:a;n=h?n:p;o=h?o:u;l=h?u:l;u=(o+l|0)>>>1}while((u|0)!=(o|0))}s[r>>2]=i-n;p=a-n|0;s[d>>2]=p;if(p>>>0<16777216)zi(e);d=(s[t+12>>2]|0)+(o<<2)|0;s[d>>2]=(s[d>>2]|0)+1;d=t+28|0;p=(s[d>>2]|0)+-1|0;s[d>>2]=p;if(!p)Vi(t);return o|0}function Gi(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;if(t>>>0>19){i=(Wi(e)|0)&65535;return(Gi(e,t+-16|0)|0)<<16|i|0}r=e+4|0;n=s[r>>2]|0;o=e+8|0;i=(s[o>>2]|0)>>>t;s[o>>2]=i;t=(n>>>0)/(i>>>0)|0;s[r>>2]=n-(_(t,i)|0);if(i>>>0<16777216)zi(e);return t|0}function ji(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0;r=e+8|0;n=s[r>>2]|0;i=_(n>>>13,s[t+8>>2]|0)|0;o=e+4|0;a=s[o>>2]|0;l=a>>>0>=i>>>0;if(l){s[o>>2]=a-i;i=n-i|0;s[r>>2]=i}else{s[r>>2]=i;a=t+12|0;s[a>>2]=(s[a>>2]|0)+1}if(i>>>0<16777216)zi(e);a=t+4|0;e=(s[a>>2]|0)+-1|0;s[a>>2]=e;if(!e)Xi(t);return l&1|0}function zi(e){e=e|0;var t=0,i=0,r=0,n=0;t=e+4|0;i=e+8|0;r=s[t>>2]|0;do{r=r<<8|(Ci(s[e>>2]|0)|0)&255;s[t>>2]=r;n=s[i>>2]<<8;s[i>>2]=n}while(n>>>0<16777216);return}function Wi(e){e=e|0;var t=0,i=0,r=0,n=0;i=e+4|0;n=s[i>>2]|0;t=e+8|0;r=(s[t>>2]|0)>>>16;s[t>>2]=r;t=(n>>>0)/(r>>>0)|0;s[i>>2]=n-(_(t,r)|0);zi(e);return t&65535|0}function Xi(e){e=e|0;var t=0,i=0,r=0,n=0,o=0;n=s[e>>2]|0;i=e+16|0;t=(s[i>>2]|0)+n|0;s[i>>2]=t;if(t>>>0>8192){r=(t+1|0)>>>1;s[i>>2]=r;o=e+12|0;t=((s[o>>2]|0)+1|0)>>>1;s[o>>2]=t;if((t|0)==(r|0)){t=r+1|0;s[i>>2]=t;i=t;t=r}else i=r}else{i=t;t=s[e+12>>2]|0}s[e+8>>2]=(_(t,2147483648/(i>>>0)|0)|0)>>>18;o=n*5|0;o=o>>>0>259?64:o>>>2;s[e>>2]=o;s[e+4>>2]=o;return}function Ki(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;h=J;J=J+32|0;a=h+16|0;l=h+8|0;u=h;A=e+336|0;r=A;n=e+259|0;if(!((s[r+4>>2]|0)==0?(s[r>>2]|0)==(o[n>>0]|o[n+1>>0]<<8|o[n+2>>0]<<16|o[n+3>>0]<<24|0):0)){r=e+320|0;i=s[r>>2]|0;n=i;if(!((i|0)!=0?(s[e+312>>2]|0)!=0:0)){i=n;c=5}}else{r=e+320|0;i=s[e+320>>2]|0;c=5}if((c|0)==5){c=e+320|0;s[a>>2]=i;s[c>>2]=0;i=e+324|0;s[a+4>>2]=s[i>>2];s[i>>2]=0;Ee(a);n=e+312|0;s[a>>2]=s[n>>2];s[n>>2]=0;d=e+316|0;s[a+4>>2]=s[d>>2];s[d>>2]=0;Ie(a);p=Zf(12)|0;ii(p,e+4|0);s[u>>2]=0;s[a>>2]=s[u>>2];Ji(l,p,a);p=s[l>>2]|0;s[l>>2]=s[n>>2];s[n>>2]=p;p=l+4|0;u=s[p>>2]|0;s[p>>2]=s[d>>2];s[d>>2]=u;Ie(l);Zi(l,s[n>>2]|0,e+300|0);n=s[l>>2]|0;d=l+4|0;u=s[d>>2]|0;s[l>>2]=0;s[d>>2]=0;s[a>>2]=s[c>>2];s[c>>2]=n;s[a+4>>2]=s[i>>2];s[i>>2]=u;Ee(a);Ee(l);i=e+328|0;u=i;u=ig(s[u>>2]|0,s[u+4>>2]|0,1,0)|0;c=B()|0;s[i>>2]=u;s[i+4>>2]=c;i=A;s[i>>2]=0;s[i+4>>2]=0;i=s[r>>2]|0}Qg[s[s[i>>2]>>2]&63](i,t)|0;c=A;c=ig(s[c>>2]|0,s[c+4>>2]|0,1,0)|0;d=B()|0;p=A;s[p>>2]=c;s[p+4>>2]=d;J=h;return}function Zi(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;a=J;J=J+64|0;r=a+56|0;n=a;o=ir(i)|0;if((o|0)==-1){a=x(8)|0;rr(a);C(a|0,2784,8)}i=nr(i)|0;e:do{if(!i)switch(o|0){case 0:{o=Zf(4788)|0;pr(o);dr(e,t,o);break e}case 1:{o=Zf(5116)|0;vr(o);fr(e,t,o);break e}case 2:{o=Zf(5104)|0;mr(o);gr(e,t,o);break e}case 3:{o=Zf(5432)|0;yr(o);_r(e,t,o);break e}default:{s[e>>2]=0;s[e+4>>2]=0;break e}}else{sr(r,t);or(s[r>>2]|0);if((o|2|0)==3)ar(s[r>>2]|0);if((o|1|0)==3)lr(s[r>>2]|0);o=s[r>>2]|0;Ar(n,i);ur(o,n);cr(n);s[e>>2]=s[r>>2];o=r+4|0;s[e+4>>2]=s[o>>2];s[r>>2]=0;s[o>>2]=0;hr(r)}}while(0);J=a;return}function Ji(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4576;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Yi(e,r);J=i;return}function Yi(e,t){e=e|0;t=t|0;return}function qi(e){e=e|0;ov(e);$p(e);return}function $i(e){e=e|0;e=s[e+12>>2]|0;if(e|0){li(e);$p(e)}return}function er(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==7983?e+12|0:0)|0}function tr(e){e=e|0;ye(e,16);return}function ir(e){e=e|0;var t=0,i=0;t=(s[e+4>>2]|0)-(s[e>>2]|0)|0;e:do{if(((t|0)!=0?(i=((t|0)/12|0)+(((nr(e)|0)!=0)<<31>>31)|0,(i|0)!=0):0)?(t=s[e>>2]|0,!(br(t,wr()|0)|0)):0){switch(i|0){case 1:{e=0;break e}case 2:{if(Br((s[e>>2]|0)+12|0,xr()|0)|0){e=1;break e}if(Br((s[e>>2]|0)+12|0,Pr()|0)|0){e=2;break e}break}case 3:{if(Br((s[e>>2]|0)+12|0,xr()|0)|0?(i=(s[e>>2]|0)+24|0,Br(i,Pr()|0)|0):0){e=3;break e}break}default:{}}e=-1}else e=-1}while(0);return e|0}function rr(e){e=e|0;pv(e,8131);s[e>>2]=4604;return}function nr(e){e=e|0;var t=0,i=0;t=s[e+4>>2]|0;if(((t|0)!=(s[e>>2]|0)?(i=t,(s[i+-12>>2]|0)==0):0)?(s[i+-4>>2]|0)==2:0)e=s[i+-8>>2]|0;else e=0;return e|0}function sr(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;i=J;J=J+16|0;r=i+4|0;o=i;n=Zf(24)|0;Mr(n,t);s[o>>2]=0;s[r>>2]=s[o>>2];Fr(e,n,r);J=i;return}function or(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(4792)|0;Hr(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];Gr(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function ar(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(336)|0;Wn(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];Xn(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function lr(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(324)|0;gs(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];ms(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function ur(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;a=u+12|0;l=u;r=u+8|0;o=Zf(64)|0;Ds(o,s[e+4>>2]|0,t);n=e+8|0;s[r>>2]=0;s[a>>2]=s[r>>2];Ss(l,o,a);o=e+12|0;t=s[o>>2]|0;r=e+16|0;do{if(t>>>0>=(s[r>>2]|0)>>>0){t=(t-(s[n>>2]|0)>>3)+1|0;i=Zr(n)|0;if(i>>>0<t>>>0)Xv(n);else{A=s[n>>2]|0;c=(s[r>>2]|0)-A|0;r=c>>2;Wr(a,c>>3>>>0<i>>>1>>>0?r>>>0<t>>>0?t:r:i,(s[o>>2]|0)-A>>3,e+16|0);e=a+8|0;o=s[e>>2]|0;s[o>>2]=s[l>>2];r=l+4|0;s[o+4>>2]=s[r>>2];s[l>>2]=0;s[r>>2]=0;s[e>>2]=o+8;Xr(n,a);Kr(a);break}}else{jr(a,n,1);c=a+4|0;A=s[c>>2]|0;s[A>>2]=s[l>>2];e=l+4|0;s[A+4>>2]=s[e>>2];s[l>>2]=0;s[e>>2]=0;s[c>>2]=A+8;zr(a)}}while(0);Rr(l);J=u;return}function Ar(e,t){e=e|0;t=t|0;var i=0,n=0;i=J;J=J+48|0;n=i;s[e>>2]=t;r[e+4>>0]=0;Mo(e+8|0,t);Mo(e+20|0,t);Ii(n,256,0,0);Fo(e+32|0,t,n);Pi(n);J=i;return}function cr(e){e=e|0;Io(e+32|0);Gs(e+20|0);Gs(e+8|0);return}function hr(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function dr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;r=J;J=J+16|0;n=r+4|0;a=r;o=Zf(12)|0;To(o,t,i);s[a>>2]=0;s[n>>2]=s[a>>2];Do(e,o,n);J=r;return}function pr(e){e=e|0;Yr(e);zo(e+4784|0);return}function fr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;r=J;J=J+16|0;n=r+4|0;a=r;o=Zf(12)|0;Wo(o,t,i);s[a>>2]=0;s[n>>2]=s[a>>2];Xo(e,o,n);J=r;return}function vr(e){e=e|0;Yr(e);sa(e+4784|0);return}function gr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;r=J;J=J+16|0;n=r+4|0;a=r;o=Zf(12)|0;oa(o,t,i);s[a>>2]=0;s[n>>2]=s[a>>2];aa(e,o,n);J=r;return}function mr(e){e=e|0;Yr(e);_a(e+4784|0);return}function _r(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;r=J;J=J+16|0;n=r+4|0;a=r;o=Zf(12)|0;ya(o,t,i);s[a>>2]=0;s[n>>2]=s[a>>2];ba(e,o,n);J=r;return}function yr(e){e=e|0;Yr(e);Da(e+4784|0);return}function br(e,t){e=e|0;t=t|0;return(Br(e,t)|0)^1|0}function wr(){if((r[21456]|0)==0?Uf(21456)|0:0){Gt(21536,6,20,2);jf(21456)}return 21536}function Br(e,t){e=e|0;t=t|0;if((s[e>>2]|0)==(s[t>>2]|0)?(s[e+8>>2]|0)==(s[t+8>>2]|0):0)e=(s[e+4>>2]|0)==(s[t+4>>2]|0);else e=0;return e|0}function xr(){if((r[21464]|0)==0?Uf(21464)|0:0){Gt(21548,7,8,2);jf(21464)}return 21548}function Pr(){if((r[21472]|0)==0?Uf(21472)|0:0){Gt(21560,8,6,2);jf(21472)}return 21560}function Cr(e){e=e|0;ff(e);$p(e);return}function Mr(e,t){e=e|0;t=t|0;kr(e);s[e>>2]=4624;s[e+4>>2]=t;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;r[e+20>>0]=1;return}function Fr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4664;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Lr(e,r);J=i;return}function kr(e){e=e|0;s[e>>2]=4644;return}function Er(e,t){e=e|0;t=t|0;var i=0,n=0,o=0,a=0,l=0,u=0,A=0;A=J;J=J+16|0;a=A;i=s[e+8>>2]|0;l=s[e+12>>2]|0;if((i|0)!=(l|0)){u=a+4|0;do{n=s[i>>2]|0;s[a>>2]=n;o=s[i+4>>2]|0;s[u>>2]=o;if(o|0){o=o+4|0;s[o>>2]=(s[o>>2]|0)+1}t=Qg[s[(s[n>>2]|0)+12>>2]&63](n,t)|0;Rr(a);i=i+8|0}while((i|0)!=(l|0))}i=e+20|0;if(r[i>>0]|0){r[i>>0]=0;ni(s[e+4>>2]|0)}J=A;return t|0}function Ir(e){e=e|0;s[e>>2]=4624;Ur(e+8|0);Dr(e);return}function Tr(e){e=e|0;Ir(e);$p(e);return}function Dr(e){e=e|0;return}function Sr(e){e=e|0;Z()}function Rr(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Ur(e){e=e|0;var t=0,i=0,r=0;i=s[e>>2]|0;if(i|0){r=e+4|0;t=s[r>>2]|0;if((t|0)==(i|0))t=i;else{do{t=t+-8|0;Rr(t)}while((t|0)!=(i|0));t=s[e>>2]|0}s[r>>2]=i;ye(t,(s[e+8>>2]|0)-t|0)}return}function Lr(e,t){e=e|0;t=t|0;return}function Or(e){e=e|0;ov(e);$p(e);return}function Nr(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function Vr(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==8546?e+12|0:0)|0}function Qr(e){e=e|0;ye(e,16);return}function Hr(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=4692;s[e+4>>2]=t;Yr(e+8|0);return}function Gr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4740;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function jr(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+(i<<3);return}function zr(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function Wr(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>536870911){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t<<3)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i<<3)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t<<3);return}function Xr(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0;l=s[e>>2]|0;u=e+4|0;i=s[u>>2]|0;a=t+4|0;if((i|0)==(l|0)){n=a;o=e;r=s[a>>2]|0;i=l}else{r=s[a>>2]|0;do{o=i;i=i+-8|0;s[r+-8>>2]=s[i>>2];o=o+-4|0;s[r+-4>>2]=s[o>>2];s[i>>2]=0;s[o>>2]=0;r=(s[a>>2]|0)+-8|0;s[a>>2]=r}while((i|0)!=(l|0));n=a;o=e;i=s[e>>2]|0}s[o>>2]=r;s[n>>2]=i;l=t+8|0;a=s[u>>2]|0;s[u>>2]=s[l>>2];s[l>>2]=a;l=e+8|0;u=t+12|0;e=s[l>>2]|0;s[l>>2]=s[u>>2];s[u>>2]=e;s[t>>2]=s[n>>2];return}function Kr(e){e=e|0;var t=0,i=0,r=0,n=0;i=s[e+4>>2]|0;r=e+8|0;t=s[r>>2]|0;if((t|0)!=(i|0))do{n=t+-8|0;s[r>>2]=n;Rr(n);t=s[r>>2]|0}while((t|0)!=(i|0));t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function Zr(e){e=e|0;return 536870911}function Jr(e){e=e|0;s[e>>2]=4716;return}function Yr(e){e=e|0;on(e);an(e+3980|0);ln(e+4380|0);r[e+4780>>0]=0;r[e+4781>>0]=0;return}function qr(e){e=e|0;s[e>>2]=4692;gn(e+8|0);rn(e);return}function $r(e){e=e|0;qr(e);$p(e);return}function en(e,t){e=e|0;t=t|0;return t|0}function tn(e,t){e=e|0;t=t|0;return _n(e+8|0,s[e+4>>2]|0,t)|0}function rn(e){e=e|0;return}function nn(e){e=e|0;rn(e);$p(e);return}function sn(e,t){e=e|0;t=t|0;return t|0}function on(e){e=e|0;var t=0,i=0;cn(e);hn(e+52|0);hn(e+436|0);Ii(e+852|0,64,0,0);r[e+3976>>0]=0;t=e+20|0;i=t+32|0;do{n[t>>1]=0;t=t+2|0}while((t|0)<(i|0));t=Zf(44)|0;Ii(t,256,0,0);s[e+896>>2]=t;t=Zf(44)|0;Ii(t,256,0,0);s[e+900>>2]=t;t=e+820|0;s[t>>2]=0;s[t+4>>2]=0;s[t+8>>2]=0;s[t+12>>2]=0;s[t+16>>2]=0;s[t+20>>2]=0;s[t+24>>2]=0;s[t+28>>2]=0;t=0;do{i=Zf(44)|0;Ii(i,256,0,0);s[e+904+(t<<2)>>2]=i;i=Zf(44)|0;Ii(i,256,0,0);s[e+1928+(t<<2)>>2]=i;i=Zf(44)|0;Ii(i,256,0,0);s[e+2952+(t<<2)>>2]=i;t=t+1|0}while(t>>>0<256);return}function an(e){e=e|0;fn(e,16,4,8,0);fn(e+80|0,16,1,8,0);fn(e+160|0,32,2,8,0);fn(e+240|0,32,22,8,0);fn(e+320|0,32,20,8,0);return}function ln(e){e=e|0;ri(e,16,4,8,0);ri(e+80|0,16,1,8,0);ri(e+160|0,32,2,8,0);ri(e+240|0,32,22,8,0);ri(e+320|0,32,20,8,0);return}function un(e){e=e|0;vn(e+320|0);vn(e+240|0);vn(e+160|0);vn(e+80|0);vn(e);return}function An(e){e=e|0;var t=0,i=0;t=s[e+896>>2]|0;if(t|0){Pi(t);$p(t)}t=s[e+900>>2]|0;if(t|0){Pi(t);$p(t)}i=0;do{t=s[e+904+(i<<2)>>2]|0;if(t|0){Pi(t);$p(t)}t=s[e+1928+(i<<2)>>2]|0;if(t|0){Pi(t);$p(t)}t=s[e+2952+(i<<2)>>2]|0;if(t|0){Pi(t);$p(t)}i=i+1|0}while((i|0)!=256);Pi(e+852|0);return}function cn(e){e=e|0;var t=0;r[e>>0]=0;r[e+1>>0]=0;r[e+2>>0]=0;r[e+3>>0]=0;t=e+4|0;r[t>>0]=0;r[t+1>>0]=0;r[t+2>>0]=0;r[t+3>>0]=0;e=e+12|0;t=e;r[t>>0]=0;r[t+1>>0]=0;r[t+2>>0]=0;r[t+3>>0]=0;e=e+4|0;r[e>>0]=0;r[e+1>>0]=0;r[e+2>>0]=0;r[e+3>>0]=0;return}function hn(e){e=e|0;var t=0;t=e+384|0;do{dn(e);e=e+24|0}while((e|0)!=(t|0));return}function dn(e){e=e|0;pn(e);return}function pn(e){e=e|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;r[e+20>>0]=1;return}function fn(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var o=0;s[e+4>>2]=t;s[e+8>>2]=i;s[e+12>>2]=r;s[e+16>>2]=n;s[e+36>>2]=0;s[e+40>>2]=0;s[e+44>>2]=0;Bi(e+48|0);s[e+68>>2]=0;s[e+72>>2]=0;s[e+76>>2]=0;do{if(!n){i=e+20|0;if((t+-1|0)>>>0<31){s[i>>2]=t;n=1<<t;s[e+24>>2]=n;i=n>>>1;s[e+28>>2]=0-i;i=n+-1-i|0;break}else{s[i>>2]=32;s[e+24>>2]=0;s[e+28>>2]=-2147483648;i=2147483647;break}}else{r=e+20|0;s[r>>2]=0;s[e+24>>2]=n;i=n;o=0;while(1){i=i>>>1;t=o+1|0;if(!i)break;else o=t}s[r>>2]=(1<<o|0)==(n|0)?o:t;i=n>>>1;s[e+28>>2]=0-i;i=n+-1-i|0}}while(0);s[e+32>>2]=i;s[e>>2]=0;return}function vn(e){e=e|0;var t=0,i=0,r=0,n=0,o=0;o=e+36|0;i=s[o>>2]|0;r=e+40|0;t=s[r>>2]|0;if((t|0)!=(i|0))do{t=t+-44|0;Pi(t)}while((t|0)!=(i|0));s[r>>2]=i;r=e+68|0;n=s[r>>2]|0;i=e+72|0;t=s[i>>2]|0;if((t|0)!=(n|0))do{t=t+-44|0;Pi(t)}while((t|0)!=(n|0));s[i>>2]=n;xi(r);xi(o);return}function gn(e){e=e|0;mn(e+4380|0);un(e+3980|0);An(e);return}function mn(e){e=e|0;ai(e+320|0);ai(e+240|0);ai(e+160|0);ai(e+80|0);ai(e);return}function _n(e,t,i){e=e|0;t=t|0;i=i|0;var l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;f=J;J=J+32|0;p=f;l=e+4781|0;if(!(r[l>>0]|0)){yn(e+4380|0);r[l>>0]=1}l=e+3976|0;if(!(r[l>>0]|0)){r[l>>0]=1;wn(bn(t)|0,i,20);Bn(p,i);A=e;l=p;u=A+20|0;do{r[A>>0]=r[l>>0]|0;A=A+1|0;l=l+1|0}while((A|0)<(u|0));n[e+12>>1]=0}else{h=Hi(t,e+852|0)|0;if(h){if(h&32|0)Pn((Hi(t,s[e+904+(((xn(e)|0)&255)<<2)>>2]|0)|0)&255,e);d=e+14|0;A=r[d>>0]|0;l=A&7;A=(A&255)>>>3&7;u=o[16+(A<<3)+l>>0]|0;l=o[80+(A<<3)+l>>0]|0;if(!(h&16))c=n[e+20+(u<<1)>>1]|0;else{v=e+20+(u<<1)|0;c=(oi(e+4380|0,t,a[v>>1]|0,u>>>0<3?u:3)|0)&65535;n[v>>1]=c}n[e+12>>1]=c;if(h&8|0){v=e+15|0;r[v>>0]=Hi(t,s[e+1928+(o[v>>0]<<2)>>2]|0)|0}if(h&4|0){d=Hi(t,s[e+896+(((o[d>>0]|0)>>>6&1)<<2)>>2]|0)|0;v=e+16|0;r[v>>0]=Cn(d+(r[v>>0]|0)|0)|0}if(h&2|0){v=e+17|0;r[v>>0]=Hi(t,s[e+2952+(o[v>>0]<<2)>>2]|0)|0}if(h&1){v=e+18|0;n[v>>1]=oi(e+4460|0,t,a[v>>1]|0,0)|0}}else{v=r[e+14>>0]|0;l=v&7;v=(v&255)>>>3&7;A=v;u=o[16+(v<<3)+l>>0]|0;l=o[80+(v<<3)+l>>0]|0}c=e+52+(u*24|0)|0;h=e+4540|0;d=(A|0)==1&1;A=oi(h,t,Mn(c)|0,d)|0;s[p>>2]=A;s[e>>2]=(s[e>>2]|0)+A;Fn(c,p);c=e+436+(u*24|0)|0;A=Mn(c)|0;u=kn(h)|0;v=e+4620|0;u=oi(v,t,A,(u>>>0<20?u&-2:20)|d)|0;s[p>>2]=u;A=e+4|0;s[A>>2]=(s[A>>2]|0)+u;Fn(c,p);p=kn(h)|0;p=(kn(v)|0)+p|0;v=e+820+(l<<2)|0;p=oi(e+4700|0,t,s[v>>2]|0,(p>>>0<36?p>>>1&2147483646:18)|d)|0;s[e+8>>2]=p;s[v>>2]=p;En(e,i)}J=f;return i+20|0}function yn(e){e=e|0;si(e);si(e+80|0);si(e+160|0);si(e+240|0);si(e+320|0);return}function bn(e){e=e|0;return s[e>>2]|0}function wn(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0,A=0;A=e+4|0;n=s[A>>2]|0;u=(s[e+8>>2]|0)-n|0;u=u>>>0>i>>>0?i:u;l=e+12|0;o=(s[l>>2]|0)+n|0;a=o+u|0;if(u){n=o;o=t;while(1){r[o>>0]=r[n>>0]|0;n=n+1|0;if((n|0)==(a|0))break;else o=o+1|0}n=s[A>>2]|0}s[A>>2]=n+u;i=i-u|0;if(i|0){Mi(e);o=(s[l>>2]|0)+(s[A>>2]|0)|0;a=o+i|0;n=t+u|0;while(1){r[n>>0]=r[o>>0]|0;o=o+1|0;if((o|0)==(a|0))break;else n=n+1|0}s[A>>2]=(s[A>>2]|0)+i}return}function Bn(e,t){e=e|0;t=t|0;cn(e);s[e>>2]=In(t)|0;s[e+4>>2]=In(t+4|0)|0;s[e+8>>2]=In(t+8|0)|0;n[e+12>>1]=Tn(t+12|0)|0;Pn(Dn(t+14|0)|0,e);r[e+15>>0]=Dn(t+15|0)|0;r[e+16>>0]=Sn(t+16|0)|0;r[e+17>>0]=Sn(t+17|0)|0;n[e+18>>1]=Tn(t+18|0)|0;return}function xn(e){e=e|0;return r[e+14>>0]|0}function Pn(e,t){e=e|0;t=t|0;r[t+14>>0]=e;return}function Cn(e){e=e|0;return e&255|0}function Mn(e){e=e|0;return s[e+8>>2]|0}function Fn(e,t){e=e|0;t=t|0;var i=0,n=0,o=0,a=0,l=0,u=0,A=0;A=e+20|0;do{if(!(r[A>>0]|0)){u=e+8|0;i=s[u>>2]|0;n=s[t>>2]|0;o=e+4|0;a=s[o>>2]|0;if((i|0)>=(n|0)){if((a|0)<(n|0)){s[e>>2]=a;s[o>>2]=s[t>>2]}else s[e>>2]=n;r[A>>0]=1;break}s[e>>2]=a;s[o>>2]=i;o=e+16|0;a=s[o>>2]|0;l=s[t>>2]|0;i=e+12|0;n=s[i>>2]|0;if((a|0)<(l|0)){s[u>>2]=n;s[i>>2]=a;s[o>>2]=s[t>>2];break}if((n|0)<(l|0)){s[u>>2]=n;s[i>>2]=s[t>>2];break}else{s[u>>2]=l;break}}else{o=s[t>>2]|0;l=e+8|0;i=s[l>>2]|0;a=e+12|0;n=s[a>>2]|0;if((o|0)>=(i|0)){i=e+16|0;if((o|0)<(n|0)){s[i>>2]=n;s[a>>2]=s[t>>2]}else s[i>>2]=o;r[A>>0]=0;break}s[e+16>>2]=n;s[a>>2]=i;i=s[t>>2]|0;n=s[e>>2]|0;o=e+4|0;a=s[o>>2]|0;if((i|0)<(n|0)){s[l>>2]=a;s[o>>2]=n;s[e>>2]=s[t>>2];break}if((i|0)<(a|0)){s[l>>2]=a;s[o>>2]=s[t>>2];break}else{s[l>>2]=i;break}}}while(0);return}function kn(e){e=e|0;return s[e>>2]|0}function En(e,t){e=e|0;t=t|0;var i=0;Un(o[e>>0]|o[e+1>>0]<<8|o[e+2>>0]<<16|o[e+3>>0]<<24,t);i=e+4|0;Un(o[i>>0]|o[i+1>>0]<<8|o[i+2>>0]<<16|o[i+3>>0]<<24,t+4|0);i=e+8|0;Un(o[i>>0]|o[i+1>>0]<<8|o[i+2>>0]<<16|o[i+3>>0]<<24,t+8|0);i=e+12|0;Ln(o[i>>0]|o[i+1>>0]<<8,t+12|0);On(xn(e)|0,t+14|0);On(r[e+15>>0]|0,t+15|0);Nn(r[e+16>>0]|0,t+16|0);Nn(r[e+17>>0]|0,t+17|0);e=e+18|0;Ln(o[e>>0]|o[e+1>>0]<<8,t+18|0);return}function In(e){e=e|0;return Rn(e)|0}function Tn(e){e=e|0;return(r[e+1>>0]<<8|o[e>>0])&65535|0}function Dn(e){e=e|0;return r[e>>0]|0}function Sn(e){e=e|0;return r[e>>0]|0}function Rn(e){e=e|0;return(o[e+1>>0]|0)<<8|(o[e>>0]|0)|(o[e+2>>0]|0)<<16|(o[e+3>>0]|0)<<24|0}function Un(e,t){e=e|0;t=t|0;Vn(e,t);return}function Ln(e,t){e=e|0;t=t|0;r[t+1>>0]=(e&65535)>>>8;r[t>>0]=e;return}function On(e,t){e=e|0;t=t|0;r[t>>0]=e;return}function Nn(e,t){e=e|0;t=t|0;r[t>>0]=e;return}function Vn(e,t){e=e|0;t=t|0;r[t+3>>0]=e>>>24;r[t+2>>0]=e>>>16;r[t+1>>0]=e>>>8;r[t>>0]=e;return}function Qn(e,t){e=e|0;t=t|0;return}function Hn(e){e=e|0;ov(e);$p(e);return}function Gn(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function jn(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==9202?e+12|0:0)|0}function zn(e){e=e|0;ye(e,16);return}function Wn(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=4768;s[e+4>>2]=t;Kn(e+8|0);return}function Xn(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4792;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function Kn(e){e=e|0;qn(e);$n(e+164|0);es(e+244|0);r[e+324>>0]=0;r[e+325>>0]=0;return}function Zn(e){e=e|0;s[e>>2]=4768;ss(e+8|0);rn(e);return}function Jn(e){e=e|0;Zn(e);$p(e);return}function Yn(e,t){e=e|0;t=t|0;return as(e+8|0,s[e+4>>2]|0,t)|0}function qn(e){e=e|0;var t=0,i=0,n=0,o=0,a=0,l=0,u=0;a=J;J=J+16|0;n=a;r[e>>0]=0;Ii(e+4|0,516,0,0);Ii(e+48|0,6,0,0);s[e+92>>2]=0;s[e+96>>2]=0;i=e+100|0;rs(i);ns(n);o=s[n>>2]|0;n=s[n+4>>2]|0;t=4;while(1){l=i;u=l;r[u>>0]=o;r[u+1>>0]=o>>8;r[u+2>>0]=o>>16;r[u+3>>0]=o>>24;l=l+4|0;r[l>>0]=n;r[l+1>>0]=n>>8;r[l+2>>0]=n>>16;r[l+3>>0]=n>>24;t=t+-1|0;if(!t)break;else i=i+8|0}u=e+132|0;s[u>>2]=0;s[u+4>>2]=0;s[u+8>>2]=0;s[u+12>>2]=0;s[u+16>>2]=0;s[u+20>>2]=0;s[u+24>>2]=0;s[u+28>>2]=0;J=a;return}function $n(e){e=e|0;fn(e,32,9,8,0);return}function es(e){e=e|0;ri(e,32,9,8,0);return}function ts(e){e=e|0;vn(e);return}function is(e){e=e|0;Pi(e+48|0);Pi(e+4|0);return}function rs(e){e=e|0;var t=0;t=e+32|0;do{ns(e);e=e+8|0}while((e|0)!=(t|0));return}function ns(e){e=e|0;var t=0;t=e;r[t>>0]=0;r[t+1>>0]=0;r[t+2>>0]=0;r[t+3>>0]=0;e=e+4|0;r[e>>0]=0;r[e+1>>0]=0;r[e+2>>0]=0;r[e+3>>0]=0;return}function ss(e){e=e|0;os(e+244|0);ts(e+164|0);is(e);return}function os(e){e=e|0;ai(e);return}function as(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,a=0,l=0,u=0,A=0;n=e+325|0;if(!(r[n>>0]|0)){ls(e+244|0);r[n>>0]=1}if(!(r[e>>0]|0)){r[e>>0]=1;wn(bn(t)|0,i,8);l=us(i)|0;u=B()|0;e=e+100|0;t=e;r[t>>0]=l;r[t+1>>0]=l>>8;r[t+2>>0]=l>>16;r[t+3>>0]=l>>24;e=e+4|0;r[e>>0]=u;r[e+1>>0]=u>>8;r[e+2>>0]=u>>16;r[e+3>>0]=u>>24}else{u=e+92|0;e:do{if(!(s[e+132+(s[u>>2]<<2)>>2]|0)){n=Hi(t,e+48|0)|0;switch(n|0){case 1:{t=oi(e+244|0,t,0,0)|0;s[e+132+(s[u>>2]<<2)>>2]=t;t=s[u>>2]|0;A=s[e+132+(t<<2)>>2]|0;l=e+100+(t<<3)|0;a=l;n=a;a=a+4|0;A=ig(o[n>>0]|o[n+1>>0]<<8|o[n+2>>0]<<16|o[n+3>>0]<<24|0,o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24|0,A|0,((A|0)<0)<<31>>31|0)|0;a=B()|0;n=l;r[n>>0]=A;r[n+1>>0]=A>>8;r[n+2>>0]=A>>16;r[n+3>>0]=A>>24;l=l+4|0;r[l>>0]=a;r[l+1>>0]=a>>8;r[l+2>>0]=a>>16;r[l+3>>0]=a>>24;s[e+148+(t<<2)>>2]=0;break e}case 2:{A=e+96|0;s[A>>2]=(s[A>>2]|0)+1&3;l=e+100+(s[u>>2]<<3)+4|0;l=oi(e+244|0,t,o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24,8)|0;n=e+100+(s[A>>2]<<3)|0;a=n;r[a>>0]=0;r[a+1>>0]=0;r[a+2>>0]=0;r[a+3>>0]=0;n=n+4|0;r[n>>0]=l;r[n+1>>0]=l>>8;r[n+2>>0]=l>>16;r[n+3>>0]=l>>24;n=As(t)|0;A=s[A>>2]|0;t=e+100+(A<<3)|0;l=t;a=l;l=l+4|0;l=o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24;n=o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24|n;a=t;r[a>>0]=n;r[a+1>>0]=n>>8;r[a+2>>0]=n>>16;r[a+3>>0]=n>>24;t=t+4|0;r[t>>0]=l;r[t+1>>0]=l>>8;r[t+2>>0]=l>>16;r[t+3>>0]=l>>24;s[u>>2]=A;s[e+132+(A<<2)>>2]=0;s[e+148+(s[u>>2]<<2)>>2]=0;break e}default:{if((n|0)<=2)break e;s[u>>2]=n+2+(s[u>>2]|0)&3;as(e,t,i)|0;break e}}}else{l=Hi(t,e+4|0)|0;if((l|0)==1){n=oi(e+244|0,t,s[e+132+(s[u>>2]<<2)>>2]|0,1)|0;A=s[u>>2]|0;t=e+100+(A<<3)|0;l=t;a=l;l=l+4|0;n=ig(o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24|0,o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24|0,n|0,((n|0)<0)<<31>>31|0)|0;l=B()|0;a=t;r[a>>0]=n;r[a+1>>0]=n>>8;r[a+2>>0]=n>>16;r[a+3>>0]=n>>24;t=t+4|0;r[t>>0]=l;r[t+1>>0]=l>>8;r[t+2>>0]=l>>16;r[t+3>>0]=l>>24;s[e+148+(A<<2)>>2]=0;break}if((l|0)>=511){if((l|0)==512){A=e+96|0;s[A>>2]=(s[A>>2]|0)+1&3;l=e+100+(s[u>>2]<<3)+4|0;l=oi(e+244|0,t,o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24,8)|0;n=e+100+(s[A>>2]<<3)|0;a=n;r[a>>0]=0;r[a+1>>0]=0;r[a+2>>0]=0;r[a+3>>0]=0;n=n+4|0;r[n>>0]=l;r[n+1>>0]=l>>8;r[n+2>>0]=l>>16;r[n+3>>0]=l>>24;n=As(t)|0;A=s[A>>2]|0;t=e+100+(A<<3)|0;l=t;a=l;l=l+4|0;l=o[l>>0]|o[l+1>>0]<<8|o[l+2>>0]<<16|o[l+3>>0]<<24;n=o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24|n;a=t;r[a>>0]=n;r[a+1>>0]=n>>8;r[a+2>>0]=n>>16;r[a+3>>0]=n>>24;t=t+4|0;r[t>>0]=l;r[t+1>>0]=l>>8;r[t+2>>0]=l>>16;r[t+3>>0]=l>>24;s[u>>2]=A;s[e+132+(A<<2)>>2]=0;s[e+148+(s[u>>2]<<2)>>2]=0;break}if((l|0)<=511)break;s[u>>2]=(s[u>>2]|0)+l&3;as(e,t,i)|0;break}do{if(!l){n=oi(e+244|0,t,0,7)|0;a=e+148+(s[u>>2]<<2)|0;s[a>>2]=(s[a>>2]|0)+1;a=s[u>>2]|0;if((s[e+148+(a<<2)>>2]|0)>3){s[e+132+(a<<2)>>2]=n;s[e+148+(s[u>>2]<<2)>>2]=0}}else{if((l|0)<500){n=e+244|0;a=_(s[e+132+(s[u>>2]<<2)>>2]|0,l)|0;if((l|0)<10){n=oi(n,t,a,2)|0;break}else{n=oi(n,t,a,3)|0;break}}if((l|0)==500){n=oi(e+244|0,t,(s[e+132+(s[u>>2]<<2)>>2]|0)*500|0,4)|0;a=e+148+(s[u>>2]<<2)|0;s[a>>2]=(s[a>>2]|0)+1;a=s[u>>2]|0;if((s[e+148+(a<<2)>>2]|0)<=3)break;s[e+132+(a<<2)>>2]=n;s[e+148+(s[u>>2]<<2)>>2]=0;break}n=500-l|0;a=e+244|0;l=s[e+132+(s[u>>2]<<2)>>2]|0;if((n|0)>-10){n=oi(a,t,_(l,n)|0,5)|0;break}n=oi(a,t,_(l,-10)|0,6)|0;a=e+148+(s[u>>2]<<2)|0;s[a>>2]=(s[a>>2]|0)+1;a=s[u>>2]|0;if((s[e+148+(a<<2)>>2]|0)>3){s[e+132+(a<<2)>>2]=n;s[e+148+(s[u>>2]<<2)>>2]=0}}}while(0);A=e+100+(s[u>>2]<<3)|0;a=A;t=a;a=a+4|0;a=ig(o[t>>0]|o[t+1>>0]<<8|o[t+2>>0]<<16|o[t+3>>0]<<24|0,o[a>>0]|o[a+1>>0]<<8|o[a+2>>0]<<16|o[a+3>>0]<<24|0,n|0,((n|0)<0)<<31>>31|0)|0;t=B()|0;l=A;r[l>>0]=a;r[l+1>>0]=a>>8;r[l+2>>0]=a>>16;r[l+3>>0]=a>>24;A=A+4|0;r[A>>0]=t;r[A+1>>0]=t>>8;r[A+2>>0]=t>>16;r[A+3>>0]=t>>24}}while(0);cs(e+100+(s[u>>2]<<3)|0,i)}return i+8|0}function ls(e){e=e|0;si(e);return}function us(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;r=Rn(e)|0;hs(i,r,Rn(e+4|0)|0);e=s[i>>2]|0;w(s[i+4>>2]|0);J=t;return e|0}function As(e){e=e|0;var t=0;t=(Wi(e)|0)&65535;return((Wi(e)|0)&65535)<<16|t|0}function cs(e,t){e=e|0;t=t|0;var i=0;i=e;Vn(o[i>>0]|o[i+1>>0]<<8|o[i+2>>0]<<16|o[i+3>>0]<<24,t);e=e+4|0;Vn(o[e>>0]|o[e+1>>0]<<8|o[e+2>>0]<<16|o[e+3>>0]<<24,t+4|0);return}function hs(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;n=e;r[n>>0]=t;r[n+1>>0]=t>>8;r[n+2>>0]=t>>16;r[n+3>>0]=t>>24;t=e+4|0;r[t>>0]=i;r[t+1>>0]=i>>8;r[t+2>>0]=i>>16;r[t+3>>0]=i>>24;return}function ds(e){e=e|0;ov(e);$p(e);return}function ps(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function fs(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==9890?e+12|0:0)|0}function vs(e){e=e|0;ye(e,16);return}function gs(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=4820;s[e+4>>2]=t;_s(e+8|0);return}function ms(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4844;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function _s(e){e=e|0;r[e>>0]=0;Bs(e+1|0);Ii(e+8|0,128,0,0);Ii(e+52|0,256,0,0);Ii(e+96|0,256,0,0);Ii(e+140|0,256,0,0);Ii(e+184|0,256,0,0);Ii(e+228|0,256,0,0);Ii(e+272|0,256,0,0);return}function ys(e){e=e|0;s[e>>2]=4820;xs(e+8|0);rn(e);return}function bs(e){e=e|0;ys(e);$p(e);return}function ws(e,t){e=e|0;t=t|0;return Ps(e+8|0,s[e+4>>2]|0,t)|0}function Bs(e){e=e|0;var t=0;r[e>>0]=0;r[e+1>>0]=0;t=e+2|0;r[t>>0]=0;r[t+1>>0]=0;e=e+4|0;r[e>>0]=0;r[e+1>>0]=0;return}function xs(e){e=e|0;Pi(e+272|0);Pi(e+228|0);Pi(e+184|0);Pi(e+140|0);Pi(e+96|0);Pi(e+52|0);Pi(e+8|0);return}function Ps(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0;p=J;J=J+16|0;h=p;if(!(r[e>>0]|0)){r[e>>0]=1;wn(bn(t)|0,i,6);Cs(h,i);d=e+1|0;r[d>>0]=r[h>>0]|0;r[d+1>>0]=r[h+1>>0]|0;r[d+2>>0]=r[h+2>>0]|0;r[d+3>>0]=r[h+3>>0]|0;r[d+4>>0]=r[h+4>>0]|0;r[d+5>>0]=r[h+5>>0]|0}else{d=Hi(t,e+8|0)|0;Bs(h);if(!(d&1)){s=e+1|0;s=(o[s>>0]|o[s+1>>0]<<8)&255}else{c=(Hi(t,e+52|0)|0)&255;s=e+1|0;s=(Cn(c+((o[s>>0]|o[s+1>>0]<<8)&255)|0)|0)&255}n[h>>1]=s;if(!(d&2)){c=e+1|0;s=s|(o[c>>0]|o[c+1>>0]<<8)&-256}else{s=(Hi(t,e+96|0)|0)&255;c=e+1|0;s=((Cn((((o[c>>0]|o[c+1>>0]<<8)&65535)>>>8)+s|0)|0)&255)<<8;s=(s|a[h>>1])&65535}n[h>>1]=s;do{if(d&64){A=e+1|0;l=(s&255)-((o[A>>0]|o[A+1>>0]<<8)&255)|0;if(!(d&4)){s=e+3|0;s=(o[s>>0]|o[s+1>>0]<<8)&255}else{s=(Hi(t,e+140|0)|0)&255;c=e+3|0;c=l+((o[c>>0]|o[c+1>>0]<<8)&255)|0;s=(Cn(((c|0)<1?0:(c|0)>254?255:c&255)+s|0)|0)&255}c=h+2|0;n[c>>1]=s;if(!(d&16)){s=e+5|0;s=(o[s>>0]|o[s+1>>0]<<8)&255}else{s=Hi(t,e+228|0)|0;f=e+3|0;u=e+5|0;u=((l+(n[c>>1]&255)-((o[f>>0]|o[f+1>>0]<<8)&255)|0)/2|0)+((o[u>>0]|o[u+1>>0]<<8)&255)|0;s=(Cn(((u|0)<1?0:(u|0)>254?255:u&255)+(s&255)|0)|0)&255}u=h+4|0;n[u>>1]=s;s=((a[h>>1]|0)>>>8)-(((o[A>>0]|o[A+1>>0]<<8)&65535)>>>8)|0;if(!(d&8)){l=e+3|0;l=n[c>>1]|(o[l>>0]|o[l+1>>0]<<8)&-256}else{l=(Hi(t,e+184|0)|0)&255;f=e+3|0;f=(((o[f>>0]|o[f+1>>0]<<8)&65535)>>>8)+s|0;l=((Cn(((f|0)<1?0:(f|0)>254?255:f&255)+l|0)|0)&255)<<8;l=(l|a[c>>1])&65535}n[c>>1]=l;if(!(d&32)){f=e+5|0;n[u>>1]=n[u>>1]|(o[f>>0]|o[f+1>>0]<<8)&-256;break}else{f=Hi(t,e+272|0)|0;t=e+3|0;d=e+5|0;d=((((a[c>>1]|0)>>>8)+s-(((o[t>>0]|o[t+1>>0]<<8)&65535)>>>8)|0)/2|0)+(((o[d>>0]|o[d+1>>0]<<8)&65535)>>>8)|0;f=((Cn(((d|0)<1?0:(d|0)>254?255:d&255)+(f&255)|0)|0)&255)<<8;n[u>>1]=f|a[u>>1];break}}else{n[h+2>>1]=s;n[h+4>>1]=s}}while(0);f=e+1|0;r[f>>0]=r[h>>0]|0;r[f+1>>0]=r[h+1>>0]|0;r[f+2>>0]=r[h+2>>0]|0;r[f+3>>0]=r[h+3>>0]|0;r[f+4>>0]=r[h+4>>0]|0;r[f+5>>0]=r[h+5>>0]|0;Ms(f,i)}J=p;return i+6|0}function Cs(e,t){e=e|0;t=t|0;var i=0,r=0;r=Tn(t)|0;i=Tn(t+2|0)|0;Fs(e,r,i,Tn(t+4|0)|0);return}function Ms(e,t){e=e|0;t=t|0;var i=0;Ln(o[e>>0]|o[e+1>>0]<<8,t);i=e+2|0;Ln(o[i>>0]|o[i+1>>0]<<8,t+2|0);e=e+4|0;Ln(o[e>>0]|o[e+1>>0]<<8,t+4|0);return}function Fs(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;r[e>>0]=t;r[e+1>>0]=t>>8;t=e+2|0;r[t>>0]=i;r[t+1>>0]=i>>8;i=e+4|0;r[i>>0]=n;r[i+1>>0]=n>>8;return}function ks(e){e=e|0;ov(e);$p(e);return}function Es(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Is(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==10570?e+12|0:0)|0}function Ts(e){e=e|0;ye(e,16);return}function Ds(e,t,i){e=e|0;t=t|0;i=i|0;Jr(e);s[e>>2]=4872;s[e+4>>2]=t;Rs(e+8|0,i);return}function Ss(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4896;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function Rs(e,t){e=e|0;t=t|0;s[e>>2]=s[t>>2];r[e+4>>0]=r[t+4>>0]|0;Ns(e+8|0,t+8|0);Ns(e+20|0,t+20|0);Vs(e+32|0,t+32|0);return}function Us(e){e=e|0;s[e>>2]=4872;cr(e+8|0);rn(e);return}function Ls(e){e=e|0;Us(e);$p(e);return}function Os(e,t){e=e|0;t=t|0;return bo(e+8|0,s[e+4>>2]|0,t)|0}function Ns(e,t){e=e|0;t=t|0;var i=0,r=0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;i=t+4|0;r=(s[i>>2]|0)-(s[t>>2]|0)|0;if(r|0){Qs(e,r);Hs(e,s[t>>2]|0,s[i>>2]|0,r)}return}function Vs(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+32|0;r=i+24|0;n=i+16|0;a=i+8|0;o=i;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;s[e+20>>2]=0;go(a,t);mo(o,t);s[n>>2]=s[a>>2];s[n+4>>2]=s[a+4>>2];s[r>>2]=s[o>>2];s[r+4>>2]=s[o+4>>2];Xs(e,n,r,0);J=i;return}function Qs(e,t){e=e|0;t=t|0;var i=0;if((js(e)|0)>>>0<t>>>0)Xv(e);else{i=Zf(t)|0;s[e+4>>2]=i;s[e>>2]=i;s[e+8>>2]=i+t;return}}function Hs(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0;o=J;J=J+16|0;n=o;zs(n,e,r);r=n+4|0;e=i-t|0;if((e|0)>0){cg(s[r>>2]|0,t|0,e|0)|0;s[r>>2]=(s[r>>2]|0)+e}Ws(n);J=o;return}function Gs(e){e=e|0;var t=0,i=0;t=s[e>>2]|0;i=t;if(t|0){s[e+4>>2]=i;ye(t,(s[e+8>>2]|0)-i|0)}return}function js(e){e=e|0;return 2147483647}function zs(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;t=s[t+4>>2]|0;s[e+4>>2]=t;s[e+8>>2]=t+i;return}function Ws(e){e=e|0;s[(s[e>>2]|0)+4>>2]=s[e+4>>2];return}function Xs(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;v=J;J=J+96|0;f=v+80|0;h=v+64|0;u=v+48|0;A=v+40|0;c=v+8|0;l=v;d=v+32|0;p=v+16|0;a=t;o=s[a>>2]|0;a=s[a+4>>2]|0;n=i;i=s[n>>2]|0;n=s[n+4>>2]|0;r=o;if((n|0)==(a|0))a=0;else a=((n-(s[i>>2]|0)|0)/44|0)+((i-o>>2)*93|0)+((a-(s[o>>2]|0)|0)/-44|0)|0;i=(s[e+8>>2]|0)-(s[e+4>>2]|0)|0;i=((i|0)==0?0:((i>>2)*93|0)+-1|0)-((s[e+20>>2]|0)+(s[e+16>>2]|0))|0;if(a>>>0>i>>>0)Zs(e,a-i|0);Js(A,e);Js(l,e);n=l;i=s[n>>2]|0;n=s[n+4>>2]|0;o=c;s[o>>2]=i;s[o+4>>2]=n;o=i;if(a|0){i=((n-(s[i>>2]|0)|0)/44|0)+a|0;if((i|0)>0){l=(i>>>0)/93|0;a=o+(l<<2)|0;s[c>>2]=a;i=(s[a>>2]|0)+((i-(l*93|0)|0)*44|0)|0}else{i=92-i|0;l=o+(((i|0)/-93|0)<<2)|0;s[c>>2]=l;i=(s[l>>2]|0)+((92-((i|0)%93|0)|0)*44|0)|0}s[c+4>>2]=i}s[h>>2]=s[A>>2];s[h+4>>2]=s[A+4>>2];s[f>>2]=s[c>>2];s[f+4>>2]=s[c+4>>2];Ys(u,h,f);qs(f,u);$s(h,u);if(eo(f,h)|0){o=p+4|0;a=t+4|0;do{to(d,f);io(p,e,d);i=s[p>>2]|0;if((i|0)!=(s[o>>2]|0)){n=s[a>>2]|0;do{Ni(i,n);i=(s[p>>2]|0)+44|0;s[p>>2]=i;n=n+44|0;s[a>>2]=n;if((n-(s[r>>2]|0)|0)==4092){r=r+4|0;s[t>>2]=r;n=s[r>>2]|0;s[a>>2]=n}}while((i|0)!=(s[o>>2]|0))}ro(p);no(f)|0}while(eo(f,h)|0)}J=v;return}function Ks(e){e=e|0;var t=0,i=0,r=0;t=s[e+4>>2]|0;i=e+8|0;r=s[i>>2]|0;if((r|0)!=(t|0))s[i>>2]=r+(~((r+-4-t|0)>>>2)<<2);t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function Zs(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0,y=0,b=0,w=0,B=0,x=0,P=0,C=0,M=0,F=0;M=J;J=J+64|0;b=M+52|0;y=M+48|0;w=M+28|0;B=M+24|0;x=M+20|0;f=M;P=e+8|0;i=s[P>>2]|0;C=e+4|0;u=s[C>>2]|0;g=((i|0)==(u|0)&1)+t|0;a=(g>>>0)/93|0;a=a+((g-(a*93|0)|0)!=0&1)|0;g=e+16|0;r=s[g>>2]|0;l=(r>>>0)/93|0;v=a>>>0<l>>>0?a:l;t=a-v|0;o=i;e:do{if(!t){s[g>>2]=(_(v,-93)|0)+r;if(v|0){l=e+12|0;A=e+12|0;c=w+4|0;h=w+8|0;d=w+12|0;t=v;r=u;while(1){a=s[r>>2]|0;o=r+4|0;s[C>>2]=o;m=s[l>>2]|0;r=m;do{if((i|0)==(m|0)){m=s[e>>2]|0;i=m;if(o>>>0<=m>>>0){i=r-i|0;i=(i|0)==0?1:i>>1;ao(w,i,i>>>2,A);s[B>>2]=s[C>>2];s[x>>2]=s[P>>2];s[y>>2]=s[B>>2];s[b>>2]=s[x>>2];co(w,y,b);i=s[e>>2]|0;s[e>>2]=s[w>>2];s[w>>2]=i;i=s[C>>2]|0;s[C>>2]=s[c>>2];s[c>>2]=i;i=s[P>>2]|0;s[P>>2]=s[h>>2];s[h>>2]=i;i=s[l>>2]|0;s[l>>2]=s[d>>2];s[d>>2]=i;Ao(w);i=s[P>>2]|0;break}m=o;i=((m-i>>2)+1|0)/-2|0;n=o+(i<<2)|0;r=r-m|0;if(!r)i=n;else{hg(n|0,o|0,r|0)|0;i=(s[C>>2]|0)+(i<<2)|0}m=n+(r>>2<<2)|0;s[P>>2]=m;s[C>>2]=i;i=m}}while(0);s[i>>2]=a;i=(s[P>>2]|0)+4|0;s[P>>2]=i;t=t+-1|0;if(!t)break e;r=s[C>>2]|0}}}else{m=e+12|0;r=s[m>>2]|0;n=r-(s[e>>2]|0)|0;i=o-u>>2;if(t>>>0>((n>>2)-i|0)>>>0){p=n>>1;d=i+t|0;ao(f,p>>>0<d>>>0?d:p,i-v|0,e+12|0);do{s[b>>2]=Zf(4092)|0;lo(f,b);t=t+-1|0}while((t|0)!=0);if(!v)i=s[C>>2]|0;else{l=f+8|0;u=f+12|0;A=f+4|0;c=f+16|0;h=w+4|0;d=w+8|0;p=w+12|0;a=v;t=s[l>>2]|0;i=s[C>>2]|0;do{o=s[u>>2]|0;r=o;do{if((t|0)==(o|0)){n=s[A>>2]|0;o=s[f>>2]|0;t=o;if(n>>>0<=o>>>0){t=r-t|0;t=(t|0)==0?1:t>>1;ao(w,t,t>>>2,s[c>>2]|0);s[B>>2]=s[A>>2];s[x>>2]=s[l>>2];s[y>>2]=s[B>>2];s[b>>2]=s[x>>2];co(w,y,b);t=s[f>>2]|0;s[f>>2]=s[w>>2];s[w>>2]=t;t=s[A>>2]|0;s[A>>2]=s[h>>2];s[h>>2]=t;t=s[l>>2]|0;s[l>>2]=s[d>>2];s[d>>2]=t;t=s[u>>2]|0;s[u>>2]=s[p>>2];s[p>>2]=t;Ao(w);t=s[l>>2]|0;break}F=n;t=((F-t>>2)+1|0)/-2|0;o=n+(t<<2)|0;r=r-F|0;if(!r)t=o;else{hg(o|0,n|0,r|0)|0;t=(s[A>>2]|0)+(t<<2)|0}F=o+(r>>2<<2)|0;s[l>>2]=F;s[A>>2]=t;t=F}}while(0);s[t>>2]=s[i>>2];t=(s[l>>2]|0)+4|0;s[l>>2]=t;i=(s[C>>2]|0)+4|0;s[C>>2]=i;a=a+-1|0}while((a|0)!=0)}t=s[P>>2]|0;if((t|0)!=(i|0)){do{t=t+-4|0;uo(f,t);i=s[C>>2]|0}while((t|0)!=(i|0));t=s[P>>2]|0}F=s[e>>2]|0;s[e>>2]=s[f>>2];s[f>>2]=F;F=f+4|0;s[C>>2]=s[F>>2];s[F>>2]=i;F=f+8|0;s[P>>2]=s[F>>2];s[F>>2]=t;F=f+12|0;C=s[m>>2]|0;s[m>>2]=s[F>>2];s[F>>2]=C;s[g>>2]=(s[g>>2]|0)+(_(v,-93)|0);Ao(f);break}else{t:do{if((r|0)==(o|0))A=18;else{while(1){s[b>>2]=Zf(4092)|0;so(e,b);t=t+-1|0;if(!t)break;if((s[m>>2]|0)==(s[P>>2]|0)){A=18;break t}}i=v;t=s[g>>2]|0}}while(0);if((A|0)==18){r=~(a>>>0>l>>>0?l:a);i=t;do{s[b>>2]=Zf(4092)|0;oo(e,b);i=i+-1|0;n=(((s[P>>2]|0)-(s[C>>2]|0)|0)==4?92:93)+(s[g>>2]|0)|0;s[g>>2]=n}while((i|0)!=0);i=t+-1-r|0;t=n}s[g>>2]=t+(_(i,-93)|0);if(!i)break;l=e+12|0;u=w+4|0;A=w+8|0;c=w+12|0;t=s[P>>2]|0;do{o=s[C>>2]|0;a=s[o>>2]|0;o=o+4|0;s[C>>2]=o;F=s[m>>2]|0;r=F;do{if((t|0)==(F|0)){F=s[e>>2]|0;t=F;if(o>>>0<=F>>>0){t=r-t|0;t=(t|0)==0?1:t>>1;ao(w,t,t>>>2,l);s[B>>2]=s[C>>2];s[x>>2]=s[P>>2];s[y>>2]=s[B>>2];s[b>>2]=s[x>>2];co(w,y,b);t=s[e>>2]|0;s[e>>2]=s[w>>2];s[w>>2]=t;t=s[C>>2]|0;s[C>>2]=s[u>>2];s[u>>2]=t;t=s[P>>2]|0;s[P>>2]=s[A>>2];s[A>>2]=t;t=s[m>>2]|0;s[m>>2]=s[c>>2];s[c>>2]=t;Ao(w);t=s[P>>2]|0;break}F=o;t=((F-t>>2)+1|0)/-2|0;n=o+(t<<2)|0;r=r-F|0;if(!r)t=n;else{hg(n|0,o|0,r|0)|0;t=(s[C>>2]|0)+(t<<2)|0}F=n+(r>>2<<2)|0;s[P>>2]=F;s[C>>2]=t;t=F}}while(0);s[t>>2]=a;t=(s[P>>2]|0)+4|0;s[P>>2]=t;i=i+-1|0}while((i|0)!=0)}}}while(0);J=M;return}function Js(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;i=(s[t+16>>2]|0)+(s[t+20>>2]|0)|0;o=s[t+4>>2]|0;r=(i>>>0)/93|0;n=o+(r<<2)|0;if((s[t+8>>2]|0)==(o|0))t=0;else t=(s[n>>2]|0)+((i-(r*93|0)|0)*44|0)|0;s[e>>2]=n;s[e+4>>2]=t;return}function Ys(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=t;t=s[n+4>>2]|0;r=e;s[r>>2]=s[n>>2];s[r+4>>2]=t;r=i;t=s[r+4>>2]|0;i=e+8|0;s[i>>2]=s[r>>2];s[i+4>>2]=t;return}function qs(e,t){e=e|0;t=t|0;s[e>>2]=s[t>>2];s[e+4>>2]=s[t+4>>2];s[e+8>>2]=s[t+8>>2];s[e+12>>2]=s[t+12>>2];return}function $s(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0;i=J;J=J+32|0;r=i+24|0;n=i+16|0;a=i+8|0;o=i;l=t+8|0;u=s[l>>2]|0;l=s[l+4>>2]|0;t=a;s[t>>2]=u;s[t+4>>2]=l;t=o;s[t>>2]=u;s[t+4>>2]=l;s[n>>2]=s[a>>2];s[n+4>>2]=s[a+4>>2];s[r>>2]=s[o>>2];s[r+4>>2]=s[o+4>>2];Ys(e,n,r);J=i;return}function eo(e,t){e=e|0;t=t|0;return(fo(e,t)|0)^1|0}function to(e,t){e=e|0;t=t|0;var i=0,r=0;i=s[t>>2]|0;r=s[t+4>>2]|0;if((i|0)==(s[t+8>>2]|0))vo(e,r,s[t+12>>2]|0);else vo(e,r,(s[i>>2]|0)+4092|0);return}function io(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;r=s[i>>2]|0;s[e>>2]=r;s[e+4>>2]=s[i+4>>2];s[e+8>>2]=r;s[e+12>>2]=t;return}function ro(e){e=e|0;var t=0;t=(s[e+12>>2]|0)+20|0;s[t>>2]=(s[t>>2]|0)+(((s[e>>2]|0)-(s[e+8>>2]|0)|0)/44|0);return}function no(e){e=e|0;var t=0,i=0,r=0;t=s[e>>2]|0;i=e+8|0;if((t|0)==(s[i>>2]|0)){r=i;t=s[r+4>>2]|0;i=e;s[i>>2]=s[r>>2];s[i+4>>2]=t}else{r=t+4|0;s[e>>2]=r;s[e+4>>2]=s[r>>2]}return e|0}function so(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;f=J;J=J+48|0;n=f+32|0;r=f+28|0;l=f+8|0;u=f+4|0;A=f;p=e+8|0;i=s[p>>2]|0;c=e+12|0;d=s[c>>2]|0;o=d;do{if((i|0)==(d|0)){d=e+4|0;h=s[d>>2]|0;v=s[e>>2]|0;a=v;if(h>>>0<=v>>>0){i=o-a|0;i=(i|0)==0?1:i>>1;ao(l,i,i>>>2,e+12|0);s[u>>2]=s[d>>2];s[A>>2]=s[p>>2];s[r>>2]=s[u>>2];s[n>>2]=s[A>>2];co(l,r,n);i=s[e>>2]|0;s[e>>2]=s[l>>2];s[l>>2]=i;i=l+4|0;v=s[d>>2]|0;s[d>>2]=s[i>>2];s[i>>2]=v;i=l+8|0;v=s[p>>2]|0;s[p>>2]=s[i>>2];s[i>>2]=v;i=l+12|0;v=s[c>>2]|0;s[c>>2]=s[i>>2];s[i>>2]=v;Ao(l);i=s[p>>2]|0;break}n=h;r=((n-a>>2)+1|0)/-2|0;e=h+(r<<2)|0;n=i-n|0;if(!n)i=e;else{hg(e|0,h|0,n|0)|0;i=(s[d>>2]|0)+(r<<2)|0}v=e+(n>>2<<2)|0;s[p>>2]=v;s[d>>2]=i;i=v}}while(0);s[i>>2]=s[t>>2];s[p>>2]=(s[p>>2]|0)+4;J=f;return}function oo(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;f=J;J=J+48|0;r=f+32|0;i=f+28|0;a=f+8|0;l=f+4|0;u=f;p=e+4|0;h=s[p>>2]|0;d=s[e>>2]|0;A=d;do{if((h|0)==(d|0)){d=e+8|0;c=s[d>>2]|0;o=e+12|0;v=s[o>>2]|0;n=v;if(c>>>0>=v>>>0){v=n-A|0;v=(v|0)==0?1:v>>1;ao(a,v,(v+3|0)>>>2,e+12|0);s[l>>2]=s[p>>2];s[u>>2]=s[d>>2];s[i>>2]=s[l>>2];s[r>>2]=s[u>>2];co(a,i,r);i=s[e>>2]|0;s[e>>2]=s[a>>2];s[a>>2]=i;i=a+4|0;v=s[p>>2]|0;s[p>>2]=s[i>>2];s[i>>2]=v;i=a+8|0;v=s[d>>2]|0;s[d>>2]=s[i>>2];s[i>>2]=v;i=a+12|0;v=s[o>>2]|0;s[o>>2]=s[i>>2];s[i>>2]=v;Ao(a);i=s[p>>2]|0;break}r=c;e=((n-r>>2)+1|0)/2|0;n=c+(e<<2)|0;r=r-h|0;i=n+(0-(r>>2)<<2)|0;if(!r){i=n;r=n}else{hg(i|0,h|0,r|0)|0;r=(s[d>>2]|0)+(e<<2)|0}s[p>>2]=i;s[d>>2]=r}else i=h}while(0);s[i+-4>>2]=s[t>>2];s[p>>2]=(s[p>>2]|0)+-4;J=f;return}function ao(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;n=e+12|0;s[n>>2]=0;s[e+16>>2]=r;do{if(t){if(t>>>0>1073741823){n=x(8)|0;hv(n,6723);s[n>>2]=5956;C(n|0,3928,123)}else{r=Zf(t<<2)|0;break}}else r=0}while(0);s[e>>2]=r;i=r+(i<<2)|0;s[e+8>>2]=i;s[e+4>>2]=i;s[n>>2]=r+(t<<2);return}function lo(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;f=J;J=J+48|0;n=f+32|0;r=f+28|0;l=f+8|0;u=f+4|0;A=f;p=e+8|0;i=s[p>>2]|0;c=e+12|0;d=s[c>>2]|0;o=d;do{if((i|0)==(d|0)){d=e+4|0;h=s[d>>2]|0;v=s[e>>2]|0;a=v;if(h>>>0<=v>>>0){i=o-a|0;i=(i|0)==0?1:i>>1;ao(l,i,i>>>2,s[e+16>>2]|0);s[u>>2]=s[d>>2];s[A>>2]=s[p>>2];s[r>>2]=s[u>>2];s[n>>2]=s[A>>2];co(l,r,n);i=s[e>>2]|0;s[e>>2]=s[l>>2];s[l>>2]=i;i=l+4|0;v=s[d>>2]|0;s[d>>2]=s[i>>2];s[i>>2]=v;i=l+8|0;v=s[p>>2]|0;s[p>>2]=s[i>>2];s[i>>2]=v;i=l+12|0;v=s[c>>2]|0;s[c>>2]=s[i>>2];s[i>>2]=v;Ao(l);i=s[p>>2]|0;break}n=h;r=((n-a>>2)+1|0)/-2|0;e=h+(r<<2)|0;n=i-n|0;if(!n)i=e;else{hg(e|0,h|0,n|0)|0;i=(s[d>>2]|0)+(r<<2)|0}v=e+(n>>2<<2)|0;s[p>>2]=v;s[d>>2]=i;i=v}}while(0);s[i>>2]=s[t>>2];s[p>>2]=(s[p>>2]|0)+4;J=f;return}function uo(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0;f=J;J=J+48|0;r=f+32|0;i=f+28|0;a=f+8|0;l=f+4|0;u=f;p=e+4|0;h=s[p>>2]|0;d=s[e>>2]|0;A=d;do{if((h|0)==(d|0)){d=e+8|0;c=s[d>>2]|0;o=e+12|0;v=s[o>>2]|0;n=v;if(c>>>0>=v>>>0){v=n-A|0;v=(v|0)==0?1:v>>1;ao(a,v,(v+3|0)>>>2,s[e+16>>2]|0);s[l>>2]=s[p>>2];s[u>>2]=s[d>>2];s[i>>2]=s[l>>2];s[r>>2]=s[u>>2];co(a,i,r);i=s[e>>2]|0;s[e>>2]=s[a>>2];s[a>>2]=i;i=a+4|0;v=s[p>>2]|0;s[p>>2]=s[i>>2];s[i>>2]=v;i=a+8|0;v=s[d>>2]|0;s[d>>2]=s[i>>2];s[i>>2]=v;i=a+12|0;v=s[o>>2]|0;s[o>>2]=s[i>>2];s[i>>2]=v;Ao(a);i=s[p>>2]|0;break}r=c;e=((n-r>>2)+1|0)/2|0;n=c+(e<<2)|0;r=r-h|0;i=n+(0-(r>>2)<<2)|0;if(!r){i=n;r=n}else{hg(i|0,h|0,r|0)|0;r=(s[d>>2]|0)+(e<<2)|0}s[p>>2]=i;s[d>>2]=r}else i=h}while(0);s[i+-4>>2]=s[t>>2];s[p>>2]=(s[p>>2]|0)+-4;J=f;return}function Ao(e){e=e|0;var t=0,i=0,r=0;t=s[e+4>>2]|0;i=e+8|0;r=s[i>>2]|0;if((r|0)!=(t|0))s[i>>2]=r+(~((r+-4-t|0)>>>2)<<2);t=s[e>>2]|0;if(t|0)ye(t,(s[e+12>>2]|0)-t|0);return}function co(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0;a=J;J=J+16|0;o=a;n=s[t>>2]|0;ho(o,e+8|0,(s[i>>2]|0)-n>>2);e=s[o>>2]|0;r=o+4|0;if((e|0)!=(s[r>>2]|0)){i=n;do{s[e>>2]=s[i>>2];e=(s[o>>2]|0)+4|0;s[o>>2]=e;i=i+4|0}while((e|0)!=(s[r>>2]|0));s[t>>2]=i}po(o);J=a;return}function ho(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=s[t>>2];s[e+4>>2]=(s[t>>2]|0)+(i<<2);s[e+8>>2]=t;return}function po(e){e=e|0;s[s[e+8>>2]>>2]=s[e>>2];return}function fo(e,t){e=e|0;t=t|0;return(s[e+4>>2]|0)==(s[t+4>>2]|0)|0}function vo(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;s[e+4>>2]=i;return}function go(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;o=s[t+4>>2]|0;i=s[t+16>>2]|0;r=(i>>>0)/93|0;n=o+(r<<2)|0;if((s[t+8>>2]|0)==(o|0))t=0;else t=(s[n>>2]|0)+((i-(r*93|0)|0)*44|0)|0;s[e>>2]=n;s[e+4>>2]=t;return}function mo(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;i=(s[t+16>>2]|0)+(s[t+20>>2]|0)|0;o=s[t+4>>2]|0;r=(i>>>0)/93|0;n=o+(r<<2)|0;if((s[t+8>>2]|0)==(o|0))t=0;else t=(s[n>>2]|0)+((i-(r*93|0)|0)*44|0)|0;s[e>>2]=n;s[e+4>>2]=t;return}function _o(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0;l=J;J=J+16|0;r=l+8|0;o=l;yo(r,e);Js(o,e);n=r+4|0;t=s[n>>2]|0;o=o+4|0;if((t|0)!=(s[o>>2]|0))do{Pi(t);t=(s[n>>2]|0)+44|0;s[n>>2]=t;i=s[r>>2]|0;if((t-(s[i>>2]|0)|0)==4092){t=i+4|0;s[r>>2]=t;t=s[t>>2]|0;s[n>>2]=t}}while((t|0)!=(s[o>>2]|0));s[e+20>>2]=0;n=e+8|0;r=e+4|0;i=s[r>>2]|0;t=(s[n>>2]|0)-i>>2;if(t>>>0>2)do{ye(s[i>>2]|0,4092);i=(s[r>>2]|0)+4|0;s[r>>2]=i;t=(s[n>>2]|0)-i>>2}while(t>>>0>2);switch(t|0){case 1:{t=46;a=11;break}case 2:{t=93;a=11;break}default:{}}if((a|0)==11)s[e+16>>2]=t;J=l;return}function yo(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;o=s[t+4>>2]|0;i=s[t+16>>2]|0;r=(i>>>0)/93|0;n=o+(r<<2)|0;if((s[t+8>>2]|0)==(o|0))t=0;else t=(s[n>>2]|0)+((i-(r*93|0)|0)*44|0)|0;s[e>>2]=n;s[e+4>>2]=t;return}function bo(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,a=0,l=0,u=0,A=0,c=0,h=0;h=J;J=J+16|0;c=h;u=e+4|0;if(!(r[u>>0]|0)){c=bn(t)|0;wn(c,i,s[e>>2]|0);c=s[e>>2]|0;l=i+c|0;if(!c)n=0;else{n=i;a=s[e+8>>2]|0;while(1){r[a>>0]=r[n>>0]|0;n=n+1|0;if((n|0)==(l|0))break;else a=a+1|0}n=s[e>>2]|0}r[u>>0]=1;i=i+n|0}else{a=s[e+20>>2]|0;n=s[e+8>>2]|0;yo(c,e+32|0);e=e+12|0;if((n|0)!=(s[e>>2]|0)){A=c+4|0;u=n;l=a;n=s[A>>2]|0;while(1){a=o[u>>0]|0;a=wo((Hi(t,n)|0)+a|0)|0;r[l>>0]=a;r[i>>0]=a;r[u>>0]=a;u=u+1|0;i=i+1|0;a=s[c>>2]|0;n=(s[A>>2]|0)+44|0;s[A>>2]=n;if((n-(s[a>>2]|0)|0)==4092){n=a+4|0;s[c>>2]=n;n=s[n>>2]|0;s[A>>2]=n}if((u|0)==(s[e>>2]|0))break;else l=l+1|0}}}J=h;return i|0}function wo(e){e=e|0;return e&255|0}function Bo(e){e=e|0;ov(e);$p(e);return}function xo(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Po(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==11262?e+12|0:0)|0}function Co(e){e=e|0;ye(e,16);return}function Mo(e,t){e=e|0;t=t|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;if(t|0){Qs(e,t);ko(e,t)}return}function Fo(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;s[e+20>>2]=0;if(t|0)Eo(e,t,i);return}function ko(e,t){e=e|0;t=t|0;var i=0,n=0,o=0;o=J;J=J+16|0;n=o;zs(n,e,t);t=n+4|0;e=s[t>>2]|0;i=n+8|0;if((e|0)!=(s[i>>2]|0))do{r[e>>0]=0;e=(s[t>>2]|0)+1|0;s[t>>2]=e}while((e|0)!=(s[i>>2]|0));Ws(n);J=o;return}function Eo(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;p=J;J=J+96|0;d=p+80|0;A=p+64|0;a=p+48|0;l=p+40|0;u=p+8|0;n=p;c=p+32|0;h=p+16|0;r=(s[e+8>>2]|0)-(s[e+4>>2]|0)|0;r=((r|0)==0?0:((r>>2)*93|0)+-1|0)-((s[e+20>>2]|0)+(s[e+16>>2]|0))|0;if(r>>>0<t>>>0)Zs(e,t-r|0);Js(l,e);Js(n,e);r=s[n>>2]|0;n=s[n+4>>2]|0;o=u;s[o>>2]=r;s[o+4>>2]=n;o=r;if(t|0){r=((n-(s[r>>2]|0)|0)/44|0)+t|0;if((r|0)>0){t=(r>>>0)/93|0;o=o+(t<<2)|0;s[u>>2]=o;r=(s[o>>2]|0)+((r-(t*93|0)|0)*44|0)|0}else{r=92-r|0;t=o+(((r|0)/-93|0)<<2)|0;s[u>>2]=t;r=(s[t>>2]|0)+((92-((r|0)%93|0)|0)*44|0)|0}s[u+4>>2]=r}s[A>>2]=s[l>>2];s[A+4>>2]=s[l+4>>2];s[d>>2]=s[u>>2];s[d+4>>2]=s[u+4>>2];Ys(a,A,d);qs(d,a);$s(A,a);if(eo(d,A)|0){n=h+4|0;do{to(c,d);io(h,e,c);r=s[h>>2]|0;if((r|0)!=(s[n>>2]|0))do{Ni(r,i);r=(s[h>>2]|0)+44|0;s[h>>2]=r}while((r|0)!=(s[n>>2]|0));ro(h);no(d)|0}while(eo(d,A)|0)}J=p;return}function Io(e){e=e|0;var t=0,i=0;_o(e);t=s[e+4>>2]|0;i=s[e+8>>2]|0;if((t|0)!=(i|0))do{ye(s[t>>2]|0,4092);t=t+4|0}while((t|0)!=(i|0));Ks(e);return}function To(e,t,i){e=e|0;t=t|0;i=i|0;kr(e);s[e>>2]=4924;s[e+4>>2]=t;s[e+8>>2]=i;return}function Do(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4944;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Vo(e,r);J=i;return}function So(e,t){e=e|0;t=t|0;return Lo(s[e+8>>2]|0,s[e+4>>2]|0,t)|0}function Ro(e){e=e|0;var t=0,i=0;s[e>>2]=4924;i=e+8|0;t=s[i>>2]|0;s[i>>2]=0;if(t|0){No(t);$p(t)}Dr(e);return}function Uo(e){e=e|0;Ro(e);$p(e);return}function Lo(e,t,i){e=e|0;t=t|0;i=i|0;return Oo(e+4784|0,t,_n(e,t,i)|0)|0}function Oo(e,t,i){e=e|0;t=t|0;i=i|0;if(r[e>>0]|0){ni(t);r[e>>0]=0}return i|0}function No(e){e=e|0;gn(e);return}function Vo(e,t){e=e|0;t=t|0;return}function Qo(e){e=e|0;ov(e);$p(e);return}function Ho(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function Go(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==12004?e+12|0:0)|0}function jo(e){e=e|0;ye(e,16);return}function zo(e){e=e|0;r[e>>0]=1;return}function Wo(e,t,i){e=e|0;t=t|0;i=i|0;kr(e);s[e>>2]=4972;s[e+4>>2]=t;s[e+8>>2]=i;return}function Xo(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=4992;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Vo(e,r);J=i;return}function Ko(e,t){e=e|0;t=t|0;return Yo(s[e+8>>2]|0,s[e+4>>2]|0,t)|0}function Zo(e){e=e|0;var t=0,i=0;s[e>>2]=4972;i=e+8|0;t=s[i>>2]|0;s[i>>2]=0;if(t|0){$o(t);$p(t)}Dr(e);return}function Jo(e){e=e|0;Zo(e);$p(e);return}function Yo(e,t,i){e=e|0;t=t|0;i=i|0;return qo(e+4784|0,t,_n(e,t,i)|0)|0}function qo(e,t,i){e=e|0;t=t|0;i=i|0;return Oo(e+328|0,t,as(e,t,i)|0)|0}function $o(e){e=e|0;ea(e+4784|0);gn(e);return}function ea(e){e=e|0;ss(e);return}function ta(e){e=e|0;ov(e);$p(e);return}function ia(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function ra(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==12827?e+12|0:0)|0}function na(e){e=e|0;ye(e,16);return}function sa(e){e=e|0;Kn(e);zo(e+328|0);return}function oa(e,t,i){e=e|0;t=t|0;i=i|0;kr(e);s[e>>2]=5020;s[e+4>>2]=t;s[e+8>>2]=i;return}function aa(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5040;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Vo(e,r);J=i;return}function la(e,t){e=e|0;t=t|0;return ca(s[e+8>>2]|0,s[e+4>>2]|0,t)|0}function ua(e){e=e|0;var t=0,i=0;s[e>>2]=5020;i=e+8|0;t=s[i>>2]|0;s[i>>2]=0;if(t|0){da(t);$p(t)}Dr(e);return}function Aa(e){e=e|0;ua(e);$p(e);return}function ca(e,t,i){e=e|0;t=t|0;i=i|0;return ha(e+4784|0,t,_n(e,t,i)|0)|0}function ha(e,t,i){e=e|0;t=t|0;i=i|0;return Oo(e+316|0,t,Ps(e,t,i)|0)|0}function da(e){e=e|0;pa(e+4784|0);gn(e);return}function pa(e){e=e|0;xs(e);return}function fa(e){e=e|0;ov(e);$p(e);return}function va(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function ga(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==13672?e+12|0:0)|0}function ma(e){e=e|0;ye(e,16);return}function _a(e){e=e|0;_s(e);zo(e+316|0);return}function ya(e,t,i){e=e|0;t=t|0;i=i|0;kr(e);s[e>>2]=5068;s[e+4>>2]=t;s[e+8>>2]=i;return}function ba(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5088;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Vo(e,r);J=i;return}function wa(e,t){e=e|0;t=t|0;return Pa(s[e+8>>2]|0,s[e+4>>2]|0,t)|0}function Ba(e){e=e|0;var t=0,i=0;s[e>>2]=5068;i=e+8|0;t=s[i>>2]|0;s[i>>2]=0;if(t|0){Ma(t);$p(t)}Dr(e);return}function xa(e){e=e|0;Ba(e);$p(e);return}function Pa(e,t,i){e=e|0;t=t|0;i=i|0;return Ca(e+4784|0,t,_n(e,t,i)|0)|0}function Ca(e,t,i){e=e|0;t=t|0;i=i|0;return ha(e+328|0,t,as(e,t,i)|0)|0}function Ma(e){e=e|0;Fa(e+4784|0);gn(e);return}function Fa(e){e=e|0;pa(e+328|0);ss(e);return}function ka(e){e=e|0;ov(e);$p(e);return}function Ea(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function Ia(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==14573?e+12|0:0)|0}function Ta(e){e=e|0;ye(e,16);return}function Da(e){e=e|0;Kn(e);_a(e+328|0);return}function Sa(e){e=e|0;return e+20|0}function Ra(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=t;s[e+4>>2]=i;s[e+8>>2]=0;return}function Ua(e,t){e=e|0;t=t|0;s[e>>2]=t;s[e+4>>2]=0;s[e+8>>2]=-1;return}function La(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;i=J;J=J+16|0;r=i+4|0;o=i;n=Zf(24)|0;el(n,t);s[o>>2]=0;s[r>>2]=s[o>>2];tl(e,n,r);J=i;return}function Oa(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Na(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5116;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qa(e,r);J=i;return}function Va(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Qa(e,t){e=e|0;t=t|0;return}function Ha(e){e=e|0;ov(e);$p(e);return}function Ga(e){e=e|0;e=s[e+12>>2]|0;if(e|0)$p(e);return}function ja(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==14966?e+12|0:0)|0}function za(e){e=e|0;ye(e,16);return}function Wa(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5144;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Ka(e,r);J=i;return}function Xa(e){e=e|0;var t=0,i=0;e=s[e+4>>2]|0;if(e|0?(i=e+4|0,t=s[i>>2]|0,s[i>>2]=t+-1,(t|0)==0):0){jg[s[(s[e>>2]|0)+8>>2]&255](e);av(e)}return}function Ka(e,t){e=e|0;t=t|0;return}function Za(e){e=e|0;ov(e);$p(e);return}function Ja(e){e=e|0;e=s[e+12>>2]|0;if(e|0){$a(e);$p(e)}return}function Ya(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==15127?e+12|0:0)|0}function qa(e){e=e|0;ye(e,16);return}function $a(e){e=e|0;return}function el(e,t){e=e|0;t=t|0;kr(e);s[e>>2]=5172;s[e+4>>2]=t;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;r[e+20>>0]=1;return}function tl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5192;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;al(e,r);J=i;return}function il(e,t){e=e|0;t=t|0;var i=0,n=0,o=0,a=0,l=0,u=0,A=0;A=J;J=J+16|0;a=A;i=s[e+8>>2]|0;l=s[e+12>>2]|0;if((i|0)!=(l|0)){u=a+4|0;do{n=s[i>>2]|0;s[a>>2]=n;o=s[i+4>>2]|0;s[u>>2]=o;if(o|0){o=o+4|0;s[o>>2]=(s[o>>2]|0)+1}t=Qg[s[(s[n>>2]|0)+12>>2]&63](n,t)|0;Rr(a);i=i+8|0}while((i|0)!=(l|0))}i=e+20|0;if(r[i>>0]|0){r[i>>0]=0;sl(s[e+4>>2]|0)}J=A;return t|0}function rl(e){e=e|0;s[e>>2]=5172;Ur(e+8|0);Dr(e);return}function nl(e){e=e|0;rl(e);$p(e);return}function sl(e){e=e|0;var t=0;t=((ol(s[e>>2]|0)|0)&255)<<24;t=((ol(s[e>>2]|0)|0)&255)<<16|t;t=t|((ol(s[e>>2]|0)|0)&255)<<8;s[e+4>>2]=t|(ol(s[e>>2]|0)|0)&255;return}function ol(e){e=e|0;var t=0,i=0;t=s[e>>2]|0;i=e+8|0;e=s[i>>2]|0;s[i>>2]=e+1;return r[t+e>>0]|0}function al(e,t){e=e|0;t=t|0;return}function ll(e){e=e|0;ov(e);$p(e);return}function ul(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+8>>2]&255](e);return}function Al(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==15450?e+12|0:0)|0}function cl(e){e=e|0;ye(e,16);return}function hl(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(180)|0;pl(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];fl(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function dl(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(180)|0;Ol(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];Nl(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function pl(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5220;s[e+4>>2]=t;vl(e+8|0);return}function fl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5244;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function vl(e){e=e|0;fn(e,32,1,8,0);ri(e+80|0,32,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;yl(e+164|0);return}function gl(e){e=e|0;s[e>>2]=5220;bl(e+8|0);rn(e);return}function ml(e){e=e|0;gl(e);$p(e);return}function _l(e,t){e=e|0;t=t|0;return wl(e+8|0,s[e+4>>2]|0,t)|0}function yl(e){e=e|0;r[e+4>>0]=0;return}function bl(e){e=e|0;ai(e+80|0);vn(e);return}function wl(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0;a=J;J=J+16|0;n=a;if(!(r[e+161>>0]|0))si(e+80|0);o=e+164|0;if(Bl(o)|0){t=xl(e+80|0,t,s[o>>2]|0,0)|0;s[n>>2]=t;Un(t,i)}else{Cl(Pl(t)|0,i,4);s[n>>2]=In(i)|0}Ml(o,n);J=a;return i+4|0}function Bl(e){e=e|0;return(r[e+4>>0]|0)!=0|0}function xl(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;i=(Fl(e,t,(s[e+36>>2]|0)+(r*44|0)|0)|0)+i|0;t=s[e+24>>2]|0;if((i|0)<0)return i+t|0;else return i-(i>>>0<t>>>0?0:t)|0;return 0}function Pl(e){e=e|0;return s[e>>2]|0}function Cl(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;if((i|0)>0){n=0;do{r[t+n>>0]=ol(e)|0;n=n+1|0}while((n|0)!=(i|0))}return}function Ml(e,t){e=e|0;t=t|0;var i=0;i=e+4|0;if(!(r[i>>0]|0))r[i>>0]=1;s[e>>2]=s[t>>2];return}function Fl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;i=kl(t,i)|0;s[e>>2]=i;do{if(i){if(i>>>0>=32){i=s[e+28>>2]|0;break}r=s[e+12>>2]|0;if(i>>>0>r>>>0){r=i-r|0;i=kl(t,(s[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;r=i<<r|(El(t,r)|0)}else r=kl(t,(s[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;i=s[e>>2]|0;if((r|0)<(1<<i+-1|0)){i=r+1+(-1<<i)|0;break}else{i=r+1|0;break}}else i=Il(t,e+48|0)|0}while(0);return i|0}function kl(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;d=e+8|0;h=s[d>>2]|0;n=s[t+16>>2]|0;if(n){r=e+4|0;i=s[r>>2]|0;c=h>>>15;s[d>>2]=c;u=(i>>>0)/(c>>>0)|0;l=u>>>(s[t+40>>2]|0);o=s[n+(l<<2)>>2]|0;l=(s[n+(l+1<<2)>>2]|0)+1|0;a=o+1|0;A=s[t+8>>2]|0;if(l>>>0>a>>>0){n=o;o=l;do{a=(o+n|0)>>>1;l=(s[A+(a<<2)>>2]|0)>>>0>u>>>0;n=l?n:a;o=l?a:o;a=n+1|0}while(o>>>0>a>>>0);o=n}n=_(s[A+(o<<2)>>2]|0,c)|0;if((o|0)==(s[t+32>>2]|0))a=h;else a=_(s[A+(a<<2)>>2]|0,c)|0}else{A=h>>>15;s[d>>2]=A;l=s[t>>2]|0;c=s[t+8>>2]|0;r=e+4|0;i=s[r>>2]|0;u=l>>>1;n=0;a=h;o=0;do{p=_(s[c+(u<<2)>>2]|0,A)|0;h=p>>>0>i>>>0;a=h?p:a;n=h?n:p;o=h?o:u;l=h?u:l;u=(o+l|0)>>>1}while((u|0)!=(o|0))}s[r>>2]=i-n;p=a-n|0;s[d>>2]=p;if(p>>>0<16777216)Tl(e);d=(s[t+12>>2]|0)+(o<<2)|0;s[d>>2]=(s[d>>2]|0)+1;d=t+28|0;p=(s[d>>2]|0)+-1|0;s[d>>2]=p;if(!p)Vi(t);return o|0}function El(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;if(t>>>0>19){i=(Dl(e)|0)&65535;return(El(e,t+-16|0)|0)<<16|i|0}r=e+4|0;n=s[r>>2]|0;o=e+8|0;i=(s[o>>2]|0)>>>t;s[o>>2]=i;t=(n>>>0)/(i>>>0)|0;s[r>>2]=n-(_(t,i)|0);if(i>>>0<16777216)Tl(e);return t|0}function Il(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0,l=0;r=e+8|0;n=s[r>>2]|0;i=_(n>>>13,s[t+8>>2]|0)|0;o=e+4|0;a=s[o>>2]|0;l=a>>>0>=i>>>0;if(l){s[o>>2]=a-i;i=n-i|0;s[r>>2]=i}else{s[r>>2]=i;a=t+12|0;s[a>>2]=(s[a>>2]|0)+1}if(i>>>0<16777216)Tl(e);a=t+4|0;e=(s[a>>2]|0)+-1|0;s[a>>2]=e;if(!e)Xi(t);return l&1|0}function Tl(e){e=e|0;var t=0,i=0,r=0,n=0;t=e+4|0;i=e+8|0;r=s[t>>2]|0;do{r=r<<8|(ol(s[e>>2]|0)|0)&255;s[t>>2]=r;n=s[i>>2]<<8;s[i>>2]=n}while(n>>>0<16777216);return}function Dl(e){e=e|0;var t=0,i=0,r=0,n=0;i=e+4|0;n=s[i>>2]|0;t=e+8|0;r=(s[t>>2]|0)>>>16;s[t>>2]=r;t=(n>>>0)/(r>>>0)|0;s[i>>2]=n-(_(t,r)|0);Tl(e);return t&65535|0}function Sl(e){e=e|0;ov(e);$p(e);return}function Rl(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Ul(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==15904?e+12|0:0)|0}function Ll(e){e=e|0;ye(e,16);return}function Ol(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5272;s[e+4>>2]=t;Vl(e+8|0);return}function Nl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5296;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function Vl(e){e=e|0;fn(e,32,1,8,0);ri(e+80|0,32,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;jl(e+164|0);return}function Ql(e){e=e|0;s[e>>2]=5272;zl(e+8|0);rn(e);return}function Hl(e){e=e|0;Ql(e);$p(e);return}function Gl(e,t){e=e|0;t=t|0;return Wl(e+8|0,s[e+4>>2]|0,t)|0}function jl(e){e=e|0;r[e+4>>0]=0;return}function zl(e){e=e|0;ai(e+80|0);vn(e);return}function Wl(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0;a=J;J=J+16|0;n=a;if(!(r[e+161>>0]|0))si(e+80|0);o=e+164|0;if(Xl(o)|0){t=xl(e+80|0,t,s[o>>2]|0,0)|0;s[n>>2]=t;Vn(t,i)}else{Cl(Pl(t)|0,i,4);s[n>>2]=Rn(i)|0}Kl(o,n);J=a;return i+4|0}function Xl(e){e=e|0;return(r[e+4>>0]|0)!=0|0}function Kl(e,t){e=e|0;t=t|0;var i=0;i=e+4|0;if(!(r[i>>0]|0))r[i>>0]=1;s[e>>2]=s[t>>2];return}function Zl(e){e=e|0;ov(e);$p(e);return}function Jl(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Yl(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==16402?e+12|0:0)|0}function ql(e){e=e|0;ye(e,16);return}function $l(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(172)|0;tu(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];iu(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function eu(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(176)|0;mu(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];_u(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function tu(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5324;s[e+4>>2]=t;ru(e+8|0);return}function iu(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5348;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function ru(e){e=e|0;fn(e,8,1,8,0);ri(e+80|0,8,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;au(e+162|0);return}function nu(e){e=e|0;s[e>>2]=5324;lu(e+8|0);rn(e);return}function su(e){e=e|0;nu(e);$p(e);return}function ou(e,t){e=e|0;t=t|0;return uu(e+8|0,s[e+4>>2]|0,t)|0}function au(e){e=e|0;r[e+1>>0]=0;return}function lu(e){e=e|0;ai(e+80|0);vn(e);return}function uu(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,s=0,o=0;o=J;J=J+16|0;n=o;if(!(r[e+161>>0]|0))si(e+80|0);s=e+162|0;if(Au(s)|0){t=(xl(e+80|0,t,r[s>>0]|0,0)|0)&255;r[n>>0]=t;cu(t,i)}else{Cl(Pl(t)|0,i,1);r[n>>0]=hu(i)|0}du(s,n);J=o;return i+1|0}function Au(e){e=e|0;return(r[e+1>>0]|0)!=0|0}function cu(e,t){e=e|0;t=t|0;r[t>>0]=e;return}function hu(e){e=e|0;return r[e>>0]|0}function du(e,t){e=e|0;t=t|0;var i=0;i=e+1|0;if(!(r[i>>0]|0))r[i>>0]=1;r[e>>0]=r[t>>0]|0;return}function pu(e){e=e|0;ov(e);$p(e);return}function fu(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function vu(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==16900?e+12|0:0)|0}function gu(e){e=e|0;ye(e,16);return}function mu(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5376;s[e+4>>2]=t;yu(e+8|0);return}function _u(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5400;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function yu(e){e=e|0;fn(e,16,1,8,0);ri(e+80|0,16,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;xu(e+162|0);return}function bu(e){e=e|0;s[e>>2]=5376;Pu(e+8|0);rn(e);return}function wu(e){e=e|0;bu(e);$p(e);return}function Bu(e,t){e=e|0;t=t|0;return Cu(e+8|0,s[e+4>>2]|0,t)|0}function xu(e){e=e|0;r[e+2>>0]=0;return}function Pu(e){e=e|0;ai(e+80|0);vn(e);return}function Cu(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,o=0,a=0;a=J;J=J+16|0;s=a;if(!(r[e+161>>0]|0))si(e+80|0);o=e+162|0;if(Mu(o)|0){t=(xl(e+80|0,t,n[o>>1]|0,0)|0)&65535;n[s>>1]=t;Fu(t,i)}else{Cl(Pl(t)|0,i,2);n[s>>1]=ku(i)|0}Eu(o,s);J=a;return i+2|0}function Mu(e){e=e|0;return(r[e+2>>0]|0)!=0|0}function Fu(e,t){e=e|0;t=t|0;Ln(e,t);return}function ku(e){e=e|0;return Tn(e)|0}function Eu(e,t){e=e|0;t=t|0;var i=0;i=e+2|0;if(!(r[i>>0]|0))r[i>>0]=1;n[e>>1]=n[t>>1]|0;return}function Iu(e){e=e|0;ov(e);$p(e);return}function Tu(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Du(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==17398?e+12|0:0)|0}function Su(e){e=e|0;ye(e,16);return}function Ru(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(172)|0;Lu(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];Ou(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function Uu(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0;u=J;J=J+32|0;r=u+12|0;n=u;t=u+8|0;a=Zf(176)|0;qu(a,s[e+4>>2]|0);o=e+8|0;s[t>>2]=0;s[r>>2]=s[t>>2];$u(n,a,r);a=e+12|0;t=s[a>>2]|0;l=e+16|0;do{if(t>>>0>=(s[l>>2]|0)>>>0){t=(t-(s[o>>2]|0)>>3)+1|0;i=Zr(o)|0;if(i>>>0<t>>>0)Xv(o);else{A=s[o>>2]|0;c=(s[l>>2]|0)-A|0;l=c>>2;Wr(r,c>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(s[a>>2]|0)-A>>3,e+16|0);l=r+8|0;a=s[l>>2]|0;s[a>>2]=s[n>>2];e=n+4|0;s[a+4>>2]=s[e>>2];s[n>>2]=0;s[e>>2]=0;s[l>>2]=a+8;Xr(o,r);Kr(r);break}}else{jr(r,o,1);c=r+4|0;A=s[c>>2]|0;s[A>>2]=s[n>>2];l=n+4|0;s[A+4>>2]=s[l>>2];s[n>>2]=0;s[l>>2]=0;s[c>>2]=A+8;zr(r)}}while(0);Rr(n);J=u;return}function Lu(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5428;s[e+4>>2]=t;Nu(e+8|0);return}function Ou(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5452;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function Nu(e){e=e|0;fn(e,8,1,8,0);ri(e+80|0,8,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;Gu(e+162|0);return}function Vu(e){e=e|0;s[e>>2]=5428;ju(e+8|0);rn(e);return}function Qu(e){e=e|0;Vu(e);$p(e);return}function Hu(e,t){e=e|0;t=t|0;return zu(e+8|0,s[e+4>>2]|0,t)|0}function Gu(e){e=e|0;r[e+1>>0]=0;return}function ju(e){e=e|0;ai(e+80|0);vn(e);return}function zu(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,s=0,a=0;a=J;J=J+16|0;n=a;if(!(r[e+161>>0]|0))si(e+80|0);s=e+162|0;if(Wu(s)|0){t=(xl(e+80|0,t,o[s>>0]|0,0)|0)&255;r[n>>0]=t;On(t,i)}else{Cl(Pl(t)|0,i,1);r[n>>0]=Dn(i)|0}Xu(s,n);J=a;return i+1|0}function Wu(e){e=e|0;return(r[e+1>>0]|0)!=0|0}function Xu(e,t){e=e|0;t=t|0;var i=0;i=e+1|0;if(!(r[i>>0]|0))r[i>>0]=1;r[e>>0]=r[t>>0]|0;return}function Ku(e){e=e|0;ov(e);$p(e);return}function Zu(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function Ju(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==17896?e+12|0:0)|0}function Yu(e){e=e|0;ye(e,16);return}function qu(e,t){e=e|0;t=t|0;Jr(e);s[e>>2]=5480;s[e+4>>2]=t;eA(e+8|0);return}function $u(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;i=J;J=J+16|0;r=i;s[e>>2]=t;n=Zf(16)|0;s[n+4>>2]=0;s[n+8>>2]=0;s[n>>2]=5504;s[n+12>>2]=t;s[e+4>>2]=n;s[r>>2]=t;s[r+4>>2]=t;Qn(e,r);J=i;return}function eA(e){e=e|0;fn(e,16,1,8,0);ri(e+80|0,16,1,8,0);r[e+160>>0]=0;r[e+161>>0]=0;nA(e+162|0);return}function tA(e){e=e|0;s[e>>2]=5480;sA(e+8|0);rn(e);return}function iA(e){e=e|0;tA(e);$p(e);return}function rA(e,t){e=e|0;t=t|0;return oA(e+8|0,s[e+4>>2]|0,t)|0}function nA(e){e=e|0;r[e+2>>0]=0;return}function sA(e){e=e|0;ai(e+80|0);vn(e);return}function oA(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,o=0,l=0;l=J;J=J+16|0;s=l;if(!(r[e+161>>0]|0))si(e+80|0);o=e+162|0;if(aA(o)|0){t=(xl(e+80|0,t,a[o>>1]|0,0)|0)&65535;n[s>>1]=t;Ln(t,i)}else{Cl(Pl(t)|0,i,2);n[s>>1]=Tn(i)|0}lA(o,s);J=l;return i+2|0}function aA(e){e=e|0;return(r[e+2>>0]|0)!=0|0}function lA(e,t){e=e|0;t=t|0;var i=0;i=e+2|0;if(!(r[i>>0]|0))r[i>>0]=1;n[e>>1]=n[t>>1]|0;return}function uA(e){e=e|0;ov(e);$p(e);return}function AA(e){e=e|0;e=s[e+12>>2]|0;if(e|0)jg[s[(s[e>>2]|0)+4>>2]&255](e);return}function cA(e,t){e=e|0;t=t|0;return((s[t+4>>2]|0)==18394?e+12|0:0)|0}function hA(e){e=e|0;ye(e,16);return}function dA(){return}function pA(e){e=e|0;return wA(e)|0}function fA(){return 0}function vA(){return 0}function gA(e){e=e|0;if(e|0){BA(e);$p(e)}return}function mA(){return xA()|0}function _A(){return PA()|0}function yA(){return CA()|0}function bA(){return 0}function wA(e){e=e|0;return 3360}function BA(e){e=e|0;var t=0,i=0,r=0,n=0;t=J;J=J+16|0;r=t;s[r>>2]=s[e>>2];s[e>>2]=0;i=e+4|0;s[r+4>>2]=s[i>>2];s[i>>2]=0;de(r);i=e+8|0;s[r>>2]=s[i>>2];s[i>>2]=0;n=e+12|0;s[r+4>>2]=s[n>>2];s[n>>2]=0;Be(r);Be(i);de(e);J=t;return}function xA(){return 3360}function PA(){return 3368}function CA(){return 3384}function MA(){return 18579}function FA(){return 18582}function kA(){return 18584}function EA(){var e=0;e=Zf(16)|0;LA(e);return e|0}function IA(e){e=e|0;var t=0,i=0,r=0,n=0;t=J;J=J+16|0;i=t;n=mA()|0;r=DA(i)|0;i=SA(i)|0;D(n|0,r|0,i|0,MA()|0,12,e|0);J=t;return}function TA(e){e=e|0;return RA(Og[e&3]()|0)|0}function DA(e){e=e|0;return 1}function SA(e){e=e|0;return UA()|0}function RA(e){e=e|0;return e|0}function UA(){return 5524}function LA(e){e=e|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;return}function OA(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=mA()|0;o=VA(n)|0;n=QA(n)|0;t=XA()|0;S(a|0,e|0,o|0,n|0,t|0,4,HA(r)|0,0);J=i;return}function NA(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0;o=GA(t)|0;t=s[e>>2]|0;n=s[e+4>>2]|0;e=o+(n>>1)|0;if(n&1)t=s[(s[e>>2]|0)+t>>2]|0;n=jA(i)|0;o=zA(r)|0;Wg[t&15](e,n,o);return}function VA(e){e=e|0;return 4}function QA(e){e=e|0;return WA()|0}function HA(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function GA(e){e=e|0;return e|0}function jA(e){e=e|0;return e|0}function zA(e){e=e|0;return e|0}function WA(){return 144}function XA(){return 18587}function KA(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=mA()|0;o=JA(n)|0;n=YA(n)|0;t=tc()|0;S(a|0,e|0,o|0,n|0,t|0,7,qA(r)|0,0);J=i;return}function ZA(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=GA(t)|0;t=s[e>>2]|0;r=s[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=s[(s[e>>2]|0)+t>>2]|0;n=$A(i)|0;zg[t&15](e,n);return}function JA(e){e=e|0;return 3}function YA(e){e=e|0;return ec()|0}function qA(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function $A(e){e=e|0;return e|0}function ec(){return 5528}function tc(){return 18593}function ic(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=mA()|0;o=nc(n)|0;n=sc(n)|0;t=uc()|0;S(a|0,e|0,o|0,n|0,t|0,41,oc(r)|0,0);J=i;return}function rc(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0;r=J;J=J+16|0;i=r;o=GA(t)|0;t=s[e>>2]|0;n=s[e+4>>2]|0;e=o+(n>>1)|0;if(n&1)t=s[(s[e>>2]|0)+t>>2]|0;s[i>>2]=Ng[t&15](e)|0;o=ac(i)|0;J=r;return o|0}function nc(e){e=e|0;return 2}function sc(e){e=e|0;return lc()|0}function oc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function ac(e){e=e|0;return s[e>>2]|0}function lc(){return 5540}function uc(){return 18598}function Ac(){return}function cc(e){e=e|0;return mc(e)|0}function hc(){return 0}function dc(){return 0}function pc(e){e=e|0;if(e|0){_c(e);$p(e)}return}function fc(){return yc()|0}function vc(){return bc()|0}function gc(){return wc()|0}function mc(e){e=e|0;return 3400}function _c(e){e=e|0;var t=0,i=0,r=0,n=0;t=J;J=J+16|0;r=t;s[r>>2]=s[e>>2];s[e>>2]=0;i=e+4|0;s[r+4>>2]=s[i>>2];s[i>>2]=0;Va(r);i=e+16|0;s[r>>2]=s[i>>2];s[i>>2]=0;n=e+20|0;s[r+4>>2]=s[n>>2];s[n>>2]=0;Oa(r);s[r>>2]=s[i>>2];s[i>>2]=0;s[r+4>>2]=s[n>>2];s[n>>2]=0;Oa(r);Oa(i);Xa(e+8|0);Va(e);J=t;return}function yc(){return 3400}function bc(){return 3408}function wc(){return 3424}function Bc(){var e=0;e=Zf(24)|0;Ec(e);return e|0}function xc(e){e=e|0;var t=0,i=0,r=0,n=0;t=J;J=J+16|0;i=t;n=fc()|0;r=Cc(i)|0;i=Mc(i)|0;D(n|0,r|0,i|0,MA()|0,13,e|0);J=t;return}function Pc(e){e=e|0;return Fc(Og[e&3]()|0)|0}function Cc(e){e=e|0;return 1}function Mc(e){e=e|0;return kc()|0}function Fc(e){e=e|0;return e|0}function kc(){return 5548}function Ec(e){e=e|0;s[e>>2]=0;s[e+4>>2]=0;s[e+8>>2]=0;s[e+12>>2]=0;s[e+16>>2]=0;s[e+20>>2]=0;return}function Ic(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=fc()|0;o=Dc(n)|0;n=Sc(n)|0;t=XA()|0;S(a|0,e|0,o|0,n|0,t|0,5,Rc(r)|0,0);J=i;return}function Tc(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0;o=Uc(t)|0;t=s[e>>2]|0;n=s[e+4>>2]|0;e=o+(n>>1)|0;if(n&1)t=s[(s[e>>2]|0)+t>>2]|0;n=jA(i)|0;o=zA(r)|0;Wg[t&15](e,n,o);return}function Dc(e){e=e|0;return 4}function Sc(e){e=e|0;return Lc()|0}function Rc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function Uc(e){e=e|0;return e|0}function Lc(){return 160}function Oc(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=fc()|0;o=Vc(n)|0;n=Qc(n)|0;t=tc()|0;S(a|0,e|0,o|0,n|0,t|0,8,Hc(r)|0,0);J=i;return}function Nc(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=Uc(t)|0;t=s[e>>2]|0;r=s[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=s[(s[e>>2]|0)+t>>2]|0;n=zA(i)|0;zg[t&15](e,n);return}function Vc(e){e=e|0;return 3}function Qc(e){e=e|0;return Gc()|0}function Hc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function Gc(){return 5552}function jc(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;i=J;J=J+16|0;r=i;n=i+8|0;a=s[t+4>>2]|0;s[r>>2]=s[t>>2];s[r+4>>2]=a;a=fc()|0;o=Wc(n)|0;n=Xc(n)|0;t=tc()|0;S(a|0,e|0,o|0,n|0,t|0,9,Kc(r)|0,0);J=i;return}function zc(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=Uc(t)|0;t=s[e>>2]|0;r=s[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=s[(s[e>>2]|0)+t>>2]|0;n=$A(i)|0;zg[t&15](e,n);return}function Wc(e){e=e|0;return 3}function Xc(e){e=e|0;return Zc()|0}function Kc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=s[e+4>>2]|0;s[t>>2]=s[e>>2];s[t+4>>2]=i;return t|0}function Zc(){return 5564}function Jc(){ee();return}function Yc(){qc();return}function qc(){$c(22144);return}function $c(e){e=e|0;var t=0;t=J;J=J+16|0;s[t>>2]=e;eh();J=t;return}function eh(){Q(th()|0,18653);I(ih()|0,18658,1,1,0);rh(18663);nh(18668);sh(18680);oh(18694);ah(18700);lh(18715);uh(18719);Ah(18732);ch(18737);hh(18751);dh(18757);N(ph()|0,18764);N(fh()|0,18776);V(vh()|0,4,18809);V(gh()|0,2,18822);V(mh()|0,4,18837);R(_h()|0,18852);yh(18868);bh(18898);wh(18935);Bh(18974);xh(19005);Ph(19045);Ch(19074);Mh(19112);Fh(19142);bh(19181);wh(19213);Bh(19246);xh(19279);Ph(19313);Ch(19346);kh(19380);Eh(19411);Ih(19443);return}function th(){return Gd()|0}function ih(){return Hd()|0}function rh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Vd()|0;L(e|0,s[i>>2]|0,1,-128<<24>>24|0,127<<24>>24|0);J=t;return}function nh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Od()|0;L(e|0,s[i>>2]|0,1,-128<<24>>24|0,127<<24>>24|0);J=t;return}function sh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Ud()|0;L(e|0,s[i>>2]|0,1,0,255);J=t;return}function oh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Sd()|0;L(e|0,s[i>>2]|0,2,-32768<<16>>16|0,32767<<16>>16|0);J=t;return}function ah(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Td()|0;L(e|0,s[i>>2]|0,2,0,65535);J=t;return}function lh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Ed()|0;L(e|0,s[i>>2]|0,4,-2147483648,2147483647);J=t;return}function uh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Fd()|0;L(e|0,s[i>>2]|0,4,0,-1);J=t;return}function Ah(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=Cd()|0;L(e|0,s[i>>2]|0,4,-2147483648,2147483647);J=t;return}function ch(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=xd()|0;L(e|0,s[i>>2]|0,4,0,-1);J=t;return}function hh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=wd()|0;U(e|0,s[i>>2]|0,4);J=t;return}function dh(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;s[i>>2]=e;e=yd()|0;U(e|0,s[i>>2]|0,8);J=t;return}function ph(){return _d()|0}function fh(){return md()|0}function vh(){return gd()|0}function gh(){return vd()|0}function mh(){return fd()|0}function _h(){return pd()|0}function yh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=cd()|0;e=hd()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function bh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=ld()|0;e=ud()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function wh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=sd()|0;e=od()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Bh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=id()|0;e=rd()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function xh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=$h()|0;e=ed()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Ph(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Jh()|0;e=Yh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Ch(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Xh()|0;e=Kh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Mh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=jh()|0;e=zh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Fh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Qh()|0;e=Hh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function kh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Oh()|0;e=Nh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Eh(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Rh()|0;e=Uh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Ih(e){e=e|0;var t=0,i=0,r=0;t=J;J=J+16|0;i=t;s[i>>2]=e;r=Th()|0;e=Dh()|0;O(r|0,e|0,s[i>>2]|0);J=t;return}function Th(){return Sh()|0}function Dh(){return 7}function Sh(){return 3440}function Rh(){return Lh()|0}function Uh(){return 7}function Lh(){return 3448}function Oh(){return Vh()|0}function Nh(){return 6}function Vh(){return 3456}function Qh(){return Gh()|0}function Hh(){return 5}function Gh(){return 3464}function jh(){return Wh()|0}function zh(){return 4}function Wh(){return 3472}function Xh(){return Zh()|0}function Kh(){return 5}function Zh(){return 3480}function Jh(){return qh()|0}function Yh(){return 4}function qh(){return 3488}function $h(){return td()|0}function ed(){return 3}function td(){return 3496}function id(){return nd()|0}function rd(){return 2}function nd(){return 3504}function sd(){return ad()|0}function od(){return 1}function ad(){return 3512}function ld(){return Ad()|0}function ud(){return 0}function Ad(){return 3520}function cd(){return dd()|0}function hd(){return 0}function dd(){return 3528}function pd(){return 3536}function fd(){return 3544}function vd(){return 3576}function gd(){return 3600}function md(){return 3624}function _d(){return 3648}function yd(){return bd()|0}function bd(){return 4144}function wd(){return Bd()|0}function Bd(){return 4136}function xd(){return Pd()|0}function Pd(){return 4128}function Cd(){return Md()|0}function Md(){return 4120}function Fd(){return kd()|0}function kd(){return 4112}function Ed(){return Id()|0}function Id(){return 4104}function Td(){return Dd()|0}function Dd(){return 4096}function Sd(){return Rd()|0}function Rd(){return 4088}function Ud(){return Ld()|0}function Ld(){return 4072}function Od(){return Nd()|0}function Nd(){return 4080}function Vd(){return Qd()|0}function Qd(){return 4064}function Hd(){return 4056}function Gd(){return 4040}function jd(e){e=e|0;var t=0,i=0,r=0,n=0;t=J;J=J+16|0;i=t+8|0;r=t+4|0;n=t;s[n>>2]=e;s[r>>2]=s[n>>2];s[i>>2]=s[(s[r>>2]|0)+4>>2];e=Pp(s[i>>2]|0)|0;J=t;return e|0}function zd(){return 21636}function Wd(e){e=e|0;return(e+-48|0)>>>0<10|0}function Xd(){return 5576}function Kd(e,t){e=e|0;t=t|0;var i=0,n=0;i=r[e>>0]|0;n=r[t>>0]|0;if(i<<24>>24==0?1:i<<24>>24!=n<<24>>24)e=n;else{do{e=e+1|0;t=t+1|0;i=r[e>>0]|0;n=r[t>>0]|0}while(!(i<<24>>24==0?1:i<<24>>24!=n<<24>>24));e=n}return(i&255)-(e&255)|0}function Zd(e){e=e|0;var t=0,i=0,n=0;n=e;e:do{if(!(n&3))i=5;else{t=n;while(1){if(!(r[e>>0]|0)){e=t;break e}e=e+1|0;t=e;if(!(t&3)){i=5;break}}}}while(0);if((i|0)==5){while(1){t=s[e>>2]|0;if(!((t&-2139062144^-2139062144)&t+-16843009))e=e+4|0;else break}if((t&255)<<24>>24)do{e=e+1|0}while((r[e>>0]|0)!=0)}return e-n|0}function Jd(e){e=e|0;return}function Yd(e){e=e|0;return 1}function qd(e){e=e|0;var t=0,i=0;t=e+74|0;i=r[t>>0]|0;r[t>>0]=i+255|i;t=s[e>>2]|0;if(!(t&8)){s[e+8>>2]=0;s[e+4>>2]=0;i=s[e+44>>2]|0;s[e+28>>2]=i;s[e+20>>2]=i;s[e+16>>2]=i+(s[e+48>>2]|0);e=0}else{s[e>>2]=t|32;e=-1}return e|0}function $d(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0;n=i+16|0;o=s[n>>2]|0;if(!o){if(!(qd(i)|0)){o=s[n>>2]|0;a=5}else n=0}else a=5;e:do{if((a|0)==5){u=i+20|0;l=s[u>>2]|0;n=l;if((o-l|0)>>>0<t>>>0){n=Hg[s[i+36>>2]&7](i,e,t)|0;break}t:do{if((r[i+75>>0]|0)<0|(t|0)==0){a=0;o=e}else{l=t;while(1){o=l+-1|0;if((r[e+o>>0]|0)==10)break;if(!o){a=0;o=e;break t}else l=o}n=Hg[s[i+36>>2]&7](i,e,l)|0;if(n>>>0<l>>>0)break e;a=l;o=e+l|0;t=t-l|0;n=s[u>>2]|0}}while(0);cg(n|0,o|0,t|0)|0;s[u>>2]=(s[u>>2]|0)+t;n=a+t|0}}while(0);return n|0}function ep(e,t){e=e|0;t=t|0;if(!t)t=0;else t=tp(s[t>>2]|0,s[t+4>>2]|0,e)|0;return((t|0)==0?e:t)|0}function tp(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0;p=(s[e>>2]|0)+1794895138|0;a=ip(s[e+8>>2]|0,p)|0;n=ip(s[e+12>>2]|0,p)|0;o=ip(s[e+16>>2]|0,p)|0;e:do{if((a>>>0<t>>>2>>>0?(d=t-(a<<2)|0,n>>>0<d>>>0&o>>>0<d>>>0):0)?((o|n)&3|0)==0:0){d=n>>>2;h=o>>>2;c=0;while(1){u=a>>>1;A=c+u|0;l=A<<1;o=l+d|0;n=ip(s[e+(o<<2)>>2]|0,p)|0;o=ip(s[e+(o+1<<2)>>2]|0,p)|0;if(!(o>>>0<t>>>0&n>>>0<(t-o|0)>>>0)){n=0;break e}if(r[e+(o+n)>>0]|0){n=0;break e}n=Kd(i,e+o|0)|0;if(!n)break;n=(n|0)<0;if((a|0)==1){n=0;break e}c=n?c:A;a=n?u:a-u|0}n=l+h|0;o=ip(s[e+(n<<2)>>2]|0,p)|0;n=ip(s[e+(n+1<<2)>>2]|0,p)|0;if(n>>>0<t>>>0&o>>>0<(t-n|0)>>>0)n=(r[e+(n+o)>>0]|0)==0?e+n|0:0;else n=0}else n=0}while(0);return n|0}function ip(e,t){e=e|0;t=t|0;var i=0;i=Ag(e|0)|0;return((t|0)==0?e:i)|0}function rp(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0;a=t&255;n=(i|0)!=0;e:do{if(n&(e&3|0)!=0){o=t&255;while(1){if((r[e>>0]|0)==o<<24>>24){o=6;break e}e=e+1|0;i=i+-1|0;n=(i|0)!=0;if(!(n&(e&3|0)!=0)){o=5;break}}}else o=5}while(0);if((o|0)==5)if(n)o=6;else e=0;e:do{if((o|0)==6){if((r[e>>0]|0)!=(t&255)<<24>>24){n=_(a,16843009)|0;t:do{if(i>>>0>3)do{a=s[e>>2]^n;if((a&-2139062144^-2139062144)&a+-16843009|0)break t;e=e+4|0;i=i+-4|0}while(i>>>0>3)}while(0)}if(!i)e=0;else{n=t&255;while(1){if((r[e>>0]|0)==n<<24>>24)break e;i=i+-1|0;if(!i){e=0;break}else e=e+1|0}}}}while(0);return e|0}function np(e,t,i){e=e|0;t=t|0;i=i|0;return ap(e,t,i,1,8)|0}function sp(e,t,i,n,a,l){e=e|0;t=+t;i=i|0;n=n|0;a=a|0;l=l|0;var u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0.0,g=0,m=0,y=0,b=0,w=0,x=0,P=0,C=0,M=0,F=0,k=0,E=0,I=0,T=0,D=0;D=J;J=J+560|0;c=D+32|0;b=D+536|0;T=D;I=T;h=D+540|0;s[b>>2]=0;E=h+12|0;_p(t)|0;u=B()|0;if((u|0)<0){t=-t;_p(t)|0;k=1;F=20247;u=B()|0}else{k=(a&2049|0)!=0&1;F=(a&2048|0)==0?(a&1|0)==0?20248:20253:20250}do{if(0==0&(u&2146435072|0)==2146435072){T=(l&32|0)!=0;u=k+3|0;fp(e,32,i,u,a&-65537);up(e,F,k);up(e,t!=t|0.0!=0.0?T?20274:20278:T?20266:20270,3);fp(e,32,i,u,a^8192)}else{v=+yp(t,b)*2.0;u=v!=0.0;if(u)s[b>>2]=(s[b>>2]|0)+-1;y=l|32;if((y|0)==97){p=l&32;g=(p|0)==0?F:F+9|0;f=k|2;u=12-n|0;do{if(!(n>>>0>11|(u|0)==0)){t=8.0;do{u=u+-1|0;t=t*16.0}while((u|0)!=0);if((r[g>>0]|0)==45){t=-(t+(-v-t));break}else{t=v+t-t;break}}else t=v}while(0);A=s[b>>2]|0;u=(A|0)<0?0-A|0:A;u=pp(u,((u|0)<0)<<31>>31,E)|0;if((u|0)==(E|0)){u=h+11|0;r[u>>0]=48}r[u+-1>>0]=(A>>31&2)+43;d=u+-2|0;r[d>>0]=l+15;A=(n|0)<1;c=(a&8|0)==0;h=T;do{k=~~t;u=h+1|0;r[h>>0]=p|o[640+k>>0];t=(t-+(k|0))*16.0;if((u-I|0)==1?!(c&(A&t==0.0)):0){r[u>>0]=46;h=h+2|0}else h=u}while(t!=0.0);if((n|0)!=0?(-2-I+h|0)<(n|0):0){A=E;c=d;u=n+2+A-c|0}else{A=E;c=d;u=A-I-c+h|0}E=u+f|0;fp(e,32,i,E,a);up(e,g,f);fp(e,48,i,E,a^65536);I=h-I|0;up(e,T,I);T=A-c|0;fp(e,48,u-(I+T)|0,0,0);up(e,d,T);fp(e,32,i,E,a^8192);u=E;break}A=(n|0)<0?6:n;if(u){u=(s[b>>2]|0)+-28|0;s[b>>2]=u;t=v*268435456.0}else{t=v;u=s[b>>2]|0}M=(u|0)<0?c:c+288|0;c=M;do{P=~~t>>>0;s[c>>2]=P;c=c+4|0;t=(t-+(P>>>0))*1.0e9}while(t!=0.0);P=M;if((u|0)>0){p=M;while(1){d=(u|0)<29?u:29;u=c+-4|0;if(u>>>0>=p>>>0){h=0;do{m=lg(s[u>>2]|0,0,d|0)|0;m=ig(m|0,B()|0,h|0,0)|0;w=B()|0;h=og(m|0,w|0,1e9,0)|0;x=tg(h|0,B()|0,1e9,0)|0;x=rg(m|0,w|0,x|0,B()|0)|0;B()|0;s[u>>2]=x;u=u+-4|0}while(u>>>0>=p>>>0);if(h){x=p+-4|0;s[x>>2]=h;h=x}else h=p}else h=p;e:do{if(c>>>0>h>>>0){u=c;while(1){c=u+-4|0;if(s[c>>2]|0){c=u;break e}if(c>>>0>h>>>0)u=c;else break}}}while(0);u=(s[b>>2]|0)-d|0;s[b>>2]=u;if((u|0)>0)p=h;else break}}else h=M;if((u|0)<0){n=((A+25|0)/9|0)+1|0;m=(y|0)==102;do{g=0-u|0;g=(g|0)<9?g:9;if(h>>>0<c>>>0){d=(1<<g)+-1|0;p=1e9>>>g;f=0;u=h;do{x=s[u>>2]|0;s[u>>2]=(x>>>g)+f;f=_(x&d,p)|0;u=u+4|0}while(u>>>0<c>>>0);h=(s[h>>2]|0)==0?h+4|0:h;if(f){s[c>>2]=f;c=c+4|0}}else h=(s[h>>2]|0)==0?h+4|0:h;u=m?M:h;c=(c-u>>2|0)>(n|0)?u+(n<<2)|0:c;u=(s[b>>2]|0)+g|0;s[b>>2]=u}while((u|0)<0);m=h}else m=h;if(m>>>0<c>>>0){u=(P-m>>2)*9|0;d=s[m>>2]|0;if(d>>>0>=10){h=10;do{h=h*10|0;u=u+1|0}while(d>>>0>=h>>>0)}}else u=0;w=(y|0)==103;x=(A|0)!=0;h=A-((y|0)==102?0:u)+((x&w)<<31>>31)|0;if((h|0)<(((c-P>>2)*9|0)+-9|0)){b=h+9216|0;h=(b|0)/9|0;n=M+4+(h+-1024<<2)|0;h=b-(h*9|0)|0;if((h|0)<8){d=10;while(1){d=d*10|0;if((h|0)<7)h=h+1|0;else break}}else d=10;f=s[n>>2]|0;h=(f>>>0)/(d>>>0)|0;g=f-(_(h,d)|0)|0;p=(n+4|0)==(c|0);if(!(p&(g|0)==0)){v=(h&1|0)==0?9007199254740992.0:9007199254740994.0;b=d>>>1;t=g>>>0<b>>>0?0.5:p&(g|0)==(b|0)?1.0:1.5;if(k){b=(r[F>>0]|0)==45;t=b?-t:t;v=b?-v:v}h=f-g|0;s[n>>2]=h;if(v+t!=v){b=h+d|0;s[n>>2]=b;if(b>>>0>999999999){d=n;u=m;while(1){h=d+-4|0;s[d>>2]=0;if(h>>>0<u>>>0){u=u+-4|0;s[u>>2]=0}b=(s[h>>2]|0)+1|0;s[h>>2]=b;if(b>>>0>999999999)d=h;else{d=u;break}}}else{h=n;d=m}u=(P-d>>2)*9|0;f=s[d>>2]|0;if(f>>>0>=10){p=10;do{p=p*10|0;u=u+1|0}while(f>>>0>=p>>>0)}}else{h=n;d=m}}else{h=n;d=m}b=h+4|0;c=c>>>0>b>>>0?b:c}else d=m;n=0-u|0;e:do{if(c>>>0>d>>>0)while(1){h=c+-4|0;if(s[h>>2]|0){b=c;y=1;break e}if(h>>>0>d>>>0)c=h;else{b=h;y=0;break}}else{b=c;y=0}}while(0);do{if(w){A=A+((x^1)&1)|0;if((A|0)>(u|0)&(u|0)>-5){p=l+-1|0;A=A+-1-u|0}else{p=l+-2|0;A=A+-1|0}if(!(a&8)){if(y?(C=s[b+-4>>2]|0,(C|0)!=0):0){if(!((C>>>0)%10|0)){h=0;c=10;do{c=c*10|0;h=h+1|0}while(!((C>>>0)%(c>>>0)|0|0))}else h=0}else h=9;c=((b-P>>2)*9|0)+-9|0;if((p|32|0)==102){l=c-h|0;l=(l|0)>0?l:0;A=(A|0)<(l|0)?A:l;break}else{l=c+u-h|0;l=(l|0)>0?l:0;A=(A|0)<(l|0)?A:l;break}}}else p=l}while(0);m=(A|0)!=0;f=m?1:a>>>3&1;g=(p|32|0)==102;if(g){w=0;u=(u|0)>0?u:0}else{c=(u|0)<0?n:u;c=pp(c,((c|0)<0)<<31>>31,E)|0;h=E;if((h-c|0)<2)do{c=c+-1|0;r[c>>0]=48}while((h-c|0)<2);r[c+-1>>0]=(u>>31&2)+43;u=c+-2|0;r[u>>0]=p;w=u;u=h-u|0}u=k+1+A+f+u|0;fp(e,32,i,u,a);up(e,F,k);fp(e,48,i,u,a^65536);if(g){f=d>>>0>M>>>0?M:d;g=T+9|0;d=g;p=T+8|0;h=f;do{c=pp(s[h>>2]|0,0,g)|0;if((h|0)==(f|0)){if((c|0)==(g|0)){r[p>>0]=48;c=p}}else if(c>>>0>T>>>0){dg(T|0,48,c-I|0)|0;do{c=c+-1|0}while(c>>>0>T>>>0)}up(e,c,d-c|0);h=h+4|0}while(h>>>0<=M>>>0);if(!((a&8|0)==0&(m^1)))up(e,20282,1);if(h>>>0<b>>>0&(A|0)>0)while(1){c=pp(s[h>>2]|0,0,g)|0;if(c>>>0>T>>>0){dg(T|0,48,c-I|0)|0;do{c=c+-1|0}while(c>>>0>T>>>0)}up(e,c,(A|0)<9?A:9);h=h+4|0;c=A+-9|0;if(!(h>>>0<b>>>0&(A|0)>9)){A=c;break}else A=c}fp(e,48,A+9|0,9,0)}else{b=y?b:d+4|0;if(d>>>0<b>>>0&(A|0)>-1){n=T+9|0;m=(a&8|0)==0;y=n;f=0-I|0;g=T+8|0;p=d;do{c=pp(s[p>>2]|0,0,n)|0;if((c|0)==(n|0)){r[g>>0]=48;c=g}do{if((p|0)==(d|0)){h=c+1|0;up(e,c,1);if(m&(A|0)<1){c=h;break}up(e,20282,1);c=h}else{if(c>>>0<=T>>>0)break;dg(T|0,48,c+f|0)|0;do{c=c+-1|0}while(c>>>0>T>>>0)}}while(0);I=y-c|0;up(e,c,(A|0)>(I|0)?I:A);A=A-I|0;p=p+4|0}while(p>>>0<b>>>0&(A|0)>-1)}fp(e,48,A+18|0,18,0);up(e,w,E-w|0)}fp(e,32,i,u,a^8192)}}while(0);J=D;return((u|0)<(i|0)?i:u)|0}function op(e,t){e=e|0;t=t|0;var i=0.0,r=0;r=(s[t>>2]|0)+(8-1)&~(8-1);i=+u[r>>3];s[t>>2]=r+8;u[e>>3]=i;return}function ap(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;var a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0,_=0;_=J;J=J+224|0;f=_+208|0;v=_+160|0;g=_+80|0;m=_;a=v;l=a+40|0;do{s[a>>2]=0;a=a+4|0}while((a|0)<(l|0));s[f>>2]=s[i>>2];if((lp(0,t,f,g,v,n,o)|0)<0)i=-1;else{if((s[e+76>>2]|0)>-1)p=Yd(e)|0;else p=0;i=s[e>>2]|0;d=i&32;if((r[e+74>>0]|0)<1)s[e>>2]=i&-33;a=e+48|0;if(!(s[a>>2]|0)){l=e+44|0;u=s[l>>2]|0;s[l>>2]=m;A=e+28|0;s[A>>2]=m;c=e+20|0;s[c>>2]=m;s[a>>2]=80;h=e+16|0;s[h>>2]=m+80;i=lp(e,t,f,g,v,n,o)|0;if(u){Hg[s[e+36>>2]&7](e,0,0)|0;i=(s[c>>2]|0)==0?-1:i;s[l>>2]=u;s[a>>2]=0;s[h>>2]=0;s[A>>2]=0;s[c>>2]=0}}else i=lp(e,t,f,g,v,n,o)|0;a=s[e>>2]|0;s[e>>2]=a|d;if(p|0)Jd(e);i=(a&32|0)==0?i:-1}J=_;return i|0}function lp(e,t,i,o,a,l,A){e=e|0;t=t|0;i=i|0;o=o|0;a=a|0;l=l|0;A=A|0;var c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0,_=0,y=0,b=0,w=0,x=0,P=0,C=0,M=0,F=0,k=0,E=0,I=0,T=0,D=0,S=0,R=0,U=0;R=J;J=J+64|0;T=R+56|0;S=R+40|0;M=R;k=R+48|0;E=R+60|0;s[T>>2]=t;x=(e|0)!=0;P=M+40|0;C=P;M=M+39|0;F=k+4|0;c=0;t=0;d=0;e:while(1){do{do{if((t|0)>-1)if((c|0)>(2147483647-t|0)){s[(zd()|0)>>2]=61;t=-1;break}else{t=c+t|0;break}}while(0);g=s[T>>2]|0;c=r[g>>0]|0;if(!(c<<24>>24)){w=92;break e}h=g;t:while(1){switch(c<<24>>24){case 37:{w=10;break t}case 0:{c=h;break t}default:{}}b=h+1|0;s[T>>2]=b;c=r[b>>0]|0;h=b}t:do{if((w|0)==10){w=0;c=h;do{if((r[h+1>>0]|0)!=37)break t;c=c+1|0;h=h+2|0;s[T>>2]=h}while((r[h>>0]|0)==37)}}while(0);c=c-g|0;if(x)up(e,g,c)}while((c|0)!=0);b=(Wd(r[(s[T>>2]|0)+1>>0]|0)|0)==0;h=s[T>>2]|0;if(!b?(r[h+2>>0]|0)==36:0){_=(r[h+1>>0]|0)+-48|0;f=1;c=3}else{_=-1;f=d;c=1}c=h+c|0;s[T>>2]=c;h=r[c>>0]|0;d=(h<<24>>24)+-32|0;if(d>>>0>31|(1<<d&75913|0)==0)p=0;else{p=0;do{p=1<<d|p;c=c+1|0;s[T>>2]=c;h=r[c>>0]|0;d=(h<<24>>24)+-32|0}while(!(d>>>0>31|(1<<d&75913|0)==0))}if(h<<24>>24==42){if((Wd(r[c+1>>0]|0)|0)!=0?(D=s[T>>2]|0,(r[D+2>>0]|0)==36):0){c=D+1|0;s[a+((r[c>>0]|0)+-48<<2)>>2]=10;c=s[o+((r[c>>0]|0)+-48<<3)>>2]|0;d=1;h=D+3|0}else{if(f|0){t=-1;break}if(x){b=(s[i>>2]|0)+(4-1)&~(4-1);c=s[b>>2]|0;s[i>>2]=b+4}else c=0;d=0;h=(s[T>>2]|0)+1|0}s[T>>2]=h;b=(c|0)<0;y=b?0-c|0:c;p=b?p|8192:p;b=d}else{c=Ap(T)|0;if((c|0)<0){t=-1;break}y=c;b=f;h=s[T>>2]|0}do{if((r[h>>0]|0)==46){c=h+1|0;if((r[c>>0]|0)!=42){s[T>>2]=c;c=Ap(T)|0;h=s[T>>2]|0;break}if(Wd(r[h+2>>0]|0)|0?(I=s[T>>2]|0,(r[I+3>>0]|0)==36):0){c=I+2|0;s[a+((r[c>>0]|0)+-48<<2)>>2]=10;c=s[o+((r[c>>0]|0)+-48<<3)>>2]|0;h=I+4|0;s[T>>2]=h;break}if(b|0){t=-1;break e}if(x){m=(s[i>>2]|0)+(4-1)&~(4-1);c=s[m>>2]|0;s[i>>2]=m+4}else c=0;h=(s[T>>2]|0)+2|0;s[T>>2]=h}else c=-1}while(0);m=0;while(1){if(((r[h>>0]|0)+-65|0)>>>0>57){t=-1;break e}d=h;h=h+1|0;s[T>>2]=h;d=r[(r[d>>0]|0)+-65+(176+(m*58|0))>>0]|0;f=d&255;if((f+-1|0)>>>0>=8)break;else m=f}if(!(d<<24>>24)){t=-1;break}v=(_|0)>-1;do{if(d<<24>>24==19){if(v){t=-1;break e}else w=54}else{if(v){s[a+(_<<2)>>2]=f;v=o+(_<<3)|0;_=s[v+4>>2]|0;w=S;s[w>>2]=s[v>>2];s[w+4>>2]=_;w=54;break}if(!x){t=0;break e}cp(S,f,i,A);h=s[T>>2]|0;w=55}}while(0);if((w|0)==54){w=0;if(x)w=55;else c=0}t:do{if((w|0)==55){w=0;h=r[h+-1>>0]|0;h=(m|0)!=0&(h&15|0)==3?h&-33:h;d=p&-65537;_=(p&8192|0)==0?p:d;i:do{switch(h|0){case 110:switch((m&255)<<24>>24){case 0:{s[s[S>>2]>>2]=t;c=0;break t}case 1:{s[s[S>>2]>>2]=t;c=0;break t}case 2:{c=s[S>>2]|0;s[c>>2]=t;s[c+4>>2]=((t|0)<0)<<31>>31;c=0;break t}case 3:{n[s[S>>2]>>1]=t;c=0;break t}case 4:{r[s[S>>2]>>0]=t;c=0;break t}case 6:{s[s[S>>2]>>2]=t;c=0;break t}case 7:{c=s[S>>2]|0;s[c>>2]=t;s[c+4>>2]=((t|0)<0)<<31>>31;c=0;break t}default:{c=0;break t}}case 112:{h=120;c=c>>>0>8?c:8;d=_|8;w=67;break}case 88:case 120:{d=_;w=67;break}case 111:{v=S;v=dp(s[v>>2]|0,s[v+4>>2]|0,P)|0;d=C-v|0;p=0;f=20230;c=(_&8|0)==0|(c|0)>(d|0)?c:d+1|0;d=_;w=73;break}case 105:case 100:{d=S;h=s[d>>2]|0;d=s[d+4>>2]|0;if((d|0)<0){h=rg(0,0,h|0,d|0)|0;d=B()|0;p=S;s[p>>2]=h;s[p+4>>2]=d;p=1;f=20230;w=72;break i}else{p=(_&2049|0)!=0&1;f=(_&2048|0)==0?(_&1|0)==0?20230:20232:20231;w=72;break i}}case 117:{d=S;p=0;f=20230;h=s[d>>2]|0;d=s[d+4>>2]|0;w=72;break}case 99:{r[M>>0]=s[S>>2];g=M;p=0;f=20230;v=1;h=d;c=C;break}case 115:{m=s[S>>2]|0;m=(m|0)==0?20240:m;_=rp(m,0,c)|0;U=(_|0)==0;g=m;p=0;f=20230;v=U?c:_-m|0;h=d;c=U?m+c|0:_;break}case 67:{s[k>>2]=s[S>>2];s[F>>2]=0;s[S>>2]=k;f=-1;w=79;break}case 83:{if(!c){fp(e,32,y,0,_);c=0;w=89}else{f=c;w=79}break}case 65:case 71:case 70:case 69:case 97:case 103:case 102:case 101:{c=Vg[l&1](e,+u[S>>3],y,c,_,h)|0;break t}default:{p=0;f=20230;v=c;h=_;c=C}}}while(0);i:do{if((w|0)==67){v=S;v=hp(s[v>>2]|0,s[v+4>>2]|0,P,h&32)|0;f=S;f=(d&8|0)==0|(s[f>>2]|0)==0&(s[f+4>>2]|0)==0;p=f?0:2;f=f?20230:20230+(h>>>4)|0;w=73}else if((w|0)==72){v=pp(h,d,P)|0;d=_;w=73}else if((w|0)==79){w=0;p=s[S>>2]|0;c=0;while(1){h=s[p>>2]|0;if(!h)break;h=vp(E,h)|0;d=(h|0)<0;if(d|h>>>0>(f-c|0)>>>0){w=83;break}c=h+c|0;if(f>>>0>c>>>0)p=p+4|0;else break}if((w|0)==83){w=0;if(d){t=-1;break e}}fp(e,32,y,c,_);if(!c){c=0;w=89}else{d=s[S>>2]|0;p=0;while(1){h=s[d>>2]|0;if(!h){w=89;break i}h=vp(E,h)|0;p=h+p|0;if((p|0)>(c|0)){w=89;break i}up(e,E,h);if(p>>>0>=c>>>0){w=89;break}else d=d+4|0}}}}while(0);if((w|0)==73){w=0;h=S;h=(s[h>>2]|0)!=0|(s[h+4>>2]|0)!=0;U=(c|0)!=0|h;h=C-v+((h^1)&1)|0;g=U?v:P;v=U?(c|0)>(h|0)?c:h:0;h=(c|0)>-1?d&-65537:d;c=C}else if((w|0)==89){w=0;fp(e,32,y,c,_^8192);c=(y|0)>(c|0)?y:c;break}_=c-g|0;m=(v|0)<(_|0)?_:v;U=m+p|0;c=(y|0)<(U|0)?U:y;fp(e,32,c,U,h);up(e,f,p);fp(e,48,c,U,h^65536);fp(e,48,m,_,0);up(e,g,_);fp(e,32,c,U,h^8192)}}while(0);d=b}e:do{if((w|0)==92)if(!e)if(!d)t=0;else{t=1;while(1){c=s[a+(t<<2)>>2]|0;if(!c)break;cp(o+(t<<3)|0,c,i,A);t=t+1|0;if(t>>>0>=10){t=1;break e}}while(1){if(s[a+(t<<2)>>2]|0){t=-1;break e}t=t+1|0;if(t>>>0>=10){t=1;break}}}}while(0);J=R;return t|0}function up(e,t,i){e=e|0;t=t|0;i=i|0;if(!(s[e>>2]&32))$d(t,i,e)|0;return}function Ap(e){e=e|0;var t=0,i=0;if(!(Wd(r[s[e>>2]>>0]|0)|0))t=0;else{t=0;do{i=s[e>>2]|0;t=(t*10|0)+-48+(r[i>>0]|0)|0;i=i+1|0;s[e>>2]=i}while((Wd(r[i>>0]|0)|0)!=0)}return t|0}function cp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0.0;e:do{if(t>>>0<=20)do{switch(t|0){case 9:{t=(s[i>>2]|0)+(4-1)&~(4-1);r=s[t>>2]|0;s[i>>2]=t+4;s[e>>2]=r;break e}case 10:{r=(s[i>>2]|0)+(4-1)&~(4-1);t=s[r>>2]|0;s[i>>2]=r+4;r=e;s[r>>2]=t;s[r+4>>2]=((t|0)<0)<<31>>31;break e}case 11:{r=(s[i>>2]|0)+(4-1)&~(4-1);t=s[r>>2]|0;s[i>>2]=r+4;r=e;s[r>>2]=t;s[r+4>>2]=0;break e}case 12:{r=(s[i>>2]|0)+(8-1)&~(8-1);t=r;n=s[t>>2]|0;t=s[t+4>>2]|0;s[i>>2]=r+8;r=e;s[r>>2]=n;s[r+4>>2]=t;break e}case 13:{n=(s[i>>2]|0)+(4-1)&~(4-1);r=s[n>>2]|0;s[i>>2]=n+4;r=(r&65535)<<16>>16;n=e;s[n>>2]=r;s[n+4>>2]=((r|0)<0)<<31>>31;break e}case 14:{n=(s[i>>2]|0)+(4-1)&~(4-1);r=s[n>>2]|0;s[i>>2]=n+4;n=e;s[n>>2]=r&65535;s[n+4>>2]=0;break e}case 15:{n=(s[i>>2]|0)+(4-1)&~(4-1);r=s[n>>2]|0;s[i>>2]=n+4;r=(r&255)<<24>>24;n=e;s[n>>2]=r;s[n+4>>2]=((r|0)<0)<<31>>31;break e}case 16:{n=(s[i>>2]|0)+(4-1)&~(4-1);r=s[n>>2]|0;s[i>>2]=n+4;n=e;s[n>>2]=r&255;s[n+4>>2]=0;break e}case 17:{n=(s[i>>2]|0)+(8-1)&~(8-1);o=+u[n>>3];s[i>>2]=n+8;u[e>>3]=o;break e}case 18:{zg[r&15](e,i);break e}default:break e}}while(0)}while(0);return}function hp(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;if(!((e|0)==0&(t|0)==0))do{i=i+-1|0;r[i>>0]=o[640+(e&15)>>0]|0|n;e=ag(e|0,t|0,4)|0;t=B()|0}while(!((e|0)==0&(t|0)==0));return i|0}function dp(e,t,i){e=e|0;t=t|0;i=i|0;if(!((e|0)==0&(t|0)==0))do{i=i+-1|0;r[i>>0]=e&7|48;e=ag(e|0,t|0,3)|0;t=B()|0}while(!((e|0)==0&(t|0)==0));return i|0}function pp(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,s=0,o=0;if(t>>>0>0|(t|0)==0&e>>>0>4294967295){do{n=e;e=og(e|0,t|0,10,0)|0;s=t;t=B()|0;o=tg(e|0,t|0,10,0)|0;o=rg(n|0,s|0,o|0,B()|0)|0;B()|0;i=i+-1|0;r[i>>0]=o&255|48}while(s>>>0>9|(s|0)==9&n>>>0>4294967295);t=e}else t=e;if(t)do{o=t;t=(t>>>0)/10|0;i=i+-1|0;r[i>>0]=o-(t*10|0)|48}while(o>>>0>=10);return i|0}function fp(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var s=0,o=0;o=J;J=J+256|0;s=o;if((i|0)>(r|0)&(n&73728|0)==0){n=i-r|0;dg(s|0,t<<24>>24|0,(n>>>0<256?n:256)|0)|0;if(n>>>0>255){t=i-r|0;do{up(e,s,256);n=n+-256|0}while(n>>>0>255);n=t&255}up(e,s,n)}J=o;return}function vp(e,t){e=e|0;t=t|0;if(!e)e=0;else e=gp(e,t,0)|0;return e|0}function gp(e,t,i){e=e|0;t=t|0;i=i|0;do{if(e){if(t>>>0<128){r[e>>0]=t;e=1;break}if(!(s[s[(mp()|0)+176>>2]>>2]|0))if((t&-128|0)==57216){r[e>>0]=t;e=1;break}else{s[(zd()|0)>>2]=25;e=-1;break}if(t>>>0<2048){r[e>>0]=t>>>6|192;r[e+1>>0]=t&63|128;e=2;break}if(t>>>0<55296|(t&-8192|0)==57344){r[e>>0]=t>>>12|224;r[e+1>>0]=t>>>6&63|128;r[e+2>>0]=t&63|128;e=3;break}if((t+-65536|0)>>>0<1048576){r[e>>0]=t>>>18|240;r[e+1>>0]=t>>>12&63|128;r[e+2>>0]=t>>>6&63|128;r[e+3>>0]=t&63|128;e=4;break}else{s[(zd()|0)>>2]=25;e=-1;break}}else e=1}while(0);return e|0}function mp(){return Xd()|0}function _p(e){e=+e;var t=0;u[A>>3]=e;t=s[A>>2]|0;w(s[A+4>>2]|0);return t|0}function yp(e,t){e=+e;t=t|0;var i=0,r=0,n=0;u[A>>3]=e;i=s[A>>2]|0;r=s[A+4>>2]|0;n=ag(i|0,r|0,52)|0;B()|0;switch(n&2047){case 0:{if(e!=0.0){e=+yp(e*18446744073709551616.0,t);i=(s[t>>2]|0)+-64|0}else i=0;s[t>>2]=i;break}case 2047:break;default:{s[t>>2]=(n&2047)+-1022;s[A>>2]=i;s[A+4>>2]=r&-2146435073|1071644672;e=+u[A>>3]}}return+e}function bp(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,s=0;e:do{if(!i)e=0;else{while(1){n=r[e>>0]|0;s=r[t>>0]|0;if(n<<24>>24!=s<<24>>24)break;i=i+-1|0;if(!i){e=0;break e}else{e=e+1|0;t=t+1|0}}e=(n&255)-(s&255)|0}}while(0);return e|0}function wp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0;n=J;J=J+16|0;o=n;s[o>>2]=r;r=Bp(e,t,i,o)|0;J=n;return r|0}function Bp(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var o=0,a=0,l=0,u=0;u=J;J=J+160|0;o=u+144|0;l=u;cg(l|0,3672,144)|0;if((t+-1|0)>>>0>2147483646){if(!t){e=o;t=1;a=4}else{s[(zd()|0)>>2]=61;t=-1}}else a=4;if((a|0)==4){a=-2-e|0;a=t>>>0>a>>>0?a:t;s[l+48>>2]=a;o=l+20|0;s[o>>2]=e;s[l+44>>2]=e;t=e+a|0;e=l+16|0;s[e>>2]=t;s[l+28>>2]=t;t=np(l,i,n)|0;if(a){l=s[o>>2]|0;r[l+(((l|0)==(s[e>>2]|0))<<31>>31)>>0]=0}}J=u;return t|0}function xp(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;r=e+20|0;n=s[r>>2]|0;e=(s[e+16>>2]|0)-n|0;e=e>>>0>i>>>0?i:e;cg(n|0,t|0,e|0)|0;s[r>>2]=(s[r>>2]|0)+e;return i|0}function Pp(e){e=e|0;var t=0,i=0;t=(Zd(e)|0)+1|0;i=Kv(t)|0;if(!i)e=0;else e=cg(i|0,e|0,t|0)|0;return e|0}function Cp(e,t){e=e|0;t=t|0;var i=0,n=0;i=0;while(1){if((o[656+i>>0]|0)==(e|0)){n=4;break}i=i+1|0;if((i|0)==87){e=87;n=5;break}}if((n|0)==4)if(!i)i=752;else{e=i;n=5}if((n|0)==5){i=752;do{do{n=i;i=i+1|0}while((r[n>>0]|0)!=0);e=e+-1|0}while((e|0)!=0)}return Mp(i,s[t+20>>2]|0)|0}function Mp(e,t){e=e|0;t=t|0;return ep(e,t)|0}function Fp(e){e=e|0;return Cp(e,s[(kp()|0)+176>>2]|0)|0}function kp(){return Xd()|0}function Ep(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;n=Fp(e)|0;e=Zd(n)|0;if(e>>>0>=i>>>0){e=i+-1|0;if(!i)e=68;else{cg(t|0,n|0,e|0)|0;r[t+e>>0]=0;e=68}}else{cg(t|0,n|0,e+1|0)|0;e=0}return e|0}function Ip(){var e=0,t=0,i=0,r=0,n=0,o=0,a=0;r=J;J=J+48|0;o=r+32|0;t=r+24|0;a=r+16|0;n=r;r=r+36|0;e=Tp()|0;if(e|0?(i=s[e>>2]|0,i|0):0){e=i+48|0;if(!(Dp(e)|0)){s[t>>2]=20420;Rp(20370,t)}t=Sp(e)|0;if((t|0)==1126902529&(B()|0)==1129074247)e=s[i+44>>2]|0;else e=i+80|0;s[r>>2]=e;i=s[i>>2]|0;e=s[i+4>>2]|0;if(Hg[s[(s[954]|0)+16>>2]&7](3816,i,r)|0){a=s[r>>2]|0;a=Ng[s[(s[a>>2]|0)+8>>2]&15](a)|0;s[n>>2]=20420;s[n+4>>2]=e;s[n+8>>2]=a;Rp(20284,n)}else{s[a>>2]=20420;s[a+4>>2]=e;Rp(20329,a)}}Rp(20408,o)}function Tp(){return 21640}function Dp(e){e=e|0;e=Sp(e)|0;return(e&-256|0)==1126902528&(B()|0)==1129074247|0}function Sp(e){e=e|0;var t=0;t=e;e=s[t>>2]|0;w(s[t+4>>2]|0);return e|0}function Rp(e,t){e=e|0;t=t|0;Z()}function Up(e){e=e|0;return}function Lp(e){e=e|0;Up(e);$p(e);return}function Op(e){e=e|0;return}function Np(e){e=e|0;return}function Vp(e,t,i){e=e|0;t=t|0;i=i|0;var o=0,a=0,l=0,u=0,A=0,c=0;c=J;J=J+64|0;u=c;if(!(jp(e,t,0)|0)){if((t|0)!=0?(A=Kp(t,3840,3824,0)|0,(A|0)!=0):0){s[u>>2]=A;s[u+4>>2]=0;s[u+8>>2]=e;s[u+12>>2]=-1;e=u+16|0;t=u+24|0;o=u+48|0;a=e;l=a+36|0;do{s[a>>2]=0;a=a+4|0}while((a|0)<(l|0));n[e+36>>1]=0;r[e+38>>0]=0;s[o>>2]=1;Xg[s[(s[A>>2]|0)+28>>2]&7](A,u,s[i>>2]|0,1);if((s[t>>2]|0)==1){s[i>>2]=s[e>>2];e=1}else e=0}else e=0}else e=1;J=c;return e|0}function Qp(e,t,i,r,n,o){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;o=o|0;if(jp(e,s[t+8>>2]|0,o)|0)Xp(0,t,i,r,n);return}function Hp(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;var a=0;do{if(!(jp(e,s[t+8>>2]|0,o)|0)){if(jp(e,s[t>>2]|0,o)|0){if((s[t+16>>2]|0)!=(i|0)?(a=t+20|0,(s[a>>2]|0)!=(i|0)):0){s[t+32>>2]=n;s[a>>2]=i;o=t+40|0;s[o>>2]=(s[o>>2]|0)+1;if((s[t+36>>2]|0)==1?(s[t+24>>2]|0)==2:0)r[t+54>>0]=1;s[t+44>>2]=4;break}if((n|0)==1)s[t+32>>2]=1}}else Wp(0,t,i,n)}while(0);return}function Gp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;if(jp(e,s[t+8>>2]|0,0)|0)zp(0,t,i,r);return}function jp(e,t,i){e=e|0;t=t|0;i=i|0;if(i){if((e|0)==(t|0))e=1;else e=(Kd(s[e+4>>2]|0,s[t+4>>2]|0)|0)==0}else e=(s[e+4>>2]|0)==(s[t+4>>2]|0);return e|0}function zp(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var o=0;e=t+16|0;o=s[e>>2]|0;do{if(o){if((o|0)!=(i|0)){n=t+36|0;s[n>>2]=(s[n>>2]|0)+1;s[t+24>>2]=2;r[t+54>>0]=1;break}e=t+24|0;if((s[e>>2]|0)==2)s[e>>2]=n}else{s[e>>2]=i;s[t+24>>2]=n;s[t+36>>2]=1}}while(0);return}function Wp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;if((s[t+4>>2]|0)==(i|0)?(n=t+28|0,(s[n>>2]|0)!=1):0)s[n>>2]=r;return}function Xp(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;r[t+53>>0]=1;do{if((s[t+4>>2]|0)==(n|0)){r[t+52>>0]=1;e=t+16|0;n=s[e>>2]|0;if(!n){s[e>>2]=i;s[t+24>>2]=o;s[t+36>>2]=1;if(!((o|0)==1?(s[t+48>>2]|0)==1:0))break;r[t+54>>0]=1;break}if((n|0)!=(i|0)){o=t+36|0;s[o>>2]=(s[o>>2]|0)+1;r[t+54>>0]=1;break}n=t+24|0;e=s[n>>2]|0;if((e|0)==2){s[n>>2]=o;e=o}if((e|0)==1?(s[t+48>>2]|0)==1:0)r[t+54>>0]=1}}while(0);return}function Kp(e,t,i,o){e=e|0;t=t|0;i=i|0;o=o|0;var a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0;f=J;J=J+64|0;d=f;h=s[e>>2]|0;p=e+(s[h+-8>>2]|0)|0;h=s[h+-4>>2]|0;s[d>>2]=i;s[d+4>>2]=e;s[d+8>>2]=t;s[d+12>>2]=o;e=d+16|0;t=d+20|0;o=d+24|0;a=d+28|0;l=d+32|0;u=d+40|0;A=e;c=A+36|0;do{s[A>>2]=0;A=A+4|0}while((A|0)<(c|0));n[e+36>>1]=0;r[e+38>>0]=0;e:do{if(jp(h,i,0)|0){s[d+48>>2]=1;Zg[s[(s[h>>2]|0)+20>>2]&3](h,d,p,p,1,0);e=(s[o>>2]|0)==1?p:0}else{Kg[s[(s[h>>2]|0)+24>>2]&3](h,d,p,1,0);switch(s[d+36>>2]|0){case 0:{e=(s[u>>2]|0)==1&(s[a>>2]|0)==1&(s[l>>2]|0)==1?s[t>>2]|0:0;break e}case 1:break;default:{e=0;break e}}if((s[o>>2]|0)!=1?!((s[u>>2]|0)==0&(s[a>>2]|0)==1&(s[l>>2]|0)==1):0){e=0;break}e=s[e>>2]|0}}while(0);J=f;return e|0}function Zp(e){e=e|0;Up(e);$p(e);return}function Jp(e,t,i,r,n,o){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;o=o|0;if(jp(e,s[t+8>>2]|0,o)|0)Xp(0,t,i,r,n);else{e=s[e+8>>2]|0;Zg[s[(s[e>>2]|0)+20>>2]&3](e,t,i,r,n,o)}return}function Yp(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;var a=0,l=0,u=0;e:do{if(!(jp(e,s[t+8>>2]|0,o)|0)){if(!(jp(e,s[t>>2]|0,o)|0)){l=s[e+8>>2]|0;Kg[s[(s[l>>2]|0)+24>>2]&3](l,t,i,n,o);break}if((s[t+16>>2]|0)!=(i|0)?(l=t+20|0,(s[l>>2]|0)!=(i|0)):0){s[t+32>>2]=n;n=t+44|0;do{if((s[n>>2]|0)!=4){a=t+52|0;r[a>>0]=0;u=t+53|0;r[u>>0]=0;e=s[e+8>>2]|0;Zg[s[(s[e>>2]|0)+20>>2]&3](e,t,i,i,1,o);if(r[u>>0]|0){u=(r[a>>0]|0)==0;s[n>>2]=3;if(u)break;else break e}else{s[n>>2]=4;break}}}while(0);s[l>>2]=i;u=t+40|0;s[u>>2]=(s[u>>2]|0)+1;if((s[t+36>>2]|0)!=1)break;if((s[t+24>>2]|0)!=2)break;r[t+54>>0]=1;break}if((n|0)==1)s[t+32>>2]=1}else Wp(0,t,i,n)}while(0);return}function qp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;if(jp(e,s[t+8>>2]|0,0)|0)zp(0,t,i,r);else{e=s[e+8>>2]|0;Xg[s[(s[e>>2]|0)+28>>2]&7](e,t,i,r)}return}function $p(e){e=e|0;Zv(e);return}function ef(e){e=e|0;return}function tf(){var e=0,t=0;e=Tp()|0;if((e|0?(t=s[e>>2]|0,t|0):0)?Dp(t+48|0)|0:0)rf(s[t+12>>2]|0);rf(nf()|0)}function rf(e){e=e|0;var t=0;t=J;J=J+16|0;Gg[e&3]();Rp(20559,t)}function nf(){return 2}function sf(e){e=e|0;return}function of(e){e=e|0;$p(e);return}function af(e){e=e|0;return 20599}function lf(e){e=e|0;s[e>>2]=5916;hf(e+4|0);return}function uf(e){e=e|0;lf(e);$p(e);return}function Af(e){e=e|0;return cf(e+4|0)|0}function cf(e){e=e|0;return s[e>>2]|0}function hf(e){e=e|0;var t=0,i=0;if(df(e)|0?(t=pf(s[e>>2]|0)|0,i=t+8|0,e=s[i>>2]|0,s[i>>2]=e+-1,(e|0)<1):0)$p(t);return}function df(e){e=e|0;return 1}function pf(e){e=e|0;return e+-12|0}function ff(e){e=e|0;s[e>>2]=5936;hf(e+4|0);return}function vf(e){e=e|0;ff(e);$p(e);return}function gf(e){e=e|0;return cf(e+4|0)|0}function mf(e){e=e|0;lf(e);$p(e);return}function _f(e){e=e|0;lf(e);$p(e);return}function yf(){var e=0;e=J;J=J+16|0;Rp(20848,e)}function bf(e){e=e|0;Up(e);$p(e);return}function wf(e,t,i){e=e|0;t=t|0;i=i|0;return jp(e,t,0)|0}function Bf(e){e=e|0;Up(e);$p(e);return}function xf(e,t,i){e=e|0;t=t|0;i=i|0;var o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0;d=J;J=J+64|0;c=d;do{if(!(jp(t,4048,0)|0)){if(Pf(e,t,0)|0){t=s[i>>2]|0;if(!t){t=1;break}s[i>>2]=s[t>>2];t=1;break}if((t|0)!=0?(o=Kp(t,3840,3976,0)|0,(o|0)!=0):0){t=s[i>>2]|0;if(t|0)s[i>>2]=s[t>>2];t=s[o+8>>2]|0;l=e+8|0;a=s[l>>2]|0;if((t&7&(a^7)|0)==0?((t&96^96)&a|0)==0:0){a=e+12|0;e=s[a>>2]|0;o=o+12|0;t=s[o>>2]|0;if(!(jp(e,t,0)|0)){if(jp(e,4040,0)|0){if(!t){t=1;break}t=(Kp(t,3840,3992,0)|0)==0;break}if(e){t=Kp(e,3840,3976,0)|0;if(t|0){if(!(s[l>>2]&1)){t=0;break}t=Cf(t,s[o>>2]|0)|0;break}t=s[a>>2]|0;if(t){t=Kp(t,3840,4008,0)|0;if(t|0){if(!(s[l>>2]&1)){t=0;break}t=Mf(t,s[o>>2]|0)|0;break}t=s[a>>2]|0;if((((t|0)!=0?(u=Kp(t,3840,3824,0)|0,(u|0)!=0):0)?(A=s[o>>2]|0,(A|0)!=0):0)?(h=Kp(A,3840,3824,0)|0,(h|0)!=0):0){s[c>>2]=h;s[c+4>>2]=0;s[c+8>>2]=u;s[c+12>>2]=-1;t=c+16|0;e=c+24|0;o=c+48|0;a=t;l=a+36|0;do{s[a>>2]=0;a=a+4|0}while((a|0)<(l|0));n[t+36>>1]=0;r[t+38>>0]=0;s[o>>2]=1;Xg[s[(s[h>>2]|0)+28>>2]&7](h,c,s[i>>2]|0,1);do{if((s[e>>2]|0)==1){if(!(s[i>>2]|0)){t=1;break}s[i>>2]=s[t>>2];t=1}else t=0}while(0)}else t=0}else t=0}else t=0}else t=1}else t=0}else t=0}else{s[i>>2]=0;t=1}}while(0);J=d;return t|0}function Pf(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;if(!(s[e+8>>2]&24)){if((t|0)!=0?(r=Kp(t,3840,3960,0)|0,(r|0)!=0):0){i=(s[r+8>>2]&24|0)!=0;n=5}else i=0}else{i=1;n=5}if((n|0)==5)i=jp(e,t,i)|0;return i|0}function Cf(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,o=0,a=0;while(1){if(!t){t=0;break}i=Kp(t,3840,3976,0)|0;if(!i){t=0;break}n=s[e+8>>2]|0;if(s[i+8>>2]&~n|0){t=0;break}r=e+12|0;t=s[r>>2]|0;i=i+12|0;if(jp(t,s[i>>2]|0,0)|0){t=1;break}if((n&1|0)==0|(t|0)==0){t=0;break}e=Kp(t,3840,3976,0)|0;if(!e){a=9;break}t=s[i>>2]|0}if((a|0)==9){t=s[r>>2]|0;if((t|0)!=0?(o=Kp(t,3840,4008,0)|0,(o|0)!=0):0)t=Mf(o,s[i>>2]|0)|0;else t=0}return t|0}function Mf(e,t){e=e|0;t=t|0;var i=0;if((((t|0)!=0?(i=Kp(t,3840,4008,0)|0,(i|0)!=0):0)?(s[i+8>>2]&~s[e+8>>2]|0)==0:0)?jp(s[e+12>>2]|0,s[i+12>>2]|0,0)|0:0)e=jp(s[e+16>>2]|0,s[i+16>>2]|0,0)|0;else e=0;return e|0}function Ff(e){e=e|0;Up(e);$p(e);return}function kf(e,t,i,n,o,a){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;a=a|0;var l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0,g=0;if(jp(e,s[t+8>>2]|0,a)|0)Xp(0,t,i,n,o);else{g=t+52|0;u=r[g>>0]|0;v=t+53|0;l=r[v>>0]|0;f=s[e+12>>2]|0;h=e+16+(f<<3)|0;r[g>>0]=0;r[v>>0]=0;Df(e+16|0,t,i,n,o,a);A=r[g>>0]|0;u=A|u;c=r[v>>0]|0;l=c|l;e:do{if((f|0)>1){d=t+24|0;p=e+8|0;f=t+54|0;e=e+24|0;do{l=l&1;u=u&1;if(r[f>>0]|0)break e;if(!(A<<24>>24)){if(c<<24>>24?(s[p>>2]&1|0)==0:0)break e}else{if((s[d>>2]|0)==1)break e;if(!(s[p>>2]&2))break e}r[g>>0]=0;r[v>>0]=0;Df(e,t,i,n,o,a);A=r[g>>0]|0;u=A|u;c=r[v>>0]|0;l=c|l;e=e+8|0}while(e>>>0<h>>>0)}}while(0);r[g>>0]=u<<24>>24!=0&1;r[v>>0]=l<<24>>24!=0&1}return}function Ef(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;var a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0;e:do{if(!(jp(e,s[t+8>>2]|0,o)|0)){if(!(jp(e,s[t>>2]|0,o)|0)){f=s[e+12>>2]|0;A=e+16+(f<<3)|0;Sf(e+16|0,t,i,n,o);a=e+24|0;if((f|0)<=1)break;e=s[e+8>>2]|0;if((e&2|0)==0?(u=t+36|0,(s[u>>2]|0)!=1):0){if(!(e&1)){e=t+54|0;while(1){if(r[e>>0]|0)break e;if((s[u>>2]|0)==1)break e;Sf(a,t,i,n,o);a=a+8|0;if(a>>>0>=A>>>0)break e}}e=t+24|0;l=t+54|0;while(1){if(r[l>>0]|0)break e;if((s[u>>2]|0)==1?(s[e>>2]|0)==1:0)break e;Sf(a,t,i,n,o);a=a+8|0;if(a>>>0>=A>>>0)break e}}e=t+54|0;while(1){if(r[e>>0]|0)break e;Sf(a,t,i,n,o);a=a+8|0;if(a>>>0>=A>>>0)break e}}if((s[t+16>>2]|0)!=(i|0)?(f=t+20|0,(s[f>>2]|0)!=(i|0)):0){s[t+32>>2]=n;p=t+44|0;if((s[p>>2]|0)!=4){u=e+16+(s[e+12>>2]<<3)|0;A=t+52|0;n=t+53|0;c=t+54|0;h=e+8|0;d=t+24|0;a=0;l=e+16|0;e=0;t:while(1){if(l>>>0>=u>>>0){l=18;break}r[A>>0]=0;r[n>>0]=0;Df(l,t,i,i,1,o);if(r[c>>0]|0){l=18;break}do{if(r[n>>0]|0){if(!(r[A>>0]|0))if(!(s[h>>2]&1)){l=19;break t}else{e=1;break}if((s[d>>2]|0)==1){a=1;l=19;break t}if(!(s[h>>2]&2)){a=1;l=19;break t}else{a=1;e=1}}}while(0);l=l+8|0}if((l|0)==18)if(e)l=19;else e=4;if((l|0)==19)e=3;s[p>>2]=e;if(a&1)break}s[f>>2]=i;i=t+40|0;s[i>>2]=(s[i>>2]|0)+1;if((s[t+36>>2]|0)!=1)break;if((s[t+24>>2]|0)!=2)break;r[t+54>>0]=1;break}if((n|0)==1)s[t+32>>2]=1}else Wp(0,t,i,n)}while(0);return}function If(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var o=0,a=0;e:do{if(!(jp(e,s[t+8>>2]|0,0)|0)){a=s[e+12>>2]|0;o=e+16+(a<<3)|0;Tf(e+16|0,t,i,n);if((a|0)>1){a=t+54|0;e=e+24|0;do{Tf(e,t,i,n);if(r[a>>0]|0)break e;e=e+8|0}while(e>>>0<o>>>0)}}else zp(0,t,i,n)}while(0);return}function Tf(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,o=0;o=s[e+4>>2]|0;if(i){n=o>>8;if(o&1)n=s[(s[i>>2]|0)+n>>2]|0}else n=0;e=s[e>>2]|0;Xg[s[(s[e>>2]|0)+28>>2]&7](e,t,i+n|0,(o&2|0)==0?2:r);return}function Df(e,t,i,r,n,o){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;o=o|0;var a=0,l=0;l=s[e+4>>2]|0;a=l>>8;if(l&1)a=s[(s[r>>2]|0)+a>>2]|0;e=s[e>>2]|0;Zg[s[(s[e>>2]|0)+20>>2]&3](e,t,i,r+a|0,(l&2|0)==0?2:n,o);return}function Sf(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var o=0,a=0;a=s[e+4>>2]|0;o=a>>8;if(a&1)o=s[(s[i>>2]|0)+o>>2]|0;e=s[e>>2]|0;Kg[s[(s[e>>2]|0)+24>>2]&3](e,t,i+o|0,(a&2|0)==0?2:r,n);return}function Rf(e){e=e|0;s[e>>2]=5896;return}function Uf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Lf(i,e);e=Of(i)|0;J=t;return e|0}function Lf(e,t){e=e|0;t=t|0;Gf(e,t);return}function Of(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Nf(i,s[e+4>>2]|0);if(!((Vf(i)|0)<<24>>24))e=Hf(Qf(e)|0)|0;else e=0;J=t;return e|0}function Nf(e,t){e=e|0;t=t|0;s[e>>2]=t;return}function Vf(e){e=e|0;return r[s[e>>2]>>0]|0}function Qf(e){e=e|0;return e|0}function Hf(e){e=e|0;var t=0,i=0,n=0,o=0;o=J;J=J+16|0;n=o;e=s[e+8>>2]|0;t=r[e>>0]|0;do{if(t<<24>>24!=1){if(!(t&2)){r[e>>0]=2;i=1;break}else Rp(20985,n)}else i=0}while(0);J=o;return i|0}function Gf(e,t){e=e|0;t=t|0;s[e>>2]=t;s[e+4>>2]=t;s[e+8>>2]=t+1;s[e+12>>2]=0;return}function jf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Lf(i,e);zf(i);J=t;return}function zf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Nf(i,s[e+4>>2]|0);Wf(i);Xf(Qf(e)|0);J=t;return}function Wf(e){e=e|0;r[s[e>>2]>>0]=1;return}function Xf(e){e=e|0;r[s[e+8>>2]>>0]=1;return}function Kf(){return 0}function Zf(e){e=e|0;var t=0,i=0;i=(e|0)==0?1:e;while(1){t=Kv(i)|0;if(t|0){e=6;break}e=Kf()|0;if(!e){e=5;break}Gg[e&3]()}if((e|0)==5){i=x(4)|0;Rf(i);C(i|0,3880,121)}else if((e|0)==6)return t|0;return 0}function Jf(e){e=e|0;return Zf(e)|0}function Yf(e){e=e|0;$p(e);return}function qf(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=J;J=J+16|0;r=n;s[r>>2]=s[i>>2];e=Hg[s[(s[e>>2]|0)+16>>2]&7](e,t,r)|0;if(e)s[i>>2]=s[r>>2];J=n;return e&1|0}function $f(e){e=e|0;if(!e)e=0;else e=(Kp(e,3840,3976,0)|0)!=0&1;return e|0}function ev(e){e=e|0;return 0}function tv(){return(iv()|0)>0|0}function iv(){return M()|0}function rv(e){e=e|0;return}function nv(e){e=e|0;rv(e);$p(e);return}function sv(e){e=e|0;return 21039}function ov(e){e=e|0;return}function av(e){e=e|0;var t=0,i=0;t=e+8|0;if(!((s[t>>2]|0)!=0?(i=s[t>>2]|0,s[t>>2]=i+-1,(i|0)!=0):0))jg[s[(s[e>>2]|0)+16>>2]&255](e);return}function lv(e){e=e|0;e=ev(e)|0;if(!e)return;else Wv(e,21145)}function uv(e){e=e|0;return}function Av(e,t){e=e|0;t=t|0;var i=0,r=0;r=Zd(t)|0;i=Zf(r+13|0)|0;s[i>>2]=r;s[i+4>>2]=r;s[i+8>>2]=0;i=cv(i)|0;cg(i|0,t|0,r+1|0)|0;s[e>>2]=i;return}function cv(e){e=e|0;return e+12|0}function hv(e,t){e=e|0;t=t|0;s[e>>2]=5916;Av(e+4|0,t);return}function dv(e,t){e=e|0;t=t|0;s[e>>2]=5936;Av(e+4|0,(r[t+11>>0]|0)<0?s[t>>2]|0:t);return}function pv(e,t){e=e|0;t=t|0;s[e>>2]=5936;Av(e+4|0,t);return}function fv(e){e=e|0;e=x(8)|0;hv(e,21163);s[e>>2]=5956;C(e|0,3928,123)}function vv(e){e=e|0;e=x(8)|0;hv(e,21163);s[e>>2]=5976;C(e|0,3944,123)}function gv(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0;o=J;J=J+16|0;n=o;if(i>>>0>4294967279)fv(e);if(i>>>0<11)r[e+11>>0]=i;else{l=i+16&-16;a=Zf(l)|0;s[e>>2]=a;s[e+8>>2]=l|-2147483648;s[e+4>>2]=i;e=a}mv(e,t,i)|0;r[n>>0]=0;nt(e+i|0,n);J=o;return}function mv(e,t,i){e=e|0;t=t|0;i=i|0;if(i|0)cg(e|0,t|0,i|0)|0;return e|0}function _v(e){e=e|0;if((r[e+11>>0]|0)<0)ye(s[e>>2]|0,s[e+8>>2]&2147483647);return}function yv(e,t,i,n,o,a,l,u){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;a=a|0;l=l|0;u=u|0;var A=0,c=0,h=0,d=0,p=0;p=J;J=J+16|0;d=p;if((-18-t|0)>>>0<i>>>0)fv(e);if((r[e+11>>0]|0)<0)h=s[e>>2]|0;else h=e;if(t>>>0<2147483623){A=i+t|0;c=t<<1;A=A>>>0<c>>>0?c:A;A=A>>>0<11?11:A+16&-16}else A=-17;c=Zf(A)|0;if(o|0)mv(c,h,o)|0;if(l|0)mv(c+o|0,u,l)|0;n=n-a|0;i=n-o|0;if(i|0)mv(c+o+l|0,h+o+a|0,i)|0;i=t+1|0;if((i|0)!=11)ye(h,i);s[e>>2]=c;s[e+8>>2]=A|-2147483648;l=n+l|0;s[e+4>>2]=l;r[d>>0]=0;nt(c+l|0,d);J=p;return}function bv(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0,u=0,A=0;A=J;J=J+16|0;l=A;u=e+11|0;n=r[u>>0]|0;a=n<<24>>24<0;if(a){o=(s[e+8>>2]&2147483647)+-1|0;n=s[e+4>>2]|0}else{o=10;n=n&255}if((o-n|0)>>>0>=i>>>0){if(i|0){if(a)o=s[e>>2]|0;else o=e;mv(o+n|0,t,i)|0;n=n+i|0;if((r[u>>0]|0)<0)s[e+4>>2]=n;else r[u>>0]=n;r[l>>0]=0;nt(o+n|0,l)}}else yv(e,o,n+i-o|0,n,n,0,i,t);J=A;return e|0}function wv(e,t){e=e|0;t=t|0;return bv(e,t,it(t)|0)|0}function Bv(e,t,i){e=e|0;t=t|0;i=i|0;if(!i)e=0;else e=bp(e,t,i)|0;return e|0}function xv(e,t,i,n,o){e=e|0;t=t|0;i=i|0;n=n|0;o=o|0;var a=0,l=0;a=r[e+11>>0]|0;l=a<<24>>24<0;if(l)a=s[e+4>>2]|0;else a=a&255;if((o|0)==-1|a>>>0<t>>>0)vv(e);a=a-t|0;i=a>>>0<i>>>0?a:i;if(l)e=s[e>>2]|0;a=i>>>0>o>>>0;e=Bv(e+t|0,n,a?o:i)|0;if(!e)return(i>>>0<o>>>0?-1:a&1)|0;else return e|0;return 0}function Pv(e){e=e|0;return}function Cv(e){e=e|0;$p(e);return}function Mv(e){e=e|0;return 21228}function Fv(e,t,i){e=e|0;t=t|0;i=i|0;s[e>>2]=i;s[e+4>>2]=t;return}function kv(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0;n=J;J=J+16|0;r=n;Wg[s[(s[e>>2]|0)+12>>2]&15](r,e,t);if((s[r+4>>2]|0)==(s[i+4>>2]|0))e=(s[r>>2]|0)==(s[i>>2]|0);else e=0;J=n;return e|0}function Ev(e,t,i){e=e|0;t=t|0;i=i|0;return((s[t>>2]|0)==(i|0)?(s[t+4>>2]|0)==(e|0):0)|0}function Iv(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256)gv(e,21176,it(21176)|0);else Tv(e,0,i);return}function Tv(e,t,i){e=e|0;t=t|0;i=i|0;Dv(e,i);return}function Dv(e,t){e=e|0;t=t|0;var i=0,n=0,o=0,a=0,l=0;l=J;J=J+1040|0;o=l+1024|0;i=l;a=s[(zd()|0)>>2]|0;n=Sv(Ep(t,i,1024)|0,i)|0;if(!(r[n>>0]|0)){s[o>>2]=t;wp(i,1024,21211,o)|0}else i=n;s[(zd()|0)>>2]=a;gv(e,i,it(i)|0);J=l;return}function Sv(e,t){e=e|0;t=t|0;var i=0,r=0;switch(e|0){case 0:{i=t;break}case-1:{e=s[(zd()|0)>>2]|0;r=3;break}default:r=3}if((r|0)==3)if((e|0)==28)i=22145;else j();return i|0}function Rv(e){e=e|0;$p(e);return}function Uv(e){e=e|0;return 21353}function Lv(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256){Nv()|0;t=6180}else{Vv()|0;t=6176}s[e>>2]=i;s[e+4>>2]=t;return}function Ov(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256)gv(e,21319,it(21319)|0);else Tv(e,0,i);return}function Nv(){if((r[21488]|0)==0?Uf(21488)|0:0)jf(21488);return 6180}function Vv(){if((r[21480]|0)==0?Uf(21480)|0:0)jf(21480);return 6176}function Qv(e){e=e|0;ff(e);return}function Hv(e){e=e|0;Qv(e);$p(e);return}function Gv(e,t){e=e|0;t=t|0;var i=0;i=s[t+4>>2]|0;Wg[s[(s[i>>2]|0)+24>>2]&15](e,i,s[t>>2]|0);return}function jv(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0;a=J;J=J+16|0;o=a;if(s[t>>2]|0){n=r[i+11>>0]|0;if(n<<24>>24<0)n=s[i+4>>2]|0;else n=n&255;if(n|0)wv(i,21417)|0;Gv(o,t);t=r[o+11>>0]|0;n=t<<24>>24<0;bv(i,n?s[o>>2]|0:o,n?s[o+4>>2]|0:t&255)|0;_v(o)}s[e>>2]=s[i>>2];s[e+4>>2]=s[i+4>>2];s[e+8>>2]=s[i+8>>2];n=0;while(1){if((n|0)==3)break;s[i+(n<<2)>>2]=0;n=n+1|0}J=a;return}function zv(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,o=0;r=J;J=J+32|0;o=r+12|0;n=r;gv(n,i,it(i)|0);jv(o,t,n);dv(e,o);_v(o);_v(n);s[e>>2]=6192;n=t;t=s[n+4>>2]|0;i=e+8|0;s[i>>2]=s[n>>2];s[i+4>>2]=t;J=r;return}function Wv(e,t){e=e|0;t=t|0;var i=0,r=0,n=0;n=J;J=J+16|0;r=n+8|0;i=x(16)|0;Nv()|0;s[n>>2]=e;s[n+4>>2]=6180;s[r>>2]=s[n>>2];s[r+4>>2]=s[n+4>>2];zv(i,r,t);C(i|0,4272,136)}function Xv(e){e=e|0;e=x(8)|0;hv(e,21420);s[e>>2]=5956;C(e|0,3928,123)}function Kv(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0,v=0,g=0,m=0,_=0,y=0,b=0,w=0;w=J;J=J+16|0;d=w;do{if(e>>>0<245){A=e>>>0<11?16:e+11&-8;e=A>>>3;h=s[5412]|0;i=h>>>e;if(i&3|0){t=(i&1^1)+e|0;e=21688+(t<<1<<2)|0;i=e+8|0;r=s[i>>2]|0;n=r+8|0;o=s[n>>2]|0;if((o|0)==(e|0))s[5412]=h&~(1<<t);else{s[o+12>>2]=e;s[i>>2]=o}b=t<<3;s[r+4>>2]=b|3;b=r+b+4|0;s[b>>2]=s[b>>2]|1;b=n;J=w;return b|0}c=s[5414]|0;if(A>>>0>c>>>0){if(i|0){t=2<<e;t=i<<e&(t|0-t);t=(t&0-t)+-1|0;l=t>>>12&16;t=t>>>l;i=t>>>5&8;t=t>>>i;o=t>>>2&4;t=t>>>o;e=t>>>1&2;t=t>>>e;r=t>>>1&1;r=(i|l|o|e|r)+(t>>>r)|0;t=21688+(r<<1<<2)|0;e=t+8|0;o=s[e>>2]|0;l=o+8|0;i=s[l>>2]|0;if((i|0)==(t|0)){e=h&~(1<<r);s[5412]=e}else{s[i+12>>2]=t;s[e>>2]=i;e=h}b=r<<3;a=b-A|0;s[o+4>>2]=A|3;n=o+A|0;s[n+4>>2]=a|1;s[o+b>>2]=a;if(c|0){r=s[5417]|0;t=c>>>3;i=21688+(t<<1<<2)|0;t=1<<t;if(!(e&t)){s[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=s[e>>2]|0}s[e>>2]=r;s[t+12>>2]=r;s[r+8>>2]=t;s[r+12>>2]=i}s[5414]=a;s[5417]=n;b=l;J=w;return b|0}o=s[5413]|0;if(o){i=(o&0-o)+-1|0;n=i>>>12&16;i=i>>>n;r=i>>>5&8;i=i>>>r;a=i>>>2&4;i=i>>>a;l=i>>>1&2;i=i>>>l;u=i>>>1&1;u=s[21952+((r|n|a|l|u)+(i>>>u)<<2)>>2]|0;i=u;l=u;u=(s[u+4>>2]&-8)-A|0;while(1){e=s[i+16>>2]|0;if(!e){e=s[i+20>>2]|0;if(!e)break}a=(s[e+4>>2]&-8)-A|0;n=a>>>0<u>>>0;i=e;l=n?e:l;u=n?a:u}a=l+A|0;if(a>>>0>l>>>0){n=s[l+24>>2]|0;t=s[l+12>>2]|0;do{if((t|0)==(l|0)){e=l+20|0;t=s[e>>2]|0;if(!t){e=l+16|0;t=s[e>>2]|0;if(!t){i=0;break}}while(1){r=t+20|0;i=s[r>>2]|0;if(!i){r=t+16|0;i=s[r>>2]|0;if(!i)break;else{t=i;e=r}}else{t=i;e=r}}s[e>>2]=0;i=t}else{i=s[l+8>>2]|0;s[i+12>>2]=t;s[t+8>>2]=i;i=t}}while(0);do{if(n|0){t=s[l+28>>2]|0;e=21952+(t<<2)|0;if((l|0)==(s[e>>2]|0)){s[e>>2]=i;if(!i){s[5413]=o&~(1<<t);break}}else{b=n+16|0;s[((s[b>>2]|0)==(l|0)?b:n+20|0)>>2]=i;if(!i)break}s[i+24>>2]=n;t=s[l+16>>2]|0;if(t|0){s[i+16>>2]=t;s[t+24>>2]=i}t=s[l+20>>2]|0;if(t|0){s[i+20>>2]=t;s[t+24>>2]=i}}}while(0);if(u>>>0<16){b=u+A|0;s[l+4>>2]=b|3;b=l+b+4|0;s[b>>2]=s[b>>2]|1}else{s[l+4>>2]=A|3;s[a+4>>2]=u|1;s[a+u>>2]=u;if(c|0){r=s[5417]|0;t=c>>>3;i=21688+(t<<1<<2)|0;t=1<<t;if(!(t&h)){s[5412]=t|h;t=i;e=i+8|0}else{e=i+8|0;t=s[e>>2]|0}s[e>>2]=r;s[t+12>>2]=r;s[r+8>>2]=t;s[r+12>>2]=i}s[5414]=u;s[5417]=a}b=l+8|0;J=w;return b|0}else h=A}else h=A}else h=A}else if(e>>>0<=4294967231){e=e+11|0;A=e&-8;r=s[5413]|0;if(r){n=0-A|0;e=e>>>8;if(e){if(A>>>0>16777215)u=31;else{h=(e+1048320|0)>>>16&8;v=e<<h;l=(v+520192|0)>>>16&4;v=v<<l;u=(v+245760|0)>>>16&2;u=14-(l|h|u)+(v<<u>>>15)|0;u=A>>>(u+7|0)&1|u<<1}}else u=0;i=s[21952+(u<<2)>>2]|0;e:do{if(!i){i=0;e=0;v=61}else{e=0;l=A<<((u|0)==31?0:25-(u>>>1)|0);o=0;while(1){a=(s[i+4>>2]&-8)-A|0;if(a>>>0<n>>>0)if(!a){e=i;n=0;v=65;break e}else{e=i;n=a}v=s[i+20>>2]|0;i=s[i+16+(l>>>31<<2)>>2]|0;o=(v|0)==0|(v|0)==(i|0)?o:v;if(!i){i=o;v=61;break}else l=l<<1}}}while(0);if((v|0)==61){if((i|0)==0&(e|0)==0){e=2<<u;e=(e|0-e)&r;if(!e){h=A;break}h=(e&0-e)+-1|0;a=h>>>12&16;h=h>>>a;o=h>>>5&8;h=h>>>o;l=h>>>2&4;h=h>>>l;u=h>>>1&2;h=h>>>u;i=h>>>1&1;e=0;i=s[21952+((o|a|l|u|i)+(h>>>i)<<2)>>2]|0}if(!i){l=e;a=n}else v=65}if((v|0)==65){o=i;while(1){h=(s[o+4>>2]&-8)-A|0;i=h>>>0<n>>>0;n=i?h:n;e=i?o:e;i=s[o+16>>2]|0;if(!i)i=s[o+20>>2]|0;if(!i){l=e;a=n;break}else o=i}}if(((l|0)!=0?a>>>0<((s[5414]|0)-A|0)>>>0:0)?(c=l+A|0,c>>>0>l>>>0):0){o=s[l+24>>2]|0;t=s[l+12>>2]|0;do{if((t|0)==(l|0)){e=l+20|0;t=s[e>>2]|0;if(!t){e=l+16|0;t=s[e>>2]|0;if(!t){t=0;break}}while(1){n=t+20|0;i=s[n>>2]|0;if(!i){n=t+16|0;i=s[n>>2]|0;if(!i)break;else{t=i;e=n}}else{t=i;e=n}}s[e>>2]=0}else{b=s[l+8>>2]|0;s[b+12>>2]=t;s[t+8>>2]=b}}while(0);do{if(o){e=s[l+28>>2]|0;i=21952+(e<<2)|0;if((l|0)==(s[i>>2]|0)){s[i>>2]=t;if(!t){r=r&~(1<<e);s[5413]=r;break}}else{b=o+16|0;s[((s[b>>2]|0)==(l|0)?b:o+20|0)>>2]=t;if(!t)break}s[t+24>>2]=o;e=s[l+16>>2]|0;if(e|0){s[t+16>>2]=e;s[e+24>>2]=t}e=s[l+20>>2]|0;if(e){s[t+20>>2]=e;s[e+24>>2]=t}}}while(0);e:do{if(a>>>0<16){b=a+A|0;s[l+4>>2]=b|3;b=l+b+4|0;s[b>>2]=s[b>>2]|1}else{s[l+4>>2]=A|3;s[c+4>>2]=a|1;s[c+a>>2]=a;t=a>>>3;if(a>>>0<256){i=21688+(t<<1<<2)|0;e=s[5412]|0;t=1<<t;if(!(e&t)){s[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=s[e>>2]|0}s[e>>2]=c;s[t+12>>2]=c;s[c+8>>2]=t;s[c+12>>2]=i;break}t=a>>>8;if(t){if(a>>>0>16777215)i=31;else{y=(t+1048320|0)>>>16&8;b=t<<y;_=(b+520192|0)>>>16&4;b=b<<_;i=(b+245760|0)>>>16&2;i=14-(_|y|i)+(b<<i>>>15)|0;i=a>>>(i+7|0)&1|i<<1}}else i=0;t=21952+(i<<2)|0;s[c+28>>2]=i;e=c+16|0;s[e+4>>2]=0;s[e>>2]=0;e=1<<i;if(!(r&e)){s[5413]=r|e;s[t>>2]=c;s[c+24>>2]=t;s[c+12>>2]=c;s[c+8>>2]=c;break}t=s[t>>2]|0;t:do{if((s[t+4>>2]&-8|0)!=(a|0)){r=a<<((i|0)==31?0:25-(i>>>1)|0);while(1){i=t+16+(r>>>31<<2)|0;e=s[i>>2]|0;if(!e)break;if((s[e+4>>2]&-8|0)==(a|0)){t=e;break t}else{r=r<<1;t=e}}s[i>>2]=c;s[c+24>>2]=t;s[c+12>>2]=c;s[c+8>>2]=c;break e}}while(0);y=t+8|0;b=s[y>>2]|0;s[b+12>>2]=c;s[y>>2]=c;s[c+8>>2]=b;s[c+12>>2]=t;s[c+24>>2]=0}}while(0);b=l+8|0;J=w;return b|0}else h=A}else h=A}else h=-1}while(0);i=s[5414]|0;if(i>>>0>=h>>>0){t=i-h|0;e=s[5417]|0;if(t>>>0>15){b=e+h|0;s[5417]=b;s[5414]=t;s[b+4>>2]=t|1;s[e+i>>2]=t;s[e+4>>2]=h|3}else{s[5414]=0;s[5417]=0;s[e+4>>2]=i|3;b=e+i+4|0;s[b>>2]=s[b>>2]|1}b=e+8|0;J=w;return b|0}a=s[5415]|0;if(a>>>0>h>>>0){_=a-h|0;s[5415]=_;b=s[5418]|0;y=b+h|0;s[5418]=y;s[y+4>>2]=_|1;s[b+4>>2]=h|3;b=b+8|0;J=w;return b|0}if(!(s[5530]|0)){s[5532]=4096;s[5531]=4096;s[5533]=-1;s[5534]=-1;s[5535]=0;s[5523]=0;s[5530]=d&-16^1431655768;e=4096}else e=s[5532]|0;l=h+48|0;u=h+47|0;o=e+u|0;n=0-e|0;A=o&n;if(A>>>0<=h>>>0){b=0;J=w;return b|0}e=s[5522]|0;if(e|0?(c=s[5520]|0,d=c+A|0,d>>>0<=c>>>0|d>>>0>e>>>0):0){b=0;J=w;return b|0}e:do{if(!(s[5523]&4)){i=s[5418]|0;t:do{if(i){r=22096;while(1){d=s[r>>2]|0;if(d>>>0<=i>>>0?(d+(s[r+4>>2]|0)|0)>>>0>i>>>0:0)break;e=s[r+8>>2]|0;if(!e){v=128;break t}else r=e}t=o-a&n;if(t>>>0<2147483647){e=Jv(t)|0;if((e|0)==((s[r>>2]|0)+(s[r+4>>2]|0)|0)){if((e|0)!=(-1|0)){a=t;o=e;v=145;break e}}else{r=e;v=136}}else t=0}else v=128}while(0);do{if((v|0)==128){i=Jv(0)|0;if((i|0)!=(-1|0)?(t=i,p=s[5531]|0,f=p+-1|0,t=((f&t|0)==0?0:(f+t&0-p)-t|0)+A|0,p=s[5520]|0,f=t+p|0,t>>>0>h>>>0&t>>>0<2147483647):0){d=s[5522]|0;if(d|0?f>>>0<=p>>>0|f>>>0>d>>>0:0){t=0;break}e=Jv(t)|0;if((e|0)==(i|0)){a=t;o=i;v=145;break e}else{r=e;v=136}}else t=0}}while(0);do{if((v|0)==136){i=0-t|0;if(!(l>>>0>t>>>0&(t>>>0<2147483647&(r|0)!=(-1|0))))if((r|0)==(-1|0)){t=0;break}else{a=t;o=r;v=145;break e}e=s[5532]|0;e=u-t+e&0-e;if(e>>>0>=2147483647){a=t;o=r;v=145;break e}if((Jv(e)|0)==(-1|0)){Jv(i)|0;t=0;break}else{a=e+t|0;o=r;v=145;break e}}}while(0);s[5523]=s[5523]|4;v=143}else{t=0;v=143}}while(0);if(((v|0)==143?A>>>0<2147483647:0)?(_=Jv(A)|0,f=Jv(0)|0,g=f-_|0,m=g>>>0>(h+40|0)>>>0,!((_|0)==(-1|0)|m^1|_>>>0<f>>>0&((_|0)!=(-1|0)&(f|0)!=(-1|0))^1)):0){a=m?g:t;o=_;v=145}if((v|0)==145){t=(s[5520]|0)+a|0;s[5520]=t;if(t>>>0>(s[5521]|0)>>>0)s[5521]=t;u=s[5418]|0;e:do{if(u){t=22096;while(1){e=s[t>>2]|0;i=s[t+4>>2]|0;if((o|0)==(e+i|0)){v=154;break}r=s[t+8>>2]|0;if(!r)break;else t=r}if(((v|0)==154?(y=t+4|0,(s[t+12>>2]&8|0)==0):0)?o>>>0>u>>>0&e>>>0<=u>>>0:0){s[y>>2]=i+a;b=(s[5415]|0)+a|0;_=u+8|0;_=(_&7|0)==0?0:0-_&7;y=u+_|0;_=b-_|0;s[5418]=y;s[5415]=_;s[y+4>>2]=_|1;s[u+b+4>>2]=40;s[5419]=s[5534];break}if(o>>>0<(s[5416]|0)>>>0)s[5416]=o;i=o+a|0;t=22096;while(1){if((s[t>>2]|0)==(i|0)){v=162;break}e=s[t+8>>2]|0;if(!e)break;else t=e}if((v|0)==162?(s[t+12>>2]&8|0)==0:0){s[t>>2]=o;c=t+4|0;s[c>>2]=(s[c>>2]|0)+a;c=o+8|0;c=o+((c&7|0)==0?0:0-c&7)|0;t=i+8|0;t=i+((t&7|0)==0?0:0-t&7)|0;A=c+h|0;l=t-c-h|0;s[c+4>>2]=h|3;t:do{if((u|0)==(t|0)){b=(s[5415]|0)+l|0;s[5415]=b;s[5418]=A;s[A+4>>2]=b|1}else{if((s[5417]|0)==(t|0)){b=(s[5414]|0)+l|0;s[5414]=b;s[5417]=A;s[A+4>>2]=b|1;s[A+b>>2]=b;break}e=s[t+4>>2]|0;if((e&3|0)==1){a=e&-8;r=e>>>3;i:do{if(e>>>0<256){e=s[t+8>>2]|0;i=s[t+12>>2]|0;if((i|0)==(e|0)){s[5412]=s[5412]&~(1<<r);break}else{s[e+12>>2]=i;s[i+8>>2]=e;break}}else{o=s[t+24>>2]|0;e=s[t+12>>2]|0;do{if((e|0)==(t|0)){i=t+16|0;r=i+4|0;e=s[r>>2]|0;if(!e){e=s[i>>2]|0;if(!e){e=0;break}}else i=r;while(1){n=e+20|0;r=s[n>>2]|0;if(!r){n=e+16|0;r=s[n>>2]|0;if(!r)break;else{e=r;i=n}}else{e=r;i=n}}s[i>>2]=0}else{b=s[t+8>>2]|0;s[b+12>>2]=e;s[e+8>>2]=b}}while(0);if(!o)break;i=s[t+28>>2]|0;r=21952+(i<<2)|0;do{if((s[r>>2]|0)!=(t|0)){b=o+16|0;s[((s[b>>2]|0)==(t|0)?b:o+20|0)>>2]=e;if(!e)break i}else{s[r>>2]=e;if(e|0)break;s[5413]=s[5413]&~(1<<i);break i}}while(0);s[e+24>>2]=o;i=t+16|0;r=s[i>>2]|0;if(r|0){s[e+16>>2]=r;s[r+24>>2]=e}i=s[i+4>>2]|0;if(!i)break;s[e+20>>2]=i;s[i+24>>2]=e}}while(0);t=t+a|0;n=a+l|0}else n=l;t=t+4|0;s[t>>2]=s[t>>2]&-2;s[A+4>>2]=n|1;s[A+n>>2]=n;t=n>>>3;if(n>>>0<256){i=21688+(t<<1<<2)|0;e=s[5412]|0;t=1<<t;if(!(e&t)){s[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=s[e>>2]|0}s[e>>2]=A;s[t+12>>2]=A;s[A+8>>2]=t;s[A+12>>2]=i;break}t=n>>>8;do{if(!t)r=0;else{if(n>>>0>16777215){r=31;break}y=(t+1048320|0)>>>16&8;b=t<<y;_=(b+520192|0)>>>16&4;b=b<<_;r=(b+245760|0)>>>16&2;r=14-(_|y|r)+(b<<r>>>15)|0;r=n>>>(r+7|0)&1|r<<1}}while(0);t=21952+(r<<2)|0;s[A+28>>2]=r;e=A+16|0;s[e+4>>2]=0;s[e>>2]=0;e=s[5413]|0;i=1<<r;if(!(e&i)){s[5413]=e|i;s[t>>2]=A;s[A+24>>2]=t;s[A+12>>2]=A;s[A+8>>2]=A;break}t=s[t>>2]|0;i:do{if((s[t+4>>2]&-8|0)!=(n|0)){r=n<<((r|0)==31?0:25-(r>>>1)|0);while(1){i=t+16+(r>>>31<<2)|0;e=s[i>>2]|0;if(!e)break;if((s[e+4>>2]&-8|0)==(n|0)){t=e;break i}else{r=r<<1;t=e}}s[i>>2]=A;s[A+24>>2]=t;s[A+12>>2]=A;s[A+8>>2]=A;break t}}while(0);y=t+8|0;b=s[y>>2]|0;s[b+12>>2]=A;s[y>>2]=A;s[A+8>>2]=b;s[A+12>>2]=t;s[A+24>>2]=0}}while(0);b=c+8|0;J=w;return b|0}t=22096;while(1){e=s[t>>2]|0;if(e>>>0<=u>>>0?(b=e+(s[t+4>>2]|0)|0,b>>>0>u>>>0):0)break;t=s[t+8>>2]|0}n=b+-47|0;e=n+8|0;e=n+((e&7|0)==0?0:0-e&7)|0;n=u+16|0;e=e>>>0<n>>>0?u:e;t=e+8|0;i=a+-40|0;_=o+8|0;_=(_&7|0)==0?0:0-_&7;y=o+_|0;_=i-_|0;s[5418]=y;s[5415]=_;s[y+4>>2]=_|1;s[o+i+4>>2]=40;s[5419]=s[5534];i=e+4|0;s[i>>2]=27;s[t>>2]=s[5524];s[t+4>>2]=s[5525];s[t+8>>2]=s[5526];s[t+12>>2]=s[5527];s[5524]=o;s[5525]=a;s[5527]=0;s[5526]=t;t=e+24|0;do{y=t;t=t+4|0;s[t>>2]=7}while((y+8|0)>>>0<b>>>0);if((e|0)!=(u|0)){o=e-u|0;s[i>>2]=s[i>>2]&-2;s[u+4>>2]=o|1;s[e>>2]=o;t=o>>>3;if(o>>>0<256){i=21688+(t<<1<<2)|0;e=s[5412]|0;t=1<<t;if(!(e&t)){s[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=s[e>>2]|0}s[e>>2]=u;s[t+12>>2]=u;s[u+8>>2]=t;s[u+12>>2]=i;break}t=o>>>8;if(t){if(o>>>0>16777215)r=31;else{y=(t+1048320|0)>>>16&8;b=t<<y;_=(b+520192|0)>>>16&4;b=b<<_;r=(b+245760|0)>>>16&2;r=14-(_|y|r)+(b<<r>>>15)|0;r=o>>>(r+7|0)&1|r<<1}}else r=0;i=21952+(r<<2)|0;s[u+28>>2]=r;s[u+20>>2]=0;s[n>>2]=0;t=s[5413]|0;e=1<<r;if(!(t&e)){s[5413]=t|e;s[i>>2]=u;s[u+24>>2]=i;s[u+12>>2]=u;s[u+8>>2]=u;break}t=s[i>>2]|0;t:do{if((s[t+4>>2]&-8|0)!=(o|0)){r=o<<((r|0)==31?0:25-(r>>>1)|0);while(1){i=t+16+(r>>>31<<2)|0;e=s[i>>2]|0;if(!e)break;if((s[e+4>>2]&-8|0)==(o|0)){t=e;break t}else{r=r<<1;t=e}}s[i>>2]=u;s[u+24>>2]=t;s[u+12>>2]=u;s[u+8>>2]=u;break e}}while(0);y=t+8|0;b=s[y>>2]|0;s[b+12>>2]=u;s[y>>2]=u;s[u+8>>2]=b;s[u+12>>2]=t;s[u+24>>2]=0}}else{b=s[5416]|0;if((b|0)==0|o>>>0<b>>>0)s[5416]=o;s[5524]=o;s[5525]=a;s[5527]=0;s[5421]=s[5530];s[5420]=-1;s[5425]=21688;s[5424]=21688;s[5427]=21696;s[5426]=21696;s[5429]=21704;s[5428]=21704;s[5431]=21712;s[5430]=21712;s[5433]=21720;s[5432]=21720;s[5435]=21728;s[5434]=21728;s[5437]=21736;s[5436]=21736;s[5439]=21744;s[5438]=21744;s[5441]=21752;s[5440]=21752;s[5443]=21760;s[5442]=21760;s[5445]=21768;s[5444]=21768;s[5447]=21776;s[5446]=21776;s[5449]=21784;s[5448]=21784;s[5451]=21792;s[5450]=21792;s[5453]=21800;s[5452]=21800;s[5455]=21808;s[5454]=21808;s[5457]=21816;s[5456]=21816;s[5459]=21824;s[5458]=21824;s[5461]=21832;s[5460]=21832;s[5463]=21840;s[5462]=21840;s[5465]=21848;s[5464]=21848;s[5467]=21856;s[5466]=21856;s[5469]=21864;s[5468]=21864;s[5471]=21872;s[5470]=21872;s[5473]=21880;s[5472]=21880;s[5475]=21888;s[5474]=21888;s[5477]=21896;s[5476]=21896;s[5479]=21904;s[5478]=21904;s[5481]=21912;s[5480]=21912;s[5483]=21920;s[5482]=21920;s[5485]=21928;s[5484]=21928;s[5487]=21936;s[5486]=21936;b=a+-40|0;_=o+8|0;_=(_&7|0)==0?0:0-_&7;y=o+_|0;_=b-_|0;s[5418]=y;s[5415]=_;s[y+4>>2]=_|1;s[o+b+4>>2]=40;s[5419]=s[5534]}}while(0);t=s[5415]|0;if(t>>>0>h>>>0){_=t-h|0;s[5415]=_;b=s[5418]|0;y=b+h|0;s[5418]=y;s[y+4>>2]=_|1;s[b+4>>2]=h|3;b=b+8|0;J=w;return b|0}}s[(zd()|0)>>2]=48;b=0;J=w;return b|0}function Zv(e){e=e|0;var t=0,i=0,r=0,n=0,o=0,a=0,l=0,u=0;if(!e)return;i=e+-8|0;n=s[5416]|0;e=s[e+-4>>2]|0;t=e&-8;u=i+t|0;do{if(!(e&1)){r=s[i>>2]|0;if(!(e&3))return;a=i+(0-r)|0;o=r+t|0;if(a>>>0<n>>>0)return;if((s[5417]|0)==(a|0)){e=u+4|0;t=s[e>>2]|0;if((t&3|0)!=3){l=a;t=o;break}s[5414]=o;s[e>>2]=t&-2;s[a+4>>2]=o|1;s[a+o>>2]=o;return}i=r>>>3;if(r>>>0<256){e=s[a+8>>2]|0;t=s[a+12>>2]|0;if((t|0)==(e|0)){s[5412]=s[5412]&~(1<<i);l=a;t=o;break}else{s[e+12>>2]=t;s[t+8>>2]=e;l=a;t=o;break}}n=s[a+24>>2]|0;e=s[a+12>>2]|0;do{if((e|0)==(a|0)){t=a+16|0;i=t+4|0;e=s[i>>2]|0;if(!e){e=s[t>>2]|0;if(!e){e=0;break}}else t=i;while(1){r=e+20|0;i=s[r>>2]|0;if(!i){r=e+16|0;i=s[r>>2]|0;if(!i)break;else{e=i;t=r}}else{e=i;t=r}}s[t>>2]=0}else{l=s[a+8>>2]|0;s[l+12>>2]=e;s[e+8>>2]=l}}while(0);if(n){t=s[a+28>>2]|0;i=21952+(t<<2)|0;if((s[i>>2]|0)==(a|0)){s[i>>2]=e;if(!e){s[5413]=s[5413]&~(1<<t);l=a;t=o;break}}else{l=n+16|0;s[((s[l>>2]|0)==(a|0)?l:n+20|0)>>2]=e;if(!e){l=a;t=o;break}}s[e+24>>2]=n;t=a+16|0;i=s[t>>2]|0;if(i|0){s[e+16>>2]=i;s[i+24>>2]=e}t=s[t+4>>2]|0;if(t){s[e+20>>2]=t;s[t+24>>2]=e;l=a;t=o}else{l=a;t=o}}else{l=a;t=o}}else{l=i;a=i}}while(0);if(a>>>0>=u>>>0)return;e=u+4|0;r=s[e>>2]|0;if(!(r&1))return;if(!(r&2)){if((s[5418]|0)==(u|0)){u=(s[5415]|0)+t|0;s[5415]=u;s[5418]=l;s[l+4>>2]=u|1;if((l|0)!=(s[5417]|0))return;s[5417]=0;s[5414]=0;return}if((s[5417]|0)==(u|0)){u=(s[5414]|0)+t|0;s[5414]=u;s[5417]=a;s[l+4>>2]=u|1;s[a+u>>2]=u;return}n=(r&-8)+t|0;i=r>>>3;do{if(r>>>0<256){t=s[u+8>>2]|0;e=s[u+12>>2]|0;if((e|0)==(t|0)){s[5412]=s[5412]&~(1<<i);break}else{s[t+12>>2]=e;s[e+8>>2]=t;break}}else{o=s[u+24>>2]|0;e=s[u+12>>2]|0;do{if((e|0)==(u|0)){t=u+16|0;i=t+4|0;e=s[i>>2]|0;if(!e){e=s[t>>2]|0;if(!e){i=0;break}}else t=i;while(1){r=e+20|0;i=s[r>>2]|0;if(!i){r=e+16|0;i=s[r>>2]|0;if(!i)break;else{e=i;t=r}}else{e=i;t=r}}s[t>>2]=0;i=e}else{i=s[u+8>>2]|0;s[i+12>>2]=e;s[e+8>>2]=i;i=e}}while(0);if(o|0){e=s[u+28>>2]|0;t=21952+(e<<2)|0;if((s[t>>2]|0)==(u|0)){s[t>>2]=i;if(!i){s[5413]=s[5413]&~(1<<e);break}}else{r=o+16|0;s[((s[r>>2]|0)==(u|0)?r:o+20|0)>>2]=i;if(!i)break}s[i+24>>2]=o;e=u+16|0;t=s[e>>2]|0;if(t|0){s[i+16>>2]=t;s[t+24>>2]=i}e=s[e+4>>2]|0;if(e|0){s[i+20>>2]=e;s[e+24>>2]=i}}}}while(0);s[l+4>>2]=n|1;s[a+n>>2]=n;if((l|0)==(s[5417]|0)){s[5414]=n;return}}else{s[e>>2]=r&-2;s[l+4>>2]=t|1;s[a+t>>2]=t;n=t}e=n>>>3;if(n>>>0<256){i=21688+(e<<1<<2)|0;t=s[5412]|0;e=1<<e;if(!(t&e)){s[5412]=t|e;e=i;t=i+8|0}else{t=i+8|0;e=s[t>>2]|0}s[t>>2]=l;s[e+12>>2]=l;s[l+8>>2]=e;s[l+12>>2]=i;return}e=n>>>8;if(e){if(n>>>0>16777215)r=31;else{a=(e+1048320|0)>>>16&8;u=e<<a;o=(u+520192|0)>>>16&4;u=u<<o;r=(u+245760|0)>>>16&2;r=14-(o|a|r)+(u<<r>>>15)|0;r=n>>>(r+7|0)&1|r<<1}}else r=0;e=21952+(r<<2)|0;s[l+28>>2]=r;s[l+20>>2]=0;s[l+16>>2]=0;t=s[5413]|0;i=1<<r;e:do{if(!(t&i)){s[5413]=t|i;s[e>>2]=l;s[l+24>>2]=e;s[l+12>>2]=l;s[l+8>>2]=l}else{e=s[e>>2]|0;t:do{if((s[e+4>>2]&-8|0)!=(n|0)){r=n<<((r|0)==31?0:25-(r>>>1)|0);while(1){i=e+16+(r>>>31<<2)|0;t=s[i>>2]|0;if(!t)break;if((s[t+4>>2]&-8|0)==(n|0)){e=t;break t}else{r=r<<1;e=t}}s[i>>2]=l;s[l+24>>2]=e;s[l+12>>2]=l;s[l+8>>2]=l;break e}}while(0);a=e+8|0;u=s[a>>2]|0;s[u+12>>2]=l;s[a>>2]=l;s[l+8>>2]=u;s[l+12>>2]=e;s[l+24>>2]=0}}while(0);u=(s[5420]|0)+-1|0;s[5420]=u;if(u|0)return;e=22104;while(1){e=s[e>>2]|0;if(!e)break;else e=e+8|0}s[5420]=-1;return}function Jv(e){e=e|0;var t=0,i=0,r=0;r=e+3&-4;e=ug()|0;t=s[e>>2]|0;i=t+r|0;do{if((r|0)<1|i>>>0>t>>>0){if(i>>>0>(W()|0)>>>0?(K(i|0)|0)==0:0)break;s[e>>2]=i;r=t;return r|0}}while(0);s[(zd()|0)>>2]=48;r=-1;return r|0}function Yv(e){e=e|0;var t=0;t=J;J=J+e|0;J=J+15&-16;return t|0}function qv(e){e=e|0;J=e}function $v(){return J|0}function eg(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,s=0;s=e&65535;n=t&65535;i=_(n,s)|0;r=e>>>16;e=(i>>>16)+(_(n,r)|0)|0;n=t>>>16;t=_(n,s)|0;return(w((e>>>16)+(_(n,r)|0)+(((e&65535)+t|0)>>>16)|0),e+t<<16|i&65535|0)|0}function tg(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,s=0;n=e;s=i;i=eg(n,s)|0;e=B()|0;return(w((_(t,s)|0)+(_(r,n)|0)+e|e&0|0),i|0|0)|0}function ig(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;i=e+i>>>0;return(w(t+r+(i>>>0<e>>>0|0)>>>0|0),i|0)|0}function rg(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;r=t-r-(i>>>0>e>>>0|0)>>>0;return(w(r|0),e-i>>>0|0)|0}function ng(e){e=e|0;return(e?31-(y(e^e-1)|0)|0:32)|0}function sg(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var o=0,a=0,l=0,u=0,A=0,c=0,h=0,d=0,p=0,f=0;c=e;u=t;A=u;a=i;d=r;l=d;if(!A){o=(n|0)!=0;if(!l){if(o){s[n>>2]=(c>>>0)%(a>>>0);s[n+4>>2]=0}d=0;n=(c>>>0)/(a>>>0)>>>0;return(w(d|0),n)|0}else{if(!o){d=0;n=0;return(w(d|0),n)|0}s[n>>2]=e|0;s[n+4>>2]=t&0;d=0;n=0;return(w(d|0),n)|0}}o=(l|0)==0;do{if(a){if(!o){o=(y(l|0)|0)-(y(A|0)|0)|0;if(o>>>0<=31){h=o+1|0;l=31-o|0;t=o-31>>31;a=h;e=c>>>(h>>>0)&t|A<<l;t=A>>>(h>>>0)&t;o=0;l=c<<l;break}if(!n){d=0;n=0;return(w(d|0),n)|0}s[n>>2]=e|0;s[n+4>>2]=u|t&0;d=0;n=0;return(w(d|0),n)|0}o=a-1|0;if(o&a|0){l=(y(a|0)|0)+33-(y(A|0)|0)|0;f=64-l|0;h=32-l|0;u=h>>31;p=l-32|0;t=p>>31;a=l;e=h-1>>31&A>>>(p>>>0)|(A<<h|c>>>(l>>>0))&t;t=t&A>>>(l>>>0);o=c<<f&u;l=(A<<f|c>>>(p>>>0))&u|c<<h&l-33>>31;break}if(n|0){s[n>>2]=o&c;s[n+4>>2]=0}if((a|0)==1){p=u|t&0;f=e|0|0;return(w(p|0),f)|0}else{f=ng(a|0)|0;p=A>>>(f>>>0)|0;f=A<<32-f|c>>>(f>>>0)|0;return(w(p|0),f)|0}}else{if(o){if(n|0){s[n>>2]=(A>>>0)%(a>>>0);s[n+4>>2]=0}p=0;f=(A>>>0)/(a>>>0)>>>0;return(w(p|0),f)|0}if(!c){if(n|0){s[n>>2]=0;s[n+4>>2]=(A>>>0)%(l>>>0)}p=0;f=(A>>>0)/(l>>>0)>>>0;return(w(p|0),f)|0}o=l-1|0;if(!(o&l)){if(n|0){s[n>>2]=e|0;s[n+4>>2]=o&A|t&0}p=0;f=A>>>((ng(l|0)|0)>>>0);return(w(p|0),f)|0}o=(y(l|0)|0)-(y(A|0)|0)|0;if(o>>>0<=30){t=o+1|0;l=31-o|0;a=t;e=A<<l|c>>>(t>>>0);t=A>>>(t>>>0);o=0;l=c<<l;break}if(!n){p=0;f=0;return(w(p|0),f)|0}s[n>>2]=e|0;s[n+4>>2]=u|t&0;p=0;f=0;return(w(p|0),f)|0}}while(0);if(!a){A=l;u=0;l=0}else{h=i|0|0;c=d|r&0;A=ig(h|0,c|0,-1,-1)|0;i=B()|0;u=l;l=0;do{r=u;u=o>>>31|u<<1;o=l|o<<1;r=e<<1|r>>>31|0;d=e>>>31|t<<1|0;rg(A|0,i|0,r|0,d|0)|0;f=B()|0;p=f>>31|((f|0)<0?-1:0)<<1;l=p&1;e=rg(r|0,d|0,p&h|0,(((f|0)<0?-1:0)>>31|((f|0)<0?-1:0)<<1)&c|0)|0;t=B()|0;a=a-1|0}while((a|0)!=0);A=u;u=0}a=0;if(n|0){s[n>>2]=e;s[n+4>>2]=t}p=(o|0)>>>31|(A|a)<<1|(a<<1|o>>>31)&0|u;f=(o<<1|0>>>31)&-2|l;return(w(p|0),f)|0}function og(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;return sg(e,t,i,r,0)|0}function ag(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)<32){w(t>>>i|0);return e>>>i|(t&(1<<i)-1)<<32-i}w(0);return t>>>i-32|0}function lg(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)<32){w(t<<i|(e&(1<<i)-1<<32-i)>>>32-i|0);return e<<i}w(e<<i-32|0);return 0}function ug(){return 22176}function Ag(e){e=e|0;return(e&255)<<24|(e>>8&255)<<16|(e>>16&255)<<8|e>>>24|0}function cg(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0;if((i|0)>=512){X(e|0,t|0,i|0)|0;return e|0}a=e|0;o=e+i|0;if((e&3)==(t&3)){while(e&3){if(!i)return a|0;r[e>>0]=r[t>>0]|0;e=e+1|0;t=t+1|0;i=i-1|0}i=o&-4|0;n=i-64|0;while((e|0)<=(n|0)){s[e>>2]=s[t>>2];s[e+4>>2]=s[t+4>>2];s[e+8>>2]=s[t+8>>2];s[e+12>>2]=s[t+12>>2];s[e+16>>2]=s[t+16>>2];s[e+20>>2]=s[t+20>>2];s[e+24>>2]=s[t+24>>2];s[e+28>>2]=s[t+28>>2];s[e+32>>2]=s[t+32>>2];s[e+36>>2]=s[t+36>>2];s[e+40>>2]=s[t+40>>2];s[e+44>>2]=s[t+44>>2];s[e+48>>2]=s[t+48>>2];s[e+52>>2]=s[t+52>>2];s[e+56>>2]=s[t+56>>2];s[e+60>>2]=s[t+60>>2];e=e+64|0;t=t+64|0}while((e|0)<(i|0)){s[e>>2]=s[t>>2];e=e+4|0;t=t+4|0}}else{i=o-4|0;while((e|0)<(i|0)){r[e>>0]=r[t>>0]|0;r[e+1>>0]=r[t+1>>0]|0;r[e+2>>0]=r[t+2>>0]|0;r[e+3>>0]=r[t+3>>0]|0;e=e+4|0;t=t+4|0}}while((e|0)<(o|0)){r[e>>0]=r[t>>0]|0;e=e+1|0;t=t+1|0}return a|0}function hg(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;if((t|0)<(e|0)&(e|0)<(t+i|0)){n=e;t=t+i|0;e=e+i|0;while((i|0)>0){e=e-1|0;t=t-1|0;i=i-1|0;r[e>>0]=r[t>>0]|0}e=n}else cg(e,t,i)|0;return e|0}function dg(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,o=0,a=0,l=0;a=e+i|0;t=t&255;if((i|0)>=67){while(e&3){r[e>>0]=t;e=e+1|0}n=a&-4|0;l=t|t<<8|t<<16|t<<24;o=n-64|0;while((e|0)<=(o|0)){s[e>>2]=l;s[e+4>>2]=l;s[e+8>>2]=l;s[e+12>>2]=l;s[e+16>>2]=l;s[e+20>>2]=l;s[e+24>>2]=l;s[e+28>>2]=l;s[e+32>>2]=l;s[e+36>>2]=l;s[e+40>>2]=l;s[e+44>>2]=l;s[e+48>>2]=l;s[e+52>>2]=l;s[e+56>>2]=l;s[e+60>>2]=l;e=e+64|0}while((e|0)<(n|0)){s[e>>2]=l;e=e+4|0}}while((e|0)<(a|0)){r[e>>0]=t;e=e+1|0}return a-i|0}function pg(e){e=e|0;return Og[e&3]()|0}function fg(e,t){e=e|0;t=t|0;return Ng[e&15](t|0)|0}function vg(e,t,i,r,n,s,o){e=e|0;t=t|0;i=+i;r=r|0;n=n|0;s=s|0;o=o|0;return Vg[e&1](t|0,+i,r|0,n|0,s|0,o|0)|0}function gg(e,t,i){e=e|0;t=t|0;i=i|0;return Qg[e&63](t|0,i|0)|0}function mg(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;return Hg[e&7](t|0,i|0,r|0)|0}function _g(e){e=e|0;Gg[e&3]()}function yg(e,t){e=e|0;t=t|0;jg[e&255](t|0)}function bg(e,t,i){e=e|0;t=t|0;i=i|0;zg[e&15](t|0,i|0)}function wg(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;Wg[e&15](t|0,i|0,r|0)}function Bg(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;Xg[e&7](t|0,i|0,r|0,n|0)}function xg(e,t,i,r,n,s){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;s=s|0;Kg[e&3](t|0,i|0,r|0,n|0,s|0)}function Pg(e,t,i,r,n,s,o){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;s=s|0;o=o|0;Zg[e&3](t|0,i|0,r|0,n|0,s|0,o|0)}function Cg(){b(0);return 0}function Mg(e){e=e|0;b(1);return 0}function Fg(e,t,i,r,n,s){e=e|0;t=+t;i=i|0;r=r|0;n=n|0;s=s|0;b(2);return 0}function kg(e,t){e=e|0;t=t|0;b(3);return 0}function Eg(e,t,i){e=e|0;t=t|0;i=i|0;b(4);return 0}function Ig(){b(5)}function Tg(e){e=e|0;b(6)}function Dg(e,t){e=e|0;t=t|0;b(7)}function Sg(e,t,i){e=e|0;t=t|0;i=i|0;b(8)}function Rg(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;b(9)}function Ug(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;b(10)}function Lg(e,t,i,r,n,s){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;s=s|0;b(11)}var Og=[Cg,EA,Bc,Cg];var Ng=[Mg,gf,vt,wt,af,Af,sv,Mv,Uv,pA,ne,cc,TA,Pc,Mg,Mg];var Vg=[Fg,sp];var Qg=[kg,me,Me,bt,er,Er,Vr,en,tn,sn,jn,Yn,fs,ws,Is,Os,Po,So,Go,Ko,ra,la,ga,wa,Ia,ja,Ya,il,Al,_l,Ul,Gl,Yl,ou,vu,Bu,Du,Hu,Ju,rA,cA,rc,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg,kg];var Hg=[Eg,xp,Vp,wf,xf,kv,Ev,Eg];var Gg=[Ig,yf,Ip,Ig];var jg=[Tg,ov,ve,ge,_e,Pe,Ce,Fe,ff,st,Bt,ft,mt,_t,Ft,kt,Vt,Qt,ui,Ai,ci,Ei,qi,$i,tr,Cr,Ir,Tr,Dr,Sr,Or,Nr,Qr,qr,$r,rn,nn,Hn,Gn,zn,Zn,Jn,ds,ps,vs,ys,bs,ks,Es,Ts,Us,Ls,Bo,xo,Co,Ro,Uo,Qo,Ho,jo,Zo,Jo,ta,ia,na,ua,Aa,fa,va,ma,Ba,xa,ka,Ea,Ta,Ha,Ga,za,Za,Ja,qa,rl,nl,ll,ul,cl,gl,ml,Sl,Rl,Ll,Ql,Hl,Zl,Jl,ql,nu,su,pu,fu,gu,bu,wu,Iu,Tu,Su,Vu,Qu,Ku,Zu,Yu,tA,iA,uA,AA,hA,Up,Lp,Op,Np,Zp,sf,of,lf,uf,vf,mf,_f,bf,Bf,Ff,rv,nv,Pv,Cv,Rv,Qv,Hv,gA,pc,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg,Tg];var zg=[Dg,gt,yt,re,oe,ae,le,ue,op,Dg,Dg,Dg,Dg,Dg,Dg,Dg];var Wg=[Sg,Fv,Iv,Lv,Ov,ie,se,ZA,Nc,zc,Sg,Sg,Sg,Sg,Sg,Sg];var Xg=[Rg,Gp,qp,If,NA,Tc,Rg,Rg];var Kg=[Ug,Hp,Yp,Ef];var Zg=[Lg,Qp,Jp,kf];return{__ZSt18uncaught_exceptionv:tv,___cxa_can_catch:qf,___cxa_is_pointer_type:$f,___embind_register_native_and_builtin_types:eh,___errno_location:zd,___getTypeName:jd,___muldi3:tg,___udivdi3:og,_bitshift64Lshr:ag,_bitshift64Shl:lg,_emscripten_get_sbrk_ptr:ug,_free:Zv,_i64Add:ig,_i64Subtract:rg,_llvm_bswap_i32:Ag,_malloc:Kv,_memcpy:cg,_memmove:hg,_memset:dg,dynCall_i:pg,dynCall_ii:fg,dynCall_iidiiii:vg,dynCall_iii:gg,dynCall_iiii:mg,dynCall_v:_g,dynCall_vi:yg,dynCall_vii:bg,dynCall_viii:wg,dynCall_viiii:Bg,dynCall_viiiii:xg,dynCall_viiiiii:Pg,globalCtors:$,stackAlloc:Yv,stackRestore:qv,stackSave:$v}}({Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Float32Array:Float32Array,Float64Array:Float64Array},pt,b),vt=t.__ZSt18uncaught_exceptionv=ft.__ZSt18uncaught_exceptionv;t.___cxa_can_catch=ft.___cxa_can_catch,t.___cxa_is_pointer_type=ft.___cxa_is_pointer_type,t.___embind_register_native_and_builtin_types=ft.___embind_register_native_and_builtin_types,t.___errno_location=ft.___errno_location;var gt=t.___getTypeName=ft.___getTypeName;t.___muldi3=ft.___muldi3,t.___udivdi3=ft.___udivdi3,t._bitshift64Lshr=ft._bitshift64Lshr,t._bitshift64Shl=ft._bitshift64Shl,t._emscripten_get_sbrk_ptr=ft._emscripten_get_sbrk_ptr;var mt=t._free=ft._free;t._i64Add=ft._i64Add,t._i64Subtract=ft._i64Subtract,t._llvm_bswap_i32=ft._llvm_bswap_i32;var _t=t._malloc=ft._malloc;t._memcpy=ft._memcpy,t._memmove=ft._memmove,t._memset=ft._memset;var yt,bt,wt=t.globalCtors=ft.globalCtors;if(t.stackAlloc=ft.stackAlloc,t.stackRestore=ft.stackRestore,t.stackSave=ft.stackSave,t.dynCall_i=ft.dynCall_i,t.dynCall_ii=ft.dynCall_ii,t.dynCall_iidiiii=ft.dynCall_iidiiii,t.dynCall_iii=ft.dynCall_iii,t.dynCall_iiii=ft.dynCall_iiii,t.dynCall_v=ft.dynCall_v,t.dynCall_vi=ft.dynCall_vi,t.dynCall_vii=ft.dynCall_vii,t.dynCall_viii=ft.dynCall_viii,t.dynCall_viiii=ft.dynCall_viiii,t.dynCall_viiiii=ft.dynCall_viiiii,t.dynCall_viiiiii=ft.dynCall_viiiiii,t.asm=ft,K)if(J(K)||(yt=K,K=t.locateFile?t.locateFile(yt,h):h+yt),s||o){var Bt=u(K);B.set(Bt,8)}else{z++,t.monitorRunDependencies&&t.monitorRunDependencies(z);var xt=function(e){e.byteLength&&(e=new Uint8Array(e)),B.set(e,8),t.memoryInitializerRequest&&delete t.memoryInitializerRequest.response,function(e){if(z--,t.monitorRunDependencies&&t.monitorRunDependencies(z),0==z&&W){var i=W;W=null,i()}}()},Pt=function(){l(K,xt,(function(){throw new Error("could not load memory initializer "+K)}))},Ct=dt(K);if(Ct)xt(Ct.buffer);else if(t.memoryInitializerRequest){var Mt=function(){var e=t.memoryInitializerRequest,i=e.response;if(200!==e.status&&0!==e.status){var r=dt(t.memoryInitializerRequestURL);if(!r)return console.warn("a problem seems to have happened with Module.memoryInitializerRequest, status: "+e.status+", retrying "+K),void Pt();i=r.buffer}xt(i)};t.memoryInitializerRequest.response?setTimeout(Mt,0):t.memoryInitializerRequest.addEventListener("load",Mt)}else Pt()}function Ft(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function kt(e){function i(){bt||(bt=!0,t.calledRun=!0,g||(V(H),V(G),t.onRuntimeInitialized&&t.onRuntimeInitialized(),function(){if(t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;)e=t.postRun.shift(),j.unshift(e);var e;V(j)}()))}z>0||(!function(){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)e=t.preRun.shift(),Q.unshift(e);var e;V(Q)}(),z>0||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),i()}),1)):i()))}if(W=function e(){bt||kt(),bt||(W=e)},t.run=kt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);t.preInit.length>0;)t.preInit.pop()();return kt(),t}var xw=null,Pw={0:function(e){return{position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15)}},1:function(e){return{position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15)}},2:function(e){return{position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15),color:[e.getUint16(20,!0),e.getUint16(22,!0),e.getUint16(24,!0)]}},3:function(e){return{position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15),color:[e.getUint16(28,!0),e.getUint16(30,!0),e.getUint16(32,!0)]}}};function Cw(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;r=void 0===r||0===r?1:r;var n=e.slice(i,i+t.BYTES_PER_ELEMENT*r),s=new t(n);if(1===r)return s[0];for(var o=[],a=0;a<r;a++)o.push(s[a]);return o}function Mw(e){var t=131,i={pointsOffset:Cw(e,Uint32Array,96),pointsFormatId:Cw(e,Uint8Array,104),pointsStructSize:Cw(e,Uint16Array,105),pointsCount:Cw(e,Uint32Array,107),scale:Cw(e,Float64Array,t,3)};t+=24,i.offset=Cw(e,Float64Array,t,3),t+=24;var r=Cw(e,Float64Array,t,6);return t+=48,i.maxs=[r[0],r[2],r[4]],i.mins=[r[1],r[3],r[5]],i}var Fw=function(){function e(t){k(this,e),d(this,"arraybuffer",void 0),d(this,"readOffset",0),d(this,"header",{pointsOffset:0,pointsFormatId:0,pointsStructSize:0,pointsCount:0,scale:[0,0,0],offset:[0,0,0],maxs:[0],mins:[0],totalToRead:0,totalRead:0,versionAsString:"",isCompressed:!0}),this.arraybuffer=t}return I(e,[{key:"open",value:function(){return!0}},{key:"getHeader",value:function(){return this.header=Mw(this.arraybuffer),this.header}},{key:"readData",value:function(e,t){var i=this.header,r=this.arraybuffer;if(!i)throw new Error("Cannot start reading data till a header request is issued");var n,s=this.readOffset;if(t<=1){e=Math.min(e,i.pointsCount-s);var o=(n=i.pointsOffset+s*i.pointsStructSize)+e*i.pointsStructSize;return s+=e,this.readOffset=s,{buffer:r.slice(n,o),count:e,hasMoreData:s<i.pointsCount}}for(var a=Math.min(e*t,i.pointsCount-s),l=Math.ceil(a/t),u=0,A=new Uint8Array(l*i.pointsStructSize),c=0;c<a;c++){if(c%t==0){n=i.pointsOffset+s*i.pointsStructSize;var h=new Uint8Array(r,n,i.pointsStructSize);A.set(h,u*i.pointsStructSize),u++}s++}return this.readOffset=s,{buffer:A.buffer,count:u,hasMoreData:s<i.pointsCount}}},{key:"close",value:function(){return this.arraybuffer=null,!0}}]),e}(),kw=function(){function e(t){k(this,e),d(this,"arraybuffer",void 0),d(this,"instance",null),d(this,"header",null),this.arraybuffer=t,xw||(xw=Bw())}return I(e,[{key:"open",value:function(){try{var e=this.arraybuffer;this.instance=new xw.LASZip;var t=new Uint8Array(e),i=xw._malloc(e.byteLength);return this.instance.arraybuffer=e,this.instance.buf=i,xw.HEAPU8.set(t,i),this.instance.open(i,e.byteLength),this.instance.readOffset=0,!0}catch(e){throw new Error("Failed to open file: ".concat(e.message))}}},{key:"getHeader",value:function(){if(!this.instance)throw new Error("You need to open the file before trying to read header");try{var e=Mw(this.instance.arraybuffer);return e.pointsFormatId&=63,this.header=e,e}catch(e){throw new Error("Failed to get header: ".concat(e.message))}}},{key:"readData",value:function(e,t,i){if(!this.instance)throw new Error("You need to open the file before trying to read stuff");var r=this.header,n=this.instance;if(!r)throw new Error("You need to query header before reading, I maintain state that way, sorry :(");try{for(var s=Math.min(e*i,r.pointsCount-n.readOffset),o=Math.ceil(s/i),a=0,l=new Uint8Array(o*r.pointsStructSize),u=xw._malloc(r.pointsStructSize),A=0;A<s;A++){if(n.getPoint(u),A%i==0){var c=new Uint8Array(xw.HEAPU8.buffer,u,r.pointsStructSize);l.set(c,a*r.pointsStructSize),a++}n.readOffset++}return xw._free(u),{buffer:l.buffer,count:a,hasMoreData:n.readOffset<r.pointsCount}}catch(e){throw new Error("Failed to read data: ".concat(e.message))}}},{key:"close",value:function(){try{return null!==this.instance&&(xw._free(this.instance.buf),this.instance.delete(),this.instance=null),!0}catch(e){throw new Error("Failed to close file: ".concat(e.message))}}}]),e}(),Ew=function(){function e(t,i,r){k(this,e),d(this,"arrayb",void 0),d(this,"decoder",void 0),d(this,"pointsCount",void 0),d(this,"pointSize",void 0),d(this,"scale",void 0),d(this,"offset",void 0),d(this,"mins",void 0),d(this,"maxs",void 0),this.arrayb=t,this.decoder=Pw[r.pointsFormatId],this.pointsCount=i,this.pointSize=r.pointsStructSize,this.scale=r.scale,this.offset=r.offset,this.mins=r.mins,this.maxs=r.maxs}return I(e,[{key:"getPoint",value:function(e){if(e<0||e>=this.pointsCount)throw new Error("Point index out of range");var t=new DataView(this.arrayb,e*this.pointSize,this.pointSize);return this.decoder(t)}}]),e}(),Iw=function(){function e(t){if(k(this,e),d(this,"arraybuffer",void 0),d(this,"formatId",0),d(this,"loader",void 0),d(this,"isCompressed",!0),d(this,"isOpen",!1),d(this,"version",0),d(this,"versionAsString",""),this.arraybuffer=t,this.determineVersion()>13)throw new Error("Only file versions <= 1.3 are supported at this time");if(this.determineFormat(),void 0===Pw[this.formatId])throw new Error("The point format ID is not supported");this.loader=this.isCompressed?new kw(this.arraybuffer):new Fw(this.arraybuffer)}return I(e,[{key:"determineFormat",value:function(){var e=Cw(this.arraybuffer,Uint8Array,104),t=(128&e)>>7,i=(64&e)>>6;if(1===t&&1===i)throw new Error("Old style compression not supported");this.formatId=63&e,this.isCompressed=1===t||1===i}},{key:"determineVersion",value:function(){var e=new Int8Array(this.arraybuffer,24,2);return this.version=10*e[0]+e[1],this.versionAsString="".concat(e[0],".").concat(e[1]),this.version}},{key:"open",value:function(){this.loader.open()&&(this.isOpen=!0)}},{key:"getHeader",value:function(){return this.loader.getHeader()}},{key:"readData",value:function(e,t,i){return this.loader.readData(e,t,i)}},{key:"close",value:function(){this.loader.close()&&(this.isOpen=!1)}},{key:"getUnpacker",value:function(){return Ew}}]),e}();function Tw(e,t){var i=function(e){var t={};t.las_pointsOffset=e.pointsOffset.toString(10),t.las_pointsFormatId=e.pointsFormatId.toString(10),t.las_pointsStructSize=e.pointsStructSize.toString(10),t.las_pointsCount=e.pointsCount.toString(10),t.las_scale=JSON.stringify(e.scale),t.las_offset=JSON.stringify(e.offset),void 0!==e.maxs&&(t.las_maxs=JSON.stringify(e.maxs));void 0!==e.mins&&(t.las_mins=JSON.stringify(e.mins));t.las_totalToRead=e.totalToRead.toString(10),t.las_pointsFortotalReadmatId=e.totalRead.toString(10),void 0!==e.versionAsString&&(t.las_versionAsString=e.versionAsString);void 0!==e.isCompressed&&(t.las_isCompressed=e.isCompressed.toString());return t}(e),r=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{fields:Og(e),metadata:t}}(t,i);return r}function Dw(e,t){return function(e){var t,i,r,n,s,o,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=0,u={loader:"las",loaderData:{},schema:{fields:[],metadata:{}},header:{vertexCount:0,boundingBox:[[0,0,0],[0,0,0]]},attributes:{},topology:"point-list",mode:0};Sw(e,null===(t=a.las)||void 0===t?void 0:t.skip,(function(){var e,t,A=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=arguments.length>1?arguments[1]:void 0;if(!o){var d;o=c;var p=c.totalToRead,f=null!==(d=a.las)&&void 0!==d&&d.fp64?Float64Array:Float32Array;i=new f(3*p),r=c.pointsFormatId>=2?new Uint8Array(4*p):null,n=new Uint16Array(p),s=new Uint8Array(p),u.loaderData=c,u.attributes={POSITION:{value:i,size:3},intensity:{value:n,size:1},classification:{value:s,size:1}},r&&(u.attributes.COLOR_0={value:r,size:4})}for(var v=A.pointsCount,g=C(c.scale,3),m=g[0],_=g[1],y=g[2],b=C(c.offset,3),w=b[0],B=b[1],x=b[2],P=Rw(A,v,null===(e=a.las)||void 0===e?void 0:e.colorDepth),M=0;M<v;M++){var F=A.getPoint(M),k=F.position,E=F.color,I=F.intensity,T=F.classification;i[3*l]=k[0]*m+w,i[3*l+1]=k[1]*_+B,i[3*l+2]=k[2]*y+x,E&&r&&(P?(r[4*l]=E[0]/256,r[4*l+1]=E[1]/256,r[4*l+2]=E[2]/256):(r[4*l]=E[0],r[4*l+1]=E[1],r[4*l+2]=E[2]),r[4*l+3]=255),n[l]=I,s[l]=T,l++}var D=h(h({},u),{},{header:{vertexCount:c.totalRead},progress:c.totalRead/c.totalToRead});null==a||null===(t=a.onProgress)||void 0===t||t.call(a,D)})),u.header={vertexCount:o.totalToRead,boundingBox:Ug((null==u?void 0:u.attributes)||{})},u&&(u.schema=Tw(u.loaderData,u.attributes));return u}(e,t)}function Sw(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new Iw(e);try{r.open();var n=r.getHeader(),s=r.getUnpacker(),o=Math.ceil(n.pointsCount/Math.max(1,t));n.totalToRead=o;for(var a=0;;){var l=r.readData(1e5,0,t);a+=l.count,n.totalRead=a,n.versionAsString=l.versionAsString,n.isCompressed=l.isCompressed;var u=new s(l.buffer,l.count,n);if(i(u,n),!l.hasMoreData||a>=o)break}}catch(e){throw e}finally{r.close()}}function Rw(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=!1;switch(i){case 8:r=!1;break;case 16:r=!0;break;case"auto":if(e.getPoint(0).color)for(var n=0;n<t;n++){var s=e.getPoint(n),o=s.color;(o[0]>255||o[1]>255||o[2]>255)&&(r=!0)}break;default:console.warn("las: illegal value for options.las.colorDepth")}return r}var Uw,Lw=h(h({},ww),{},{parse:(Uw=A(l().mark((function e(t,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Dw(t,i));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return Uw.apply(this,arguments)}),parseSync:function(e,t){return Dw(e,t)}}),Ow=function(e,t){return Ow=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},Ow(e,t)};
/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 */
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function Nw(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}Ow(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var Vw=function(){return Vw=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},Vw.apply(this,arguments)};function Qw(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function a(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((r=r.apply(e,t||[])).next())}))}function Hw(e,t){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(n=2&s[0]?r.return:s[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,s[1])).done)return n;switch(r=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function Gw(e,t,i){if(i||2===arguments.length)for(var r,n=0,s=t.length;n<s;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||t)}for(var jw=function(){function e(e,t,i,r){this.left=e,this.top=t,this.width=i,this.height=r}return e.prototype.add=function(t,i,r,n){return new e(this.left+t,this.top+i,this.width+r,this.height+n)},e.fromClientRect=function(t,i){return new e(i.left+t.windowBounds.left,i.top+t.windowBounds.top,i.width,i.height)},e.fromDOMRectList=function(t,i){var r=Array.from(i).find((function(e){return 0!==e.width}));return r?new e(r.left+t.windowBounds.left,r.top+t.windowBounds.top,r.width,r.height):e.EMPTY},e.EMPTY=new e(0,0,0,0),e}(),zw=function(e,t){return jw.fromClientRect(e,t.getBoundingClientRect())},Ww=function(e){for(var t=[],i=0,r=e.length;i<r;){var n=e.charCodeAt(i++);if(n>=55296&&n<=56319&&i<r){var s=e.charCodeAt(i++);56320==(64512&s)?t.push(((1023&n)<<10)+(1023&s)+65536):(t.push(n),i--)}else t.push(n)}return t},Xw=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,e);var i=e.length;if(!i)return"";for(var r=[],n=-1,s="";++n<i;){var o=e[n];o<=65535?r.push(o):(o-=65536,r.push(55296+(o>>10),o%1024+56320)),(n+1===i||r.length>16384)&&(s+=String.fromCharCode.apply(String,r),r.length=0)}return s},Kw="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Zw="undefined"==typeof Uint8Array?[]:new Uint8Array(256),Jw=0;Jw<Kw.length;Jw++)Zw[Kw.charCodeAt(Jw)]=Jw;for(var Yw="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",qw="undefined"==typeof Uint8Array?[]:new Uint8Array(256),$w=0;$w<Yw.length;$w++)qw[Yw.charCodeAt($w)]=$w;for(var eB=function(e,t,i){return e.slice?e.slice(t,i):new Uint16Array(Array.prototype.slice.call(e,t,i))},tB=function(){function e(e,t,i,r,n,s){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=r,this.index=n,this.data=s}return e.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=((t=this.index[e>>5])<<2)+(31&e),this.data[t];if(e<=65535)return t=((t=this.index[2048+(e-55296>>5)])<<2)+(31&e),this.data[t];if(e<this.highStart)return t=2080+(e>>11),t=this.index[t],t+=e>>5&63,t=((t=this.index[t])<<2)+(31&e),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},e}(),iB="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",rB="undefined"==typeof Uint8Array?[]:new Uint8Array(256),nB=0;nB<iB.length;nB++)rB[iB.charCodeAt(nB)]=nB;var sB=10,oB=13,aB=15,lB=17,uB=18,AB=19,cB=20,hB=21,dB=22,pB=24,fB=25,vB=26,gB=27,mB=28,_B=30,yB=32,bB=33,wB=34,BB=35,xB=37,PB=38,CB=39,MB=40,FB=42,kB=[9001,65288],EB=function(e,t){var i,r,n,s=function(e){var t,i,r,n,s,o=.75*e.length,a=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var u="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&void 0!==Uint8Array.prototype.slice?new ArrayBuffer(o):new Array(o),A=Array.isArray(u)?u:new Uint8Array(u);for(t=0;t<a;t+=4)i=qw[e.charCodeAt(t)],r=qw[e.charCodeAt(t+1)],n=qw[e.charCodeAt(t+2)],s=qw[e.charCodeAt(t+3)],A[l++]=i<<2|r>>4,A[l++]=(15&r)<<4|n>>2,A[l++]=(3&n)<<6|63&s;return u}(e),o=Array.isArray(s)?function(e){for(var t=e.length,i=[],r=0;r<t;r+=4)i.push(e[r+3]<<24|e[r+2]<<16|e[r+1]<<8|e[r]);return i}(s):new Uint32Array(s),a=Array.isArray(s)?function(e){for(var t=e.length,i=[],r=0;r<t;r+=2)i.push(e[r+1]<<8|e[r]);return i}(s):new Uint16Array(s),l=eB(a,12,o[4]/2),u=2===o[5]?eB(a,(24+o[4])/2):(i=o,r=Math.ceil((24+o[4])/4),i.slice?i.slice(r,n):new Uint32Array(Array.prototype.slice.call(i,r,n)));return new tB(o[0],o[1],o[2],o[3],l,u)}("KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA=="),IB=[_B,36],TB=[1,2,3,5],DB=[sB,8],SB=[gB,vB],RB=TB.concat(DB),UB=[PB,CB,MB,wB,BB],LB=[aB,oB],OB=function(e,t,i,r){var n=r[i];if(Array.isArray(e)?-1!==e.indexOf(n):e===n)for(var s=i;s<=r.length;){if((l=r[++s])===t)return!0;if(l!==sB)break}if(n===sB)for(s=i;s>0;){var o=r[--s];if(Array.isArray(e)?-1!==e.indexOf(o):e===o)for(var a=i;a<=r.length;){var l;if((l=r[++a])===t)return!0;if(l!==sB)break}if(o!==sB)break}return!1},NB=function(e,t){for(var i=e;i>=0;){var r=t[i];if(r!==sB)return r;i--}return 0},VB=function(e,t,i,r,n){if(0===i[r])return"×";var s=r-1;if(Array.isArray(n)&&!0===n[s])return"×";var o=s-1,a=s+1,l=t[s],u=o>=0?t[o]:0,A=t[a];if(2===l&&3===A)return"×";if(-1!==TB.indexOf(l))return"!";if(-1!==TB.indexOf(A))return"×";if(-1!==DB.indexOf(A))return"×";if(8===NB(s,t))return"÷";if(11===EB.get(e[s]))return"×";if((l===yB||l===bB)&&11===EB.get(e[a]))return"×";if(7===l||7===A)return"×";if(9===l)return"×";if(-1===[sB,oB,aB].indexOf(l)&&9===A)return"×";if(-1!==[lB,uB,AB,pB,mB].indexOf(A))return"×";if(NB(s,t)===dB)return"×";if(OB(23,dB,s,t))return"×";if(OB([lB,uB],hB,s,t))return"×";if(OB(12,12,s,t))return"×";if(l===sB)return"÷";if(23===l||23===A)return"×";if(16===A||16===l)return"÷";if(-1!==[oB,aB,hB].indexOf(A)||14===l)return"×";if(36===u&&-1!==LB.indexOf(l))return"×";if(l===mB&&36===A)return"×";if(A===cB)return"×";if(-1!==IB.indexOf(A)&&l===fB||-1!==IB.indexOf(l)&&A===fB)return"×";if(l===gB&&-1!==[xB,yB,bB].indexOf(A)||-1!==[xB,yB,bB].indexOf(l)&&A===vB)return"×";if(-1!==IB.indexOf(l)&&-1!==SB.indexOf(A)||-1!==SB.indexOf(l)&&-1!==IB.indexOf(A))return"×";if(-1!==[gB,vB].indexOf(l)&&(A===fB||-1!==[dB,aB].indexOf(A)&&t[a+1]===fB)||-1!==[dB,aB].indexOf(l)&&A===fB||l===fB&&-1!==[fB,mB,pB].indexOf(A))return"×";if(-1!==[fB,mB,pB,lB,uB].indexOf(A))for(var c=s;c>=0;){if((h=t[c])===fB)return"×";if(-1===[mB,pB].indexOf(h))break;c--}if(-1!==[gB,vB].indexOf(A))for(c=-1!==[lB,uB].indexOf(l)?o:s;c>=0;){var h;if((h=t[c])===fB)return"×";if(-1===[mB,pB].indexOf(h))break;c--}if(PB===l&&-1!==[PB,CB,wB,BB].indexOf(A)||-1!==[CB,wB].indexOf(l)&&-1!==[CB,MB].indexOf(A)||-1!==[MB,BB].indexOf(l)&&A===MB)return"×";if(-1!==UB.indexOf(l)&&-1!==[cB,vB].indexOf(A)||-1!==UB.indexOf(A)&&l===gB)return"×";if(-1!==IB.indexOf(l)&&-1!==IB.indexOf(A))return"×";if(l===pB&&-1!==IB.indexOf(A))return"×";if(-1!==IB.concat(fB).indexOf(l)&&A===dB&&-1===kB.indexOf(e[a])||-1!==IB.concat(fB).indexOf(A)&&l===uB)return"×";if(41===l&&41===A){for(var d=i[s],p=1;d>0&&41===t[--d];)p++;if(p%2!=0)return"×"}return l===yB&&A===bB?"×":"÷"},QB=function(e,t){t||(t={lineBreak:"normal",wordBreak:"normal"});var i=function(e,t){void 0===t&&(t="strict");var i=[],r=[],n=[];return e.forEach((function(e,s){var o=EB.get(e);if(o>50?(n.push(!0),o-=50):n.push(!1),-1!==["normal","auto","loose"].indexOf(t)&&-1!==[8208,8211,12316,12448].indexOf(e))return r.push(s),i.push(16);if(4===o||11===o){if(0===s)return r.push(s),i.push(_B);var a=i[s-1];return-1===RB.indexOf(a)?(r.push(r[s-1]),i.push(a)):(r.push(s),i.push(_B))}return r.push(s),31===o?i.push("strict"===t?hB:xB):o===FB||29===o?i.push(_B):43===o?e>=131072&&e<=196605||e>=196608&&e<=262141?i.push(xB):i.push(_B):void i.push(o)})),[r,i,n]}(e,t.lineBreak),r=i[0],n=i[1],s=i[2];"break-all"!==t.wordBreak&&"break-word"!==t.wordBreak||(n=n.map((function(e){return-1!==[fB,_B,FB].indexOf(e)?xB:e})));var o="keep-all"===t.wordBreak?s.map((function(t,i){return t&&e[i]>=19968&&e[i]<=40959})):void 0;return[r,n,o]},HB=function(){function e(e,t,i,r){this.codePoints=e,this.required="!"===t,this.start=i,this.end=r}return e.prototype.slice=function(){return Xw.apply(void 0,this.codePoints.slice(this.start,this.end))},e}(),GB=function(e){return e>=48&&e<=57},jB=function(e){return GB(e)||e>=65&&e<=70||e>=97&&e<=102},zB=function(e){return 10===e||9===e||32===e},WB=function(e){return function(e){return function(e){return e>=97&&e<=122}(e)||function(e){return e>=65&&e<=90}(e)}(e)||function(e){return e>=128}(e)||95===e},XB=function(e){return WB(e)||GB(e)||45===e},KB=function(e){return e>=0&&e<=8||11===e||e>=14&&e<=31||127===e},ZB=function(e,t){return 92===e&&10!==t},JB=function(e,t,i){return 45===e?WB(t)||ZB(t,i):!!WB(e)||!(92!==e||!ZB(e,t))},YB=function(e,t,i){return 43===e||45===e?!!GB(t)||46===t&&GB(i):GB(46===e?t:e)},qB=function(e){var t=0,i=1;43!==e[t]&&45!==e[t]||(45===e[t]&&(i=-1),t++);for(var r=[];GB(e[t]);)r.push(e[t++]);var n=r.length?parseInt(Xw.apply(void 0,r),10):0;46===e[t]&&t++;for(var s=[];GB(e[t]);)s.push(e[t++]);var o=s.length,a=o?parseInt(Xw.apply(void 0,s),10):0;69!==e[t]&&101!==e[t]||t++;var l=1;43!==e[t]&&45!==e[t]||(45===e[t]&&(l=-1),t++);for(var u=[];GB(e[t]);)u.push(e[t++]);var A=u.length?parseInt(Xw.apply(void 0,u),10):0;return i*(n+a*Math.pow(10,-o))*Math.pow(10,l*A)},$B={type:2},ex={type:3},tx={type:4},ix={type:13},rx={type:8},nx={type:21},sx={type:9},ox={type:10},ax={type:11},lx={type:12},ux={type:14},Ax={type:23},cx={type:1},hx={type:25},dx={type:24},px={type:26},fx={type:27},vx={type:28},gx={type:29},mx={type:31},_x={type:32},yx=function(){function e(){this._value=[]}return e.prototype.write=function(e){this._value=this._value.concat(Ww(e))},e.prototype.read=function(){for(var e=[],t=this.consumeToken();t!==_x;)e.push(t),t=this.consumeToken();return e},e.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case 34:return this.consumeStringToken(34);case 35:var t=this.peekCodePoint(0),i=this.peekCodePoint(1),r=this.peekCodePoint(2);if(XB(t)||ZB(i,r)){var n=JB(t,i,r)?2:1;return{type:5,value:this.consumeName(),flags:n}}break;case 36:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),ix;break;case 39:return this.consumeStringToken(39);case 40:return $B;case 41:return ex;case 42:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),ux;break;case 43:if(YB(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case 44:return tx;case 45:var s=e,o=this.peekCodePoint(0),a=this.peekCodePoint(1);if(YB(s,o,a))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(JB(s,o,a))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(45===o&&62===a)return this.consumeCodePoint(),this.consumeCodePoint(),dx;break;case 46:if(YB(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case 47:if(42===this.peekCodePoint(0))for(this.consumeCodePoint();;){var l=this.consumeCodePoint();if(42===l&&47===(l=this.consumeCodePoint()))return this.consumeToken();if(-1===l)return this.consumeToken()}break;case 58:return px;case 59:return fx;case 60:if(33===this.peekCodePoint(0)&&45===this.peekCodePoint(1)&&45===this.peekCodePoint(2))return this.consumeCodePoint(),this.consumeCodePoint(),hx;break;case 64:var u=this.peekCodePoint(0),A=this.peekCodePoint(1),c=this.peekCodePoint(2);if(JB(u,A,c))return{type:7,value:this.consumeName()};break;case 91:return vx;case 92:if(ZB(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case 93:return gx;case 61:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),rx;break;case 123:return ax;case 125:return lx;case 117:case 85:var h=this.peekCodePoint(0),d=this.peekCodePoint(1);return 43!==h||!jB(d)&&63!==d||(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case 124:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),sx;if(124===this.peekCodePoint(0))return this.consumeCodePoint(),nx;break;case 126:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),ox;break;case-1:return _x}return zB(e)?(this.consumeWhiteSpace(),mx):GB(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):WB(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Xw(e)}},e.prototype.consumeCodePoint=function(){var e=this._value.shift();return void 0===e?-1:e},e.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},e.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},e.prototype.consumeUnicodeRangeToken=function(){for(var e=[],t=this.consumeCodePoint();jB(t)&&e.length<6;)e.push(t),t=this.consumeCodePoint();for(var i=!1;63===t&&e.length<6;)e.push(t),t=this.consumeCodePoint(),i=!0;if(i)return{type:30,start:parseInt(Xw.apply(void 0,e.map((function(e){return 63===e?48:e}))),16),end:parseInt(Xw.apply(void 0,e.map((function(e){return 63===e?70:e}))),16)};var r=parseInt(Xw.apply(void 0,e),16);if(45===this.peekCodePoint(0)&&jB(this.peekCodePoint(1))){this.consumeCodePoint(),t=this.consumeCodePoint();for(var n=[];jB(t)&&n.length<6;)n.push(t),t=this.consumeCodePoint();return{type:30,start:r,end:parseInt(Xw.apply(void 0,n),16)}}return{type:30,start:r,end:r}},e.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return"url"===e.toLowerCase()&&40===this.peekCodePoint(0)?(this.consumeCodePoint(),this.consumeUrlToken()):40===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},e.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),-1===this.peekCodePoint(0))return{type:22,value:""};var t=this.peekCodePoint(0);if(39===t||34===t){var i=this.consumeStringToken(this.consumeCodePoint());return 0===i.type&&(this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0))?(this.consumeCodePoint(),{type:22,value:i.value}):(this.consumeBadUrlRemnants(),Ax)}for(;;){var r=this.consumeCodePoint();if(-1===r||41===r)return{type:22,value:Xw.apply(void 0,e)};if(zB(r))return this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:22,value:Xw.apply(void 0,e)}):(this.consumeBadUrlRemnants(),Ax);if(34===r||39===r||40===r||KB(r))return this.consumeBadUrlRemnants(),Ax;if(92===r){if(!ZB(r,this.peekCodePoint(0)))return this.consumeBadUrlRemnants(),Ax;e.push(this.consumeEscapedCodePoint())}else e.push(r)}},e.prototype.consumeWhiteSpace=function(){for(;zB(this.peekCodePoint(0));)this.consumeCodePoint()},e.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(41===e||-1===e)return;ZB(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},e.prototype.consumeStringSlice=function(e){for(var t="";e>0;){var i=Math.min(5e4,e);t+=Xw.apply(void 0,this._value.splice(0,i)),e-=i}return this._value.shift(),t},e.prototype.consumeStringToken=function(e){for(var t="",i=0;;){var r=this._value[i];if(-1===r||void 0===r||r===e)return{type:0,value:t+=this.consumeStringSlice(i)};if(10===r)return this._value.splice(0,i),cx;if(92===r){var n=this._value[i+1];-1!==n&&void 0!==n&&(10===n?(t+=this.consumeStringSlice(i),i=-1,this._value.shift()):ZB(r,n)&&(t+=this.consumeStringSlice(i),t+=Xw(this.consumeEscapedCodePoint()),i=-1))}i++}},e.prototype.consumeNumber=function(){var e=[],t=4,i=this.peekCodePoint(0);for(43!==i&&45!==i||e.push(this.consumeCodePoint());GB(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0);var r=this.peekCodePoint(1);if(46===i&&GB(r))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=8;GB(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0),r=this.peekCodePoint(1);var n=this.peekCodePoint(2);if((69===i||101===i)&&((43===r||45===r)&&GB(n)||GB(r)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=8;GB(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[qB(e),t]},e.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),t=e[0],i=e[1],r=this.peekCodePoint(0),n=this.peekCodePoint(1),s=this.peekCodePoint(2);return JB(r,n,s)?{type:15,number:t,flags:i,unit:this.consumeName()}:37===r?(this.consumeCodePoint(),{type:16,number:t,flags:i}):{type:17,number:t,flags:i}},e.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(jB(e)){for(var t=Xw(e);jB(this.peekCodePoint(0))&&t.length<6;)t+=Xw(this.consumeCodePoint());zB(this.peekCodePoint(0))&&this.consumeCodePoint();var i=parseInt(t,16);return 0===i||function(e){return e>=55296&&e<=57343}(i)||i>1114111?65533:i}return-1===e?65533:e},e.prototype.consumeName=function(){for(var e="";;){var t=this.consumeCodePoint();if(XB(t))e+=Xw(t);else{if(!ZB(t,this.peekCodePoint(0)))return this.reconsumeCodePoint(t),e;e+=Xw(this.consumeEscapedCodePoint())}}},e}(),bx=function(){function e(e){this._tokens=e}return e.create=function(t){var i=new yx;return i.write(t),new e(i.read())},e.parseValue=function(t){return e.create(t).parseComponentValue()},e.parseValues=function(t){return e.create(t).parseComponentValues()},e.prototype.parseComponentValue=function(){for(var e=this.consumeToken();31===e.type;)e=this.consumeToken();if(32===e.type)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var t=this.consumeComponentValue();do{e=this.consumeToken()}while(31===e.type);if(32===e.type)return t;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},e.prototype.parseComponentValues=function(){for(var e=[];;){var t=this.consumeComponentValue();if(32===t.type)return e;e.push(t),e.push()}},e.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},e.prototype.consumeSimpleBlock=function(e){for(var t={type:e,values:[]},i=this.consumeToken();;){if(32===i.type||Ex(i,e))return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue()),i=this.consumeToken()}},e.prototype.consumeFunction=function(e){for(var t={name:e.value,values:[],type:18};;){var i=this.consumeToken();if(32===i.type||3===i.type)return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue())}},e.prototype.consumeToken=function(){var e=this._tokens.shift();return void 0===e?_x:e},e.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},e}(),wx=function(e){return 15===e.type},Bx=function(e){return 17===e.type},xx=function(e){return 20===e.type},Px=function(e){return 0===e.type},Cx=function(e,t){return xx(e)&&e.value===t},Mx=function(e){return 31!==e.type},Fx=function(e){return 31!==e.type&&4!==e.type},kx=function(e){var t=[],i=[];return e.forEach((function(e){if(4===e.type){if(0===i.length)throw new Error("Error parsing function args, zero tokens for arg");return t.push(i),void(i=[])}31!==e.type&&i.push(e)})),i.length&&t.push(i),t},Ex=function(e,t){return 11===t&&12===e.type||(28===t&&29===e.type||2===t&&3===e.type)},Ix=function(e){return 17===e.type||15===e.type},Tx=function(e){return 16===e.type||Ix(e)},Dx=function(e){return e.length>1?[e[0],e[1]]:[e[0]]},Sx={type:17,number:0,flags:4},Rx={type:16,number:50,flags:4},Ux={type:16,number:100,flags:4},Lx=function(e,t,i){var r=e[0],n=e[1];return[Ox(r,t),Ox(void 0!==n?n:r,i)]},Ox=function(e,t){if(16===e.type)return e.number/100*t;if(wx(e))switch(e.unit){case"rem":case"em":return 16*e.number;default:return e.number}return e.number},Nx=function(e,t){if(15===t.type)switch(t.unit){case"deg":return Math.PI*t.number/180;case"grad":return Math.PI/200*t.number;case"rad":return t.number;case"turn":return 2*Math.PI*t.number}throw new Error("Unsupported angle type")},Vx=function(e){return 15===e.type&&("deg"===e.unit||"grad"===e.unit||"rad"===e.unit||"turn"===e.unit)},Qx=function(e){switch(e.filter(xx).map((function(e){return e.value})).join(" ")){case"to bottom right":case"to right bottom":case"left top":case"top left":return[Sx,Sx];case"to top":case"bottom":return Hx(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[Sx,Ux];case"to right":case"left":return Hx(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[Ux,Ux];case"to bottom":case"top":return Hx(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[Ux,Sx];case"to left":case"right":return Hx(270)}return 0},Hx=function(e){return Math.PI*e/180},Gx=function(e,t){if(18===t.type){var i=Yx[t.name];if(void 0===i)throw new Error('Attempting to parse an unsupported color function "'+t.name+'"');return i(e,t.values)}if(5===t.type){if(3===t.value.length){var r=t.value.substring(0,1),n=t.value.substring(1,2),s=t.value.substring(2,3);return Wx(parseInt(r+r,16),parseInt(n+n,16),parseInt(s+s,16),1)}if(4===t.value.length){r=t.value.substring(0,1),n=t.value.substring(1,2),s=t.value.substring(2,3);var o=t.value.substring(3,4);return Wx(parseInt(r+r,16),parseInt(n+n,16),parseInt(s+s,16),parseInt(o+o,16)/255)}if(6===t.value.length){r=t.value.substring(0,2),n=t.value.substring(2,4),s=t.value.substring(4,6);return Wx(parseInt(r,16),parseInt(n,16),parseInt(s,16),1)}if(8===t.value.length){r=t.value.substring(0,2),n=t.value.substring(2,4),s=t.value.substring(4,6),o=t.value.substring(6,8);return Wx(parseInt(r,16),parseInt(n,16),parseInt(s,16),parseInt(o,16)/255)}}if(20===t.type){var a=$x[t.value.toUpperCase()];if(void 0!==a)return a}return $x.TRANSPARENT},jx=function(e){return 0==(255&e)},zx=function(e){var t=255&e,i=255&e>>8,r=255&e>>16,n=255&e>>24;return t<255?"rgba("+n+","+r+","+i+","+t/255+")":"rgb("+n+","+r+","+i+")"},Wx=function(e,t,i,r){return(e<<24|t<<16|i<<8|Math.round(255*r)<<0)>>>0},Xx=function(e,t){if(17===e.type)return e.number;if(16===e.type){var i=3===t?1:255;return 3===t?e.number/100*i:Math.round(e.number/100*i)}return 0},Kx=function(e,t){var i=t.filter(Fx);if(3===i.length){var r=i.map(Xx),n=r[0],s=r[1],o=r[2];return Wx(n,s,o,1)}if(4===i.length){var a=i.map(Xx),l=(n=a[0],s=a[1],o=a[2],a[3]);return Wx(n,s,o,l)}return 0};function Zx(e,t,i){return i<0&&(i+=1),i>=1&&(i-=1),i<1/6?(t-e)*i*6+e:i<.5?t:i<2/3?6*(t-e)*(2/3-i)+e:e}var Jx=function(e,t){var i=t.filter(Fx),r=i[0],n=i[1],s=i[2],o=i[3],a=(17===r.type?Hx(r.number):Nx(e,r))/(2*Math.PI),l=Tx(n)?n.number/100:0,u=Tx(s)?s.number/100:0,A=void 0!==o&&Tx(o)?Ox(o,1):1;if(0===l)return Wx(255*u,255*u,255*u,1);var c=u<=.5?u*(l+1):u+l-u*l,h=2*u-c,d=Zx(h,c,a+1/3),p=Zx(h,c,a),f=Zx(h,c,a-1/3);return Wx(255*d,255*p,255*f,A)},Yx={hsl:Jx,hsla:Jx,rgb:Kx,rgba:Kx},qx=function(e,t){return Gx(e,bx.create(t).parseComponentValue())},$x={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},eP={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(e,t){return t.map((function(e){if(xx(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0}))}},tP={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},iP=function(e,t){var i=Gx(e,t[0]),r=t[1];return r&&Tx(r)?{color:i,stop:r}:{color:i,stop:null}},rP=function(e,t){var i=e[0],r=e[e.length-1];null===i.stop&&(i.stop=Sx),null===r.stop&&(r.stop=Ux);for(var n=[],s=0,o=0;o<e.length;o++){var a=e[o].stop;if(null!==a){var l=Ox(a,t);l>s?n.push(l):n.push(s),s=l}else n.push(null)}var u=null;for(o=0;o<n.length;o++){var A=n[o];if(null===A)null===u&&(u=o);else if(null!==u){for(var c=o-u,h=(A-n[u-1])/(c+1),d=1;d<=c;d++)n[u+d-1]=h*d;u=null}}return e.map((function(e,i){return{color:e.color,stop:Math.max(Math.min(1,n[i]/t),0)}}))},nP=function(e,t,i){var r="number"==typeof e?e:function(e,t,i){var r=t/2,n=i/2,s=Ox(e[0],t)-r,o=n-Ox(e[1],i);return(Math.atan2(o,s)+2*Math.PI)%(2*Math.PI)}(e,t,i),n=Math.abs(t*Math.sin(r))+Math.abs(i*Math.cos(r)),s=t/2,o=i/2,a=n/2,l=Math.sin(r-Math.PI/2)*a,u=Math.cos(r-Math.PI/2)*a;return[n,s-u,s+u,o-l,o+l]},sP=function(e,t){return Math.sqrt(e*e+t*t)},oP=function(e,t,i,r,n){return[[0,0],[0,t],[e,0],[e,t]].reduce((function(e,t){var s=t[0],o=t[1],a=sP(i-s,r-o);return(n?a<e.optimumDistance:a>e.optimumDistance)?{optimumCorner:t,optimumDistance:a}:e}),{optimumDistance:n?1/0:-1/0,optimumCorner:null}).optimumCorner},aP=function(e,t){var i=Hx(180),r=[];return kx(t).forEach((function(t,n){if(0===n){var s=t[0];if(20===s.type&&-1!==["top","left","right","bottom"].indexOf(s.value))return void(i=Qx(t));if(Vx(s))return void(i=(Nx(e,s)+Hx(270))%Hx(360))}var o=iP(e,t);r.push(o)})),{angle:i,stops:r,type:1}},lP=function(e,t){var i=0,r=3,n=[],s=[];return kx(t).forEach((function(t,o){var a=!0;if(0===o?a=t.reduce((function(e,t){if(xx(t))switch(t.value){case"center":return s.push(Rx),!1;case"top":case"left":return s.push(Sx),!1;case"right":case"bottom":return s.push(Ux),!1}else if(Tx(t)||Ix(t))return s.push(t),!1;return e}),a):1===o&&(a=t.reduce((function(e,t){if(xx(t))switch(t.value){case"circle":return i=0,!1;case"ellipse":return i=1,!1;case"contain":case"closest-side":return r=0,!1;case"farthest-side":return r=1,!1;case"closest-corner":return r=2,!1;case"cover":case"farthest-corner":return r=3,!1}else if(Ix(t)||Tx(t))return Array.isArray(r)||(r=[]),r.push(t),!1;return e}),a)),a){var l=iP(e,t);n.push(l)}})),{size:r,shape:i,stops:n,position:s,type:2}},uP=function(e,t){if(22===t.type){var i={url:t.value,type:0};return e.cache.addImage(t.value),i}if(18===t.type){var r=cP[t.name];if(void 0===r)throw new Error('Attempting to parse an unsupported image function "'+t.name+'"');return r(e,t.values)}throw new Error("Unsupported image type "+t.type)};var AP,cP={"linear-gradient":function(e,t){var i=Hx(180),r=[];return kx(t).forEach((function(t,n){if(0===n){var s=t[0];if(20===s.type&&"to"===s.value)return void(i=Qx(t));if(Vx(s))return void(i=Nx(e,s))}var o=iP(e,t);r.push(o)})),{angle:i,stops:r,type:1}},"-moz-linear-gradient":aP,"-ms-linear-gradient":aP,"-o-linear-gradient":aP,"-webkit-linear-gradient":aP,"radial-gradient":function(e,t){var i=0,r=3,n=[],s=[];return kx(t).forEach((function(t,o){var a=!0;if(0===o){var l=!1;a=t.reduce((function(e,t){if(l)if(xx(t))switch(t.value){case"center":return s.push(Rx),e;case"top":case"left":return s.push(Sx),e;case"right":case"bottom":return s.push(Ux),e}else(Tx(t)||Ix(t))&&s.push(t);else if(xx(t))switch(t.value){case"circle":return i=0,!1;case"ellipse":return i=1,!1;case"at":return l=!0,!1;case"closest-side":return r=0,!1;case"cover":case"farthest-side":return r=1,!1;case"contain":case"closest-corner":return r=2,!1;case"farthest-corner":return r=3,!1}else if(Ix(t)||Tx(t))return Array.isArray(r)||(r=[]),r.push(t),!1;return e}),a)}if(a){var u=iP(e,t);n.push(u)}})),{size:r,shape:i,stops:n,position:s,type:2}},"-moz-radial-gradient":lP,"-ms-radial-gradient":lP,"-o-radial-gradient":lP,"-webkit-radial-gradient":lP,"-webkit-gradient":function(e,t){var i=Hx(180),r=[],n=1;return kx(t).forEach((function(t,i){var s=t[0];if(0===i){if(xx(s)&&"linear"===s.value)return void(n=1);if(xx(s)&&"radial"===s.value)return void(n=2)}if(18===s.type)if("from"===s.name){var o=Gx(e,s.values[0]);r.push({stop:Sx,color:o})}else if("to"===s.name){o=Gx(e,s.values[0]);r.push({stop:Ux,color:o})}else if("color-stop"===s.name){var a=s.values.filter(Fx);if(2===a.length){o=Gx(e,a[1]);var l=a[0];Bx(l)&&r.push({stop:{type:16,number:100*l.number,flags:l.flags},color:o})}}})),1===n?{angle:(i+Hx(180))%Hx(360),stops:r,type:n}:{size:3,shape:0,stops:r,position:[],type:n}}},hP={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(e,t){if(0===t.length)return[];var i=t[0];return 20===i.type&&"none"===i.value?[]:t.filter((function(e){return Fx(e)&&function(e){return!(20===e.type&&"none"===e.value||18===e.type&&!cP[e.name])}(e)})).map((function(t){return uP(e,t)}))}},dP={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(e,t){return t.map((function(e){if(xx(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0}))}},pP={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(e,t){return kx(t).map((function(e){return e.filter(Tx)})).map(Dx)}},fP={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(e,t){return kx(t).map((function(e){return e.filter(xx).map((function(e){return e.value})).join(" ")})).map(vP)}},vP=function(e){switch(e){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;default:return 0}};!function(e){e.AUTO="auto",e.CONTAIN="contain",e.COVER="cover"}(AP||(AP={}));var gP,mP={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(e,t){return kx(t).map((function(e){return e.filter(_P)}))}},_P=function(e){return xx(e)||Tx(e)},yP=function(e){return{name:"border-"+e+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},bP=yP("top"),wP=yP("right"),BP=yP("bottom"),xP=yP("left"),PP=function(e){return{name:"border-radius-"+e,initialValue:"0 0",prefix:!1,type:1,parse:function(e,t){return Dx(t.filter(Tx))}}},CP=PP("top-left"),MP=PP("top-right"),FP=PP("bottom-right"),kP=PP("bottom-left"),EP=function(e){return{name:"border-"+e+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,t){switch(t){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},IP=EP("top"),TP=EP("right"),DP=EP("bottom"),SP=EP("left"),RP=function(e){return{name:"border-"+e+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return wx(t)?t.number:0}}},UP=RP("top"),LP=RP("right"),OP=RP("bottom"),NP=RP("left"),VP={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},QP={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(e,t){return"rtl"===t?1:0}},HP={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(e,t){return t.filter(xx).reduce((function(e,t){return e|GP(t.value)}),0)}},GP=function(e){switch(e){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},jP={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},zP={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(e,t){return 20===t.type&&"normal"===t.value?0:17===t.type||15===t.type?t.number:0}};!function(e){e.NORMAL="normal",e.STRICT="strict"}(gP||(gP={}));var WP,XP={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){return"strict"===t?gP.STRICT:gP.NORMAL}},KP={name:"line-height",initialValue:"normal",prefix:!1,type:4},ZP=function(e,t){return xx(e)&&"normal"===e.value?1.2*t:17===e.type?t*e.number:Tx(e)?Ox(e,t):t},JP={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(e,t){return 20===t.type&&"none"===t.value?null:uP(e,t)}},YP={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(e,t){return"inside"===t?0:1}},qP={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;default:return-1}}},$P=function(e){return{name:"margin-"+e,initialValue:"0",prefix:!1,type:4}},eC=$P("top"),tC=$P("right"),iC=$P("bottom"),rC=$P("left"),nC={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(e,t){return t.filter(xx).map((function(e){switch(e.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;default:return 0}}))}},sC={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){return"break-word"===t?"break-word":"normal"}},oC=function(e){return{name:"padding-"+e,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},aC=oC("top"),lC=oC("right"),uC=oC("bottom"),AC=oC("left"),cC={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(e,t){switch(t){case"right":return 2;case"center":case"justify":return 1;default:return 0}}},hC={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(e,t){switch(t){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},dC={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return 1===t.length&&Cx(t[0],"none")?[]:kx(t).map((function(t){for(var i={color:$x.TRANSPARENT,offsetX:Sx,offsetY:Sx,blur:Sx},r=0,n=0;n<t.length;n++){var s=t[n];Ix(s)?(0===r?i.offsetX=s:1===r?i.offsetY=s:i.blur=s,r++):i.color=Gx(e,s)}return i}))}},pC={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},fC={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(e,t){if(20===t.type&&"none"===t.value)return null;if(18===t.type){var i=vC[t.name];if(void 0===i)throw new Error('Attempting to parse an unsupported transform function "'+t.name+'"');return i(t.values)}return null}},vC={matrix:function(e){var t=e.filter((function(e){return 17===e.type})).map((function(e){return e.number}));return 6===t.length?t:null},matrix3d:function(e){var t=e.filter((function(e){return 17===e.type})).map((function(e){return e.number})),i=t[0],r=t[1];t[2],t[3];var n=t[4],s=t[5];t[6],t[7],t[8],t[9],t[10],t[11];var o=t[12],a=t[13];return t[14],t[15],16===t.length?[i,r,n,s,o,a]:null}},gC={type:16,number:50,flags:4},mC=[gC,gC],_C={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(e,t){var i=t.filter(Tx);return 2!==i.length?mC:[i[0],i[1]]}},yC={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"hidden":return 1;case"collapse":return 2;default:return 0}}};!function(e){e.NORMAL="normal",e.BREAK_ALL="break-all",e.KEEP_ALL="keep-all"}(WP||(WP={}));for(var bC={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){switch(t){case"break-all":return WP.BREAK_ALL;case"keep-all":return WP.KEEP_ALL;default:return WP.NORMAL}}},wC={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(e,t){if(20===t.type)return{auto:!0,order:0};if(Bx(t))return{auto:!1,order:t.number};throw new Error("Invalid z-index number parsed")}},BC=function(e,t){if(15===t.type)switch(t.unit.toLowerCase()){case"s":return 1e3*t.number;case"ms":return t.number}throw new Error("Unsupported time type")},xC={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(e,t){return Bx(t)?t.number:1}},PC={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},CC={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(e,t){return t.filter(xx).map((function(e){switch(e.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0})).filter((function(e){return 0!==e}))}},MC={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(e,t){var i=[],r=[];return t.forEach((function(e){switch(e.type){case 20:case 0:i.push(e.value);break;case 17:i.push(e.number.toString());break;case 4:r.push(i.join(" ")),i.length=0}})),i.length&&r.push(i.join(" ")),r.map((function(e){return-1===e.indexOf(" ")?e:"'"+e+"'"}))}},FC={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},kC={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(e,t){return Bx(t)?t.number:xx(t)&&"bold"===t.value?700:400}},EC={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return t.filter(xx).map((function(e){return e.value}))}},IC={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){switch(t){case"oblique":return"oblique";case"italic":return"italic";default:return"normal"}}},TC=function(e,t){return 0!=(e&t)},DC={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(e,t){if(0===t.length)return[];var i=t[0];return 20===i.type&&"none"===i.value?[]:t}},SC={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return null;var i=t[0];if(20===i.type&&"none"===i.value)return null;for(var r=[],n=t.filter(Mx),s=0;s<n.length;s++){var o=n[s],a=n[s+1];if(20===o.type){var l=a&&Bx(a)?a.number:1;r.push({counter:o.value,increment:l})}}return r}},RC={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return[];for(var i=[],r=t.filter(Mx),n=0;n<r.length;n++){var s=r[n],o=r[n+1];if(xx(s)&&"none"!==s.value){var a=o&&Bx(o)?o.number:0;i.push({counter:s.value,reset:a})}}return i}},UC={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(e,t){return t.filter(wx).map((function(t){return BC(e,t)}))}},LC={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return null;var i=t[0];if(20===i.type&&"none"===i.value)return null;var r=[],n=t.filter(Px);if(n.length%2!=0)return null;for(var s=0;s<n.length;s+=2){var o=n[s].value,a=n[s+1].value;r.push({open:o,close:a})}return r}},OC=function(e,t,i){if(!e)return"";var r=e[Math.min(t,e.length-1)];return r?i?r.open:r.close:""},NC={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return 1===t.length&&Cx(t[0],"none")?[]:kx(t).map((function(t){for(var i={color:255,offsetX:Sx,offsetY:Sx,blur:Sx,spread:Sx,inset:!1},r=0,n=0;n<t.length;n++){var s=t[n];Cx(s,"inset")?i.inset=!0:Ix(s)?(0===r?i.offsetX=s:1===r?i.offsetY=s:2===r?i.blur=s:i.spread=s,r++):i.color=Gx(e,s)}return i}))}},VC={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(e,t){var i=[];return t.filter(xx).forEach((function(e){switch(e.value){case"stroke":i.push(1);break;case"fill":i.push(0);break;case"markers":i.push(2)}})),[0,1,2].forEach((function(e){-1===i.indexOf(e)&&i.push(e)})),i}},QC={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},HC={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return wx(t)?t.number:0}},GC=function(){function e(e,t){var i,r;this.animationDuration=WC(e,UC,t.animationDuration),this.backgroundClip=WC(e,eP,t.backgroundClip),this.backgroundColor=WC(e,tP,t.backgroundColor),this.backgroundImage=WC(e,hP,t.backgroundImage),this.backgroundOrigin=WC(e,dP,t.backgroundOrigin),this.backgroundPosition=WC(e,pP,t.backgroundPosition),this.backgroundRepeat=WC(e,fP,t.backgroundRepeat),this.backgroundSize=WC(e,mP,t.backgroundSize),this.borderTopColor=WC(e,bP,t.borderTopColor),this.borderRightColor=WC(e,wP,t.borderRightColor),this.borderBottomColor=WC(e,BP,t.borderBottomColor),this.borderLeftColor=WC(e,xP,t.borderLeftColor),this.borderTopLeftRadius=WC(e,CP,t.borderTopLeftRadius),this.borderTopRightRadius=WC(e,MP,t.borderTopRightRadius),this.borderBottomRightRadius=WC(e,FP,t.borderBottomRightRadius),this.borderBottomLeftRadius=WC(e,kP,t.borderBottomLeftRadius),this.borderTopStyle=WC(e,IP,t.borderTopStyle),this.borderRightStyle=WC(e,TP,t.borderRightStyle),this.borderBottomStyle=WC(e,DP,t.borderBottomStyle),this.borderLeftStyle=WC(e,SP,t.borderLeftStyle),this.borderTopWidth=WC(e,UP,t.borderTopWidth),this.borderRightWidth=WC(e,LP,t.borderRightWidth),this.borderBottomWidth=WC(e,OP,t.borderBottomWidth),this.borderLeftWidth=WC(e,NP,t.borderLeftWidth),this.boxShadow=WC(e,NC,t.boxShadow),this.color=WC(e,VP,t.color),this.direction=WC(e,QP,t.direction),this.display=WC(e,HP,t.display),this.float=WC(e,jP,t.cssFloat),this.fontFamily=WC(e,MC,t.fontFamily),this.fontSize=WC(e,FC,t.fontSize),this.fontStyle=WC(e,IC,t.fontStyle),this.fontVariant=WC(e,EC,t.fontVariant),this.fontWeight=WC(e,kC,t.fontWeight),this.letterSpacing=WC(e,zP,t.letterSpacing),this.lineBreak=WC(e,XP,t.lineBreak),this.lineHeight=WC(e,KP,t.lineHeight),this.listStyleImage=WC(e,JP,t.listStyleImage),this.listStylePosition=WC(e,YP,t.listStylePosition),this.listStyleType=WC(e,qP,t.listStyleType),this.marginTop=WC(e,eC,t.marginTop),this.marginRight=WC(e,tC,t.marginRight),this.marginBottom=WC(e,iC,t.marginBottom),this.marginLeft=WC(e,rC,t.marginLeft),this.opacity=WC(e,xC,t.opacity);var n=WC(e,nC,t.overflow);this.overflowX=n[0],this.overflowY=n[n.length>1?1:0],this.overflowWrap=WC(e,sC,t.overflowWrap),this.paddingTop=WC(e,aC,t.paddingTop),this.paddingRight=WC(e,lC,t.paddingRight),this.paddingBottom=WC(e,uC,t.paddingBottom),this.paddingLeft=WC(e,AC,t.paddingLeft),this.paintOrder=WC(e,VC,t.paintOrder),this.position=WC(e,hC,t.position),this.textAlign=WC(e,cC,t.textAlign),this.textDecorationColor=WC(e,PC,null!==(i=t.textDecorationColor)&&void 0!==i?i:t.color),this.textDecorationLine=WC(e,CC,null!==(r=t.textDecorationLine)&&void 0!==r?r:t.textDecoration),this.textShadow=WC(e,dC,t.textShadow),this.textTransform=WC(e,pC,t.textTransform),this.transform=WC(e,fC,t.transform),this.transformOrigin=WC(e,_C,t.transformOrigin),this.visibility=WC(e,yC,t.visibility),this.webkitTextStrokeColor=WC(e,QC,t.webkitTextStrokeColor),this.webkitTextStrokeWidth=WC(e,HC,t.webkitTextStrokeWidth),this.wordBreak=WC(e,bC,t.wordBreak),this.zIndex=WC(e,wC,t.zIndex)}return e.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&0===this.visibility},e.prototype.isTransparent=function(){return jx(this.backgroundColor)},e.prototype.isTransformed=function(){return null!==this.transform},e.prototype.isPositioned=function(){return 0!==this.position},e.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},e.prototype.isFloating=function(){return 0!==this.float},e.prototype.isInlineLevel=function(){return TC(this.display,4)||TC(this.display,33554432)||TC(this.display,268435456)||TC(this.display,536870912)||TC(this.display,67108864)||TC(this.display,134217728)},e}(),jC=function(e,t){this.content=WC(e,DC,t.content),this.quotes=WC(e,LC,t.quotes)},zC=function(e,t){this.counterIncrement=WC(e,SC,t.counterIncrement),this.counterReset=WC(e,RC,t.counterReset)},WC=function(e,t,i){var r=new yx,n=null!=i?i.toString():t.initialValue;r.write(n);var s=new bx(r.read());switch(t.type){case 2:var o=s.parseComponentValue();return t.parse(e,xx(o)?o.value:t.initialValue);case 0:return t.parse(e,s.parseComponentValue());case 1:return t.parse(e,s.parseComponentValues());case 4:return s.parseComponentValue();case 3:switch(t.format){case"angle":return Nx(e,s.parseComponentValue());case"color":return Gx(e,s.parseComponentValue());case"image":return uP(e,s.parseComponentValue());case"length":var a=s.parseComponentValue();return Ix(a)?a:Sx;case"length-percentage":var l=s.parseComponentValue();return Tx(l)?l:Sx;case"time":return BC(e,s.parseComponentValue())}}},XC=function(e,t){var i=function(e){switch(e.getAttribute("data-html2canvas-debug")){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}}(e);return 1===i||t===i},KC=function(e,t){this.context=e,this.textNodes=[],this.elements=[],this.flags=0,XC(t,3),this.styles=new GC(e,window.getComputedStyle(t,null)),KM(t)&&(this.styles.animationDuration.some((function(e){return e>0}))&&(t.style.animationDuration="0s"),null!==this.styles.transform&&(t.style.transform="none")),this.bounds=zw(this.context,t),XC(t,4)&&(this.flags|=16)},ZC="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",JC="undefined"==typeof Uint8Array?[]:new Uint8Array(256),YC=0;YC<ZC.length;YC++)JC[ZC.charCodeAt(YC)]=YC;for(var qC=function(e,t,i){return e.slice?e.slice(t,i):new Uint16Array(Array.prototype.slice.call(e,t,i))},$C=function(){function e(e,t,i,r,n,s){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=r,this.index=n,this.data=s}return e.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=((t=this.index[e>>5])<<2)+(31&e),this.data[t];if(e<=65535)return t=((t=this.index[2048+(e-55296>>5)])<<2)+(31&e),this.data[t];if(e<this.highStart)return t=2080+(e>>11),t=this.index[t],t+=e>>5&63,t=((t=this.index[t])<<2)+(31&e),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},e}(),eM="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",tM="undefined"==typeof Uint8Array?[]:new Uint8Array(256),iM=0;iM<eM.length;iM++)tM[eM.charCodeAt(iM)]=iM;var rM,nM=8,sM=9,oM=11,aM=12,lM=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,e);var i=e.length;if(!i)return"";for(var r=[],n=-1,s="";++n<i;){var o=e[n];o<=65535?r.push(o):(o-=65536,r.push(55296+(o>>10),o%1024+56320)),(n+1===i||r.length>16384)&&(s+=String.fromCharCode.apply(String,r),r.length=0)}return s},uM=function(e,t){var i,r,n,s=function(e){var t,i,r,n,s,o=.75*e.length,a=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var u="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&void 0!==Uint8Array.prototype.slice?new ArrayBuffer(o):new Array(o),A=Array.isArray(u)?u:new Uint8Array(u);for(t=0;t<a;t+=4)i=JC[e.charCodeAt(t)],r=JC[e.charCodeAt(t+1)],n=JC[e.charCodeAt(t+2)],s=JC[e.charCodeAt(t+3)],A[l++]=i<<2|r>>4,A[l++]=(15&r)<<4|n>>2,A[l++]=(3&n)<<6|63&s;return u}(e),o=Array.isArray(s)?function(e){for(var t=e.length,i=[],r=0;r<t;r+=4)i.push(e[r+3]<<24|e[r+2]<<16|e[r+1]<<8|e[r]);return i}(s):new Uint32Array(s),a=Array.isArray(s)?function(e){for(var t=e.length,i=[],r=0;r<t;r+=2)i.push(e[r+1]<<8|e[r]);return i}(s):new Uint16Array(s),l=qC(a,12,o[4]/2),u=2===o[5]?qC(a,(24+o[4])/2):(i=o,r=Math.ceil((24+o[4])/4),i.slice?i.slice(r,n):new Uint32Array(Array.prototype.slice.call(i,r,n)));return new $C(o[0],o[1],o[2],o[3],l,u)}("AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA="),AM=function(e){return uM.get(e)},cM=function(e,t,i){var r=i-2,n=t[r],s=t[i-1],o=t[i];if(2===s&&3===o)return"×";if(2===s||3===s||4===s)return"÷";if(2===o||3===o||4===o)return"÷";if(s===nM&&-1!==[nM,sM,oM,aM].indexOf(o))return"×";if(!(s!==oM&&s!==sM||o!==sM&&10!==o))return"×";if((s===aM||10===s)&&10===o)return"×";if(13===o||5===o)return"×";if(7===o)return"×";if(1===s)return"×";if(13===s&&14===o){for(;5===n;)n=t[--r];if(14===n)return"×"}if(15===s&&15===o){for(var a=0;15===n;)a++,n=t[--r];if(a%2==0)return"×"}return"÷"},hM=function(e){var t=function(e){for(var t=[],i=0,r=e.length;i<r;){var n=e.charCodeAt(i++);if(n>=55296&&n<=56319&&i<r){var s=e.charCodeAt(i++);56320==(64512&s)?t.push(((1023&n)<<10)+(1023&s)+65536):(t.push(n),i--)}else t.push(n)}return t}(e),i=t.length,r=0,n=0,s=t.map(AM);return{next:function(){if(r>=i)return{done:!0,value:null};for(var e="×";r<i&&"×"===(e=cM(0,s,++r)););if("×"!==e||r===i){var o=lM.apply(null,t.slice(n,r));return n=r,{value:o,done:!1}}return{done:!0,value:null}}}},dM=function(e){return 0===e[0]&&255===e[1]&&0===e[2]&&255===e[3]},pM=function(e,t,i,r,n){var s="http://www.w3.org/2000/svg",o=document.createElementNS(s,"svg"),a=document.createElementNS(s,"foreignObject");return o.setAttributeNS(null,"width",e.toString()),o.setAttributeNS(null,"height",t.toString()),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.setAttributeNS(null,"x",i.toString()),a.setAttributeNS(null,"y",r.toString()),a.setAttributeNS(null,"externalResourcesRequired","true"),o.appendChild(a),a.appendChild(n),o},fM=function(e){return new Promise((function(t,i){var r=new Image;r.onload=function(){return t(r)},r.onerror=i,r.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(e))}))},vM={get SUPPORT_RANGE_BOUNDS(){var e=function(e){if(e.createRange){var t=e.createRange();if(t.getBoundingClientRect){var i=e.createElement("boundtest");i.style.height="123px",i.style.display="block",e.body.appendChild(i),t.selectNode(i);var r=t.getBoundingClientRect(),n=Math.round(r.height);if(e.body.removeChild(i),123===n)return!0}}return!1}(document);return Object.defineProperty(vM,"SUPPORT_RANGE_BOUNDS",{value:e}),e},get SUPPORT_WORD_BREAKING(){var e=vM.SUPPORT_RANGE_BOUNDS&&function(e){var t=e.createElement("boundtest");t.style.width="50px",t.style.display="block",t.style.fontSize="12px",t.style.letterSpacing="0px",t.style.wordSpacing="0px",e.body.appendChild(t);var i=e.createRange();t.innerHTML="function"==typeof"".repeat?"&#128104;".repeat(10):"";var r=t.firstChild,n=Ww(r.data).map((function(e){return Xw(e)})),s=0,o={},a=n.every((function(e,t){i.setStart(r,s),i.setEnd(r,s+e.length);var n=i.getBoundingClientRect();s+=e.length;var a=n.x>o.x||n.y>o.y;return o=n,0===t||a}));return e.body.removeChild(t),a}(document);return Object.defineProperty(vM,"SUPPORT_WORD_BREAKING",{value:e}),e},get SUPPORT_SVG_DRAWING(){var e=function(e){var t=new Image,i=e.createElement("canvas"),r=i.getContext("2d");if(!r)return!1;t.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{r.drawImage(t,0,0),i.toDataURL()}catch(e){return!1}return!0}(document);return Object.defineProperty(vM,"SUPPORT_SVG_DRAWING",{value:e}),e},get SUPPORT_FOREIGNOBJECT_DRAWING(){var e="function"==typeof Array.from&&"function"==typeof window.fetch?function(e){var t=e.createElement("canvas"),i=100;t.width=i,t.height=i;var r=t.getContext("2d");if(!r)return Promise.reject(!1);r.fillStyle="rgb(0, 255, 0)",r.fillRect(0,0,i,i);var n=new Image,s=t.toDataURL();n.src=s;var o=pM(i,i,0,0,n);return r.fillStyle="red",r.fillRect(0,0,i,i),fM(o).then((function(t){r.drawImage(t,0,0);var n=r.getImageData(0,0,i,i).data;r.fillStyle="red",r.fillRect(0,0,i,i);var o=e.createElement("div");return o.style.backgroundImage="url("+s+")",o.style.height="100px",dM(n)?fM(pM(i,i,0,0,o)):Promise.reject(!1)})).then((function(e){return r.drawImage(e,0,0),dM(r.getImageData(0,0,i,i).data)})).catch((function(){return!1}))}(document):Promise.resolve(!1);return Object.defineProperty(vM,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:e}),e},get SUPPORT_CORS_IMAGES(){var e=void 0!==(new Image).crossOrigin;return Object.defineProperty(vM,"SUPPORT_CORS_IMAGES",{value:e}),e},get SUPPORT_RESPONSE_TYPE(){var e="string"==typeof(new XMLHttpRequest).responseType;return Object.defineProperty(vM,"SUPPORT_RESPONSE_TYPE",{value:e}),e},get SUPPORT_CORS_XHR(){var e="withCredentials"in new XMLHttpRequest;return Object.defineProperty(vM,"SUPPORT_CORS_XHR",{value:e}),e},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var e=!("undefined"==typeof Intl||!Intl.Segmenter);return Object.defineProperty(vM,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:e}),e}},gM=function(e,t){this.text=e,this.bounds=t},mM=function(e,t){var i=t.ownerDocument;if(i){var r=i.createElement("html2canvaswrapper");r.appendChild(t.cloneNode(!0));var n=t.parentNode;if(n){n.replaceChild(r,t);var s=zw(e,r);return r.firstChild&&n.replaceChild(r.firstChild,r),s}}return jw.EMPTY},_M=function(e,t,i){var r=e.ownerDocument;if(!r)throw new Error("Node has no owner document");var n=r.createRange();return n.setStart(e,t),n.setEnd(e,t+i),n},yM=function(e){if(vM.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(t.segment(e)).map((function(e){return e.segment}))}return function(e){for(var t,i=hM(e),r=[];!(t=i.next()).done;)t.value&&r.push(t.value.slice());return r}(e)},bM=function(e,t){return 0!==t.letterSpacing?yM(e):function(e,t){if(vM.SUPPORT_NATIVE_TEXT_SEGMENTATION){var i=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(i.segment(e)).map((function(e){return e.segment}))}return BM(e,t)}(e,t)},wM=[32,160,4961,65792,65793,4153,4241],BM=function(e,t){for(var i,r=function(e,t){var i=Ww(e),r=QB(i,t),n=r[0],s=r[1],o=r[2],a=i.length,l=0,u=0;return{next:function(){if(u>=a)return{done:!0,value:null};for(var e="×";u<a&&"×"===(e=VB(i,s,n,++u,o)););if("×"!==e||u===a){var t=new HB(i,e,l,u);return l=u,{value:t,done:!1}}return{done:!0,value:null}}}}(e,{lineBreak:t.lineBreak,wordBreak:"break-word"===t.overflowWrap?"break-word":t.wordBreak}),n=[],s=function(){if(i.value){var e=i.value.slice(),t=Ww(e),r="";t.forEach((function(e){-1===wM.indexOf(e)?r+=Xw(e):(r.length&&n.push(r),n.push(Xw(e)),r="")})),r.length&&n.push(r)}};!(i=r.next()).done;)s();return n},xM=function(e,t,i){this.text=PM(t.data,i.textTransform),this.textBounds=function(e,t,i,r){var n=bM(t,i),s=[],o=0;return n.forEach((function(t){if(i.textDecorationLine.length||t.trim().length>0)if(vM.SUPPORT_RANGE_BOUNDS){var n=_M(r,o,t.length).getClientRects();if(n.length>1){var a=yM(t),l=0;a.forEach((function(t){s.push(new gM(t,jw.fromDOMRectList(e,_M(r,l+o,t.length).getClientRects()))),l+=t.length}))}else s.push(new gM(t,jw.fromDOMRectList(e,n)))}else{var u=r.splitText(t.length);s.push(new gM(t,mM(e,r))),r=u}else vM.SUPPORT_RANGE_BOUNDS||(r=r.splitText(t.length));o+=t.length})),s}(e,this.text,i,t)},PM=function(e,t){switch(t){case 1:return e.toLowerCase();case 3:return e.replace(CM,MM);case 2:return e.toUpperCase();default:return e}},CM=/(^|\s|:|-|\(|\))([a-z])/g,MM=function(e,t,i){return e.length>0?t+i.toUpperCase():e},FM=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.src=i.currentSrc||i.src,r.intrinsicWidth=i.naturalWidth,r.intrinsicHeight=i.naturalHeight,r.context.cache.addImage(r.src),r}return Nw(t,e),t}(KC),kM=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.canvas=i,r.intrinsicWidth=i.width,r.intrinsicHeight=i.height,r}return Nw(t,e),t}(KC),EM=function(e){function t(t,i){var r=e.call(this,t,i)||this,n=new XMLSerializer,s=zw(t,i);return i.setAttribute("width",s.width+"px"),i.setAttribute("height",s.height+"px"),r.svg="data:image/svg+xml,"+encodeURIComponent(n.serializeToString(i)),r.intrinsicWidth=i.width.baseVal.value,r.intrinsicHeight=i.height.baseVal.value,r.context.cache.addImage(r.svg),r}return Nw(t,e),t}(KC),IM=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.value=i.value,r}return Nw(t,e),t}(KC),TM=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.start=i.start,r.reversed="boolean"==typeof i.reversed&&!0===i.reversed,r}return Nw(t,e),t}(KC),DM=[{type:15,flags:0,unit:"px",number:3}],SM=[{type:16,flags:0,number:50}],RM="password",UM=function(e){function t(t,i){var r,n,s,o=e.call(this,t,i)||this;switch(o.type=i.type.toLowerCase(),o.checked=i.checked,o.value=0===(n=(r=i).type===RM?new Array(r.value.length+1).join("•"):r.value).length?r.placeholder||"":n,"checkbox"!==o.type&&"radio"!==o.type||(o.styles.backgroundColor=3739148031,o.styles.borderTopColor=o.styles.borderRightColor=o.styles.borderBottomColor=o.styles.borderLeftColor=2779096575,o.styles.borderTopWidth=o.styles.borderRightWidth=o.styles.borderBottomWidth=o.styles.borderLeftWidth=1,o.styles.borderTopStyle=o.styles.borderRightStyle=o.styles.borderBottomStyle=o.styles.borderLeftStyle=1,o.styles.backgroundClip=[0],o.styles.backgroundOrigin=[0],o.bounds=(s=o.bounds).width>s.height?new jw(s.left+(s.width-s.height)/2,s.top,s.height,s.height):s.width<s.height?new jw(s.left,s.top+(s.height-s.width)/2,s.width,s.width):s),o.type){case"checkbox":o.styles.borderTopRightRadius=o.styles.borderTopLeftRadius=o.styles.borderBottomRightRadius=o.styles.borderBottomLeftRadius=DM;break;case"radio":o.styles.borderTopRightRadius=o.styles.borderTopLeftRadius=o.styles.borderBottomRightRadius=o.styles.borderBottomLeftRadius=SM}return o}return Nw(t,e),t}(KC),LM=function(e){function t(t,i){var r=e.call(this,t,i)||this,n=i.options[i.selectedIndex||0];return r.value=n&&n.text||"",r}return Nw(t,e),t}(KC),OM=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.value=i.value,r}return Nw(t,e),t}(KC),NM=function(e){function t(t,i){var r=e.call(this,t,i)||this;r.src=i.src,r.width=parseInt(i.width,10)||0,r.height=parseInt(i.height,10)||0,r.backgroundColor=r.styles.backgroundColor;try{if(i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.documentElement){r.tree=GM(t,i.contentWindow.document.documentElement);var n=i.contentWindow.document.documentElement?qx(t,getComputedStyle(i.contentWindow.document.documentElement).backgroundColor):$x.TRANSPARENT,s=i.contentWindow.document.body?qx(t,getComputedStyle(i.contentWindow.document.body).backgroundColor):$x.TRANSPARENT;r.backgroundColor=jx(n)?jx(s)?r.styles.backgroundColor:s:n}}catch(e){}return r}return Nw(t,e),t}(KC),VM=["OL","UL","MENU"],QM=function e(t,i,r,n){for(var s=i.firstChild,o=void 0;s;s=o)if(o=s.nextSibling,WM(s)&&s.data.trim().length>0)r.textNodes.push(new xM(t,s,r.styles));else if(XM(s))if(lF(s)&&s.assignedNodes)s.assignedNodes().forEach((function(i){return e(t,i,r,n)}));else{var a=HM(t,s);a.styles.isVisible()&&(jM(s,a,n)?a.flags|=4:zM(a.styles)&&(a.flags|=2),-1!==VM.indexOf(s.tagName)&&(a.flags|=8),r.elements.push(a),s.slot,s.shadowRoot?e(t,s.shadowRoot,a,n):oF(s)||$M(s)||aF(s)||e(t,s,a,n))}},HM=function(e,t){return rF(t)?new FM(e,t):tF(t)?new kM(e,t):$M(t)?new EM(e,t):JM(t)?new IM(e,t):YM(t)?new TM(e,t):qM(t)?new UM(e,t):aF(t)?new LM(e,t):oF(t)?new OM(e,t):nF(t)?new NM(e,t):new KC(e,t)},GM=function(e,t){var i=HM(e,t);return i.flags|=4,QM(e,t,i,i),i},jM=function(e,t,i){return t.styles.isPositionedWithZIndex()||t.styles.opacity<1||t.styles.isTransformed()||eF(e)&&i.styles.isTransparent()},zM=function(e){return e.isPositioned()||e.isFloating()},WM=function(e){return e.nodeType===Node.TEXT_NODE},XM=function(e){return e.nodeType===Node.ELEMENT_NODE},KM=function(e){return XM(e)&&void 0!==e.style&&!ZM(e)},ZM=function(e){return"object"===P(e.className)},JM=function(e){return"LI"===e.tagName},YM=function(e){return"OL"===e.tagName},qM=function(e){return"INPUT"===e.tagName},$M=function(e){return"svg"===e.tagName},eF=function(e){return"BODY"===e.tagName},tF=function(e){return"CANVAS"===e.tagName},iF=function(e){return"VIDEO"===e.tagName},rF=function(e){return"IMG"===e.tagName},nF=function(e){return"IFRAME"===e.tagName},sF=function(e){return"STYLE"===e.tagName},oF=function(e){return"TEXTAREA"===e.tagName},aF=function(e){return"SELECT"===e.tagName},lF=function(e){return"SLOT"===e.tagName},uF=function(e){return e.tagName.indexOf("-")>0},AF=function(){function e(){this.counters={}}return e.prototype.getCounterValue=function(e){var t=this.counters[e];return t&&t.length?t[t.length-1]:1},e.prototype.getCounterValues=function(e){var t=this.counters[e];return t||[]},e.prototype.pop=function(e){var t=this;e.forEach((function(e){return t.counters[e].pop()}))},e.prototype.parse=function(e){var t=this,i=e.counterIncrement,r=e.counterReset,n=!0;null!==i&&i.forEach((function(e){var i=t.counters[e.counter];i&&0!==e.increment&&(n=!1,i.length||i.push(1),i[Math.max(0,i.length-1)]+=e.increment)}));var s=[];return n&&r.forEach((function(e){var i=t.counters[e.counter];s.push(e.counter),i||(i=t.counters[e.counter]=[]),i.push(e.reset)})),s},e}(),cF={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},hF={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["Ք","Փ","Ւ","Ց","Ր","Տ","Վ","Ս","Ռ","Ջ","Պ","Չ","Ո","Շ","Ն","Յ","Մ","Ճ","Ղ","Ձ","Հ","Կ","Ծ","Խ","Լ","Ի","Ժ","Թ","Ը","Է","Զ","Ե","Դ","Գ","Բ","Ա"]},dF={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["י׳","ט׳","ח׳","ז׳","ו׳","ה׳","ד׳","ג׳","ב׳","א׳","ת","ש","ר","ק","צ","פ","ע","ס","נ","מ","ל","כ","יט","יח","יז","טז","טו","י","ט","ח","ז","ו","ה","ד","ג","ב","א"]},pF={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["ჵ","ჰ","ჯ","ჴ","ხ","ჭ","წ","ძ","ც","ჩ","შ","ყ","ღ","ქ","ფ","ჳ","ტ","ს","რ","ჟ","პ","ო","ჲ","ნ","მ","ლ","კ","ი","თ","ჱ","ზ","ვ","ე","დ","გ","ბ","ა"]},fF=function(e,t,i,r,n,s){return e<t||e>i?yF(e,n,s.length>0):r.integers.reduce((function(t,i,n){for(;e>=i;)e-=i,t+=r.values[n];return t}),"")+s},vF=function(e,t,i,r){var n="";do{i||e--,n=r(e)+n,e/=t}while(e*t>=t);return n},gF=function(e,t,i,r,n){var s=i-t+1;return(e<0?"-":"")+(vF(Math.abs(e),s,r,(function(e){return Xw(Math.floor(e%s)+t)}))+n)},mF=function(e,t,i){void 0===i&&(i=". ");var r=t.length;return vF(Math.abs(e),r,!1,(function(e){return t[Math.floor(e%r)]}))+i},_F=function(e,t,i,r,n,s){if(e<-9999||e>9999)return yF(e,4,n.length>0);var o=Math.abs(e),a=n;if(0===o)return t[0]+a;for(var l=0;o>0&&l<=4;l++){var u=o%10;0===u&&TC(s,1)&&""!==a?a=t[u]+a:u>1||1===u&&0===l||1===u&&1===l&&TC(s,2)||1===u&&1===l&&TC(s,4)&&e>100||1===u&&l>1&&TC(s,8)?a=t[u]+(l>0?i[l-1]:"")+a:1===u&&l>0&&(a=i[l-1]+a),o=Math.floor(o/10)}return(e<0?r:"")+a},yF=function(e,t,i){var r=i?". ":"",n=i?"、":"",s=i?", ":"",o=i?" ":"";switch(t){case 0:return"•"+o;case 1:return"◦"+o;case 2:return"◾"+o;case 5:var a=gF(e,48,57,!0,r);return a.length<4?"0"+a:a;case 4:return mF(e,"〇一二三四五六七八九",n);case 6:return fF(e,1,3999,cF,3,r).toLowerCase();case 7:return fF(e,1,3999,cF,3,r);case 8:return gF(e,945,969,!1,r);case 9:return gF(e,97,122,!1,r);case 10:return gF(e,65,90,!1,r);case 11:return gF(e,1632,1641,!0,r);case 12:case 49:return fF(e,1,9999,hF,3,r);case 35:return fF(e,1,9999,hF,3,r).toLowerCase();case 13:return gF(e,2534,2543,!0,r);case 14:case 30:return gF(e,6112,6121,!0,r);case 15:return mF(e,"子丑寅卯辰巳午未申酉戌亥",n);case 16:return mF(e,"甲乙丙丁戊己庚辛壬癸",n);case 17:case 48:return _F(e,"零一二三四五六七八九","十百千萬","負",n,14);case 47:return _F(e,"零壹貳參肆伍陸柒捌玖","拾佰仟萬","負",n,15);case 42:return _F(e,"零一二三四五六七八九","十百千萬","负",n,14);case 41:return _F(e,"零壹贰叁肆伍陆柒捌玖","拾佰仟萬","负",n,15);case 26:return _F(e,"〇一二三四五六七八九","十百千万","マイナス",n,0);case 25:return _F(e,"零壱弐参四伍六七八九","拾百千万","マイナス",n,7);case 31:return _F(e,"영일이삼사오육칠팔구","십백천만","마이너스",s,7);case 33:return _F(e,"零一二三四五六七八九","十百千萬","마이너스",s,0);case 32:return _F(e,"零壹貳參四五六七八九","拾百千","마이너스",s,7);case 18:return gF(e,2406,2415,!0,r);case 20:return fF(e,1,19999,pF,3,r);case 21:return gF(e,2790,2799,!0,r);case 22:return gF(e,2662,2671,!0,r);case 22:return fF(e,1,10999,dF,3,r);case 23:return mF(e,"あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわゐゑをん");case 24:return mF(e,"いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす");case 27:return gF(e,3302,3311,!0,r);case 28:return mF(e,"アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヰヱヲン",n);case 29:return mF(e,"イロハニホヘトチリヌルヲワカヨタレソツネナラムウヰノオクヤマケフコエテアサキユメミシヱヒモセス",n);case 34:return gF(e,3792,3801,!0,r);case 37:return gF(e,6160,6169,!0,r);case 38:return gF(e,4160,4169,!0,r);case 39:return gF(e,2918,2927,!0,r);case 40:return gF(e,1776,1785,!0,r);case 43:return gF(e,3046,3055,!0,r);case 44:return gF(e,3174,3183,!0,r);case 45:return gF(e,3664,3673,!0,r);case 46:return gF(e,3872,3881,!0,r);default:return gF(e,48,57,!0,r)}},bF=function(){function e(e,t,i){if(this.context=e,this.options=i,this.scrolledElements=[],this.referenceElement=t,this.counters=new AF,this.quoteDepth=0,!t.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(t.ownerDocument.documentElement,!1)}return e.prototype.toIFrame=function(e,t){var i=this,r=BF(e,t);if(!r.contentWindow)return Promise.reject("Unable to find iframe window");var n=e.defaultView.pageXOffset,s=e.defaultView.pageYOffset,o=r.contentWindow,a=o.document,l=CF(r).then((function(){return Qw(i,void 0,void 0,(function(){var e,i;return Hw(this,(function(n){switch(n.label){case 0:return this.scrolledElements.forEach(IF),o&&(o.scrollTo(t.left,t.top),!/(iPad|iPhone|iPod)/g.test(navigator.userAgent)||o.scrollY===t.top&&o.scrollX===t.left||(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(o.scrollX-t.left,o.scrollY-t.top,0,0))),e=this.options.onclone,void 0===(i=this.clonedReferenceElement)?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:a.fonts&&a.fonts.ready?[4,a.fonts.ready]:[3,2];case 1:n.sent(),n.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,PF(a)]:[3,4];case 3:n.sent(),n.label=4;case 4:return"function"==typeof e?[2,Promise.resolve().then((function(){return e(a,i)})).then((function(){return r}))]:[2,r]}}))}))}));return a.open(),a.write(kF(document.doctype)+"<html></html>"),EF(this.referenceElement.ownerDocument,n,s),a.replaceChild(a.adoptNode(this.documentElement),a.documentElement),a.close(),l},e.prototype.createElementClone=function(e){if(XC(e,2),tF(e))return this.createCanvasClone(e);if(iF(e))return this.createVideoClone(e);if(sF(e))return this.createStyleClone(e);var t=e.cloneNode(!1);return rF(t)&&(rF(e)&&e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),"lazy"===t.loading&&(t.loading="eager")),uF(t)?this.createCustomElementClone(t):t},e.prototype.createCustomElementClone=function(e){var t=document.createElement("html2canvascustomelement");return FF(e.style,t),t},e.prototype.createStyleClone=function(e){try{var t=e.sheet;if(t&&t.cssRules){var i=[].slice.call(t.cssRules,0).reduce((function(e,t){return t&&"string"==typeof t.cssText?e+t.cssText:e}),""),r=e.cloneNode(!1);return r.textContent=i,r}}catch(e){if(this.context.logger.error("Unable to access cssRules property",e),"SecurityError"!==e.name)throw e}return e.cloneNode(!1)},e.prototype.createCanvasClone=function(e){var t;if(this.options.inlineImages&&e.ownerDocument){var i=e.ownerDocument.createElement("img");try{return i.src=e.toDataURL(),i}catch(t){this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var r=e.cloneNode(!1);try{r.width=e.width,r.height=e.height;var n=e.getContext("2d"),s=r.getContext("2d");if(s)if(!this.options.allowTaint&&n)s.putImageData(n.getImageData(0,0,e.width,e.height),0,0);else{var o=null!==(t=e.getContext("webgl2"))&&void 0!==t?t:e.getContext("webgl");if(o){var a=o.getContextAttributes();!1===(null==a?void 0:a.preserveDrawingBuffer)&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}s.drawImage(e,0,0)}return r}catch(t){this.context.logger.info("Unable to clone canvas as it is tainted",e)}return r},e.prototype.createVideoClone=function(e){var t=e.ownerDocument.createElement("canvas");t.width=e.offsetWidth,t.height=e.offsetHeight;var i=t.getContext("2d");try{return i&&(i.drawImage(e,0,0,t.width,t.height),this.options.allowTaint||i.getImageData(0,0,t.width,t.height)),t}catch(t){this.context.logger.info("Unable to clone video as it is tainted",e)}var r=e.ownerDocument.createElement("canvas");return r.width=e.offsetWidth,r.height=e.offsetHeight,r},e.prototype.appendChildNode=function(e,t,i){XM(t)&&("SCRIPT"===t.tagName||t.hasAttribute("data-html2canvas-ignore")||"function"==typeof this.options.ignoreElements&&this.options.ignoreElements(t))||this.options.copyStyles&&XM(t)&&sF(t)||e.appendChild(this.cloneNode(t,i))},e.prototype.cloneChildNodes=function(e,t,i){for(var r=this,n=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;n;n=n.nextSibling)if(XM(n)&&lF(n)&&"function"==typeof n.assignedNodes){var s=n.assignedNodes();s.length&&s.forEach((function(e){return r.appendChildNode(t,e,i)}))}else this.appendChildNode(t,n,i)},e.prototype.cloneNode=function(e,t){if(WM(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var i=e.ownerDocument.defaultView;if(i&&XM(e)&&(KM(e)||ZM(e))){var r=this.createElementClone(e);r.style.transitionProperty="none";var n=i.getComputedStyle(e),s=i.getComputedStyle(e,":before"),o=i.getComputedStyle(e,":after");this.referenceElement===e&&KM(r)&&(this.clonedReferenceElement=r),eF(r)&&SF(r);var a=this.counters.parse(new zC(this.context,n)),l=this.resolvePseudoContent(e,r,s,rM.BEFORE);uF(e)&&(t=!0),iF(e)||this.cloneChildNodes(e,r,t),l&&r.insertBefore(l,r.firstChild);var u=this.resolvePseudoContent(e,r,o,rM.AFTER);return u&&r.appendChild(u),this.counters.pop(a),(n&&(this.options.copyStyles||ZM(e))&&!nF(e)||t)&&FF(n,r),0===e.scrollTop&&0===e.scrollLeft||this.scrolledElements.push([r,e.scrollLeft,e.scrollTop]),(oF(e)||aF(e))&&(oF(r)||aF(r))&&(r.value=e.value),r}return e.cloneNode(!1)},e.prototype.resolvePseudoContent=function(e,t,i,r){var n=this;if(i){var s=i.content,o=t.ownerDocument;if(o&&s&&"none"!==s&&"-moz-alt-content"!==s&&"none"!==i.display){this.counters.parse(new zC(this.context,i));var a=new jC(this.context,i),l=o.createElement("html2canvaspseudoelement");FF(i,l),a.content.forEach((function(t){if(0===t.type)l.appendChild(o.createTextNode(t.value));else if(22===t.type){var i=o.createElement("img");i.src=t.value,i.style.opacity="1",l.appendChild(i)}else if(18===t.type){if("attr"===t.name){var r=t.values.filter(xx);r.length&&l.appendChild(o.createTextNode(e.getAttribute(r[0].value)||""))}else if("counter"===t.name){var s=t.values.filter(Fx),u=s[0],A=s[1];if(u&&xx(u)){var c=n.counters.getCounterValue(u.value),h=A&&xx(A)?qP.parse(n.context,A.value):3;l.appendChild(o.createTextNode(yF(c,h,!1)))}}else if("counters"===t.name){var d=t.values.filter(Fx),p=(u=d[0],d[1]);A=d[2];if(u&&xx(u)){var f=n.counters.getCounterValues(u.value),v=A&&xx(A)?qP.parse(n.context,A.value):3,g=p&&0===p.type?p.value:"",m=f.map((function(e){return yF(e,v,!1)})).join(g);l.appendChild(o.createTextNode(m))}}}else if(20===t.type)switch(t.value){case"open-quote":l.appendChild(o.createTextNode(OC(a.quotes,n.quoteDepth++,!0)));break;case"close-quote":l.appendChild(o.createTextNode(OC(a.quotes,--n.quoteDepth,!1)));break;default:l.appendChild(o.createTextNode(t.value))}})),l.className=TF+" "+DF;var u=r===rM.BEFORE?" "+TF:" "+DF;return ZM(t)?t.className.baseValue+=u:t.className+=u,l}}},e.destroy=function(e){return!!e.parentNode&&(e.parentNode.removeChild(e),!0)},e}();!function(e){e[e.BEFORE=0]="BEFORE",e[e.AFTER=1]="AFTER"}(rM||(rM={}));var wF,BF=function(e,t){var i=e.createElement("iframe");return i.className="html2canvas-container",i.style.visibility="hidden",i.style.position="fixed",i.style.left="-10000px",i.style.top="0px",i.style.border="0",i.width=t.width.toString(),i.height=t.height.toString(),i.scrolling="no",i.setAttribute("data-html2canvas-ignore","true"),e.body.appendChild(i),i},xF=function(e){return new Promise((function(t){e.complete?t():e.src?(e.onload=t,e.onerror=t):t()}))},PF=function(e){return Promise.all([].slice.call(e.images,0).map(xF))},CF=function(e){return new Promise((function(t,i){var r=e.contentWindow;if(!r)return i("No window assigned for iframe");var n=r.document;r.onload=e.onload=function(){r.onload=e.onload=null;var i=setInterval((function(){n.body.childNodes.length>0&&"complete"===n.readyState&&(clearInterval(i),t(e))}),50)}}))},MF=["all","d","content"],FF=function(e,t){for(var i=e.length-1;i>=0;i--){var r=e.item(i);-1===MF.indexOf(r)&&t.style.setProperty(r,e.getPropertyValue(r))}return t},kF=function(e){var t="";return e&&(t+="<!DOCTYPE ",e.name&&(t+=e.name),e.internalSubset&&(t+=e.internalSubset),e.publicId&&(t+='"'+e.publicId+'"'),e.systemId&&(t+='"'+e.systemId+'"'),t+=">"),t},EF=function(e,t,i){e&&e.defaultView&&(t!==e.defaultView.pageXOffset||i!==e.defaultView.pageYOffset)&&e.defaultView.scrollTo(t,i)},IF=function(e){var t=e[0],i=e[1],r=e[2];t.scrollLeft=i,t.scrollTop=r},TF="___html2canvas___pseudoelement_before",DF="___html2canvas___pseudoelement_after",SF=function(e){RF(e,"."+TF+':before{\n    content: "" !important;\n    display: none !important;\n}\n         .'+DF+':after{\n    content: "" !important;\n    display: none !important;\n}')},RF=function(e,t){var i=e.ownerDocument;if(i){var r=i.createElement("style");r.textContent=t,e.appendChild(r)}},UF=function(){function e(){}return e.getOrigin=function(t){var i=e._link;return i?(i.href=t,i.href=i.href,i.protocol+i.hostname+i.port):"about:blank"},e.isSameOrigin=function(t){return e.getOrigin(t)===e._origin},e.setContext=function(t){e._link=t.document.createElement("a"),e._origin=e.getOrigin(t.location.href)},e._origin="about:blank",e}(),LF=function(){function e(e,t){this.context=e,this._options=t,this._cache={}}return e.prototype.addImage=function(e){var t=Promise.resolve();return this.has(e)?t:jF(e)||QF(e)?((this._cache[e]=this.loadImage(e)).catch((function(){})),t):t},e.prototype.match=function(e){return this._cache[e]},e.prototype.loadImage=function(e){return Qw(this,void 0,void 0,(function(){var t,i,r,n,s=this;return Hw(this,(function(o){switch(o.label){case 0:return t=UF.isSameOrigin(e),i=!HF(e)&&!0===this._options.useCORS&&vM.SUPPORT_CORS_IMAGES&&!t,r=!HF(e)&&!t&&!jF(e)&&"string"==typeof this._options.proxy&&vM.SUPPORT_CORS_XHR&&!i,t||!1!==this._options.allowTaint||HF(e)||jF(e)||r||i?(n=e,r?[4,this.proxy(n)]:[3,2]):[2];case 1:n=o.sent(),o.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise((function(e,t){var r=new Image;r.onload=function(){return e(r)},r.onerror=t,(GF(n)||i)&&(r.crossOrigin="anonymous"),r.src=n,!0===r.complete&&setTimeout((function(){return e(r)}),500),s._options.imageTimeout>0&&setTimeout((function(){return t("Timed out ("+s._options.imageTimeout+"ms) loading image")}),s._options.imageTimeout)}))];case 3:return[2,o.sent()]}}))}))},e.prototype.has=function(e){return void 0!==this._cache[e]},e.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},e.prototype.proxy=function(e){var t=this,i=this._options.proxy;if(!i)throw new Error("No proxy defined");var r=e.substring(0,256);return new Promise((function(n,s){var o=vM.SUPPORT_RESPONSE_TYPE?"blob":"text",a=new XMLHttpRequest;a.onload=function(){if(200===a.status)if("text"===o)n(a.response);else{var e=new FileReader;e.addEventListener("load",(function(){return n(e.result)}),!1),e.addEventListener("error",(function(e){return s(e)}),!1),e.readAsDataURL(a.response)}else s("Failed to proxy resource "+r+" with status code "+a.status)},a.onerror=s;var l=i.indexOf("?")>-1?"&":"?";if(a.open("GET",""+i+l+"url="+encodeURIComponent(e)+"&responseType="+o),"text"!==o&&a instanceof XMLHttpRequest&&(a.responseType=o),t._options.imageTimeout){var u=t._options.imageTimeout;a.timeout=u,a.ontimeout=function(){return s("Timed out ("+u+"ms) proxying "+r)}}a.send()}))},e}(),OF=/^data:image\/svg\+xml/i,NF=/^data:image\/.*;base64,/i,VF=/^data:image\/.*/i,QF=function(e){return vM.SUPPORT_SVG_DRAWING||!zF(e)},HF=function(e){return VF.test(e)},GF=function(e){return NF.test(e)},jF=function(e){return"blob"===e.substr(0,4)},zF=function(e){return"svg"===e.substr(-3).toLowerCase()||OF.test(e)},WF=function(){function e(e,t){this.type=0,this.x=e,this.y=t}return e.prototype.add=function(t,i){return new e(this.x+t,this.y+i)},e}(),XF=function(e,t,i){return new WF(e.x+(t.x-e.x)*i,e.y+(t.y-e.y)*i)},KF=function(){function e(e,t,i,r){this.type=1,this.start=e,this.startControl=t,this.endControl=i,this.end=r}return e.prototype.subdivide=function(t,i){var r=XF(this.start,this.startControl,t),n=XF(this.startControl,this.endControl,t),s=XF(this.endControl,this.end,t),o=XF(r,n,t),a=XF(n,s,t),l=XF(o,a,t);return i?new e(this.start,r,o,l):new e(l,a,s,this.end)},e.prototype.add=function(t,i){return new e(this.start.add(t,i),this.startControl.add(t,i),this.endControl.add(t,i),this.end.add(t,i))},e.prototype.reverse=function(){return new e(this.end,this.endControl,this.startControl,this.start)},e}(),ZF=function(e){return 1===e.type},JF=function(e){var t=e.styles,i=e.bounds,r=Lx(t.borderTopLeftRadius,i.width,i.height),n=r[0],s=r[1],o=Lx(t.borderTopRightRadius,i.width,i.height),a=o[0],l=o[1],u=Lx(t.borderBottomRightRadius,i.width,i.height),A=u[0],c=u[1],h=Lx(t.borderBottomLeftRadius,i.width,i.height),d=h[0],p=h[1],f=[];f.push((n+a)/i.width),f.push((d+A)/i.width),f.push((s+p)/i.height),f.push((l+c)/i.height);var v=Math.max.apply(Math,f);v>1&&(n/=v,s/=v,a/=v,l/=v,A/=v,c/=v,d/=v,p/=v);var g=i.width-a,m=i.height-c,_=i.width-A,y=i.height-p,b=t.borderTopWidth,w=t.borderRightWidth,B=t.borderBottomWidth,x=t.borderLeftWidth,P=Ox(t.paddingTop,e.bounds.width),C=Ox(t.paddingRight,e.bounds.width),M=Ox(t.paddingBottom,e.bounds.width),F=Ox(t.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=n>0||s>0?YF(i.left+x/3,i.top+b/3,n-x/3,s-b/3,wF.TOP_LEFT):new WF(i.left+x/3,i.top+b/3),this.topRightBorderDoubleOuterBox=n>0||s>0?YF(i.left+g,i.top+b/3,a-w/3,l-b/3,wF.TOP_RIGHT):new WF(i.left+i.width-w/3,i.top+b/3),this.bottomRightBorderDoubleOuterBox=A>0||c>0?YF(i.left+_,i.top+m,A-w/3,c-B/3,wF.BOTTOM_RIGHT):new WF(i.left+i.width-w/3,i.top+i.height-B/3),this.bottomLeftBorderDoubleOuterBox=d>0||p>0?YF(i.left+x/3,i.top+y,d-x/3,p-B/3,wF.BOTTOM_LEFT):new WF(i.left+x/3,i.top+i.height-B/3),this.topLeftBorderDoubleInnerBox=n>0||s>0?YF(i.left+2*x/3,i.top+2*b/3,n-2*x/3,s-2*b/3,wF.TOP_LEFT):new WF(i.left+2*x/3,i.top+2*b/3),this.topRightBorderDoubleInnerBox=n>0||s>0?YF(i.left+g,i.top+2*b/3,a-2*w/3,l-2*b/3,wF.TOP_RIGHT):new WF(i.left+i.width-2*w/3,i.top+2*b/3),this.bottomRightBorderDoubleInnerBox=A>0||c>0?YF(i.left+_,i.top+m,A-2*w/3,c-2*B/3,wF.BOTTOM_RIGHT):new WF(i.left+i.width-2*w/3,i.top+i.height-2*B/3),this.bottomLeftBorderDoubleInnerBox=d>0||p>0?YF(i.left+2*x/3,i.top+y,d-2*x/3,p-2*B/3,wF.BOTTOM_LEFT):new WF(i.left+2*x/3,i.top+i.height-2*B/3),this.topLeftBorderStroke=n>0||s>0?YF(i.left+x/2,i.top+b/2,n-x/2,s-b/2,wF.TOP_LEFT):new WF(i.left+x/2,i.top+b/2),this.topRightBorderStroke=n>0||s>0?YF(i.left+g,i.top+b/2,a-w/2,l-b/2,wF.TOP_RIGHT):new WF(i.left+i.width-w/2,i.top+b/2),this.bottomRightBorderStroke=A>0||c>0?YF(i.left+_,i.top+m,A-w/2,c-B/2,wF.BOTTOM_RIGHT):new WF(i.left+i.width-w/2,i.top+i.height-B/2),this.bottomLeftBorderStroke=d>0||p>0?YF(i.left+x/2,i.top+y,d-x/2,p-B/2,wF.BOTTOM_LEFT):new WF(i.left+x/2,i.top+i.height-B/2),this.topLeftBorderBox=n>0||s>0?YF(i.left,i.top,n,s,wF.TOP_LEFT):new WF(i.left,i.top),this.topRightBorderBox=a>0||l>0?YF(i.left+g,i.top,a,l,wF.TOP_RIGHT):new WF(i.left+i.width,i.top),this.bottomRightBorderBox=A>0||c>0?YF(i.left+_,i.top+m,A,c,wF.BOTTOM_RIGHT):new WF(i.left+i.width,i.top+i.height),this.bottomLeftBorderBox=d>0||p>0?YF(i.left,i.top+y,d,p,wF.BOTTOM_LEFT):new WF(i.left,i.top+i.height),this.topLeftPaddingBox=n>0||s>0?YF(i.left+x,i.top+b,Math.max(0,n-x),Math.max(0,s-b),wF.TOP_LEFT):new WF(i.left+x,i.top+b),this.topRightPaddingBox=a>0||l>0?YF(i.left+Math.min(g,i.width-w),i.top+b,g>i.width+w?0:Math.max(0,a-w),Math.max(0,l-b),wF.TOP_RIGHT):new WF(i.left+i.width-w,i.top+b),this.bottomRightPaddingBox=A>0||c>0?YF(i.left+Math.min(_,i.width-x),i.top+Math.min(m,i.height-B),Math.max(0,A-w),Math.max(0,c-B),wF.BOTTOM_RIGHT):new WF(i.left+i.width-w,i.top+i.height-B),this.bottomLeftPaddingBox=d>0||p>0?YF(i.left+x,i.top+Math.min(y,i.height-B),Math.max(0,d-x),Math.max(0,p-B),wF.BOTTOM_LEFT):new WF(i.left+x,i.top+i.height-B),this.topLeftContentBox=n>0||s>0?YF(i.left+x+F,i.top+b+P,Math.max(0,n-(x+F)),Math.max(0,s-(b+P)),wF.TOP_LEFT):new WF(i.left+x+F,i.top+b+P),this.topRightContentBox=a>0||l>0?YF(i.left+Math.min(g,i.width+x+F),i.top+b+P,g>i.width+x+F?0:a-x+F,l-(b+P),wF.TOP_RIGHT):new WF(i.left+i.width-(w+C),i.top+b+P),this.bottomRightContentBox=A>0||c>0?YF(i.left+Math.min(_,i.width-(x+F)),i.top+Math.min(m,i.height+b+P),Math.max(0,A-(w+C)),c-(B+M),wF.BOTTOM_RIGHT):new WF(i.left+i.width-(w+C),i.top+i.height-(B+M)),this.bottomLeftContentBox=d>0||p>0?YF(i.left+x+F,i.top+y,Math.max(0,d-(x+F)),p-(B+M),wF.BOTTOM_LEFT):new WF(i.left+x+F,i.top+i.height-(B+M))};!function(e){e[e.TOP_LEFT=0]="TOP_LEFT",e[e.TOP_RIGHT=1]="TOP_RIGHT",e[e.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",e[e.BOTTOM_LEFT=3]="BOTTOM_LEFT"}(wF||(wF={}));var YF=function(e,t,i,r,n){var s=(Math.sqrt(2)-1)/3*4,o=i*s,a=r*s,l=e+i,u=t+r;switch(n){case wF.TOP_LEFT:return new KF(new WF(e,u),new WF(e,u-a),new WF(l-o,t),new WF(l,t));case wF.TOP_RIGHT:return new KF(new WF(e,t),new WF(e+o,t),new WF(l,u-a),new WF(l,u));case wF.BOTTOM_RIGHT:return new KF(new WF(l,t),new WF(l,t+a),new WF(e+o,u),new WF(e,u));case wF.BOTTOM_LEFT:default:return new KF(new WF(l,u),new WF(l-o,u),new WF(e,t+a),new WF(e,t))}},qF=function(e){return[e.topLeftBorderBox,e.topRightBorderBox,e.bottomRightBorderBox,e.bottomLeftBorderBox]},$F=function(e){return[e.topLeftPaddingBox,e.topRightPaddingBox,e.bottomRightPaddingBox,e.bottomLeftPaddingBox]},ek=function(e,t,i){this.offsetX=e,this.offsetY=t,this.matrix=i,this.type=0,this.target=6},tk=function(e,t){this.path=e,this.target=t,this.type=1},ik=function(e){this.opacity=e,this.type=2,this.target=6},rk=function(e){return 1===e.type},nk=function(e,t){return e.length===t.length&&e.some((function(e,i){return e===t[i]}))},sk=function(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]},ok=function(){function e(e,t){if(this.container=e,this.parent=t,this.effects=[],this.curves=new JF(this.container),this.container.styles.opacity<1&&this.effects.push(new ik(this.container.styles.opacity)),null!==this.container.styles.transform){var i=this.container.bounds.left+this.container.styles.transformOrigin[0].number,r=this.container.bounds.top+this.container.styles.transformOrigin[1].number,n=this.container.styles.transform;this.effects.push(new ek(i,r,n))}if(0!==this.container.styles.overflowX){var s=qF(this.curves),o=$F(this.curves);nk(s,o)?this.effects.push(new tk(s,6)):(this.effects.push(new tk(s,2)),this.effects.push(new tk(o,4)))}}return e.prototype.getEffects=function(e){for(var t=-1===[2,3].indexOf(this.container.styles.position),i=this.parent,r=this.effects.slice(0);i;){var n=i.effects.filter((function(e){return!rk(e)}));if(t||0!==i.container.styles.position||!i.parent){if(r.unshift.apply(r,n),t=-1===[2,3].indexOf(i.container.styles.position),0!==i.container.styles.overflowX){var s=qF(i.curves),o=$F(i.curves);nk(s,o)||r.unshift(new tk(o,6))}}else r.unshift.apply(r,n);i=i.parent}return r.filter((function(t){return TC(t.target,e)}))},e}(),ak=function e(t,i,r,n){t.container.elements.forEach((function(s){var o=TC(s.flags,4),a=TC(s.flags,2),l=new ok(s,t);TC(s.styles.display,2048)&&n.push(l);var u=TC(s.flags,8)?[]:n;if(o||a){var A=o||s.styles.isPositioned()?r:i,c=new sk(l);if(s.styles.isPositioned()||s.styles.opacity<1||s.styles.isTransformed()){var h=s.styles.zIndex.order;if(h<0){var d=0;A.negativeZIndex.some((function(e,t){return h>e.element.container.styles.zIndex.order?(d=t,!1):d>0})),A.negativeZIndex.splice(d,0,c)}else if(h>0){var p=0;A.positiveZIndex.some((function(e,t){return h>=e.element.container.styles.zIndex.order?(p=t+1,!1):p>0})),A.positiveZIndex.splice(p,0,c)}else A.zeroOrAutoZIndexOrTransformedOrOpacity.push(c)}else s.styles.isFloating()?A.nonPositionedFloats.push(c):A.nonPositionedInlineLevel.push(c);e(l,c,o?c:r,u)}else s.styles.isInlineLevel()?i.inlineLevel.push(l):i.nonInlineLevel.push(l),e(l,i,r,u);TC(s.flags,8)&&lk(s,u)}))},lk=function(e,t){for(var i=e instanceof TM?e.start:1,r=e instanceof TM&&e.reversed,n=0;n<t.length;n++){var s=t[n];s.container instanceof IM&&"number"==typeof s.container.value&&0!==s.container.value&&(i=s.container.value),s.listValue=yF(i,s.container.styles.listStyleType,!0),i+=r?-1:1}},uk=function(e){var t=new ok(e,null),i=new sk(t),r=[];return ak(t,i,i,r),lk(t.container,r),i},Ak=function(e,t){switch(t){case 0:return hk(e.topLeftBorderBox,e.topLeftPaddingBox,e.topRightBorderBox,e.topRightPaddingBox);case 1:return hk(e.topRightBorderBox,e.topRightPaddingBox,e.bottomRightBorderBox,e.bottomRightPaddingBox);case 2:return hk(e.bottomRightBorderBox,e.bottomRightPaddingBox,e.bottomLeftBorderBox,e.bottomLeftPaddingBox);default:return hk(e.bottomLeftBorderBox,e.bottomLeftPaddingBox,e.topLeftBorderBox,e.topLeftPaddingBox)}},ck=function(e,t){var i=[];return ZF(e)?i.push(e.subdivide(.5,!1)):i.push(e),ZF(t)?i.push(t.subdivide(.5,!0)):i.push(t),i},hk=function(e,t,i,r){var n=[];return ZF(e)?n.push(e.subdivide(.5,!1)):n.push(e),ZF(i)?n.push(i.subdivide(.5,!0)):n.push(i),ZF(r)?n.push(r.subdivide(.5,!0).reverse()):n.push(r),ZF(t)?n.push(t.subdivide(.5,!1).reverse()):n.push(t),n},dk=function(e){var t=e.bounds,i=e.styles;return t.add(i.borderLeftWidth,i.borderTopWidth,-(i.borderRightWidth+i.borderLeftWidth),-(i.borderTopWidth+i.borderBottomWidth))},pk=function(e){var t=e.styles,i=e.bounds,r=Ox(t.paddingLeft,i.width),n=Ox(t.paddingRight,i.width),s=Ox(t.paddingTop,i.width),o=Ox(t.paddingBottom,i.width);return i.add(r+t.borderLeftWidth,s+t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth+r+n),-(t.borderTopWidth+t.borderBottomWidth+s+o))},fk=function(e,t,i){var r=function(e,t){return 0===e?t.bounds:2===e?pk(t):dk(t)}(_k(e.styles.backgroundOrigin,t),e),n=function(e,t){return 0===e?t.bounds:2===e?pk(t):dk(t)}(_k(e.styles.backgroundClip,t),e),s=mk(_k(e.styles.backgroundSize,t),i,r),o=s[0],a=s[1],l=Lx(_k(e.styles.backgroundPosition,t),r.width-o,r.height-a);return[yk(_k(e.styles.backgroundRepeat,t),l,s,r,n),Math.round(r.left+l[0]),Math.round(r.top+l[1]),o,a]},vk=function(e){return xx(e)&&e.value===AP.AUTO},gk=function(e){return"number"==typeof e},mk=function(e,t,i){var r=t[0],n=t[1],s=t[2],o=e[0],a=e[1];if(!o)return[0,0];if(Tx(o)&&a&&Tx(a))return[Ox(o,i.width),Ox(a,i.height)];var l=gk(s);if(xx(o)&&(o.value===AP.CONTAIN||o.value===AP.COVER))return gk(s)?i.width/i.height<s!=(o.value===AP.COVER)?[i.width,i.width/s]:[i.height*s,i.height]:[i.width,i.height];var u=gk(r),A=gk(n),c=u||A;if(vk(o)&&(!a||vk(a)))return u&&A?[r,n]:l||c?c&&l?[u?r:n*s,A?n:r/s]:[u?r:i.width,A?n:i.height]:[i.width,i.height];if(l){var h=0,d=0;return Tx(o)?h=Ox(o,i.width):Tx(a)&&(d=Ox(a,i.height)),vk(o)?h=d*s:a&&!vk(a)||(d=h/s),[h,d]}var p=null,f=null;if(Tx(o)?p=Ox(o,i.width):a&&Tx(a)&&(f=Ox(a,i.height)),null===p||a&&!vk(a)||(f=u&&A?p/r*n:i.height),null!==f&&vk(o)&&(p=u&&A?f/n*r:i.width),null!==p&&null!==f)return[p,f];throw new Error("Unable to calculate background-size for element")},_k=function(e,t){var i=e[t];return void 0===i?e[0]:i},yk=function(e,t,i,r,n){var s=t[0],o=t[1],a=i[0],l=i[1];switch(e){case 2:return[new WF(Math.round(r.left),Math.round(r.top+o)),new WF(Math.round(r.left+r.width),Math.round(r.top+o)),new WF(Math.round(r.left+r.width),Math.round(l+r.top+o)),new WF(Math.round(r.left),Math.round(l+r.top+o))];case 3:return[new WF(Math.round(r.left+s),Math.round(r.top)),new WF(Math.round(r.left+s+a),Math.round(r.top)),new WF(Math.round(r.left+s+a),Math.round(r.height+r.top)),new WF(Math.round(r.left+s),Math.round(r.height+r.top))];case 1:return[new WF(Math.round(r.left+s),Math.round(r.top+o)),new WF(Math.round(r.left+s+a),Math.round(r.top+o)),new WF(Math.round(r.left+s+a),Math.round(r.top+o+l)),new WF(Math.round(r.left+s),Math.round(r.top+o+l))];default:return[new WF(Math.round(n.left),Math.round(n.top)),new WF(Math.round(n.left+n.width),Math.round(n.top)),new WF(Math.round(n.left+n.width),Math.round(n.height+n.top)),new WF(Math.round(n.left),Math.round(n.height+n.top))]}},bk=function(){function e(e){this._data={},this._document=e}return e.prototype.parseMetrics=function(e,t){var i=this._document.createElement("div"),r=this._document.createElement("img"),n=this._document.createElement("span"),s=this._document.body;i.style.visibility="hidden",i.style.fontFamily=e,i.style.fontSize=t,i.style.margin="0",i.style.padding="0",i.style.whiteSpace="nowrap",s.appendChild(i),r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",r.width=1,r.height=1,r.style.margin="0",r.style.padding="0",r.style.verticalAlign="baseline",n.style.fontFamily=e,n.style.fontSize=t,n.style.margin="0",n.style.padding="0",n.appendChild(this._document.createTextNode("Hidden Text")),i.appendChild(n),i.appendChild(r);var o=r.offsetTop-n.offsetTop+2;i.removeChild(n),i.appendChild(this._document.createTextNode("Hidden Text")),i.style.lineHeight="normal",r.style.verticalAlign="super";var a=r.offsetTop-i.offsetTop+2;return s.removeChild(i),{baseline:o,middle:a}},e.prototype.getMetrics=function(e,t){var i=e+" "+t;return void 0===this._data[i]&&(this._data[i]=this.parseMetrics(e,t)),this._data[i]},e}(),wk=function(e,t){this.context=e,this.options=t},Bk=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r._activeEffects=[],r.canvas=i.canvas?i.canvas:document.createElement("canvas"),r.ctx=r.canvas.getContext("2d"),i.canvas||(r.canvas.width=Math.floor(i.width*i.scale),r.canvas.height=Math.floor(i.height*i.scale),r.canvas.style.width=i.width+"px",r.canvas.style.height=i.height+"px"),r.fontMetrics=new bk(document),r.ctx.scale(r.options.scale,r.options.scale),r.ctx.translate(-i.x,-i.y),r.ctx.textBaseline="bottom",r._activeEffects=[],r.context.logger.debug("Canvas renderer initialized ("+i.width+"x"+i.height+") with scale "+i.scale),r}return Nw(t,e),t.prototype.applyEffects=function(e){for(var t=this;this._activeEffects.length;)this.popEffect();e.forEach((function(e){return t.applyEffect(e)}))},t.prototype.applyEffect=function(e){this.ctx.save(),function(e){return 2===e.type}(e)&&(this.ctx.globalAlpha=e.opacity),function(e){return 0===e.type}(e)&&(this.ctx.translate(e.offsetX,e.offsetY),this.ctx.transform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this.ctx.translate(-e.offsetX,-e.offsetY)),rk(e)&&(this.path(e.path),this.ctx.clip()),this._activeEffects.push(e)},t.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},t.prototype.renderStack=function(e){return Qw(this,void 0,void 0,(function(){return Hw(this,(function(t){switch(t.label){case 0:return e.element.container.styles.isVisible()?[4,this.renderStackContent(e)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.renderNode=function(e){return Qw(this,void 0,void 0,(function(){return Hw(this,(function(t){switch(t.label){case 0:return TC(e.container.flags,16),e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return t.sent(),[4,this.renderNodeContent(e)];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},t.prototype.renderTextWithLetterSpacing=function(e,t,i){var r=this;0===t?this.ctx.fillText(e.text,e.bounds.left,e.bounds.top+i):yM(e.text).reduce((function(t,n){return r.ctx.fillText(n,t,e.bounds.top+i),t+r.ctx.measureText(n).width}),e.bounds.left)},t.prototype.createFontStyle=function(e){var t=e.fontVariant.filter((function(e){return"normal"===e||"small-caps"===e})).join(""),i=Fk(e.fontFamily).join(", "),r=wx(e.fontSize)?""+e.fontSize.number+e.fontSize.unit:e.fontSize.number+"px";return[[e.fontStyle,t,e.fontWeight,r,i].join(" "),i,r]},t.prototype.renderTextNode=function(e,t){return Qw(this,void 0,void 0,(function(){var i,r,n,s,o,a,l,u,A=this;return Hw(this,(function(c){return i=this.createFontStyle(t),r=i[0],n=i[1],s=i[2],this.ctx.font=r,this.ctx.direction=1===t.direction?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",o=this.fontMetrics.getMetrics(n,s),a=o.baseline,l=o.middle,u=t.paintOrder,e.textBounds.forEach((function(e){u.forEach((function(i){switch(i){case 0:A.ctx.fillStyle=zx(t.color),A.renderTextWithLetterSpacing(e,t.letterSpacing,a);var r=t.textShadow;r.length&&e.text.trim().length&&(r.slice(0).reverse().forEach((function(i){A.ctx.shadowColor=zx(i.color),A.ctx.shadowOffsetX=i.offsetX.number*A.options.scale,A.ctx.shadowOffsetY=i.offsetY.number*A.options.scale,A.ctx.shadowBlur=i.blur.number,A.renderTextWithLetterSpacing(e,t.letterSpacing,a)})),A.ctx.shadowColor="",A.ctx.shadowOffsetX=0,A.ctx.shadowOffsetY=0,A.ctx.shadowBlur=0),t.textDecorationLine.length&&(A.ctx.fillStyle=zx(t.textDecorationColor||t.color),t.textDecorationLine.forEach((function(t){switch(t){case 1:A.ctx.fillRect(e.bounds.left,Math.round(e.bounds.top+a),e.bounds.width,1);break;case 2:A.ctx.fillRect(e.bounds.left,Math.round(e.bounds.top),e.bounds.width,1);break;case 3:A.ctx.fillRect(e.bounds.left,Math.ceil(e.bounds.top+l),e.bounds.width,1)}})));break;case 1:t.webkitTextStrokeWidth&&e.text.trim().length&&(A.ctx.strokeStyle=zx(t.webkitTextStrokeColor),A.ctx.lineWidth=t.webkitTextStrokeWidth,A.ctx.lineJoin=window.chrome?"miter":"round",A.ctx.strokeText(e.text,e.bounds.left,e.bounds.top+a)),A.ctx.strokeStyle="",A.ctx.lineWidth=0,A.ctx.lineJoin="miter"}}))})),[2]}))}))},t.prototype.renderReplacedElement=function(e,t,i){if(i&&e.intrinsicWidth>0&&e.intrinsicHeight>0){var r=pk(e),n=$F(t);this.path(n),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(i,0,0,e.intrinsicWidth,e.intrinsicHeight,r.left,r.top,r.width,r.height),this.ctx.restore()}},t.prototype.renderNodeContent=function(e){return Qw(this,void 0,void 0,(function(){var i,r,n,s,o,a,l,u,A,c,h,d,p,f,v,g,m,_;return Hw(this,(function(y){switch(y.label){case 0:this.applyEffects(e.getEffects(4)),i=e.container,r=e.curves,n=i.styles,s=0,o=i.textNodes,y.label=1;case 1:return s<o.length?(a=o[s],[4,this.renderTextNode(a,n)]):[3,4];case 2:y.sent(),y.label=3;case 3:return s++,[3,1];case 4:if(!(i instanceof FM))return[3,8];y.label=5;case 5:return y.trys.push([5,7,,8]),[4,this.context.cache.match(i.src)];case 6:return v=y.sent(),this.renderReplacedElement(i,r,v),[3,8];case 7:return y.sent(),this.context.logger.error("Error loading image "+i.src),[3,8];case 8:if(i instanceof kM&&this.renderReplacedElement(i,r,i.canvas),!(i instanceof EM))return[3,12];y.label=9;case 9:return y.trys.push([9,11,,12]),[4,this.context.cache.match(i.svg)];case 10:return v=y.sent(),this.renderReplacedElement(i,r,v),[3,12];case 11:return y.sent(),this.context.logger.error("Error loading svg "+i.svg.substring(0,255)),[3,12];case 12:return i instanceof NM&&i.tree?[4,new t(this.context,{scale:this.options.scale,backgroundColor:i.backgroundColor,x:0,y:0,width:i.width,height:i.height}).render(i.tree)]:[3,14];case 13:l=y.sent(),i.width&&i.height&&this.ctx.drawImage(l,0,0,i.width,i.height,i.bounds.left,i.bounds.top,i.bounds.width,i.bounds.height),y.label=14;case 14:if(i instanceof UM&&(u=Math.min(i.bounds.width,i.bounds.height),"checkbox"===i.type?i.checked&&(this.ctx.save(),this.path([new WF(i.bounds.left+.39363*u,i.bounds.top+.79*u),new WF(i.bounds.left+.16*u,i.bounds.top+.5549*u),new WF(i.bounds.left+.27347*u,i.bounds.top+.44071*u),new WF(i.bounds.left+.39694*u,i.bounds.top+.5649*u),new WF(i.bounds.left+.72983*u,i.bounds.top+.23*u),new WF(i.bounds.left+.84*u,i.bounds.top+.34085*u),new WF(i.bounds.left+.39363*u,i.bounds.top+.79*u)]),this.ctx.fillStyle=zx(707406591),this.ctx.fill(),this.ctx.restore()):"radio"===i.type&&i.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i.bounds.left+u/2,i.bounds.top+u/2,u/4,0,2*Math.PI,!0),this.ctx.fillStyle=zx(707406591),this.ctx.fill(),this.ctx.restore())),xk(i)&&i.value.length){switch(A=this.createFontStyle(n),m=A[0],c=A[1],h=this.fontMetrics.getMetrics(m,c).baseline,this.ctx.font=m,this.ctx.fillStyle=zx(n.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=Ck(i.styles.textAlign),_=pk(i),d=0,i.styles.textAlign){case 1:d+=_.width/2;break;case 2:d+=_.width}p=_.add(d,0,0,-_.height/2+1),this.ctx.save(),this.path([new WF(_.left,_.top),new WF(_.left+_.width,_.top),new WF(_.left+_.width,_.top+_.height),new WF(_.left,_.top+_.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new gM(i.value,p),n.letterSpacing,h),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!TC(i.styles.display,2048))return[3,20];if(null===i.styles.listStyleImage)return[3,19];if(0!==(f=i.styles.listStyleImage).type)return[3,18];v=void 0,g=f.url,y.label=15;case 15:return y.trys.push([15,17,,18]),[4,this.context.cache.match(g)];case 16:return v=y.sent(),this.ctx.drawImage(v,i.bounds.left-(v.width+10),i.bounds.top),[3,18];case 17:return y.sent(),this.context.logger.error("Error loading list-style-image "+g),[3,18];case 18:return[3,20];case 19:e.listValue&&-1!==i.styles.listStyleType&&(m=this.createFontStyle(n)[0],this.ctx.font=m,this.ctx.fillStyle=zx(n.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",_=new jw(i.bounds.left,i.bounds.top+Ox(i.styles.paddingTop,i.bounds.width),i.bounds.width,ZP(n.lineHeight,n.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new gM(e.listValue,_),n.letterSpacing,ZP(n.lineHeight,n.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),y.label=20;case 20:return[2]}}))}))},t.prototype.renderStackContent=function(e){return Qw(this,void 0,void 0,(function(){var t,i,r,n,s,o,a,l,u,A,c,h,d,p,f;return Hw(this,(function(v){switch(v.label){case 0:return TC(e.element.container.flags,16),[4,this.renderNodeBackgroundAndBorders(e.element)];case 1:v.sent(),t=0,i=e.negativeZIndex,v.label=2;case 2:return t<i.length?(f=i[t],[4,this.renderStack(f)]):[3,5];case 3:v.sent(),v.label=4;case 4:return t++,[3,2];case 5:return[4,this.renderNodeContent(e.element)];case 6:v.sent(),r=0,n=e.nonInlineLevel,v.label=7;case 7:return r<n.length?(f=n[r],[4,this.renderNode(f)]):[3,10];case 8:v.sent(),v.label=9;case 9:return r++,[3,7];case 10:s=0,o=e.nonPositionedFloats,v.label=11;case 11:return s<o.length?(f=o[s],[4,this.renderStack(f)]):[3,14];case 12:v.sent(),v.label=13;case 13:return s++,[3,11];case 14:a=0,l=e.nonPositionedInlineLevel,v.label=15;case 15:return a<l.length?(f=l[a],[4,this.renderStack(f)]):[3,18];case 16:v.sent(),v.label=17;case 17:return a++,[3,15];case 18:u=0,A=e.inlineLevel,v.label=19;case 19:return u<A.length?(f=A[u],[4,this.renderNode(f)]):[3,22];case 20:v.sent(),v.label=21;case 21:return u++,[3,19];case 22:c=0,h=e.zeroOrAutoZIndexOrTransformedOrOpacity,v.label=23;case 23:return c<h.length?(f=h[c],[4,this.renderStack(f)]):[3,26];case 24:v.sent(),v.label=25;case 25:return c++,[3,23];case 26:d=0,p=e.positiveZIndex,v.label=27;case 27:return d<p.length?(f=p[d],[4,this.renderStack(f)]):[3,30];case 28:v.sent(),v.label=29;case 29:return d++,[3,27];case 30:return[2]}}))}))},t.prototype.mask=function(e){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(e.slice(0).reverse()),this.ctx.closePath()},t.prototype.path=function(e){this.ctx.beginPath(),this.formatPath(e),this.ctx.closePath()},t.prototype.formatPath=function(e){var t=this;e.forEach((function(e,i){var r=ZF(e)?e.start:e;0===i?t.ctx.moveTo(r.x,r.y):t.ctx.lineTo(r.x,r.y),ZF(e)&&t.ctx.bezierCurveTo(e.startControl.x,e.startControl.y,e.endControl.x,e.endControl.y,e.end.x,e.end.y)}))},t.prototype.renderRepeat=function(e,t,i,r){this.path(e),this.ctx.fillStyle=t,this.ctx.translate(i,r),this.ctx.fill(),this.ctx.translate(-i,-r)},t.prototype.resizeImage=function(e,t,i){var r;if(e.width===t&&e.height===i)return e;var n=(null!==(r=this.canvas.ownerDocument)&&void 0!==r?r:document).createElement("canvas");return n.width=Math.max(1,t),n.height=Math.max(1,i),n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,i),n},t.prototype.renderBackgroundImage=function(e){return Qw(this,void 0,void 0,(function(){var t,i,r,n,s,o;return Hw(this,(function(a){switch(a.label){case 0:t=e.styles.backgroundImage.length-1,i=function(i){var n,s,o,a,l,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B,x,P,C,M,F,k,E,I,T,D,S;return Hw(this,(function(R){switch(R.label){case 0:if(0!==i.type)return[3,5];n=void 0,s=i.url,R.label=1;case 1:return R.trys.push([1,3,,4]),[4,r.context.cache.match(s)];case 2:return n=R.sent(),[3,4];case 3:return R.sent(),r.context.logger.error("Error loading background-image "+s),[3,4];case 4:return n&&(o=fk(e,t,[n.width,n.height,n.width/n.height]),_=o[0],P=o[1],C=o[2],w=o[3],B=o[4],g=r.ctx.createPattern(r.resizeImage(n,w,B),"repeat"),r.renderRepeat(_,g,P,C)),[3,6];case 5:1===i.type?(a=fk(e,t,[null,null,null]),_=a[0],P=a[1],C=a[2],w=a[3],B=a[4],l=nP(i.angle,w,B),u=l[0],A=l[1],c=l[2],h=l[3],d=l[4],(p=document.createElement("canvas")).width=w,p.height=B,f=p.getContext("2d"),v=f.createLinearGradient(A,h,c,d),rP(i.stops,u).forEach((function(e){return v.addColorStop(e.stop,zx(e.color))})),f.fillStyle=v,f.fillRect(0,0,w,B),w>0&&B>0&&(g=r.ctx.createPattern(p,"repeat"),r.renderRepeat(_,g,P,C))):function(e){return 2===e.type}(i)&&(m=fk(e,t,[null,null,null]),_=m[0],y=m[1],b=m[2],w=m[3],B=m[4],x=0===i.position.length?[Rx]:i.position,P=Ox(x[0],w),C=Ox(x[x.length-1],B),M=function(e,t,i,r,n){var s=0,o=0;switch(e.size){case 0:0===e.shape?s=o=Math.min(Math.abs(t),Math.abs(t-r),Math.abs(i),Math.abs(i-n)):1===e.shape&&(s=Math.min(Math.abs(t),Math.abs(t-r)),o=Math.min(Math.abs(i),Math.abs(i-n)));break;case 2:if(0===e.shape)s=o=Math.min(sP(t,i),sP(t,i-n),sP(t-r,i),sP(t-r,i-n));else if(1===e.shape){var a=Math.min(Math.abs(i),Math.abs(i-n))/Math.min(Math.abs(t),Math.abs(t-r)),l=oP(r,n,t,i,!0),u=l[0],A=l[1];o=a*(s=sP(u-t,(A-i)/a))}break;case 1:0===e.shape?s=o=Math.max(Math.abs(t),Math.abs(t-r),Math.abs(i),Math.abs(i-n)):1===e.shape&&(s=Math.max(Math.abs(t),Math.abs(t-r)),o=Math.max(Math.abs(i),Math.abs(i-n)));break;case 3:if(0===e.shape)s=o=Math.max(sP(t,i),sP(t,i-n),sP(t-r,i),sP(t-r,i-n));else if(1===e.shape){a=Math.max(Math.abs(i),Math.abs(i-n))/Math.max(Math.abs(t),Math.abs(t-r));var c=oP(r,n,t,i,!1);u=c[0],A=c[1],o=a*(s=sP(u-t,(A-i)/a))}}return Array.isArray(e.size)&&(s=Ox(e.size[0],r),o=2===e.size.length?Ox(e.size[1],n):s),[s,o]}(i,P,C,w,B),F=M[0],k=M[1],F>0&&k>0&&(E=r.ctx.createRadialGradient(y+P,b+C,0,y+P,b+C,F),rP(i.stops,2*F).forEach((function(e){return E.addColorStop(e.stop,zx(e.color))})),r.path(_),r.ctx.fillStyle=E,F!==k?(I=e.bounds.left+.5*e.bounds.width,T=e.bounds.top+.5*e.bounds.height,S=1/(D=k/F),r.ctx.save(),r.ctx.translate(I,T),r.ctx.transform(1,0,0,D,0,0),r.ctx.translate(-I,-T),r.ctx.fillRect(y,S*(b-T)+T,w,B*S),r.ctx.restore()):r.ctx.fill())),R.label=6;case 6:return t--,[2]}}))},r=this,n=0,s=e.styles.backgroundImage.slice(0).reverse(),a.label=1;case 1:return n<s.length?(o=s[n],[5,i(o)]):[3,4];case 2:a.sent(),a.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},t.prototype.renderSolidBorder=function(e,t,i){return Qw(this,void 0,void 0,(function(){return Hw(this,(function(r){return this.path(Ak(i,t)),this.ctx.fillStyle=zx(e),this.ctx.fill(),[2]}))}))},t.prototype.renderDoubleBorder=function(e,t,i,r){return Qw(this,void 0,void 0,(function(){var n,s;return Hw(this,(function(o){switch(o.label){case 0:return t<3?[4,this.renderSolidBorder(e,i,r)]:[3,2];case 1:return o.sent(),[2];case 2:return n=function(e,t){switch(t){case 0:return hk(e.topLeftBorderBox,e.topLeftBorderDoubleOuterBox,e.topRightBorderBox,e.topRightBorderDoubleOuterBox);case 1:return hk(e.topRightBorderBox,e.topRightBorderDoubleOuterBox,e.bottomRightBorderBox,e.bottomRightBorderDoubleOuterBox);case 2:return hk(e.bottomRightBorderBox,e.bottomRightBorderDoubleOuterBox,e.bottomLeftBorderBox,e.bottomLeftBorderDoubleOuterBox);default:return hk(e.bottomLeftBorderBox,e.bottomLeftBorderDoubleOuterBox,e.topLeftBorderBox,e.topLeftBorderDoubleOuterBox)}}(r,i),this.path(n),this.ctx.fillStyle=zx(e),this.ctx.fill(),s=function(e,t){switch(t){case 0:return hk(e.topLeftBorderDoubleInnerBox,e.topLeftPaddingBox,e.topRightBorderDoubleInnerBox,e.topRightPaddingBox);case 1:return hk(e.topRightBorderDoubleInnerBox,e.topRightPaddingBox,e.bottomRightBorderDoubleInnerBox,e.bottomRightPaddingBox);case 2:return hk(e.bottomRightBorderDoubleInnerBox,e.bottomRightPaddingBox,e.bottomLeftBorderDoubleInnerBox,e.bottomLeftPaddingBox);default:return hk(e.bottomLeftBorderDoubleInnerBox,e.bottomLeftPaddingBox,e.topLeftBorderDoubleInnerBox,e.topLeftPaddingBox)}}(r,i),this.path(s),this.ctx.fill(),[2]}}))}))},t.prototype.renderNodeBackgroundAndBorders=function(e){return Qw(this,void 0,void 0,(function(){var t,i,r,n,s,o,a,l,u=this;return Hw(this,(function(A){switch(A.label){case 0:return this.applyEffects(e.getEffects(2)),t=e.container.styles,i=!jx(t.backgroundColor)||t.backgroundImage.length,r=[{style:t.borderTopStyle,color:t.borderTopColor,width:t.borderTopWidth},{style:t.borderRightStyle,color:t.borderRightColor,width:t.borderRightWidth},{style:t.borderBottomStyle,color:t.borderBottomColor,width:t.borderBottomWidth},{style:t.borderLeftStyle,color:t.borderLeftColor,width:t.borderLeftWidth}],n=Pk(_k(t.backgroundClip,0),e.curves),i||t.boxShadow.length?(this.ctx.save(),this.path(n),this.ctx.clip(),jx(t.backgroundColor)||(this.ctx.fillStyle=zx(t.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(e.container)]):[3,2];case 1:A.sent(),this.ctx.restore(),t.boxShadow.slice(0).reverse().forEach((function(t){u.ctx.save();var i,r,n,s,o,a=qF(e.curves),l=t.inset?0:1e4,A=(i=a,r=-l+(t.inset?1:-1)*t.spread.number,n=(t.inset?1:-1)*t.spread.number,s=t.spread.number*(t.inset?-2:2),o=t.spread.number*(t.inset?-2:2),i.map((function(e,t){switch(t){case 0:return e.add(r,n);case 1:return e.add(r+s,n);case 2:return e.add(r+s,n+o);case 3:return e.add(r,n+o)}return e})));t.inset?(u.path(a),u.ctx.clip(),u.mask(A)):(u.mask(a),u.ctx.clip(),u.path(A)),u.ctx.shadowOffsetX=t.offsetX.number+l,u.ctx.shadowOffsetY=t.offsetY.number,u.ctx.shadowColor=zx(t.color),u.ctx.shadowBlur=t.blur.number,u.ctx.fillStyle=t.inset?zx(t.color):"rgba(0,0,0,1)",u.ctx.fill(),u.ctx.restore()})),A.label=2;case 2:s=0,o=0,a=r,A.label=3;case 3:return o<a.length?0!==(l=a[o]).style&&!jx(l.color)&&l.width>0?2!==l.style?[3,5]:[4,this.renderDashedDottedBorder(l.color,l.width,s,e.curves,2)]:[3,11]:[3,13];case 4:return A.sent(),[3,11];case 5:return 3!==l.style?[3,7]:[4,this.renderDashedDottedBorder(l.color,l.width,s,e.curves,3)];case 6:return A.sent(),[3,11];case 7:return 4!==l.style?[3,9]:[4,this.renderDoubleBorder(l.color,l.width,s,e.curves)];case 8:return A.sent(),[3,11];case 9:return[4,this.renderSolidBorder(l.color,s,e.curves)];case 10:A.sent(),A.label=11;case 11:s++,A.label=12;case 12:return o++,[3,3];case 13:return[2]}}))}))},t.prototype.renderDashedDottedBorder=function(e,t,i,r,n){return Qw(this,void 0,void 0,(function(){var s,o,a,l,u,A,c,h,d,p,f,v,g,m,_,y;return Hw(this,(function(b){return this.ctx.save(),s=function(e,t){switch(t){case 0:return ck(e.topLeftBorderStroke,e.topRightBorderStroke);case 1:return ck(e.topRightBorderStroke,e.bottomRightBorderStroke);case 2:return ck(e.bottomRightBorderStroke,e.bottomLeftBorderStroke);default:return ck(e.bottomLeftBorderStroke,e.topLeftBorderStroke)}}(r,i),o=Ak(r,i),2===n&&(this.path(o),this.ctx.clip()),ZF(o[0])?(a=o[0].start.x,l=o[0].start.y):(a=o[0].x,l=o[0].y),ZF(o[1])?(u=o[1].end.x,A=o[1].end.y):(u=o[1].x,A=o[1].y),c=0===i||2===i?Math.abs(a-u):Math.abs(l-A),this.ctx.beginPath(),3===n?this.formatPath(s):this.formatPath(o.slice(0,2)),h=t<3?3*t:2*t,d=t<3?2*t:t,3===n&&(h=t,d=t),p=!0,c<=2*h?p=!1:c<=2*h+d?(h*=f=c/(2*h+d),d*=f):(v=Math.floor((c+d)/(h+d)),g=(c-v*h)/(v-1),d=(m=(c-(v+1)*h)/v)<=0||Math.abs(d-g)<Math.abs(d-m)?g:m),p&&(3===n?this.ctx.setLineDash([0,h+d]):this.ctx.setLineDash([h,d])),3===n?(this.ctx.lineCap="round",this.ctx.lineWidth=t):this.ctx.lineWidth=2*t+1.1,this.ctx.strokeStyle=zx(e),this.ctx.stroke(),this.ctx.setLineDash([]),2===n&&(ZF(o[0])&&(_=o[3],y=o[0],this.ctx.beginPath(),this.formatPath([new WF(_.end.x,_.end.y),new WF(y.start.x,y.start.y)]),this.ctx.stroke()),ZF(o[1])&&(_=o[1],y=o[2],this.ctx.beginPath(),this.formatPath([new WF(_.end.x,_.end.y),new WF(y.start.x,y.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]}))}))},t.prototype.render=function(e){return Qw(this,void 0,void 0,(function(){var t;return Hw(this,(function(i){switch(i.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=zx(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),t=uk(e),[4,this.renderStack(t)];case 1:return i.sent(),this.applyEffects([]),[2,this.canvas]}}))}))},t}(wk),xk=function(e){return e instanceof OM||(e instanceof LM||e instanceof UM&&"radio"!==e.type&&"checkbox"!==e.type)},Pk=function(e,t){switch(e){case 0:return qF(t);case 2:return function(e){return[e.topLeftContentBox,e.topRightContentBox,e.bottomRightContentBox,e.bottomLeftContentBox]}(t);default:return $F(t)}},Ck=function(e){switch(e){case 1:return"center";case 2:return"right";default:return"left"}},Mk=["-apple-system","system-ui"],Fk=function(e){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?e.filter((function(e){return-1===Mk.indexOf(e)})):e},kk=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.canvas=i.canvas?i.canvas:document.createElement("canvas"),r.ctx=r.canvas.getContext("2d"),r.options=i,r.canvas.width=Math.floor(i.width*i.scale),r.canvas.height=Math.floor(i.height*i.scale),r.canvas.style.width=i.width+"px",r.canvas.style.height=i.height+"px",r.ctx.scale(r.options.scale,r.options.scale),r.ctx.translate(-i.x,-i.y),r.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+i.width+"x"+i.height+" at "+i.x+","+i.y+") with scale "+i.scale),r}return Nw(t,e),t.prototype.render=function(e){return Qw(this,void 0,void 0,(function(){var t,i;return Hw(this,(function(r){switch(r.label){case 0:return t=pM(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,e),[4,Ek(t)];case 1:return i=r.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=zx(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(i,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}}))}))},t}(wk),Ek=function(e){return new Promise((function(t,i){var r=new Image;r.onload=function(){t(r)},r.onerror=i,r.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(e))}))},Ik=function(){function e(e){var t=e.id,i=e.enabled;this.id=t,this.enabled=i,this.start=Date.now()}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.debug?console.debug.apply(console,Gw([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.prototype.getTime=function(){return Date.now()-this.start},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&"undefined"!=typeof window&&window.console&&"function"==typeof console.info&&console.info.apply(console,Gw([this.id,this.getTime()+"ms"],e))},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.warn?console.warn.apply(console,Gw([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.error?console.error.apply(console,Gw([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.instances={},e}(),Tk=function(){function e(t,i){var r;this.windowBounds=i,this.instanceName="#"+e.instanceCount++,this.logger=new Ik({id:this.instanceName,enabled:t.logging}),this.cache=null!==(r=t.cache)&&void 0!==r?r:new LF(this,t)}return e.instanceCount=1,e}(),Dk=function(e,t){return void 0===t&&(t={}),Sk(e,t)};"undefined"!=typeof window&&UF.setContext(window);var Sk=function(e,t){return Qw(void 0,void 0,void 0,(function(){var i,r,n,s,o,a,l,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B,x,C,M,F,k,E,I,T,D,S,R,U,L,O,N,V;return Hw(this,(function(Q){switch(Q.label){case 0:if(!e||"object"!==P(e))return[2,Promise.reject("Invalid element provided as first argument")];if(!(i=e.ownerDocument))throw new Error("Element is not attached to a Document");if(!(r=i.defaultView))throw new Error("Document is not attached to a Window");return n={allowTaint:null!==(B=t.allowTaint)&&void 0!==B&&B,imageTimeout:null!==(x=t.imageTimeout)&&void 0!==x?x:15e3,proxy:t.proxy,useCORS:null!==(C=t.useCORS)&&void 0!==C&&C},s=Vw({logging:null===(M=t.logging)||void 0===M||M,cache:t.cache},n),o={windowWidth:null!==(F=t.windowWidth)&&void 0!==F?F:r.innerWidth,windowHeight:null!==(k=t.windowHeight)&&void 0!==k?k:r.innerHeight,scrollX:null!==(E=t.scrollX)&&void 0!==E?E:r.pageXOffset,scrollY:null!==(I=t.scrollY)&&void 0!==I?I:r.pageYOffset},a=new jw(o.scrollX,o.scrollY,o.windowWidth,o.windowHeight),l=new Tk(s,a),u=null!==(T=t.foreignObjectRendering)&&void 0!==T&&T,A={allowTaint:null!==(D=t.allowTaint)&&void 0!==D&&D,onclone:t.onclone,ignoreElements:t.ignoreElements,inlineImages:u,copyStyles:u},l.logger.debug("Starting document clone with size "+a.width+"x"+a.height+" scrolled to "+-a.left+","+-a.top),c=new bF(l,e,A),(h=c.clonedReferenceElement)?[4,c.toIFrame(i,a)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return d=Q.sent(),p=eF(h)||"HTML"===h.tagName?function(e){var t=e.body,i=e.documentElement;if(!t||!i)throw new Error("Unable to get document size");var r=Math.max(Math.max(t.scrollWidth,i.scrollWidth),Math.max(t.offsetWidth,i.offsetWidth),Math.max(t.clientWidth,i.clientWidth)),n=Math.max(Math.max(t.scrollHeight,i.scrollHeight),Math.max(t.offsetHeight,i.offsetHeight),Math.max(t.clientHeight,i.clientHeight));return new jw(0,0,r,n)}(h.ownerDocument):zw(l,h),f=p.width,v=p.height,g=p.left,m=p.top,_=Rk(l,h,t.backgroundColor),y={canvas:t.canvas,backgroundColor:_,scale:null!==(R=null!==(S=t.scale)&&void 0!==S?S:r.devicePixelRatio)&&void 0!==R?R:1,x:(null!==(U=t.x)&&void 0!==U?U:0)+g,y:(null!==(L=t.y)&&void 0!==L?L:0)+m,width:null!==(O=t.width)&&void 0!==O?O:Math.ceil(f),height:null!==(N=t.height)&&void 0!==N?N:Math.ceil(v)},u?(l.logger.debug("Document cloned, using foreign object rendering"),[4,new kk(l,y).render(h)]):[3,3];case 2:return b=Q.sent(),[3,5];case 3:return l.logger.debug("Document cloned, element located at "+g+","+m+" with size "+f+"x"+v+" using computed rendering"),l.logger.debug("Starting DOM parsing"),w=GM(l,h),_===w.styles.backgroundColor&&(w.styles.backgroundColor=$x.TRANSPARENT),l.logger.debug("Starting renderer for element at "+y.x+","+y.y+" with size "+y.width+"x"+y.height),[4,new Bk(l,y).render(w)];case 4:b=Q.sent(),Q.label=5;case 5:return(null===(V=t.removeContainer)||void 0===V||V)&&(bF.destroy(d)||l.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),l.logger.debug("Finished rendering"),[2,b]}}))}))},Rk=function(e,t,i){var r=t.ownerDocument,n=r.documentElement?qx(e,getComputedStyle(r.documentElement).backgroundColor):$x.TRANSPARENT,s=r.body?qx(e,getComputedStyle(r.body).backgroundColor):$x.TRANSPARENT,o="string"==typeof i?qx(e,i):null===i?$x.TRANSPARENT:4294967295;return t===r.documentElement?jx(n)?jx(s)?o:s:n:o};function Uk(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};if(e&&t){var r,n,s=null,o=500,a=3,l=function(e){if(e.preventDefault(),s&&(clearTimeout(s),s=null),!(e.touches.length>1)){var i=e.touches[0];r=i.clientX,n=i.clientY,s=setTimeout((function(){e.clientX=i.clientX,e.clientY=i.clientY,t(e),clearTimeout(s),s=null}),o)}},u=function(e){e.touches.length>1&&s&&(clearTimeout(s),s=null)},A=function(e){if(s){var t=e.touches[0],i=Math.abs(t.clientX-r),o=Math.abs(t.clientY-n);(i>a||o>a)&&(clearTimeout(s),s=null)}},c=function(e){e.preventDefault(),s&&(i(e),clearTimeout(s),s=null)},h=function(e){t(e),e.preventDefault(),e.stopPropagation()};return fh.isIphoneOrIpadSafari()?(e.addEventListener("touchstart",l),e.addEventListener("touchmove",A),e.addEventListener("touchend",c),window.addEventListener("touchstart",u)):e.addEventListener("contextmenu",h),function(){fh.isIphoneOrIpadSafari()?(e.removeEventListener("touchstart",l),e.removeEventListener("touchmove",A),e.removeEventListener("touchend",c),window.removeEventListener("touchstart",u)):e.removeEventListener("contextmenu",h)}}}var Lk=function(){function e(t){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this._highlightClass="viewer-ruler-dot-highlighted",this._x=0,this._y=0,this._dot=document.createElement("div"),this._dot.className+=this._dot.className?" viewer-ruler-dot":"viewer-ruler-dot",this._dotClickable=document.createElement("div"),this._dotClickable.className+=this._dotClickable.className?" viewer-ruler-dot-clickable":"viewer-ruler-dot-clickable",this._visible=!1!==r.visible,this._culled=!1;var n=this._dot,s=n.style;s["border-radius"]="25px",s.border="solid 2px white",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===r.zIndex?"40000005":r.zIndex,s.width="8px",s.height="8px",s.visibility=this._visible?"visible":"hidden",s.top="0px",s.left="0px",s["box-shadow"]="0 2px 5px 0 #182A3D;",s.opacity=1,s["pointer-events"]="none",r.onContextMenu,t.appendChild(n);var o=this._dotClickable,a=o.style;if(a["border-radius"]="35px",a.border="solid 10px white",a.position="absolute",a["z-index"]=void 0===r.zIndex?"40000007":r.zIndex+1,a.width="8px",a.height="8px",a.visibility="visible",a.top="0px",a.left="0px",a.opacity=0,a["pointer-events"]="none",r.onContextMenu,t.appendChild(o),o.addEventListener("click",(function(e){t.dispatchEvent(new MouseEvent("mouseover",e))})),r.onMouseOver&&o.addEventListener("mouseover",(function(e){r.onMouseOver(e,i),t.dispatchEvent(new MouseEvent("mouseover",e))})),r.onMouseLeave&&o.addEventListener("mouseleave",(function(e){r.onMouseLeave(e,i)})),r.onMouseWheel&&o.addEventListener("wheel",(function(e){r.onMouseWheel(e,i)})),r.onMouseDown&&o.addEventListener("mousedown",(function(e){r.onMouseDown(e,i)})),r.onMouseUp&&o.addEventListener("mouseup",(function(e){r.onMouseUp(e,i)})),r.onMouseMove&&o.addEventListener("mousemove",(function(e){r.onMouseMove(e,i)})),r.onTouchstart&&o.addEventListener("touchstart",(function(e){r.onTouchstart(e,i)})),r.onTouchmove&&o.addEventListener("touchmove",(function(e){r.onTouchmove(e,i)})),r.onTouchend&&o.addEventListener("touchend",(function(e){r.onTouchend(e,i)})),r.onContextMenu){var l=function(e){r.onContextMenu(e,i)};Uk(o,l)}this.setPos(r.x||0,r.y||0),this.setFillColor(r.fillColor),this.setBorderColor(r.borderColor)}return I(e,[{key:"setPos",value:function(e,t){this._x=e,this._y=t;var i=this._dot.style;i.left=Math.round(e)-6+"px",i.top=Math.round(t)-6+"px";var r=this._dotClickable.style;r.left=Math.round(e)-14+"px",r.top=Math.round(t)-14+"px"}},{key:"setFillColor",value:function(e){this._dot.style.background=e||"lightgreen"}},{key:"setBorderColor",value:function(e){this._dot.style.border="solid 2px"+(e||"black")}},{key:"setOpacity",value:function(e){this._dot.style.opacity=e}},{key:"_updateVisibility",value:function(){this._dot.style.visibility=this._dotClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"setCulled",value:function(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}},{key:"setClickable",value:function(e){this._dotClickable.style["pointer-events"]=e?"all":"none"}},{key:"setHighlighted",value:function(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._dot.classList.add(this._highlightClass):this._dot.classList.remove(this._highlightClass))}},{key:"destroy",value:function(){this.setVisible(!1),this._dot.parentElement&&this._dot.parentElement.removeChild(this._dot),this._dotClickable.parentElement&&this._dotClickable.parentElement.removeChild(this._dotClickable)}}]),e}(),Ok=function(){function e(t){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this._highlightClass="viewer-ruler-label-highlighted",this._prefix=r.prefix||"",this._x=0,this._y=0,this._visible=!0,this._culled=!1,this._label=document.createElement("div"),this._label.className+=this._label.className?" viewer-ruler-label":"viewer-ruler-label",this._timeout=null;var n=this._label,s=n.style;if(s["border-radius"]="5px",s.color="white",s.padding="4px",s.border="solid 1px",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===r.zIndex?"5000005":r.zIndex,s.width="auto",s.height="auto",s.visibility="visible",s.top="0px",s.left="0px",s["pointer-events"]="all",s.opacity=1,r.onContextMenu,n.innerText="",t.appendChild(n),this.setPos(r.x||0,r.y||0),this.setFillColor(r.fillColor),this.setBorderColor(r.fillColor),this.setText(r.text),r.onMouseOver&&n.addEventListener("mouseover",(function(e){r.onMouseOver(e,i),e.preventDefault()})),r.onMouseLeave&&n.addEventListener("mouseleave",(function(e){r.onMouseLeave(e,i),e.preventDefault()})),r.onMouseWheel&&n.addEventListener("wheel",(function(e){r.onMouseWheel(e,i)})),r.onMouseDown&&n.addEventListener("mousedown",(function(e){r.onMouseDown(e,i),e.stopPropagation()})),r.onMouseUp&&n.addEventListener("mouseup",(function(e){r.onMouseUp(e,i),e.stopPropagation()})),r.onMouseMove&&n.addEventListener("mousemove",(function(e){r.onMouseMove(e,i)})),r.onContextMenu){var o=function(e){r.onContextMenu(e,i)};Uk(n,o)}}return I(e,[{key:"setPos",value:function(e,t){this._x=e,this._y=t;var i=this._label.style;i.left=Math.round(e)-20+"px",i.top=Math.round(t)-12+"px"}},{key:"setPosOnWire",value:function(e,t,i,r){var n=e+.5*(i-e),s=t+.5*(r-t),o=this._label.style;o.left=Math.round(n)-20+"px",o.top=Math.round(s)-12+"px"}},{key:"setPosBetweenWires",value:function(e,t,i,r,n,s){var o=(e+i+n)/3,a=(t+r+s)/3,l=this._label.style;l.left=Math.round(o)-20+"px",l.top=Math.round(a)-12+"px"}},{key:"setText",value:function(e){this._label.innerHTML=this._prefix+(e||"")}},{key:"setFillColor",value:function(e){this._fillColor=e||"lightgreen",this._label.style.background=this._fillColor}},{key:"setBorderColor",value:function(e){this._borderColor=e||"black",this._label.style.border="solid 1px "+this._borderColor}},{key:"setOpacity",value:function(e){this._label.style.opacity=e}},{key:"_updateVisibility",value:function(){this._label.style.visibility=this._visible&&!this._culled?"visible":"hidden"}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"setCulled",value:function(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}},{key:"setHighlighted",value:function(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._label.classList.add(this._highlightClass):this._label.classList.remove(this._highlightClass))}},{key:"setClickable",value:function(e){this._label.style["pointer-events"]=e?"all":"none"}},{key:"setPrefix",value:function(e){this._prefix!==e&&(this._prefix=e)}},{key:"destroy",value:function(){this._label.parentElement&&this._label.parentElement.removeChild(this._label)}}]),e}(),Nk=function(){function e(t){var i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this._color=r.color||"black",this._highlightClass="viewer-ruler-wire-highlighted",this._wire=document.createElement("div"),this._wire.className+=this._wire.className?" viewer-ruler-wire":"viewer-ruler-wire",this._wireClickable=document.createElement("div"),this._wireClickable.className+=this._wireClickable.className?" viewer-ruler-wire-clickable":"viewer-ruler-wire-clickable",this._thickness=r.thickness||1,this._thicknessClickable=r.thicknessClickable||6,this._visible=!0,this._culled=!1;var n=this._wire,s=n.style;s.border="solid "+this._thickness+"px "+this._color,s.position="absolute",s["z-index"]=void 0===r.zIndex?"2000001":r.zIndex,s.width="0px",s.height="0px",s.visibility="visible",s.top="0px",s.left="0px",s["-webkit-transform-origin"]="0 0",s["-moz-transform-origin"]="0 0",s["-ms-transform-origin"]="0 0",s["-o-transform-origin"]="0 0",s["transform-origin"]="0 0",s["-webkit-transform"]="rotate(0deg)",s["-moz-transform"]="rotate(0deg)",s["-ms-transform"]="rotate(0deg)",s["-o-transform"]="rotate(0deg)",s.transform="rotate(0deg)",s.opacity=1,s["pointer-events"]="none",r.onContextMenu,t.appendChild(n);var o=this._wireClickable,a=o.style;if(a.border="solid "+this._thicknessClickable+"px "+this._color,a.position="absolute",a["z-index"]=void 0===r.zIndex?"2000002":r.zIndex+1,a.width="0px",a.height="0px",a.visibility="visible",a.top="0px",a.left="0px",a["-webkit-transform-origin"]="0 0",a["-moz-transform-origin"]="0 0",a["-ms-transform-origin"]="0 0",a["-o-transform-origin"]="0 0",a["transform-origin"]="0 0",a["-webkit-transform"]="rotate(0deg)",a["-moz-transform"]="rotate(0deg)",a["-ms-transform"]="rotate(0deg)",a["-o-transform"]="rotate(0deg)",a.transform="rotate(0deg)",a.opacity=0,a["pointer-events"]="none",r.onContextMenu,t.appendChild(o),r.onMouseOver&&o.addEventListener("mouseover",(function(e){r.onMouseOver(e,i)})),r.onMouseLeave&&o.addEventListener("mouseleave",(function(e){r.onMouseLeave(e,i)})),r.onMouseWheel&&o.addEventListener("wheel",(function(e){r.onMouseWheel(e,i)})),r.onMouseDown&&o.addEventListener("mousedown",(function(e){r.onMouseDown(e,i)})),r.onMouseUp&&o.addEventListener("mouseup",(function(e){r.onMouseUp(e,i)})),r.onMouseMove&&o.addEventListener("mousemove",(function(e){r.onMouseMove(e,i)})),r.onContextMenu){var l=function(e){r.onContextMenu(e,i)};Uk(o,l)}this._x1=0,this._y1=0,this._x2=0,this._y2=0,this._update()}return I(e,[{key:"visible",get:function(){return"visible"===this._wire.style.visibility}},{key:"_update",value:function(){var e=Math.abs(Math.sqrt((this._x1-this._x2)*(this._x1-this._x2)+(this._y1-this._y2)*(this._y1-this._y2))),t=180*Math.atan2(this._y2-this._y1,this._x2-this._x1)/Math.PI,i=this._wire.style;i.width=Math.round(e)+"px",i.left=Math.round(this._x1)+"px",i.top=Math.round(this._y1)+"px",i["-webkit-transform"]=i["-moz-transform"]=i["-ms-transform"]=i["-o-transform"]=i.transform="rotate("+t+"deg) translate(-"+this._thickness+"px, -"+this._thickness+"px)";var r=this._wireClickable.style;r.width=Math.round(e)+"px",r.left=Math.round(this._x1)+"px",r.top=Math.round(this._y1)+"px",r["-webkit-transform"]=r["-moz-transform"]=r["-ms-transform"]=r["-o-transform"]=r.transform="rotate("+t+"deg) translate(-"+this._thicknessClickable+"px, -"+this._thicknessClickable+"px)"}},{key:"setStartAndEnd",value:function(e,t,i,r){this._x1=e,this._y1=t,this._x2=i,this._y2=r,this._update()}},{key:"setColor",value:function(e){this._color=e||"black",this._wire.style.border="solid "+this._thickness+"px "+this._color}},{key:"setOpacity",value:function(e){this._wire.style.opacity=e}},{key:"_updateVisibility",value:function(){this._wire.style.visibility=this._wireClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"setCulled",value:function(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}},{key:"setClickable",value:function(e){this._wireClickable.style["pointer-events"]=e?"all":"none"}},{key:"setHighlighted",value:function(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._wire.classList.add(this._highlightClass):this._wire.classList.remove(this._highlightClass))}},{key:"destroy",value:function(e){this._wire.parentElement&&this._wire.parentElement.removeChild(this._wire),this._wireClickable.parentElement&&this._wireClickable.parentElement.removeChild(this._wireClickable)}}]),e}(),Vk=le.vec2(),Qk=le.vec2(),Hk=le.vec2(),Gk=le.vec2(),jk=le.vec3(),zk=le.vec3(),Wk=le.vec4(),Xk=le.vec4(),Kk=le.vec4(),Zk=le.vec4(),Jk=le.mat4(),Yk={origin:le.vec3(),direction:le.vec3()},qk=function(){},$k=function(e,t,i,r){var n=(e-le.dotVec3(i,t))/le.dotVec3(r,t);if(n<0)return null;var s=le.vec3();return le.mulVec3Scalar(r,n,s),le.addVec3(i,s,s),s};function eE(e,t,i){var r=e.getBoundingClientRect(),n=t.getBoundingClientRect();i[0]+=r.left-n.left,i[1]+=r.top-n.top}var tE=function(e,t,i){Jk.set(e.viewMatrix),Jk.set(e.projMatrix),i.set(t),i[3]=1,le.mulMat4v4(e.viewMatrix,i,i),le.mulMat4v4(e.projMatrix,i,i)},iE=function(e,t,i,r){r[0]=.5*(1+i[0])*e.offsetWidth,r[1]=.5*(1-i[1])*e.offsetHeight,eE(e,t,r)},rE=function(e,t,i,r,n,s){var o=e.camera,a=e.canvas.canvas;if(le.distVec3(i,r)<.001)return!1;var l,u=le.subVec3(r,i,jk),A=0,c=1,h=p(e._sectionPlanesState.sectionPlanes);try{for(h.s();!(l=h.n()).done;){var d=l.value,f=le.dotVec3(d.dir,le.subVec3(d.pos,r,zk)),v=le.dotVec3(d.dir,le.subVec3(d.pos,i,zk));if(v>0&&f>0)return!1;if(v>0||f>0){var g=le.dotVec3(d.dir,u);if(Math.abs(g)>=1e-6){var m=le.dotVec3(d.dir,zk)/g;v>0?A=Math.max(A,m):c=Math.min(c,m)}}}}catch(e){h.e(e)}finally{h.f()}var _=Wk,y=Xk;tE(o,A>0?le.addVec3(i,le.mulVec3Scalar(u,A,zk),zk):i,_),tE(o,c<1?le.addVec3(i,le.mulVec3Scalar(u,c,zk),zk):r,y);var b=_[2]/_[3]<-1||_[3]<0,w=y[2]/y[3]<-1||y[3]<0;if(b&&w)return!1;var B=(_[3]+_[2])/(_[3]+_[2]-(y[3]+y[2]));if(B>0&&B<1){var x=le.subVec4(y,_,Kk);le.mulVec4Scalar(x,B,x),le.addVec4(_,x,b?_:y)}le.mulVec4Scalar(_,1/_[3]),le.mulVec4Scalar(y,1/y[3]);for(var P=0,C=1,M=0;M<2;++M){var F=y[M]-_[M],k=(-1-_[M])/F,E=(1-_[M])/F;F>0?(P=Math.max(P,k),C=Math.min(C,E)):F<0?(P=Math.max(P,E),C=Math.min(C,k)):_[0]<-1?P=-window.Infinity:_[0]>1&&(C=window.Infinity)}if(P>=C)return!1;var I=le.subVec4(y,_,Kk);return le.addVec4(_,le.mulVec4Scalar(I,C,Zk),y),le.addVec4(_,le.mulVec4Scalar(I,P,Zk),_),le.mulVec4Scalar(_,1/_[3]),le.mulVec4Scalar(y,1/y[3]),iE(a,t,_,n),iE(a,t,y,s),!0},nE=function(e){m(i,Zc);var t=y(i);function i(e,r,n){var s,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};k(this,i);var a=e.camera;(s=t.call(this,e,r)).__visible=!0;var l=function(e,t){return function(i){e&&e(i),s.fire(t,i,!0)}};s._dot=new Lk(n,{borderColor:o.borderColor,fillColor:o.fillColor,zIndex:o.zIndex,onMouseOver:l(o.onMouseOver,"mouseover"),onMouseLeave:l(o.onMouseLeave,"mouseleave"),onMouseWheel:l(o.onMouseWheel,"wheel"),onMouseDown:l(o.onMouseDown,"mousedown"),onMouseUp:l(o.onMouseUp,"mouseup"),onMouseMove:l(o.onMouseMove,"mousemove"),onTouchstart:l(o.onTouchstart,"touchstart"),onTouchmove:l(o.onTouchmove,"touchmove"),onTouchend:l(o.onTouchend,"touchend"),onContextMenu:l(o.onContextMenu,"contextmenu")});var u=function(e,t){t.set(e),t[3]=1,le.mulMat4v4(a.viewMatrix,t,t),le.mulMat4v4(a.projMatrix,t,t)},A=function(t){var i=e.canvas.canvas;t[0]=.5*(1+t[0])*i.offsetWidth,t[1]=.5*(1-t[1])*i.offsetHeight,eE(i,n,t)},c=function(){if(s.__visible){var t=Kk;u(s.worldPos,t),le.mulVec3Scalar(t,1/t[3]);var i=t[3]<0||t[0]<-1||t[0]>1||t[1]<-1||t[1]>1||t[2]<-1||t[2]>1||e._sectionPlanesState.sectionPlanes.some((function(e){return le.dotVec3(e.dir,le.subVec3(e.pos,s.worldPos,jk))>0}));s._dot.setCulled(i),i||(A(t),s._dot.setPos(t[0],t[1]))}};s.on("worldPos",c);var h=a.on("viewMatrix",c),d=a.on("projMatrix",c),p=e.canvas.on("boundary",c),f=e.on("sectionPlaneUpdated",c),v=e.on("sectionPlaneCreated",c),g=e.on("sectionPlaneDestroyed",c);return s._updatePosition=c,s._cleanup=function(){a.off(h),a.off(d),e.canvas.off(p),e.off(f),e.off(v),e.off(g),s._dot.destroy()},s}return I(i,[{key:"setClickable",value:function(e){this._dot.setClickable(e)}},{key:"setFillColor",value:function(e){this._dot.setFillColor(e)}},{key:"setBorderColor",value:function(e){this._dot.setBorderColor(e)}},{key:"setHighlighted",value:function(e){this._dot.setHighlighted(e)}},{key:"setOpacity",value:function(e){this._dot.setOpacity(e)}},{key:"setVisible",value:function(e){this.__visible!=e&&(this.__visible=e,this._updatePosition(),this._dot.setVisible(e))}},{key:"destroy",value:function(){this._cleanup(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),sE=function(){function e(t,i,r){var n=this;k(this,e);var s=t.camera;this._label=new Ok(i,r),this._start=le.vec3(),this._mid=le.vec3(),this._end=le.vec3(),this._yOff=0,this.__visible=!0,this._updatePos=function(){tE(s,n._start,Wk),le.mulVec4Scalar(Wk,1/Wk[3]),iE(t.canvas.canvas,i,Wk,Vk),n._label.setPos(Vk[0],Vk[1])};var o=function(e,t,i){e[0]+=t[0],e[1]+=t[1],le.mulVec2Scalar(e,.5),n._label.setPos(e[0],e[1]+i)};this._updatePosBetween=function(){var e=rE(t,i,n._start,n._mid,Vk,Qk),r=rE(t,i,n._end,n._mid,Hk,Gk);n._label.setCulled(!(e||r)),e&&r?(Qk[0]+=Gk[0],Qk[1]+=Gk[1],le.mulVec2Scalar(Qk,.5),Qk[0]+=Vk[0]+Hk[0],Qk[1]+=Vk[1]+Hk[1],le.mulVec2Scalar(Qk,1/3),n._label.setPos(Qk[0],Qk[1])):e?o(Vk,Qk,0):r&&o(Hk,Gk,0)},this._updatePosOnWire=function(){var e=rE(t,i,n._start,n._end,Vk,Qk)&&le.distVec2(Vk,Qk)>=n._labelMinAxisLength;n._label.setCulled(!e),e&&o(Vk,Qk,n._yOff)};var a=function(){};this._setUpdatePositions=function(e){a=e,n._updatePositions()},this._updatePositions=function(){n.__visible&&a()};var l=s.on("viewMatrix",this._updatePositions),u=s.on("projMatrix",this._updatePositions),A=t.canvas.on("boundary",this._updatePositions),c=t.on("sectionPlaneUpdated",this._updatePositions),h=t.on("sectionPlaneCreated",this._updatePositions),d=t.on("sectionPlaneDestroyed",this._updatePositions);this._cleanup=function(){s.off(l),s.off(u),t.canvas.off(A),t.off(c),t.off(h),t.off(d),n._label.destroy()}}return I(e,[{key:"setPos",value:function(e){this._start.set(e),this._setUpdatePositions(this._updatePos)}},{key:"setPosOnWire",value:function(e,t,i,r){this._start.set(e),this._end.set(t),this._yOff=i,this._labelMinAxisLength=r,this._setUpdatePositions(this._updatePosOnWire)}},{key:"setPosBetween",value:function(e,t,i){this._start.set(e),this._mid.set(t),this._end.set(i),this._setUpdatePositions(this._updatePosBetween)}},{key:"setFillColor",value:function(e){this._label.setFillColor(e)}},{key:"setHighlighted",value:function(e){this._label.setHighlighted(e)}},{key:"setText",value:function(e){this._label.setText(e)}},{key:"setClickable",value:function(e){this._label.setClickable(e)}},{key:"setVisible",value:function(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._label.setVisible(e))}},{key:"destroy",value:function(){this._cleanup()}}]),e}(),oE=function(){function e(t,i,r){var n=this;k(this,e);var s=t.camera;this._wire=new Nk(i,r),this._start=le.vec3(),this._end=le.vec3(),this.__visible=!0,this._updatePositions=function(){if(n.__visible){var e=rE(t,i,n._start,n._end,Vk,Qk);n._wire.setCulled(!e),e&&n._wire.setStartAndEnd(Vk[0],Vk[1],Qk[0],Qk[1])}};var o=s.on("viewMatrix",this._updatePositions),a=s.on("projMatrix",this._updatePositions),l=t.canvas.on("boundary",this._updatePositions),u=t.on("sectionPlaneUpdated",this._updatePositions),A=t.on("sectionPlaneCreated",this._updatePositions),c=t.on("sectionPlaneDestroyed",this._updatePositions);this._cleanup=function(){s.off(o),s.off(a),t.canvas.off(l),t.off(u),t.off(A),t.off(c),n._wire.destroy()}}return I(e,[{key:"setEnds",value:function(e,t){this._start.set(e),this._end.set(t),this._updatePositions()}},{key:"setClickable",value:function(e){this._wire.setClickable(e)}},{key:"setColor",value:function(e){this._wire.setColor(e)}},{key:"setHighlighted",value:function(e){this._wire.setHighlighted(e)}},{key:"setOpacity",value:function(e){this._wire.setOpacity(e)}},{key:"setVisible",value:function(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._wire.setVisible(e))}},{key:"destroy",value:function(){this._cleanup()}}]),e}(),aE=function(e,t){var i=new nE(e,{},e.canvas.canvas.parentNode,{borderColor:"white",fillColor:t,zIndex:100});return{update:function(e){e&&(i.worldPos=e),i.setVisible(!!e)},setFillColor:function(e){return i.setFillColor(e)},setHighlighted:function(e){return i.setHighlighted(e)},getCanvasPos:function(){return i.canvasPos},getWorldPos:function(){return i.worldPos},destroy:function(){return i.destroy()}}},lE=function(e,t){var i=new oE(e,e.canvas.canvas.ownerDocument.body,{color:t,thickness:1,thicknessClickable:6});return i.setVisible(!1),{update:function(e,t){t&&i.setEnds(e,t),i.setVisible(!!t)},setColor:function(e){return i.setColor(e)},destroy:function(){return i.destroy()}}};function uE(e,t){var i,r=function(e,i){if(e in t)return t[e];if(void 0!==i)return i;throw"config missing: "+e},n=r("viewer"),s=r("ray2WorldPos"),o=r("handleMouseEvents",!1),a=r("handleTouchEvents",!1),l=r("onStart",qk),u=r("onMove",qk),A=r("onEnd",qk),c=n.scene,h=c.canvas.canvas,d=function(e){var t=le.vec2([e.clientX,e.clientY]);eE(h.ownerDocument.documentElement,h,t),u(t,function(e){var t=le.vec3(),i=le.vec3();return le.canvasPosToWorldRay(h,c.camera.viewMatrix,c.camera.projMatrix,c.camera.projection,e,t,i),s(t,i,e)}(t))},p=null,v=function(e){var t=p.matchesEvent(e);t&&d(t)},g=function(t){var i=p.matchesEvent(t);i&&(e.setOpacity(b),p.cleanup(),d(i),A())},m=function(t,i){p&&p.cleanup(),e.setOpacity(1),e.setClickable(!1),n.cameraControl.active=!1,p={matchesEvent:t,cleanup:function(){p=null,e.setClickable(!0),n.cameraControl.active=!0,i()}},l()},_=[],y=function(t,i){var r=e.on(t,i);_.push((function(){return e.off(r)}))};(o&&(y("mouseover",(function(){return!p&&e.setOpacity(1)})),y("mouseleave",(function(){return!p&&e.setOpacity(b)})),y("mousedown",(function(e){1===e.which&&(h.addEventListener("mousemove",v),h.addEventListener("mouseup",g),m((function(e){return 1===e.which&&e}),(function(){h.removeEventListener("mousemove",v),h.removeEventListener("mouseup",g)})))}))),a)&&(y("touchstart",(function(e){e.preventDefault(),1===e.touches.length&&(i=e.touches[0].identifier,m((function(e){return f(e.changedTouches).find((function(e){return e.identifier===i}))}),(function(){i=null})))})),y("touchmove",(function(e){e.preventDefault(),v(e)})),y("touchend",(function(e){e.preventDefault(),g(e)})));var b=.8;return e.setOpacity(b),function(){p&&p.cleanup(),_.forEach((function(e){return e()})),e.setOpacity(1)}}function AE(e){var t=function(t,i){if(t in e)return e[t];if(void 0!==i)return i;throw"config missing: "+t},i=t("viewer"),r=t("handleMouseEvents",!1),n=t("handleTouchEvents",!1),s=t("pointerLens",null),o=t("dots"),a=t("ray2WorldPos"),l=t("onEnd",qk),u=s?function(e){s.visible=!!e,e&&(s.canvasPos=e)}:function(){},A=o.map((function(e){var t;return uE(e,{handleMouseEvents:r,handleTouchEvents:n,viewer:i,ray2WorldPos:function(e,i,r){return a(e,i,r)||t},onStart:function(){t=e.worldPos.slice(),c(!1,e)},onMove:function(t,i){u(t),e.worldPos=i},onEnd:function(){l(t,e)||(e.worldPos=t),u(null),c(!0,e)}})})),c=function(e,t){return o.forEach((function(i){return i!==t&&i.setClickable(e)}))};return c(!0),function(){A.forEach((function(e){return e()})),u(null)}}var cE=function(e,t,i){return function(r,n,s){var o,a=e.scene,l=a.canvas.canvas,u=function(e,t){return t[0]=e.clientX,t[1]=e.clientY,eE(l.ownerDocument.documentElement,l,t),t},A=function(e){var t=le.vec3(),r=le.vec3();return le.canvasPosToWorldRay(l,a.camera.viewMatrix,a.camera.projMatrix,a.camera.projection,e,t,r),i(t,r)},c=null,h=function(){},d=h,p=function(){t.stop(),clearTimeout(c),e.cameraControl.active=!0,d=h,o=null},v=function(){p(),l.removeEventListener("touchstart",g),l.removeEventListener("touchmove",m),l.removeEventListener("touchend",_)},g=function(i){var s=i.touches;if(1!==s.length)p(),r();else{var a=s[0],l=u(a,le.vec2());A(l)&&(o=a.identifier,d=function(e){le.distVec2(l,e)>20&&p()},c=setTimeout((function(){t.start(l),c=setTimeout((function(){t.stop(),e.cameraControl.active=!1,d=function(e){n(e,A(e))},d(l)}),300)}),250))}};l.addEventListener("touchstart",g,{passive:!0});var m=function(e){var t=f(e.changedTouches).find((function(e){return e.identifier===o}));t&&d(u(t,le.vec2()))};l.addEventListener("touchmove",m,{passive:!0});var _=function(e){var t=f(e.changedTouches).find((function(e){return e.identifier===o}));if(t){v();var i=u(t,le.vec2());s(i,A(i))}};return l.addEventListener("touchend",_,{passive:!0}),v}},hE=function(e){for(var t=[],i=0;i<e.length;++i)t.push(i);var r=function(){for(var i=le.vec2(),r=le.vec2(),n=0,s=0;s<t.length;++s){var o=e[t[s]],a=e[t[(s+1)%t.length]],l=e[t[(s+2)%t.length]];le.subVec2(o,a,i),le.subVec2(l,a,r);var u=le.dotVec2(i,r)/Math.sqrt(le.sqLenVec2(i)*le.sqLenVec2(r)),A=Math.acos(Math.max(-1,Math.min(u,1)));n+=i[0]*r[1]-i[1]*r[0]>=0?A:2*Math.PI-A}return n<t.length*Math.PI}(),n=function(){var e=function(e,t,i){return(e[0]-i[0])*(t[1]-i[1])-(t[0]-i[0])*(e[1]-i[1])};return function(t,i,r,n){var s=e(t,i,r),o=e(t,r,n),a=e(t,n,i);return!((s<0||o<0||a<0)&&(s>0||o>0||a>0))}}(),s=[],o=(r?t:t.slice(0).reverse()).map((function(e){return{idx:e}}));o.forEach((function(e,t){e.prev=o[(t-1+o.length)%o.length],e.next=o[(t+1)%o.length]}));for(var a=le.vec2(),l=le.vec2();o.length>2;){for(var u=0,A=function(){if(u>=o.length)throw"isCCW = ".concat(r,"; earIdx = ").concat(u,"; len = ").concat(o.length);var t=o[u],i=e[t.prev.idx],s=e[t.idx],A=e[t.next.idx];if(le.subVec2(i,s,a),le.subVec2(A,s,l),a[0]*l[1]-a[1]*l[0]>=0&&o.every((function(r){return r===t||r===t.prev||r===t.next||!n(e[r.idx],i,s,A)})))return"break";++u};;){if("break"===A())break}var c=o[u];o.splice(u,1),s.push([c.idx,c.next.idx,c.prev.idx]),c.prev.next=c.next,c.next.prev=c.prev}return[e,s,r]},dE=function(e,t){var i=function(t,i){return i[0]=t.clientX,i[1]=t.clientY,eE(e.ownerDocument.documentElement,e,i),i},r=!1,n=[],s=function(){return n.forEach((function(e){return e()}))},o=function(t,i){e.addEventListener(t,i),n.push((function(){return e.removeEventListener(t,i)}))},a=le.vec2();return o("mousedown",(function(e){1===e.which&&(r=!0,t(i(e,a)))})),o("mousemove",(function(e){i(e,Vk),r&&le.distVec2(a,Vk)>4&&(r=!1),(r||1&!e.buttons)&&t(Vk)})),o("mouseup",(function(e){if(1===e.which&&r){var n=t(i(e,Vk));n&&(s(),n())}})),s},pE=function(e,t,i,r){var n,s=le.vec2(),o=function(t,i){return i[0]=t.clientX,i[1]=t.clientY,eE(e.ownerDocument.documentElement,e,i),i},a=null,l=qk,u=function(){clearTimeout(a),i.stop(),t.active=!0,l=qk,n=null},A=[],c=function(){return A.forEach((function(e){return e()}))},h=function(t,i){e.addEventListener(t,i,{passive:!0}),A.push((function(){return e.removeEventListener(t,i)}))};return h("touchstart",(function(e){var A=e.touches;if(1!==A.length)u(),r(null);else{var c=A[0];o(c,s),n=c.identifier,l=function(e){le.distVec2(s,e)>20&&u()},a=setTimeout((function(){i.start(s),a=setTimeout((function(){i.stop(),t.active=!1,(l=r)(s)}),300)}),250)}})),h("touchmove",(function(e){var t=f(e.changedTouches).find((function(e){return e.identifier===n}));t&&l(o(t,Vk))})),h("touchend",(function(e){var t=f(e.changedTouches).find((function(e){return e.identifier===n}));if(t){var i=r(o(t,Vk));u(),i?(c(),i()):r(null)}})),function(){u(),c()}},fE=function(e,t,i,r,n,s){var o,a=e.canvas.canvas,l=t?function(e,i){t.visible=!!e,e&&(t.canvasPos=e,t.snapped=!!i)}:function(){},u=function(){var e=function(e,t,i){return t[0]<=Math.max(e[0],i[0])&&t[0]>=Math.min(e[0],i[0])&&t[1]<=Math.max(e[1],i[1])&&t[1]>=Math.min(e[1],i[1])},t=function(e,t,i){var r=(t[1]-e[1])*(i[0]-t[0])-(t[0]-e[0])*(i[1]-t[1]);return 0===r?0:r>0?1:2};return function(i,r){for(var n=r?1:0,s=i[(i.length-2+n)%i.length],o=i[(i.length-1+n)%i.length],a=n;a<i.length-2-1+n;++a){var l=i[a],u=i[a+1],A=t(s,o,l),c=t(s,o,u),h=t(l,u,s),d=t(l,u,o);if(A!==c&&h!==d||0===A&&e(s,l,o)||0===c&&e(s,u,o)||0===h&&e(l,s,u)||0===d&&e(l,o,u))return!0}return!1}}(),A=function(e){return e.length>=3&&function(){var t=le.normalizeVec3(le.subVec3(e[1],e[0],le.vec3())),i=le.normalizeVec3(le.subVec3(e[2],e[0],jk)),r=le.normalizeVec3(le.cross3Vec3(t,i,le.vec3())),n=le.normalizeVec3(le.cross3Vec3(r,t,le.vec3()));return{normal:r,origin:le.vec3(e[0]),u:t,v:n}}()},c=[];return function t(){var h=A(c),d=!1,p=i((function(t){var i=t&&function(e){var t=r(e),i=t&&t.entity&&(!h||t.snapped)&&t.worldPos;if(h){var n=le.dotVec3(h.normal,h.origin),s=i?n-le.dotVec3(i,h.normal):window.Infinity;if(Math.abs(s)<1e-4){var o=le.vec3();return{worldPos:le.addVec3(i,le.mulVec3Scalar(h.normal,s,o),o),snapped:!0}}return{worldPos:$k(n,h.normal,e.origin,e.direction),snapped:!1}}return{worldPos:i,snapped:t&&t.snapped}}(function(t,i){return le.canvasPosToWorldRay(a,e.camera.viewMatrix,e.camera.projMatrix,e.camera.projection,t,i.origin,i.direction),i}(t,Yk)),n=i&&i.worldPos;return f(n,t,i&&i.snapped)})),f=function(i,r,o){var a,p=i?e.camera.projectWorldPos(i):r,f=c.length>0&&(a=c[0],{canvasPos:e.camera.projectWorldPos(a),worldPos:a}),v=c.length>=3&&(p&&le.distVec2(p,f.canvasPos)<10||i&&le.compareVec3(i,f.worldPos));l(v?f.canvasPos:p,v||o);var g=r&&(!i||(c.length<3?c.some((function(e){return le.compareVec3(e,i)})):le.compareVec3(c[c.length-1],i))),m=c.concat(v||!i||g?[]:[i]),_=!g&&(h||A(m)),y=_&&m.map((function(e){return le.subVec3(e,_.origin,jk),le.vec2([le.dotVec3(jk,_.u),le.dotVec3(jk,_.v)])})),b=!(g||y&&u(y,v)),w=b&&y&&(v||!u(y,!0))&&function(){try{var e=C(hE(y),3),t=e[0],i=e[1];e[2];return{faces:i,vertices:t.map((function(e){return le.addVec3(_.origin,le.addVec3(le.mulVec3Scalar(_.u,e[0],jk),le.mulVec3Scalar(_.v,e[1],zk),jk),le.vec3())}))}}catch(e){return console.warn("e",e),!1}}();return n(m,v,b,w),d=b&&(v?function(){l(null),s()}:function(){c.push(le.vec3(i)),l(null),t()})};o={closePolygon:function(){var e=c.length>=3&&f(c[0]);return e&&(p(),e()),!!e},placeVertex:function(){return d&&(p(),d()),!!d},popVertex:function(){return c.length>0&&(p(),c.pop(),t(),!0)},removePressListener:p,updateOnChange:function(){return f()}}}(),{cancel:function(){o.removePressListener(),l(null)},closePolygon:function(){return o.closePolygon()},placeVertex:function(){return o.placeVertex()},popVertex:function(){return o.popVertex()},updateOnChange:function(){return o.updateOnChange()}}},vE=function(){function e(t){k(this,e),this.language="en",this.localeService=t.localeService||new He,this.scene=new Jd(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,keyboardEventsElement:t.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,readableGeometryEnabled:!!t.readableGeometryEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled,colorTextureEnabled:!1!==t.colorTextureEnabled,dtxEnabled:!!t.dtxEnabled,markerZOffset:t.markerZOffset,numCachedSectionPlanes:t.numCachedSectionPlanes}),this.metaScene=new Vp(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new et(this.scene,{duration:.5}),this.cameraControl=new Rp(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}var t;return I(e,[{key:"capabilities",get:function(){return this.scene.capabilities}},{key:"on",value:function(e,t){var i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}},{key:"fire",value:function(e,t){var i=this._eventSubs[e];if(i)for(var r=0,n=i.length;r<n;r++)i[r](t)}},{key:"off",value:function(e){}},{key:"log",value:function(e){console.log("[xeokit viewer ".concat(this.id,"]: ").concat(e))}},{key:"error",value:function(e){console.error("[xeokit viewer ".concat(this.id,"]: ").concat(e))}},{key:"addPlugin",value:function(e){this._plugins.push(e)}},{key:"removePlugin",value:function(e){for(var t=0,i=this._plugins.length;t<i;t++){var r=this._plugins[t];if(r===e)return r.clear&&r.clear(),void this._plugins.splice(t,1)}}},{key:"sendToPlugins",value:function(e,t){for(var i=0,r=this._plugins.length;i<r;i++){var n=this._plugins[i];n.send&&n.send(e,t)}}},{key:"clear",value:function(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}},{key:"resetView",value:function(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}},{key:"beginSnapshot",value:function(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}},{key:"getSnapshot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!this._snapshotBegun,i=void 0!==e.width&&void 0!==e.height,r=this.scene.canvas.canvas,n=r.clientWidth,s=r.clientHeight,o=e.width?Math.floor(e.width):r.width,a=e.height?Math.floor(e.height):r.height;i&&(r.width=o,r.height=a),this._snapshotBegun||this.beginSnapshot({width:o,height:a}),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene.fire("rendering",{},!0),this.scene._renderer.renderSnapshot();var l=this.scene._renderer.readSnapshot(e);return i&&(r.width=n,r.height=s,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),l}},{key:"getSnapshotWithPlugins",value:(t=A(l().mark((function e(){var t,i,r,n,s,o,a,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=B.length>0&&void 0!==B[0]?B[0]:{},r=!this._snapshotBegun,n=void 0!==i.width&&void 0!==i.height,s=this.scene.canvas.canvas,o=s.clientWidth,a=s.clientHeight,u=i.width?Math.floor(i.width):s.width,A=i.height?Math.floor(i.height):s.height,n&&(s.width=u,s.height=A),this._snapshotBegun||this.beginSnapshot(),i.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene._renderer.renderSnapshot(),c=this.scene._renderer.readSnapshotAsCanvas(),n&&(s.width=o,s.height=a,this.scene.glRedraw()),h={},d=[],p=0,f=this._plugins.length;p<f;p++)(v=this._plugins[p]).getContainerElement&&(g=v.getContainerElement())!==document.body&&(h[g.id]||(h[g.id]=!0,d.push(g)));m=document.createElement("style"),document.head.appendChild(m),null===(t=m.sheet)||void 0===t||t.insertRule("body > div:last-child img { display: inline-block; }"),_=0,y=d.length;case 21:if(!(_<y)){e.next=29;break}return b=d[_],e.next=25,Dk(b,{canvas:c,backgroundColor:null,scale:c.width/b.clientWidth});case 25:c.getContext("2d").resetTransform();case 26:_++,e.next=21;break;case 29:return m.remove(),i.includeGizmos||this.sendToPlugins("snapshotFinished"),r&&this.endSnapshot(),"jpeg"!==(w=i.format||"png")&&"png"!==w&&"bmp"!==w&&(console.error("Unsupported image format: '"+w+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),w="png"),i.includeGizmos||this.sendToPlugins("snapshotFinished"),r&&this.endSnapshot(),e.abrupt("return",c.toDataURL("image/".concat(w)));case 37:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"endSnapshot",value:function(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}},{key:"destroy",value:function(){for(var e=this._plugins.slice(),t=0,i=e.length;t<i;t++){e[t].destroy()}this.scene.destroy()}}]),e}();function gE(e,t){return mE.apply(this,arguments)}function mE(){return mE=A(l().mark((function e(t,i){var r,n,s,o,a,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i.src&&Array.isArray(i.src)&&6===i.src.length){e.next=2;break}throw new Error("src requires path to 6 images");case 2:if(r=C(i.src,6),n=r[0],s=r[1],o=r[2],a=r[3],u=r[4],A=r[5],n&&s&&o&&a&&u&&A){e.next=5;break}throw new Error("All six images must be provided");case 5:return c=document.createElement("canvas"),h=c.getContext("2d"),d=function(e){return new Promise((function(t,i){var r=new Image;r.crossOrigin="anonymous",r.onload=function(){return t(r)},r.onerror=function(){return i(new Error("Failed to load image: ".concat(e)))},r.src=e}))},e.prev=8,e.next=11,Promise.all([d(n),d(s),d(o),d(a),d(u),d(A)]);case 11:if(p=e.sent,f=C(p,6),v=f[0],g=f[1],m=f[2],_=f[3],y=f[4],b=f[5],w=v.width,g.width===w&&m.width===w&&_.width===w&&y.width===w&&b.width===w){e.next=22;break}throw new Error("All skybox textures must have the same dimensions");case 22:return c.width=4*w,c.height=3*w,h.fillStyle="black",h.fillRect(0,0,c.width,c.height),h.drawImage(g,0*w,1*w,w,w),h.drawImage(v,2*w,1*w,w,w),h.drawImage(m,1*w,0*w,w,w),h.drawImage(_,1*w,2*w,w,w),h.drawImage(y,1*w,1*w,w,w),h.drawImage(b,3*w,1*w,w,w),B=new In(t,{image:c,flipY:!0,wrapS:1001,wrapT:1001,encoding:i.encoding||3e3}),e.abrupt("return",B);case 36:throw e.prev=36,e.t0=e.catch(8),console.error("Error creating combined skybox texture:",e.t0),e.t0;case 40:case"end":return e.stop()}}),e,null,[[8,36]])}))),mE.apply(this,arguments)}function _E(e,t){return new vn(e,{geometry:new mt(e,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),background:!0,scale:[1e3,1e3,1e3],rotation:[0,-90,0],material:new bn(e,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:t,backfaces:!0}),visible:!0,pickable:!1,clippable:!1,collidable:!1})}function yE(e,t){var i=new mt(e,It({center:[0,0,0],radius:1,heightSegments:60,widthSegments:60})),r=new bn(e,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:t,backfaces:!0});return new vn(e,{geometry:i,background:!0,rotation:[0,0,180],material:r,visible:!0,pickable:!1,clippable:!1,collidable:!1})}var bE=le.vec3(),wE=le.vec3(),BE=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i);var s=e.viewer.scene;(r=t.call(this,s,n)).plugin=e;var o=n.container;if(!o)throw"config missing: container";r._color=n.color||e.defaultColor;var a=function(e){var t=[],i=!1!==e;return{reg:function(e){return t.push(e)},get:function(){return i},set:function(e){i=!1!==e,t.forEach((function(e){return e(i)}))}}};r._visible=a(n.visible),r._originVisible=a(n.originVisible),r._cornerVisible=a(n.cornerVisible),r._targetVisible=a(n.targetVisible),r._originWireVisible=a(n.originWireVisible),r._targetWireVisible=a(n.targetWireVisible),r._angleVisible=a(n.angleVisible),r._labelsVisible=a(),r.labelsVisible=n.labelsVisible,r._clickable=a(!1),r.approximate=n.approximate;var l=s.canvas.canvas,u=n.onMouseOver?function(e){n.onMouseOver(e,w(r)),l.dispatchEvent(new MouseEvent("mouseover",e))}:null,A=n.onMouseLeave?function(e){n.onMouseLeave(e,w(r)),l.dispatchEvent(new MouseEvent("mouseleave",e))}:null,c=n.onContextMenu?function(e){n.onContextMenu(e,w(r))}:null,h=function(e){return l.dispatchEvent(new MouseEvent("mousedown",e))},d=function(e){return l.dispatchEvent(new MouseEvent("mouseup",e))},p=function(e){return l.dispatchEvent(new MouseEvent("mousemove",e))},f=function(e){return l.dispatchEvent(new WheelEvent("wheel",e))};r._cleanups=[],r._drawables=[];var v=function(e,t){var i=function(){return e.setVisible(t.every((function(e){return e.get()})))};t.forEach((function(e){return e.reg(i)})),r._drawables.push(e),r._cleanups.push((function(){return e.destroy()}))},g=function(t,i,r){var n=new oE(s,o,{color:t,thickness:i,thicknessClickable:6,zIndex:void 0!==e.zIndex?e.zIndex+1:void 0,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return v(n,r),{setEnds:function(e,t){return n.setEnds(e,t)},setColor:function(e){return n.setColor(e)}}};r._originWire=g(r._color||"blue",1,[r._visible,r._originWireVisible]),r._targetWire=g(r._color||"red",1,[r._visible,r._targetWireVisible]);var m=function(t,i,r){var n=new sE(s,o,{fillColor:t,zIndex:e.zIndex+i,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return v(n,r),{setFillColor:function(e){return n.setFillColor(e)},setPosOnWire:function(e,t,i){return n.setPosOnWire(e,t,i)},setPosBetween:function(e,t,i){return n.setPosBetween(e,t,i)},setText:function(e){return n.setText(e)}}};r._angleLabel=m(r._color||"#00BBFF",2,[r._visible,r._angleVisible,r._labelsVisible]);var _=function(t,i){var n=new nE(s,t,o,{fillColor:r._color,zIndex:void 0!==e.zIndex?e.zIndex+2:void 0,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return n.on("worldPos",(function(){return r._update()})),v(n,i),n};return r._originDot=_(n.origin,[r._visible,r._originVisible]),r._cornerDot=_(n.corner,[r._visible,r._cornerVisible]),r._targetDot=_(n.target,[r._visible,r._targetVisible]),r._update(),r}return I(i,[{key:"_update",value:function(){if(this._targetDot){var e=this._originDot.worldPos,t=this._cornerDot.worldPos,i=this._targetDot.worldPos;this._originWire.setEnds(e,t),this._targetWire.setEnds(t,i),this._angleLabel.setPosBetween(e,t,i),le.subVec3(e,t,bE),le.subVec3(i,t,wE),le.lenVec3(bE)>0&&le.lenVec3(wE)>0?(le.normalizeVec3(bE),le.normalizeVec3(wE),this._angle=Math.abs(le.angleVec3(bE,wE))*le.RADTODEG,this._angleLabel.setText((this._approximate?" ~ ":" = ")+this._angle.toFixed(2)+"°")):(this._angle=void 0,this._angleLabel.setText(""))}}},{key:"approximate",get:function(){return this._approximate},set:function(e){e=!1!==e,this._approximate!==e&&(this._approximate=e,this._update())}},{key:"origin",get:function(){return this._originDot}},{key:"corner",get:function(){return this._cornerDot}},{key:"target",get:function(){return this._targetDot}},{key:"angle",get:function(){return this._angle}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._originDot.setFillColor(e),this._cornerDot.setFillColor(e),this._targetDot.setFillColor(e),this._originWire.setColor(e||"blue"),this._targetWire.setColor(e||"red"),this._angleLabel.setFillColor(e||"#00BBFF")}},{key:"visible",get:function(){return this._visible.get()},set:function(e){this._visible.set(e)}},{key:"originVisible",get:function(){return this._originVisible.get()},set:function(e){this._originVisible.set(e)}},{key:"cornerVisible",get:function(){return this._cornerVisible.get()},set:function(e){this._cornerVisible.set(e)}},{key:"targetVisible",get:function(){return this._targetVisible.get()},set:function(e){this._targetVisible.set(e)}},{key:"originWireVisible",get:function(){return this._originWireVisible.get()},set:function(e){this._originWireVisible.set(e)}},{key:"targetWireVisible",get:function(){return this._targetWireVisible.get()},set:function(e){this._targetWireVisible.set(e)}},{key:"angleVisible",get:function(){return this._angleVisible.get()},set:function(e){this._angleVisible.set(e)}},{key:"labelsVisible",get:function(){return this._labelsVisible.get()},set:function(e){this._labelsVisible.set(void 0!==e?Boolean(e):this.plugin.defaultLabelsVisible)}},{key:"setHighlighted",value:function(e){this._drawables.forEach((function(t){return t.setHighlighted(e)}))}},{key:"clickable",get:function(){return this._clickable.get()},set:function(e){var t=this;this._clickable.set(!!e),this._drawables.forEach((function(e){return e.setClickable(t._clickable.get())}))}},{key:"destroy",value:function(){this._cleanups.forEach((function(e){return e()})),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),xE=function(e){m(i,Ie);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"active",get:function(){}},{key:"snapping",get:function(){return!0},set:function(e){}},{key:"activate",value:function(){}},{key:"deactivate",value:function(){}},{key:"reset",value:function(){}},{key:"currentMeasurement",get:function(){return null}},{key:"destroy",value:function(){}}]),i}(),PE=function(e){m(i,xE);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e.viewer.scene))._canvasToPagePos=n.canvasToPagePos,r.pointerLens=n.pointerLens,r._active=!1,r._currentAngleMeasurement=null,r._initMarkerDiv(),r._snapping=!1!==n.snapping,r._mouseState=0,r._attachPlugin(e,n),r}return I(i,[{key:"_initMarkerDiv",value:function(){var e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this.markerDiv=e}},{key:"_destroyMarkerDiv",value:function(){this.markerDiv&&(this.markerDiv.parentNode.removeChild(this.markerDiv),this.markerDiv=null)}},{key:"_attachPlugin",value:function(e){this.angleMeasurementsPlugin=e,this.plugin=e}},{key:"active",get:function(){return this._active}},{key:"snapping",get:function(){return this._snapping},set:function(e){this._snapping=e}},{key:"activate",value:function(){var e=this;if(!this._active){this.markerDiv||this._initMarkerDiv(),this.angleMeasurementsPlugin;var t=this.scene;t.input;var i=t.canvas.canvas,r=this.angleMeasurementsPlugin.viewer.cameraControl,n=this.pointerLens,s=!1,o=null,a=0,l=0,u=le.vec3(),A=le.vec2();this._currentAngleMeasurement=null;var c=le.vec2(),h=function(t){t.snappedToVertex||t.snappedToEdge?(n&&(n.visible=!0,n.canvasPos=t.canvasPos,n.snappedCanvasPos=t.snappedCanvasPos||t.canvasPos,n.snapped=!0),e.markerDiv.style.background="greenyellow",e.markerDiv.style.border="2px solid green"):(n&&(n.visible=!0,n.canvasPos=t.canvasPos,n.snappedCanvasPos=t.canvasPos,n.snapped=!1),e.markerDiv.style.background="pink",e.markerDiv.style.border="2px solid red");var r=t.snappedCanvasPos||t.canvasPos;switch(s=!0,o=t.entity,u.set(t.worldPos),A.set(r),e._mouseState){case 0:if(e._canvasToPagePos)e._canvasToPagePos(i,r,c),e.markerDiv.style.left="".concat(c[0]-5,"px"),e.markerDiv.style.top="".concat(c[1]-5,"px");else{var a=le.vec2(r);eE(i,e.markerDiv.parentNode,a),e.markerDiv.style.left="".concat(a[0]-5,"px"),e.markerDiv.style.top="".concat(a[1]-5,"px")}break;case 1:e._currentAngleMeasurement&&(e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.angleVisible=!1,e._currentAngleMeasurement.corner.worldPos=t.worldPos,e._currentAngleMeasurement.corner.entity=t.entity),e.markerDiv.style.left="-10000px",e.markerDiv.style.top="-10000px",i.style.cursor="pointer";break;case 2:e._currentAngleMeasurement&&(e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e._currentAngleMeasurement.target.worldPos=t.worldPos,e._currentAngleMeasurement.target.entity=t.entity),e.markerDiv.style.left="-10000px",e.markerDiv.style.top="-10000px",i.style.cursor="pointer"}};this._onHoverSnapOrSurface=r.on("hoverSnapOrSurface",(function(t){e._snapping&&h(t)})),this._onHoverSurface=r.on("hoverSurface",(function(t){e._snapping||h(t)})),i.addEventListener("mousedown",this._onMouseDown=function(e){1===e.which&&(a=e.clientX,l=e.clientY)}),i.addEventListener("mouseup",this._onMouseUp=function(t){if(1===t.which&&!(t.clientX>a+20||t.clientX<a-20||t.clientY>l+20||t.clientY<l-20))switch(e._mouseState){case 0:s&&(e._currentAngleMeasurement=e.angleMeasurementsPlugin.createMeasurement({id:le.createUUID(),origin:{worldPos:u,entity:o},corner:{worldPos:u,entity:o},target:{worldPos:u,entity:o},approximate:!0}),e._currentAngleMeasurement.clickable=!1,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.angleVisible=!1,e._currentAngleMeasurement.origin.entity=o,e._mouseState=1,e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement));break;case 1:s?(e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e._currentAngleMeasurement.corner.entity=o,e._mouseState=2):e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null,o=null,e._mouseState=0,e.angleMeasurementsPlugin.fire("measurementCancel",e._currentAngleMeasurement));break;case 2:s?(e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e._currentAngleMeasurement.target.entity=o,e._currentAngleMeasurement.clickable=!0,o=null,e.angleMeasurementsPlugin.fire("measurementEnd",e._currentAngleMeasurement),e._currentAngleMeasurement=null,e._mouseState=0):e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null,o=null,e._mouseState=0,e.angleMeasurementsPlugin.fire("measurementCancel",e._currentAngleMeasurement))}});var d=function(t){if(s=!1,n&&(n.visible=!0,n.canvasPos=t.canvasPos,n.snappedCanvasPos=t.snappedCanvasPos||t.canvasPos,n.snapped=!1),e.markerDiv.style.left="-100px",e.markerDiv.style.top="-100px",e._currentAngleMeasurement){switch(e._mouseState){case 0:e._currentAngleMeasurement.originVisible=!1;break;case 1:e._currentAngleMeasurement.cornerVisible=!1,e._currentAngleMeasurement.originWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1;break;case 2:e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1}i.style.cursor="default"}};this._onHoverSnapOrSurfaceOff=r.on("hoverSnapOrSurfaceOff",(function(t){e._snapping&&d(t)})),this._onHoverOff=r.on("hoverOff",(function(t){e._snapping||d(t)})),this._active=!0}}},{key:"deactivate",value:function(){if(this._active){this.pointerLens&&(this.pointerLens.visible=!1),this.reset();var e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);var t=this.angleMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}}},{key:"reset",value:function(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._mouseState=0)}},{key:"currentMeasurement",get:function(){return this._currentAngleMeasurement}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),CE=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"AngleMeasurements",e))._container=n.container||document.body,r._defaultControl=null,r._measurements={},r.defaultColor=void 0!==n.defaultColor?n.defaultColor:"#00BBFF",r.defaultLabelsVisible=!1!==n.defaultLabelsVisible,r.zIndex=n.zIndex||1e4,r._onMouseOver=function(e,t){r.fire("mouseOver",{plugin:w(r),angleMeasurement:t,measurement:t,event:e})},r._onMouseLeave=function(e,t){r.fire("mouseLeave",{plugin:w(r),angleMeasurement:t,measurement:t,event:e})},r._onContextMenu=function(e,t){r.fire("contextMenu",{plugin:w(r),angleMeasurement:t,measurement:t,event:e})},r}return I(i,[{key:"getContainerElement",value:function(){return this._container}},{key:"send",value:function(e,t){}},{key:"control",get:function(){return this._defaultControl||(this._defaultControl=new PE(this,{})),this._defaultControl}},{key:"measurements",get:function(){return this._measurements}},{key:"createMeasurement",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);var i=t.origin,r=t.corner,n=t.target,s=new BE(this,{id:t.id,plugin:this,container:this._container,origin:{entity:i.entity,worldPos:i.worldPos},corner:{entity:r.entity,worldPos:r.worldPos},target:{entity:n.entity,worldPos:n.worldPos},visible:t.visible,originVisible:!0,originWireVisible:!0,cornerVisible:!0,targetWireVisible:!0,targetVisible:!0,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[s.id]=s,s.on("destroyed",(function(){delete e._measurements[s.id]})),s.clickable=!0,this.fire("measurementCreated",s),s}},{key:"destroyMeasurement",value:function(e){var t=this._measurements[e];t?(t.destroy(),this.fire("measurementDestroyed",t)):this.log("AngleMeasurement not found: "+e)}},{key:"setLabelsShown",value:function(e){for(var t=0,i=Object.entries(this.measurements);t<i.length;t++){var r=C(i[t],2);r[0];r[1].labelShown=e}}},{key:"clear",value:function(){for(var e=Object.keys(this._measurements),t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}},{key:"destroy",value:function(){this.clear(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),ME=le.vec2(),FE=function(e){m(i,xE);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e.viewer.scene)).pointerLens=n.pointerLens,r.pointerCircle=new Qe(e.viewer),r._active=!1;var s=document.createElement("div"),o=r.scene.canvas.canvas;return o.parentNode.insertBefore(s,o),s.style.background="black",s.style.border="2px solid blue",s.style.borderRadius="10px",s.style.width="5px",s.style.height="5px",s.style.margin="-200px -200px",s.style.zIndex="100",s.style.position="absolute",s.style.pointerEvents="none",r.markerDiv=s,r._currentAngleMeasurement=null,r._longTouchTimeoutMs=300,r._snapping=!1!==n.snapping,r._touchState=0,r._attachPlugin(e,n),r}return I(i,[{key:"_attachPlugin",value:function(e){this.angleMeasurementsPlugin=e,this.plugin=e}},{key:"active",get:function(){return this._active}},{key:"snapping",get:function(){return this._snapping},set:function(e){this._snapping=e}},{key:"activate",value:function(){var e=this;if(!this._active){var t=this.plugin,i=this.scene,r=i.canvas.canvas;t.pointerLens;var n=le.vec3(),s=20,o=null;this._touchState=0;var a=le.vec2(),l=le.vec2(),u=le.vec2(),A=null,c=function(){e.plugin.viewer.cameraControl.active=!1},h=function(){e.plugin.viewer.cameraControl.active=!0},d=function(e,t){return t[0]=e.clientX,t[1]=e.clientY,eE(r.ownerDocument.documentElement,r,t),t},p=function(e,t){return t.set(e),eE(r,r.ownerDocument.documentElement,t),t};r.addEventListener("touchstart",this._onCanvasTouchStart=function(r){var u=r.touches.length;if(1===u){var f=r.touches[0];switch(d(f,a),l.set(a),e._touchState){case 0:if(1!==u&&null!==o)return o&&(clearTimeout(o),o=null),e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null),h(),void(e._touchState=0);var v=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping});if(v&&v.snapped)n.set(v.worldPos),e.pointerCircle.start(p(v.snappedCanvasPos,ME));else{var g=i.pick({canvasPos:l,pickSurface:!0});if(!g||!g.worldPos)return;n.set(g.worldPos),e.pointerCircle.start(p(g.canvasPos,ME))}o=setTimeout((function(){1!==u||l[0]>a[0]+s||l[0]<a[0]-s||l[1]>a[1]+s||l[1]<a[1]-s||(e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=a,e.pointerLens.cursorPos=a),e.pointerLens&&(e.pointerLens.canvasPos=l,e.pointerLens.snapped=!1),e.pointerLens&&(e.pointerLens.cursorPos=v.canvasPos,e.pointerLens.snapped=!0),e._currentAngleMeasurement?e._currentAngleMeasurement.origin.worldPos=n:(e._currentAngleMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:v.worldPos,entity:v.entity},corner:{worldPos:v.worldPos,entity:v.entity},target:{worldPos:v.worldPos,entity:v.entity}}),e._currentAngleMeasurement.clickable=!1,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!1,e._currentAngleMeasurement.cornerVisible=!1,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1),e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement),e._touchState=2,c())}),e._longTouchTimeoutMs),e._touchState=1,A=f.identifier;break;case 3:if(1!==u&&null!==o)return clearTimeout(o),void(o=null);1===u&&(o=setTimeout((function(){if(o=null,!(1!==u||l[0]>a[0]+s||l[0]<a[0]-s||l[1]>a[1]+s||l[1]<a[1]-s)){e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=a,e.pointerLens.snapped=!1);var t=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping});if(t&&t.snapped)e.pointerLens&&(e.pointerLens.cursorPos=t.snappedCanvasPos,e.pointerLens.snapped=!0),e.pointerCircle.start(p(t.snappedCanvasPos,ME)),n.set(t.worldPos),e._currentAngleMeasurement.corner.worldPos=t.worldPos,e._currentAngleMeasurement.corner.entity=t.entity,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1,e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement);else{var r=i.pick({canvasPos:l,pickSurface:!0});r&&r.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=r.canvasPos,e.pointerLens.snapped=!1),e.pointerCircle.start(p(r.canvasPos,ME)),n.set(r.worldPos),e._currentAngleMeasurement.corner.worldPos=r.worldPos,e._currentAngleMeasurement.corner.entity=r.entity,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1,e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement)):e.pointerLens&&(e.pointerLens.cursorPos=null,e.pointerLens.snapped=!1)}e._touchState=5,c()}}),e._longTouchTimeoutMs),e._touchState=4),A=f.identifier;break;case 6:if(1!==u&&null!==o)return clearTimeout(o),void(o=null);1===u&&(o=setTimeout((function(){if(o=null,!(1!==u||l[0]>a[0]+s||l[0]<a[0]-s||l[1]>a[1]+s||l[1]<a[1]-s)){e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=a,e.pointerLens.snapped=!1);var t=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping});if(t&&t.snapped)e.pointerLens&&(e.pointerLens.cursorPos=t.snappedCanvasPos,e.pointerLens.snapped=!0),e.pointerCircle.start(p(t.snappedCanvasPos,ME)),n.set(t.worldPos),e._currentAngleMeasurement.target.worldPos=t.worldPos,e._currentAngleMeasurement.target.entity=t.entity,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement);else{var r=i.pick({canvasPos:l,pickSurface:!0});r&&r.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=r.canvasPos,e.pointerLens.snapped=!1),e.pointerCircle.start(p(r.canvasPos,ME)),n.set(r.worldPos),e._currentAngleMeasurement.target.worldPos=r.worldPos,e._currentAngleMeasurement.target.entity=r.entity,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e.angleMeasurementsPlugin.fire("measurementStart",e._currentAngleMeasurement)):e.pointerLens&&(e.pointerLens.cursorPos=null,e.pointerLens.snapped=!1)}e._touchState=8,c()}}),e._longTouchTimeoutMs),e._touchState=7),A=f.identifier;break;default:return null!==o&&(clearTimeout(o),o=null),void(e._touchState=7)}}else o&&(clearTimeout(o),o=null)},{passive:!0}),r.addEventListener("touchmove",(function(t){e.pointerCircle.stop();var r=t.touches.length;if(1===r&&1===t.changedTouches.length){var s,a,u=t.touches[0];if(u.identifier===A)switch(d(u,l),e._touchState){case 2:e.pointerLens&&(e.pointerLens.canvasPos=l),(s=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping}))&&s.snapped?(e.pointerLens&&(e.pointerLens.snappedCanvasPos=s.snappedCanvasPos,e.pointerLens.snapped=!0),n.set(s.worldPos),e._currentAngleMeasurement.origin.worldPos=s.worldPos):(a=i.pick({canvasPos:l,pickSurface:!0}))&&a.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=a.canvasPos,e.pointerLens.snapped=!1),n.set(a.worldPos),e._currentAngleMeasurement.origin.worldPos=a.worldPos):e.pointerLens&&(e.pointerLens.cursorPos=null,e.pointerLens.snapped=!1),e._touchState=2;break;case 5:if(1!==r&&null!==o)return clearTimeout(o),o=null,e.pointerLens&&(e.pointerLens.visible=!1),void(e._touchState=7);e.pointerLens&&(e.pointerLens.canvasPos=l),(s=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping}))&&s.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=s.snappedCanvasPos,e.pointerLens.snapped=!0),e._currentAngleMeasurement.corner.worldPos=s.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1):(a=i.pick({canvasPos:l,pickSurface:!0}))&&a.worldPos&&(e.pointerLens&&(e.pointerLens.cursorPos=a.canvasPos,e.pointerLens.snapped=!1),e._currentAngleMeasurement.corner.worldPos=a.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1),e._touchState=5;break;case 8:if(1!==r&&null!==o)return clearTimeout(o),o=null,e.pointerLens&&(e.pointerLens.visible=!1),void(e._touchState=7);e.pointerLens&&(e.pointerLens.canvasPos=l),(s=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping}))&&s.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=s.snappedCanvasPos,e.pointerLens.snapped=!0),e._currentAngleMeasurement.target.worldPos=s.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.angleVisible=!0):(a=i.pick({canvasPos:l,pickSurface:!0}))&&a.worldPos&&(e.pointerLens&&(e.pointerLens.cursorPos=a.canvasPos,e.pointerLens.snapped=!1),e._currentAngleMeasurement.target.worldPos=a.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.angleVisible=!0),e._touchState=8}}else o&&(clearTimeout(o),o=null)}),{passive:!0}),r.addEventListener("touchend",this._onCanvasTouchEnd=function(r){e.pointerCircle.stop();var n=r.changedTouches.length;if(1===n){var c=r.changedTouches[0];if(c.identifier===A){o&&(clearTimeout(o),o=null),d(c,u);var p=u[0],f=u[1];switch(e._touchState){case 1:if(1!==n||p>a[0]+s||p<a[0]-s||f>a[1]+s||f<a[1]-s)return void(e._touchState=0);var v=i.pick({canvasPos:l,pickSurface:!0});v&&v.worldPos?(e._currentAngleMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:v.worldPos},corner:{worldPos:v.worldPos},target:{worldPos:v.worldPos}}),e._currentAngleMeasurement.clickable=!1,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!1,e._currentAngleMeasurement.cornerVisible=!1,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1,e._touchState=3):(e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null),e._touchState=0),h();break;case 2:e.pointerLens&&(e.pointerLens.visible=!1),e._currentAngleMeasurement?e._touchState=3:(e.pointerLens&&(e.pointerLens.snapped=!1,e.pointerLens.visible=!1),e._touchState=0),h();break;case 4:if(1!==n||p>a[0]+s||p<a[0]-s||f>a[1]+s||f<a[1]-s)return void(e._touchState=3);var g=i.pick({canvasPos:l,pickSurface:!0});g&&g.worldPos?(e._currentAngleMeasurement.corner.worldPos=g.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!1,e._currentAngleMeasurement.targetVisible=!1,e._currentAngleMeasurement.targetWireVisible=!1,e._currentAngleMeasurement.angleVisible=!1,e._touchState=6):(e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null),e._touchState=0),h();break;case 5:e.pointerLens&&(e.pointerLens.visible=!1),e._touchState=6,h();break;case 7:if(1!==n||p>a[0]+s||p<a[0]-s||f>a[1]+s||f<a[1]-s)return void(e._touchState=6);var m=i.pick({canvasPos:l,pickSurface:!0});m&&m.worldPos?(e._currentAngleMeasurement.target.worldPos=m.worldPos,e._currentAngleMeasurement.originVisible=!0,e._currentAngleMeasurement.originWireVisible=!0,e._currentAngleMeasurement.cornerVisible=!0,e._currentAngleMeasurement.cornerWireVisible=!0,e._currentAngleMeasurement.targetVisible=!0,e._currentAngleMeasurement.targetWireVisible=!0,e._currentAngleMeasurement.angleVisible=!0,e.angleMeasurementsPlugin.fire("measurementEnd",e._currentAngleMeasurement),e._currentAngleMeasurement=null):e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null),e._touchState=0,h();break;case 8:e.pointerLens&&(e.pointerLens.visible=!1),e._currentAngleMeasurement&&e._currentAngleMeasurement.targetVisible?(e._currentAngleMeasurement.clickable=!0,e.angleMeasurementsPlugin.fire("measurementEnd",e._currentAngleMeasurement),e._currentAngleMeasurement=null,e._touchState=0):(e._currentAngleMeasurement&&(e._currentAngleMeasurement.destroy(),e._currentAngleMeasurement=null),e._touchState=0),h()}}}},{passive:!0}),this._active=!0}}},{key:"deactivate",value:function(){if(this._active){this.plugin.pointerLens&&(this.plugin.pointerLens.visible=!1),this.reset();var e=this.plugin.viewer.scene.canvas.canvas;e.removeEventListener("touchstart",this._onCanvasTouchStart),e.removeEventListener("touchend",this._onCanvasTouchEnd),this._active=!1,this.plugin.viewer.cameraControl.active=!0}}},{key:"reset",value:function(){this._active&&this._currentAngleMeasurement&&(this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement),this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null)}},{key:"currentMeasurement",get:function(){return this._currentAngleMeasurement}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),kE=function(e){m(i,Ie);var t=y(i);function i(e,r,n,s){var o;k(this,i);var a=e.plugin.viewer;o=t.call(this,a.scene);var l=AE({viewer:a,handleMouseEvents:n,handleTouchEvents:s,pointerLens:r.pointerLens,dots:[e.origin,e.corner,e.target],ray2WorldPos:function(e,t,i){return function e(t){var r=a.scene.pick({canvasPos:i,snapToEdge:t,snapToVertex:t,pickSurface:!0});return r&&r.worldPos?r.worldPos:t&&e(!1)}(!!r.snapping)},onEnd:function(e,t){var i=!le.compareVec3(e,t.worldPos);return i&&o.fire("edited"),i}}),u=e.on("destroyed",l);return o._deactivate=function(){e.off("destroyed",u),l()},o}return I(i,[{key:"deactivate",value:function(){this._deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),EE=function(e){m(i,kE);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!0,!1)}return I(i)}(),IE=function(e){m(i,kE);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!1,!0)}return I(i)}(),TE=le.vec3(),DE=le.vec3(),SE=le.vec3(),RE=function(e){return e+"px"},UE=function(e){m(i,Zc);var t=y(i);function i(e,r){var n;if(k(this,i),(n=t.call(this,e,r)).plugin=r.plugin,n._container=r.container,!n._container)throw"config missing: container";if(!r.markerElement&&!r.markerHTML)throw"config missing: need either markerElement or markerHTML";if(!r.labelElement&&!r.labelHTML)throw"config missing: need either labelElement or labelHTML";return n._htmlDirty=!1,n._curMarkerWidth=void 0,n._curLabelWidth=0,r.markerElement?(n._marker=r.markerElement,n._marker.addEventListener("click",n._onMouseClickedExternalMarker=function(){n.plugin.fire("markerClicked",w(n))}),n._onContextMenuExternalMarker=function(){n.plugin.fire("contextmenu",w(n))},n._onContextMenuExternalMarkerRemover=Uk(n._marker,n._onContextMenuExternalMarker),n._marker.addEventListener("mouseenter",n._onMouseEnterExternalMarker=function(){n.plugin.fire("markerMouseEnter",w(n))}),n._marker.addEventListener("mouseleave",n._onMouseLeaveExternalMarker=function(){n.plugin.fire("markerMouseLeave",w(n))}),n._markerExternal=!0):(n._markerHTML=r.markerHTML,n._htmlDirty=!0,n._markerExternal=!1),r.labelElement?(n._label=r.labelElement,n._labelExternal=!0):(n._labelHTML=r.labelHTML,n._htmlDirty=!0,n._labelExternal=!1),n._markerShown=!!r.markerShown,n._labelShown=!!r.labelShown,n._values=r.values||{},n._layoutDirty=!0,n._visibilityDirty=!0,n._labelPosition=24,n._buildHTML(),n._onTick=n.scene.on("tick",(function(){n._htmlDirty&&(n._buildHTML(),n._htmlDirty=!1,n._layoutDirty=!0,n._visibilityDirty=!0),(n._layoutDirty||n._visibilityDirty)&&(n._markerShown||n._labelShown)&&(n._updatePosition(),n._layoutDirty=!1),n._visibilityDirty&&(n._marker.style.visibility=n.visible&&n._markerShown?"visible":"hidden",n._label.style.visibility=n.visible&&n._markerShown&&n._labelShown?"visible":"hidden",n._visibilityDirty=!1)})),n.on("canvasPos",(function(){n._layoutDirty=!0})),n.on("visible",(function(){n._visibilityDirty=!0})),n.setMarkerShown(!1!==r.markerShown),n.setLabelShown(r.labelShown),n.eye=r.eye?r.eye.slice():null,n.look=r.look?r.look.slice():null,n.up=r.up?r.up.slice():null,n.projection=r.projection,n}return I(i,[{key:"_buildHTML",value:function(){var e=this;if(!this._markerExternal){this._marker&&(this._container.removeChild(this._marker),this._marker=null);var t=this._markerHTML||"<p></p>";ge.isArray(t)&&(t=t.join("")),t=this._renderTemplate(t.trim());var i=document.createRange().createContextualFragment(t);this._marker=i.firstChild,this._container.appendChild(this._marker),this._marker.style.visibility=this._markerShown?"visible":"hidden",this._marker.addEventListener("click",(function(){e.plugin.fire("markerClicked",e)})),Uk(this._marker,(function(t){t.preventDefault(),e.plugin.fire("contextmenu",e)}),(function(t){t.preventDefault(),e.plugin.fire("markerClicked",e)})),this._marker.addEventListener("mouseenter",(function(){e.plugin.fire("markerMouseEnter",e)})),this._marker.addEventListener("mouseleave",(function(){e.plugin.fire("markerMouseLeave",e)})),this._marker.addEventListener("wheel",(function(t){e.plugin.viewer.scene.canvas.canvas.dispatchEvent(new WheelEvent("wheel",t))}))}if(!this._labelExternal){this._label&&(this._container.removeChild(this._label),this._label=null);var r=this._labelHTML||"<p></p>";ge.isArray(r)&&(r=r.join("")),r=this._renderTemplate(r.trim());var n=document.createRange().createContextualFragment(r);this._label=n.firstChild,this._container.appendChild(this._label),this._label.style.visibility=this._markerShown&&this._labelShown?"visible":"hidden",this._label.addEventListener("wheel",(function(t){e.plugin.viewer.scene.canvas.canvas.dispatchEvent(new WheelEvent("wheel",t))}))}}},{key:"_updateWithCurWidths",value:function(){var e=this.scene.canvas.boundary,t=e[0]+this.canvasPos[0],i=e[1]+this.canvasPos[1];if(this._marker.style.top=RE(i-12),this._label.style.top=RE(i-17),"legacy"===this._markerAlign)this._marker.style.left=RE(t-12),this._label.style.left=RE(t+40);else{var r=this._curMarkerWidth,n=t+("right"===this._markerAlign?-1:"center"===this._markerAlign?0:1)*(r/2-12);this._marker.style.left=RE(n-r/2);var s=this._curLabelWidth,o=Math.sign(this._labelPosition);this._label.style.left=RE(n+o*(r/2+Math.abs(this._labelPosition)+s/2)-s/2)}var a=90005+Math.floor(this._viewPos[2])+1;this._marker.style["z-index"]=a,this._label.style["z-index"]=a}},{key:"_updateIfWidthsChanged",value:function(){var e=!1,t=this._marker.getBoundingClientRect().width;if(this._curMarkerWidth!==t&&(this._curMarkerWidth=t,e=!0),1!==Math.sign(this._labelPosition)){var i=this._label.getBoundingClientRect().width;this._curLabelWidth!==i&&(this._curLabelWidth=i,e=!0)}e&&this._updateWithCurWidths()}},{key:"_updatePosition",value:function(){var e=this,t="legacy"===this._markerAlign;t||void 0!==this._curMarkerWidth?(this._updateWithCurWidths(),window.clearTimeout(this._widthTimeout),t||(this._widthTimeout=window.setTimeout((function(){return e._updateIfWidthsChanged()}),500))):this._updateIfWidthsChanged()}},{key:"_renderTemplate",value:function(e){for(var t in this._values)if(this._values.hasOwnProperty(t)){var i=this._values[t];e=e.replace(new RegExp("{{"+t+"}}","g"),i)}return e}},{key:"setFromPickResult",value:function(e){if(e.worldPos&&e.worldNormal){var t=le.normalizeVec3(e.worldNormal,TE),i=this.plugin&&this.plugin.surfaceOffset||0,r=le.mulVec3Scalar(t,i,DE),n=le.addVec3(e.worldPos,r,SE);this.entity=e.entity,this.worldPos=n}else this.error("Param 'pickResult' does not have both worldPos and worldNormal")}},{key:"setMarkerAlign",value:function(e){var t=["left","center","right","legacy"];t.includes(e)?(this._markerAlign=e,this._updatePosition()):this.error("Param 'align' should be one of: "+JSON.stringify(t))}},{key:"setLabelPosition",value:function(e){"number"!=typeof e?this.error("Param 'position' is not a number"):0===e?this.error("Param 'position' is zero"):(this._labelPosition=e,this._updatePosition())}},{key:"setMarkerShown",value:function(e){e=!!e,this._markerShown!==e&&(this._markerShown=e,this._visibilityDirty=!0)}},{key:"getMarkerShown",value:function(){return this._markerShown}},{key:"setLabelShown",value:function(e){e=!!e,this._labelShown!==e&&(this._labelShown=e,this._visibilityDirty=!0)}},{key:"getLabelShown",value:function(){return this._labelShown}},{key:"setField",value:function(e,t){this._values[e]=t||"",this._htmlDirty=!0}},{key:"getField",value:function(e){return this._values[e]}},{key:"setValues",value:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];this.setField(t,i)}}},{key:"getValues",value:function(){return this._values}},{key:"destroy",value:function(){window.clearTimeout(this._widthTimeout),this._marker&&(this._markerExternal?(this._marker.removeEventListener("click",this._onMouseClickedExternalMarker),this._onContextMenuExternalMarkerRemover(),this._marker.removeEventListener("mouseenter",this._onMouseEnterExternalMarker),this._marker.removeEventListener("mouseleave",this._onMouseLeaveExternalMarker),this._marker=null):(this._marker.parentNode.removeChild(this._marker),this._marker=null)),this._label&&(this._labelExternal||this._label.parentNode.removeChild(this._label),this._label=null),this.scene.off(this._onTick),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),LE=function(e){m(i,vh);var t=y(i);function i(e,r){var n;return k(this,i),(n=t.call(this,"Annotations",e))._labelHTML=r.labelHTML||"<div></div>",n._markerHTML=r.markerHTML||"<div></div>",n._container=r.container||document.body,n._values=r.values||{},n.annotations={},n.surfaceOffset=r.surfaceOffset,n}return I(i,[{key:"getContainerElement",value:function(){return this._container}},{key:"send",value:function(e,t){if("clearAnnotations"===e)this.clear()}},{key:"surfaceOffset",get:function(){return this._surfaceOffset},set:function(e){null==e&&(e=.3),this._surfaceOffset=e}},{key:"createAnnotation",value:function(e){var t=this;this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);var i=null;e.markerElementId&&((i=document.getElementById(e.markerElementId))||this.error("Can't find DOM element for 'markerElementId' value '"+e.markerElementId+"' - defaulting to internally-generated empty DIV"));var r=null;e.labelElementId&&((r=document.getElementById(e.labelElementId))||this.error("Can't find DOM element for 'labelElementId' value '"+e.labelElementId+"' - defaulting to internally-generated empty DIV"));var n=new UE(this.viewer.scene,{id:e.id,plugin:this,container:this._container,markerElement:i,labelElement:r,markerHTML:e.markerHTML||this._markerHTML,labelHTML:e.labelHTML||this._labelHTML,occludable:e.occludable,values:ge.apply(e.values,ge.apply(this._values,{})),markerShown:e.markerShown,labelShown:e.labelShown,eye:e.eye,look:e.look,up:e.up,projection:e.projection,visible:!1!==e.visible});return e.pickResult=e.pickResult||e.pickRecord,e.pickResult?n.setFromPickResult(e.pickResult):(n.entity=e.entity,n.worldPos=e.worldPos),this.annotations[n.id]=n,n.on("destroyed",(function(){delete t.annotations[n.id],t.fire("annotationDestroyed",n.id)})),this.fire("annotationCreated",n.id),n}},{key:"destroyAnnotation",value:function(e){var t=this.annotations[e];t?t.destroy():this.log("Annotation not found: "+e)}},{key:"clear",value:function(){for(var e=Object.keys(this.annotations),t=0,i=e.length;t<i;t++)this.destroyAnnotation(e[t])}},{key:"destroy",value:function(){this.clear(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),OE=function(e){m(i,vh);var t=y(i);function i(e,r){var n;k(this,i),r=r||{},n=t.call(this,"AxisGizmo",e,r);var s=e.scene.camera;r.canvasId||r.canvasElement||n.error("Config expected: either 'canvasId' or 'canvasElement'");try{n._axisGizmoScene=new Jd(e,{canvasId:r.canvasId,canvasElement:r.canvasElement,transparent:!0})}catch(e){return n.error(e),b(n)}var o=n._axisGizmoScene;o.clearLights(),new Oc(o,{color:[.45,.45,.5],intensity:.9}),new Vc(o,{dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new Vc(o,{dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"});var a=o.camera;s.on("matrix",(function(){var e=s.eye,t=s.look,i=s.up,r=le.mulVec3Scalar(le.normalizeVec3(le.subVec3(e,t,[])),22);a.look=[0,0,0],a.eye=r,a.up=i}));var l=new mt(o,Ft({radiusTop:.01,radiusBottom:.6,height:1.7,radialSegments:20,heightSegments:1,openEnded:!1})),u=new mt(o,Ft({radiusTop:.2,radiusBottom:.2,height:4.5,radialSegments:20,heightSegments:1,openEnded:!1})),A=new bn(o,{diffuse:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),c=new bn(o,{emissive:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),h=new bn(o,{diffuse:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),d=new bn(o,{emissive:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),p=new bn(o,{diffuse:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),f=new bn(o,{emissive:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),v=new bn(o,{diffuse:[.5,.5,.5],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2});return n._meshes=[new vn(o,{geometry:new mt(o,It({radius:9,heightSegments:60,widthSegments:60})),material:new bn(o,{diffuse:[0,0,0],emissive:[.1,.1,.1],ambient:[.1,.1,.2],specular:[0,0,0],alpha:.4,alphaMode:"blend",frontface:"cw"}),pickable:!1,collidable:!1,visible:!1!==r.visible}),new vn(o,{geometry:new mt(o,It({radius:1})),material:v,pickable:!1,collidable:!1,visible:!1!==r.visible}),new vn(o,{geometry:l,material:A,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[5,0,0],rotation:[0,0,-90]}),new vn(o,{geometry:u,material:A,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[2,0,0],rotation:[0,0,90]}),new vn(o,{geometry:new mt(o,St({text:"X",size:1.5})),material:c,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[7,0,0],billboard:"spherical"}),new vn(o,{geometry:l,material:h,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,5,0]}),new vn(o,{geometry:u,material:h,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,2,0]}),new vn(o,{geometry:new mt(o,St({text:"Y",size:1.5})),material:d,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,7,0],billboard:"spherical"}),new vn(o,{geometry:l,material:p,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,0,5],rotation:[90,0,0]}),new vn(o,{geometry:u,material:p,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,0,2],rotation:[90,0,0]}),new vn(o,{geometry:new mt(o,St({text:"Z",size:1.5})),material:f,pickable:!1,collidable:!1,visible:!1!==r.visible,position:[0,0,7],billboard:"spherical"})],n}return I(i,[{key:"setVisible",value:function(e){for(var t=0;t<this._meshes.length;t++)this._meshes[t].visible=e}},{key:"destroy",value:function(){this._axisGizmoCanvas=null,this._axisGizmoScene.destroy(),this._axisGizmoScene=null,v(x(i.prototype),"destroy",this).call(this)}}]),i}(),NE=le.vec3(),VE=le.vec3(),QE=le.vec3(),HE=le.vec3(),GE=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"BCFViewpoints",e,n)).originatingSystem=n.originatingSystem||"xeokit.io",r.authoringTool=n.authoringTool||"xeokit.io",r}return I(i,[{key:"getViewpoint",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=this.viewer.scene,r=i.camera,n=i.realWorldOffset,s=!0===t.reverseClippingPlanes,o={},a=le.normalizeVec3(le.subVec3(r.look,r.eye,le.vec3())),l=r.eye,u=r.up;r.yUp&&(a=WE(a),l=WE(l),u=WE(u));var A=jE(le.addVec3(l,n));"ortho"===r.projection?o.orthogonal_camera={camera_view_point:A,camera_direction:jE(a),camera_up_vector:jE(u),view_to_world_scale:r.ortho.scale}:o.perspective_camera={camera_view_point:A,camera_direction:jE(a),camera_up_vector:jE(u),field_of_view:r.perspective.fov};var c=i.sectionPlanes;for(var h in c)if(c.hasOwnProperty(h)){var d=c[h];if(!d.active)continue;var p=d.pos,f=void 0;f=s?le.negateVec3(d.dir,le.vec3()):d.dir,r.yUp&&(p=WE(p),f=WE(f)),le.addVec3(p,n),p=jE(p),f=jE(f),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:p,direction:f})}var v=i.lineSets;for(var g in v)if(v.hasOwnProperty(g)){var m=v[g];o.lines||(o.lines=[]);for(var _=m.positions,y=m.indices,b=0,w=y.length/2;b<w;b++){var B=y[2*b],x=y[2*b+1];o.lines.push({start_point:{x:_[3*B+0],y:_[3*B+1],z:_[3*B+2]},end_point:{x:_[3*x+0],y:_[3*x+1],z:_[3*x+2]}})}}var P=i.bitmaps;for(var M in P)if(P.hasOwnProperty(M)){var F=P[M],k=F.pos,E=F.normal,I=F.up;r.yUp&&(k=WE(k),E=WE(E),I=WE(I)),le.addVec3(k,n),o.bitmaps||(o.bitmaps=[]),o.bitmaps.push({bitmap_type:F.type,bitmap_data:F.imageData,location:jE(k),normal:jE(E),up:jE(I),height:F.height})}o.components={visibility:{view_setup_hints:{spaces_visible:!!t.spacesVisible,space_boundaries_visible:!!t.spaceBoundariesVisible,openings_visible:!!t.openingsVisible,spaces_translucent:!!t.spaces_translucent,space_boundaries_translucent:!!t.space_boundaries_translucent,openings_translucent:!!t.openings_translucent}}};var T=new Set(i.opacityObjectIds),D=new Set(i.xrayedObjectIds),S=new Set(i.colorizedObjectIds),R=Object.values(i.objects).filter((function(e){return T.has(e.id)||S.has(e.id)||D.has(e.id)})).reduce((function(t,r){var n,s=KE(r.colorize);r.xrayed?(n=0===i.xrayMaterial.fillAlpha&&0!==i.xrayMaterial.edgeAlpha?.1:i.xrayMaterial.fillAlpha,s=(n=Math.round(255*n).toString(16).padStart(2,"0"))+s):T.has(r.id)&&(s=(n=Math.round(255*r.opacity).toString(16).padStart(2,"0"))+s),t[s]||(t[s]=[]);var o=r.id,a=r.originalSystemId,l={ifc_guid:a,originating_system:e.originatingSystem};return a!==o&&(l.authoring_tool_id=o),t[s].push(l),t}),{}),U=Object.entries(R).map((function(e){var t=C(e,2);return{color:t[0],components:t[1]}}));o.components.coloring=U;var L=i.objectIds,O=i.visibleObjects,N=i.visibleObjectIds,V=L.filter((function(e){return!O[e]})),Q=i.selectedObjectIds;return t.defaultInvisible||N.length<V.length?(o.components.visibility.exceptions=this._createBCFComponents(N),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(V),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(Q),o.components.translucency=this._createBCFComponents(i.xrayedObjectIds),!1!==t.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}},{key:"_createBCFComponents",value:function(e){for(var t=this.viewer.scene,i=[],r=0,n=e.length;r<n;r++){var s=e[r],o=t.objects[s];if(o){var a={ifc_guid:o.originalSystemId,originating_system:this.originatingSystem};o.originalSystemId!==s&&(a.authoring_tool_id=s),i.push(a)}}return i}},{key:"setViewpoint",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e){var r=this.viewer,n=r.scene,s=n.camera,o=!1!==i.rayCast,a=!1!==i.immediate,l=!1!==i.reset,u=n.realWorldOffset,A=!0===i.reverseClippingPlanes;if(n.clearSectionPlanes(),e.clipping_planes&&e.clipping_planes.length>0&&e.clipping_planes.forEach((function(e){var t=zE(e.location,NE),i=zE(e.direction,NE);A&&le.negateVec3(i),le.subVec3(t,u),s.yUp&&(t=XE(t),i=XE(i)),new hh(n,{pos:t,dir:i})})),n.clearLines(),e.lines&&e.lines.length>0){var c=[],h=[],d=0;e.lines.forEach((function(e){e.start_point&&e.end_point&&(c.push(e.start_point.x),c.push(e.start_point.y),c.push(e.start_point.z),c.push(e.end_point.x),c.push(e.end_point.y),c.push(e.end_point.z),h.push(d++),h.push(d++))})),new Uc(n,{positions:c,indices:h,clippable:!1,collidable:!0})}if(n.clearBitmaps(),e.bitmaps&&e.bitmaps.length>0&&e.bitmaps.forEach((function(e){var t=e.bitmap_type||"jpg",i=e.bitmap_data,r=zE(e.location,VE),o=zE(e.normal,QE),a=zE(e.up,HE),l=e.height||1;t&&i&&r&&o&&a&&(s.yUp&&(r=XE(r),o=XE(o),a=XE(a)),new Zn(n,{src:i,type:t,pos:r,normal:o,up:a,clippable:!1,collidable:!0,height:l}))})),l&&(n.setObjectsXRayed(n.xrayedObjectIds,!1),n.setObjectsHighlighted(n.highlightedObjectIds,!1),n.setObjectsSelected(n.selectedObjectIds,!1)),e.components){if(e.components.visibility){e.components.visibility.default_visibility?(n.setObjectsVisible(n.objectIds,!0),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.visible=!1}))}))):(n.setObjectsVisible(n.objectIds,!1),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.visible=!0}))})));var p=e.components.visibility.view_setup_hints;p&&(!1===p.spaces_visible&&n.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcSpace"),!1),void 0!==p.spaces_translucent&&n.setObjectsXRayed(r.metaScene.getObjectIDsByType("IfcSpace"),!0),p.space_boundaries_visible,!1===p.openings_visible&&n.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcOpening"),!0),p.space_boundaries_translucent,void 0!==p.openings_translucent&&n.setObjectsXRayed(r.metaScene.getObjectIDsByType("IfcOpening"),!0))}e.components.selection&&(n.setObjectsSelected(n.selectedObjectIds,!1),e.components.selection.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.selected=!0}))}))),e.components.translucency&&(n.setObjectsXRayed(n.xrayedObjectIds,!1),e.components.translucency.forEach((function(e){return t._withBCFComponent(i,e,(function(e){return e.xrayed=!0}))}))),e.components.coloring&&(n.setObjectsColorized(n.colorizedObjectIds,null),e.components.coloring.forEach((function(e){var r=e.color,n=0,s=!1;8===r.length&&((n=parseInt(r.substring(0,2),16)/255)<=1&&n>=.95&&(n=1),r=r.substring(2),s=!0);var o=[parseInt(r.substring(0,2),16)/255,parseInt(r.substring(2,4),16)/255,parseInt(r.substring(4,6),16)/255];e.components.map((function(e){return t._withBCFComponent(i,e,(function(e){e.colorize=o,s&&(e.opacity=n)}))}))})))}if(e.perspective_camera||e.orthogonal_camera){var f,v,g,m;if(e.perspective_camera?(f=zE(e.perspective_camera.camera_view_point,NE),v=zE(e.perspective_camera.camera_direction,NE),g=zE(e.perspective_camera.camera_up_vector,NE),s.perspective.fov=e.perspective_camera.field_of_view,m="perspective"):(f=zE(e.orthogonal_camera.camera_view_point,NE),v=zE(e.orthogonal_camera.camera_direction,NE),g=zE(e.orthogonal_camera.camera_up_vector,NE),s.ortho.scale=e.orthogonal_camera.view_to_world_scale,m="ortho"),le.subVec3(f,u),s.yUp&&(f=XE(f),v=XE(v),g=XE(g)),o){var _=n.pick({pickSurface:!0,origin:f,direction:v});v=_?_.worldPos:le.addVec3(f,v,NE)}else v=le.addVec3(f,v,NE);a?(s.eye=f,s.look=v,s.up=g,s.projection=m):r.cameraFlight.flyTo({eye:f,look:v,up:g,duration:i.duration,projection:m})}}}},{key:"_withBCFComponent",value:function(e,t,i){var r=this.viewer,n=r.scene;if(t.authoring_tool_id&&t.originating_system===this.originatingSystem){var s=t.authoring_tool_id,o=n.objects[s];if(o)return void i(o);if(e.updateCompositeObjects)if(r.metaScene.metaObjects[s])return void n.withObjects(r.metaScene.getObjectIDsInSubtree(s),i)}if(t.ifc_guid){var a=t.ifc_guid,l=n.objects[a];if(l)return void i(l);if(e.updateCompositeObjects)if(r.metaScene.metaObjects[a])return void n.withObjects(r.metaScene.getObjectIDsInSubtree(a),i);Object.keys(n.models).forEach((function(t){var s=le.globalizeObjectId(t,a),o=n.objects[s];o?i(o):e.updateCompositeObjects&&r.metaScene.metaObjects[s]&&n.withObjects(r.metaScene.getObjectIDsInSubtree(s),i)}))}}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}();function jE(e){return{x:e[0],y:e[1],z:e[2]}}function zE(e,t){return(t=new Float64Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t}function WE(e){return new Float64Array([e[0],-e[2],e[1]])}function XE(e){return new Float64Array([e[0],e[2],-e[1]])}function KE(e){var t="";return t+=Math.round(255*e[0]).toString(16).padStart(2,"0"),t+=Math.round(255*e[1]).toString(16).padStart(2,"0"),t+=Math.round(255*e[2]).toString(16).padStart(2,"0")}var ZE=le.vec3(),JE=le.vec3(),YE=le.vec3();le.vec4(),le.vec4(),le.vec4();var qE=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i);var s=e.viewer.scene;(r=t.call(this,s,n)).plugin=e;var o=n.container;if(!o)throw"config missing: container";r._color=n.color||e.defaultColor;var a=function(e,t){var i=[],r=void 0!==e?Boolean(e):t;return{reg:function(e){return i.push(e)},get:function(){return r},set:function(e){r=void 0!==e?Boolean(e):t,i.forEach((function(e){return e(r)}))}}};r._visible=a(n.visible,e.defaultVisible),r._originVisible=a(n.originVisible,e.defaultOriginVisible),r._targetVisible=a(n.targetVisible,e.defaultTargetVisible),r._axisVisible=a(n.axisVisible,e.defaultAxisVisible),r._xAxisVisible=a(n.xAxisVisible,e.defaultAxisVisible),r._yAxisVisible=a(n.yAxisVisible,e.defaultAxisVisible),r._zAxisVisible=a(n.zAxisVisible,e.defaultAxisVisible),r._axisEnabled=a(!0,e.defaultAxisVisible),r._wireVisible=a(n.wireVisible,e.defaultWireVisible),r._xLabelEnabled=a(n.xLabelEnabled,e.defaultXLabelEnabled),r._yLabelEnabled=a(n.yLabelEnabled,e.defaultYLabelEnabled),r._zLabelEnabled=a(n.zLabelEnabled,e.defaultZLabelEnabled),r._lengthLabelEnabled=a(n.lengthLabelEnabled,e.defaultLengthLabelEnabled),r._labelsVisible=a(n.labelsVisible,e.defaultLabelsVisible),r._clickable=a(!1,!1),r._labelsOnWires=a(n.labelsOnWires,e.defaultLabelsOnWires),r._useRotationAdjustment=a(n.useRotationAdjustment,e.useRotationAdjustment),r._axesBasis=le.identityMat4(),r.approximate=n.approximate;var l=s.canvas.canvas,u=n.onMouseOver?function(e){n.onMouseOver(e,w(r)),l.dispatchEvent(new MouseEvent("mouseover",e))}:null,A=n.onMouseLeave?function(e){n.onMouseLeave(e,w(r)),l.dispatchEvent(new MouseEvent("mouseleave",e))}:null,c=n.onContextMenu?function(e){n.onContextMenu(e,w(r))}:null,h=function(e){return l.dispatchEvent(new MouseEvent("mousedown",e))},d=function(e){return l.dispatchEvent(new MouseEvent("mouseup",e))},p=function(e){return l.dispatchEvent(new MouseEvent("mousemove",e))},f=function(e){return l.dispatchEvent(new WheelEvent("wheel",e))};r._cleanups=[],["units","scale"].forEach((function(e){var t=s.metrics.on("units",(function(){return r._update()}));r._cleanups.push((function(){return s.metrics.off(t)}))})),r._drawables=[];var v=function(e,t){var i=function(){return e.setVisible(t.every((function(e){return e.get()})))};t.forEach((function(e){return e.reg(i)})),r._drawables.push(e),r._cleanups.push((function(){return e.destroy()}))},g=function(t,i,r){var n=new oE(s,o,{color:t,thickness:i,thicknessClickable:6,zIndex:void 0!==e.zIndex?e.zIndex+1:void 0,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return v(n,r),{setEnds:function(e,t){return n.setEnds(e,t)},setColor:function(e){return n.setColor(e)}}};r._lengthWire=g(r._color,2,[r._visible,r._wireVisible]),r._xAxisWire=g("red",1,[r._visible,r._axisEnabled,r._axisVisible,r._xAxisVisible]),r._yAxisWire=g("green",1,[r._visible,r._axisEnabled,r._axisVisible,r._yAxisVisible]),r._zAxisWire=g("blue",1,[r._visible,r._axisEnabled,r._axisVisible,r._zAxisVisible]);var m=function(t,i,r){var n=new sE(s,o,{fillColor:t,zIndex:void 0!==e.zIndex?e.zIndex+i:void 0,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return v(n,r),{setFillColor:function(e){return n.setFillColor(e)},setPosOnWire:function(e,t,i,r){return n.setPosOnWire(e,t,i,r)},setPosBetween:function(e,t,i){return n.setPosBetween(e,t,i)},setText:function(e){return n.setText(e.replace(/ /g,"&nbsp;"))}}};r._lengthLabel=m(r._color,4,[r._visible,r._wireVisible,r._labelsVisible,r._clickable,r._axisEnabled,r._lengthLabelEnabled]),r._xAxisLabel=m("red",3,[r._visible,r._axisEnabled,r._axisVisible,r._xAxisVisible,r._labelsVisible,r._clickable,r._xLabelEnabled]),r._yAxisLabel=m("green",3,[r._visible,r._axisEnabled,r._axisVisible,r._yAxisVisible,r._labelsVisible,r._clickable,r._yLabelEnabled]),r._zAxisLabel=m("blue",3,[r._visible,r._axisEnabled,r._axisVisible,r._zAxisVisible,r._labelsVisible,r._clickable,r._zLabelEnabled]);var _=function(t,i){var n=new nE(s,t,o,{fillColor:r._color,zIndex:void 0!==e.zIndex?e.zIndex+2:void 0,onMouseOver:u,onMouseLeave:A,onMouseWheel:f,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return n.on("worldPos",(function(){return r._update()})),v(n,i),n};return r._originDot=_(n.origin,[r._visible,r._originVisible]),r._targetDot=_(n.target,[r._visible,r._targetVisible]),r._update(),r}return I(i,[{key:"_update",value:function(){var e=this;if(this._targetDot){var t=this._originDot.worldPos,i=this._targetDot.worldPos,r=this._axesBasis,n=le.subVec3(i,t,ZE),s=le.transformVec3(r,n,n),o=this._useRotationAdjustment.get()&&Math.abs(n[1])>0,a=function(r,n){var s=e.plugin.viewer.scene.metrics,a=s.scale,l=s.unitsInfo[s.units].abbrev,u=function(r,n,s,o){e._labelsOnWires.get()?r.setPosOnWire(n,s,0,e.plugin.labelMinAxisLength):r.setPosOnWire(t,i,35*o,0)},A=function(t){return(e._approximate?" ~ ":" = ")+t.toFixed(2)+l};e._xAxisWire.setEnds(t,r),u(e._xAxisLabel,t,r,1),e._xAxisLabel.setText("X"+A(le.distVec3(t,r)*a)),e._yAxisWire.setEnds(r,n),u(e._yAxisLabel,r,n,2),e._yAxisLabel.setText("Y"+A(le.distVec3(r,n)*a)),e._zAxisWire.setEnds(n,i),u(e._zAxisLabel,n,i,3),e._zAxisLabel.setText((o?"":"Z")+A(le.distVec3(n,i)*a)),e._lengthWire.setEnds(t,i),u(e._lengthLabel,t,i,0),e._length=le.distVec3(t,i)*a,e._lengthLabel.setText(A(e._length))};o?(YE[0]=t[0],YE[1]=i[1],YE[2]=t[2],a(t,YE)):(JE[0]=t[0]+r[0]*s[0],JE[1]=t[1]+r[4]*s[0],JE[2]=t[2]+r[8]*s[0],YE[0]=JE[0]+r[1]*s[1],YE[1]=JE[1]+r[5]*s[1],YE[2]=JE[2]+r[9]*s[1],a(JE,YE))}}},{key:"axesBasis",get:function(){return this._axesBasis},set:function(e){this._axesBasis.set(e),this._update()}},{key:"approximate",get:function(){return this._approximate},set:function(e){e=!1!==e,this._approximate!==e&&(this._approximate=e,this._update())}},{key:"origin",get:function(){return this._originDot}},{key:"target",get:function(){return this._targetDot}},{key:"length",get:function(){return this._length}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._originDot.setFillColor(e),this._targetDot.setFillColor(e),this._lengthWire.setColor(e),this._lengthLabel.setFillColor(e)}},{key:"visible",get:function(){return this._visible.get()},set:function(e){this._visible.set(e)}},{key:"originVisible",get:function(){return this._originVisible.get()},set:function(e){this._originVisible.set(e)}},{key:"targetVisible",get:function(){return this._targetVisible.get()},set:function(e){this._targetVisible.set(e)}},{key:"useRotationAdjustment",get:function(){return this._useRotationAdjustment.get()},set:function(e){this._useRotationAdjustment.set(e),this._update()}},{key:"axisEnabled",get:function(){return this._axisEnabled.get()},set:function(e){this._axisEnabled.set(e)}},{key:"axisVisible",get:function(){return this._axisVisible.get()},set:function(e){this._axisVisible.set(e)}},{key:"xAxisVisible",get:function(){return this._xAxisVisible.get()},set:function(e){this._xAxisVisible.set(e)}},{key:"yAxisVisible",get:function(){return this._yAxisVisible.get()},set:function(e){this._yAxisVisible.set(e)}},{key:"zAxisVisible",get:function(){return this._zAxisVisible.get()},set:function(e){this._zAxisVisible.set(e)}},{key:"wireVisible",get:function(){return this._wireVisible.get()},set:function(e){this._wireVisible.set(e)}},{key:"labelsVisible",get:function(){return this._labelsVisible.get()},set:function(e){this._labelsVisible.set(e)}},{key:"xLabelEnabled",get:function(){return this._xLabelEnabled.get()},set:function(e){this._xLabelEnabled.set(e)}},{key:"yLabelEnabled",get:function(){return this._yLabelEnabled.get()},set:function(e){this._yLabelEnabled.set(e)}},{key:"zLabelEnabled",get:function(){return this._zLabelEnabled.get()},set:function(e){this._zLabelEnabled.set(e)}},{key:"lengthLabelEnabled",get:function(){return this._lengthLabelEnabled.get()},set:function(e){this._lengthLabelEnabled.set(e)}},{key:"labelsOnWires",get:function(){return this._labelsOnWires.get()},set:function(e){this._labelsOnWires.set(e),this._update()}},{key:"setHighlighted",value:function(e){this._drawables.forEach((function(t){return t.setHighlighted(e)}))}},{key:"clickable",get:function(){return this._clickable.get()},set:function(e){var t=this;this._clickable.set(!!e),this._drawables.forEach((function(e){return e.setClickable(t._clickable.get())}))}},{key:"destroy",value:function(){this._cleanups.forEach((function(e){return e()})),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),$E=function(e){m(i,Ie);var t=y(i);function i(){return k(this,i),t.apply(this,arguments)}return I(i,[{key:"active",get:function(){}},{key:"snapping",get:function(){return!0},set:function(e){}},{key:"activate",value:function(){}},{key:"deactivate",value:function(){}},{key:"reset",value:function(){}},{key:"currentMeasurement",get:function(){return null}},{key:"destroy",value:function(){}}]),i}(),eI=function(e){m(i,$E);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e.viewer.scene))._canvasToPagePos=n.canvasToPagePos,r.pointerLens=n.pointerLens,r._active=!1,r._currentDistanceMeasurement=null,r._currentDistanceMeasurementInitState={wireVisible:null,axisVisible:null,xAxisVisible:null,yaxisVisible:null,zAxisVisible:null,targetVisible:null},r._initMarkerDiv(),r._snapping=!1!==n.snapping,r._mouseState=0,r._attachPlugin(e,n),r}return I(i,[{key:"_initMarkerDiv",value:function(){var e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this._markerDiv=e}},{key:"_destroyMarkerDiv",value:function(){this._markerDiv&&(this._markerDiv.parentNode.removeChild(this._markerDiv),this._markerDiv=null)}},{key:"_attachPlugin",value:function(e){this.distanceMeasurementsPlugin=e,this.plugin=e}},{key:"active",get:function(){return this._active}},{key:"snapping",get:function(){return this._snapping},set:function(e){this._snapping=e}},{key:"activate",value:function(){var e=this;if(!this._active){this._markerDiv||this._initMarkerDiv(),this.fire("activated",!0);var t=this.distanceMeasurementsPlugin,i=this.scene,r=t.viewer.cameraControl,n=i.canvas.canvas;i.input;var s,o,a=!1,l=le.vec3(),u=le.vec2(),A=null;this._mouseState=0;var c=le.vec2(),h=function(t){var i=t.snappedCanvasPos||t.canvasPos;if(a=!0,l.set(t.worldPos),u.set(t.canvasPos),0===e._mouseState){if(e._canvasToPagePos)e._canvasToPagePos(n,i,c),e._markerDiv.style.left="".concat(c[0]-5,"px"),e._markerDiv.style.top="".concat(c[1]-5,"px");else{var r=le.vec2(i);eE(n,e._markerDiv.parentNode,r),e._markerDiv.style.left="".concat(r[0]-5,"px"),e._markerDiv.style.top="".concat(r[1]-5,"px")}e._markerDiv.style.background="pink",t.snappedToVertex||t.snappedToEdge?(e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=t.canvasPos,e.pointerLens.snappedCanvasPos=t.snappedCanvasPos||t.canvasPos,e.pointerLens.snapped=!0),e._markerDiv.style.background="greenyellow",e._markerDiv.style.border="2px solid green"):(e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=t.canvasPos,e.pointerLens.snappedCanvasPos=t.canvasPos,e.pointerLens.snapped=!1),e._markerDiv.style.background="pink",e._markerDiv.style.border="2px solid red"),A=t.entity}else e._markerDiv.style.left="-10000px",e._markerDiv.style.top="-10000px";n.style.cursor="pointer",e._currentDistanceMeasurement&&(e._currentDistanceMeasurement.wireVisible=e._currentDistanceMeasurementInitState.wireVisible,e._currentDistanceMeasurement.axisVisible=e._currentDistanceMeasurementInitState.axisVisible&&e.distanceMeasurementsPlugin.defaultAxisVisible,e._currentDistanceMeasurement.xAxisVisible=e._currentDistanceMeasurementInitState.xAxisVisible&&e.distanceMeasurementsPlugin.defaultXAxisVisible,e._currentDistanceMeasurement.yAxisVisible=e._currentDistanceMeasurementInitState.yAxisVisible&&e.distanceMeasurementsPlugin.defaultYAxisVisible,e._currentDistanceMeasurement.zAxisVisible=e._currentDistanceMeasurementInitState.zAxisVisible&&e.distanceMeasurementsPlugin.defaultZAxisVisible,e._currentDistanceMeasurement.targetVisible=e._currentDistanceMeasurementInitState.targetVisible,e._currentDistanceMeasurement.target.worldPos=l.slice(),e._markerDiv.style.left="-10000px",e._markerDiv.style.top="-10000px")};this._onHoverSnapOrSurface=r.on("hoverSnapOrSurface",(function(t){e._snapping&&h(t)})),this._onHoverSurface=r.on("hoverSurface",(function(t){e._snapping||h(t)})),n.addEventListener("mousedown",this._onMouseDown=function(e){1===e.which&&(s=e.clientX,o=e.clientY)}),n.addEventListener("mouseup",this._onMouseUp=function(i){1===i.which&&(i.clientX>s+20||i.clientX<s-20||i.clientY>o+20||i.clientY<o-20||(e._currentDistanceMeasurement?a?(e._currentDistanceMeasurement.target.entity=A,A=null,e._currentDistanceMeasurement.clickable=!0,e.distanceMeasurementsPlugin.fire("measurementEnd",e._currentDistanceMeasurement),e._currentDistanceMeasurement=null):(e._currentDistanceMeasurement.destroy(),e.distanceMeasurementsPlugin.fire("measurementCancel",e._currentDistanceMeasurement),e._currentDistanceMeasurement=null,A=null):a&&(e._currentDistanceMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:l.slice(),entity:A},target:{worldPos:l.slice(),entity:A},approximate:!0}),e._currentDistanceMeasurementInitState.axisVisible=e._currentDistanceMeasurement.axisVisible&&e.distanceMeasurementsPlugin.defaultAxisVisible,e._currentDistanceMeasurementInitState.xAxisVisible=e._currentDistanceMeasurement.xAxisVisible&&e.distanceMeasurementsPlugin.defaultXAxisVisible,e._currentDistanceMeasurementInitState.yAxisVisible=e._currentDistanceMeasurement.yAxisVisible&&e.distanceMeasurementsPlugin.defaultYAxisVisible,e._currentDistanceMeasurementInitState.zAxisVisible=e._currentDistanceMeasurement.zAxisVisible&&e.distanceMeasurementsPlugin.defaultZAxisVisible,e._currentDistanceMeasurementInitState.wireVisible=e._currentDistanceMeasurement.wireVisible,e._currentDistanceMeasurementInitState.targetVisible=e._currentDistanceMeasurement.targetVisible,e._currentDistanceMeasurement.clickable=!1,e._currentDistanceMeasurement.origin.entity=A,A=null,e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement))))});var d=function(t){e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=t.canvasPos,e.pointerLens.snappedCanvasPos=t.snappedCanvasPos||t.canvasPos),a=!1,e._markerDiv.style.left="-100px",e._markerDiv.style.top="-100px",e._currentDistanceMeasurement&&(e._currentDistanceMeasurement.wireVisible=!1,e._currentDistanceMeasurement.targetVisible=!1,e._currentDistanceMeasurement.axisVisible=!1),n.style.cursor="default"};this._onHoverSnapOrSurfaceOff=r.on("hoverSnapOrSurfaceOff",(function(t){e._snapping&&d(t)})),this._onHoverOff=r.on("hoverOff",(function(t){e._snapping||d(t)})),this._active=!0}}},{key:"deactivate",value:function(){if(this._active){this.fire("activated",!1),this.pointerLens&&(this.pointerLens.visible=!1),this.reset();var e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);var t=this.distanceMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}}},{key:"reset",value:function(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentDistanceMeasurement&&(this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),this._mouseState=0)}},{key:"currentMeasurement",get:function(){return this._currentDistanceMeasurement}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),tI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"DistanceMeasurements",e))._pointerLens=n.pointerLens,r._container=n.container||document.body,r._defaultControl=null,r._measurements={},r.labelMinAxisLength=n.labelMinAxisLength,r.defaultVisible=!1!==n.defaultVisible,r.defaultOriginVisible=!1!==n.defaultOriginVisible,r.defaultTargetVisible=!1!==n.defaultTargetVisible,r.defaultWireVisible=!1!==n.defaultWireVisible,r.defaultXLabelEnabled=!1!==n.defaultXLabelEnabled,r.defaultYLabelEnabled=!1!==n.defaultYLabelEnabled,r.defaultZLabelEnabled=!1!==n.defaultZLabelEnabled,r.defaultLengthLabelEnabled=!1!==n.defaultLengthLabelEnabled,r.defaultLabelsVisible=!1!==n.defaultLabelsVisible,r.defaultAxisVisible=!1!==n.defaultAxisVisible,r.defaultXAxisVisible=!1!==n.defaultXAxisVisible,r.defaultYAxisVisible=!1!==n.defaultYAxisVisible,r.defaultZAxisVisible=!1!==n.defaultZAxisVisible,r.defaultColor=void 0!==n.defaultColor?n.defaultColor:"#00BBFF",r.zIndex=n.zIndex||1e4,r.defaultLabelsOnWires=!1!==n.defaultLabelsOnWires,r.useRotationAdjustment=void 0!==n.useRotationAdjustment&&!1!==n.useRotationAdjustment,r._onMouseOver=function(e,t){r.fire("mouseOver",{plugin:w(r),distanceMeasurement:t,measurement:t,event:e})},r._onMouseLeave=function(e,t){r.fire("mouseLeave",{plugin:w(r),distanceMeasurement:t,measurement:t,event:e})},r._onContextMenu=function(e,t){r.fire("contextMenu",{plugin:w(r),distanceMeasurement:t,measurement:t,event:e})},r}return I(i,[{key:"getContainerElement",value:function(){return this._container}},{key:"send",value:function(e,t){}},{key:"pointerLens",get:function(){return this._pointerLens}},{key:"control",get:function(){return this._defaultControl||(this._defaultControl=new eI(this,{})),this._defaultControl}},{key:"measurements",get:function(){return this._measurements}},{key:"labelMinAxisLength",get:function(){return this._labelMinAxisLength},set:function(e){e<1&&(this.error("labelMinAxisLength must be >= 1; defaulting to 25"),e=25),this._labelMinAxisLength=e||25}},{key:"useRotationAdjustment",get:function(){return this._useRotationAdjustment},set:function(e){e=void 0!==e&&Boolean(e),this._useRotationAdjustment=e}},{key:"createMeasurement",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);var i=t.origin,r=t.target,n=new qE(this,{id:t.id,plugin:this,container:this._container,origin:{entity:i.entity,worldPos:i.worldPos},target:{entity:r.entity,worldPos:r.worldPos},visible:t.visible,wireVisible:t.wireVisible,axisVisible:!1!==t.axisVisible&&!1!==this.defaultAxisVisible,xAxisVisible:!1!==t.xAxisVisible&&!1!==this.defaultXAxisVisible,yAxisVisible:!1!==t.yAxisVisible&&!1!==this.defaultYAxisVisible,zAxisVisible:!1!==t.zAxisVisible&&!1!==this.defaultZAxisVisible,xLabelEnabled:!1!==t.xLabelEnabled&&!1!==this.defaultXLabelEnabled,yLabelEnabled:!1!==t.yLabelEnabled&&!1!==this.defaultYLabelEnabled,zLabelEnabled:!1!==t.zLabelEnabled&&!1!==this.defaultZLabelEnabled,lengthLabelEnabled:!1!==t.lengthLabelEnabled&&!1!==this.defaultLengthLabelEnabled,labelsVisible:!1!==t.labelsVisible&&!1!==this.defaultLabelsVisible,useRotationAdjustment:this.useRotationAdjustment,originVisible:t.originVisible,targetVisible:t.targetVisible,color:t.color,labelsOnWires:!1!==t.labelsOnWires&&!1!==this.defaultLabelsOnWires,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[n.id]=n,n.clickable=!0,n.on("destroyed",(function(){delete e._measurements[n.id]})),this.fire("measurementCreated",n),n}},{key:"destroyMeasurement",value:function(e){var t=this._measurements[e];t?(t.destroy(),this.fire("measurementDestroyed",t)):this.log("DistanceMeasurement not found: "+e)}},{key:"setLabelsShown",value:function(e){for(var t=0,i=Object.entries(this.measurements);t<i.length;t++){var r=C(i[t],2);r[0];r[1].labelShown=e}}},{key:"setAxisVisible",value:function(e){for(var t=0,i=Object.entries(this.measurements);t<i.length;t++){var r=C(i[t],2);r[0];r[1].axisVisible=e}this.defaultAxisVisible=e}},{key:"getAxisVisible",value:function(){return this.defaultAxisVisible}},{key:"clear",value:function(){for(var e=Object.keys(this._measurements),t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}},{key:"destroy",value:function(){this.clear(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),iI=le.vec2(),rI=function(e){m(i,$E);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,e.viewer.scene)).pointerLens=n.pointerLens,r.pointerCircle=new Qe(e.viewer),r._active=!1;var s=document.createElement("div"),o=r.scene.canvas.canvas;return o.parentNode.insertBefore(s,o),s.style.background="black",s.style.border="2px solid blue",s.style.borderRadius="10px",s.style.width="5px",s.style.height="5px",s.style.margin="-200px -200px",s.style.zIndex="100",s.style.position="absolute",s.style.pointerEvents="none",r.markerDiv=s,r._currentDistanceMeasurement=null,r._currentDistanceMeasurementInitState={wireVisible:null,axisVisible:null,xAxisVisible:null,yaxisVisible:null,zAxisVisible:null,targetVisible:null},r._longTouchTimeoutMs=300,r._snapping=!1!==n.snapping,r._attachPlugin(e,n),r}return I(i,[{key:"_attachPlugin",value:function(e){this.distanceMeasurementsPlugin=e,this.plugin=e}},{key:"active",get:function(){return this._active}},{key:"snapping",get:function(){return this._snapping},set:function(e){this._snapping=e}},{key:"activate",value:function(){var e=this;if(!this._active){var t=this.plugin,i=this.scene,r=i.canvas.canvas;t.pointerLens;var n=le.vec3(),s=20,o=null;this._touchState=0;var a=le.vec2(),l=le.vec2(),u=le.vec2(),A=null,c=function(){e.plugin.viewer.cameraControl.active=!1},h=function(){e.plugin.viewer.cameraControl.active=!0},d=function(e,t){return t[0]=e.clientX,t[1]=e.clientY,eE(r.ownerDocument.documentElement,r,t),t},p=function(e,t){return t.set(e),eE(r,r.ownerDocument.documentElement,t),t};r.addEventListener("touchstart",this._onCanvasTouchStart=function(r){var u=r.touches.length;if(1===u){var f=r.touches[0];switch(d(f,a),l.set(a),e._touchState){case 0:if(1!==u&&null!==o)return o&&(clearTimeout(o),o=null),e._currentDistanceMeasurement&&(e._currentDistanceMeasurement.destroy(),e._currentDistanceMeasurement=null),h(),void(e._touchState=0);var v=i.pick({canvasPos:l,snapping:e._snapping,snapToEdge:e._snapping});if(v&&v.snapped)n.set(v.worldPos),e.pointerCircle.start(p(v.snappedCanvasPos,iI));else{var g=i.pick({canvasPos:l,pickSurface:!0});if(!g||!g.worldPos)return;n.set(g.worldPos),e.pointerCircle.start(p(g.canvasPos,iI))}o=setTimeout((function(){1!==u||l[0]>a[0]+s||l[0]<a[0]-s||l[1]>a[1]+s||l[1]<a[1]-s||(e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=a,e.pointerLens.cursorPos=a),e.pointerLens&&(e.pointerLens.canvasPos=l,e.pointerLens.snapped=!1),e.pointerLens&&(e.pointerLens.cursorPos=v.canvasPos,e.pointerLens.snapped=!0),e._currentDistanceMeasurement?e._currentDistanceMeasurement.origin.worldPos=n:(e._currentDistanceMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:n,entity:v.entity},target:{worldPos:n,entity:v.entity}}),e._currentDistanceMeasurement.labelsVisible=!1,e._currentDistanceMeasurement.xAxisVisible=!1,e._currentDistanceMeasurement.yAxisVisible=!1,e._currentDistanceMeasurement.zAxisVisible=!1,e._currentDistanceMeasurement.wireVisible=!1,e._currentDistanceMeasurement.originVisible=!0,e._currentDistanceMeasurement.targetVisible=!1,e._currentDistanceMeasurement.clickable=!1),e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement),e._touchState=2,c())}),e._longTouchTimeoutMs),e._touchState=1,A=f.identifier;break;case 3:if(1!==u&&null!==o)return clearTimeout(o),void(o=null);1===u&&(o=setTimeout((function(){if(o=null,!(1!==u||l[0]>a[0]+s||l[0]<a[0]-s||l[1]>a[1]+s||l[1]<a[1]-s)){e.pointerLens&&(e.pointerLens.visible=!0,e.pointerLens.canvasPos=a,e.pointerLens.snapped=!1);var t=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping});if(t&&t.snapped)e.pointerLens&&(e.pointerLens.cursorPos=t.snappedCanvasPos,e.pointerLens.snapped=!0),e.pointerCircle.start(p(t.snappedCanvasPos,iI)),n.set(t.worldPos),e._currentDistanceMeasurement.target.worldPos=t.worldPos,e._currentDistanceMeasurement.target.entity=t.entity,e._currentDistanceMeasurement.targetVisible=!0,e._currentDistanceMeasurement.wireVisible=!0,e._currentDistanceMeasurement.labelsVisible=!0,e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement);else{var r=i.pick({canvasPos:l,pickSurface:!0});r&&r.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=r.canvasPos,e.pointerLens.snapped=!1),e.pointerCircle.start(p(r.canvasPos,iI)),n.set(r.worldPos),e._currentDistanceMeasurement.target.worldPos=r.worldPos,e._currentDistanceMeasurement.target.entity=r.entity,e._currentDistanceMeasurement.targetVisible=!0,e._currentDistanceMeasurement.wireVisible=!0,e._currentDistanceMeasurement.labelsVisible=!0,e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement)):e.pointerLens&&(e.pointerLens.cursorPos=null,e.pointerLens.snapped=!1)}e._touchState=5,c()}}),e._longTouchTimeoutMs),e._touchState=4),A=f.identifier;break;default:return null!==o&&(clearTimeout(o),o=null),void(e._touchState=7)}}else o&&(clearTimeout(o),o=null)},{passive:!0}),r.addEventListener("touchmove",(function(r){e.pointerCircle.stop();var s=r.touches.length;if(1===s&&1===r.changedTouches.length){var a,u,c=r.touches[0];if(c.identifier===A)switch(d(c,l),e._touchState){case 2:e.pointerLens&&(e.pointerLens.canvasPos=l),(a=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping}))&&a.snapped?(e.pointerLens&&(e.pointerLens.snappedCanvasPos=a.snappedCanvasPos,e.pointerLens.snapped=!0),n.set(a.worldPos),e._currentDistanceMeasurement?e._currentDistanceMeasurement.origin.worldPos=a.worldPos:(e._currentDistanceMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:a.worldPos,entity:a.entity},target:{worldPos:a.worldPos,entity:a.entity}}),e._currentDistanceMeasurement.labelsVisible=!1,e._currentDistanceMeasurement.xAxisVisible=!1,e._currentDistanceMeasurement.yAxisVisible=!1,e._currentDistanceMeasurement.zAxisVisible=!1,e._currentDistanceMeasurement.wireVisible=!1,e._currentDistanceMeasurement.originVisible=!0,e._currentDistanceMeasurement.targetVisible=!1,e._currentDistanceMeasurement.clickable=!1),e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement)):(u=i.pick({canvasPos:l,pickSurface:!0}))&&u.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=u.canvasPos,e.pointerLens.snapped=!1),n.set(u.worldPos),e._currentDistanceMeasurement?e._currentDistanceMeasurement.origin.worldPos=u.worldPos:(e._currentDistanceMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:u.worldPos,entity:u.entity},target:{worldPos:u.worldPos,entity:u.entity}}),e._currentDistanceMeasurement.labelsVisible=!1,e._currentDistanceMeasurement.xAxisVisible=!1,e._currentDistanceMeasurement.yAxisVisible=!1,e._currentDistanceMeasurement.zAxisVisible=!1,e._currentDistanceMeasurement.wireVisible=!1,e._currentDistanceMeasurement.originVisible=!0,e._currentDistanceMeasurement.targetVisible=!1,e._currentDistanceMeasurement.clickable=!1),e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement)):e.pointerLens&&(e.pointerLens.cursorPos=null,e.pointerLens.snapped=!1),e._touchState=2;break;case 5:if(1!==s&&null!==o)return clearTimeout(o),o=null,e.pointerLens&&(e.pointerLens.visible=!1),void(e._touchState=7);e.pointerLens&&(e.pointerLens.canvasPos=l),(a=i.pick({canvasPos:l,snapToVertex:e._snapping,snapToEdge:e._snapping}))&&a.worldPos?(e.pointerLens&&(e.pointerLens.cursorPos=a.snappedCanvasPos,e.pointerLens.snapped=!0),e._currentDistanceMeasurement.target.worldPos=a.worldPos,e._currentDistanceMeasurement.target.entity=a.entity,e._currentDistanceMeasurement.targetVisible=!0,e._currentDistanceMeasurement.wireVisible=!0,e._currentDistanceMeasurement.labelsVisible=!0):(u=i.pick({canvasPos:l,pickSurface:!0}))&&u.worldPos&&(e.pointerLens&&(e.pointerLens.cursorPos=u.canvasPos,e.pointerLens.snapped=!1),e._currentDistanceMeasurement.target.worldPos=u.worldPos,e._currentDistanceMeasurement.target.entity=u.entity,e._currentDistanceMeasurement.targetVisible=!0,e._currentDistanceMeasurement.wireVisible=!0,e._currentDistanceMeasurement.labelsVisible=!0),e._touchState=5}}else o&&(clearTimeout(o),o=null)}),{passive:!0}),r.addEventListener("touchend",this._onCanvasTouchEnd=function(r){e.pointerCircle.stop();var n=r.changedTouches.length;if(1===n){var c=r.changedTouches[0];if(c.identifier===A){o&&(clearTimeout(o),o=null),d(c,u);var p=u[0],f=u[1];switch(e._touchState){case 1:if(1!==n||p>a[0]+s||p<a[0]-s||f>a[1]+s||f<a[1]-s)return void(e._touchState=0);var v=i.pick({canvasPos:l,pickSurface:!0});v&&v.worldPos?(e._currentDistanceMeasurement=t.createMeasurement({id:le.createUUID(),origin:{worldPos:v.worldPos,entity:v.entity},target:{worldPos:v.worldPos,entity:v.entity}}),e._currentDistanceMeasurement.labelsVisible=!1,e._currentDistanceMeasurement.xAxisVisible=!1,e._currentDistanceMeasurement.yAxisVisible=!1,e._currentDistanceMeasurement.zAxisVisible=!1,e._currentDistanceMeasurement.wireVisible=!1,e._currentDistanceMeasurement.originVisible=!0,e._currentDistanceMeasurement.targetVisible=!1,e._currentDistanceMeasurement.clickable=!1,e._touchState=3,e.distanceMeasurementsPlugin.fire("measurementStart",e._currentDistanceMeasurement)):(e._currentDistanceMeasurement&&e._currentDistanceMeasurement.destroy(),e._touchState=0),h();break;case 2:e.pointerLens&&(e.pointerLens.visible=!1),e._currentDistanceMeasurement?e._touchState=3:(e.pointerLens&&(e.pointerLens.snapped=!1,e.pointerLens.visible=!1),e._touchState=0),h();break;case 4:if(1!==n||p>a[0]+s||p<a[0]-s||f>a[1]+s||f<a[1]-s)return void(e._touchState=3);var g=i.pick({canvasPos:l,pickSurface:!0});g&&g.worldPos?(e._currentDistanceMeasurement.target.worldPos=g.worldPos,e._currentDistanceMeasurement.target.entity=g.entity,e._currentDistanceMeasurement.targetVisible=!0,e._currentDistanceMeasurement.wireVisible=!0,e._currentDistanceMeasurement.labelsVisible=!0,e._currentDistanceMeasurement.xAxisVisible=!0,e._currentDistanceMeasurement.yAxisVisible=!0,e._currentDistanceMeasurement.zAxisVisible=!0,e._currentDistanceMeasurement.clickable=!0,e.distanceMeasurementsPlugin.fire("measurementEnd",e._currentDistanceMeasurement),e._currentDistanceMeasurement=null):e._currentDistanceMeasurement&&(e._currentDistanceMeasurement.destroy(),e._currentDistanceMeasurement=null),e._touchState=0,h();break;case 5:console.log("long touch"),e.pointerLens&&(e.pointerLens.visible=!1),e._currentDistanceMeasurement&&e._currentDistanceMeasurement.targetVisible?(e._currentDistanceMeasurement.clickable=!0,e.distanceMeasurementsPlugin.fire("measurementEnd",e._currentDistanceMeasurement),e._currentDistanceMeasurement=null,e._touchState=0):(e._currentDistanceMeasurement&&(e._currentDistanceMeasurement.destroy(),e._currentDistanceMeasurement=null),e._touchState=0),h()}}}},{passive:!0}),this._active=!0}}},{key:"deactivate",value:function(){if(this._active){this.plugin.pointerLens&&(this.plugin.pointerLens.visible=!1),this.reset();var e=this.plugin.viewer.scene.canvas.canvas;e.removeEventListener("touchstart",this._onCanvasTouchStart),e.removeEventListener("touchend",this._onCanvasTouchEnd),this._active=!1,this.plugin.viewer.cameraControl.active=!0}}},{key:"reset",value:function(){this._active&&this._currentDistanceMeasurement&&(this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null)}},{key:"currentMeasurement",get:function(){return this._currentDistanceMeasurement}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),nI=function(e){m(i,Ie);var t=y(i);function i(e,r,n,s){var o;k(this,i);var a=e.plugin.viewer;o=t.call(this,a.scene);var l=AE({viewer:a,handleMouseEvents:n,handleTouchEvents:s,pointerLens:r.pointerLens,dots:[e.origin,e.target],ray2WorldPos:function(e,t,i){return function e(t){var r=a.scene.pick({canvasPos:i,snapToEdge:t,snapToVertex:t,pickSurface:!0});return r&&r.worldPos?r.worldPos:t&&e(!1)}(!!r.snapping)},onEnd:function(e,t){var i=!le.compareVec3(e,t.worldPos);return i&&o.fire("edited"),i}}),u=e.on("destroyed",l);return o._deactivate=function(){e.off("destroyed",u),l()},o}return I(i,[{key:"deactivate",value:function(){this._deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),sI=function(e){m(i,nI);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!0,!1)}return I(i)}(),oI=function(e){m(i,nI);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!1,!0)}return I(i)}(),aI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(r=t.call(this,"FastNav",e))._hideColorTexture=!1!==n.hideColorTexture,r._hidePBR=!1!==n.hidePBR,r._hideSAO=!1!==n.hideSAO,r._hideEdges=!1!==n.hideEdges,r._hideTransparentObjects=!!n.hideTransparentObjects,r._scaleCanvasResolution=!!n.scaleCanvasResolution,r._defaultScaleCanvasResolutionFactor=n.defaultScaleCanvasResolutionFactor,r._scaleCanvasResolutionFactor=n.scaleCanvasResolutionFactor||.6,r._delayBeforeRestore=!1!==n.delayBeforeRestore,r._delayBeforeRestoreSeconds=n.delayBeforeRestoreSeconds||.5,r._onMoved=n.onMoved,r._onStopped=null;var s=1e3*r._delayBeforeRestoreSeconds,o=!1,a=function(){s=1e3*r._delayBeforeRestoreSeconds,o||(e.scene._renderer.setColorTextureEnabled(!r._hideColorTexture),e.scene._renderer.setPBREnabled(!r._hidePBR),e.scene._renderer.setSAOEnabled(!r._hideSAO),e.scene._renderer.setTransparentEnabled(!r._hideTransparentObjects),e.scene._renderer.setEdgesEnabled(!r._hideEdges),r._originalCanvasResolutionScale=e.scene.canvas.resolutionScale,r._scaleCanvasResolution?e.scene.canvas.resolutionScale=r._scaleCanvasResolutionFactor:e.scene.canvas.resolutionScale=r._defaultScaleCanvasResolutionFactor,r._onMoved&&(r._onStopped=r._onMoved()),o=!0)},l=function(){e.scene.canvas.resolutionScale=r._defaultScaleCanvasResolutionFactor||r._originalCanvasResolutionScale||1,e.scene._renderer.setEdgesEnabled(!0),e.scene._renderer.setColorTextureEnabled(!0),e.scene._renderer.setPBREnabled(!0),e.scene._renderer.setSAOEnabled(!0),e.scene._renderer.setTransparentEnabled(!0),r._onStopped&&r._onStopped(),o=!1};return r._onCameraMatrix=e.scene.camera.on("matrix",a),r._onSceneTick=e.scene.on("tick",(function(e){o&&(s-=e.deltaTime,(!r._delayBeforeRestore||s<=0)&&l())})),r}return I(i,[{key:"hideColorTexture",get:function(){return this._hideColorTexture},set:function(e){this._hideColorTexture=e}},{key:"hidePBR",get:function(){return this._hidePBR},set:function(e){this._hidePBR=e}},{key:"hideSAO",get:function(){return this._hideSAO},set:function(e){this._hideSAO=e}},{key:"hideEdges",get:function(){return this._hideEdges},set:function(e){this._hideEdges=e}},{key:"hideTransparentObjects",get:function(){return this._hideTransparentObjects},set:function(e){this._hideTransparentObjects=!1!==e}},{key:"scaleCanvasResolution",get:function(){return this._scaleCanvasResolution},set:function(e){this._scaleCanvasResolution=e}},{key:"defaultScaleCanvasResolutionFactor",get:function(){return this._defaultScaleCanvasResolutionFactor},set:function(e){this._defaultScaleCanvasResolutionFactor=e}},{key:"scaleCanvasResolutionFactor",get:function(){return this._scaleCanvasResolutionFactor},set:function(e){this._scaleCanvasResolutionFactor=e||.6}},{key:"delayBeforeRestore",get:function(){return this._delayBeforeRestore},set:function(e){this._delayBeforeRestore=e}},{key:"delayBeforeRestoreSeconds",get:function(){return this._delayBeforeRestoreSeconds},set:function(e){this._delayBeforeRestoreSeconds=null!=e?e:.5}},{key:"send",value:function(e,t){}},{key:"destroy",value:function(){this.viewer.scene.camera.off(this._onCameraMatrix),this.viewer.scene.canvas.off(this._onCanvasBoundary),this.viewer.scene.input.off(this._onSceneMouseDown),this.viewer.scene.input.off(this._onSceneMouseUp),this.viewer.scene.input.off(this._onSceneMouseMove),this.viewer.scene.off(this._onSceneTick),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),lI=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getMetaModel",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}},{key:"getGLTF",value:function(e,t,i){ge.loadArraybuffer(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}},{key:"getGLB",value:function(e,t,i){ge.loadArraybuffer(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}},{key:"getArrayBuffer",value:function(e,t,i,r){!function(e,t,i,r){var n=function(){};i=i||n,r=r||n;var s=/^data:(.*?)(;base64)?,(.*)$/,o=t.match(s);if(o){var a=!!o[2],l=o[3];l=window.decodeURIComponent(l),a&&(l=window.atob(l));try{for(var u=new ArrayBuffer(l.length),A=new Uint8Array(u),c=0;c<l.length;c++)A[c]=l.charCodeAt(c);Fe.scheduleTask((function(){i(u)}))}catch(e){Fe.scheduleTask((function(){r(e)}))}}else{var h=function(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}(e),d=h+t,p=new XMLHttpRequest;p.open("GET",d,!0),p.responseType="arraybuffer",p.onreadystatechange=function(){4===p.readyState&&(200===p.status?i(p.response):r("loadArrayBuffer error : "+p.response))},p.send(null)}}(this._cacheBusterURL(e),t,(function(e){i(e)}),(function(e){r(e)}))}}]),e}();var uI=function(){function e(t){k(this,e)}return I(e,[{key:"load",value:function(e,t,i,r,n,s,o){!function(e,t,i,r,n,s,o){var a=e.viewer.scene.canvas.spinner;a.processes++,"glb"===t.split(".").pop()?e.dataSource.getGLB(t,(function(l){r.basePath=AI(t),cI(e,t,l,i,r,n,s,o),a.processes--}),(function(e){a.processes--,o(e)})):e.dataSource.getGLTF(t,(function(l){r.basePath=AI(t),cI(e,t,l,i,r,n,s,o),a.processes--}),(function(e){a.processes--,o(e)}))}(e,t,i,r=r||{},n,(function(){Fe.scheduleTask((function(){n.scene.fire("modelLoaded",n.id),n.fire("loaded",!0,!1)})),s&&s()}),(function(t){e.error(t),o&&o(t),n.fire("error",t)}))}},{key:"parse",value:function(e,t,i,r,n,s,o){cI(e,"",t,i,r=r||{},n,(function(){n.scene.fire("modelLoaded",n.id),n.fire("loaded",!0,!1),s&&s()}),(function(e){n.error(e),n.fire("error",e),o&&o(e)}))}}]),e}();function AI(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}function cI(e,t,i,r,n,s,o,a){var l=e.viewer.scene.canvas.spinner;l.processes++,Tg(i,uw,{baseUri:n.basePath}).then((function(i){var a=function(e,t){return(new bw).postProcess(e,t)}(i),u={src:t,entityId:n.entityId,metaModelJSON:r,autoMetaModel:n.autoMetaModel,globalizeObjectIds:n.globalizeObjectIds,metaObjects:[],loadBuffer:n.loadBuffer,basePath:n.basePath,handlenode:n.handlenode,backfaces:!!n.backfaces,gltfData:a,scene:s.scene,plugin:e,sceneModel:s,numObjects:0,nodes:[],nextId:0,log:function(t){e.log(t)}};!function(e){var t=e.gltfData.textures;if(t)for(var i=0,r=t.length;i<r;i++)hI(e,t[i])}(u),function(e){var t=e.gltfData.materials;if(t)for(var i=0,r=t.length;i<r;i++){var n=t[i];n._textureSetId=dI(e,n),n._attributes=pI(e,n)}}(u),n.autoMetaModel&&u.metaObjects.push({id:s.id,type:"Default",name:s.id}),fI(u),s.finalize(),n.autoMetaModel&&e.viewer.metaScene.createMetaModel(s.id,{metaObjects:u.metaObjects}),l.processes--,o()})).catch((function(e){a&&a(e)}))}function hI(e,t){if(t.source&&t.source.image){var i="texture-".concat(e.nextId++),r=1005;switch(t.sampler.minFilter){case 9728:r=1003;break;case 9729:r=1006;break;case 9984:r=1004;break;case 9985:r=1007;break;case 9986:r=1005;break;case 9987:r=1008}var n=1006;switch(t.sampler.magFilter){case 9728:n=1003;break;case 9729:n=1006}var s=1e3;switch(t.sampler.wrapS){case 33071:s=1001;break;case 33648:s=1002;break;case 10497:s=1e3}var o=1e3;switch(t.sampler.wrapT){case 33071:o=1001;break;case 33648:o=1002;break;case 10497:o=1e3}var a=1e3;switch(t.sampler.wrapR){case 33071:a=1001;break;case 33648:a=1002;break;case 10497:a=1e3}e.sceneModel.createTexture({id:i,image:t.source.image,flipY:!!t.flipY,minFilter:r,magFilter:n,wrapS:s,wrapT:o,wrapR:a,encoding:3001}),t._textureId=i}}function dI(e,t){var i={};switch(t.normalTexture&&(i.normalTextureId=t.normalTexture.texture._textureId),t.occlusionTexture&&(i.occlusionTextureId=t.occlusionTexture.texture._textureId),t.emissiveTexture&&(i.emissiveTextureId=t.emissiveTexture.texture._textureId),t.alphaMode){case"OPAQUE":break;case"MASK":var r=t.alphaCutoff;i.alphaCutoff=void 0!==r?r:.5}var n=t.pbrMetallicRoughness;if(t.pbrMetallicRoughness){var s=t.pbrMetallicRoughness,o=s.baseColorTexture||s.colorTexture;o&&(o.texture?i.colorTextureId=o.texture._textureId:i.colorTextureId=e.gltfData.textures[o.index]._textureId),n.metallicRoughnessTexture&&(i.metallicRoughnessTextureId=n.metallicRoughnessTexture.texture._textureId)}var a=t.extensions;if(a){var l=a.KHR_materials_pbrSpecularGlossiness;if(l){l.specularTexture;var u=l.specularColorTexture;null!=u&&(i.colorTextureId=e.gltfData.textures[u.index]._textureId)}}return void 0!==i.normalTextureId||void 0!==i.occlusionTextureId||void 0!==i.emissiveTextureId||void 0!==i.colorTextureId||void 0!==i.metallicRoughnessTextureId?(i.id="textureSet-".concat(e.nextId++,";"),e.sceneModel.createTextureSet(i),i.id):null}function pI(e,t){var i=t.extensions,r={color:new Float32Array([1,1,1,1]),opacity:1,metallic:0,roughness:1,doubleSided:!0};if(i){var n=i.KHR_materials_pbrSpecularGlossiness;if(n){var s=n.diffuseFactor;null!=s&&r.color.set(s)}var o=i.KHR_materials_common;if(o){var a=o.technique,l=o.values||{},u="BLINN"===a,A="PHONG"===a,c="LAMBERT"===a,h=l.diffuse;h&&(u||A||c)&&(ge.isString(h)||r.color.set(h));var d=l.transparency;null!=d&&(r.opacity=d);var p=l.transparent;null!=p&&(r.opacity=p)}}var f=t.pbrMetallicRoughness;if(f){var v=f.baseColorFactor;v&&(r.color[0]=v[0],r.color[1]=v[1],r.color[2]=v[2],r.opacity=v[3]);var g=f.metallicFactor;null!=g&&(r.metallic=g);var m=f.roughnessFactor;null!=m&&(r.roughness=m)}return r.doubleSided=!1!==t.doubleSided,r}function fI(e){var t=e.gltfData,i=t.scene||t.scenes[0];if(i){var r=i.nodes;if(r){!function e(t){t.forEach((function(t){var i=t.mesh;i&&(i.instances||(i.instances=0),i.instances+=1),t.children&&e(t.children)}))}(r);var n=[],s=null;!function t(i,r,o){i.forEach((function(i){var a=i.name,l=null!=a&&a||0===r&&"entity-"+e.nextId++;if(l){for(;e.sceneModel.objects[l];)l="entity-"+e.nextId++;n.push(s),s=[]}var u=function(e,t){var i;e.matrix&&(i=e.matrix,t=t?le.mulMat4(t,i,le.mat4()):i);e.translation&&(i=le.translationMat4v(e.translation),t=t?le.mulMat4(t,i,le.mat4()):i);e.rotation&&(i=le.quaternionToMat4(e.rotation),t=t?le.mulMat4(t,i,le.mat4()):i);e.scale&&(i=le.scalingMat4v(e.scale),t=t?le.mulMat4(t,i,le.mat4()):i);return t}(i,o);if(i.mesh&&function(e,t,i,r){var n=e.mesh;if(!n)return;var s=n.primitives.length;if(s>0)for(var o=0;o<s;o++){var a=n.primitives[o];if(!(a.mode<4)){var l={id:t.sceneModel.id+"."+t.numObjects++},u=a.material;u?(l.textureSetId=u._textureSetId,l.color=u._attributes.color,l.opacity=u._attributes.opacity,l.metallic=u._attributes.metallic,l.roughness=u._attributes.roughness):(l.color=new Float32Array([1,1,1]),l.opacity=1);var A=!1!==t.backfaces||u&&!1!==u.doubleSided;switch(a.mode){case 0:l.primitive="points";break;case 1:case 2:case 3:l.primitive="lines";break;default:l.primitive=A?"triangles":"solid"}var c=a.attributes.POSITION;if(c){l.localPositions=c.value,l.positions=new Float64Array(l.localPositions.length),a.attributes.NORMAL&&(l.normals=a.attributes.NORMAL.value),a.attributes.TEXCOORD_0&&(l.uv=a.attributes.TEXCOORD_0.value),a.indices&&(l.indices=a.indices.value),i?le.transformPositions3(i,l.localPositions,l.positions):l.positions.set(l.localPositions);var h=le.vec3();qt(l.positions,l.positions,h)&&(l.origin=h),t.sceneModel.createMesh(l),r.push(l.id)}}}}(i,e,u,s),i.children&&t(i.children,r+1,u),l){if(s.length>0){var A=e.globalizeObjectIds?le.globalizeObjectId(e.sceneModel.id,l):l;e.sceneModel.createEntity({id:A,meshIds:s,isObject:!0}),e.autoMetaModel&&e.metaObjects.push({id:A,type:"Default",name:A,parent:e.sceneModel.id})}s=n.pop()}}))}(r,0,null)}}else!function(e,t){e.plugin.error(t)}(e,"glTF has no default scene")}var vI={DEFAULT:{}},gI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"GLTFLoader",e,n))._sceneModelLoader=new uI(w(r),n),r.dataSource=n.dataSource,r.objectDefaults=n.objectDefaults,r}return I(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new lI}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||vI}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new Sc(this.viewer.scene,ge.apply(t,{isModel:!0,dtxEnabled:t.dtxEnabled})),r=i.id;if(!t.src&&!t.gltf)return this.error("load() param expected: src or gltf"),i;if(t.metaModelSrc||t.metaModelJSON){var n=function(n){e.viewer.metaScene.createMetaModel(r,n,{}),e.viewer.scene.canvas.spinner.processes--,t.src?e._sceneModelLoader.load(e,t.src,n,t,i):e._sceneModelLoader.parse(e,t.gltf,n,t,i)};if(t.metaModelSrc){var s=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(s,(function(t){e.viewer.scene.canvas.spinner.processes--,n(t)}),(function(t){e.error("load(): Failed to load model metadata for model '".concat(r," from  '").concat(s,"' - ").concat(t)),e.viewer.scene.canvas.spinner.processes--}))}else t.metaModelJSON&&n(t.metaModelJSON)}else t.src?this._sceneModelLoader.load(this,t.src,null,t,i):this._sceneModelLoader.parse(this,t.gltf,null,t,i);return i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(r)})),i}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}();function mI(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r="lightgrey",n=i.hoverColor||"rgba(0,0,0,0.4)",s=i.textColor||"black",o=i.canvasElement||document.body,a=500,l=a+a/3,u=l/24,A=[{boundary:[6,6,6,6],color:i.frontColor||i.color||"#55FF55"},{boundary:[18,6,6,6],color:i.backColor||i.color||"#55FF55"},{boundary:[12,6,6,6],color:i.rightColor||i.color||"#FF5555"},{boundary:[0,6,6,6],color:i.leftColor||i.color||"#FF5555"},{boundary:[6,0,6,6],color:i.topColor||i.color||"#7777FF"},{boundary:[6,12,6,6],color:i.bottomColor||i.color||"#7777FF"}],c=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];i.frontColor||i.color,i.backColor||i.color,i.rightColor||i.color,i.leftColor||i.color,i.topColor||i.color,i.bottomColor||i.color;for(var h=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}],d=0,p=c.length;d<p;d++)le.normalizeVec3(c[d].dir,c[d].dir),le.normalizeVec3(c[d].up,c[d].up);for(var f=0,v=h.length;f<v;f++)le.normalizeVec3(h[f].dir,h[f].dir),le.normalizeVec3(h[f].up,h[f].up);var g=h;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=l,this._textureCanvas.height=a,this._textureCanvas.style.width=l+"px",this._textureCanvas.style.height=a+"px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=r,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6,o.appendChild(this._textureCanvas);var m=this._textureCanvas.getContext("2d"),_=!1;function y(){for(var e=0,i=A.length;e<i;e++){var o=A[e],a=o.boundary,l=Math.round(a[0]*u),c=Math.round(a[1]*u),h=Math.round(a[2]*u),d=Math.round(a[3]*u);m.fillStyle=o.color,m.fillRect(l,c,h,d)}for(var p=0,f=g.length;p<f;p++){for(var v=void 0,_=void 0,y=void 0,b=void 0,w=g[p],B=w.boundaries,P=0,C=B.length;P<C;P++){var M=B[P];v=Math.round(M[0]*u),_=Math.round(M[1]*u),y=Math.round(M[2]*u),b=Math.round(M[3]*u),w.highlighted&&(m.fillStyle=w.highlighted?n:w.color||r,m.fillRect(v,_,y,b))}if(w.label){m.fillStyle=s,m.font="60px sans-serif",m.textAlign="center";var F=v+.5*y,k=_+.7*b;m.fillText(x(w.label),F,k,80)}}t.glRedraw()}var b,w,B,x=(b={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},w={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},B={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"},function(t){var i=_?w:b,r=i?i[t]:null;return r?e.localeService.translate(r)||B[r]||r:t});this.setZUp=function(){_=!0,g=c,this.clear()},this.setYUp=function(){_=!1,g=h,this.clear()},this.clear=function(){m.fillStyle=r,m.fillRect(0,0,l,a);for(var e=0,t=g.length;e<t;e++){g[e].highlighted=!1}y()},this.getArea=function(e){for(var t=e[0]*l,i=a-e[1]*a,r=0,n=g.length;r<n;r++)for(var s=g[r].boundaries,o=0,A=s.length;o<A;o++){var c=s[o];if(t>=c[0]*u&&t<=(c[0]+c[2])*u&&i>=c[1]*u&&i<=(c[1]+c[3])*u)return r}return-1},this.setAreaHighlighted=function(e,t){var i=g[e];if(!i)throw"Area not found: "+e;i.highlighted=!!t,y()},this.getAreaDir=function(e){var t=g[e];if(!t)throw"Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=g[e];if(!t)throw"Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}var _I=le.vec3(),yI=le.vec3();le.mat4();var bI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),r=t.call(this,"NavCube",e,n),e.navCube=w(r);var s=!0;try{r._navCubeScene=new Jd(e,{canvasId:n.canvasId,canvasElement:n.canvasElement,transparent:!0}),r._navCubeCanvas=r._navCubeScene.canvas.canvas,r._navCubeScene.input.keyboardEnabled=!1}catch(e){return r.error(e),b(r)}var o=r._navCubeScene;o.clearLights(),new Vc(o,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new Vc(o,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new Vc(o,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),r._navCubeCamera=o.camera,r._navCubeCamera.ortho.scale=7,r._navCubeCamera.ortho.near=.1,r._navCubeCamera.ortho.far=2e3,o.edgeMaterial.edgeColor=[.2,.2,.2],o.edgeMaterial.edgeAlpha=.6,r._zUp=Boolean(e.camera.zUp);var a=w(r);r.setIsProjectNorth(n.isProjectNorth),r.setProjectNorthOffsetAngle(n.projectNorthOffsetAngle);var l,u=(l=le.mat4(),function(e,t,i){return le.identityMat4(l),le.rotationMat4v(e*a._projectNorthOffsetAngle*le.DEGTORAD,[0,1,0],l),le.transformVec3(l,t,i)});r._synchCamera=function(){var t=le.rotationMat4c(-90*le.DEGTORAD,1,0,0),i=le.vec3(),r=le.vec3(),n=le.vec3();return function(){var s=e.camera.eye,o=e.camera.look,l=e.camera.up;i=le.mulVec3Scalar(le.normalizeVec3(le.subVec3(s,o,i)),5),a._isProjectNorth&&a._projectNorthOffsetAngle&&(i=u(-1,i,_I),l=u(-1,l,yI)),a._zUp?(le.transformVec3(t,i,r),le.transformVec3(t,l,n),a._navCubeCamera.look=[0,0,0],a._navCubeCamera.eye=le.transformVec3(t,i,r),a._navCubeCamera.up=le.transformPoint3(t,l,n)):(a._navCubeCamera.look=[0,0,0],a._navCubeCamera.eye=i,a._navCubeCamera.up=l)}}(),r._cubeTextureCanvas=new mI(e,o,n),r._cubeSampler=new In(o,{image:r._cubeTextureCanvas.getImage(),flipY:!0,wrapS:1001,wrapT:1001}),r._cubeMesh=new vn(o,{geometry:new mt(o,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new bn(o,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:r._cubeSampler,emissiveMap:r._cubeSampler}),visible:!!s,edges:!0}),r._shadow=!1===n.shadowVisible?null:new vn(o,{geometry:new mt(o,Ft({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new bn(o,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!!s,pickable:!1,backfaces:!1}),r._onCameraMatrix=e.camera.on("matrix",r._synchCamera),r._onCameraWorldAxis=e.camera.on("worldAxis",(function(){e.camera.zUp?(r._zUp=!0,r._cubeTextureCanvas.setZUp(),r._repaint(),r._synchCamera()):e.camera.yUp&&(r._zUp=!1,r._cubeTextureCanvas.setYUp(),r._repaint(),r._synchCamera())})),r._onCameraFOV=e.camera.perspective.on("fov",(function(e){r._synchProjection&&(r._navCubeCamera.perspective.fov=e)})),r._onCameraProjection=e.camera.on("projection",(function(e){r._synchProjection&&(r._navCubeCamera.projection="ortho"===e||"perspective"===e?e:"perspective")}));var A=-1;function c(t,i){var r=(t-d)*-_,n=(i-p)*-_;e.camera.orbitYaw(r),e.camera.orbitPitch(-n),d=t,p=i}function h(e){var t=a._navCubeCanvas.getBoundingClientRect(),i=t.left,r=t.top;return[e.clientX-i,e.clientY-r]}var d,p,f=null,v=null,g=!1,m=!1,_=.5;a._navCubeCanvas.addEventListener("mouseenter",a._onMouseEnter=function(e){m=!0}),a._navCubeCanvas.addEventListener("mouseleave",a._onMouseLeave=function(e){m=!1}),a._navCubeCanvas.addEventListener("mousedown",a._onMouseDown=function(e){if(1===e.which){f=e.x,v=e.y,d=e.clientX,p=e.clientY;var t=h({clientX:e.clientX,clientY:e.clientY}),i=o.pick({canvasPos:t});g=!!i}}),a._navCubeCanvas.addEventListener("mouseup",a._onMouseUp=function(e){if(1===e.which&&(g=!1,null!==f)){var t=h({clientX:e.clientX,clientY:e.clientY}),i=o.pick({canvasPos:t,pickSurface:!0});if(i&&i.uv){var r=a._cubeTextureCanvas.getArea(i.uv);if(r>=0&&(a._navCubeCanvas.style.cursor="pointer",A>=0&&(a._cubeTextureCanvas.setAreaHighlighted(A,!1),a._repaint(),A=-1),r>=0)){if(a._cubeTextureCanvas.setAreaHighlighted(r,!0),A=r,a._repaint(),e.x<f-3||e.x>f+3||e.y<v-3||e.y>v+3)return;var n=a._cubeTextureCanvas.getAreaDir(r);if(n){var s=a._cubeTextureCanvas.getAreaUp(r);a._isProjectNorth&&a._projectNorthOffsetAngle&&(n=u(1,n,_I),s=u(1,s,yI)),y(n,s,(function(){A>=0&&(a._cubeTextureCanvas.setAreaHighlighted(A,!1),a._repaint(),A=-1),a._navCubeCanvas.style.cursor="pointer",A>=0&&(a._cubeTextureCanvas.setAreaHighlighted(A,!1),a._repaint(),A=-1),r>=0&&(a._cubeTextureCanvas.setAreaHighlighted(r,!1),A=-1,a._repaint())}))}}}}}),a._navCubeCanvas.addEventListener("mousemove",a._onMouseMove=function(e){if(A>=0&&(a._cubeTextureCanvas.setAreaHighlighted(A,!1),a._repaint(),A=-1),1!==e.buttons||g){if(g){var t=e.clientX,i=e.clientY;return a._navCubeCanvas.style.cursor="move",void c(t,i)}if(m){var r=h({clientX:e.clientX,clientY:e.clientY}),n=o.pick({canvasPos:r,pickSurface:!0});if(n){if(n.uv){a._navCubeCanvas.style.cursor="pointer";var s=a._cubeTextureCanvas.getArea(n.uv);if(s===A)return;A>=0&&a._cubeTextureCanvas.setAreaHighlighted(A,!1),s>=0&&(a._cubeTextureCanvas.setAreaHighlighted(s,!0),a._repaint(),A=s)}}else a._navCubeCanvas.style.cursor="default",A>=0&&(a._cubeTextureCanvas.setAreaHighlighted(A,!1),a._repaint(),A=-1)}}}),a._navCubeCanvas.addEventListener("touchstart",a._onTouchStart=function(e){if(e.touches.length>0){f=e.touches[0].clientX,v=e.touches[0].clientY,d=e.touches[0].clientX,p=e.touches[0].clientY;var t=h({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}),i=o.pick({canvasPos:t});g=!!i}},{passive:!1}),a._navCubeCanvas.addEventListener("touchmove",a._onTouchMove=function(e){e.preventDefault();var t=e.touches[0],i=t.clientX,r=t.clientY,n=document.elementFromPoint(i,r);(m=a._navCubeCanvas===n)&&g&&c(i,r)},{passive:!1}),a._navCubeCanvas.addEventListener("touchend",a._onTouchEnd=function(e){g=!1});var y=function(){var t=le.vec3();return function(i,r,n){var s=a._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,o=le.getAABB3Diag(s);le.getAABB3Center(s,t);var l=Math.abs(o/Math.tan(a._cameraFitFOV*le.DEGTORAD));e.cameraControl.pivotPos=t,a._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*o,fitFOV:a._cameraFitFOV,duration:a._cameraFlyDuration},n):e.cameraFlight.jumpTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*o,fitFOV:a._cameraFitFOV},n)}}();return r._onUpdated=e.localeService.on("updated",(function(){r._cubeTextureCanvas.clear(),r._repaint()})),r.setVisible(n.visible),r.setCameraFitFOV(n.cameraFitFOV),r.setCameraFly(n.cameraFly),r.setCameraFlyDuration(n.cameraFlyDuration),r.setFitVisible(n.fitVisible),r.setSynchProjection(n.synchProjection),r}return I(i,[{key:"send",value:function(e,t){if("language"===e)this._cubeTextureCanvas.clear(),this._repaint()}},{key:"_repaint",value:function(){var e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}},{key:"setVisible",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden")}},{key:"getVisible",value:function(){return!!this._navCubeCanvas&&this._cubeMesh.visible}},{key:"setFitVisible",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._fitVisible=e}},{key:"getFitVisible",value:function(){return this._fitVisible}},{key:"setCameraFly",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._cameraFly=e}},{key:"getCameraFly",value:function(){return this._cameraFly}},{key:"setCameraFitFOV",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:45;this._cameraFitFOV=e}},{key:"getCameraFitFOV",value:function(){return this._cameraFitFOV}},{key:"setCameraFlyDuration",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;this._cameraFlyDuration=e}},{key:"getCameraFlyDuration",value:function(){return this._cameraFlyDuration}},{key:"setSynchProjection",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._synchProjection=e}},{key:"getSynchProjection",value:function(){return this._synchProjection}},{key:"setIsProjectNorth",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._isProjectNorth=e}},{key:"getIsProjectNorth",value:function(){return this._isProjectNorth}},{key:"setProjectNorthOffsetAngle",value:function(e){this._projectNorthOffsetAngle=e}},{key:"getProjectNorthOffsetAngle",value:function(){return this._projectNorthOffsetAngle}},{key:"destroy",value:function(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),this._navCubeCanvas.removeEventListener("mousemove",this._onMouseMove),this._navCubeCanvas.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas.removeEventListener("touchstart",this._onTouchStart),this._navCubeCanvas.removeEventListener("touchmove",this._onTouchMove),this._navCubeCanvas.removeEventListener("touchend",this._onTouchEnd),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this._onTouchStart=null,this._onTouchMove=null,this._onTouchEnd=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,v(x(i.prototype),"destroy",this).call(this)}}]),i}(),wI=le.vec3(),BI=function(){function e(){k(this,e)}return I(e,[{key:"load",value:function(e,t){var i=e.scene.canvas.spinner;i.processes++,xI(e,t,(function(t){CI(e,t,(function(){kI(e,t),i.processes--,Fe.scheduleTask((function(){e.fire("loaded",!0,!1)}))}))}))}},{key:"parse",value:function(e,t,i,r){if(t){var n=PI(e,t,null);i&&FI(e,i,r),kI(e,n),e.src=null,e.fire("loaded",!0,!1)}else this.warn("load() param expected: objText")}}]),e}(),xI=function(e,t,i){EI(t,(function(r){var n=PI(e,r,t);i(n)}),(function(t){e.error(t)}))},PI=function(){var e={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /};return function(i,r,n){var s,o,a={src:n=n||"",basePath:(s=n,o=s.lastIndexOf("/"),-1===o?s:s.substring(0,o+1)),objects:[],object:{},positions:[],normals:[],uv:[],materialLibraries:{}};t(a,"",!1),-1!==r.indexOf("\r\n")&&(r=r.replace("\r\n","\n"));for(var l=r.split("\n"),u="",h="",d="",p=[],f="function"==typeof"".trimLeft,v=0,g=l.length;v<g;v++)if(u=l[v],0!==(u=f?u.trimLeft():u.trim()).length&&"#"!==(h=u.charAt(0)))if("v"===h)if(" "===(d=u.charAt(1))&&null!==(p=e.vertex_pattern.exec(u)))a.positions.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));else if("n"===d&&null!==(p=e.normal_pattern.exec(u)))a.normals.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));else{if("t"!==d||null===(p=e.uv_pattern.exec(u)))return void i.error("Unexpected vertex/normal/uv line: '"+u+"'");a.uv.push(parseFloat(p[1]),parseFloat(p[2]))}else if("f"===h)if(null!==(p=e.face_vertex_uv_normal.exec(u)))A(a,p[1],p[4],p[7],p[10],p[2],p[5],p[8],p[11],p[3],p[6],p[9],p[12]);else if(null!==(p=e.face_vertex_uv.exec(u)))A(a,p[1],p[3],p[5],p[7],p[2],p[4],p[6],p[8]);else if(null!==(p=e.face_vertex_normal.exec(u)))A(a,p[1],p[3],p[5],p[7],void 0,void 0,void 0,void 0,p[2],p[4],p[6],p[8]);else{if(null===(p=e.face_vertex.exec(u)))return void i.error("Unexpected face line: '"+u+"'");A(a,p[1],p[2],p[3],p[4])}else if("l"===h){var m=u.substring(1).trim().split(" "),_=[],y=[];if(-1===u.indexOf("/"))_=m;else for(var b=0,w=m.length;b<w;b++){var B=m[b].split("/");""!==B[0]&&_.push(B[0]),""!==B[1]&&y.push(B[1])}c(a,_,y)}else if(null!==(p=e.object_pattern.exec(u))){t(a,x=p[0].substr(1).trim(),!0)}else if(e.material_use_pattern.test(u)){var x=u.substring(7).trim();a.object.material.id=x}else if(e.material_library_pattern.test(u))a.materialLibraries[u.substring(7).trim()]=!0;else{if(null===(p=e.smoothing_pattern.exec(u))){if("\0"===u)continue;return void i.error("Unexpected line: '"+u+"'")}var P=p[1].trim().toLowerCase();a.object.material.smooth="1"===P||"on"===P}return a};function t(e,t,i){if(e.object&&!1===e.object.fromDeclaration)return e.object.id=t,void(e.object.fromDeclaration=!1!==i);e.object={id:t||"",geometry:{positions:[],normals:[],uv:[]},material:{id:"",smooth:!0},fromDeclaration:!1!==i},e.objects.push(e.object)}function i(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}function r(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}function n(e,t){var i=parseInt(e,10);return 2*(i>=0?i-1:i+t/2)}function s(e,t,i,r){var n=e.positions,s=e.object.geometry.positions;s.push(n[t+0]),s.push(n[t+1]),s.push(n[t+2]),s.push(n[i+0]),s.push(n[i+1]),s.push(n[i+2]),s.push(n[r+0]),s.push(n[r+1]),s.push(n[r+2])}function o(e,t){var i=e.positions,r=e.object.geometry.positions;r.push(i[t+0]),r.push(i[t+1]),r.push(i[t+2])}function a(e,t,i,r){var n=e.normals,s=e.object.geometry.normals;s.push(n[t+0]),s.push(n[t+1]),s.push(n[t+2]),s.push(n[i+0]),s.push(n[i+1]),s.push(n[i+2]),s.push(n[r+0]),s.push(n[r+1]),s.push(n[r+2])}function l(e,t,i,r){var n=e.uv,s=e.object.geometry.uv;s.push(n[t+0]),s.push(n[t+1]),s.push(n[i+0]),s.push(n[i+1]),s.push(n[r+0]),s.push(n[r+1])}function u(e,t){var i=e.uv,r=e.object.geometry.uv;r.push(i[t+0]),r.push(i[t+1])}function A(e,t,o,u,A,c,h,d,p,f,v,g,m){var _,y=e.positions.length,b=i(t,y),w=i(o,y),B=i(u,y);if(void 0===A?s(e,b,w,B):(s(e,b,w,_=i(A,y)),s(e,w,B,_)),void 0!==c){var x=e.uv.length;b=n(c,x),w=n(h,x),B=n(d,x),void 0===A?l(e,b,w,B):(l(e,b,w,_=n(p,x)),l(e,w,B,_))}if(void 0!==f){var P=e.normals.length;b=r(f,P),w=f===v?b:r(v,P),B=f===g?b:r(g,P),void 0===A?a(e,b,w,B):(a(e,b,w,_=r(m,P)),a(e,w,B,_))}}function c(e,t,r){e.object.geometry.type="Line";for(var s=e.positions.length,a=e.uv.length,l=0,A=t.length;l<A;l++)o(e,i(t[l],s));for(var c=0,h=r.length;c<h;c++)u(e,n(r[c],a))}}();function CI(e,t,i){for(var r=t.basePath,n=Object.keys(t.materialLibraries),s=n.length,o=0,a=s;o<a;o++)MI(e,r,r+n[o],(function(){0==--s&&i()}))}var MI=function(e,t,i,r){EI(i,(function(i){FI(e,i,t),r()}),(function(t){e.error(t),r()}))},FI=function(){var e=/\s+/;return function(e,n,s){var o,a,l,u,A,c=n.split("\n"),h={id:"Default"},d=!1;s=s||"";for(var p=0;p<c.length;p++)if(0!==(o=c[p].trim()).length&&"#"!==o.charAt(0))switch(l=(l=(a=o.indexOf(" "))>=0?o.substring(0,a):o).toLowerCase(),u=(u=a>=0?o.substring(a+1):"").trim(),l.toLowerCase()){case"newmtl":i(e,h),h={id:u},d=!0;break;case"ka":h.ambient=r(u);break;case"kd":h.diffuse=r(u);break;case"ks":h.specular=r(u);break;case"map_kd":h.diffuseMap||(h.diffuseMap=t(e,s,u,"sRGB"));break;case"map_ks":h.specularMap||(h.specularMap=t(e,s,u,"linear"));break;case"map_bump":case"bump":h.normalMap||(h.normalMap=t(e,s,u));break;case"ns":h.shininess=parseFloat(u);break;case"d":(A=parseFloat(u))<1&&(h.alpha=A,h.alphaMode="blend");break;case"tr":(A=parseFloat(u))>0&&(h.alpha=1-A,h.alphaMode="blend")}d&&i(e,h)};function t(e,t,i,r){var n={},s=i.split(/\s+/),o=s.indexOf("-bm");return o>=0&&s.splice(o,2),(o=s.indexOf("-s"))>=0&&(n.scale=[parseFloat(s[o+1]),parseFloat(s[o+2])],s.splice(o,4)),(o=s.indexOf("-o"))>=0&&(n.translate=[parseFloat(s[o+1]),parseFloat(s[o+2])],s.splice(o,4)),n.src=t+s.join(" ").trim(),n.flipY=!0,n.encoding=r||"linear",new In(e,n).id}function i(e,t){new bn(e,t)}function r(t){var i=t.split(e,3);return[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])]}}();function kI(e,t){for(var i=0,r=t.objects.length;i<r;i++){var n=t.objects[i],s=n.geometry;if(s.type,0!==s.positions.length){var o={primitive:"triangles",compressGeometry:!1};o.positions=s.positions,s.normals.length>0&&(o.normals=s.normals),s.uv.length>0&&(o.uv=s.uv);for(var a=new Array(o.positions.length/3),l=0;l<a.length;l++)a[l]=l;o.indices=a;var u=wI;qt(s.positions,s.positions,u);var A,c=new mt(e,o),h=n.material.id;h&&""!==h?(A=e.scene.components[h])||e.error("Material not found: "+h):A=new bn(e,{diffuse:[.6,.6,.6],backfaces:!0});var d=new vn(e,{id:e.id+"#"+n.id,origin:0!==u[0]||0!==u[1]||0!==u[2]?u:null,isObject:!0,geometry:c,material:A,pickable:!0});e.addChild(d)}}}function EI(e,t,i){var r=new XMLHttpRequest;r.open("GET",e,!0),r.addEventListener("load",(function(e){var r=e.target.response;200===this.status?t&&t(r):0===this.status?(console.warn("loadFile: HTTP Status 0 received."),t&&t(r)):i&&i(e)}),!1),r.addEventListener("error",(function(e){i&&i(e)}),!1),r.send(null)}var II=function(e){m(i,vh);var t=y(i);function i(e,r){var n;return k(this,i),(n=t.call(this,"OBJLoader",e,r))._sceneGraphLoader=new BI,n}return I(i,[{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new Xt(this.viewer.scene,ge.apply(t,{isModel:!0})),r=i.id,n=t.src;if(!n)return this.error("load() param expected: src"),i;if(t.metaModelSrc){var s=t.metaModelSrc;ge.loadJSON(s,(function(s){e.viewer.metaScene.createMetaModel(r,s),e._sceneGraphLoader.load(i,n,t)}),(function(t){e.error("load(): Failed to load model modelMetadata for model '".concat(r," from  '").concat(s,"' - ").concat(t))}))}else this._sceneGraphLoader.load(i,n,t);return i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(r)})),i}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}(),TI=function(){function e(t){var i=this;k(this,e);var r,n,s=t.cameraControl,o=t.scene,a=o.canvas.canvas,l=!1,u=.09,A=.01,c=new Xt(o,{position:[0,0,0],scale:[5,5,5],isObject:!1}),h=le.vec3();this._setPosition=(r=le.vec3(),n=le.vec3(),function(e){h.set(e),Yt(e,r,n),c.origin=r,c.position=n}),this._setQuaternion=function(e){c.quaternion=e};var d=function(e,t){return new mt(c,Ft({radiusTop:.001,radiusBottom:e,radialSegments:32,heightSegments:1,height:t,openEnded:!1}))},p=function(e,t,i){return new mt(c,Ft({radiusTop:e,radiusBottom:e,radialSegments:i,heightSegments:1,height:t,openEnded:!1}))},v=function(e,t,i){return new mt(c,Tt({radius:.8,tube:e,radialSegments:64,tubeSegments:i,arc:2*Math.PI*t}))},g={curve:v(A,.25,14),curveHandle:v(u,.25,14),hoop:v(A,1,8),arrowHead:d(.07,.2),arrowHeadBig:d(.09,.25),arrowHeadHandle:p(u,.37,8),axis:p(A,1,20),axisHandle:p(u,1,20)},m=function(e,t){return new zn(c,{edges:!1,fill:!0,fillColor:e,fillAlpha:t})},_=new bn(c,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),y={},b=function(e,t){le.mulVec3Scalar(e,-1,le.vec3());var r=function(e){return new bn(c,{diffuse:e,emissive:e,ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2})}(e),n=le.quaternionToRotationMat4(t,le.identityMat4());le.mulMat4(le.rotationMat4v(Math.PI,[0,1,0],le.mat4()),n,n);var s=le.scaleMat4v([.6,.6,.6],le.identityMat4()),u=function(e,t){var i=le.translateMat4v(e,le.identityMat4()),r=le.identityMat4();return le.mulMat4(i,t,r),le.mulMat4(n,r,r),le.mulMat4(r,s,le.identityMat4())},A=c.addChild(new vn(c,{geometry:g.curve,material:r,matrix:n,pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isUI:!0,isObject:!1}),l),d=c.addChild(new vn(c,{geometry:g.curveHandle,material:_,matrix:n,pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isUI:!0,isObject:!1}),l),p=c.addChild(new vn(c,{geometry:g.arrowHead,material:r,matrix:u([.8,.07,0],le.rotationMat4v(180*le.DEGTORAD,[0,0,1],le.identityMat4())),pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),f=c.addChild(new vn(c,{geometry:g.arrowHead,material:r,matrix:u([.07,.8,0],le.rotationMat4v(90*le.DEGTORAD,[0,0,1],le.identityMat4())),pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),v=c.addChild(new vn(c,{geometry:g.hoop,material:r,highlighted:!0,highlightMaterial:m(e,.6),matrix:n,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),b=le.quaternionToRotationMat4(le.vec3PairToQuaternion([0,1,0],e),le.identityMat4());le.mulMat4(le.rotationMat4v(Math.PI,[0,1,0],le.mat4()),b,b);var w,B,x,P=function(e){return le.mulMat4(b,le.translateMat4c(0,e,0,le.identityMat4()),le.identityMat4())},C=P(1.1),M=P(.5),F=c.addChild(new vn(c,{geometry:g.arrowHead,material:r,matrix:C,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),k=c.addChild(new vn(c,{geometry:g.arrowHeadHandle,material:_,matrix:C,pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),E=c.addChild(new vn(c,{geometry:g.axis,material:r,matrix:M,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),I=c.addChild(new vn(c,{geometry:g.axisHandle,material:_,matrix:M,pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),T=c.addChild(new vn(c,{geometry:g.arrowHeadBig,material:r,matrix:C,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),l),D=function(e,t){return le.vec3ApplyQuaternion(c.quaternion,e,t)},S=(w=le.vec3(),B=le.vec3(),x=le.vec3(),function(t,i){D(e,w);var r=h,n=w;le.canvasPosToWorldRay(a,o.camera.viewMatrix,o.camera.projMatrix,o.camera.projection,t,B,x);var s=le.dotVec3(n,x),l=le.subVec3(B,r,i),u=le.dotVec3(l,n),A=le.dotVec3(l,x),c=1-s*s;if(Math.abs(c)>1e-10){var d=(u-s*A)/c;return le.addVec3(r,le.mulVec3Scalar(n,d,i),i),!0}return!1}),R=le.vec3(),U=le.vec3();y[k.id]=y[I.id]={setActivated:function(e){return T.visible=e},initDragAction:function(e){return S(e,R)&&le.subVec3(R,h,R)&&function(e){S(e,U)&&(le.subVec3(U,R,U),i._setPosition(U),i._handlers&&i._handlers.onPosition(U))}}},y[d.id]={setActivated:function(e){return v.visible=e},initDragAction:function(t){var r=function(){var t=o.camera.projectWorldPos(h);D(e,U),le.transformVec3(o.camera.normalMatrix,U,U);var i=Math.sign(U[2]);return function(e){var r=e[0]-t[0],n=e[1]-t[1];return i*Math.atan2(-n,r)}}(),n=r(t);return function(t){var s=r(t);c.rotate(e,180*(s-n)/Math.PI),i._handlers&&i._handlers.onQuaternion(c.quaternion),n=s}}};var L=!1,O=!1,N=!1,V=function(){var e=N&&L;k.visible=I.visible=F.visible=E.visible=!!e,e||(T.visible=!1)},Q=function(){var e=N&&O;d.visible=A.visible=p.visible=f.visible=!!e,e||(v.visible=!1)};return{setPositionActive:function(e){L=e,V()},setRotationActive:function(e){O=e,Q()},set visible(e){N=e,V(),Q()}}};this._displayMeshes={center:c.addChild(new vn(c,{geometry:new mt(c,It({radius:.05})),material:new bn(c,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),l),x:b([1,0,0],le.vec3PairToQuaternion([1,0,0],[0,0,1])),y:b([0,1,0],le.eulerToQuaternion([90,0,0],"XYZ")),z:b([0,0,1],le.identityQuaternion())};var w=[],B=-1,x=function(e){c.scale[0]!==e&&(c.scale=[e,e,e],i._handlers&&i._handlers.onScreenScale&&i._handlers.onScreenScale(c.scale))},P=o.on("tick",(function(){var e=o.camera,t=Math.abs(le.distVec3(e.eye,h));"perspective"===e.projection?t!==B&&x(.07*t*Math.tan(e.perspective.fov*le.DEGTORAD)):"ortho"===e.projection&&x(e.ortho.scale/10),B=t}));w.push((function(){return o.off(P)}));var C=null,M=null;w.push((function(){M&&M.cleanup()}));var F=le.vec2(),E=function(e,t){t[0]=e.pageX,t[1]=e.pageY,eE(a.ownerDocument.documentElement,a,t)},I=function(e){E(e,F);var t=o.pick({canvasPos:F}),i=t&&t.entity,r=i&&i.id;return r in y&&y[r]},T=function(e,t){var i=I(t(e));if(i){M&&M.cleanup();var r=i.initDragAction(F);return r&&(s.pointerEnabled=!1,i.setActivated(!0),M={onChange:function(e){var i=t(e);i&&(E(i,F),r(F))},cleanup:function(){M=null,s.pointerEnabled=!0,i.setActivated(!1)}}),!!r}return!1},D=function(e,t){a.addEventListener(e,t),w.push((function(){return a.removeEventListener(e,t)}))},S=function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};D("mousedown",(function(e){1===e.which&&T(e,(function(e){return 1===e.which&&e}))&&S(e)})),D("mousemove",(function(e){if(M)M.onChange(e),S(e);else{C&&C();var t=I(e);t?(t.setActivated(!0),C=function(){return t.setActivated(!1)}):C=null}})),D("mouseup",(function(e){M&&(M.onChange(e),M.cleanup())})),D("touchstart",(function(e){if(e.preventDefault(),1===e.touches.length){var t=e.touches[0].identifier;T(e,(function(e){return f(e.changedTouches).find((function(e){return e.identifier===t}))}))&&S(e)}})),D("touchmove",(function(e){M&&(M.onChange(e),S(e))})),D("touchend",(function(e){M&&(M.onChange(e),M.cleanup())})),this.__destroy=function(){for(var e in w.forEach((function(e){return e()})),c.destroy(),y)delete y[e]}}return I(e,[{key:"destroy",value:function(){this.__destroy()}},{key:"setHandlers",value:function(e){Object.values(this._displayMeshes).forEach((function(t){return t.visible=!!e})),this._handlers=e,this._displayMeshes.x.setPositionActive(e&&e.onPosition),this._displayMeshes.y.setPositionActive(e&&e.onPosition),this._displayMeshes.z.setPositionActive(e&&e.onPosition),this._displayMeshes.x.setRotationActive(e&&e.onQuaternion),this._displayMeshes.y.setRotationActive(e&&e.onQuaternion),this._displayMeshes.z.setRotationActive(e&&e.onQuaternion)}},{key:"setPosition",value:function(e){this._setPosition(e)}},{key:"setQuaternion",value:function(e){this._setQuaternion(e)}}]),e}(),DI=function(){function e(t,i,r){var n=this;k(this,e),this.id=r.id,this._sectionPlane=r,this._mesh=new vn(i,{id:r.id,geometry:new mt(i,Pt({xSize:.5,ySize:.5,zSize:.001})),material:new bn(i,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Xn(i,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new zn(i,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new zn(i,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});var s=le.vec3([0,0,0]),o=le.vec3(),a=le.vec3([0,0,1]),l=le.vec4(4),u=le.vec3(),A=function(){var e=n._sectionPlane.scene.center,t=[-n._sectionPlane.dir[0],-n._sectionPlane.dir[1],-n._sectionPlane.dir[2]];le.subVec3(e,n._sectionPlane.pos,s);var i=-le.dotVec3(t,s);le.normalizeVec3(t),le.mulVec3Scalar(t,i,o);var r=le.vec3PairToQuaternion(a,n._sectionPlane.dir,l);u[0]=.1*o[0],u[1]=.1*o[1],u[2]=.1*o[2],n._mesh.quaternion=r,n._mesh.position=u};this._onSectionPlanePos=this._sectionPlane.on("pos",A),this._onSectionPlaneDir=this._sectionPlane.on("dir",A),this._highlighted=!1,this._selected=!1}return I(e,[{key:"setHighlighted",value:function(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}},{key:"getHighlighted",value:function(){return this._highlighted}},{key:"setSelected",value:function(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}},{key:"getSelected",value:function(){return this._selected}},{key:"destroy",value:function(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}]),e}(),SI=function(){function e(t,i){var r=this;if(k(this,e),!(i.onHoverEnterPlane&&i.onHoverLeavePlane&&i.onClickedNothing&&i.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=t,this._viewer=t.viewer,this._onHoverEnterPlane=i.onHoverEnterPlane,this._onHoverLeavePlane=i.onHoverLeavePlane,this._onClickedNothing=i.onClickedNothing,this._onClickedPlane=i.onClickedPlane,this._visible=!0,this._planes={},this._canvas=i.overviewCanvas,this._scene=new Jd(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new Vc(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new Vc(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new Vc(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;var n=this._scene.camera,s=le.rotationMat4c(-90*le.DEGTORAD,1,0,0),o=le.vec3(),a=le.vec3(),l=le.vec3();this._synchCamera=function(){var e=r._viewer.camera.eye,t=r._viewer.camera.look,i=r._viewer.camera.up;le.mulVec3Scalar(le.normalizeVec3(le.subVec3(e,t,o)),7),r._zUp?(le.transformVec3(s,o,a),le.transformVec3(s,i,l),n.look=[0,0,0],n.eye=le.transformVec3(s,o,a),n.up=le.transformPoint3(s,i,l)):(n.look=[0,0,0],n.eye=o,n.up=i)},this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(function(e){r._scene.camera.perspective.fov=e}));var u=null;this._onInputMouseMove=this._scene.input.on("mousemove",(function(e){var t=r._scene.pick({canvasPos:e});if(t){if(!u||t.entity.id!==u.id){if(u)r._planes[u.id]&&r._onHoverLeavePlane(u.id);u=t.entity,r._planes[u.id]&&r._onHoverEnterPlane(u.id)}}else u&&(r._onHoverLeavePlane(u.id),u=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=function(){u?r._planes[u.id]&&r._onClickedPlane(u.id):r._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=function(){u&&(r._onHoverLeavePlane(u.id),u=null)}),this.setVisible(i.overviewVisible)}return I(e,[{key:"addSectionPlane",value:function(e){this._planes[e.id]=new DI(this,this._scene,e)}},{key:"setPlaneHighlighted",value:function(e,t){var i=this._planes[e];i&&i.setHighlighted(t)}},{key:"setPlaneSelected",value:function(e,t){var i=this._planes[e];i&&i.setSelected(t)}},{key:"removeSectionPlane",value:function(e){var t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}},{key:"setVisible",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}},{key:"getVisible",value:function(){return this._visible}},{key:"destroy",value:function(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}]),e}(),RI=le.AABB3(),UI=le.vec3(),LI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,"SectionPlanes",e))._freeControls=[],r._sectionPlanes=e.scene.sectionPlanes,r._controls={},r._shownControlId=null,null!==n.overviewCanvasId&&void 0!==n.overviewCanvasId){var s=document.getElementById(n.overviewCanvasId);s?r._overview=new SI(w(r),{overviewCanvas:s,visible:n.overviewVisible,onHoverEnterPlane:function(e){r._overview.setPlaneHighlighted(e,!0)},onHoverLeavePlane:function(e){r._overview.setPlaneHighlighted(e,!1)},onClickedPlane:function(e){if(r.getShownControl()!==e){r.showControl(e);var t=r.sectionPlanes[e].pos;RI.set(r.viewer.scene.aabb),le.getAABB3Center(RI,UI),RI[0]+=t[0]-UI[0],RI[1]+=t[1]-UI[1],RI[2]+=t[2]-UI[2],RI[3]+=t[0]-UI[0],RI[4]+=t[1]-UI[1],RI[5]+=t[2]-UI[2],r.viewer.cameraFlight.flyTo({aabb:RI,fitFOV:65})}else r.hideControl()},onClickedNothing:function(){r.hideControl()}}):r.warn("Can't find overview canvas: '"+n.overviewCanvasId+"' - will create plugin without overview")}return r._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(function(e){r._sectionPlaneCreated(e)})),r}return I(i,[{key:"setOverviewVisible",value:function(e){this._overview&&this._overview.setVisible(e)}},{key:"getOverviewVisible",value:function(){if(this._overview)return this._overview.getVisible()}},{key:"sectionPlanes",get:function(){return this._sectionPlanes}},{key:"createSectionPlane",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);var t=new hh(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0});return t}},{key:"_sectionPlaneCreated",value:function(e){var t,i,r,n,s,o,a,l,u,A,c,h=this,d=this._freeControls.length>0?this._freeControls.pop():(n=h.viewer.scene,(r=new Xt(n,{isObject:!1})).addChild(new vn(r,{geometry:new mt(r,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new bn(r,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new zn(r,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1],isObject:!1})),r.addChild(new vn(r,{geometry:new mt(r,Tt({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bn(r,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new zn(r,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45],isObject:!1})),s={setPosition:(t=le.vec3(),i=le.vec3(),function(e){Yt(e,t,i),r.origin=t,r.position=i}),setQuaternion:function(e){r.quaternion=e},setScale:function(e){r.scale=e},setVisible:function(e){r.visible=e},destroy:function(){r.destroy()}},o=function(){},a=new TI(h.viewer),l=!1,u=!1,A=null,c=function(){var e=u&&!l;s.setVisible(e),a.setHandlers(e&&A)},{_destroy:function(){o(),a.destroy(),s.destroy()},setCulled:function(e){l=e,c()},setVisible:function(e){u=e,c()},_setSectionPlane:function(e){if(o(),e){var t=!1;A={onPosition:function(t){s.setPosition(t),e.pos=t},onQuaternion:function(i){s.setQuaternion(i),t=!0,e.quaternion=i},onScreenScale:function(e){s.setScale(e)}};var i=function(){s.setPosition(e.pos),a.setPosition(e.pos)},r=function(){s.setQuaternion(e.quaternion),a.setQuaternion(e.quaternion)};i(),r();var n=e.on("pos",i),l=e.on("dir",(function(){t?t=!1:r()}));o=function(){e.off(n),e.off(l),o=function(){}}}}});d._setSectionPlane(e),d.setVisible(!1),this._controls[e.id]=d,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(function(){h._sectionPlaneDestroyed(e)}))}},{key:"flipSectionPlanes",value:function(){var e=this.viewer.scene.sectionPlanes;for(var t in e){e[t].flipDir()}}},{key:"showControl",value:function(e){var t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e)}},{key:"getShownControl",value:function(){return this._shownControlId}},{key:"hideControl",value:function(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}},{key:"destroySectionPlane",value:function(e){var t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e)}},{key:"_sectionPlaneDestroyed",value:function(e){this._overview&&this._overview.removeSectionPlane(e);var t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}},{key:"clear",value:function(){for(var e=Object.keys(this._sectionPlanes),t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}},{key:"send",value:function(e,t){switch(e){case"snapshotStarting":for(var i in this._controls)this._controls.hasOwnProperty(i)&&this._controls[i].setCulled(!0);break;case"snapshotFinished":for(var r in this._controls)this._controls.hasOwnProperty(r)&&this._controls[r].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}},{key:"destroy",value:function(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),v(x(i.prototype),"destroy",this).call(this)}},{key:"_destroyFreeControls",value:function(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}]),i}(),OI=I((function e(t,i,r,n,s,o){k(this,e),this.plugin=t,this.storeyId=s,this.modelId=n,this.storeyAABB=r.slice(),this.aabb=this.storeyAABB,this.modelAABB=i.slice(),this.numObjects=o})),NI=I((function e(t,i,r,n,s,o){k(this,e),this.storeyId=t,this.imageData=i,this.format=r,this.width=n,this.height=s})),VI=le.vec3(),QI=le.mat4(),HI="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",GI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"StoreyViews",e))._objectsMemento=new th,r._cameraMemento=new Yc,r.storeys={},r._storeysList=null,r.modelStoreys={},r._fitStoreyMaps=!!n.fitStoreyMaps,r._onModelLoaded=r.viewer.scene.on("modelLoaded",(function(e){r._registerModelStoreys(e),r.fire("storeys",r.storeys)})),r}return I(i,[{key:"_registerModelStoreys",value:function(e){var t=this,i=this.viewer,r=i.scene,n=i.metaScene,s=n.metaModels[e],o=r.models[e];if(s&&s.rootMetaObjects){for(var a=s.rootMetaObjects,l=0,u=a.length;l<u;l++)for(var A=a[l].getObjectIDsInSubtreeByType(["IfcBuildingStorey"]),c=0,h=A.length;c<h;c++){var d=A[c],p=n.metaObjects[d].getObjectIDsInSubtree(),f=r.getAABB(p),v=Math.random()>.5?p.length:0,g=new OI(this,o.aabb,f,e,d,v);g._onModelDestroyed=o.once("destroyed",(function(){t._deregisterModelStoreys(e),t.fire("storeys",t.storeys)})),this.storeys[d]=g,this._storeysList=null,this.modelStoreys[e]||(this.modelStoreys[e]={}),this.modelStoreys[e][d]=g}this._clipBoundingBoxes()}}},{key:"_clipBoundingBoxes",value:function(){var e,t=this.storeysList,i=this.viewer.metaScene,r=this.viewer.camera.worldUp,n=r[0]>r[1]&&r[0]>r[2],s=!n&&r[1]>r[0]&&r[1]>r[2];!n&&!s&&r[2]>r[0]&&(r[2],r[1]),e=n?0:s?1:2;for(var o=0,a=t.length;o<a;o++){var l=i.metaObjects[t[o].storeyId].attributes.elevation;if(isNaN(l))return;var u=t[o].storeyAABB;if(u[e]=Math.max(u[1],parseFloat(l)),o>0){var A=i.metaObjects[t[o-1].storeyId].attributes.elevation;u[4]=Math.min(u[e+3],parseFloat(A))}this.storeys[t[o].storeyId].storeyAABB=u}}},{key:"_deregisterModelStoreys",value:function(e){var t=this.modelStoreys[e];if(t){var i=this.viewer.scene;for(var r in t)if(t.hasOwnProperty(r)){var n=t[r],s=i.models[n.modelId];s&&s.off(n._onModelDestroyed),delete this.storeys[r],this._storeysList=null}delete this.modelStoreys[e]}}},{key:"fitStoreyMaps",get:function(){return this._fitStoreyMaps}},{key:"gotoStoreyCamera",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.storeys[e];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+e),void(t.done&&t.done());var r=this.viewer,n=r.scene,s=n.camera,o=i.storeyAABB;if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])t.done&&t.done();else if(o[3]!==o[0]||o[4]!==o[1]||o[5]!==o[2]){var a=le.getAABB3Center(o),l=le.getAABB3Diag(o),u=45,A=Math.abs(l/Math.tan(u*le.DEGTORAD)),c=1.3*l,h=VI;h[0]=a[0]+s.worldUp[0]*A,h[1]=a[1]+s.worldUp[1]*A,h[2]=a[2]+s.worldUp[2]*A;var d=s.worldForward;t.done?r.cameraFlight.flyTo(ge.apply(t,{eye:h,look:a,up:d,orthoScale:c}),(function(){t.done()})):(r.cameraFlight.jumpTo(ge.apply(t,{eye:h,look:a,up:d,orthoScale:c})),r.camera.ortho.scale=c)}else t.done&&t.done()}},{key:"showStoreyObjects",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.storeys[e];if(i){var r=this.viewer,n=r.scene,s=r.metaScene,o=s.metaObjects[e];o&&(t.hideOthers&&n.setObjectsVisible(r.scene.visibleObjectIds,!1),this.withStoreyObjects(e,(function(e,t){e&&(e.visible=!0)})))}else this.error("IfcBuildingStorey not found with this ID: "+e)}},{key:"withStoreyObjects",value:function(e,t){var i=this.viewer,r=i.scene,n=i.metaScene,s=n.metaObjects[e];if(s)for(var o=s.getObjectIDsInSubtree(),a=0,l=o.length;a<l;a++){var u=o[a],A=n.metaObjects[u],c=r.objects[u];c&&t(c,A)}}},{key:"createStoreyMap",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.storeys[e];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+e),HI;var r,n,s=this.viewer,o=s.scene,a=t.format||"png",l=this._fitStoreyMaps?i.storeyAABB:i.modelAABB,u=Math.abs((l[5]-l[2])/(l[3]-l[0])),A=t.padding||0,c=!!t.captureSectionPlanes;t.width&&t.height?(r=t.width,n=t.height):t.height?(n=t.height,r=Math.round(n/u)):t.width?(r=t.width,n=Math.round(r*u)):(r=300,n=Math.round(r*u));var h={visible:!0};this._objectsMemento.saveObjects(o,h),this._cameraMemento.saveCamera(o),this.showStoreyObjects(e,ge.apply(t,{hideOthers:!0})),c&&this._toggleSectionPlanes(!1),this._arrangeStoreyMapCamera(i);var d=s.getSnapshot({width:r,height:n,format:a});return this._objectsMemento.restoreObjects(o,h),this._cameraMemento.restoreCamera(o),c&&this._toggleSectionPlanes(!0),new NI(e,d,a,r,n,A)}},{key:"_toggleSectionPlanes",value:function(e){var t=this.viewer.scene.sectionPlanes;for(var i in t)t[i].active=e}},{key:"_arrangeStoreyMapCamera",value:function(e){var t=this.viewer,i=t.scene.camera,r=this._fitStoreyMaps?e.storeyAABB:e.modelAABB,n=le.getAABB3Center(r),s=VI;s[0]=n[0]+.5*i.worldUp[0],s[1]=n[1]+.5*i.worldUp[1],s[2]=n[2]+.5*i.worldUp[2];var o=i.worldForward;t.cameraFlight.jumpTo({eye:s,look:n,up:o});var a=(r[3]-r[0])/2,l=(r[4]-r[1])/2,u=(r[5]-r[2])/2,A=-a,c=+a,h=-l,d=+l,p=-u,f=+u;t.camera.customProjection.matrix=le.orthoMat4c(A,c,p,f,h,d,QI),t.camera.projection="customProjection"}},{key:"pickStoreyMap",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e.storeyId,n=this.storeys[r];if(!n)return this.error("IfcBuildingStorey not found with this ID: "+r),null;var s=1-t[0]/e.width,o=1-t[1]/e.height,a=this._fitStoreyMaps?n.storeyAABB:n.modelAABB,l=a[0],u=a[1],A=a[2],c=a[3],h=a[4],d=a[5],p=c-l,f=h-u,v=d-A,g=le.vec3([l+p*s,u+.5*f,A+v*o]),m=le.vec3([0,-1,0]),_=le.addVec3(g,m,VI),y=this.viewer.camera.worldForward,b=le.lookAtMat4v(g,_,y,QI),w=this.viewer.scene.pick({pickSurface:i.pickSurface,pickInvisible:!0,matrix:b});return w}},{key:"storeyMapToWorldPos",value:function(e,t){var i=e.storeyId,r=this.storeys[i];if(!r)return this.error("IfcBuildingStorey not found with this ID: "+i),null;var n=1-t[0]/e.width,s=1-t[1]/e.height,o=this._fitStoreyMaps?r.storeyAABB:r.modelAABB,a=o[0],l=o[1],u=o[2],A=o[3],c=o[4],h=o[5],d=A-a,p=c-l,f=h-u,v=le.vec3([a+d*n,l+.5*p,u+f*s]);return v}},{key:"getStoreyContainingWorldPos",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=t?this._filterStoreys(t):this.storeys;for(var r in i){var n=i[r];if(le.point3AABB3AbsoluteIntersect(n.storeyAABB,e))return r}return null}},{key:"getStoreyInVerticalRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=t?this._filterStoreys(t):this.storeys;for(var r in i){var n=i[r],s=[0,0,0,0,0,0],o=[0,0,0];if(s[1]=n.storeyAABB[1],s[4]=n.storeyAABB[4],o[1]=e[1],le.point3AABB3AbsoluteIntersect(s,o))return r}return null}},{key:"isPositionAboveOrBelowBuilding",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=t?this._filterStoreys(t):this.storeys,r=Object.keys(i);if(r.length<=0)return null;var n=[r[0],r[r.length-1]];return e[1]<i[n[0]].storeyAABB[1]?n[0]:e[1]>i[n[1]].storeyAABB[4]?n[1]:null}},{key:"worldPosToStoreyMap",value:function(e,t,i){var r=e.storeyId,n=this.storeys[r];if(!n)return this.error("IfcBuildingStorey not found with this ID: "+r),!1;var s=this._fitStoreyMaps?n.storeyAABB:n.modelAABB,o=s[0],a=s[1],l=s[2],u=s[3]-o,A=s[4]-a,c=s[5]-l,h=this.viewer.camera.worldUp,d=h[0]>h[1]&&h[0]>h[2],p=!d&&h[1]>h[0]&&h[1]>h[2];!d&&!p&&h[2]>h[0]&&(h[2],h[1]);var f=e.width/u,v=p?e.height/c:e.height/A;return i[0]=Math.floor(e.width-(t[0]-o)*f),i[1]=Math.floor(e.height-(t[2]-l)*v),i[0]>=0&&i[0]<e.width&&i[1]>=0&&i[1]<=e.height}},{key:"worldDirToStoreyMap",value:function(e,t,i){var r=this.viewer.camera,n=r.eye,s=r.look,o=le.subVec3(s,n,VI),a=r.worldUp,l=a[0]>a[1]&&a[0]>a[2],u=!l&&a[1]>a[0]&&a[1]>a[2];!l&&!u&&a[2]>a[0]&&(a[2],a[1]),l?(i[0]=o[1],i[1]=o[2]):u?(i[0]=o[0],i[1]=o[2]):(i[0]=o[0],i[1]=o[1]),le.normalizeVec2(i)}},{key:"destroy",value:function(){this.viewer.scene.off(this._onModelLoaded),v(x(i.prototype),"destroy",this).call(this)}},{key:"storeysList",get:function(){return this._storeysList||(this._storeysList=Object.values(this.storeys),this._storeysList.sort(this._getSpatialSortFunc())),this._storeysList}},{key:"_getSpatialSortFunc",value:function(){var e=this,t=this.viewer.scene.camera;return this._spatialSortFunc||(this._spatialSortFunc=function(i,r){var n=0;n=t.xUp?0:t.yUp?1:2;var s=e.viewer.metaScene,o=s.metaObjects[i.storeyId],a=s.metaObjects[r.storeyId];if(o&&o.attributes&&void 0!==o.attributes.elevation&&a&&a.attributes&&void 0!==a.attributes.elevation){var l=Number.parseFloat(o.attributes.elevation),u=Number.parseFloat(a.attributes.elevation);return l>u?-1:l<u?1:0}return i.aabb[n]>r.aabb[n]?-1:i.aabb[n]<r.aabb[n]?1:0})}},{key:"_filterStoreys",value:function(e){return Object.fromEntries(Object.entries(this.storeys).filter((function(t){var i=C(t,2);i[0];return i[1].modelId===e})))}}]),i}(),jI=new Float64Array([0,0,1]),zI=new Float64Array(4),WI=function(){function e(t){k(this,e),this.id=null,this._viewer=t.viewer,this._plugin=t,this._visible=!1,this._pos=le.vec3(),this._origin=le.vec3(),this._rtcPos=le.vec3(),this._baseDir=le.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()}return I(e,[{key:"_setSectionPlane",value:function(e){var t=this;this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),e&&(this.id=e.id,this._setPos(e.pos),this._setDir(e.dir),this._sectionPlane=e,this._onSectionPlanePos=e.on("pos",(function(){t._setPos(t._sectionPlane.pos)})),this._onSectionPlaneDir=e.on("dir",(function(){t._ignoreNextSectionPlaneDirUpdate?t._ignoreNextSectionPlaneDirUpdate=!1:t._setDir(t._sectionPlane.dir)})))}},{key:"sectionPlane",get:function(){return this._sectionPlane}},{key:"_setPos",value:function(e){this._pos.set(e),Yt(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos}},{key:"_setDir",value:function(e){this._baseDir.set(e),this._rootNode.quaternion=le.vec3PairToQuaternion(jI,e,zI)}},{key:"_setSectionPlaneDir",value:function(e){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=e)}},{key:"setVisible",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._visible!==e){var t;for(t in this._visible=e,this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].visible=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].visible=e)}}},{key:"getVisible",value:function(){return this._visible}},{key:"setCulled",value:function(e){var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].culled=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].culled=e)}},{key:"_createNodes",value:function(){var e=!1,t=this._viewer.scene,i=.01;this._rootNode=new Xt(t,{position:[0,0,0],scale:[5,5,5]});var r=this._rootNode,n={arrowHead:new mt(r,Ft({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new mt(r,Ft({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),axis:new mt(r,Ft({radiusTop:i,radiusBottom:i,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},s={red:new bn(r,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),green:new bn(r,{diffuse:[0,1,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),blue:new bn(r,{diffuse:[0,0,1],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new zn(r,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6})};this._displayMeshes={plane:r.addChild(new vn(r,{geometry:new mt(r,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new bn(r,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),e),planeFrame:r.addChild(new vn(r,{geometry:new mt(r,Tt({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bn(r,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),e),center:r.addChild(new vn(r,{geometry:new mt(r,It({radius:.05})),material:s.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:r.addChild(new vn(r,{geometry:n.arrowHead,material:s.blue,matrix:function(){var e=le.translateMat4c(0,1.1,0,le.identityMat4()),t=le.rotationMat4v(-90*le.DEGTORAD,[.8,0,0],le.identityMat4());return le.mulMat4(t,e,le.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zShaft:r.addChild(new vn(r,{geometry:n.axis,material:s.blue,matrix:function(){var e=le.translateMat4c(0,.5,0,le.identityMat4()),t=le.rotationMat4v(-90*le.DEGTORAD,[1,0,0],le.identityMat4());return le.mulMat4(t,e,le.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),e)},this._affordanceMeshes={planeFrame:r.addChild(new vn(r,{geometry:new mt(r,Tt({center:[0,0,0],radius:2,tube:i,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bn(r,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new zn(r,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),e),zAxisArrow:r.addChild(new vn(r,{geometry:n.arrowHeadBig,material:s.blue,matrix:function(){var e=le.translateMat4c(0,1.1,0,le.identityMat4()),t=le.rotationMat4v(-90*le.DEGTORAD,[.8,0,0],le.identityMat4());return le.mulMat4(t,e,le.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e)}}},{key:"_bindEvents",value:function(){var e=this,t=this._rootNode,i=le.vec2(),r=this._viewer.camera,n=this._viewer.scene,s=0,o=!1,a=le.vec3([0,0,0]),l=-1;this._onCameraViewMatrix=n.camera.on("viewMatrix",(function(){})),this._onCameraProjMatrix=n.camera.on("projMatrix",(function(){})),this._onSceneTick=n.on("tick",(function(){o=!1;var i=Math.abs(le.lenVec3(le.subVec3(n.camera.eye,e._pos,a)));if(i!==l&&"perspective"===r.projection){var u=.07*(Math.tan(r.perspective.fov*le.DEGTORAD)*i);t.scale=[u,u,u],l=i}if("ortho"===r.projection){var c=r.ortho.scale/10;t.scale=[c,c,c],l=i}0!==s&&(A(s),s=0)}));var u=function(){var e=new Float64Array(2);return function(t){if(t){for(var i=t.target,r=0,n=0;i.offsetParent;)r+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-r,e[1]=t.pageY-n}else t=window.event,e[0]=t.x,e[1]=t.y;return e}}(),A=function(t){var i=e._sectionPlane.pos,r=e._sectionPlane.dir;le.addVec3(i,le.mulVec3Scalar(r,.1*t*e._plugin.getDragSensitivity(),le.vec3())),e._sectionPlane.pos=i},c=!1;this._plugin._controlElement.addEventListener("mousedown",this._canvasMouseDownListener=function(t){if(t.preventDefault(),e._visible&&(e._viewer.cameraControl.pointerEnabled=!1,1===t.which)){c=!0;var r=u(t);i[0]=r[0],i[1]=r[1]}}),this._plugin._controlElement.addEventListener("mousemove",this._canvasMouseMoveListener=function(t){if(e._visible&&c&&!o){var r=u(t),n=r[0],s=r[1];A(s-i[1]),i[0]=n,i[1]=s}}),this._plugin._controlElement.addEventListener("mouseup",this._canvasMouseUpListener=function(t){e._visible&&(e._viewer.cameraControl.pointerEnabled=!0,c&&(t.which,c=!1))}),this._plugin._controlElement.addEventListener("wheel",this._canvasWheelListener=function(t){e._visible&&(s+=Math.max(-1,Math.min(1,40*-t.deltaY)))});var h,d,p=null;this._plugin._controlElement.addEventListener("touchstart",this._handleTouchStart=function(t){t.stopPropagation(),t.preventDefault(),e._visible&&(h=t.touches[0].clientY,p=h,s=0)}),this._plugin._controlElement.addEventListener("touchmove",this._handleTouchMove=function(t){t.stopPropagation(),t.preventDefault(),e._visible&&(o||(o=!0,d=t.touches[0].clientY,null!==p&&(s+=d-p),p=d))}),this._plugin._controlElement.addEventListener("touchend",this._handleTouchEnd=function(t){t.stopPropagation(),t.preventDefault(),e._visible&&(h=null,d=null,s=0)})}},{key:"_destroy",value:function(){this._unbindEvents(),this._destroyNodes()}},{key:"_unbindEvents",value:function(){var e=this._viewer,t=e.scene,i=t.canvas.canvas,r=e.camera,n=this._plugin._controlElement;t.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),n.removeEventListener("touchstart",this._handleTouchStart),n.removeEventListener("touchmove",this._handleTouchMove),n.removeEventListener("touchend",this._handleTouchEnd),r.off(this._onCameraViewMatrix),r.off(this._onCameraProjMatrix)}},{key:"_destroyNodes",value:function(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}}}]),e}(),XI=function(){function e(t,i,r){var n=this;k(this,e),this.id=r.id,this._sectionPlane=r,this._mesh=new vn(i,{id:r.id,geometry:new mt(i,Pt({xSize:.5,ySize:.5,zSize:.001})),material:new bn(i,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Xn(i,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new zn(i,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new zn(i,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});var s=le.vec3([0,0,0]),o=le.vec3(),a=le.vec3([0,0,1]),l=le.vec4(4),u=le.vec3(),A=function(){var e=n._sectionPlane.scene.center,t=[-n._sectionPlane.dir[0],-n._sectionPlane.dir[1],-n._sectionPlane.dir[2]];le.subVec3(e,n._sectionPlane.pos,s);var i=-le.dotVec3(t,s);le.normalizeVec3(t),le.mulVec3Scalar(t,i,o);var r=le.vec3PairToQuaternion(a,n._sectionPlane.dir,l);u[0]=.1*o[0],u[1]=.1*o[1],u[2]=.1*o[2],n._mesh.quaternion=r,n._mesh.position=u};this._onSectionPlanePos=this._sectionPlane.on("pos",A),this._onSectionPlaneDir=this._sectionPlane.on("dir",A),this._highlighted=!1,this._selected=!1}return I(e,[{key:"setHighlighted",value:function(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}},{key:"getHighlighted",value:function(){return this._highlighted}},{key:"setSelected",value:function(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}},{key:"getSelected",value:function(){return this._selected}},{key:"destroy",value:function(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}]),e}(),KI=function(){function e(t,i){var r=this;if(k(this,e),!(i.onHoverEnterPlane&&i.onHoverLeavePlane&&i.onClickedNothing&&i.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=t,this._viewer=t.viewer,this._onHoverEnterPlane=i.onHoverEnterPlane,this._onHoverLeavePlane=i.onHoverLeavePlane,this._onClickedNothing=i.onClickedNothing,this._onClickedPlane=i.onClickedPlane,this._visible=!0,this._planes={},this._canvas=i.overviewCanvas,this._scene=new Jd(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new Vc(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new Vc(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new Vc(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;var n=this._scene.camera,s=le.rotationMat4c(-90*le.DEGTORAD,1,0,0),o=le.vec3(),a=le.vec3(),l=le.vec3();this._synchCamera=function(){var e=r._viewer.camera.eye,t=r._viewer.camera.look,i=r._viewer.camera.up;le.mulVec3Scalar(le.normalizeVec3(le.subVec3(e,t,o)),7),r._zUp?(le.transformVec3(s,o,a),le.transformVec3(s,i,l),n.look=[0,0,0],n.eye=le.transformVec3(s,o,a),n.up=le.transformPoint3(s,i,l)):(n.look=[0,0,0],n.eye=o,n.up=i)},this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(function(e){r._scene.camera.perspective.fov=e}));var u=null;this._onInputMouseMove=this._scene.input.on("mousemove",(function(e){var t=r._scene.pick({canvasPos:e});if(t){if(!u||t.entity.id!==u.id){if(u)r._planes[u.id]&&r._onHoverLeavePlane(u.id);u=t.entity,r._planes[u.id]&&r._onHoverEnterPlane(u.id)}}else u&&(r._onHoverLeavePlane(u.id),u=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=function(){u?r._planes[u.id]&&r._onClickedPlane(u.id):r._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=function(){u&&(r._onHoverLeavePlane(u.id),u=null)}),this.setVisible(i.overviewVisible)}return I(e,[{key:"addSectionPlane",value:function(e){this._planes[e.id]=new XI(this,this._scene,e)}},{key:"setPlaneHighlighted",value:function(e,t){var i=this._planes[e];i&&i.setHighlighted(t)}},{key:"setPlaneSelected",value:function(e,t){var i=this._planes[e];i&&i.setSelected(t)}},{key:"removeSectionPlane",value:function(e){var t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}},{key:"setVisible",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}},{key:"getVisible",value:function(){return this._visible}},{key:"destroy",value:function(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}]),e}(),ZI=le.AABB3(),JI=le.vec3(),YI=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,"FaceAlignedSectionPlanesPlugin",e))._freeControls=[],r._sectionPlanes=e.scene.sectionPlanes,r._controls={},r._shownControlId=null,r._dragSensitivity=n.dragSensitivity||1,null!==n.overviewCanvasId&&void 0!==n.overviewCanvasId){var s=document.getElementById(n.overviewCanvasId);s?r._overview=new KI(w(r),{overviewCanvas:s,visible:n.overviewVisible,onHoverEnterPlane:function(e){r._overview.setPlaneHighlighted(e,!0)},onHoverLeavePlane:function(e){r._overview.setPlaneHighlighted(e,!1)},onClickedPlane:function(e){if(r.getShownControl()!==e){r.showControl(e);var t=r.sectionPlanes[e].pos;ZI.set(r.viewer.scene.aabb),le.getAABB3Center(ZI,JI),ZI[0]+=t[0]-JI[0],ZI[1]+=t[1]-JI[1],ZI[2]+=t[2]-JI[2],ZI[3]+=t[0]-JI[0],ZI[4]+=t[1]-JI[1],ZI[5]+=t[2]-JI[2],r.viewer.cameraFlight.flyTo({aabb:ZI,fitFOV:65})}else r.hideControl()},onClickedNothing:function(){r.hideControl()}}):r.warn("Can't find overview canvas: '"+n.overviewCanvasId+"' - will create plugin without overview")}return null===n.controlElementId||void 0===n.controlElementId?r.error("Parameter expected: controlElementId"):(r._controlElement=document.getElementById(n.controlElementId),r._controlElement||r.warn("Can't find control element: '"+n.controlElementId+"' - will create plugin without control element")),r._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(function(e){r._sectionPlaneCreated(e)})),r}return I(i,[{key:"setDragSensitivity",value:function(e){this._dragSensitivity=e||1}},{key:"getDragSensitivity",value:function(){return this._dragSensitivity}},{key:"setOverviewVisible",value:function(e){this._overview&&this._overview.setVisible(e)}},{key:"getOverviewVisible",value:function(){if(this._overview)return this._overview.getVisible()}},{key:"sectionPlanes",get:function(){return this._sectionPlanes}},{key:"createSectionPlane",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);var t=new hh(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0});return t}},{key:"_sectionPlaneCreated",value:function(e){var t=this,i=this._freeControls.length>0?this._freeControls.pop():new WI(this);i._setSectionPlane(e),i.setVisible(!1),this._controls[e.id]=i,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(function(){t._sectionPlaneDestroyed(e)}))}},{key:"flipSectionPlanes",value:function(){var e=this.viewer.scene.sectionPlanes;for(var t in e){e[t].flipDir()}}},{key:"showControl",value:function(e){var t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e)}},{key:"getShownControl",value:function(){return this._shownControlId}},{key:"hideControl",value:function(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}},{key:"destroySectionPlane",value:function(e){var t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e)}},{key:"_sectionPlaneDestroyed",value:function(e){this._overview&&this._overview.removeSectionPlane(e);var t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}},{key:"clear",value:function(){for(var e=Object.keys(this._sectionPlanes),t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}},{key:"send",value:function(e,t){switch(e){case"snapshotStarting":for(var i in this._controls)this._controls.hasOwnProperty(i)&&this._controls[i].setCulled(!0);break;case"snapshotFinished":for(var r in this._controls)this._controls.hasOwnProperty(r)&&this._controls[r].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}},{key:"destroy",value:function(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),v(x(i.prototype),"destroy",this).call(this)}},{key:"_destroyFreeControls",value:function(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}]),i}(),qI=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getSTL",value:function(e,t,i){e=this._cacheBusterURL(e);var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.responseType="arraybuffer",r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t(r.response):i(r.statusText))},r.send(null)}}]),e}(),$I=le.vec3(),eT=function(){function e(){k(this,e)}return I(e,[{key:"load",value:function(e,t,i,r,n,s){r=r||{};var o=e.viewer.scene.canvas.spinner;o.processes++,e.dataSource.getSTL(i,(function(i){!function(e,t,i,r){try{var n=oT(i);tT(n)?iT(e,n,t,r):rT(e,sT(i),t,r)}catch(e){t.fire("error",e)}}(e,t,i,r);try{var a=oT(i);tT(a)?iT(e,a,t,r):rT(e,sT(i),t,r),o.processes--,Fe.scheduleTask((function(){t.fire("loaded",!0,!1)})),n&&n()}catch(i){o.processes--,e.error(i),s&&s(i),t.fire("error",i)}}),(function(i){o.processes--,e.error(i),s&&s(i),t.fire("error",i)}))}},{key:"parse",value:function(e,t,i,r){var n=e.viewer.scene.canvas.spinner;n.processes++;try{var s=oT(i);tT(s)?iT(e,s,t,r):rT(e,sT(i),t,r),n.processes--,Fe.scheduleTask((function(){t.fire("loaded",!0,!1)}))}catch(e){n.processes--,t.fire("error",e)}}}]),e}();function tT(e){var t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;for(var i=[115,111,108,105,100],r=0;r<5;r++)if(i[r]!==t.getUint8(r,!1))return!0;return!1}function iT(e,t,i,r){for(var n,s,o,a,l,u,A,c=new DataView(t),h=c.getUint32(80,!0),d=!1,p=null,f=null,v=null,g=!1,m=0;m<70;m++)1129270351===c.getUint32(m,!1)&&82===c.getUint8(m+4)&&61===c.getUint8(m+5)&&(d=!0,a=[],l=c.getUint8(m+6)/255,u=c.getUint8(m+7)/255,A=c.getUint8(m+8)/255,c.getUint8(m+9));for(var _=new Vn(i,{roughness:.5}),y=[],b=[],w=r.splitMeshes,B=0;B<h;B++){var x=84+50*B,P=c.getFloat32(x,!0),C=c.getFloat32(x+4,!0),M=c.getFloat32(x+8,!0);if(d){var F=c.getUint16(x+48,!0);0==(32768&F)?(n=(31&F)/31,s=(F>>5&31)/31,o=(F>>10&31)/31):(n=l,s=u,o=A),(w&&n!==p||s!==f||o!==v)&&(null!==p&&(g=!0),p=n,f=s,v=o)}for(var k=1;k<=3;k++){var E=x+12*k;y.push(c.getFloat32(E,!0)),y.push(c.getFloat32(E+4,!0)),y.push(c.getFloat32(E+8,!0)),b.push(P,C,M),d&&a.push(n,s,o,1)}w&&g&&(nT(i,y,b,a,_,r),y=[],b=[],a=a?[]:null,g=!1)}y.length>0&&nT(i,y,b,a,_,r)}function rT(e,t,i,r){for(var n,s,o,a,l,u,A,c=/facet([\s\S]*?)endfacet/g,h=0,d=/[\s]+([+-]?(?:\d+.\d+|\d+.|\d+|.\d+)(?:[eE][+-]?\d+)?)/.source,p=new RegExp("vertex"+d+d+d,"g"),f=new RegExp("normal"+d+d+d,"g"),v=[],g=[];null!==(a=c.exec(t));){for(l=0,u=0,A=a[0];null!==(a=f.exec(A));)n=parseFloat(a[1]),s=parseFloat(a[2]),o=parseFloat(a[3]),u++;for(;null!==(a=p.exec(A));)v.push(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])),g.push(n,s,o),l++;1!==u&&e.error("Error in normal of face "+h),3!==l&&e.error("Error in positions of face "+h),h++}nT(i,v,g,null,new Vn(i,{roughness:.5}),r)}function nT(e,t,i,r,n,s){for(var o=new Int32Array(t.length/3),a=0,l=o.length;a<l;a++)o[a]=a;i=i&&i.length>0?i:null,r=r&&r.length>0?r:null,s.smoothNormals&&le.faceToVertexNormals(t,i,s);var u=$I;qt(t,t,u);var A=new mt(e,{primitive:"triangles",positions:t,normals:i,colors:r,indices:o}),c=new vn(e,{origin:0!==u[0]||0!==u[1]||0!==u[2]?u:null,geometry:A,material:n,edges:s.edges});e.addChild(c)}function sT(e){return"string"!=typeof e?function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",i=0,r=e.length;i<r;i++)t+=String.fromCharCode(e[i]);return decodeURIComponent(escape(t))}(new Uint8Array(e)):e}function oT(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=255&e.charCodeAt(i);return t.buffer||t}return e}var aT=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"STLLoader",e,n))._sceneGraphLoader=new eT,r.dataSource=n.dataSource,r}return I(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new qI}},{key:"load",value:function(e){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);var t=new Xt(this.viewer.scene,ge.apply(e,{isModel:!0})),i=e.src,r=e.stl;return i||r?(i?this._sceneGraphLoader.load(this,t,i,e):this._sceneGraphLoader.parse(this,t,r,e),t):(this.error("load() param expected: either 'src' or 'stl'"),t)}}]),i}(),lT=function(){function e(t){k(this,e),this._treeViewContainer=t}return I(e,[{key:"createRootNode",value:function(){return document.createElement("ul")}},{key:"createNodeElement",value:function(e,t,i,r,n){var s=document.createElement("li");if(s.id=e.nodeId,e.xrayed&&s.classList.add("xrayed-node"),e.children.length>0){var o=document.createElement("a");o.href="#",o.id="switch-".concat(e.nodeId),o.textContent="+",o.classList.add("plus"),t&&o.addEventListener("click",t),s.appendChild(o)}var a=document.createElement("input");a.id="checkbox-".concat(e.nodeId),a.type="checkbox",a.checked=e.checked,a.style["pointer-events"]="all",i&&a.addEventListener("change",i),s.appendChild(a);var l=document.createElement("span");return l.textContent=e.title,s.appendChild(l),r&&Uk(l,r),n&&(l.onclick=n),s}},{key:"createDisabledNodeElement",value:function(e){var t=document.createElement("li"),i=document.createElement("a");i.href="#",i.textContent="!",i.classList.add("warn"),i.classList.add("warning"),t.appendChild(i);var r=document.createElement("span");return r.textContent=e,t.appendChild(r),t}},{key:"addChildren",value:function(e,t){var i=document.createElement("ul");t.forEach((function(e){i.appendChild(e)})),e.parentElement.appendChild(i)}},{key:"expand",value:function(e,t,i){e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",t),e.addEventListener("click",i)}},{key:"collapse",value:function(e,t,i){if(e){var r=e.parentElement;if(r){var n=r.querySelector("ul");n&&(r.removeChild(n),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",i),e.addEventListener("click",t))}}}},{key:"isExpanded",value:function(e){return void 0!==e.parentElement.getElementsByTagName("li")[0]}},{key:"getId",value:function(e){return e.parentElement.id}},{key:"getIdFromCheckbox",value:function(e){return e.id.replace("checkbox-","")}},{key:"getSwitchElement",value:function(e){return this._treeViewContainer.querySelector('[id="switch-'.concat(e,'"]'))}},{key:"isChecked",value:function(e){return e.checked}},{key:"setCheckbox",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this._treeViewContainer.querySelector('[id="checkbox-'.concat(e,'"]'));r&&(t!==r.checked&&(r.checked=t),i!==r.indeterminate&&(r.indeterminate=i,i&&(r.checked=!1)))}},{key:"setXRayed",value:function(e,t){var i=this._treeViewContainer.querySelector('[id="'.concat(e,'"]'));i&&(t?i.classList.add("xrayed-node"):i.classList.remove("xrayed-node"))}},{key:"setHighlighted",value:function(e,t){var i=this._treeViewContainer.querySelector('[id="'.concat(e,'"]'));i&&(t?(i.scrollIntoView({block:"center"}),i.classList.add("highlighted-node")):i.classList.remove("highlighted-node"))}}]),e}(),uT=[],AT=function(e){m(i,vh);var t=y(i);function i(e){var r,n,s,o,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i),(a=t.call(this,"TreeViewPlugin",e)).errors=[],a.valid=!0;var u=l.containerElement||document.getElementById(l.containerElementId);if(!(u instanceof HTMLElement))return a.error("Mandatory config expected: valid containerElementId or containerElement"),b(a);for(var A=0;;A++)if(!uT[A]){uT[A]=w(a),a._index=A,a._id="tree-".concat(A);break}if(a._containerElement=u,a._metaModels={},a._autoAddModels=!1!==l.autoAddModels,a._autoExpandDepth=l.autoExpandDepth||0,a._sortNodes=!1!==l.sortNodes,a._viewer=e,a._rootElement=null,a._muteSceneEvents=!1,a._muteTreeEvents=!1,a._rootNodes=[],a._objectNodes={},a._nodeNodes={},a._rootNames={},a._sortNodes=l.sortNodes,a._pruneEmptyNodes=l.pruneEmptyNodes,a._showListItemElementId=null,a._renderService=l.renderService||new lT(a._containerElement),a._showIndeterminate=null!==(r=l.showIndeterminate)&&void 0!==r&&r,a._showProjectNode=null!==(n=l.showProjectNode)&&void 0!==n&&n,a._elevationSortFunction=null!==(s=l.elevationSortFunction)&&void 0!==s?s:void 0,a._defaultSortFunction=null!==(o=l.defaultSortFunction)&&void 0!==o?o:void 0,!a._renderService)throw new Error("TreeViewPlugin: no render service set");if(a._containerElement.oncontextmenu=function(e){e.preventDefault()},a._onObjectVisibility=a._viewer.scene.on("objectVisibility",(function(e){if(!a._muteSceneEvents){var t=e.id,i=a._objectNodes[t];if(i){var r=e.visible;if(r!==i.checked){a._muteTreeEvents=!0,i.checked=r,r?i.numVisibleEntities++:i.numVisibleEntities--,a._renderService.setCheckbox(i.nodeId,r);for(var n=i.parent;n;){n.checked=r,r?n.numVisibleEntities++:n.numVisibleEntities--;var s=a._showIndeterminate&&n.numVisibleEntities>0&&n.numVisibleEntities<n.numEntities;n.checked=n.numVisibleEntities>0,a._renderService.setCheckbox(n.nodeId,n.checked,s),n=n.parent}a._muteTreeEvents=!1}}}})),a._onObjectXrayed=a._viewer.scene.on("objectXRayed",(function(e){if(!a._muteSceneEvents){var t=e.id,i=a._objectNodes[t];if(i){a._muteTreeEvents=!0;var r=e.xrayed;r!==i.xrayed&&(i.xrayed=r,a._renderService.setXRayed(i.nodeId,r),a._muteTreeEvents=!1)}}})),a._switchExpandHandler=function(e){e.preventDefault(),e.stopPropagation();var t=e.target;a._expandSwitchElement(t)},a._switchCollapseHandler=function(e){e.preventDefault(),e.stopPropagation();var t=e.target;a._collapseSwitchElement(t)},a._checkboxChangeHandler=function(e){if(!a._muteTreeEvents){a._muteSceneEvents=!0;var t=e.target,i=a._renderService.isChecked(t),r=a._renderService.getIdFromCheckbox(t),n=a._nodeNodes[r],s=a._viewer.scene.objects,o=0;a._withNodeTree(n,(function(e){var t=e.objectId,r=s[t],n=0===e.children.length;e.numVisibleEntities=i?e.numEntities:0,n&&i!==e.checked&&o++,e.checked=i,a._renderService.setCheckbox(e.nodeId,i),r&&(r.visible=i)}));for(var l=n.parent;l;){i?l.numVisibleEntities+=o:l.numVisibleEntities-=o;var u=a._showIndeterminate&&l.numVisibleEntities>0&&l.numVisibleEntities<l.numEntities;l.checked=l.numVisibleEntities>0,a._renderService.setCheckbox(l.nodeId,l.checked,u),l=l.parent}a._muteSceneEvents=!1}},a._hierarchy=l.hierarchy||"containment",a._autoExpandDepth=l.autoExpandDepth||0,a._autoAddModels){for(var c=Object.keys(a.viewer.metaScene.metaModels),h=0,d=c.length;h<d;h++){var p=c[h],f=a.viewer.metaScene.metaModels[p];f.finalized&&a.addModel(p)}a.viewer.scene.on("modelLoaded",(function(e){a.viewer.metaScene.metaModels[e]&&a.addModel(e)}))}return a.hierarchy=l.hierarchy,a}return I(i,[{key:"hierarchy",get:function(){return this._hierarchy},set:function(e){"containment"!==(e=e||"containment")&&"storeys"!==e&&"types"!==e&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}},{key:"addModel",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._containerElement){var r=this.viewer.scene.models[e];if(!r)throw"Model not found: "+e;var n=this.viewer.metaScene.metaModels[e];n?this._metaModels[e]?this.warn("Model already added: "+e):(this._metaModels[e]=n,i&&i.rootName&&(this._rootNames[e]=i.rootName),r.on("destroyed",(function(){t.removeModel(r.id)})),this._createNodes()):this.error("MetaModel not found: "+e)}}},{key:"removeModel",value:function(e){this._containerElement&&(this._metaModels[e]&&(this._rootNames[e]&&delete this._rootNames[e],delete this._metaModels[e],this._createNodes()))}},{key:"showNode",value:function(e){this.unShowNode();var t=this._objectNodes[e];if(t){this.collapse();var i=t.nodeId,r=this._renderService.getSwitchElement(i);if(r)return this._expandSwitchElement(r),r.scrollIntoView(),!0;var n=[];n.unshift(t);for(var s=t.parent;s;)n.unshift(s),s=s.parent;for(var o=0,a=n.length;o<a;o++){var l=this._renderService.getSwitchElement(n[o].nodeId);l&&this._expandSwitchElement(l)}this._renderService.setHighlighted(i,!0),this._showListItemElementId=i}}},{key:"unShowNode",value:function(){this._showListItemElementId&&(this._renderService.setHighlighted(this._showListItemElementId,!1),this._showListItemElementId=null)}},{key:"expandToDepth",value:function(e){var t=this;this.collapse();for(var i=function i(r,n){if(n!==e){var s=t._renderService.getSwitchElement(r.nodeId);if(s){t._expandSwitchElement(s);for(var o=r.children,a=0,l=o.length;a<l;a++){i(o[a],n+1)}}}},r=0,n=this._rootNodes.length;r<n;r++){i(this._rootNodes[r],0)}}},{key:"collapse",value:function(){for(var e=0,t=this._rootNodes.length;e<t;e++){var i=this._rootNodes[e].nodeId;this._collapseNode(i)}}},{key:"withNodeTree",value:function(e,t){t(e);var i=e.children;if(i)for(var r=0,n=i.length;r<n;r++)this.withNodeTree(i[r],t)}},{key:"destroy",value:function(){this._containerElement&&(this._metaModels={},this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0),delete uT[this._index],v(x(i.prototype),"destroy",this).call(this))}},{key:"_createNodes",value:function(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._validate(),this.valid||"storeys"!==this._hierarchy?this._createEnabledNodes():this._createDisabledNodes()}},{key:"_validate",value:function(){if(this.errors=[],"storeys"===this._hierarchy)this.valid=this._validateMetaModelForStoreysHierarchy();else this.valid=this._rootNodes.length>0;return this.valid}},{key:"_validateMetaModelForStoreysHierarchy",value:function(){return!0}},{key:"_createEnabledNodes",value:function(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this.error("Failed to build storeys hierarchy");break;case"types":this._createTypesNodes();break;default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}},{key:"_createDisabledNodes",value:function(){var e=this._renderService.createRootNode();this._rootElement=e,this._containerElement.appendChild(e);var t=this._viewer.metaScene.rootMetaObjects;for(var i in t){var r=t[i],n=r.type,s=r.name,o=s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:n,a=this._renderService.createDisabledNodeElement(o);e.appendChild(a)}}},{key:"_findEmptyNodes",value:function(){var e=this._viewer.metaScene.rootMetaObjects;for(var t in e)this._findEmptyNodes2(e[t])}},{key:"_findEmptyNodes2",value:function(e){var t=this.viewer,i=t.scene,r=e.children,n=e.id,s=i.objects[n];if(e._countEntities=0,s&&e._countEntities++,r)for(var o=0,a=r.length;o<a;o++){var l=r[o];l._countEntities=this._findEmptyNodes2(l),e._countEntities+=l._countEntities}return e._countEntities}},{key:"_createStoreysNodes",value:function(){var e=this._viewer.metaScene.rootMetaObjects;for(var t in e)this._createStoreysNodes2(e[t],null,null,null,null)}},{key:"_createStoreysNodes2",value:function(e,t,i,r,n){if(!this._pruneEmptyNodes||0!==e._countEntities){var s=e.type,o=e.name,a=e.children,l=e.id;if(this._showProjectNode&&"IfcProject"===s)t={nodeId:"".concat(this._id,"-").concat(l),objectId:l,title:0===e.metaModels.length?o:this._rootNames[e.metaModels[0].id]||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t;else if("IfcBuilding"===s)i={nodeId:"".concat(this._id,"-").concat(l),objectId:l,title:0===e.metaModels.length?o:this._rootNames[e.metaModels[0].id]||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s),type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t?t.children.push(i):this._rootNodes.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i;else if("IfcBuildingStorey"===s){if(!i)return void this.error("Failed to build storeys hierarchy for model - model does not have an IfcBuilding object, or is not an IFC model");r={nodeId:"".concat(this._id,"-").concat(l),objectId:l,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s,type:s,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(r),this._objectNodes[r.objectId]=r,this._nodeNodes[r.nodeId]=r,n={}}else{if(r)if(this._viewer.scene.objects[l]){var u=(n=n||{})[s];u||(u={nodeId:"".concat(this._id,"-").concat(r.objectId,"-").concat(s),objectId:"".concat(r.objectId,"-").concat(s),title:s,type:s,parent:r,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},r.children.push(u),this._objectNodes[u.objectId]=u,this._nodeNodes[u.nodeId]=u,n[s]=u);var A={nodeId:"".concat(this._id,"-").concat(l),objectId:l,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s,type:s,parent:u,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};u.children.push(A),this._objectNodes[A.objectId]=A,this._nodeNodes[A.nodeId]=A}}if(a)for(var c=0,h=a.length;c<h;c++){var d=a[c];this._createStoreysNodes2(d,t,i,r,n)}}}},{key:"_createTypesNodes",value:function(){var e=this._viewer.metaScene.rootMetaObjects;for(var t in e)this._createTypesNodes2(e[t],null,null)}},{key:"_createTypesNodes2",value:function(e,t,i){if(!this._pruneEmptyNodes||0!==e._countEntities){var r=e.type,n=e.name,s=e.children,o=e.id;if(e.parent){if(t)if(this._viewer.scene.objects[o]){var a=i[r];a||(a={nodeId:"".concat(this._id,"-").concat(t.objectId,"-").concat(r),objectId:"".concat(t.objectId,"-").concat(r),title:r,type:r,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(a),this._objectNodes[a.objectId]=a,this._nodeNodes[a.nodeId]=a,i[r]=a);var l={nodeId:"".concat(this._id,"-").concat(o),objectId:o,title:n&&""!==n&&"Default"!==n?n:r,type:r,parent:a,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};a.children.push(l),this._objectNodes[l.objectId]=l,this._nodeNodes[l.nodeId]=l}}else t={nodeId:"".concat(this._id,"-").concat(o),objectId:o,title:0===e.metaModels.length?n:this._rootNames[e.metaModels[0].id]||(n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:r),type:r,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t,i={};if(s)for(var u=0,A=s.length;u<A;u++){var c=s[u];this._createTypesNodes2(c,t,i)}}}},{key:"_createContainmentNodes",value:function(){var e=this._viewer.metaScene.rootMetaObjects;for(var t in e)this._createContainmentNodes2(e[t],null)}},{key:"_createContainmentNodes2",value:function(e,t){if(!this._pruneEmptyNodes||0!==e._countEntities){var i=e.type,r=e.name||i,n=e.children,s=e.id,o={nodeId:"".concat(this._id,"-").concat(s),objectId:s,title:t?r&&""!==r&&"Undefined"!==r&&"Default"!==r?r:i:0===e.metaModels.length?r:this._rootNames[e.metaModels[0].id]||r,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};if(t?t.children.push(o):this._rootNodes.push(o),this._objectNodes[o.objectId]=o,this._nodeNodes[o.nodeId]=o,n)for(var a=0,l=n.length;a<l;a++){var u=n[a];this._createContainmentNodes2(u,o)}}}},{key:"_doSortNodes",value:function(){for(var e=0,t=this._rootNodes.length;e<t;e++){var i=this._rootNodes[e];this._sortChildren(i)}}},{key:"_sortChildren",value:function(e){var t=e.children;if(t&&0!==t.length){var i=t[0];"storeys"!==this._hierarchy&&"containment"!==this._hierarchy||"IfcBuildingStorey"!==i.type?this._defaultSortFunction?t.sort(this._defaultSortFunction):t.sort(this._alphaSortFunc):this._elevationSortFunction?t.sort(this._elevationSortFunction):t.sort(this._getSpatialSortFunc());for(var r=0,n=t.length;r<n;r++){var s=t[r];this._sortChildren(s)}}}},{key:"_getSpatialSortFunc",value:function(){var e=this,t=this.viewer.scene.camera;return this._spatialSortFunc||(this._spatialSortFunc=function(i,r){t.xUp||t.yUp;var n=e.viewer.metaScene,s=n.metaObjects[i.objectId],o=n.metaObjects[r.objectId];if(s&&s.attributes&&void 0!==s.attributes.elevation&&o&&o.attributes&&void 0!==o.attributes.elevation){var a=Number.parseFloat(s.attributes.elevation),l=Number.parseFloat(o.attributes.elevation);return a>l?-1:a<l?1:0}return 0})}},{key:"_alphaSortFunc",value:function(e,t){var i=e.title.toUpperCase(),r=t.title.toUpperCase();return i<r?-1:i>r?1:0}},{key:"_synchNodesToEntities",value:function(){for(var e=Object.keys(this.viewer.metaScene.metaObjects),t=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects,r=0,n=e.length;r<n;r++){var s=e[r];if(t[s]){var o=this._objectNodes[s];if(o){var a=i[s];if(a){var l=a.visible;o.numEntities=1,o.xrayed=a.xrayed,l?(o.numVisibleEntities=1,o.checked=!0):(o.numVisibleEntities=0,o.checked=!1);for(var u=o.parent;u;)u.numEntities++,l&&(u.numVisibleEntities++,u.checked=!0),u=u.parent}}}}}},{key:"_withNodeTree",value:function(e,t){t(e);var i=e.children;if(i)for(var r=0,n=i.length;r<n;r++)this._withNodeTree(i[r],t)}},{key:"_createTrees",value:function(){var e=this;if(0!==this._rootNodes.length){var t=this._rootNodes.map((function(t){return e._createNodeElement(t)})),i=this._renderService.createRootNode();t.forEach((function(e){i.appendChild(e)})),this._containerElement.appendChild(i),this._rootElement=i}}},{key:"_createNodeElement",value:function(e){var t=this;return this._renderService.createNodeElement(e,this._switchExpandHandler,this._checkboxChangeHandler,(function(i){t.fire("contextmenu",{event:i,viewer:t._viewer,treeViewPlugin:t,treeViewNode:e}),i.preventDefault()}),(function(i){t.fire("nodeTitleClicked",{event:i,viewer:t._viewer,treeViewPlugin:t,treeViewNode:e}),i.preventDefault()}))}},{key:"_expandSwitchElement",value:function(e){var t=this;if(!this._renderService.isExpanded(e)){var i=this._renderService.getId(e),r=this._nodeNodes[i].children.map((function(e){return t._createNodeElement(e)}));this._renderService.addChildren(e,r),this._renderService.expand(e,this._switchExpandHandler,this._switchCollapseHandler)}}},{key:"_collapseNode",value:function(e){var t=this._renderService.getSwitchElement(e);this._collapseSwitchElement(t)}},{key:"_collapseSwitchElement",value:function(e){this._renderService.collapse(e,this._switchExpandHandler,this._switchCollapseHandler)}}]),i}(),cT=function(){function e(t){var i=this;k(this,e),this._scene=t,this._objects=[],this._objectsViewCulled=[],this._objectsDetailCulled=[],this._objectsChanged=[],this._objectsChangedList=[],this._modelInfos={},this._numObjects=0,this._lenObjectsChangedList=0,this._dirty=!0,this._onModelLoaded=t.on("modelLoaded",(function(e){var r=t.models[e];r&&i._addModel(r)})),this._onTick=t.on("tick",(function(){i._dirty&&i._build(),i._applyChanges()}))}return I(e,[{key:"_addModel",value:function(e){var t=this,i={model:e,onDestroyed:e.on("destroyed",(function(){t._removeModel(e)}))};this._modelInfos[e.id]=i,this._dirty=!0}},{key:"_removeModel",value:function(e){var t=this._modelInfos[e.id];t&&(t.model.off(t.onDestroyed),delete this._modelInfos[e.id],this._dirty=!0)}},{key:"_build",value:function(){if(this._dirty){this._applyChanges();for(var e=this._scene.objects,t=0;t<this._numObjects;t++)this._objects[t]=null;for(var i in this._numObjects=0,e){var r=e[i];this._objects[this._numObjects++]=r}this._lenObjectsChangedList=0,this._dirty=!1}}},{key:"_applyChanges",value:function(){if(this._lenObjectsChangedList>0){for(var e=0;e<this._lenObjectsChangedList;e++){var t=this._objectsChangedList[e],i=this._objects[t],r=this._objectsViewCulled[t],n=this._objectsDetailCulled[t],s=r||n;i.culled=s,this._objectsChanged[t]=!1}this._lenObjectsChangedList=0}}},{key:"objects",get:function(){return this._dirty&&this._build(),this._objects}},{key:"numObjects",get:function(){return this._dirty&&this._build(),this._numObjects}},{key:"setObjectViewCulled",value:function(e,t){this._dirty&&this._build(),this._objectsViewCulled[e]!==t&&(this._objectsViewCulled[e]=t,this._objectsChanged[e]||(this._objectsChanged[e]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=e))}},{key:"setObjectDetailCulled",value:function(e,t){this._dirty&&this._build(),this._objectsDetailCulled[e]!==t&&(this._objectsDetailCulled[e]=t,this._objectsChanged[e]||(this._objectsChanged[e]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=e))}},{key:"_destroy",value:function(){this._clear(),this._scene.off(this._onModelLoaded),this._scene.off(this._onTick)}},{key:"_clear",value:function(){for(var e in this._modelInfos){var t=this._modelInfos[e];t.model.off(t.onDestroyed)}this._modelInfos={},this._dirty=!0}}]),e}(),hT={};function dT(e){var t=e.id,i=hT[t];return i||(i=new cT(e),hT[t]=i,e.on("destroyed",(function(){delete hT[t],i._destroy()}))),i}var pT=new Float32Array(3),fT=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"ViewCull",e))._objectCullStates=dT(e.scene),r._maxTreeDepth=n.maxTreeDepth||8,r._modelInfos={},r._frustum=new Ue,r._kdRoot=null,r._frustumDirty=!1,r._kdTreeDirty=!1,r._onViewMatrix=e.scene.camera.on("viewMatrix",(function(){r._frustumDirty=!0})),r._onProjMatrix=e.scene.camera.on("projMatMatrix",(function(){r._frustumDirty=!0})),r._onModelLoaded=e.scene.on("modelLoaded",(function(e){var t=r.viewer.scene.models[e];t&&r._addModel(t)})),r._onSceneTick=e.scene.on("tick",(function(){r._doCull()})),r}return I(i,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"_addModel",value:function(e){var t=this,i={model:e,onDestroyed:e.on("destroyed",(function(){t._removeModel(e)}))};this._modelInfos[e.id]=i,this._kdTreeDirty=!0}},{key:"_removeModel",value:function(e){var t=this._modelInfos[e.id];t&&(t.model.off(t.onDestroyed),delete this._modelInfos[e.id],this._kdTreeDirty=!0)}},{key:"_doCull",value:function(){var e=this._frustumDirty||this._kdTreeDirty;if(this._frustumDirty&&this._buildFrustum(),this._kdTreeDirty&&this._buildKDTree(),e){var t=this._kdRoot;t&&this._visitKDNode(t)}}},{key:"_buildFrustum",value:function(){var e=this.viewer.scene.camera;Le(this._frustum,e.viewMatrix,e.projMatrix),this._frustumDirty=!1}},{key:"_buildKDTree",value:function(){var e=this.viewer.scene;this._kdRoot,this._kdRoot={aabb:e.getAABB(),intersection:Ue.INTERSECT};for(var t=0,i=this._objectCullStates.numObjects;t<i;t++){var r=this._objectCullStates.objects[t];this._insertEntityIntoKDTree(this._kdRoot,r,t,1)}this._kdTreeDirty=!1}},{key:"_insertEntityIntoKDTree",value:function(e,t,i,r){var n=t.aabb;if(r>=this._maxTreeDepth)return e.objects=e.objects||[],e.objects.push(i),void le.expandAABB3(e.aabb,n);if(e.left&&le.containsAABB3(e.left.aabb,n))this._insertEntityIntoKDTree(e.left,t,i,r+1);else if(e.right&&le.containsAABB3(e.right.aabb,n))this._insertEntityIntoKDTree(e.right,t,i,r+1);else{var s=e.aabb;pT[0]=s[3]-s[0],pT[1]=s[4]-s[1],pT[2]=s[5]-s[2];var o=0;if(pT[1]>pT[o]&&(o=1),pT[2]>pT[o]&&(o=2),!e.left){var a=s.slice();if(a[o+3]=(s[o]+s[o+3])/2,e.left={aabb:a,intersection:Ue.INTERSECT},le.containsAABB3(a,n))return void this._insertEntityIntoKDTree(e.left,t,i,r+1)}if(!e.right){var l=s.slice();if(l[o]=(s[o]+s[o+3])/2,e.right={aabb:l,intersection:Ue.INTERSECT},le.containsAABB3(l,n))return void this._insertEntityIntoKDTree(e.right,t,i,r+1)}e.objects=e.objects||[],e.objects.push(i),le.expandAABB3(e.aabb,n)}}},{key:"_visitKDNode",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ue.INTERSECT;if(t===Ue.INTERSECT||e.intersects!==t){t===Ue.INTERSECT&&(t=Oe(this._frustum,e.aabb),e.intersects=t);var i=t===Ue.OUTSIDE,r=e.objects;if(r&&r.length>0)for(var n=0,s=r.length;n<s;n++){var o=r[n];this._objectCullStates.setObjectViewCulled(o,i)}e.left&&this._visitKDNode(e.left,t),e.right&&this._visitKDNode(e.right,t)}}},{key:"send",value:function(e,t){}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this),this._clear();var e=this.viewer.scene,t=e.camera;e.off(this._onModelLoaded),e.off(this._onSceneTick),t.off(this._onViewMatrix),t.off(this._onProjMatrix)}},{key:"_clear",value:function(){for(var e in this._modelInfos){var t=this._modelInfos[e];t.model.off(t.onDestroyed)}this._modelInfos={},this._kdRoot=null,this._kdTreeDirty=!0}}]),i}(),vT=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getManifest",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}},{key:"getMetaModel",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}},{key:"getXKT",value:function(e,t,i){var r=function(){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var s=!!n[2],o=n[3];o=window.decodeURIComponent(o),s&&(o=window.atob(o));try{for(var a=new ArrayBuffer(o.length),l=new Uint8Array(a),u=0;u<o.length;u++)l[u]=o.charCodeAt(u);t(a)}catch(e){i(e)}}else{var A=new XMLHttpRequest;A.open("GET",this._cacheBusterURL(e),!0),A.responseType="arraybuffer",A.onreadystatechange=function(){4===A.readyState&&(200===A.status?t(A.response):i("getXKT error : "+A.response))},A.send(null)}}}]),e}();!function(e,t){"object"==("undefined"==typeof exports?"undefined":P(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pako={})}(void 0,(function(e){function t(e){for(var t=e.length;--t>=0;)e[t]=0}var i=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),r=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),n=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),s=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),o=new Array(576);t(o);var a=new Array(60);t(a);var l=new Array(512);t(l);var u=new Array(256);t(u);var A=new Array(29);t(A);var c,h,d,p=new Array(30);function f(e,t,i,r,n){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=r,this.max_length=n,this.has_stree=e&&e.length}function v(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}t(p);var g=function(e){return e<256?l[e]:l[256+(e>>>7)]},m=function(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},_=function(e,t,i){e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,m(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},y=function(e,t,i){_(e,i[2*t],i[2*t+1])},b=function(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1},w=function(e,t,i){var r,n,s=new Array(16),o=0;for(r=1;r<=15;r++)o=o+i[r-1]<<1,s[r]=o;for(n=0;n<=t;n++){var a=e[2*n+1];0!==a&&(e[2*n]=b(s[a]++,a))}},B=function(e){var t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},x=function(e){e.bi_valid>8?m(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},C=function(e,t,i,r){var n=2*t,s=2*i;return e[n]<e[s]||e[n]===e[s]&&r[t]<=r[i]},M=function(e,t,i){for(var r=e.heap[i],n=i<<1;n<=e.heap_len&&(n<e.heap_len&&C(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!C(t,r,e.heap[n],e.depth));)e.heap[i]=e.heap[n],i=n,n<<=1;e.heap[i]=r},F=function(e,t,n){var s,o,a,l,c=0;if(0!==e.sym_next)do{s=255&e.pending_buf[e.sym_buf+c++],s+=(255&e.pending_buf[e.sym_buf+c++])<<8,o=e.pending_buf[e.sym_buf+c++],0===s?y(e,o,t):(a=u[o],y(e,a+256+1,t),0!==(l=i[a])&&(o-=A[a],_(e,o,l)),s--,a=g(s),y(e,a,n),0!==(l=r[a])&&(s-=p[a],_(e,s,l)))}while(c<e.sym_next);y(e,256,t)},k=function(e,t){var i,r,n,s=t.dyn_tree,o=t.stat_desc.static_tree,a=t.stat_desc.has_stree,l=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=573,i=0;i<l;i++)0!==s[2*i]?(e.heap[++e.heap_len]=u=i,e.depth[i]=0):s[2*i+1]=0;for(;e.heap_len<2;)s[2*(n=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[n]=0,e.opt_len--,a&&(e.static_len-=o[2*n+1]);for(t.max_code=u,i=e.heap_len>>1;i>=1;i--)M(e,s,i);n=l;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],M(e,s,1),r=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=r,s[2*n]=s[2*i]+s[2*r],e.depth[n]=(e.depth[i]>=e.depth[r]?e.depth[i]:e.depth[r])+1,s[2*i+1]=s[2*r+1]=n,e.heap[1]=n++,M(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,r,n,s,o,a,l=t.dyn_tree,u=t.max_code,A=t.stat_desc.static_tree,c=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,d=t.stat_desc.extra_base,p=t.stat_desc.max_length,f=0;for(s=0;s<=15;s++)e.bl_count[s]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<573;i++)(s=l[2*l[2*(r=e.heap[i])+1]+1]+1)>p&&(s=p,f++),l[2*r+1]=s,r>u||(e.bl_count[s]++,o=0,r>=d&&(o=h[r-d]),a=l[2*r],e.opt_len+=a*(s+o),c&&(e.static_len+=a*(A[2*r+1]+o)));if(0!==f){do{for(s=p-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[p]--,f-=2}while(f>0);for(s=p;0!==s;s--)for(r=e.bl_count[s];0!==r;)(n=e.heap[--i])>u||(l[2*n+1]!==s&&(e.opt_len+=(s-l[2*n+1])*l[2*n],l[2*n+1]=s),r--)}}(e,t),w(s,u,e.bl_count)},E=function(e,t,i){var r,n,s=-1,o=t[1],a=0,l=7,u=4;for(0===o&&(l=138,u=3),t[2*(i+1)+1]=65535,r=0;r<=i;r++)n=o,o=t[2*(r+1)+1],++a<l&&n===o||(a<u?e.bl_tree[2*n]+=a:0!==n?(n!==s&&e.bl_tree[2*n]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,s=n,0===o?(l=138,u=3):n===o?(l=6,u=3):(l=7,u=4))},I=function(e,t,i){var r,n,s=-1,o=t[1],a=0,l=7,u=4;for(0===o&&(l=138,u=3),r=0;r<=i;r++)if(n=o,o=t[2*(r+1)+1],!(++a<l&&n===o)){if(a<u)do{y(e,n,e.bl_tree)}while(0!=--a);else 0!==n?(n!==s&&(y(e,n,e.bl_tree),a--),y(e,16,e.bl_tree),_(e,a-3,2)):a<=10?(y(e,17,e.bl_tree),_(e,a-3,3)):(y(e,18,e.bl_tree),_(e,a-11,7));a=0,s=n,0===o?(l=138,u=3):n===o?(l=6,u=3):(l=7,u=4)}},T=!1,D=function(e,t,i,r){_(e,0+(r?1:0),3),x(e),m(e,i),m(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i},S=function(e){T||(function(){var e,t,s,v,g,m=new Array(16);for(s=0,v=0;v<28;v++)for(A[v]=s,e=0;e<1<<i[v];e++)u[s++]=v;for(u[s-1]=v,g=0,v=0;v<16;v++)for(p[v]=g,e=0;e<1<<r[v];e++)l[g++]=v;for(g>>=7;v<30;v++)for(p[v]=g<<7,e=0;e<1<<r[v]-7;e++)l[256+g++]=v;for(t=0;t<=15;t++)m[t]=0;for(e=0;e<=143;)o[2*e+1]=8,e++,m[8]++;for(;e<=255;)o[2*e+1]=9,e++,m[9]++;for(;e<=279;)o[2*e+1]=7,e++,m[7]++;for(;e<=287;)o[2*e+1]=8,e++,m[8]++;for(w(o,287,m),e=0;e<30;e++)a[2*e+1]=5,a[2*e]=b(e,5);c=new f(o,i,257,286,15),h=new f(a,r,0,30,15),d=new f(new Array(0),n,0,19,7)}(),T=!0),e.l_desc=new v(e.dyn_ltree,c),e.d_desc=new v(e.dyn_dtree,h),e.bl_desc=new v(e.bl_tree,d),e.bi_buf=0,e.bi_valid=0,B(e)},R=D,U=function(e,t,i,r){var n,l,u=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),k(e,e.l_desc),k(e,e.d_desc),u=function(e){var t;for(E(e,e.dyn_ltree,e.l_desc.max_code),E(e,e.dyn_dtree,e.d_desc.max_code),k(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*s[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),n=e.opt_len+3+7>>>3,(l=e.static_len+3+7>>>3)<=n&&(n=l)):n=l=i+5,i+4<=n&&-1!==t?D(e,t,i,r):4===e.strategy||l===n?(_(e,2+(r?1:0),3),F(e,o,a)):(_(e,4+(r?1:0),3),function(e,t,i,r){var n;for(_(e,t-257,5),_(e,i-1,5),_(e,r-4,4),n=0;n<r;n++)_(e,e.bl_tree[2*s[n]+1],3);I(e,e.dyn_ltree,t-1),I(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,u+1),F(e,e.dyn_ltree,e.dyn_dtree)),B(e),r&&x(e)},L=function(e,t,i){return e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(u[i]+256+1)]++,e.dyn_dtree[2*g(t)]++),e.sym_next===e.sym_end},O=function(e){_(e,2,3),y(e,256,o),function(e){16===e.bi_valid?(m(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)},N=function(e,t,i,r){for(var n=65535&e|0,s=e>>>16&65535|0,o=0;0!==i;){i-=o=i>2e3?2e3:i;do{s=s+(n=n+t[r++]|0)|0}while(--o);n%=65521,s%=65521}return n|s<<16|0},V=new Uint32Array(function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}()),Q=function(e,t,i,r){var n=V,s=r+i;e^=-1;for(var o=r;o<s;o++)e=e>>>8^n[255&(e^t[o])];return-1^e},H={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},G={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},j=S,z=R,W=U,X=L,K=O,Z=G.Z_NO_FLUSH,J=G.Z_PARTIAL_FLUSH,Y=G.Z_FULL_FLUSH,q=G.Z_FINISH,$=G.Z_BLOCK,ee=G.Z_OK,te=G.Z_STREAM_END,ie=G.Z_STREAM_ERROR,re=G.Z_DATA_ERROR,ne=G.Z_BUF_ERROR,se=G.Z_DEFAULT_COMPRESSION,oe=G.Z_FILTERED,ae=G.Z_HUFFMAN_ONLY,le=G.Z_RLE,ue=G.Z_FIXED,Ae=G.Z_UNKNOWN,ce=G.Z_DEFLATED,he=258,de=262,pe=42,fe=113,ve=666,ge=function(e,t){return e.msg=H[t],t},me=function(e){return 2*e-(e>4?9:0)},_e=function(e){for(var t=e.length;--t>=0;)e[t]=0},ye=function(e){var t,i,r,n=e.w_size;r=t=e.hash_size;do{i=e.head[--r],e.head[r]=i>=n?i-n:0}while(--t);r=t=n;do{i=e.prev[--r],e.prev[r]=i>=n?i-n:0}while(--t)},be=function(e,t,i){return(t<<e.hash_shift^i)&e.hash_mask},we=function(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))},Be=function(e,t){W(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,we(e.strm)},xe=function(e,t){e.pending_buf[e.pending++]=t},Pe=function(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Ce=function(e,t,i,r){var n=e.avail_in;return n>r&&(n=r),0===n?0:(e.avail_in-=n,t.set(e.input.subarray(e.next_in,e.next_in+n),i),1===e.state.wrap?e.adler=N(e.adler,t,n,i):2===e.state.wrap&&(e.adler=Q(e.adler,t,n,i)),e.next_in+=n,e.total_in+=n,n)},Me=function(e,t){var i,r,n=e.max_chain_length,s=e.strstart,o=e.prev_length,a=e.nice_match,l=e.strstart>e.w_size-de?e.strstart-(e.w_size-de):0,u=e.window,A=e.w_mask,c=e.prev,h=e.strstart+he,d=u[s+o-1],p=u[s+o];e.prev_length>=e.good_match&&(n>>=2),a>e.lookahead&&(a=e.lookahead);do{if(u[(i=t)+o]===p&&u[i+o-1]===d&&u[i]===u[s]&&u[++i]===u[s+1]){s+=2,i++;do{}while(u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&u[++s]===u[++i]&&s<h);if(r=he-(h-s),s=h-he,r>o){if(e.match_start=t,o=r,r>=a)break;d=u[s+o-1],p=u[s+o]}}}while((t=c[t&A])>l&&0!=--n);return o<=e.lookahead?o:e.lookahead},Fe=function(e){var t,i,r,n=e.w_size;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=n+(n-de)&&(e.window.set(e.window.subarray(n,n+n-i),0),e.match_start-=n,e.strstart-=n,e.block_start-=n,e.insert>e.strstart&&(e.insert=e.strstart),ye(e),i+=n),0===e.strm.avail_in)break;if(t=Ce(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=t,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=be(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=be(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<de&&0!==e.strm.avail_in)},ke=function(e,t){var i,r,n,s=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(i=65535,n=e.bi_valid+42>>3,e.strm.avail_out<n)break;if(n=e.strm.avail_out-n,i>(r=e.strstart-e.block_start)+e.strm.avail_in&&(i=r+e.strm.avail_in),i>n&&(i=n),i<s&&(0===i&&t!==q||t===Z||i!==r+e.strm.avail_in))break;o=t===q&&i===r+e.strm.avail_in?1:0,z(e,0,0,o),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,we(e.strm),r&&(r>i&&(r=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+r),e.strm.next_out),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r,e.block_start+=r,i-=r),i&&(Ce(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(0===o);return(a-=e.strm.avail_in)&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==Z&&t!==q&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(n=e.window_size-e.strstart,e.strm.avail_in>n&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,n+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),n>e.strm.avail_in&&(n=e.strm.avail_in),n&&(Ce(e.strm,e.window,e.strstart,n),e.strstart+=n,e.insert+=n>e.w_size-e.insert?e.w_size-e.insert:n),e.high_water<e.strstart&&(e.high_water=e.strstart),n=e.bi_valid+42>>3,s=(n=e.pending_buf_size-n>65535?65535:e.pending_buf_size-n)>e.w_size?e.w_size:n,((r=e.strstart-e.block_start)>=s||(r||t===q)&&t!==Z&&0===e.strm.avail_in&&r<=n)&&(i=r>n?n:r,o=t===q&&0===e.strm.avail_in&&i===r?1:0,z(e,e.block_start,i,o),e.block_start+=i,we(e.strm)),o?3:1)},Ee=function(e,t){for(var i,r;;){if(e.lookahead<de){if(Fe(e),e.lookahead<de&&t===Z)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-de&&(e.match_length=Me(e,i)),e.match_length>=3)if(r=X(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=be(e,e.ins_h,e.window[e.strstart+1]);else r=X(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(Be(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===q?(Be(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Be(e,!1),0===e.strm.avail_out)?1:2},Ie=function(e,t){for(var i,r,n;;){if(e.lookahead<de){if(Fe(e),e.lookahead<de&&t===Z)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-de&&(e.match_length=Me(e,i),e.match_length<=5&&(e.strategy===oe||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-3,r=X(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=n&&(e.ins_h=be(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(Be(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((r=X(e,0,e.window[e.strstart-1]))&&Be(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=X(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===q?(Be(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Be(e,!1),0===e.strm.avail_out)?1:2};function Te(e,t,i,r,n){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=r,this.func=n}var De=[new Te(0,0,0,0,ke),new Te(4,4,8,4,Ee),new Te(4,5,16,8,Ee),new Te(4,6,32,32,Ee),new Te(4,4,16,16,Ie),new Te(8,16,32,32,Ie),new Te(8,16,128,128,Ie),new Te(8,32,128,256,Ie),new Te(32,128,258,1024,Ie),new Te(32,258,258,4096,Ie)];function Se(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ce,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),_e(this.dyn_ltree),_e(this.dyn_dtree),_e(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),_e(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),_e(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}var Re=function(e){if(!e)return 1;var t=e.state;return!t||t.strm!==e||t.status!==pe&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==fe&&t.status!==ve?1:0},Ue=function(e){if(Re(e))return ge(e,ie);e.total_in=e.total_out=0,e.data_type=Ae;var t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?pe:fe,e.adler=2===t.wrap?0:1,t.last_flush=-2,j(t),ee},Le=function(e){var t,i=Ue(e);return i===ee&&((t=e.state).window_size=2*t.w_size,_e(t.head),t.max_lazy_match=De[t.level].max_lazy,t.good_match=De[t.level].good_length,t.nice_match=De[t.level].nice_length,t.max_chain_length=De[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),i},Oe=function(e,t,i,r,n,s){if(!e)return ie;var o=1;if(t===se&&(t=6),r<0?(o=0,r=-r):r>15&&(o=2,r-=16),n<1||n>9||i!==ce||r<8||r>15||t<0||t>9||s<0||s>ue||8===r&&1!==o)return ge(e,ie);8===r&&(r=9);var a=new Se;return e.state=a,a.strm=e,a.status=pe,a.wrap=o,a.gzhead=null,a.w_bits=r,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=n+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<n+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=s,a.method=i,Le(e)},Ne=Oe,Ve=function(e,t){return Re(e)||2!==e.state.wrap?ie:(e.state.gzhead=t,ee)},Qe=function(e,t){if(Re(e)||t>$||t<0)return e?ge(e,ie):ie;var i=e.state;if(!e.output||0!==e.avail_in&&!e.input||i.status===ve&&t!==q)return ge(e,0===e.avail_out?ne:ie);var r=i.last_flush;if(i.last_flush=t,0!==i.pending){if(we(e),0===e.avail_out)return i.last_flush=-1,ee}else if(0===e.avail_in&&me(t)<=me(r)&&t!==q)return ge(e,ne);if(i.status===ve&&0!==e.avail_in)return ge(e,ne);if(i.status===pe&&0===i.wrap&&(i.status=fe),i.status===pe){var n=ce+(i.w_bits-8<<4)<<8;if(n|=(i.strategy>=ae||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(n|=32),Pe(i,n+=31-n%31),0!==i.strstart&&(Pe(i,e.adler>>>16),Pe(i,65535&e.adler)),e.adler=1,i.status=fe,we(e),0!==i.pending)return i.last_flush=-1,ee}if(57===i.status)if(e.adler=0,xe(i,31),xe(i,139),xe(i,8),i.gzhead)xe(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),xe(i,255&i.gzhead.time),xe(i,i.gzhead.time>>8&255),xe(i,i.gzhead.time>>16&255),xe(i,i.gzhead.time>>24&255),xe(i,9===i.level?2:i.strategy>=ae||i.level<2?4:0),xe(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(xe(i,255&i.gzhead.extra.length),xe(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=Q(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(xe(i,0),xe(i,0),xe(i,0),xe(i,0),xe(i,0),xe(i,9===i.level?2:i.strategy>=ae||i.level<2?4:0),xe(i,3),i.status=fe,we(e),0!==i.pending)return i.last_flush=-1,ee;if(69===i.status){if(i.gzhead.extra){for(var s=i.pending,o=(65535&i.gzhead.extra.length)-i.gzindex;i.pending+o>i.pending_buf_size;){var a=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+a),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>s&&(e.adler=Q(e.adler,i.pending_buf,i.pending-s,s)),i.gzindex+=a,we(e),0!==i.pending)return i.last_flush=-1,ee;s=0,o-=a}var l=new Uint8Array(i.gzhead.extra);i.pending_buf.set(l.subarray(i.gzindex,i.gzindex+o),i.pending),i.pending+=o,i.gzhead.hcrc&&i.pending>s&&(e.adler=Q(e.adler,i.pending_buf,i.pending-s,s)),i.gzindex=0}i.status=73}if(73===i.status){if(i.gzhead.name){var u,A=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>A&&(e.adler=Q(e.adler,i.pending_buf,i.pending-A,A)),we(e),0!==i.pending)return i.last_flush=-1,ee;A=0}u=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,xe(i,u)}while(0!==u);i.gzhead.hcrc&&i.pending>A&&(e.adler=Q(e.adler,i.pending_buf,i.pending-A,A)),i.gzindex=0}i.status=91}if(91===i.status){if(i.gzhead.comment){var c,h=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>h&&(e.adler=Q(e.adler,i.pending_buf,i.pending-h,h)),we(e),0!==i.pending)return i.last_flush=-1,ee;h=0}c=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,xe(i,c)}while(0!==c);i.gzhead.hcrc&&i.pending>h&&(e.adler=Q(e.adler,i.pending_buf,i.pending-h,h))}i.status=103}if(103===i.status){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(we(e),0!==i.pending))return i.last_flush=-1,ee;xe(i,255&e.adler),xe(i,e.adler>>8&255),e.adler=0}if(i.status=fe,we(e),0!==i.pending)return i.last_flush=-1,ee}if(0!==e.avail_in||0!==i.lookahead||t!==Z&&i.status!==ve){var d=0===i.level?ke(i,t):i.strategy===ae?function(e,t){for(var i;;){if(0===e.lookahead&&(Fe(e),0===e.lookahead)){if(t===Z)return 1;break}if(e.match_length=0,i=X(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(Be(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===q?(Be(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Be(e,!1),0===e.strm.avail_out)?1:2}(i,t):i.strategy===le?function(e,t){for(var i,r,n,s,o=e.window;;){if(e.lookahead<=he){if(Fe(e),e.lookahead<=he&&t===Z)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&((r=o[n=e.strstart-1])===o[++n]&&r===o[++n]&&r===o[++n])){s=e.strstart+he;do{}while(r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&r===o[++n]&&n<s);e.match_length=he-(s-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=X(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=X(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(Be(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===q?(Be(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Be(e,!1),0===e.strm.avail_out)?1:2}(i,t):De[i.level].func(i,t);if(3!==d&&4!==d||(i.status=ve),1===d||3===d)return 0===e.avail_out&&(i.last_flush=-1),ee;if(2===d&&(t===J?K(i):t!==$&&(z(i,0,0,!1),t===Y&&(_e(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),we(e),0===e.avail_out))return i.last_flush=-1,ee}return t!==q?ee:i.wrap<=0?te:(2===i.wrap?(xe(i,255&e.adler),xe(i,e.adler>>8&255),xe(i,e.adler>>16&255),xe(i,e.adler>>24&255),xe(i,255&e.total_in),xe(i,e.total_in>>8&255),xe(i,e.total_in>>16&255),xe(i,e.total_in>>24&255)):(Pe(i,e.adler>>>16),Pe(i,65535&e.adler)),we(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?ee:te)},He=function(e){if(Re(e))return ie;var t=e.state.status;return e.state=null,t===fe?ge(e,re):ee},Ge=function(e,t){var i=t.length;if(Re(e))return ie;var r=e.state,n=r.wrap;if(2===n||1===n&&r.status!==pe||r.lookahead)return ie;if(1===n&&(e.adler=N(e.adler,t,i,0)),r.wrap=0,i>=r.w_size){0===n&&(_e(r.head),r.strstart=0,r.block_start=0,r.insert=0);var s=new Uint8Array(r.w_size);s.set(t.subarray(i-r.w_size,i),0),t=s,i=r.w_size}var o=e.avail_in,a=e.next_in,l=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,Fe(r);r.lookahead>=3;){var u=r.strstart,A=r.lookahead-2;do{r.ins_h=be(r,r.ins_h,r.window[u+3-1]),r.prev[u&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=u,u++}while(--A);r.strstart=u,r.lookahead=2,Fe(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,e.next_in=a,e.input=l,e.avail_in=o,r.wrap=n,ee},je=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},ze=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=P(i))throw new TypeError(i+"must be non-object");for(var r in i)je(i,r)&&(e[r]=i[r])}}return e},We=function(e){for(var t=0,i=0,r=e.length;i<r;i++)t+=e[i].length;for(var n=new Uint8Array(t),s=0,o=0,a=e.length;s<a;s++){var l=e[s];n.set(l,o),o+=l.length}return n},Xe=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){Xe=!1}for(var Ke=new Uint8Array(256),Ze=0;Ze<256;Ze++)Ke[Ze]=Ze>=252?6:Ze>=248?5:Ze>=240?4:Ze>=224?3:Ze>=192?2:1;Ke[254]=Ke[254]=1;var Je=function(e){if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);var t,i,r,n,s,o=e.length,a=0;for(n=0;n<o;n++)55296==(64512&(i=e.charCodeAt(n)))&&n+1<o&&(56320==(64512&(r=e.charCodeAt(n+1)))&&(i=65536+(i-55296<<10)+(r-56320),n++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(a),s=0,n=0;s<a;n++)55296==(64512&(i=e.charCodeAt(n)))&&n+1<o&&(56320==(64512&(r=e.charCodeAt(n+1)))&&(i=65536+(i-55296<<10)+(r-56320),n++)),i<128?t[s++]=i:i<2048?(t[s++]=192|i>>>6,t[s++]=128|63&i):i<65536?(t[s++]=224|i>>>12,t[s++]=128|i>>>6&63,t[s++]=128|63&i):(t[s++]=240|i>>>18,t[s++]=128|i>>>12&63,t[s++]=128|i>>>6&63,t[s++]=128|63&i);return t},Ye=function(e,t){var i,r,n=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));var s=new Array(2*n);for(r=0,i=0;i<n;){var o=e[i++];if(o<128)s[r++]=o;else{var a=Ke[o];if(a>4)s[r++]=65533,i+=a-1;else{for(o&=2===a?31:3===a?15:7;a>1&&i<n;)o=o<<6|63&e[i++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}}return function(e,t){if(t<65534&&e.subarray&&Xe)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));for(var i="",r=0;r<t;r++)i+=String.fromCharCode(e[r]);return i}(s,r)},qe=function(e,t){(t=t||e.length)>e.length&&(t=e.length);for(var i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Ke[e[i]]>t?i:t},$e=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},et=Object.prototype.toString,tt=G.Z_NO_FLUSH,it=G.Z_SYNC_FLUSH,rt=G.Z_FULL_FLUSH,nt=G.Z_FINISH,st=G.Z_OK,ot=G.Z_STREAM_END,at=G.Z_DEFAULT_COMPRESSION,lt=G.Z_DEFAULT_STRATEGY,ut=G.Z_DEFLATED;function At(e){this.options=ze({level:at,method:ut,chunkSize:16384,windowBits:15,memLevel:8,strategy:lt},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new $e,this.strm.avail_out=0;var i=Ne(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==st)throw new Error(H[i]);if(t.header&&Ve(this.strm,t.header),t.dictionary){var r;if(r="string"==typeof t.dictionary?Je(t.dictionary):"[object ArrayBuffer]"===et.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(i=Ge(this.strm,r))!==st)throw new Error(H[i]);this._dict_set=!0}}function ct(e,t){var i=new At(t);if(i.push(e,!0),i.err)throw i.msg||H[i.err];return i.result}At.prototype.push=function(e,t){var i,r,n=this.strm,s=this.options.chunkSize;if(this.ended)return!1;for(r=t===~~t?t:!0===t?nt:tt,"string"==typeof e?n.input=Je(e):"[object ArrayBuffer]"===et.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(s),n.next_out=0,n.avail_out=s),(r===it||r===rt)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if((i=Qe(n,r))===ot)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=He(this.strm),this.onEnd(i),this.ended=!0,i===st;if(0!==n.avail_out){if(r>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},At.prototype.onData=function(e){this.chunks.push(e)},At.prototype.onEnd=function(e){e===st&&(this.result=We(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ht=At,dt=ct,pt=function(e,t){return(t=t||{}).raw=!0,ct(e,t)},ft=function(e,t){return(t=t||{}).gzip=!0,ct(e,t)},vt=16209,gt=function(e,t){var i,r,n,s,o,a,l,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B,x,P,C=e.state;i=e.next_in,x=e.input,r=i+(e.avail_in-5),n=e.next_out,P=e.output,s=n-(t-e.avail_out),o=n+(e.avail_out-257),a=C.dmax,l=C.wsize,u=C.whave,A=C.wnext,c=C.window,h=C.hold,d=C.bits,p=C.lencode,f=C.distcode,v=(1<<C.lenbits)-1,g=(1<<C.distbits)-1;e:do{d<15&&(h+=x[i++]<<d,d+=8,h+=x[i++]<<d,d+=8),m=p[h&v];t:for(;;){if(h>>>=_=m>>>24,d-=_,0===(_=m>>>16&255))P[n++]=65535&m;else{if(!(16&_)){if(0==(64&_)){m=p[(65535&m)+(h&(1<<_)-1)];continue t}if(32&_){C.mode=16191;break e}e.msg="invalid literal/length code",C.mode=vt;break e}y=65535&m,(_&=15)&&(d<_&&(h+=x[i++]<<d,d+=8),y+=h&(1<<_)-1,h>>>=_,d-=_),d<15&&(h+=x[i++]<<d,d+=8,h+=x[i++]<<d,d+=8),m=f[h&g];i:for(;;){if(h>>>=_=m>>>24,d-=_,!(16&(_=m>>>16&255))){if(0==(64&_)){m=f[(65535&m)+(h&(1<<_)-1)];continue i}e.msg="invalid distance code",C.mode=vt;break e}if(b=65535&m,d<(_&=15)&&(h+=x[i++]<<d,(d+=8)<_&&(h+=x[i++]<<d,d+=8)),(b+=h&(1<<_)-1)>a){e.msg="invalid distance too far back",C.mode=vt;break e}if(h>>>=_,d-=_,b>(_=n-s)){if((_=b-_)>u&&C.sane){e.msg="invalid distance too far back",C.mode=vt;break e}if(w=0,B=c,0===A){if(w+=l-_,_<y){y-=_;do{P[n++]=c[w++]}while(--_);w=n-b,B=P}}else if(A<_){if(w+=l+A-_,(_-=A)<y){y-=_;do{P[n++]=c[w++]}while(--_);if(w=0,A<y){y-=_=A;do{P[n++]=c[w++]}while(--_);w=n-b,B=P}}}else if(w+=A-_,_<y){y-=_;do{P[n++]=c[w++]}while(--_);w=n-b,B=P}for(;y>2;)P[n++]=B[w++],P[n++]=B[w++],P[n++]=B[w++],y-=3;y&&(P[n++]=B[w++],y>1&&(P[n++]=B[w++]))}else{w=n-b;do{P[n++]=P[w++],P[n++]=P[w++],P[n++]=P[w++],y-=3}while(y>2);y&&(P[n++]=P[w++],y>1&&(P[n++]=P[w++]))}break}}break}}while(i<r&&n<o);i-=y=d>>3,h&=(1<<(d-=y<<3))-1,e.next_in=i,e.next_out=n,e.avail_in=i<r?r-i+5:5-(i-r),e.avail_out=n<o?o-n+257:257-(n-o),C.hold=h,C.bits=d},mt=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),_t=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),yt=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),bt=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),wt=function(e,t,i,r,n,s,o,a){var l,u,A,c,h,d,p,f,v,g=a.bits,m=0,_=0,y=0,b=0,w=0,B=0,x=0,P=0,C=0,M=0,F=null,k=new Uint16Array(16),E=new Uint16Array(16),I=null;for(m=0;m<=15;m++)k[m]=0;for(_=0;_<r;_++)k[t[i+_]]++;for(w=g,b=15;b>=1&&0===k[b];b--);if(w>b&&(w=b),0===b)return n[s++]=20971520,n[s++]=20971520,a.bits=1,0;for(y=1;y<b&&0===k[y];y++);for(w<y&&(w=y),P=1,m=1;m<=15;m++)if(P<<=1,(P-=k[m])<0)return-1;if(P>0&&(0===e||1!==b))return-1;for(E[1]=0,m=1;m<15;m++)E[m+1]=E[m]+k[m];for(_=0;_<r;_++)0!==t[i+_]&&(o[E[t[i+_]]++]=_);if(0===e?(F=I=o,d=20):1===e?(F=mt,I=_t,d=257):(F=yt,I=bt,d=0),M=0,_=0,m=y,h=s,B=w,x=0,A=-1,c=(C=1<<w)-1,1===e&&C>852||2===e&&C>592)return 1;for(;;){p=m-x,o[_]+1<d?(f=0,v=o[_]):o[_]>=d?(f=I[o[_]-d],v=F[o[_]-d]):(f=96,v=0),l=1<<m-x,y=u=1<<B;do{n[h+(M>>x)+(u-=l)]=p<<24|f<<16|v|0}while(0!==u);for(l=1<<m-1;M&l;)l>>=1;if(0!==l?(M&=l-1,M+=l):M=0,_++,0==--k[m]){if(m===b)break;m=t[i+o[_]]}if(m>w&&(M&c)!==A){for(0===x&&(x=w),h+=y,P=1<<(B=m-x);B+x<b&&!((P-=k[B+x])<=0);)B++,P<<=1;if(C+=1<<B,1===e&&C>852||2===e&&C>592)return 1;n[A=M&c]=w<<24|B<<16|h-s|0}}return 0!==M&&(n[h+M]=m-x<<24|64<<16|0),a.bits=w,0},Bt=G.Z_FINISH,xt=G.Z_BLOCK,Pt=G.Z_TREES,Ct=G.Z_OK,Mt=G.Z_STREAM_END,Ft=G.Z_NEED_DICT,kt=G.Z_STREAM_ERROR,Et=G.Z_DATA_ERROR,It=G.Z_MEM_ERROR,Tt=G.Z_BUF_ERROR,Dt=G.Z_DEFLATED,St=16180,Rt=16190,Ut=16191,Lt=16192,Ot=16194,Nt=16199,Vt=16200,Qt=16206,Ht=16209,Gt=function(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)};function jt(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}var zt,Wt,Xt=function(e){if(!e)return 1;var t=e.state;return!t||t.strm!==e||t.mode<St||t.mode>16211?1:0},Kt=function(e){if(Xt(e))return kt;var t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=St,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Ct},Zt=function(e){if(Xt(e))return kt;var t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Kt(e)},Jt=function(e,t){var i;if(Xt(e))return kt;var r=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?kt:(null!==r.window&&r.wbits!==t&&(r.window=null),r.wrap=i,r.wbits=t,Zt(e))},Yt=function(e,t){if(!e)return kt;var i=new jt;e.state=i,i.strm=e,i.window=null,i.mode=St;var r=Jt(e,t);return r!==Ct&&(e.state=null),r},qt=!0,$t=function(e){if(qt){zt=new Int32Array(512),Wt=new Int32Array(32);for(var t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(wt(1,e.lens,0,288,zt,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;wt(2,e.lens,0,32,Wt,0,e.work,{bits:5}),qt=!1}e.lencode=zt,e.lenbits=9,e.distcode=Wt,e.distbits=5},ei=function(e,t,i,r){var n,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),r>=s.wsize?(s.window.set(t.subarray(i-s.wsize,i),0),s.wnext=0,s.whave=s.wsize):((n=s.wsize-s.wnext)>r&&(n=r),s.window.set(t.subarray(i-r,i-r+n),s.wnext),(r-=n)?(s.window.set(t.subarray(i-r,i),0),s.wnext=r,s.whave=s.wsize):(s.wnext+=n,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=n))),0},ti=Zt,ii=Yt,ri=function(e,t){var i,r,n,s,o,a,l,u,A,c,h,d,p,f,v,g,m,_,y,b,w,B,x,P,C=0,M=new Uint8Array(4),F=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Xt(e)||!e.output||!e.input&&0!==e.avail_in)return kt;(i=e.state).mode===Ut&&(i.mode=Lt),o=e.next_out,n=e.output,l=e.avail_out,s=e.next_in,r=e.input,a=e.avail_in,u=i.hold,A=i.bits,c=a,h=l,B=Ct;e:for(;;)switch(i.mode){case St:if(0===i.wrap){i.mode=Lt;break}for(;A<16;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(2&i.wrap&&35615===u){0===i.wbits&&(i.wbits=15),i.check=0,M[0]=255&u,M[1]=u>>>8&255,i.check=Q(i.check,M,2,0),u=0,A=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",i.mode=Ht;break}if((15&u)!==Dt){e.msg="unknown compression method",i.mode=Ht;break}if(A-=4,w=8+(15&(u>>>=4)),0===i.wbits&&(i.wbits=w),w>15||w>i.wbits){e.msg="invalid window size",i.mode=Ht;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&u?16189:Ut,u=0,A=0;break;case 16181:for(;A<16;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(i.flags=u,(255&i.flags)!==Dt){e.msg="unknown compression method",i.mode=Ht;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Ht;break}i.head&&(i.head.text=u>>8&1),512&i.flags&&4&i.wrap&&(M[0]=255&u,M[1]=u>>>8&255,i.check=Q(i.check,M,2,0)),u=0,A=0,i.mode=16182;case 16182:for(;A<32;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.head&&(i.head.time=u),512&i.flags&&4&i.wrap&&(M[0]=255&u,M[1]=u>>>8&255,M[2]=u>>>16&255,M[3]=u>>>24&255,i.check=Q(i.check,M,4,0)),u=0,A=0,i.mode=16183;case 16183:for(;A<16;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.head&&(i.head.xflags=255&u,i.head.os=u>>8),512&i.flags&&4&i.wrap&&(M[0]=255&u,M[1]=u>>>8&255,i.check=Q(i.check,M,2,0)),u=0,A=0,i.mode=16184;case 16184:if(1024&i.flags){for(;A<16;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.length=u,i.head&&(i.head.extra_len=u),512&i.flags&&4&i.wrap&&(M[0]=255&u,M[1]=u>>>8&255,i.check=Q(i.check,M,2,0)),u=0,A=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&((d=i.length)>a&&(d=a),d&&(i.head&&(w=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(r.subarray(s,s+d),w)),512&i.flags&&4&i.wrap&&(i.check=Q(i.check,r,d,s)),a-=d,s+=d,i.length-=d),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(0===a)break e;d=0;do{w=r[s+d++],i.head&&w&&i.length<65536&&(i.head.name+=String.fromCharCode(w))}while(w&&d<a);if(512&i.flags&&4&i.wrap&&(i.check=Q(i.check,r,d,s)),a-=d,s+=d,w)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(0===a)break e;d=0;do{w=r[s+d++],i.head&&w&&i.length<65536&&(i.head.comment+=String.fromCharCode(w))}while(w&&d<a);if(512&i.flags&&4&i.wrap&&(i.check=Q(i.check,r,d,s)),a-=d,s+=d,w)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;A<16;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(4&i.wrap&&u!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Ht;break}u=0,A=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Ut;break;case 16189:for(;A<32;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}e.adler=i.check=Gt(u),u=0,A=0,i.mode=Rt;case Rt:if(0===i.havedict)return e.next_out=o,e.avail_out=l,e.next_in=s,e.avail_in=a,i.hold=u,i.bits=A,Ft;e.adler=i.check=1,i.mode=Ut;case Ut:if(t===xt||t===Pt)break e;case Lt:if(i.last){u>>>=7&A,A-=7&A,i.mode=Qt;break}for(;A<3;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}switch(i.last=1&u,A-=1,3&(u>>>=1)){case 0:i.mode=16193;break;case 1:if($t(i),i.mode=Nt,t===Pt){u>>>=2,A-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=Ht}u>>>=2,A-=2;break;case 16193:for(u>>>=7&A,A-=7&A;A<32;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Ht;break}if(i.length=65535&u,u=0,A=0,i.mode=Ot,t===Pt)break e;case Ot:i.mode=16195;case 16195:if(d=i.length){if(d>a&&(d=a),d>l&&(d=l),0===d)break e;n.set(r.subarray(s,s+d),o),a-=d,s+=d,l-=d,o+=d,i.length-=d;break}i.mode=Ut;break;case 16196:for(;A<14;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(i.nlen=257+(31&u),u>>>=5,A-=5,i.ndist=1+(31&u),u>>>=5,A-=5,i.ncode=4+(15&u),u>>>=4,A-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Ht;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;A<3;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.lens[F[i.have++]]=7&u,u>>>=3,A-=3}for(;i.have<19;)i.lens[F[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,x={bits:i.lenbits},B=wt(0,i.lens,0,19,i.lencode,0,i.work,x),i.lenbits=x.bits,B){e.msg="invalid code lengths set",i.mode=Ht;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;g=(C=i.lencode[u&(1<<i.lenbits)-1])>>>16&255,m=65535&C,!((v=C>>>24)<=A);){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(m<16)u>>>=v,A-=v,i.lens[i.have++]=m;else{if(16===m){for(P=v+2;A<P;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(u>>>=v,A-=v,0===i.have){e.msg="invalid bit length repeat",i.mode=Ht;break}w=i.lens[i.have-1],d=3+(3&u),u>>>=2,A-=2}else if(17===m){for(P=v+3;A<P;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}A-=v,w=0,d=3+(7&(u>>>=v)),u>>>=3,A-=3}else{for(P=v+7;A<P;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}A-=v,w=0,d=11+(127&(u>>>=v)),u>>>=7,A-=7}if(i.have+d>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Ht;break}for(;d--;)i.lens[i.have++]=w}}if(i.mode===Ht)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Ht;break}if(i.lenbits=9,x={bits:i.lenbits},B=wt(1,i.lens,0,i.nlen,i.lencode,0,i.work,x),i.lenbits=x.bits,B){e.msg="invalid literal/lengths set",i.mode=Ht;break}if(i.distbits=6,i.distcode=i.distdyn,x={bits:i.distbits},B=wt(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,x),i.distbits=x.bits,B){e.msg="invalid distances set",i.mode=Ht;break}if(i.mode=Nt,t===Pt)break e;case Nt:i.mode=Vt;case Vt:if(a>=6&&l>=258){e.next_out=o,e.avail_out=l,e.next_in=s,e.avail_in=a,i.hold=u,i.bits=A,gt(e,h),o=e.next_out,n=e.output,l=e.avail_out,s=e.next_in,r=e.input,a=e.avail_in,u=i.hold,A=i.bits,i.mode===Ut&&(i.back=-1);break}for(i.back=0;g=(C=i.lencode[u&(1<<i.lenbits)-1])>>>16&255,m=65535&C,!((v=C>>>24)<=A);){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(g&&0==(240&g)){for(_=v,y=g,b=m;g=(C=i.lencode[b+((u&(1<<_+y)-1)>>_)])>>>16&255,m=65535&C,!(_+(v=C>>>24)<=A);){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}u>>>=_,A-=_,i.back+=_}if(u>>>=v,A-=v,i.back+=v,i.length=m,0===g){i.mode=16205;break}if(32&g){i.back=-1,i.mode=Ut;break}if(64&g){e.msg="invalid literal/length code",i.mode=Ht;break}i.extra=15&g,i.mode=16201;case 16201:if(i.extra){for(P=i.extra;A<P;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.length+=u&(1<<i.extra)-1,u>>>=i.extra,A-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;g=(C=i.distcode[u&(1<<i.distbits)-1])>>>16&255,m=65535&C,!((v=C>>>24)<=A);){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(0==(240&g)){for(_=v,y=g,b=m;g=(C=i.distcode[b+((u&(1<<_+y)-1)>>_)])>>>16&255,m=65535&C,!(_+(v=C>>>24)<=A);){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}u>>>=_,A-=_,i.back+=_}if(u>>>=v,A-=v,i.back+=v,64&g){e.msg="invalid distance code",i.mode=Ht;break}i.offset=m,i.extra=15&g,i.mode=16203;case 16203:if(i.extra){for(P=i.extra;A<P;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}i.offset+=u&(1<<i.extra)-1,u>>>=i.extra,A-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Ht;break}i.mode=16204;case 16204:if(0===l)break e;if(d=h-l,i.offset>d){if((d=i.offset-d)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Ht;break}d>i.wnext?(d-=i.wnext,p=i.wsize-d):p=i.wnext-d,d>i.length&&(d=i.length),f=i.window}else f=n,p=o-i.offset,d=i.length;d>l&&(d=l),l-=d,i.length-=d;do{n[o++]=f[p++]}while(--d);0===i.length&&(i.mode=Vt);break;case 16205:if(0===l)break e;n[o++]=i.length,l--,i.mode=Vt;break;case Qt:if(i.wrap){for(;A<32;){if(0===a)break e;a--,u|=r[s++]<<A,A+=8}if(h-=l,e.total_out+=h,i.total+=h,4&i.wrap&&h&&(e.adler=i.check=i.flags?Q(i.check,n,h,o-h):N(i.check,n,h,o-h)),h=l,4&i.wrap&&(i.flags?u:Gt(u))!==i.check){e.msg="incorrect data check",i.mode=Ht;break}u=0,A=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;A<32;){if(0===a)break e;a--,u+=r[s++]<<A,A+=8}if(4&i.wrap&&u!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Ht;break}u=0,A=0}i.mode=16208;case 16208:B=Mt;break e;case Ht:B=Et;break e;case 16210:return It;default:return kt}return e.next_out=o,e.avail_out=l,e.next_in=s,e.avail_in=a,i.hold=u,i.bits=A,(i.wsize||h!==e.avail_out&&i.mode<Ht&&(i.mode<Qt||t!==Bt))&&ei(e,e.output,e.next_out,h-e.avail_out),c-=e.avail_in,h-=e.avail_out,e.total_in+=c,e.total_out+=h,i.total+=h,4&i.wrap&&h&&(e.adler=i.check=i.flags?Q(i.check,n,h,e.next_out-h):N(i.check,n,h,e.next_out-h)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Ut?128:0)+(i.mode===Nt||i.mode===Ot?256:0),(0===c&&0===h||t===Bt)&&B===Ct&&(B=Tt),B},ni=function(e){if(Xt(e))return kt;var t=e.state;return t.window&&(t.window=null),e.state=null,Ct},si=function(e,t){if(Xt(e))return kt;var i=e.state;return 0==(2&i.wrap)?kt:(i.head=t,t.done=!1,Ct)},oi=function(e,t){var i,r=t.length;return Xt(e)?kt:0!==(i=e.state).wrap&&i.mode!==Rt?kt:i.mode===Rt&&N(1,t,r,0)!==i.check?Et:ei(e,t,r,r)?(i.mode=16210,It):(i.havedict=1,Ct)},ai=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},li=Object.prototype.toString,ui=G.Z_NO_FLUSH,Ai=G.Z_FINISH,ci=G.Z_OK,hi=G.Z_STREAM_END,di=G.Z_NEED_DICT,pi=G.Z_STREAM_ERROR,fi=G.Z_DATA_ERROR,vi=G.Z_MEM_ERROR;function gi(e){this.options=ze({chunkSize:65536,windowBits:15,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new $e,this.strm.avail_out=0;var i=ii(this.strm,t.windowBits);if(i!==ci)throw new Error(H[i]);if(this.header=new ai,si(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=Je(t.dictionary):"[object ArrayBuffer]"===li.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=oi(this.strm,t.dictionary))!==ci))throw new Error(H[i])}function mi(e,t){var i=new gi(t);if(i.push(e),i.err)throw i.msg||H[i.err];return i.result}gi.prototype.push=function(e,t){var i,r,n,s=this.strm,o=this.options.chunkSize,a=this.options.dictionary;if(this.ended)return!1;for(r=t===~~t?t:!0===t?Ai:ui,"[object ArrayBuffer]"===li.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;){for(0===s.avail_out&&(s.output=new Uint8Array(o),s.next_out=0,s.avail_out=o),(i=ri(s,r))===di&&a&&((i=oi(s,a))===ci?i=ri(s,r):i===fi&&(i=di));s.avail_in>0&&i===hi&&s.state.wrap>0&&0!==e[s.next_in];)ti(s),i=ri(s,r);switch(i){case pi:case fi:case di:case vi:return this.onEnd(i),this.ended=!0,!1}if(n=s.avail_out,s.next_out&&(0===s.avail_out||i===hi))if("string"===this.options.to){var l=qe(s.output,s.next_out),u=s.next_out-l,A=Ye(s.output,l);s.next_out=u,s.avail_out=o-u,u&&s.output.set(s.output.subarray(l,l+u),0),this.onData(A)}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(i!==ci||0!==n){if(i===hi)return i=ni(this.strm),this.onEnd(i),this.ended=!0,!0;if(0===s.avail_in)break}}return!0},gi.prototype.onData=function(e){this.chunks.push(e)},gi.prototype.onEnd=function(e){e===ci&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=We(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var _i=function(e,t){return(t=t||{}).raw=!0,mi(e,t)},yi=ht,bi=dt,wi=pt,Bi=ft,xi=gi,Pi=mi,Ci=_i,Mi=mi,Fi=G,ki={Deflate:yi,deflate:bi,deflateRaw:wi,gzip:Bi,Inflate:xi,inflate:Pi,inflateRaw:Ci,ungzip:Mi,constants:Fi};e.Deflate=yi,e.Inflate=xi,e.constants=Fi,e.default=ki,e.deflate=bi,e.deflateRaw=wi,e.gzip=Bi,e.inflate=Pi,e.inflateRaw=Ci,e.ungzip=Mi,Object.defineProperty(e,"__esModule",{value:!0})}));var gT=Object.freeze({__proto__:null}),mT=window.pako||gT;mT.inflate||(mT=mT.default);var _T,yT=(_T=new Float32Array(3),function(e){return _T[0]=e[0]/255,_T[1]=e[1]/255,_T[2]=e[2]/255,_T});var bT={version:1,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11]}}(i),a=function(e){return{positions:new Uint16Array(mT.inflate(e.positions).buffer),normals:new Int8Array(mT.inflate(e.normals).buffer),indices:new Uint32Array(mT.inflate(e.indices).buffer),edgeIndices:new Uint32Array(mT.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(mT.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(mT.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(mT.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(mT.inflate(e.meshColors).buffer),entityIDs:mT.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(mT.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(mT.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(mT.inflate(e.positionsDecodeMatrix).buffer)}}(o);!function(e,t,i,r,n,s){s.getNextId(),r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var o=i.positions,a=i.normals,l=i.indices,u=i.edgeIndices,A=i.meshPositions,c=i.meshIndices,h=i.meshEdgesIndices,d=i.meshColors,p=JSON.parse(i.entityIDs),f=i.entityMeshes,v=i.entityIsObjects,g=A.length,m=f.length,_=0;_<m;_++){var y=p[_],b=t.globalizeObjectIds?le.globalizeObjectId(r.id,y):y,w=e.metaScene.metaObjects[b],B={},x={};if(w){if(t.excludeTypesMap&&w.type&&t.excludeTypesMap[w.type])continue;if(t.includeTypesMap&&w.type&&!t.includeTypesMap[w.type])continue;var P=t.objectDefaults?t.objectDefaults[w.type]||t.objectDefaults.DEFAULT:null;P&&(!1===P.visible&&(B.visible=!1),!1===P.pickable&&(B.pickable=!1),P.colorize&&(x.color=P.colorize),void 0!==P.opacity&&null!==P.opacity&&(x.opacity=P.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var C=_===m-1,M=[],F=f[_],k=C?f.length:f[_+1];F<k;F++){var E=F===g-1,I=b+".mesh."+F,T=yT(d.subarray(4*F,4*F+3)),D=d[4*F+3]/255;r.createMesh(ge.apply(x,{id:I,primitive:"triangles",positionsCompressed:o.subarray(A[F],E?o.length:A[F+1]),normalsCompressed:a.subarray(A[F],E?o.length:A[F+1]),indices:l.subarray(c[F],E?l.length:c[F+1]),edgeIndices:u.subarray(h[F],E?u.length:h[F+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:T,opacity:D})),M.push(I)}r.createEntity(ge.apply(B,{id:b,isObject:1===v[_],meshIds:M}))}}(e,t,a,r,0,s)}},wT=window.pako||gT;wT.inflate||(wT=wT.default);var BT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var xT={version:2,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11],entityMeshIds:e[12],entityMatrices:e[13],entityUsesInstancing:e[14]}}(i),a=function(e){return{positions:new Uint16Array(wT.inflate(e.positions).buffer),normals:new Int8Array(wT.inflate(e.normals).buffer),indices:new Uint32Array(wT.inflate(e.indices).buffer),edgeIndices:new Uint32Array(wT.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(wT.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(wT.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(wT.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(wT.inflate(e.meshColors).buffer),entityIDs:wT.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(wT.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(wT.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(wT.inflate(e.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(wT.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(wT.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(wT.inflate(e.entityUsesInstancing).buffer)}}(o);!function(e,t,i,r,n,s){var o=s.getNextId();r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var a=i.positions,l=i.normals,u=i.indices,A=i.edgeIndices,c=i.meshPositions,h=i.meshIndices,d=i.meshEdgesIndices,p=i.meshColors,f=JSON.parse(i.entityIDs),v=i.entityMeshes,g=i.entityIsObjects,m=i.entityMeshIds,_=i.entityMatrices,y=i.entityUsesInstancing,b=c.length,w=v.length,B={},x=0;x<w;x++){var P=f[x],C=t.globalizeObjectIds?le.globalizeObjectId(r.id,P):P,M=e.metaScene.metaObjects[C],F={},k={},E=_.subarray(16*x,16*x+16);if(M){if(t.excludeTypesMap&&M.type&&t.excludeTypesMap[M.type])continue;if(t.includeTypesMap&&M.type&&!t.includeTypesMap[M.type])continue;var I=t.objectDefaults?t.objectDefaults[M.type]||t.objectDefaults.DEFAULT:null;I&&(!1===I.visible&&(F.visible=!1),!1===I.pickable&&(F.pickable=!1),I.colorize&&(k.color=I.colorize),void 0!==I.opacity&&null!==I.opacity&&(k.opacity=I.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var T=x===w-1,D=[],S=v[x],R=T?m.length:v[x+1];S<R;S++){var U=m[S],L=U===b-1,O=s.getNextId(),N=BT(p.subarray(4*U,4*U+3)),V=p[4*U+3]/255,Q=a.subarray(c[U],L?a.length:c[U+1]),H=l.subarray(c[U],L?a.length:c[U+1]),G=u.subarray(h[U],L?u.length:h[U+1]),j=A.subarray(d[U],L?A.length:d[U+1]);if(1===y[x]){var z="".concat(o,".geometry.").concat(O,".").concat(U);z in B||(r.createGeometry({id:z,positionsCompressed:Q,normalsCompressed:H,indices:G,edgeIndices:j,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),B[z]=!0),r.createMesh(ge.apply(k,{id:O,color:N,opacity:V,matrix:E,geometryId:z})),D.push(O)}else r.createMesh(ge.apply(k,{id:O,primitive:"triangles",positionsCompressed:Q,normalsCompressed:H,indices:G,edgeIndices:j,positionsDecodeMatrix:i.positionsDecodeMatrix,color:N,opacity:V})),D.push(O)}D.length&&r.createEntity(ge.apply(F,{id:C,isObject:1===g[x],meshIds:D}))}}(e,t,a,r,0,s)}},PT=window.pako||gT;PT.inflate||(PT=PT.default);var CT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var MT={version:3,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],instancedPositionsDecodeMatrix:e[11],batchedPositionsDecodeMatrix:e[12],entityMeshIds:e[13],entityMatrices:e[14],entityUsesInstancing:e[15]}}(i),a=function(e){return{positions:new Uint16Array(PT.inflate(e.positions).buffer),normals:new Int8Array(PT.inflate(e.normals).buffer),indices:new Uint32Array(PT.inflate(e.indices).buffer),edgeIndices:new Uint32Array(PT.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(PT.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(PT.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(PT.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(PT.inflate(e.meshColors).buffer),entityIDs:PT.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(PT.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(PT.inflate(e.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(PT.inflate(e.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(PT.inflate(e.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(PT.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(PT.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(PT.inflate(e.entityUsesInstancing).buffer)}}(o);!function(e,t,i,r,n,s){var o=s.getNextId();r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var a=i.positions,l=i.normals,u=i.indices,A=i.edgeIndices,c=i.meshPositions,h=i.meshIndices,d=i.meshEdgesIndices,p=i.meshColors,f=JSON.parse(i.entityIDs),v=i.entityMeshes,g=i.entityIsObjects,m=i.entityMeshIds,_=i.entityMatrices,y=i.entityUsesInstancing,b=c.length,w=v.length,B={},x=0;x<w;x++){var P=f[x],C=t.globalizeObjectIds?le.globalizeObjectId(r.id,P):P,M=e.metaScene.metaObjects[C],F={},k={},E=_.subarray(16*x,16*x+16);if(M){if(t.excludeTypesMap&&M.type&&t.excludeTypesMap[M.type])continue;if(t.includeTypesMap&&M.type&&!t.includeTypesMap[M.type])continue;var I=t.objectDefaults?t.objectDefaults[M.type]||t.objectDefaults.DEFAULT:null;I&&(!1===I.visible&&(F.visible=!1),!1===I.pickable&&(F.pickable=!1),I.colorize&&(k.color=I.colorize),void 0!==I.opacity&&null!==I.opacity&&(k.opacity=I.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var T=x===w-1,D=[],S=v[x],R=T?m.length:v[x+1];S<R;S++){var U=m[S],L=U===b-1,O="".concat(o,".").concat(C,".mesh.").concat(U),N=CT(p.subarray(4*U,4*U+3)),V=p[4*U+3]/255,Q=a.subarray(c[U],L?a.length:c[U+1]),H=l.subarray(c[U],L?a.length:c[U+1]),G=u.subarray(h[U],L?u.length:h[U+1]),j=A.subarray(d[U],L?A.length:d[U+1]);if(1===y[x]){var z="".concat(o,".geometry.").concat(O,".").concat(U);z in B||(r.createGeometry({id:z,positionsCompressed:Q,normalsCompressed:H,indices:G,edgeIndices:j,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),B[z]=!0),r.createMesh(ge.apply(k,{id:O,color:N,opacity:V,matrix:E,geometryId:z})),D.push(O)}else r.createMesh(ge.apply(k,{id:O,primitive:"triangles",positionsCompressed:Q,normalsCompressed:H,indices:G,edgeIndices:j,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:N,opacity:V})),D.push(O)}D.length&&r.createEntity(ge.apply(F,{id:C,isObject:1===g[x],meshIds:D}))}}(e,t,a,r,0,s)}},FT=window.pako||gT;FT.inflate||(FT=FT.default);var kT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var ET={version:4,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],decodeMatrices:e[4],matrices:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveDecodeMatricesPortion:e[9],eachPrimitiveColor:e[10],primitiveInstances:e[11],eachEntityId:e[12],eachEntityPrimitiveInstancesPortion:e[13],eachEntityMatricesPortion:e[14],eachEntityMatrix:e[15]}}(i),a=function(e){return{positions:new Uint16Array(FT.inflate(e.positions).buffer),normals:new Int8Array(FT.inflate(e.normals).buffer),indices:new Uint32Array(FT.inflate(e.indices).buffer),edgeIndices:new Uint32Array(FT.inflate(e.edgeIndices).buffer),decodeMatrices:new Float32Array(FT.inflate(e.decodeMatrices).buffer),matrices:new Float32Array(FT.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(FT.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(FT.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(FT.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(FT.inflate(e.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(FT.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(FT.inflate(e.primitiveInstances).buffer),eachEntityId:FT.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(FT.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(FT.inflate(e.eachEntityMatricesPortion).buffer)}}(o);!function(e,t,i,r,n,s){var o=s.getNextId();r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var a=i.positions,l=i.normals,u=i.indices,A=i.edgeIndices,c=i.decodeMatrices,h=i.matrices,d=i.eachPrimitivePositionsAndNormalsPortion,p=i.eachPrimitiveIndicesPortion,f=i.eachPrimitiveEdgeIndicesPortion,v=i.eachPrimitiveDecodeMatricesPortion,g=i.eachPrimitiveColor,m=i.primitiveInstances,_=JSON.parse(i.eachEntityId),y=i.eachEntityPrimitiveInstancesPortion,b=i.eachEntityMatricesPortion,w=d.length,B=m.length,x=new Uint8Array(w),P=new Uint32Array(w),C=_.length,M=0;M<w;M++)P[M]=M;P.sort((function(e,t){return v[e]<v[t]?-1:v[e]>v[t]?1:0}));for(var F=0;F<B;F++)x[m[F]]++;for(var k={},E=0;E<C;E++)for(var I=C-1,T=E===I,D=y[E],S=T?y[I]:y[E+1],R=D;R<S;R++){var U=m[R];x[U]>1||(k[U]=E)}for(var L=0;L<w;L++){var O=P[L],N=O===w-1,V=x[O]>1,Q=kT(g.subarray(4*O,4*O+3)),H=g[4*O+3]/255,G=a.subarray(d[O],N?a.length:d[O+1]),j=l.subarray(d[O],N?l.length:d[O+1]),z=u.subarray(p[O],N?u.length:p[O+1]),W=A.subarray(f[O],N?A.length:f[O+1]),X=c.subarray(v[O],v[O]+16);if(V){var K="".concat(o,"-geometry.").concat(O);r.createGeometry({id:K,primitive:"triangles",positionsCompressed:G,normalsCompressed:j,indices:z,edgeIndices:W,positionsDecodeMatrix:X})}else{var Z="".concat(o,"-").concat(O);_[k[O]],r.createMesh(ge.apply({},{id:Z,primitive:"triangles",positionsCompressed:G,normalsCompressed:j,indices:z,edgeIndices:W,positionsDecodeMatrix:X,color:Q,opacity:H}))}}for(var J=0,Y=0;Y<C;Y++){for(var q=C-1,$=Y===q,ee=_[Y],te=y[Y],ie=$?y[q]:y[Y+1],re=[],ne=te;ne<ie;ne++){var se=m[ne];if(x[se]>1){var oe="".concat(o,"-instance.").concat(J++),ae="".concat(o,"-geometry.").concat(se),le=16*b[Y],ue=h.subarray(le,le+16);r.createMesh(ge.apply({},{id:oe,geometryId:ae,matrix:ue})),re.push(oe)}else re.push(se)}re.length>0&&r.createEntity(ge.apply({},{id:ee,isObject:!0,meshIds:re}))}}(0,0,a,r,0,s)}},IT=window.pako||gT;IT.inflate||(IT=IT.default);var TT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var DT={version:5,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],eachPrimitivePositionsAndNormalsPortion:e[5],eachPrimitiveIndicesPortion:e[6],eachPrimitiveEdgeIndicesPortion:e[7],eachPrimitiveColor:e[8],primitiveInstances:e[9],eachEntityId:e[10],eachEntityPrimitiveInstancesPortion:e[11],eachEntityMatricesPortion:e[12]}}(i),a=function(e){return{positions:new Float32Array(IT.inflate(e.positions).buffer),normals:new Int8Array(IT.inflate(e.normals).buffer),indices:new Uint32Array(IT.inflate(e.indices).buffer),edgeIndices:new Uint32Array(IT.inflate(e.edgeIndices).buffer),matrices:new Float32Array(IT.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(IT.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(IT.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(IT.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(IT.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(IT.inflate(e.primitiveInstances).buffer),eachEntityId:IT.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(IT.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(IT.inflate(e.eachEntityMatricesPortion).buffer)}}(o);!function(e,t,i,r,n,s){var o=s.getNextId();r.positionsCompression="disabled",r.normalsCompression="precompressed";for(var a=i.positions,l=i.normals,u=i.indices,A=i.edgeIndices,c=i.matrices,h=i.eachPrimitivePositionsAndNormalsPortion,d=i.eachPrimitiveIndicesPortion,p=i.eachPrimitiveEdgeIndicesPortion,f=i.eachPrimitiveColor,v=i.primitiveInstances,g=JSON.parse(i.eachEntityId),m=i.eachEntityPrimitiveInstancesPortion,_=i.eachEntityMatricesPortion,y=h.length,b=v.length,w=new Uint8Array(y),B=g.length,x=0;x<b;x++)w[v[x]]++;for(var P={},C=0;C<B;C++)for(var M=B-1,F=C===M,k=m[C],E=F?m[M]:m[C+1],I=k;I<E;I++){var T=v[I];w[T]>1||(P[T]=C)}for(var D=0;D<y;D++){var S=D===y-1,R=w[D]>1,U=TT(f.subarray(4*D,4*D+3)),L=f[4*D+3]/255,O=a.subarray(h[D],S?a.length:h[D+1]),N=l.subarray(h[D],S?l.length:h[D+1]),V=u.subarray(d[D],S?u.length:d[D+1]),Q=A.subarray(p[D],S?A.length:p[D+1]);if(R){var H="".concat(o,"-geometry.").concat(D);r.createGeometry({id:H,primitive:"triangles",positionsCompressed:O,normalsCompressed:N,indices:V,edgeIndices:Q})}else{var G=D;g[P[D]],r.createMesh(ge.apply({},{id:G,primitive:"triangles",positionsCompressed:O,normalsCompressed:N,indices:V,edgeIndices:Q,color:U,opacity:L}))}}for(var j=0,z=0;z<B;z++){for(var W=B-1,X=z===W,K=g[z],Z=m[z],J=X?m[W]:m[z+1],Y=[],q=Z;q<J;q++){var $=v[q];if(w[$]>1){var ee="instance."+j++,te="geometry"+$,ie=16*_[z],re=c.subarray(ie,ie+16);r.createMesh(ge.apply({},{id:ee,geometryId:te,matrix:re})),Y.push(ee)}else Y.push($)}Y.length>0&&r.createEntity(ge.apply({},{id:K,isObject:!0,meshIds:Y}))}}(0,0,a,r,0,s)}},ST=window.pako||gT;ST.inflate||(ST=ST.default);var RT,UT=(RT=new Float32Array(3),function(e){return RT[0]=e[0]/255,RT[1]=e[1]/255,RT[2]=e[2]/255,RT});var LT={version:6,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],reusedPrimitivesDecodeMatrix:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveColorAndOpacity:e[9],primitiveInstances:e[10],eachEntityId:e[11],eachEntityPrimitiveInstancesPortion:e[12],eachEntityMatricesPortion:e[13],eachTileAABB:e[14],eachTileEntitiesPortion:e[15]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:ST.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(t(e.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(t(e.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(t(e.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(t(e.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(t(e.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(t(e.primitiveInstances)),eachEntityId:ST.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(t(e.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(t(e.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);!function(e,t,i,r,n,s){for(var o=s.getNextId(),a=i.positions,l=i.normals,u=i.indices,A=i.edgeIndices,c=i.matrices,h=i.reusedPrimitivesDecodeMatrix,d=i.eachPrimitivePositionsAndNormalsPortion,p=i.eachPrimitiveIndicesPortion,f=i.eachPrimitiveEdgeIndicesPortion,v=i.eachPrimitiveColorAndOpacity,g=i.primitiveInstances,m=JSON.parse(i.eachEntityId),_=i.eachEntityPrimitiveInstancesPortion,y=i.eachEntityMatricesPortion,b=i.eachTileAABB,w=i.eachTileEntitiesPortion,B=d.length,x=g.length,P=m.length,C=w.length,M=new Uint32Array(B),F=0;F<x;F++){var k=g[F];void 0!==M[k]?M[k]++:M[k]=1}for(var E=le.vec3(),I=le.AABB3(),T=0;T<C;T++){var D=T===C-1,S=w[T],R=D?P:w[T+1],U=6*T,L=b.subarray(U,U+6);le.getAABB3Center(L,E),I[0]=L[0]-E[0],I[1]=L[1]-E[1],I[2]=L[2]-E[2],I[3]=L[3]-E[0],I[4]=L[4]-E[1],I[5]=L[5]-E[2];for(var O=ft.createPositionsDecodeMatrix(I),N={},V=S;V<R;V++){var Q=m[V],H=t.globalizeObjectIds?le.globalizeObjectId(r.id,Q):Q,G=y[V],j=c.slice(G,G+16),z=V===P-1,W=_[V],X=z?g.length:_[V+1],K=[],Z=e.metaScene.metaObjects[H],J={},Y={};if(Z){if(t.excludeTypesMap&&Z.type&&t.excludeTypesMap[Z.type])continue;if(t.includeTypesMap&&Z.type&&!t.includeTypesMap[Z.type])continue;if(t.includeIdsMap&&Z.id&&!t.includeIdsMap[Z.id])continue;var q=t.objectDefaults?t.objectDefaults[Z.type]||t.objectDefaults.DEFAULT:null;q&&(!1===q.visible&&(J.visible=!1),!1===q.pickable&&(J.pickable=!1),q.colorize&&(Y.color=q.colorize),void 0!==q.opacity&&null!==q.opacity&&(Y.opacity=q.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(var $=W;$<X;$++){var ee=g[$],te=M[ee]>1,ie=ee===B-1,re=a.subarray(d[ee],ie?a.length:d[ee+1]),ne=l.subarray(d[ee],ie?l.length:d[ee+1]),se=u.subarray(p[ee],ie?u.length:p[ee+1]),oe=A.subarray(f[ee],ie?A.length:f[ee+1]),ae=UT(v.subarray(4*ee,4*ee+3)),ue=v[4*ee+3]/255,Ae=s.getNextId();if(te){var ce="".concat(o,"-geometry.").concat(T,".").concat(ee);N[ce]||(r.createGeometry({id:ce,primitive:"triangles",positionsCompressed:re,indices:se,edgeIndices:oe,positionsDecodeMatrix:h}),N[ce]=!0),r.createMesh(ge.apply(Y,{id:Ae,geometryId:ce,origin:E,matrix:j,color:ae,opacity:ue})),K.push(Ae)}else r.createMesh(ge.apply(Y,{id:Ae,origin:E,primitive:"triangles",positionsCompressed:re,normalsCompressed:ne,indices:se,edgeIndices:oe,positionsDecodeMatrix:O,color:ae,opacity:ue})),K.push(Ae)}K.length>0&&r.createEntity(ge.apply(J,{id:H,isObject:!0,meshIds:K}))}}}(e,t,a,r,0,s)}},OT=window.pako||gT;OT.inflate||(OT=OT.default);var NT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function VT(e){for(var t=[],i=0,r=e.length;i<r;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}var QT={version:7,parse:function(e,t,i,r,n,s){var o=function(e){return{positions:e[0],normals:e[1],colors:e[2],indices:e[3],edgeIndices:e[4],matrices:e[5],reusedGeometriesDecodeMatrix:e[6],eachGeometryPrimitiveType:e[7],eachGeometryPositionsPortion:e[8],eachGeometryNormalsPortion:e[9],eachGeometryColorsPortion:e[10],eachGeometryIndicesPortion:e[11],eachGeometryEdgeIndicesPortion:e[12],eachMeshGeometriesPortion:e[13],eachMeshMatricesPortion:e[14],eachMeshMaterial:e[15],eachEntityId:e[16],eachEntityMeshesPortion:e[17],eachTileAABB:e[18],eachTileEntitiesPortion:e[19]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:OT.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:OT.inflate(e.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);!function(e,t,i,r,n,s){for(var o=s.getNextId(),a=i.positions,l=i.normals,u=i.colors,A=i.indices,c=i.edgeIndices,h=i.matrices,d=i.reusedGeometriesDecodeMatrix,p=i.eachGeometryPrimitiveType,f=i.eachGeometryPositionsPortion,v=i.eachGeometryNormalsPortion,g=i.eachGeometryColorsPortion,m=i.eachGeometryIndicesPortion,_=i.eachGeometryEdgeIndicesPortion,y=i.eachMeshGeometriesPortion,b=i.eachMeshMatricesPortion,w=i.eachMeshMaterial,B=JSON.parse(i.eachEntityId),x=i.eachEntityMeshesPortion,P=i.eachTileAABB,C=i.eachTileEntitiesPortion,M=f.length,F=y.length,k=B.length,E=C.length,I=new Uint32Array(M),T=0;T<F;T++){var D=y[T];void 0!==I[D]?I[D]++:I[D]=1}for(var S=le.vec3(),R=le.AABB3(),U=0;U<E;U++){var L=U===E-1,O=C[U],N=L?k:C[U+1],V=6*U,Q=P.subarray(V,V+6);le.getAABB3Center(Q,S),R[0]=Q[0]-S[0],R[1]=Q[1]-S[1],R[2]=Q[2]-S[2],R[3]=Q[3]-S[0],R[4]=Q[4]-S[1],R[5]=Q[5]-S[2];for(var H=ft.createPositionsDecodeMatrix(R),G={},j=O;j<N;j++){var z=B[j],W=t.globalizeObjectIds?le.globalizeObjectId(r.id,z):z,X=j===k-1,K=x[j],Z=X?y.length:x[j+1],J=[],Y=e.metaScene.metaObjects[W],q={},$={};if(Y){if(t.excludeTypesMap&&Y.type&&t.excludeTypesMap[Y.type])continue;if(t.includeTypesMap&&Y.type&&!t.includeTypesMap[Y.type])continue;if(t.includeIdsMap&&Y.id&&!t.includeIdsMap[Y.id])continue;var ee=t.objectDefaults?t.objectDefaults[Y.type]||t.objectDefaults.DEFAULT:null;ee&&(!1===ee.visible&&(q.visible=!1),!1===ee.pickable&&(q.pickable=!1),ee.colorize&&($.color=ee.colorize),void 0!==ee.opacity&&null!==ee.opacity&&($.opacity=ee.opacity),void 0!==ee.metallic&&null!==ee.metallic&&($.metallic=ee.metallic),void 0!==ee.roughness&&null!==ee.roughness&&($.roughness=ee.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var te=K;te<Z;te++){var ie=y[te],re=I[ie]>1,ne=ie===M-1,se=NT(w.subarray(6*te,6*te+3)),oe=w[6*te+3]/255,ae=w[6*te+4]/255,ue=w[6*te+5]/255,Ae=s.getNextId();if(re){var ce=b[te],he=h.slice(ce,ce+16),de="".concat(o,"-geometry.").concat(U,".").concat(ie);if(!G[de]){var pe=void 0,fe=void 0,ve=void 0,me=void 0,_e=void 0,ye=void 0;switch(p[ie]){case 0:pe="solid",fe=a.subarray(f[ie],ne?a.length:f[ie+1]),ve=l.subarray(v[ie],ne?l.length:v[ie+1]),_e=A.subarray(m[ie],ne?A.length:m[ie+1]),ye=c.subarray(_[ie],ne?c.length:_[ie+1]);break;case 1:pe="surface",fe=a.subarray(f[ie],ne?a.length:f[ie+1]),ve=l.subarray(v[ie],ne?l.length:v[ie+1]),_e=A.subarray(m[ie],ne?A.length:m[ie+1]),ye=c.subarray(_[ie],ne?c.length:_[ie+1]);break;case 2:pe="points",fe=a.subarray(f[ie],ne?a.length:f[ie+1]),me=VT(u.subarray(g[ie],ne?u.length:g[ie+1]));break;case 3:pe="lines",fe=a.subarray(f[ie],ne?a.length:f[ie+1]),_e=A.subarray(m[ie],ne?A.length:m[ie+1]);break;default:continue}r.createGeometry({id:de,primitive:pe,positionsCompressed:fe,normalsCompressed:ve,colors:me,indices:_e,edgeIndices:ye,positionsDecodeMatrix:d}),G[de]=!0}r.createMesh(ge.apply($,{id:Ae,geometryId:de,origin:S,matrix:he,color:se,metallic:ae,roughness:ue,opacity:oe})),J.push(Ae)}else{var be=void 0,we=void 0,Be=void 0,xe=void 0,Pe=void 0,Ce=void 0;switch(p[ie]){case 0:be="solid",we=a.subarray(f[ie],ne?a.length:f[ie+1]),Be=l.subarray(v[ie],ne?l.length:v[ie+1]),Pe=A.subarray(m[ie],ne?A.length:m[ie+1]),Ce=c.subarray(_[ie],ne?c.length:_[ie+1]);break;case 1:be="surface",we=a.subarray(f[ie],ne?a.length:f[ie+1]),Be=l.subarray(v[ie],ne?l.length:v[ie+1]),Pe=A.subarray(m[ie],ne?A.length:m[ie+1]),Ce=c.subarray(_[ie],ne?c.length:_[ie+1]);break;case 2:be="points",we=a.subarray(f[ie],ne?a.length:f[ie+1]),xe=VT(u.subarray(g[ie],ne?u.length:g[ie+1]));break;case 3:be="lines",we=a.subarray(f[ie],ne?a.length:f[ie+1]),Pe=A.subarray(m[ie],ne?A.length:m[ie+1]);break;default:continue}r.createMesh(ge.apply($,{id:Ae,origin:S,primitive:be,positionsCompressed:we,normalsCompressed:Be,colors:xe,indices:Pe,edgeIndices:Ce,positionsDecodeMatrix:H,color:se,metallic:ae,roughness:ue,opacity:oe})),J.push(Ae)}}J.length>0&&r.createEntity(ge.apply(q,{id:W,isObject:!0,meshIds:J}))}}}(e,t,a,r,0,s)}},HT=window.pako||gT;HT.inflate||(HT=HT.default);var GT=le.vec4(),jT=le.vec4();var zT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function WT(e){for(var t=[],i=0,r=e.length;i<r;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}var XT={version:8,parse:function(e,t,i,r,n,s){var o=function(e){return{types:e[0],eachMetaObjectId:e[1],eachMetaObjectType:e[2],eachMetaObjectName:e[3],eachMetaObjectParent:e[4],positions:e[5],normals:e[6],colors:e[7],indices:e[8],edgeIndices:e[9],matrices:e[10],reusedGeometriesDecodeMatrix:e[11],eachGeometryPrimitiveType:e[12],eachGeometryPositionsPortion:e[13],eachGeometryNormalsPortion:e[14],eachGeometryColorsPortion:e[15],eachGeometryIndicesPortion:e[16],eachGeometryEdgeIndicesPortion:e[17],eachMeshGeometriesPortion:e[18],eachMeshMatricesPortion:e[19],eachMeshMaterial:e[20],eachEntityMetaObject:e[21],eachEntityMeshesPortion:e[22],eachTileAABB:e[23],eachTileEntitiesPortion:e[24]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:HT.inflate(e,t).buffer}return{types:HT.inflate(e.types,{to:"string"}),eachMetaObjectId:HT.inflate(e.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(t(e.eachMetaObjectType)),eachMetaObjectName:HT.inflate(e.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(t(e.eachMetaObjectParent)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(t(e.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);!function(e,t,i,r,n,s){var o=s.getNextId(),a=JSON.parse(i.types),l=JSON.parse(i.eachMetaObjectId),u=i.eachMetaObjectType,A=JSON.parse(i.eachMetaObjectName),c=i.eachMetaObjectParent,h=i.positions,d=i.normals,p=i.colors,f=i.indices,v=i.edgeIndices,g=i.matrices,m=i.reusedGeometriesDecodeMatrix,_=i.eachGeometryPrimitiveType,y=i.eachGeometryPositionsPortion,b=i.eachGeometryNormalsPortion,w=i.eachGeometryColorsPortion,B=i.eachGeometryIndicesPortion,x=i.eachGeometryEdgeIndicesPortion,P=i.eachMeshGeometriesPortion,C=i.eachMeshMatricesPortion,M=i.eachMeshMaterial,F=i.eachEntityMetaObject,k=i.eachEntityMeshesPortion,E=i.eachTileAABB,I=i.eachTileEntitiesPortion,T=l.length,D=y.length,S=P.length,R=F.length,U=I.length;if(n){for(var L={metaObjects:[]},O=0;O<T;O++){var N=l[O],V=a[u[O]]||"default",Q=A[O],H=c[O],G=H!==O?l[H]:null;L.metaObjects.push({id:N,type:V,name:Q,parent:G})}n.loadData(L,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds})}for(var j=new Uint32Array(D),z=0;z<S;z++){var W=P[z];void 0!==j[W]?j[W]++:j[W]=1}for(var X=le.vec3(),K=le.AABB3(),Z={},J=0;J<U;J++){var Y=J===U-1,q=I[J],$=Y?R:I[J+1],ee=6*J,te=E.subarray(ee,ee+6);le.getAABB3Center(te,X),K[0]=te[0]-X[0],K[1]=te[1]-X[1],K[2]=te[2]-X[2],K[3]=te[3]-X[0],K[4]=te[4]-X[1],K[5]=te[5]-X[2];for(var ie=ft.createPositionsDecodeMatrix(K),re={},ne=q;ne<$;ne++){var se=l[F[ne]],oe=t.globalizeObjectIds?le.globalizeObjectId(r.id,se):se,ae=ne===R-1,ue=k[ne],Ae=ae?P.length:k[ne+1],ce=[],he=e.metaScene.metaObjects[oe],de={},pe={};if(he){if(t.excludeTypesMap&&he.type&&t.excludeTypesMap[he.type])continue;if(t.includeTypesMap&&he.type&&!t.includeTypesMap[he.type])continue;if(t.includeIdsMap&&he.id&&!t.includeIdsMap[he.id])continue;var fe=t.objectDefaults?t.objectDefaults[he.type]||t.objectDefaults.DEFAULT:null;fe&&(!1===fe.visible&&(de.visible=!1),!1===fe.pickable&&(de.pickable=!1),fe.colorize&&(pe.color=fe.colorize),void 0!==fe.opacity&&null!==fe.opacity&&(pe.opacity=fe.opacity),void 0!==fe.metallic&&null!==fe.metallic&&(pe.metallic=fe.metallic),void 0!==fe.roughness&&null!==fe.roughness&&(pe.roughness=fe.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var ve=ue;ve<Ae;ve++){var me=P[ve],_e=j[me]>1,ye=me===D-1,be=zT(M.subarray(6*ve,6*ve+3)),we=M[6*ve+3]/255,Be=M[6*ve+4]/255,xe=M[6*ve+5]/255,Pe=s.getNextId();if(_e){var Ce=C[ve],Me=g.slice(Ce,Ce+16),Fe="".concat(o,"-geometry.").concat(J,".").concat(me),ke=Z[Fe];if(!ke){ke={batchThisMesh:!t.reuseGeometries};var Ee=!1;switch(_[me]){case 0:ke.primitiveName="solid",ke.geometryPositions=h.subarray(y[me],ye?h.length:y[me+1]),ke.geometryNormals=d.subarray(b[me],ye?d.length:b[me+1]),ke.geometryIndices=f.subarray(B[me],ye?f.length:B[me+1]),ke.geometryEdgeIndices=v.subarray(x[me],ye?v.length:x[me+1]),Ee=ke.geometryPositions.length>0&&ke.geometryIndices.length>0;break;case 1:ke.primitiveName="surface",ke.geometryPositions=h.subarray(y[me],ye?h.length:y[me+1]),ke.geometryNormals=d.subarray(b[me],ye?d.length:b[me+1]),ke.geometryIndices=f.subarray(B[me],ye?f.length:B[me+1]),ke.geometryEdgeIndices=v.subarray(x[me],ye?v.length:x[me+1]),Ee=ke.geometryPositions.length>0&&ke.geometryIndices.length>0;break;case 2:ke.primitiveName="points",ke.geometryPositions=h.subarray(y[me],ye?h.length:y[me+1]),ke.geometryColors=WT(p.subarray(w[me],ye?p.length:w[me+1])),Ee=ke.geometryPositions.length>0;break;case 3:ke.primitiveName="lines",ke.geometryPositions=h.subarray(y[me],ye?h.length:y[me+1]),ke.geometryIndices=f.subarray(B[me],ye?f.length:B[me+1]),Ee=ke.geometryPositions.length>0&&ke.geometryIndices.length>0;break;default:continue}if(Ee||(ke=null),ke&&(ke.geometryPositions.length,ke.batchThisMesh)){ke.decompressedPositions=new Float32Array(ke.geometryPositions.length);for(var Ie=ke.geometryPositions,Te=ke.decompressedPositions,De=0,Se=Ie.length;De<Se;De+=3)Te[De+0]=Ie[De+0]*m[0]+m[12],Te[De+1]=Ie[De+1]*m[5]+m[13],Te[De+2]=Ie[De+2]*m[10]+m[14];ke.geometryPositions=null,Z[Fe]=ke}}if(ke)if(ke.batchThisMesh){for(var Re=ke.decompressedPositions,Ue=new Uint16Array(Re.length),Le=0,Oe=Re.length;Le<Oe;Le+=3)GT[0]=Re[Le+0],GT[1]=Re[Le+1],GT[2]=Re[Le+2],GT[3]=1,le.transformVec4(Me,GT,jT),ft.compressPosition(jT,K,GT),Ue[Le+0]=GT[0],Ue[Le+1]=GT[1],Ue[Le+2]=GT[2];r.createMesh(ge.apply(pe,{id:Pe,origin:X,primitive:ke.primitiveName,positionsCompressed:Ue,normalsCompressed:ke.geometryNormals,colorsCompressed:ke.geometryColors,indices:ke.geometryIndices,edgeIndices:ke.geometryEdgeIndices,positionsDecodeMatrix:ie,color:be,metallic:Be,roughness:xe,opacity:we})),ce.push(Pe)}else re[Fe]||(r.createGeometry({id:Fe,primitive:ke.primitiveName,positionsCompressed:ke.geometryPositions,normalsCompressed:ke.geometryNormals,colorsCompressed:ke.geometryColors,indices:ke.geometryIndices,edgeIndices:ke.geometryEdgeIndices,positionsDecodeMatrix:m}),re[Fe]=!0),r.createMesh(ge.apply(pe,{id:Pe,geometryId:Fe,origin:X,matrix:Me,color:be,metallic:Be,roughness:xe,opacity:we})),ce.push(Pe)}else{var Ne=void 0,Ve=void 0,Qe=void 0,He=void 0,Ge=void 0,je=void 0,ze=!1;switch(_[me]){case 0:Ne="solid",Ve=h.subarray(y[me],ye?h.length:y[me+1]),Qe=d.subarray(b[me],ye?d.length:b[me+1]),Ge=f.subarray(B[me],ye?f.length:B[me+1]),je=v.subarray(x[me],ye?v.length:x[me+1]),ze=Ve.length>0&&Ge.length>0;break;case 1:Ne="surface",Ve=h.subarray(y[me],ye?h.length:y[me+1]),Qe=d.subarray(b[me],ye?d.length:b[me+1]),Ge=f.subarray(B[me],ye?f.length:B[me+1]),je=v.subarray(x[me],ye?v.length:x[me+1]),ze=Ve.length>0&&Ge.length>0;break;case 2:Ne="points",Ve=h.subarray(y[me],ye?h.length:y[me+1]),He=WT(p.subarray(w[me],ye?p.length:w[me+1])),ze=Ve.length>0;break;case 3:Ne="lines",Ve=h.subarray(y[me],ye?h.length:y[me+1]),Ge=f.subarray(B[me],ye?f.length:B[me+1]),ze=Ve.length>0&&Ge.length>0;break;default:continue}ze&&(r.createMesh(ge.apply(pe,{id:Pe,origin:X,primitive:Ne,positionsCompressed:Ve,normalsCompressed:Qe,colorsCompressed:He,indices:Ge,edgeIndices:je,positionsDecodeMatrix:ie,color:be,metallic:Be,roughness:xe,opacity:we})),ce.push(Pe))}}ce.length>0&&r.createEntity(ge.apply(de,{id:oe,isObject:!0,meshIds:ce}))}}}(e,t,a,r,n,s)}},KT=window.pako||gT;KT.inflate||(KT=KT.default);var ZT=le.vec4(),JT=le.vec4();var YT=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();var qT={version:9,parse:function(e,t,i,r,n,s){var o=function(e){return{metadata:e[0],positions:e[1],normals:e[2],colors:e[3],indices:e[4],edgeIndices:e[5],matrices:e[6],reusedGeometriesDecodeMatrix:e[7],eachGeometryPrimitiveType:e[8],eachGeometryPositionsPortion:e[9],eachGeometryNormalsPortion:e[10],eachGeometryColorsPortion:e[11],eachGeometryIndicesPortion:e[12],eachGeometryEdgeIndicesPortion:e[13],eachMeshGeometriesPortion:e[14],eachMeshMatricesPortion:e[15],eachMeshMaterial:e[16],eachEntityId:e[17],eachEntityMeshesPortion:e[18],eachTileAABB:e[19],eachTileEntitiesPortion:e[20]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:KT.inflate(e,t).buffer}return{metadata:JSON.parse(KT.inflate(e.metadata,{to:"string"})),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:JSON.parse(KT.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);!function(e,t,i,r,n,s){var o=s.getNextId(),a=i.metadata,l=i.positions,u=i.normals,A=i.colors,c=i.indices,h=i.edgeIndices,d=i.matrices,p=i.reusedGeometriesDecodeMatrix,f=i.eachGeometryPrimitiveType,v=i.eachGeometryPositionsPortion,g=i.eachGeometryNormalsPortion,m=i.eachGeometryColorsPortion,_=i.eachGeometryIndicesPortion,y=i.eachGeometryEdgeIndicesPortion,b=i.eachMeshGeometriesPortion,w=i.eachMeshMatricesPortion,B=i.eachMeshMaterial,x=i.eachEntityId,P=i.eachEntityMeshesPortion,C=i.eachTileAABB,M=i.eachTileEntitiesPortion,F=v.length,k=b.length,E=P.length,I=M.length;n&&n.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(var T=new Uint32Array(F),D=0;D<k;D++){var S=b[D];void 0!==T[S]?T[S]++:T[S]=1}for(var R=le.vec3(),U=le.AABB3(),L={},O=0;O<I;O++){var N=O===I-1,V=M[O],Q=N?E-1:M[O+1]-1,H=6*O,G=C.subarray(H,H+6);le.getAABB3Center(G,R),U[0]=G[0]-R[0],U[1]=G[1]-R[1],U[2]=G[2]-R[2],U[3]=G[3]-R[0],U[4]=G[4]-R[1],U[5]=G[5]-R[2];for(var j=ft.createPositionsDecodeMatrix(U),z={},W=V;W<=Q;W++){var X=x[W],K=t.globalizeObjectIds?le.globalizeObjectId(r.id,X):X,Z=W===E-1,J=P[W],Y=Z?b.length-1:P[W+1]-1,q=[],$=e.metaScene.metaObjects[K],ee={},te={};if($){if(t.excludeTypesMap&&$.type&&t.excludeTypesMap[$.type])continue;if(t.includeTypesMap&&$.type&&!t.includeTypesMap[$.type])continue;if(t.includeIdsMap&&$.id&&!t.includeIdsMap[$.id])continue;var ie=t.objectDefaults?t.objectDefaults[$.type]||t.objectDefaults.DEFAULT:null;ie&&(!1===ie.visible&&(ee.visible=!1),!1===ie.pickable&&(ee.pickable=!1),ie.colorize&&(te.color=ie.colorize),void 0!==ie.opacity&&null!==ie.opacity&&(te.opacity=ie.opacity),void 0!==ie.metallic&&null!==ie.metallic&&(te.metallic=ie.metallic),void 0!==ie.roughness&&null!==ie.roughness&&(te.roughness=ie.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var re=J;re<=Y;re++){var ne=b[re],se=T[ne]>1,oe=ne===F-1,ae=YT(B.subarray(6*re,6*re+3)),ue=B[6*re+3]/255,Ae=B[6*re+4]/255,ce=B[6*re+5]/255,he=s.getNextId();if(se){var de=w[re],pe=d.slice(de,de+16),fe="".concat(o,"-geometry.").concat(O,".").concat(ne),ve=L[fe];if(!ve){ve={batchThisMesh:!t.reuseGeometries};var me=!1;switch(f[ne]){case 0:ve.primitiveName="solid",ve.geometryPositions=l.subarray(v[ne],oe?l.length:v[ne+1]),ve.geometryNormals=u.subarray(g[ne],oe?u.length:g[ne+1]),ve.geometryIndices=c.subarray(_[ne],oe?c.length:_[ne+1]),ve.geometryEdgeIndices=h.subarray(y[ne],oe?h.length:y[ne+1]),me=ve.geometryPositions.length>0&&ve.geometryIndices.length>0;break;case 1:ve.primitiveName="surface",ve.geometryPositions=l.subarray(v[ne],oe?l.length:v[ne+1]),ve.geometryNormals=u.subarray(g[ne],oe?u.length:g[ne+1]),ve.geometryIndices=c.subarray(_[ne],oe?c.length:_[ne+1]),ve.geometryEdgeIndices=h.subarray(y[ne],oe?h.length:y[ne+1]),me=ve.geometryPositions.length>0&&ve.geometryIndices.length>0;break;case 2:ve.primitiveName="points",ve.geometryPositions=l.subarray(v[ne],oe?l.length:v[ne+1]),ve.geometryColors=A.subarray(m[ne],oe?A.length:m[ne+1]),me=ve.geometryPositions.length>0;break;case 3:ve.primitiveName="lines",ve.geometryPositions=l.subarray(v[ne],oe?l.length:v[ne+1]),ve.geometryIndices=c.subarray(_[ne],oe?c.length:_[ne+1]),me=ve.geometryPositions.length>0&&ve.geometryIndices.length>0;break;default:continue}if(me||(ve=null),ve&&(ve.geometryPositions.length,ve.batchThisMesh)){ve.decompressedPositions=new Float32Array(ve.geometryPositions.length),ve.transformedAndRecompressedPositions=new Uint16Array(ve.geometryPositions.length);for(var _e=ve.geometryPositions,ye=ve.decompressedPositions,be=0,we=_e.length;be<we;be+=3)ye[be+0]=_e[be+0]*p[0]+p[12],ye[be+1]=_e[be+1]*p[5]+p[13],ye[be+2]=_e[be+2]*p[10]+p[14];ve.geometryPositions=null,L[fe]=ve}}if(ve)if(ve.batchThisMesh){for(var Be=ve.decompressedPositions,xe=ve.transformedAndRecompressedPositions,Pe=0,Ce=Be.length;Pe<Ce;Pe+=3)ZT[0]=Be[Pe+0],ZT[1]=Be[Pe+1],ZT[2]=Be[Pe+2],ZT[3]=1,le.transformVec4(pe,ZT,JT),ft.compressPosition(JT,U,ZT),xe[Pe+0]=ZT[0],xe[Pe+1]=ZT[1],xe[Pe+2]=ZT[2];r.createMesh(ge.apply(te,{id:he,origin:R,primitive:ve.primitiveName,positionsCompressed:xe,normalsCompressed:ve.geometryNormals,colorsCompressed:ve.geometryColors,indices:ve.geometryIndices,edgeIndices:ve.geometryEdgeIndices,positionsDecodeMatrix:j,color:ae,metallic:Ae,roughness:ce,opacity:ue})),q.push(he)}else z[fe]||(r.createGeometry({id:fe,primitive:ve.primitiveName,positionsCompressed:ve.geometryPositions,normalsCompressed:ve.geometryNormals,colorsCompressed:ve.geometryColors,indices:ve.geometryIndices,edgeIndices:ve.geometryEdgeIndices,positionsDecodeMatrix:p}),z[fe]=!0),r.createMesh(ge.apply(te,{id:he,geometryId:fe,origin:R,matrix:pe,color:ae,metallic:Ae,roughness:ce,opacity:ue})),q.push(he)}else{var Me=void 0,Fe=void 0,ke=void 0,Ee=void 0,Ie=void 0,Te=void 0,De=!1;switch(f[ne]){case 0:Me="solid",Fe=l.subarray(v[ne],oe?l.length:v[ne+1]),ke=u.subarray(g[ne],oe?u.length:g[ne+1]),Ie=c.subarray(_[ne],oe?c.length:_[ne+1]),Te=h.subarray(y[ne],oe?h.length:y[ne+1]),De=Fe.length>0&&Ie.length>0;break;case 1:Me="surface",Fe=l.subarray(v[ne],oe?l.length:v[ne+1]),ke=u.subarray(g[ne],oe?u.length:g[ne+1]),Ie=c.subarray(_[ne],oe?c.length:_[ne+1]),Te=h.subarray(y[ne],oe?h.length:y[ne+1]),De=Fe.length>0&&Ie.length>0;break;case 2:Me="points",Fe=l.subarray(v[ne],oe?l.length:v[ne+1]),Ee=A.subarray(m[ne],oe?A.length:m[ne+1]),De=Fe.length>0;break;case 3:Me="lines",Fe=l.subarray(v[ne],oe?l.length:v[ne+1]),Ie=c.subarray(_[ne],oe?c.length:_[ne+1]),De=Fe.length>0&&Ie.length>0;break;default:continue}De&&(r.createMesh(ge.apply(te,{id:he,origin:R,primitive:Me,positionsCompressed:Fe,normalsCompressed:ke,colorsCompressed:Ee,indices:Ie,edgeIndices:Te,positionsDecodeMatrix:j,color:ae,metallic:Ae,roughness:ce,opacity:ue})),q.push(he))}}q.length>0&&r.createEntity(ge.apply(ee,{id:K,isObject:!0,meshIds:q}))}}}(e,t,a,r,n,s)}},$T=window.pako||gT;$T.inflate||($T=$T.default);var eD=le.vec4(),tD=le.vec4();var iD=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function rD(e,t){var i=[];if(t.length>1)for(var r=0,n=t.length-1;r<n;r++)i.push(t[r]),i.push(t[r+1]);else if(e.length>1)for(var s=0,o=e.length/3-1;s<o;s++)i.push(s),i.push(s+1);return i}!function(){var e=document.createElement("canvas"),t=e.getContext("2d")}();var nD={version:10,parse:function(e,t,i,r,n,s){var o=function(e){var t=0;return{metadata:e[t++],textureData:e[t++],eachTextureDataPortion:e[t++],eachTextureAttributes:e[t++],positions:e[t++],normals:e[t++],colors:e[t++],uvs:e[t++],indices:e[t++],edgeIndices:e[t++],eachTextureSetTextures:e[t++],matrices:e[t++],reusedGeometriesDecodeMatrix:e[t++],eachGeometryPrimitiveType:e[t++],eachGeometryPositionsPortion:e[t++],eachGeometryNormalsPortion:e[t++],eachGeometryColorsPortion:e[t++],eachGeometryUVsPortion:e[t++],eachGeometryIndicesPortion:e[t++],eachGeometryEdgeIndicesPortion:e[t++],eachMeshGeometriesPortion:e[t++],eachMeshMatricesPortion:e[t++],eachMeshTextureSet:e[t++],eachMeshMaterialAttributes:e[t++],eachEntityId:e[t++],eachEntityMeshesPortion:e[t++],eachTileAABB:e[t++],eachTileEntitiesPortion:e[t++]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:$T.inflate(e,t).buffer}return{metadata:JSON.parse($T.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse($T.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);!function(e,t,i,r,n,s){var o=s.getNextId(),a=i.metadata,l=i.textureData,u=i.eachTextureDataPortion,A=i.eachTextureAttributes,c=i.positions,h=i.normals,d=i.colors,p=i.uvs,f=i.indices,v=i.edgeIndices,g=i.eachTextureSetTextures,m=i.matrices,_=i.reusedGeometriesDecodeMatrix,y=i.eachGeometryPrimitiveType,b=i.eachGeometryPositionsPortion,w=i.eachGeometryNormalsPortion,B=i.eachGeometryColorsPortion,x=i.eachGeometryUVsPortion,P=i.eachGeometryIndicesPortion,C=i.eachGeometryEdgeIndicesPortion,M=i.eachMeshGeometriesPortion,F=i.eachMeshMatricesPortion,k=i.eachMeshTextureSet,E=i.eachMeshMaterialAttributes,I=i.eachEntityId,T=i.eachEntityMeshesPortion,D=i.eachTileAABB,S=i.eachTileEntitiesPortion,R=u.length,U=g.length/5,L=b.length,O=M.length,N=T.length,V=S.length;n&&n.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(var Q=0;Q<R;Q++){var H=Q===R-1,G=u[Q],j=H?l.length:u[Q+1],z=j-G>0,W=9*Q,X=1===A[W+0],K=A[W+1];A[W+2],A[W+3];var Z=A[W+4],J=A[W+5],Y=A[W+6],q=A[W+7],$=A[W+8];if(z){var ee=new Uint8Array(l.subarray(G,j)).buffer,te="".concat(o,"-texture-").concat(Q);if(X)r.createTexture({id:te,buffers:[ee],minFilter:Z,magFilter:J,wrapS:Y,wrapT:q,wrapR:$});else{var ie=new Blob([ee],{type:10001===K?"image/jpeg":10002===K?"image/png":"image/gif"}),re=(window.URL||window.webkitURL).createObjectURL(ie),ne=document.createElement("img");ne.src=re,r.createTexture({id:te,image:ne,minFilter:Z,magFilter:J,wrapS:Y,wrapT:q,wrapR:$})}}}for(var se=0;se<U;se++){var oe=5*se,ae="".concat(o,"-textureSet-").concat(se),ue=g[oe+0],Ae=g[oe+1],ce=g[oe+2],he=g[oe+3],de=g[oe+4];r.createTextureSet({id:ae,colorTextureId:ue>=0?"".concat(o,"-texture-").concat(ue):null,normalsTextureId:ce>=0?"".concat(o,"-texture-").concat(ce):null,metallicRoughnessTextureId:Ae>=0?"".concat(o,"-texture-").concat(Ae):null,emissiveTextureId:he>=0?"".concat(o,"-texture-").concat(he):null,occlusionTextureId:de>=0?"".concat(o,"-texture-").concat(de):null})}for(var pe=new Uint32Array(L),fe=0;fe<O;fe++){var ve=M[fe];void 0!==pe[ve]?pe[ve]++:pe[ve]=1}for(var me=le.vec3(),_e=le.AABB3(),ye={},be=0;be<V;be++){var we=be===V-1,Be=S[be],xe=we?N-1:S[be+1]-1,Pe=6*be,Ce=D.subarray(Pe,Pe+6);le.getAABB3Center(Ce,me),_e[0]=Ce[0]-me[0],_e[1]=Ce[1]-me[1],_e[2]=Ce[2]-me[2],_e[3]=Ce[3]-me[0],_e[4]=Ce[4]-me[1],_e[5]=Ce[5]-me[2];for(var Me=ft.createPositionsDecodeMatrix(_e),Fe={},ke=Be;ke<=xe;ke++){var Ee=I[ke],Ie=t.globalizeObjectIds?le.globalizeObjectId(r.id,Ee):Ee,Te=ke===N-1,De=T[ke],Se=Te?M.length-1:T[ke+1]-1,Re=[],Ue=e.metaScene.metaObjects[Ie],Le={},Oe={};if(Ue){if(t.excludeTypesMap&&Ue.type&&t.excludeTypesMap[Ue.type])continue;if(t.includeTypesMap&&Ue.type&&!t.includeTypesMap[Ue.type])continue;if(t.includeIdsMap&&Ue.id&&!t.includeIdsMap[Ue.id])continue;var Ne=t.objectDefaults?t.objectDefaults[Ue.type]||t.objectDefaults.DEFAULT:null;Ne&&(!1===Ne.visible&&(Le.visible=!1),!1===Ne.pickable&&(Le.pickable=!1),Ne.colorize&&(Oe.color=Ne.colorize),void 0!==Ne.opacity&&null!==Ne.opacity&&(Oe.opacity=Ne.opacity),void 0!==Ne.metallic&&null!==Ne.metallic&&(Oe.metallic=Ne.metallic),void 0!==Ne.roughness&&null!==Ne.roughness&&(Oe.roughness=Ne.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var Ve=De;Ve<=Se;Ve++){var Qe=M[Ve],He=pe[Qe]>1,Ge=Qe===L-1,je=k[Ve],ze=je>=0?"".concat(o,"-textureSet-").concat(je):null,We=iD(E.subarray(6*Ve,6*Ve+3)),Xe=E[6*Ve+3]/255,Ke=E[6*Ve+4]/255,Ze=E[6*Ve+5]/255,Je=s.getNextId();if(He){var Ye=F[Ve],qe=m.slice(Ye,Ye+16),$e="".concat(o,"-geometry.").concat(be,".").concat(Qe),et=ye[$e];if(!et){et={batchThisMesh:!t.reuseGeometries};var tt=!1;switch(y[Qe]){case 0:et.primitiveName="solid",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryNormals=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),et.geometryUVs=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),et.geometryEdgeIndices=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 1:et.primitiveName="surface",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryNormals=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),et.geometryUVs=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),et.geometryEdgeIndices=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 2:et.primitiveName="points",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryColors=d.subarray(B[Qe],Ge?d.length:B[Qe+1]),tt=et.geometryPositions.length>0;break;case 3:et.primitiveName="lines",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 4:et.primitiveName="lines",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryIndices=rD(et.geometryPositions,f.subarray(P[Qe],Ge?f.length:P[Qe+1])),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;default:continue}if(tt||(et=null),et&&(et.geometryPositions.length,et.batchThisMesh)){et.decompressedPositions=new Float32Array(et.geometryPositions.length),et.transformedAndRecompressedPositions=new Uint16Array(et.geometryPositions.length);for(var it=et.geometryPositions,rt=et.decompressedPositions,nt=0,st=it.length;nt<st;nt+=3)rt[nt+0]=it[nt+0]*_[0]+_[12],rt[nt+1]=it[nt+1]*_[5]+_[13],rt[nt+2]=it[nt+2]*_[10]+_[14];et.geometryPositions=null,ye[$e]=et}}if(et)if(et.batchThisMesh){for(var ot=et.decompressedPositions,at=et.transformedAndRecompressedPositions,lt=0,ut=ot.length;lt<ut;lt+=3)eD[0]=ot[lt+0],eD[1]=ot[lt+1],eD[2]=ot[lt+2],eD[3]=1,le.transformVec4(qe,eD,tD),ft.compressPosition(tD,_e,eD),at[lt+0]=eD[0],at[lt+1]=eD[1],at[lt+2]=eD[2];r.createMesh(ge.apply(Oe,{id:Je,textureSetId:ze,origin:me,primitive:et.primitiveName,positionsCompressed:at,normalsCompressed:et.geometryNormals,uv:et.geometryUVs,colorsCompressed:et.geometryColors,indices:et.geometryIndices,edgeIndices:et.geometryEdgeIndices,positionsDecodeMatrix:Me,color:We,metallic:Ke,roughness:Ze,opacity:Xe})),Re.push(Je)}else Fe[$e]||(r.createGeometry({id:$e,primitive:et.primitiveName,positionsCompressed:et.geometryPositions,normalsCompressed:et.geometryNormals,uv:et.geometryUVs,colorsCompressed:et.geometryColors,indices:et.geometryIndices,edgeIndices:et.geometryEdgeIndices,positionsDecodeMatrix:_}),Fe[$e]=!0),r.createMesh(ge.apply(Oe,{id:Je,geometryId:$e,textureSetId:ze,matrix:qe,color:We,metallic:Ke,roughness:Ze,opacity:Xe,origin:me})),Re.push(Je)}else{var At=void 0,ct=void 0,ht=void 0,dt=void 0,pt=void 0,vt=void 0,gt=void 0,mt=!1;switch(y[Qe]){case 0:At="solid",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),ht=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),dt=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),gt=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 1:At="surface",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),ht=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),dt=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),gt=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 2:At="points",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),pt=d.subarray(B[Qe],Ge?d.length:B[Qe+1]),mt=ct.length>0;break;case 3:At="lines",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 4:At="lines",vt=rD(ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),f.subarray(P[Qe],Ge?f.length:P[Qe+1])),mt=ct.length>0&&vt.length>0;break;default:continue}mt&&(r.createMesh(ge.apply(Oe,{id:Je,textureSetId:ze,origin:me,primitive:At,positionsCompressed:ct,normalsCompressed:ht,uv:dt&&dt.length>0?dt:null,colorsCompressed:pt,indices:vt,edgeIndices:gt,positionsDecodeMatrix:Me,color:We,metallic:Ke,roughness:Ze,opacity:Xe})),Re.push(Je))}}Re.length>0&&r.createEntity(ge.apply(Le,{id:Ie,isObject:!0,meshIds:Re}))}}}(e,t,a,r,n,s)}},sD=le.vec4(),oD=le.vec4();var aD=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function lD(e,t){var i=[];if(t.length>1)for(var r=0,n=t.length-1;r<n;r++)i.push(t[r]),i.push(t[r+1]);else if(e.length>1)for(var s=0,o=e.length/3-1;s<o;s++)i.push(s),i.push(s+1);return i}!function(){var e=document.createElement("canvas"),t=e.getContext("2d")}();var uD={version:11,parseArrayBuffer:function(e,t,i,r,n,s){var o=function(e){var t,i,r=(t=new ArrayBuffer(2),new Uint16Array(t)[0]=1,1!==new Uint8Array(t)[0]),n=function(){var t=0,i=new DataView(e);return function(n){var s=1+2*t++,o=i.getUint32(4*s,!0),a=i.getUint32(4*(s+1),!0),l=n.BYTES_PER_ELEMENT;if(r&&l>1)for(var u=new Uint8Array(e,o,a),A=l/2,c=u.length/l,h=0;h<c;h++)for(var d=h*l,p=0;p<A;p++){var f=d+p,v=d-p+l-1,g=u[f];u[f]=u[v],u[v]=g}return new n(e,o,a/l)}}(),s=(i=new TextDecoder,function(){return JSON.parse(i.decode(n(Uint8Array)))});return{metadata:s(),textureData:n(Uint8Array),eachTextureDataPortion:n(Uint32Array),eachTextureAttributes:n(Uint16Array),positions:n(Uint16Array),normals:n(Int8Array),colors:n(Uint8Array),uvs:n(Float32Array),indices:n(Uint32Array),edgeIndices:n(Uint32Array),eachTextureSetTextures:n(Int32Array),matrices:n(Float32Array),reusedGeometriesDecodeMatrix:n(Float32Array),eachGeometryPrimitiveType:n(Uint8Array),eachGeometryPositionsPortion:n(Uint32Array),eachGeometryNormalsPortion:n(Uint32Array),eachGeometryColorsPortion:n(Uint32Array),eachGeometryUVsPortion:n(Uint32Array),eachGeometryIndicesPortion:n(Uint32Array),eachGeometryEdgeIndicesPortion:n(Uint32Array),eachMeshGeometriesPortion:n(Uint32Array),eachMeshMatricesPortion:n(Uint32Array),eachMeshTextureSet:n(Int32Array),eachMeshMaterialAttributes:n(Uint8Array),eachEntityId:s(),eachEntityMeshesPortion:n(Uint32Array),eachTileAABB:n(Float64Array),eachTileEntitiesPortion:n(Uint32Array)}}(i);!function(e,t,i,r,n,s){var o=s.getNextId(),a=i.metadata,l=i.textureData,u=i.eachTextureDataPortion,A=i.eachTextureAttributes,c=i.positions,h=i.normals,d=i.colors,p=i.uvs,f=i.indices,v=i.edgeIndices,g=i.eachTextureSetTextures,m=i.matrices,_=i.reusedGeometriesDecodeMatrix,y=i.eachGeometryPrimitiveType,b=i.eachGeometryPositionsPortion,w=i.eachGeometryNormalsPortion,B=i.eachGeometryColorsPortion,x=i.eachGeometryUVsPortion,P=i.eachGeometryIndicesPortion,C=i.eachGeometryEdgeIndicesPortion,M=i.eachMeshGeometriesPortion,F=i.eachMeshMatricesPortion,k=i.eachMeshTextureSet,E=i.eachMeshMaterialAttributes,I=i.eachEntityId,T=i.eachEntityMeshesPortion,D=i.eachTileAABB,S=i.eachTileEntitiesPortion,R=u.length,U=g.length/5,L=b.length,O=M.length,N=T.length,V=S.length;n&&n.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(var Q=0;Q<R;Q++){var H=Q===R-1,G=u[Q],j=H?l.length:u[Q+1],z=j-G>0,W=9*Q,X=1===A[W+0],K=A[W+1];A[W+2],A[W+3];var Z=A[W+4],J=A[W+5],Y=A[W+6],q=A[W+7],$=A[W+8];if(z){var ee=new Uint8Array(l.subarray(G,j)).buffer,te="".concat(o,"-texture-").concat(Q);if(X)r.createTexture({id:te,buffers:[ee],minFilter:Z,magFilter:J,wrapS:Y,wrapT:q,wrapR:$});else{var ie=new Blob([ee],{type:10001===K?"image/jpeg":10002===K?"image/png":"image/gif"}),re=(window.URL||window.webkitURL).createObjectURL(ie),ne=document.createElement("img");ne.src=re,r.createTexture({id:te,image:ne,minFilter:Z,magFilter:J,wrapS:Y,wrapT:q,wrapR:$})}}}for(var se=0;se<U;se++){var oe=5*se,ae="".concat(o,"-textureSet-").concat(se),ue=g[oe+0],Ae=g[oe+1],ce=g[oe+2],he=g[oe+3],de=g[oe+4];r.createTextureSet({id:ae,colorTextureId:ue>=0?"".concat(o,"-texture-").concat(ue):null,normalsTextureId:ce>=0?"".concat(o,"-texture-").concat(ce):null,metallicRoughnessTextureId:Ae>=0?"".concat(o,"-texture-").concat(Ae):null,emissiveTextureId:he>=0?"".concat(o,"-texture-").concat(he):null,occlusionTextureId:de>=0?"".concat(o,"-texture-").concat(de):null})}for(var pe=new Uint32Array(L),fe=0;fe<O;fe++){var ve=M[fe];void 0!==pe[ve]?pe[ve]++:pe[ve]=1}for(var me=le.vec3(),_e=le.AABB3(),ye={},be=0;be<V;be++){var we=be===V-1,Be=S[be],xe=we?N-1:S[be+1]-1,Pe=6*be,Ce=D.subarray(Pe,Pe+6);le.getAABB3Center(Ce,me),_e[0]=Ce[0]-me[0],_e[1]=Ce[1]-me[1],_e[2]=Ce[2]-me[2],_e[3]=Ce[3]-me[0],_e[4]=Ce[4]-me[1],_e[5]=Ce[5]-me[2];for(var Me=ft.createPositionsDecodeMatrix(_e),Fe={},ke=Be;ke<=xe;ke++){var Ee=I[ke],Ie=t.globalizeObjectIds?le.globalizeObjectId(r.id,Ee):Ee,Te=ke===N-1,De=T[ke],Se=Te?M.length-1:T[ke+1]-1,Re=[],Ue=e.metaScene.metaObjects[Ie],Le={},Oe={};if(Ue){if(t.excludeTypesMap&&Ue.type&&t.excludeTypesMap[Ue.type])continue;if(t.includeTypesMap&&Ue.type&&!t.includeTypesMap[Ue.type])continue;if(t.includeIdsMap&&Ue.id&&!t.includeIdsMap[Ue.id])continue;var Ne=t.objectDefaults?t.objectDefaults[Ue.type]||t.objectDefaults.DEFAULT:null;Ne&&(!1===Ne.visible&&(Le.visible=!1),!1===Ne.pickable&&(Le.pickable=!1),Ne.colorize&&(Oe.color=Ne.colorize),void 0!==Ne.opacity&&null!==Ne.opacity&&(Oe.opacity=Ne.opacity),void 0!==Ne.metallic&&null!==Ne.metallic&&(Oe.metallic=Ne.metallic),void 0!==Ne.roughness&&null!==Ne.roughness&&(Oe.roughness=Ne.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var Ve=De;Ve<=Se;Ve++){var Qe=M[Ve],He=pe[Qe]>1,Ge=Qe===L-1,je=k[Ve],ze=je>=0?"".concat(o,"-textureSet-").concat(je):null,We=aD(E.subarray(6*Ve,6*Ve+3)),Xe=E[6*Ve+3]/255,Ke=E[6*Ve+4]/255,Ze=E[6*Ve+5]/255,Je=s.getNextId();if(He){var Ye=F[Ve],qe=m.slice(Ye,Ye+16),$e="".concat(o,"-geometry.").concat(be,".").concat(Qe),et=ye[$e];if(!et){et={batchThisMesh:!t.reuseGeometries};var tt=!1;switch(y[Qe]){case 0:et.primitiveName="solid",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryNormals=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),et.geometryUVs=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),et.geometryEdgeIndices=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 1:et.primitiveName="surface",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryNormals=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),et.geometryUVs=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),et.geometryEdgeIndices=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 2:et.primitiveName="points",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryColors=d.subarray(B[Qe],Ge?d.length:B[Qe+1]),tt=et.geometryPositions.length>0;break;case 3:et.primitiveName="lines",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryIndices=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;case 4:et.primitiveName="lines",et.geometryPositions=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),et.geometryIndices=lD(et.geometryPositions,f.subarray(P[Qe],Ge?f.length:P[Qe+1])),tt=et.geometryPositions.length>0&&et.geometryIndices.length>0;break;default:continue}if(tt||(et=null),et&&(et.geometryPositions.length,et.batchThisMesh)){et.decompressedPositions=new Float32Array(et.geometryPositions.length),et.transformedAndRecompressedPositions=new Uint16Array(et.geometryPositions.length);for(var it=et.geometryPositions,rt=et.decompressedPositions,nt=0,st=it.length;nt<st;nt+=3)rt[nt+0]=it[nt+0]*_[0]+_[12],rt[nt+1]=it[nt+1]*_[5]+_[13],rt[nt+2]=it[nt+2]*_[10]+_[14];et.geometryPositions=null,ye[$e]=et}}if(et)if(et.batchThisMesh){for(var ot=et.decompressedPositions,at=et.transformedAndRecompressedPositions,lt=0,ut=ot.length;lt<ut;lt+=3)sD[0]=ot[lt+0],sD[1]=ot[lt+1],sD[2]=ot[lt+2],sD[3]=1,le.transformVec4(qe,sD,oD),ft.compressPosition(oD,_e,sD),at[lt+0]=sD[0],at[lt+1]=sD[1],at[lt+2]=sD[2];r.createMesh(ge.apply(Oe,{id:Je,textureSetId:ze,origin:me,primitive:et.primitiveName,positionsCompressed:at,normalsCompressed:et.geometryNormals,uv:et.geometryUVs,colorsCompressed:et.geometryColors,indices:et.geometryIndices,edgeIndices:et.geometryEdgeIndices,positionsDecodeMatrix:Me,color:We,metallic:Ke,roughness:Ze,opacity:Xe})),Re.push(Je)}else Fe[$e]||(r.createGeometry({id:$e,primitive:et.primitiveName,positionsCompressed:et.geometryPositions,normalsCompressed:et.geometryNormals,uv:et.geometryUVs,colorsCompressed:et.geometryColors,indices:et.geometryIndices,edgeIndices:et.geometryEdgeIndices,positionsDecodeMatrix:_}),Fe[$e]=!0),r.createMesh(ge.apply(Oe,{id:Je,geometryId:$e,textureSetId:ze,matrix:qe,color:We,metallic:Ke,roughness:Ze,opacity:Xe,origin:me})),Re.push(Je)}else{var At=void 0,ct=void 0,ht=void 0,dt=void 0,pt=void 0,vt=void 0,gt=void 0,mt=!1;switch(y[Qe]){case 0:At="solid",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),ht=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),dt=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),gt=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 1:At="surface",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),ht=h.subarray(w[Qe],Ge?h.length:w[Qe+1]),dt=p.subarray(x[Qe],Ge?p.length:x[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),gt=v.subarray(C[Qe],Ge?v.length:C[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 2:At="points",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),pt=d.subarray(B[Qe],Ge?d.length:B[Qe+1]),mt=ct.length>0;break;case 3:At="lines",ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),vt=f.subarray(P[Qe],Ge?f.length:P[Qe+1]),mt=ct.length>0&&vt.length>0;break;case 4:At="lines",vt=lD(ct=c.subarray(b[Qe],Ge?c.length:b[Qe+1]),f.subarray(P[Qe],Ge?f.length:P[Qe+1])),mt=ct.length>0&&vt.length>0;break;default:continue}mt&&(r.createMesh(ge.apply(Oe,{id:Je,textureSetId:ze,origin:me,primitive:At,positionsCompressed:ct,normalsCompressed:ht,uv:dt&&dt.length>0?dt:null,colorsCompressed:pt,indices:vt,edgeIndices:gt,positionsDecodeMatrix:Me,color:We,metallic:Ke,roughness:Ze,opacity:Xe})),Re.push(Je))}}Re.length>0&&r.createEntity(ge.apply(Le,{id:Ie,isObject:!0,meshIds:Re}))}}}(e,t,o,r,n,s)}},AD=window.pako||gT;AD.inflate||(AD=AD.default);var cD=le.vec4(),hD=le.vec4();var dD=function(){var e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function pD(e,t,i,r,n,s){var o=s.getNextId(),a=i.metadata,l=i.textureData,u=i.eachTextureDataPortion,A=i.eachTextureAttributes,c=i.positions,d=i.normals,p=i.colors,f=i.uvs,v=i.indices,g=i.edgeIndices,m=i.eachTextureSetTextures,_=i.matrices,y=i.reusedGeometriesDecodeMatrix,b=i.eachGeometryPrimitiveType,w=i.eachGeometryAxisLabel,B=i.eachGeometryPositionsPortion,x=i.eachGeometryNormalsPortion,P=i.eachGeometryColorsPortion,C=i.eachGeometryUVsPortion,M=i.eachGeometryIndicesPortion,F=i.eachGeometryEdgeIndicesPortion,k=i.eachMeshGeometriesPortion,E=i.eachMeshMatricesPortion,I=i.eachMeshTextureSet,T=i.eachMeshMaterialAttributes,D=i.eachEntityId,S=i.eachEntityMeshesPortion,R=i.eachTileAABB,U=i.eachTileEntitiesPortion,L=u.length,O=m.length/5,N=B.length,V=k.length,Q=S.length,H=U.length;n&&n.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(var G=0;G<L;G++){var j=G===L-1,z=u[G],W=j?l.length:u[G+1],X=W-z>0,K=9*G,Z=1===A[K+0],J=A[K+1];A[K+2],A[K+3];var Y=A[K+4],q=A[K+5],$=A[K+6],ee=A[K+7],te=A[K+8];if(X){var ie=new Uint8Array(l.subarray(z,W)).buffer,re="".concat(o,"-texture-").concat(G);if(Z)r.createTexture({id:re,buffers:[ie],minFilter:Y,magFilter:q,wrapS:$,wrapT:ee,wrapR:te});else{var ne=new Blob([ie],{type:10001===J?"image/jpeg":10002===J?"image/png":"image/gif"}),se=(window.URL||window.webkitURL).createObjectURL(ne),oe=document.createElement("img");oe.src=se,r.createTexture({id:re,image:oe,minFilter:Y,magFilter:q,wrapS:$,wrapT:ee,wrapR:te})}}}for(var ae=0;ae<O;ae++){var ue=5*ae,Ae="".concat(o,"-textureSet-").concat(ae),ce=m[ue+0],he=m[ue+1],de=m[ue+2],pe=m[ue+3],fe=m[ue+4];r.createTextureSet({id:Ae,colorTextureId:ce>=0?"".concat(o,"-texture-").concat(ce):null,normalsTextureId:de>=0?"".concat(o,"-texture-").concat(de):null,metallicRoughnessTextureId:he>=0?"".concat(o,"-texture-").concat(he):null,emissiveTextureId:pe>=0?"".concat(o,"-texture-").concat(pe):null,occlusionTextureId:fe>=0?"".concat(o,"-texture-").concat(fe):null})}for(var ve=new Uint32Array(N),me=0;me<V;me++){var _e=k[me];void 0!==ve[_e]?ve[_e]++:ve[_e]=1}for(var ye=le.vec3(),be=le.AABB3(),we={},Be=0;Be<H;Be++){var xe=Be===H-1,Pe=U[Be],Ce=xe?Q-1:U[Be+1]-1,Me=6*Be,Fe=R.subarray(Me,Me+6);le.getAABB3Center(Fe,ye),be[0]=Fe[0]-ye[0],be[1]=Fe[1]-ye[1],be[2]=Fe[2]-ye[2],be[3]=Fe[3]-ye[0],be[4]=Fe[4]-ye[1],be[5]=Fe[5]-ye[2];for(var ke=ft.createPositionsDecodeMatrix(be),Ee={},Ie=Pe;Ie<=Ce;Ie++){var Te=D[Ie],De=t.globalizeObjectIds?le.globalizeObjectId(r.id,Te):Te,Se=Ie===Q-1,Re=S[Ie],Ue=Se?k.length-1:S[Ie+1]-1,Le=[],Oe=e.metaScene.metaObjects[De],Ne={},Ve={};if(Oe){if(t.excludeTypesMap&&Oe.type&&t.excludeTypesMap[Oe.type])continue;if(t.includeTypesMap&&Oe.type&&!t.includeTypesMap[Oe.type])continue;if(t.includeIdsMap&&Oe.id&&!t.includeIdsMap[Oe.id])continue;var Qe=t.objectDefaults?t.objectDefaults[Oe.type]||t.objectDefaults.DEFAULT:null;Qe&&(!1===Qe.visible&&(Ne.visible=!1),!1===Qe.pickable&&(Ne.pickable=!1),Qe.colorize&&(Ve.color=Qe.colorize),void 0!==Qe.opacity&&null!==Qe.opacity&&(Ve.opacity=Qe.opacity),void 0!==Qe.metallic&&null!==Qe.metallic&&(Ve.metallic=Qe.metallic),void 0!==Qe.roughness&&null!==Qe.roughness&&(Ve.roughness=Qe.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(var He=Re;He<=Ue;He++){var Ge=k[He],je=ve[Ge]>1,ze=Ge===N-1,We=I[He],Xe=We>=0?"".concat(o,"-textureSet-").concat(We):null,Ke=dD(T.subarray(6*He,6*He+3)),Ze=T[6*He+3]/255,Je=T[6*He+4]/255,Ye=T[6*He+5]/255,qe=s.getNextId();if(je){var $e=E[He],et=_.slice($e,$e+16),tt="".concat(o,"-geometry.").concat(Be,".").concat(Ge),it=we[tt];if(!it){it={batchThisMesh:!t.reuseGeometries};var rt=b[Ge],nt=w[Ge],st=!1,ot=void 0;switch(rt){case 0:it.primitiveName="solid",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.geometryNormals=d.subarray(x[Ge],ze?d.length:x[Ge+1]),it.geometryUVs=f.subarray(C[Ge],ze?f.length:C[Ge+1]),it.geometryIndices=v.subarray(M[Ge],ze?v.length:M[Ge+1]),it.geometryEdgeIndices=g.subarray(F[Ge],ze?g.length:F[Ge+1]),st=it.geometryPositions.length>0&&it.geometryIndices.length>0;break;case 1:it.primitiveName="surface",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.geometryNormals=d.subarray(x[Ge],ze?d.length:x[Ge+1]),it.geometryUVs=f.subarray(C[Ge],ze?f.length:C[Ge+1]),it.geometryIndices=v.subarray(M[Ge],ze?v.length:M[Ge+1]),it.geometryEdgeIndices=g.subarray(F[Ge],ze?g.length:F[Ge+1]),st=it.geometryPositions.length>0&&it.geometryIndices.length>0;break;case 2:it.primitiveName="points",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.geometryColors=p.subarray(P[Ge],ze?p.length:P[Ge+1]),st=it.geometryPositions.length>0;break;case 3:it.primitiveName="lines",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.geometryIndices=v.subarray(M[Ge],ze?v.length:M[Ge+1]),st=it.geometryPositions.length>0&&it.geometryIndices.length>0;break;case 4:it.primitiveName="lines",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.geometryIndices=fD(it.geometryPositions,v.subarray(M[Ge],ze?v.length:M[Ge+1])),st=it.geometryPositions.length>0&&it.geometryIndices.length>0;break;case 7:it.primitiveName="lines",it.geometryPositions=c.subarray(B[Ge],ze?c.length:B[Ge+1]),it.decompressedPositions=ft.decompressPositions(it.geometryPositions,y),ot=St({origin:it.decompressedPositions,text:nt,size:2}),it.decompressedPositions=ot.positions,it.geometryIndices=ot.indices,it.geometryPositions=null,st=it.decompressedPositions.length>0&&it.geometryIndices.length>0;break;default:continue}if(st||(it=null),it&&(it.geometryPositions&&it.geometryPositions.length,it.batchThisMesh)){if(7===rt)it.transformedAndRecompressedPositions=new Uint16Array(it.decompressedPositions.length);else{it.decompressedPositions=new Float32Array(it.geometryPositions.length),it.transformedAndRecompressedPositions=new Uint16Array(it.geometryPositions.length);for(var at=it.geometryPositions,lt=it.decompressedPositions,ut=0,At=at.length;ut<At;ut+=3)lt[ut+0]=at[ut+0]*y[0]+y[12],lt[ut+1]=at[ut+1]*y[5]+y[13],lt[ut+2]=at[ut+2]*y[10]+y[14];it.geometryPositions=null}we[tt]=it}}if(it)if(it.batchThisMesh){for(var ct=it.decompressedPositions,ht=it.transformedAndRecompressedPositions,dt=0,pt=ct.length;dt<pt;dt+=3)cD[0]=ct[dt+0],cD[1]=ct[dt+1],cD[2]=ct[dt+2],cD[3]=1,le.transformVec4(et,cD,hD),ft.compressPosition(hD,be,cD),ht[dt+0]=cD[0],ht[dt+1]=cD[1],ht[dt+2]=cD[2];r.createMesh(ge.apply(Ve,{id:qe,textureSetId:Xe,origin:ye,primitive:it.primitiveName,positionsCompressed:ht,normalsCompressed:it.geometryNormals,uv:it.geometryUVs,colorsCompressed:it.geometryColors,indices:it.geometryIndices,edgeIndices:it.geometryEdgeIndices,positionsDecodeMatrix:ke,color:Ke,metallic:Je,roughness:Ye,opacity:Ze})),Le.push(qe)}else{if(!Ee[tt]){var vt={id:tt,primitive:it.primitiveName,normalsCompressed:it.geometryNormals,uv:it.geometryUVs,colorsCompressed:it.geometryColors,indices:it.geometryIndices,edgeIndices:it.geometryEdgeIndices};vt=it.geometryPositions?h(h({},vt),{},{positionsCompressed:it.geometryPositions,positionsDecodeMatrix:y}):h(h({},vt),{},{positions:it.decompressedPositions}),r.createGeometry(vt),Ee[tt]=!0}r.createMesh(ge.apply(Ve,{id:qe,geometryId:tt,textureSetId:Xe,matrix:et,color:Ke,metallic:Je,roughness:Ye,opacity:Ze,origin:ye})),Le.push(qe)}}else{var gt=b[Ge],mt=w[Ge],_t=void 0,yt=void 0,bt=void 0,wt=void 0,Bt=void 0,xt=void 0,Pt=void 0,Ct=!1,Mt=void 0;switch(gt){case 0:_t="solid",yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),bt=d.subarray(x[Ge],ze?d.length:x[Ge+1]),wt=f.subarray(C[Ge],ze?f.length:C[Ge+1]),xt=v.subarray(M[Ge],ze?v.length:M[Ge+1]),Pt=g.subarray(F[Ge],ze?g.length:F[Ge+1]),Ct=yt.length>0&&xt.length>0;break;case 1:_t="surface",yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),bt=d.subarray(x[Ge],ze?d.length:x[Ge+1]),wt=f.subarray(C[Ge],ze?f.length:C[Ge+1]),xt=v.subarray(M[Ge],ze?v.length:M[Ge+1]),Pt=g.subarray(F[Ge],ze?g.length:F[Ge+1]),Ct=yt.length>0&&xt.length>0;break;case 2:_t="points",yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),Bt=p.subarray(P[Ge],ze?p.length:P[Ge+1]),Ct=yt.length>0;break;case 3:_t="lines",yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),xt=v.subarray(M[Ge],ze?v.length:M[Ge+1]),Ct=yt.length>0&&xt.length>0;break;case 4:_t="lines",xt=fD(yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),v.subarray(M[Ge],ze?v.length:M[Ge+1])),Ct=yt.length>0&&xt.length>0;break;case 7:_t="lines",yt=c.subarray(B[Ge],ze?c.length:B[Ge+1]),yt=(Mt=St({origin:yt=ft.decompressPositions(yt,ke),text:mt,size:2})).positions,xt=Mt.indices,Ct=yt.length>0&&xt.length>0;break;default:continue}if(Ct){var Ft=ge.apply(Ve,{id:qe,textureSetId:Xe,origin:ye,primitive:_t,normalsCompressed:bt,uv:wt&&wt.length>0?wt:null,colorsCompressed:Bt,indices:xt,edgeIndices:Pt,color:Ke,metallic:Je,roughness:Ye,opacity:Ze});Ft=h(h({},Ft),{},7!==gt?{positionsCompressed:yt,positionsDecodeMatrix:ke}:{positions:yt}),r.createMesh(Ft),Le.push(qe)}}}Le.length>0&&r.createEntity(ge.apply(Ne,{id:De,isObject:!0,meshIds:Le}))}}}function fD(e,t){var i=[];if(t.length>1)for(var r=0,n=t.length-1;r<n;r++)i.push(t[r]),i.push(t[r+1]);else if(e.length>1)for(var s=0,o=e.length/3-1;s<o;s++)i.push(s),i.push(s+1);return i}!function(){var e=document.createElement("canvas"),t=e.getContext("2d")}();var vD={version:12,parseArrayBuffer:function(e,t,i,r,n,s){var o=function(e){var t,i,r=(t=new ArrayBuffer(2),new Uint16Array(t)[0]=1,1!==new Uint8Array(t)[0]),n=function(){var t=0,i=new DataView(e);return function(n){var s=1+2*t++,o=i.getUint32(4*s,!0),a=i.getUint32(4*(s+1),!0),l=n.BYTES_PER_ELEMENT;if(r&&l>1)for(var u=new Uint8Array(e,o,a),A=l/2,c=u.length/l,h=0;h<c;h++)for(var d=h*l,p=0;p<A;p++){var f=d+p,v=d-p+l-1,g=u[f];u[f]=u[v],u[v]=g}return new n(e,o,a/l)}}(),s=(i=new TextDecoder,function(){return JSON.parse(i.decode(n(Uint8Array)))});return{metadata:s(),textureData:n(Uint8Array),eachTextureDataPortion:n(Uint32Array),eachTextureAttributes:n(Uint16Array),positions:n(Uint16Array),normals:n(Int8Array),colors:n(Uint8Array),uvs:n(Float32Array),indices:n(Uint32Array),edgeIndices:n(Uint32Array),eachTextureSetTextures:n(Int32Array),matrices:n(Float32Array),reusedGeometriesDecodeMatrix:n(Float32Array),eachGeometryPrimitiveType:n(Uint8Array),eachGeometryAxisLabel:s(),eachGeometryPositionsPortion:n(Uint32Array),eachGeometryNormalsPortion:n(Uint32Array),eachGeometryColorsPortion:n(Uint32Array),eachGeometryUVsPortion:n(Uint32Array),eachGeometryIndicesPortion:n(Uint32Array),eachGeometryEdgeIndicesPortion:n(Uint32Array),eachMeshGeometriesPortion:n(Uint32Array),eachMeshMatricesPortion:n(Uint32Array),eachMeshTextureSet:n(Int32Array),eachMeshMaterialAttributes:n(Uint8Array),eachEntityId:s(),eachEntityMeshesPortion:n(Uint32Array),eachTileAABB:n(Float64Array),eachTileEntitiesPortion:n(Uint32Array)}}(i);pD(e,t,o,r,n,s)},parse:function(e,t,i,r,n,s){var o=function(e){var t=0;return{metadata:e[t++],textureData:e[t++],eachTextureDataPortion:e[t++],eachTextureAttributes:e[t++],positions:e[t++],normals:e[t++],colors:e[t++],uvs:e[t++],indices:e[t++],edgeIndices:e[t++],eachTextureSetTextures:e[t++],matrices:e[t++],reusedGeometriesDecodeMatrix:e[t++],eachGeometryPrimitiveType:e[t++],eachGeometryAxisLabel:e[t++],eachGeometryPositionsPortion:e[t++],eachGeometryNormalsPortion:e[t++],eachGeometryColorsPortion:e[t++],eachGeometryUVsPortion:e[t++],eachGeometryIndicesPortion:e[t++],eachGeometryEdgeIndicesPortion:e[t++],eachMeshGeometriesPortion:e[t++],eachMeshMatricesPortion:e[t++],eachMeshTextureSet:e[t++],eachMeshMaterialAttributes:e[t++],eachEntityId:e[t++],eachEntityMeshesPortion:e[t++],eachTileAABB:e[t++],eachTileEntitiesPortion:e[t++]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:AD.inflate(e,t).buffer}return{metadata:JSON.parse(AD.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryAxisLabel:JSON.parse(AD.inflate(e.eachGeometryAxisLabel,{to:"string"})),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(AD.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(o);pD(e,t,a,r,n,s)}},gD={};gD[bT.version]=bT,gD[xT.version]=xT,gD[MT.version]=MT,gD[ET.version]=ET,gD[DT.version]=DT,gD[LT.version]=LT,gD[QT.version]=QT,gD[XT.version]=XT,gD[qT.version]=qT,gD[nD.version]=nD,gD[uD.version]=uD,gD[vD.version]=vD;var mD=function(e){m(r,vh);var t,i=y(r);function r(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,r),(t=i.call(this,"XKTLoader",e,n))._maxGeometryBatchSize=n.maxGeometryBatchSize,t.textureTranscoder=n.textureTranscoder,t.dataSource=n.dataSource,t.objectDefaults=n.objectDefaults,t.includeTypes=n.includeTypes,t.excludeTypes=n.excludeTypes,t.excludeUnclassifiedObjects=n.excludeUnclassifiedObjects,t.reuseGeometries=n.reuseGeometries,t}return I(r,[{key:"supportedVersions",get:function(){return Object.keys(gD)}},{key:"textureTranscoder",get:function(){return this._textureTranscoder},set:function(e){this._textureTranscoder=e}},{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new vT}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||vI}},{key:"includeTypes",get:function(){return this._includeTypes},set:function(e){this._includeTypes=e}},{key:"excludeTypes",get:function(){return this._excludeTypes},set:function(e){this._excludeTypes=e}},{key:"includeIds",get:function(){return this._includeIds},set:function(e){this._includeIds=e}},{key:"excludeUnclassifiedObjects",get:function(){return this._excludeUnclassifiedObjects},set:function(e){this._excludeUnclassifiedObjects=!!e}},{key:"globalizeObjectIds",get:function(){return this._globalizeObjectIds},set:function(e){this._globalizeObjectIds=!!e}},{key:"reuseGeometries",get:function(){return this._reuseGeometries},set:function(e){this._reuseGeometries=!1!==e}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id),!(t.src||t.xkt||t.manifestSrc||t.manifest))throw new Error("XKTLoaderPlugin: load() param expected: src, xkt, manifestSrc or manifestData");var i={},r=t.includeTypes||this._includeTypes,n=t.excludeTypes||this._excludeTypes,s=t.includeIds||this._includeIds,o=t.objectDefaults||this._objectDefaults;if(i.reuseGeometries=null!==t.reuseGeometries&&void 0!==t.reuseGeometries?t.reuseGeometries:!1!==this._reuseGeometries,r){i.includeTypesMap={};for(var a=0,l=r.length;a<l;a++)i.includeTypesMap[r[a]]=!0}if(n){i.excludeTypesMap={};for(var u=0,A=n.length;u<A;u++)i.excludeTypesMap[n[u]]=!0}if(s){i.includeIdsMap={};for(var c=0,h=s.length;c<h;c++)i.includeIdsMap[s[c]]=!0}o&&(i.objectDefaults=o),i.excludeUnclassifiedObjects=void 0!==t.excludeUnclassifiedObjects?!!t.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,i.globalizeObjectIds=void 0!==t.globalizeObjectIds&&null!==t.globalizeObjectIds?!!t.globalizeObjectIds:this._globalizeObjectIds;var d=new Sc(this.viewer.scene,ge.apply(t,{isModel:!0,textureTranscoder:this._textureTranscoder,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:t.origin,disableVertexWelding:t.disableVertexWelding||!1,disableIndexRebucketing:t.disableIndexRebucketing||!1,dtxEnabled:t.dtxEnabled,renderOrder:t.renderOrder})),p=d.id,f=new Np({metaScene:this.viewer.metaScene,id:p});this.viewer.scene.canvas.spinner.processes++;var v=function(){d.destroyed||(d.finalize(),f.finalize(),e.viewer.scene.canvas.spinner.processes--,d.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(f.id)})),e.scheduleTask((function(){d.destroyed||(d.scene.fire("modelLoaded",d.id),d.fire("loaded",!0,!1))})))},g=function(t){e.viewer.scene.canvas.spinner.processes--,e.error(t),d.fire("error",t)},m=0,_={getNextId:function(){return"".concat(p,".").concat(m++)}};if(t.metaModelSrc||t.metaModelData)if(t.metaModelSrc){var y=t.metaModelSrc;this._dataSource.getMetaModel(y,(function(s){d.destroyed||(f.loadData(s,{includeTypes:r,excludeTypes:n,globalizeObjectIds:i.globalizeObjectIds}),t.src?e._loadModel(t.src,i,d,null,_,v,g):(e._parseModel(t.xkt,i,d,null,_),v()))}),(function(e){g("load(): Failed to load model metadata for model '".concat(p," from  '").concat(y,"' - ").concat(e))}))}else t.metaModelData&&(f.loadData(t.metaModelData,{includeTypes:r,excludeTypes:n,globalizeObjectIds:i.globalizeObjectIds}),t.src?this._loadModel(t.src,i,d,null,_,v,g):(this._parseModel(t.xkt,i,d,null,_),v()));else if(t.src)this._loadModel(t.src,i,d,f,_,v,g);else if(t.xkt)this._parseModel(t.xkt,i,d,f,_),v();else if(t.manifestSrc||t.manifest){var b=t.manifestSrc?_D(t.manifestSrc):"",w=function(t,s,o){var a=0;!function l(){d.destroyed||a>=t.length?s():e._dataSource.getMetaModel("".concat(b).concat(t[a]),(function(t){f.loadData(t,{includeTypes:r,excludeTypes:n,globalizeObjectIds:i.globalizeObjectIds}),a++,e.scheduleTask(l,200)}),o)}()},B=function(t,r,n){var s=0;!function o(){d.destroyed||s>=t.length?r():e._dataSource.getXKT("".concat(b).concat(t[s]),(function(t){e._parseModel(t,i,d,null,_),d.preFinalize(),s++,e.scheduleTask(o,200)}),n)}()},x=function(t,r,n){var s=0;!function o(){d.destroyed||s>=t.length?r():e._dataSource.getXKT("".concat(b).concat(t[s]),(function(t){e._parseModel(t,i,d,f,_),d.preFinalize(),s++,e.scheduleTask(o,200)}),n)}()};if(t.manifest){var P=t.manifest,C=P.xktFiles;if(!C||0===C.length)return void g("load(): Failed to load model manifest - manifest not valid");var M=P.metaModelFiles;M?w(M,(function(){B(C,v,g)}),g):x(C,v,g)}else this._dataSource.getManifest(t.manifestSrc,(function(e){if(!d.destroyed){var t=e.xktFiles;if(t&&0!==t.length){var i=e.metaModelFiles;i?w(i,(function(){B(t,v,g)}),g):x(t,v,g)}else g("load(): Failed to load model manifest - manifest not valid")}}),g)}return d}},{key:"_loadModel",value:function(e,t,i,r,n,s,o){var a=this;this._dataSource.getXKT(e,(function(e){a._parseModel(e,t,i,r,n),i.preFinalize(),s()}),o)}},{key:"_parseModel",value:(t=A(l().mark((function e(t,i,r,n,s){var o,a,u,A,c,h,d,p,f,v,g;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.destroyed){e.next=2;break}return e.abrupt("return");case 2:if(o=new DataView(t),a=new Uint8Array(t),u=o.getUint32(0,!0),c=(A=2147483647&u)<11||A>=12&&u>>>31,h=gD[A]){e.next=11;break}return this.error("Unsupported .XKT file version: "+A+" - this XKTLoaderPlugin supports versions "+Object.keys(gD)),e.abrupt("return");case 11:if(c){e.next=14;break}return h.parseArrayBuffer(this.viewer,i,t,r,n,s),e.abrupt("return");case 14:for(d=o.getUint32(4,!0),p=[],f=4*(d+2),v=0;v<d;v++)g=o.getUint32(4*(v+2),!0),p.push(a.subarray(f,f+g)),f+=g;h.parse(this.viewer,i,p,r,n,s);case 19:case"end":return e.stop()}}),e,this)}))),function(e,i,r,n,s){return t.apply(this,arguments)})}]),r}();function _D(e){e.indexOf("?")>-1&&(e=e.split("?")[0]);var t=e.split("/");return t.pop(),t.join("/")+"/"}var yD={};!function(e){var t,i="File format is not recognized.",r="Error while reading zip file.",n="Error while reading file data.",s=524288,o="text/plain";try{t=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function a(){this.crc=-1}function l(){}function u(e,t){var i,r;return i=new ArrayBuffer(e),r=new Uint8Array(i),t&&r.set(t,0),{buffer:i,array:r,view:new DataView(i)}}function A(){}function c(e){var t,i=this;i.size=0,i.init=function(r,n){var s=new Blob([e],{type:o});(t=new d(s)).init((function(){i.size=t.size,r()}),n)},i.readUint8Array=function(e,i,r,n){t.readUint8Array(e,i,r,n)}}function h(t){var i,r=this;r.size=0,r.init=function(e){for(var n=t.length;"="==t.charAt(n-1);)n--;i=t.indexOf(",")+1,r.size=Math.floor(.75*(n-i)),e()},r.readUint8Array=function(r,n,s){var o,a=u(n),l=4*Math.floor(r/3),A=4*Math.ceil((r+n)/3),c=e.atob(t.substring(l+i,A+i)),h=r-3*Math.floor(l/4);for(o=h;o<h+n;o++)a.array[o-h]=c.charCodeAt(o);s(a.array)}}function d(e){var t=this;t.size=0,t.init=function(i){t.size=e.size,i()},t.readUint8Array=function(t,i,r,n){var s=new FileReader;s.onload=function(e){r(new Uint8Array(e.target.result))},s.onerror=n;try{s.readAsArrayBuffer(function(e,t,i){if(t<0||i<0||t+i>e.size)throw new RangeError("offset:"+t+", length:"+i+", size:"+e.size);return e.slice?e.slice(t,t+i):e.webkitSlice?e.webkitSlice(t,t+i):e.mozSlice?e.mozSlice(t,t+i):e.msSlice?e.msSlice(t,t+i):void 0}(e,t,i))}catch(e){n(e)}}}function p(){}function f(e){var i,r=this;r.init=function(e){i=new Blob([],{type:o}),e()},r.writeUint8Array=function(e,r){i=new Blob([i,t?e:e.buffer],{type:o}),r()},r.getData=function(t,r){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=r,n.readAsText(i,e)}}function v(t){var i=this,r="",n="";i.init=function(e){r+="data:"+(t||"")+";base64,",e()},i.writeUint8Array=function(t,i){var s,o=n.length,a=n;for(n="",s=0;s<3*Math.floor((o+t.length)/3)-o;s++)a+=String.fromCharCode(t[s]);for(;s<t.length;s++)n+=String.fromCharCode(t[s]);a.length>2?r+=e.btoa(a):n=a,i()},i.getData=function(t){t(r+e.btoa(n))}}function g(e){var i,r=this;r.init=function(t){i=new Blob([],{type:e}),t()},r.writeUint8Array=function(r,n){i=new Blob([i,t?r:r.buffer],{type:e}),n()},r.getData=function(e){e(i)}}function m(e,t,i,r,n,o,a,l,u,A){var c,h,d,p=0,f=t.sn;function v(){e.removeEventListener("message",g,!1),l(h,d)}function g(t){var i=t.data,n=i.data,s=i.error;if(s)return s.toString=function(){return"Error: "+this.message},void u(s);if(i.sn===f)switch("number"==typeof i.codecTime&&(e.codecTime+=i.codecTime),"number"==typeof i.crcTime&&(e.crcTime+=i.crcTime),i.type){case"append":n?(h+=n.length,r.writeUint8Array(n,(function(){m()}),A)):m();break;case"flush":d=i.crc,n?(h+=n.length,r.writeUint8Array(n,(function(){v()}),A)):v();break;case"progress":a&&a(c+i.loaded,o);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",i)}}function m(){(c=p*s)<=o?i.readUint8Array(n+c,Math.min(s,o-c),(function(i){a&&a(c,o);var r=0===c?t:{sn:f};r.type="append",r.data=i;try{e.postMessage(r,[i.buffer])}catch(t){e.postMessage(r)}p++}),u):e.postMessage({sn:f,type:"flush"})}h=0,e.addEventListener("message",g,!1),m()}function _(e,t,i,r,n,o,l,u,A,c){var h,d=0,p=0,f="input"===o,v="output"===o,g=new a;!function o(){var a;if((h=d*s)<n)t.readUint8Array(r+h,Math.min(s,n-h),(function(t){var r;try{r=e.append(t,(function(e){l&&l(h+e,n)}))}catch(e){return void A(e)}r?(p+=r.length,i.writeUint8Array(r,(function(){d++,setTimeout(o,1)}),c),v&&g.append(r)):(d++,setTimeout(o,1)),f&&g.append(t),l&&l(h,n)}),A);else{try{a=e.flush()}catch(e){return void A(e)}a?(v&&g.append(a),p+=a.length,i.writeUint8Array(a,(function(){u(p,g.get())}),c)):u(p,g.get())}}()}function y(t,i,r,n,s,o,a,u,A,c,h){var d="input";e.zip.useWebWorkers&&a?m(t,{sn:i,codecClass:"NOOP",crcType:d},r,n,s,o,A,u,c,h):_(new l,r,n,s,o,d,A,u,c,h)}function b(e){var t,i,r="",n=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)r+=(i=255&e.charCodeAt(t))>127?n[i-128]:String.fromCharCode(i);return r}function w(e){return decodeURIComponent(escape(e))}function B(e){var t,i="";for(t=0;t<e.length;t++)i+=String.fromCharCode(e[t]);return i}function x(e,t,i,r,n){e.version=t.view.getUint16(i,!0),e.bitFlag=t.view.getUint16(i+2,!0),e.compressionMethod=t.view.getUint16(i+4,!0),e.lastModDateRaw=t.view.getUint32(i+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,i=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?((r||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(i+10,!0),e.compressedSize=t.view.getUint32(i+14,!0),e.uncompressedSize=t.view.getUint32(i+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(i+22,!0),e.extraFieldLength=t.view.getUint16(i+24,!0)):n("File is using Zip64 (4gb+ file size).")):n("File contains encrypted entry.")}function P(t,s,o){var a=0;function l(){}l.prototype.getData=function(r,s,l,A){var c=this;function h(e,t){A&&!function(e){var t=u(4);return t.view.setUint32(0,e),c.crc32==t.view.getUint32(0)}(t)?o("CRC failed."):r.getData((function(e){s(e)}))}function d(e){o(e||n)}function p(e){o(e||"Error while writing file data.")}t.readUint8Array(c.offset,30,(function(n){var s,f=u(n.length,n);1347093252==f.view.getUint32(0)?(x(c,f,4,!1,o),s=c.offset+30+c.filenameLength+c.extraFieldLength,r.init((function(){0===c.compressionMethod?y(c._worker,a++,t,r,s,c.compressedSize,A,h,l,d,p):function(t,i,r,n,s,o,a,l,u,A,c){var h=a?"output":"none";e.zip.useWebWorkers?m(t,{sn:i,codecClass:"Inflater",crcType:h},r,n,s,o,u,l,A,c):_(new e.zip.Inflater,r,n,s,o,h,u,l,A,c)}(c._worker,a++,t,r,s,c.compressedSize,A,h,l,d,p)}),p)):o(i)}),d)};var A={getEntries:function(e){var n=this._worker;!function(e){t.size<22?o(i):n(22,(function(){n(Math.min(65558,t.size),(function(){o(i)}))}));function n(i,n){t.readUint8Array(t.size-i,i,(function(t){for(var i=t.length-22;i>=0;i--)if(80===t[i]&&75===t[i+1]&&5===t[i+2]&&6===t[i+3])return void e(new DataView(t.buffer,i,22));n()}),(function(){o(r)}))}}((function(s){var a,A;a=s.getUint32(16,!0),A=s.getUint16(8,!0),a<0||a>=t.size?o(i):t.readUint8Array(a,t.size-a,(function(t){var r,s,a,c,h=0,d=[],p=u(t.length,t);for(r=0;r<A;r++){if((s=new l)._worker=n,1347092738!=p.view.getUint32(h))return void o(i);x(s,p,h+6,!0,o),s.commentLength=p.view.getUint16(h+32,!0),s.directory=16==(16&p.view.getUint8(h+38)),s.offset=p.view.getUint32(h+42,!0),a=B(p.array.subarray(h+46,h+46+s.filenameLength)),s.filename=2048==(2048&s.bitFlag)?w(a):b(a),s.directory||"/"!=s.filename.charAt(s.filename.length-1)||(s.directory=!0),c=B(p.array.subarray(h+46+s.filenameLength+s.extraFieldLength,h+46+s.filenameLength+s.extraFieldLength+s.commentLength)),s.comment=2048==(2048&s.bitFlag)?w(c):b(c),d.push(s),h+=46+s.filenameLength+s.extraFieldLength+s.commentLength}e(d)}),(function(){o(r)}))}))},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?E("inflater",(function(e){A._worker=e,s(A)}),(function(e){o(e)})):s(A)}function C(e){return unescape(encodeURIComponent(e))}function M(e){var t,i=[];for(t=0;t<e.length;t++)i.push(e.charCodeAt(t));return i}function F(t,i,r,s){var o={},a=[],l=0,A=0;function c(e){r(e||"Error while writing zip file.")}function h(e){r(e||n)}var d={add:function(i,n,d,p,f){var v,g,b,w=this._worker;function B(e,i){var r=u(16);l+=e||0,r.view.setUint32(0,1347094280),void 0!==i&&(v.view.setUint32(10,i,!0),r.view.setUint32(4,i,!0)),n&&(r.view.setUint32(8,e,!0),v.view.setUint32(14,e,!0),r.view.setUint32(12,n.size,!0),v.view.setUint32(18,n.size,!0)),t.writeUint8Array(r.array,(function(){l+=16,d()}),c)}function x(){f=f||{},i=i.trim(),f.directory&&"/"!=i.charAt(i.length-1)&&(i+="/"),o.hasOwnProperty(i)?r("File already exists."):(g=M(C(i)),a.push(i),function(e){var r;b=f.lastModDate||new Date,v=u(26),o[i]={headerArray:v.array,directory:f.directory,filename:g,offset:l,comment:M(C(f.comment||""))},v.view.setUint32(0,335546376),f.version&&v.view.setUint8(0,f.version),s||0===f.level||f.directory||v.view.setUint16(4,2048),v.view.setUint16(6,(b.getHours()<<6|b.getMinutes())<<5|b.getSeconds()/2,!0),v.view.setUint16(8,(b.getFullYear()-1980<<4|b.getMonth()+1)<<5|b.getDate(),!0),v.view.setUint16(22,g.length,!0),(r=u(30+g.length)).view.setUint32(0,1347093252),r.array.set(v.array,4),r.array.set(g,30),l+=r.array.length,t.writeUint8Array(r.array,e,c)}((function(){n?s||0===f.level?y(w,A++,n,t,0,n.size,!0,B,p,h,c):function(t,i,r,n,s,o,a,l,u){var A="input";e.zip.useWebWorkers?m(t,{sn:i,options:{level:s},codecClass:"Deflater",crcType:A},r,n,0,r.size,a,o,l,u):_(new e.zip.Deflater,r,n,0,r.size,A,a,o,l,u)}(w,A++,n,t,f.level,B,p,h,c):B()})))}n?n.init(x,h):x()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var i,r,n,s=0,A=0;for(r=0;r<a.length;r++)s+=46+(n=o[a[r]]).filename.length+n.comment.length;for(i=u(s+22),r=0;r<a.length;r++)n=o[a[r]],i.view.setUint32(A,1347092738),i.view.setUint16(A+4,5120),i.array.set(n.headerArray,A+6),i.view.setUint16(A+32,n.comment.length,!0),n.directory&&i.view.setUint8(A+38,16),i.view.setUint32(A+42,n.offset,!0),i.array.set(n.filename,A+46),i.array.set(n.comment,A+46+n.filename.length),A+=46+n.filename.length+n.comment.length;i.view.setUint32(A,1347093766),i.view.setUint16(A+8,a.length,!0),i.view.setUint16(A+10,a.length,!0),i.view.setUint32(A+12,s,!0),i.view.setUint32(A+16,l,!0),t.writeUint8Array(i.array,(function(){t.getData(e)}),c)},_worker:null};e.zip.useWebWorkers?E("deflater",(function(e){d._worker=e,i(d)}),(function(e){r(e)})):i(d)}a.prototype.append=function(e){for(var t=0|this.crc,i=this.table,r=0,n=0|e.length;r<n;r++)t=t>>>8^i[255&(t^e[r])];this.crc=t},a.prototype.get=function(){return~this.crc},a.prototype.table=function(){var e,t,i,r=[];for(e=0;e<256;e++){for(i=e,t=0;t<8;t++)1&i?i=i>>>1^3988292384:i>>>=1;r[e]=i}return r}(),l.prototype.append=function(e,t){return e},l.prototype.flush=function(){},c.prototype=new A,c.prototype.constructor=c,h.prototype=new A,h.prototype.constructor=h,d.prototype=new A,d.prototype.constructor=d,p.prototype.getData=function(e){e(this.data)},f.prototype=new p,f.prototype.constructor=f,v.prototype=new p,v.prototype.constructor=v,g.prototype=new p,g.prototype.constructor=g;var k={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function E(t,i,r){if(null===e.zip.workerScripts||null===e.zip.workerScriptsPath){var n;if(e.zip.workerScripts){if(n=e.zip.workerScripts[t],!Array.isArray(n))return void r(new Error("zip.workerScripts."+t+" is not an array!"));n=function(e){var t=document.createElement("a");return e.map((function(e){return t.href=e,t.href}))}(n)}else(n=k[t].slice(0))[0]=(e.zip.workerScriptsPath||"")+n[0];var s=new Worker(n[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:n.slice(1)}),s.addEventListener("message",(function e(t){var n=t.data;if(n.error)return s.terminate(),void r(n.error);"importScripts"===n.type&&(s.removeEventListener("message",e),s.removeEventListener("error",o),i(s))})),s.addEventListener("error",o)}else r(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function o(e){s.terminate(),r(e)}}function I(e){console.error(e)}e.zip={Reader:A,Writer:p,BlobReader:d,Data64URIReader:h,TextReader:c,BlobWriter:g,Data64URIWriter:v,TextWriter:f,createReader:function(e,t,i){i=i||I,e.init((function(){P(e,t,i)}),i)},createWriter:function(e,t,i,r){i=i||I,r=!!r,e.init((function(){F(e,t,i,r)}),i)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(yD);var bD=yD.zip;!function(e){var t,i,r=e.Reader,n=e.Writer;try{i=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function s(e){var t=this;function i(i,r){var n;t.data?i():((n=new XMLHttpRequest).addEventListener("load",(function(){t.size||(t.size=Number(n.getResponseHeader("Content-Length"))||Number(n.response.byteLength)),t.data=new Uint8Array(n.response),i()}),!1),n.addEventListener("error",r,!1),n.open("GET",e),n.responseType="arraybuffer",n.send())}t.size=0,t.init=function(r,n){if(function(e){var t=document.createElement("a");return t.href=e,"http:"===t.protocol||"https:"===t.protocol}(e)){var s=new XMLHttpRequest;s.addEventListener("load",(function(){t.size=Number(s.getResponseHeader("Content-Length")),t.size?r():i(r,n)}),!1),s.addEventListener("error",n,!1),s.open("HEAD",e),s.send()}else i(r,n)},t.readUint8Array=function(e,r,n,s){i((function(){n(new Uint8Array(t.data.subarray(e,e+r)))}),s)}}function o(e){var t=this;t.size=0,t.init=function(i,r){var n=new XMLHttpRequest;n.addEventListener("load",(function(){t.size=Number(n.getResponseHeader("Content-Length")),"bytes"==n.getResponseHeader("Accept-Ranges")?i():r("HTTP Range not supported.")}),!1),n.addEventListener("error",r,!1),n.open("HEAD",e),n.send()},t.readUint8Array=function(t,i,r,n){!function(t,i,r,n){var s=new XMLHttpRequest;s.open("GET",e),s.responseType="arraybuffer",s.setRequestHeader("Range","bytes="+t+"-"+(t+i-1)),s.addEventListener("load",(function(){r(s.response)}),!1),s.addEventListener("error",n,!1),s.send()}(t,i,(function(e){r(new Uint8Array(e))}),n)}}function a(e){var t=this;t.size=0,t.init=function(i,r){t.size=e.byteLength,i()},t.readUint8Array=function(t,i,r,n){r(new Uint8Array(e.slice(t,t+i)))}}function l(){var e,t=this;t.init=function(t,i){e=new Uint8Array,t()},t.writeUint8Array=function(t,i,r){var n=new Uint8Array(e.length+t.length);n.set(e),n.set(t,e.length),e=n,i()},t.getData=function(t){t(e.buffer)}}function u(e,t){var r,n=this;n.init=function(t,i){e.createWriter((function(e){r=e,t()}),i)},n.writeUint8Array=function(e,n,s){var o=new Blob([i?e:e.buffer],{type:t});r.onwrite=function(){r.onwrite=null,n()},r.onerror=s,r.write(o)},n.getData=function(t){e.file(t)}}s.prototype=new r,s.prototype.constructor=s,o.prototype=new r,o.prototype.constructor=o,a.prototype=new r,a.prototype.constructor=a,l.prototype=new n,l.prototype.constructor=l,u.prototype=new n,u.prototype.constructor=u,e.FileWriter=u,e.HttpReader=s,e.HttpRangeReader=o,e.ArrayBufferReader=a,e.ArrayBufferWriter=l,e.fs&&((t=e.fs.ZipDirectoryEntry).prototype.addHttpContent=function(i,r,n){return function(i,r,n,s){if(i.directory)return s?new t(i.fs,r,n,i):new e.fs.ZipFileEntry(i.fs,r,n,i);throw"Parent entry is not a directory."}(this,i,{data:r,Reader:n?o:s})},t.prototype.importHttpContent=function(e,t,i,r){this.importZip(t?new o(e):new s(e),i,r)},e.fs.FS.prototype.importHttpContent=function(e,i,r,n){this.entries=[],this.root=new t(this),this.root.importHttpContent(e,i,r,n)})}(bD);var wD=["4.2"],BD=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,e),this.supportedSchemas=wD,this._xrayOpacity=.7,this._src=null,this._options=i,this.viewpoint=null,i.workerScriptsPath?(bD.workerScriptsPath=i.workerScriptsPath,this.src=i.src,this.xrayOpacity=.7,this.displayEffect=i.displayEffect,this.createMetaModel=i.createMetaModel):t.error("Config expected: workerScriptsPath")}return I(e,[{key:"load",value:function(e,t,i,r,n,s){switch(r.materialType){case"MetallicMaterial":t._defaultMaterial=new Vn(t,{baseColor:[1,1,1],metallic:.6,roughness:.6});break;case"SpecularMaterial":t._defaultMaterial=new Gn(t,{diffuse:[1,1,1],specular:le.vec3([1,1,1]),glossiness:.5});break;default:t._defaultMaterial=new bn(t,{reflectivity:.75,shiness:100,diffuse:[1,1,1]})}t._wireframeMaterial=new Ln(t,{color:[0,0,0],lineWidth:2});var o=t.scene.canvas.spinner;o.processes++,xD(e,t,i,r,(function(){o.processes--,n&&n(),t.fire("loaded",!0,!1)}),(function(e){o.processes--,t.error(e),s&&s(e),t.fire("error",e)}),(function(e){console.log("Error, Will Robinson: "+e)}))}}]),e}(),xD=function(e,t,i,r,n,s){!function(e,t,i){var r=new TD;r.load(e,(function(){t(r)}),(function(e){i("Error loading ZIP archive: "+e)}))}(i,(function(i){PD(e,i,r,t,n,s)}),s)},PD=function(){return function(t,i,r,n,s){var o={plugin:t,zip:i,edgeThreshold:30,materialType:r.materialType,scene:n.scene,modelNode:n,info:{references:{}},materials:{}};r.createMetaModel&&(o.metaModelData={modelId:n.id,metaObjects:[{name:n.id,type:"Default",id:n.id}]}),n.scene.loading++,function(t,i){t.zip.getFile("Manifest.xml",(function(r,n){for(var s=n.children,o=0,a=s.length;o<a;o++){var l=s[o];if("Manifest"===l.type)e(t,l,i)}}))}(o,(function(){o.metaModelData&&t.viewer.metaScene.createMetaModel(n.id,o.metaModelData),n.scene.loading--,s()}))};function e(e,i,r){for(var n=i.children,s=0,o=n.length;s<o;s++){var a=n[s];if("Root"===a.type){var l=a.children[0];e.zip.getFile(l,(function(i,n){t(e,n,r)}))}}}function t(e,t,r){for(var n=t.children,s=0,o=n.length;s<o;s++){var a=n[s];if("Model_3dxml"===a.type)i(e,a,r)}}function i(e,t,i){for(var n=t.children,a=0,l=n.length;a<l;a++){var u=n[a];switch(u.type){case"Header":r(e,u);break;case"ProductStructure":s(e,u,i);break;case"DefaultView":o(e,u)}}}function r(e,t){for(var i=t.children,r={},s=0,o=i.length;s<o;s++){var a=i[s];switch(a.type){case"SchemaVersion":r.schemaVersion=a.children[0],n(e,r.schemaVersion)||e.plugin.error("Schema version not supported: "+r.schemaVersion+" - supported versions are: "+wD.join(","));break;case"Title":r.title=a.children[0];break;case"Author":r.author=a.children[0];break;case"Created":r.created=a.children[0]}}e.modelNode.meta=r}function n(e,t){for(var i=0,r=wD.length;i<r;i++)if(t===wD[i])return!0;return!1}function s(e,t,i){!function(e,t,i){for(var r={},n=t.children,s=0,o=0,l=n.length;o<l;o++){"ReferenceRep"===(u=n[o]).type&&s++}for(o=0,l=n.length;o<l;o++){var u;if("ReferenceRep"===(u=n[o]).type)if(u.associatedFile){var A=DD(u.associatedFile);!function(){var t=u.id;e.zip.getFile(A,(function(n,o){var l=n.getElementsByTagName("MaterialId");CD(e,l,(function(){var n={id:t};a(e,o,n),r[t]=n,0==--s&&i(r)}))}),(function(e){}))}()}}}(e,t,(function(r){for(var n=t.children,s={},o={},a={},l=0,u=n.length;l<u;l++){var A=n[l];switch(A.type){case"Reference3D":s[A.id]={type:"Reference3D",id:A.id,name:A.name,instance3Ds:{},instanceReps:{}};break;case"InstanceRep":for(var c=0,h=A.children.length;c<h;c++){switch((g=A.children[c]).type){case"IsAggregatedBy":d=g.children[0];break;case"IsInstanceOf":p=g.children[0]}}o[A.id]={type:"InstanceRep",id:A.id,name:A.name,isAggregatedBy:d,isInstanceOf:p,referenceReps:{}};break;case"Instance3D":var d,p,v;for(c=0,h=A.children.length;c<h;c++){var g;switch((g=A.children[c]).type){case"IsAggregatedBy":d=g.children[0];break;case"IsInstanceOf":p=g.children[0];break;case"RelativeMatrix":v=g.children[0]}}a[A.id]={type:"Instance3D",id:A.id,name:A.name,isAggregatedBy:d,isInstanceOf:p,relativeMatrix:v,reference3Ds:{}}}}for(var m in a){(y=s[(_=a[m]).isAggregatedBy])?y.instance3Ds[_.id]=_:alert("foo")}for(var m in a){var _,y=s[(_=a[m]).isInstanceOf];_.reference3Ds[y.id]=y,y.instance3D=_}for(var m in o){var b=r[(w=o[m]).isInstanceOf];b&&(w.referenceReps[b.id]=b)}for(var m in o){var w;(y=s[(w=o[m]).isAggregatedBy])&&(y.instanceReps[w.id]=w)}function B(e,t,i){for(var r in t.instance3Ds)x(e,t.instance3Ds[r],i);for(var r in t.instanceReps)P(e,t.instanceReps[r],i)}function x(e,t,i){if(t.relativeMatrix){var r=f(t.relativeMatrix,12),n=[r[9],r[10],r[11]],s=r.slice(0,9),o=le.mat3ToMat4(s,le.identityMat4()),a=new Xt(e.modelNode,{position:n});e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(a,!0):e.modelNode.addChild(a,!0),i=a,a=new Xt(e.modelNode,{matrix:o}),e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i.addChild(a,!0),i=a}else{a=new Xt(e.modelNode,{});e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(a,!0):e.modelNode.addChild(a,!0),i=a}for(var l in t.reference3Ds)B(e,t.reference3Ds[l],i)}function P(e,t,i){if(t.referenceReps)for(var r in t.referenceReps){var n=t.referenceReps[r];for(var s in n)if("id"!==s){var o=n[s],a="lines"===o.geometry.primitive?e.modelNode._wireframeMaterial:o.materialId?e.materials[o.materialId]:null,l=o.color,u=new vn(e.modelNode,{isObject:!0,geometry:o.geometry,material:a||e.modelNode._defaultMaterial,colorize:l,backfaces:!1});e.metaModelData&&e.metaModelData.metaObjects.push({id:u.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(u,!0):e.modelNode.addChild(u,!0),u.colorize=l}}}for(var m in s){if(!(y=s[m]).instance3D)return B(e,y,null),void i()}alert("No root Reference3D element found in this modelNode - can't load."),i()}))}function o(e,t){for(var i=t.children,r=0,n=i.length;r<n;r++){var s=i[r];if("Viewpoint"===s.type){var o=s.children;e.modelNode.viewpoint={};for(var a=0,l=o.length;a<l;a++){var u=o[r];switch(u.type){case"Position":e.modelNode.viewpoint.eye=f(u.children[0],3);break;case"Sight":e.modelNode.viewpoint.look=f(u.children[0],3);break;case"Up":e.modelNode.viewpoint.up=f(u.children[0],3)}}}}}function a(e,t,i){for(var r=t.children,n=0,s=r.length;n<s;n++){var o=r[n];if("XMLRepresentation"===o.type)l(e,o,i)}}function l(e,t,i){for(var r=t.children,n=0,s=r.length;n<s;n++){var o=r[n];if("Root"===o.type)u(e,o,i)}}function u(e,t,i){t["xsi:type"];for(var r=t.children,n=0,s=r.length;n<s;n++){var o=r[n];if("Rep"===o.type)A(e,o,i)}}function A(e,t,i){t["xsi:type"];for(var r={edgeThreshold:e.edgeThreshold||30,compressGeometry:!0},n=t.children,s=0,o=n.length;s<o;s++){var a=n[s];switch(a.type){case"Rep":A(e,a,i);break;case"Edges":break;case"Faces":r.primitive="triangles",c(e,a,r);break;case"VertexBuffer":p(e,a,r);break;case"SurfaceAttributes":v(e,a,r)}}if(r.positions){var l=new mt(e.modelNode,r);i[l.id]={geometry:l,color:r.color||[1,1,1,1],materialId:r.materialId}}}function c(e,t,i){for(var r=t.children,n=0,s=r.length;n<s;n++){var o=r[n];if("Face"===o.type)h(e,o,i)}}function h(e,t,i){var r=t.strips;if(r){var n=function(e){for(var t=e.split(","),i=[],r=0,n=t.length;r<n;r++){var s=t[r].trim();if(s.length>0){for(var o=s.trim().split(" "),a=new Int16Array(o.length),l=0,u=0,A=o.length;u<A;u++)""!==o[u]&&(a[l++]=parseInt(o[u]));i.push(a)}}return i}(r);if(n.length>0){i.primitive="triangles";for(var s=[],o=0,a=n.length;o<a;o++)for(var l=d(n[o]),u=0,A=l.length;u<A;u++)s.push(l[u]);i.indices=s}}else{var c=t.triangles;c&&(i.primitive="triangles",i.indices=function(e){e=e.trim().split(" ");for(var t=new Int32Array(e.length),i=0,r=e.length;i<r;i++){var n=e[i];t[i]=parseInt(n)}return t}(c))}var h=t.children;for(o=0,a=h.length;o<a;o++){var p=h[o];if("SurfaceAttributes"===p.type)v(e,p,i)}}function d(e){for(var t=[],i=0,r=e.length;i<r-2;i++)1&i?(t.push(e[i]),t.push(e[i+2]),t.push(e[i+1])):(t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]));return t}function p(e,t,i){for(var r=t.children,n=0,s=r.length;n<s;n++){var o=r[n];switch(o.type){case"Positions":i.positions=f(o.children[0],3);break;case"Normals":i.normals=f(o.children[0],3);break;case"TextureCoordinates":i.uv=f(o.children[0],2)}}}function f(e,t){e=e.split(",");for(var i=new Float32Array(e.length*t),r=0,n=0,s=e.length;n<s;n++)for(var o=e[n],a=0,l=(o=o.split(" ")).length;a<l;a++)""!==o[a]&&(i[r++]=parseFloat(o[a]));return i}function v(e,t,i){i.color=[1,1,1,1];for(var r,n,s=t.children,o=0,a=s.length;o<a;o++){var l=s[o];switch(l.type){case"Color":i.color[0]=l.red,i.color[1]=l.green,i.color[2]=l.blue,i.color[3]=l.alpha;break;case"MaterialApplication":for(var u=l.children,A=0,c=u.length;A<c;A++){var h=u[A];if("MaterialId"===h.type){var d=(r=h.id,n=void 0,-1!==(n=r.lastIndexOf("#"))?r.substring(n+1):r);e.materials[d]||e.plugin.error("material  not found: "+d),i.materialId=d}}}}}}();function CD(e,t,i){var r={};!function n(s,o){if(s>=t.length)i();else{var a=t[s].id,l=a.lastIndexOf(":");l>0&&(a=a.substring(l+1));var u=a.lastIndexOf("#");u>0&&(a=a.substring(0,u)),r[a]?n(s+1):function(e,t,i){e.zip.getFile(t,(function(t,r){!function(e,t,i){for(var r,n=t.children,s=0,o=n.length;s<o;s++)"Model_3dxml"===(r=n[s]).type&&MD(e,r,i)}(e,r,i)}))}(e,a,(function(){r[a]=!0,n(s+1)}))}}(0)}function MD(e,t,i){for(var r,n=t.children,s=0,o=n.length;s<o;s++)"CATMaterialRef"===(r=n[s]).type&&FD(e,r,i)}function FD(e,t,i){for(var r={},n=t.children,s=0,o=0,a=n.length;o<a;o++){if("MaterialDomainInstance"===(d=n[o]).type){for(var l,u,A=0,c=d.children.length;A<c;A++){var h=d.children[A];switch(h.type){case"IsAggregatedBy":l=h.children[0];break;case"IsInstanceOf":u=h.children[0]}}r[u]=l}}for(o=0,a=n.length;o<a;o++){if("MaterialDomain"===(d=n[o]).type)s++}for(o=0,a=n.length;o<a;o++){var d;if("MaterialDomain"===(d=n[o]).type)d.associatedFile&&function(){var t=d.id,n=DD(d.associatedFile);e.zip.getFile(n,(function(n,o){e.materials[r[t]]=kD(e,o),0==--s&&i()}),(function(e){}))}()}}function kD(e,t){for(var i=t.children,r=0,n=i.length;r<n;r++){var s=i[r];if("Osm"===s.type)return ED(e,s)}}function ED(e,t){for(var i=t.children,r=0,n=i.length;r<n;r++){var s=i[r];switch(s.type){case"RenderingRootFeature":break;case"Feature":if("RenderingFeature"===s.Alias){var o,a,l,u,A={},c={},h=s.children;for(o=0,a=h.length;o<a;o++)switch((l=h[o]).Name){case"AmbientCoef":A.ambient=parseFloat(l.Value);break;case"DiffuseCoef":A.diffuse=parseFloat(l.Value);break;case"EmissiveCoef":A.emissive=parseFloat(l.Value);break;case"SpecularExponent":A.specular=parseFloat(l.Value)}for(o=0,a=h.length;o<a;o++)switch((l=h[o]).Name){case"AmbientColor":c.ambient=ID(l.Value,A.ambient);break;case"DiffuseColor":c.diffuse=ID(l.Value,A.diffuse);break;case"EmissiveColor":c.emissive=ID(l.Value,A.emissive);break;case"SpecularColor":c.specular=ID(l.Value,A.specular);break;case"Transparency":var d=1-parseFloat(l.Value);d<1&&(c.alpha=d,c.alphaMode="blend")}switch(e.materialType){case"MetallicMaterial":u=new Vn(e.modelNode,{baseColor:c.diffuse,metallic:.7,roughness:.5,emissive:c.emissive,alpha:c.alpha,alphaMode:c.alphaMode});break;case"SpecularMaterial":u=new Gn(e.modelNode,{diffuse:c.diffuse,specular:c.specular,glossiness:.5,emissive:c.emissive,alpha:c.alpha,alphaMode:c.alphaMode});break;default:u=new bn(e.modelNode,{reflectivity:.5,ambient:c.ambient,diffuse:c.diffuse,specular:c.specular,emissive:c.emissive,alphaMode:c.alphaMode,alpha:t.alpha})}return u}}}}function ID(e,t){t=void 0!==t?t:.5;var i=e.indexOf("["),r=e.indexOf("]");e=(e=e.substring(i+1,r-i)).split(",");for(var n=new Float32Array(e.length),s=0,o=0,a=e.length;o<a;o++)for(var l=e[o],u=0,A=(l=l.trim().split(" ")).length;u<A;u++)""!==l[u]&&(n[s++]=parseFloat(l[u])*t);return n}var TD=function(){var e={};function t(e,i){if(e.nodeType===e.TEXT_NODE){var r=e.nodeValue;if(null===r.match(/^\s+$/))return r}else if(e.nodeType===e.ELEMENT_NODE||e.nodeType===e.DOCUMENT_NODE){var n={type:e.nodeName,children:[]};if(e.nodeType===e.ELEMENT_NODE)for(var s=0;s<e.attributes.length;s++){var o=e.attributes[s];n[i[o.nodeName]||o.nodeName]=o.nodeValue}for(var a=0;a<e.childNodes.length;a++){(s=t(e.childNodes[a],i))&&n.children.push(s)}return n}}this.load=function(t,i,r){bD.createReader(new bD.HttpReader(t),(function(t){t.getEntries((function(t){if(t.length>0)for(var r=0,n=t.length;r<n;r++){var s=t[r];e[s.filename]=s}i()}))}),r)},this.getFile=function(i,r,n){var s=e[i];if(!s){var o="ZIP entry not found: "+i;return console.error(o),void(n&&n(o))}s.getData(new bD.TextWriter,(function(e){var i=(new DOMParser).parseFromString(e,"text/xml"),n=t(i,{});r(i,n)}))},this.destroy=function(){undefined.close((function(){}))}};function DD(e){var t="urn:3DXML:";return 0===e.indexOf(t)?e.substring(t.length):e}var SD=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),r=t.call(this,"XML3DLoader",e,n),n.workerScriptsPath?(r._workerScriptsPath=n.workerScriptsPath,r._loader=new BD(w(r),n),r.supportedSchemas=r._loader.supportedSchemas,r):(r.error("Config expected: workerScriptsPath"),b(r))}return I(i,[{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.workerScriptsPath=this._workerScriptsPath,e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);var t=new Xt(this.viewer.scene,ge.apply(e,{isModel:!0})),i=e.src;return i?(this._loader.load(this,t,i,e),t):(this.error("load() param expected: src"),t)}}]),i}(),RD=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getIFC",value:function(e,t,i){e=this._cacheBusterURL(e);var r=function(){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var s=!!n[2],o=n[3];o=window.decodeURIComponent(o),s&&(o=window.atob(o));try{for(var a=new ArrayBuffer(o.length),l=new Uint8Array(a),u=0;u<o.length;u++)l[u]=o.charCodeAt(u);t(a)}catch(e){i(e)}}else{var A=new XMLHttpRequest;A.open("GET",e,!0),A.responseType="arraybuffer",A.onreadystatechange=function(){4===A.readyState&&(200===A.status?t(A.response):i("getXKT error : "+A.response))},A.send(null)}}}]),e}(),UD=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,"ifcLoader",e,n)).dataSource=n.dataSource,r.objectDefaults=n.objectDefaults,r.includeTypes=n.includeTypes,r.excludeTypes=n.excludeTypes,r.excludeUnclassifiedObjects=n.excludeUnclassifiedObjects,!n.WebIFC)throw"Parameter expected: WebIFC";if(!n.IfcAPI)throw"Parameter expected: IfcAPI";return r._webIFC=n.WebIFC,r._ifcAPI=n.IfcAPI,r}return I(i,[{key:"supportedVersions",get:function(){return["2x3","4"]}},{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new RD}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||vI}},{key:"includeTypes",get:function(){return this._includeTypes},set:function(e){this._includeTypes=e}},{key:"excludeTypes",get:function(){return this._excludeTypes},set:function(e){this._excludeTypes=e}},{key:"excludeUnclassifiedObjects",get:function(){return this._excludeUnclassifiedObjects},set:function(e){this._excludeUnclassifiedObjects=!!e}},{key:"globalizeObjectIds",get:function(){return this._globalizeObjectIds},set:function(e){this._globalizeObjectIds=!!e}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);var t=new Sc(this.viewer.scene,ge.apply(e,{isModel:!0}));if(!e.src&&!e.ifc)return this.error("load() param expected: src or IFC"),t;var i={autoNormals:!0};if(!1!==e.loadMetadata){var r=e.includeTypes||this._includeTypes,n=e.excludeTypes||this._excludeTypes,s=e.objectDefaults||this._objectDefaults;if(r){i.includeTypesMap={};for(var o=0,a=r.length;o<a;o++)i.includeTypesMap[r[o]]=!0}if(n){i.excludeTypesMap={};for(var l=0,u=n.length;l<u;l++)i.excludeTypesMap[n[l]]=!0}s&&(i.objectDefaults=s),i.excludeUnclassifiedObjects=void 0!==e.excludeUnclassifiedObjects?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,i.globalizeObjectIds=void 0!==e.globalizeObjectIds?!!e.globalizeObjectIds:this._globalizeObjectIds}try{e.src?this._loadModel(e.src,e,i,t):this._parseModel(e.ifc,e,i,t)}catch(e){this.error(e),t.fire("error",e)}return t}},{key:"_loadModel",value:function(e,t,i,r){var n=this,s=this.viewer.scene.canvas.spinner;s.processes++,this._dataSource.getIFC(t.src,(function(e){n._parseModel(e,t,i,r),s.processes--}),(function(e){s.processes--,n.error(e),r.fire("error",e)}))}},{key:"_parseModel",value:function(e,t,i,r){if(!r.destroyed){var n=t.stats||{};if(n.sourceFormat="IFC",n.schemaVersion="",n.title="",n.author="",n.created="",n.numMetaObjects=0,n.numPropertySets=0,n.numObjects=0,n.numGeometries=0,n.numTriangles=0,n.numVertices=0,!this._ifcAPI)throw"WebIFCLoaderPlugin has no WebIFC instance configured - please inject via WebIFCLoaderPlugin constructor";var s=new Uint8Array(e),o=this._ifcAPI.OpenModel(s),a=this._ifcAPI.GetModelSchema(o),l=this._ifcAPI.GetLineIDsWithType(o,this._webIFC.IFCPROJECT).get(0),u=!1!==t.loadMetadata,A={modelID:o,modelSchema:a,sceneModel:r,loadMetadata:u,metadata:u?{id:"",projectId:""+l,author:"",createdAt:"",schema:"",creatingApplication:"",metaObjects:[],propertySets:[]}:null,metaObjects:{},options:i,log:function(e){},nextId:0,stats:n};if(u){if(i.includeTypes){A.includeTypes={};for(var c=0,h=i.includeTypes.length;c<h;c++)A.includeTypes[i.includeTypes[c]]=!0}if(i.excludeTypes){A.excludeTypes={};for(var d=0,p=i.excludeTypes.length;d<p;d++)A.excludeTypes[i.excludeTypes[d]]=!0}this._parseMetaObjects(A),this._parsePropertySets(A)}if(this._parseGeometry(A),r.finalize(),u){var f=r.id;this.viewer.metaScene.createMetaModel(f,A.metadata,i)}r.scene.once("tick",(function(){r.destroyed||(r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1))}))}}},{key:"_parseMetaObjects",value:function(e){var t=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCPROJECT).get(0),i=this._ifcAPI.GetLine(e.modelID,t);this._parseSpatialChildren(e,i)}},{key:"_parseSpatialChildren",value:function(e,t,i){var r=this._ifcAPI.GetNameFromTypeCode(t.type);if((!e.includeTypes||e.includeTypes[r])&&(!e.excludeTypes||!e.excludeTypes[r])){this._createMetaObject(e,t,i);var n=t.GlobalId.value;this._parseRelatedItemsOfType(e,t.expressID,"RelatingObject","RelatedObjects",this._webIFC.IFCRELAGGREGATES,n),this._parseRelatedItemsOfType(e,t.expressID,"RelatingStructure","RelatedElements",this._webIFC.IFCRELCONTAINEDINSPATIALSTRUCTURE,n)}}},{key:"_createMetaObject",value:function(e,t,i){var r=t.GlobalId.value,n=this._ifcAPI.GetNameFromTypeCode(t.type),s={id:r,name:t.Name&&""!==t.Name.value?t.Name.value:n,type:n,parent:i};e.metadata.metaObjects.push(s),e.metaObjects[r]=s,e.stats.numMetaObjects++}},{key:"_parseRelatedItemsOfType",value:function(e,t,i,r,n,s){for(var o=this,a=this._ifcAPI.GetLineIDsWithType(e.modelID,n),l=0;l<a.size();l++){var u=a.get(l),A=this._ifcAPI.GetLine(e.modelID,u),c=A[i],h=!1;if(Array.isArray(c))h=c.map((function(e){return e.value})).includes(t);else h=c.value===t;if(h){var d=A[r];if(Array.isArray(d))d.forEach((function(t){var i=o._ifcAPI.GetLine(e.modelID,t.value);o._parseSpatialChildren(e,i,s)}));else{var p=this._ifcAPI.GetLine(e.modelID,d.value);this._parseSpatialChildren(e,p,s)}}}}},{key:"_parsePropertySets",value:function(e){for(var t=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCRELDEFINESBYPROPERTIES),i=0;i<t.size();i++){var r=t.get(i),n=this._ifcAPI.GetLine(e.modelID,r,!0);if(n){var s=n.RelatingPropertyDefinition;if(!s)continue;var o=s.GlobalId.value,a=s.HasProperties;if(a&&a.length>0){for(var l=s.Name.value,u=[],A=0,c=a.length;A<c;A++){var h=a[A],d=h.Name,p=h.NominalValue;if(d&&p){var f={name:d.value,type:p.type,value:p.value,valueType:p.valueType};h.Description?f.description=h.Description.value:p.description&&(f.description=p.description),u.push(f)}}var v={id:o,type:"Default",name:l,properties:u};e.metadata.propertySets.push(v),e.stats.numPropertySets++;var g=n.RelatedObjects;if(!g||0===g.length)return;for(var m=0,_=g.length;m<_;m++){var y=g[m].GlobalId.value,b=e.metaObjects[y];b&&(b.propertySetIds||(b.propertySetIds=[]),b.propertySetIds.push(o))}}}}}},{key:"_parseGeometry",value:function(e){var t=this;this._ifcAPI.StreamAllMeshes(e.modelID,(function(i){var r=i.expressID,n=i.geometries,s=[],o=t._ifcAPI.GetLine(e.modelID,r).GlobalId.value;if(e.loadMetadata){var a=o,l=e.metaObjects[a];if(e.includeTypes&&(!l||!e.includeTypes[l.type]))return;if(e.excludeTypes&&(!l||e.excludeTypes[l.type]))return}for(var u=le.mat4(),A=le.vec3(),c=0,h=n.size();c<h;c++){for(var d=n.get(c),p=t._ifcAPI.GetGeometry(e.modelID,d.geometryExpressID),f=t._ifcAPI.GetVertexArray(p.GetVertexData(),p.GetVertexDataSize()),v=t._ifcAPI.GetIndexArray(p.GetIndexData(),p.GetIndexDataSize()),g=new Float64Array(f.length/2),m=new Float32Array(f.length/2),_=0,y=0,b=f.length/6;_<b;_++,y+=3)g[y+0]=f[6*_+0],g[y+1]=f[6*_+1],g[y+2]=f[6*_+2];u.set(d.flatTransformation),le.transformPositions3(u,g);var w=qt(g,g,A);if(!e.options.autoNormals)for(var B=0,x=0,P=f.length/6;B<P;B++,x+=3)m[x+0]=f[6*B+3],m[x+1]=f[6*B+4],m[x+2]=f[6*B+5];e.stats.numGeometries++,e.stats.numVertices+=g.length/3,e.stats.numTriangles+=v.length/3;var C="mesh"+e.nextId++;e.sceneModel.createMesh({id:C,primitive:"triangles",origin:w?A:null,positions:g,normals:e.options.autoNormals?null:m,indices:v,color:[d.color.x,d.color.y,d.color.z],opacity:d.color.w}),s.push(C)}var M=e.options.globalizeObjectIds?le.globalizeObjectId(e.sceneModel.id,o):o;e.sceneModel.createEntity({id:M,meshIds:s,isObject:!0}),e.stats.numObjects++}))}}]),i}();function LD(e){return OD.apply(this,arguments)}function OD(){return(OD=A(l().mark((function e(t){var i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t);case 3:if((i=e.sent).ok){e.next=6;break}throw new Error("HTTP error! Status: ".concat(i.status));case 6:return e.abrupt("return",i.text());case 9:e.prev=9,e.t0=e.catch(0),console.error("Error fetching file:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}var ND=function(e){m(r,vh);var t,i=y(r);function r(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,r),(t=i.call(this,"ifcLoader",e,n)).gltfLoader=new gI(t.viewer),t.cxConverterModule=null,t}return I(r,[{key:"setCxConverterModule",value:function(e){this.cxConverterModule=e}},{key:"load",value:(t=A(l().mark((function e(){var t,i,r,n,s,o,a=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:{},this.cxConverterModule){e.next=3;break}throw new Error("CxConverter module is not set. Use setCxConverterModule() to set it.");case 3:return t.src||this.error("load() param expected: src"),e.next=6,LD(t.src);case 6:return i=e.sent,e.next=9,this.cxConverterModule.ifc2gltf(i,{remote:!0,progressCallback:t.progressCallback,progressTextCallback:t.progressTextCallback});case 9:return r=e.sent,n=r.gltf,s=r.metaData,o=this.gltfLoader.load({id:"myModel",gltf:n,metaModelJSON:s}),e.abrupt("return",o);case 14:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),r}(),VD=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getLAS",value:function(e,t,i){e=this._cacheBusterURL(e);var r=function(){};t=t||r,i=i||r;var n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){var s=!!n[2],o=n[3];o=window.decodeURIComponent(o),s&&(o=window.atob(o));try{for(var a=new ArrayBuffer(o.length),l=new Uint8Array(a),u=0;u<o.length;u++)l[u]=o.charCodeAt(u);t(a)}catch(e){i(e)}}else{var A=new XMLHttpRequest;A.open("GET",e,!0),A.responseType="arraybuffer",A.onreadystatechange=function(){4===A.readyState&&(200===A.status?t(A.response):i("getLAS error : "+A.response))},A.send(null)}}},{key:"getManifest",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}}]),e}(),QD=[{item:"FileSignature",format:"char",size:4},{item:"FileSoureceID",format:"uShort",size:2},{item:"GlobalEncoding",format:"uShort",size:2},{item:"ProjectID1",format:"notUsed",size:4},{item:"ProjectID2",format:"notUsed",size:2},{item:"ProjectID3",format:"notUsed",size:2},{item:"ProjectID4",format:"notUsed",size:8},{item:"VersionMajor",format:"uChar",size:1},{item:"VersionMinor",format:"uChar",size:1},{item:"SystemIdentifier",format:"char",size:32},{item:"GeneratingSoftware",format:"char",size:32},{item:"CreationDay",format:"uShort",size:2},{item:"CreationYear",format:"uShort",size:2},{item:"HeaderSize",format:"uShort",size:2},{item:"OffsetToPointData",format:"uLong",size:4},{item:"NumberOfVariableLengthRecords",format:"uLong",size:4},{item:"PointDataFormatID",format:"uChar",size:1},{item:"PointDataRecordLength",format:"uShort",size:2},{item:"NumberOfPoints",format:"uLong",size:4},{item:"NumberOfPointByReturn",format:"uLong",size:20},{item:"ScaleFactorX",format:"double",size:8},{item:"ScaleFactorY",format:"double",size:8},{item:"ScaleFactorZ",format:"double",size:8},{item:"OffsetX",format:"double",size:8},{item:"OffsetY",format:"double",size:8},{item:"OffsetZ",format:"double",size:8},{item:"MaxX",format:"double",size:8},{item:"MinX",format:"double",size:8},{item:"MaxY",format:"double",size:8},{item:"MinY",format:"double",size:8},{item:"MaxZ",format:"double",size:8},{item:"MinZ",format:"double",size:8}],HD=[{item:"Reserved",format:"uShort",size:2},{item:"UserId",format:"char",size:16},{item:"RecordId",format:"uShort",size:2},{item:"RecordLengthAfterHeader",format:"uShort",size:2},{item:"Description",format:"char",size:32}],GD=function(e){var t=0,i=0,r=0,n=new DataView(e),s=new Uint8Array(6e3),o=function(r){var s,o,a=r.item,l=r.format,u=r.size;switch(l){case"char":return o=new Uint8Array(e,t,u),t+=u,[a,s=zD(o)];case"uShort":return s=n.getUint16(t,!0),t+=u,[a,s];case"uLong":return s=n.getUint32(t,!0),"NumberOfVariableLengthRecords"===a&&(i=s),t+=u,[a,s];case"uChar":return s=n.getUint8(t),t+=u,[a,s];case"double":return s=n.getFloat64(t,!0),t+=u,[a,s];default:t+=u}};return function(){var e={};QD.forEach((function(t){var i=o(h({},t));if(void 0!==i){if("FileSignature"===i[0]&&"LASF"!==i[1])throw new Error("Ivalid FileSignature. Is this a LAS/LAZ file");e[i[0]]=i[1]}}));for(var n=[],a=i,l=function(){var e={};HD.forEach((function(i){var n=o(h({},i));e[n[0]]=n[1],"UserId"===n[0]&&"LASF_Projection"===n[1]&&(r=t-18+54)})),n.push(e)};a--;)l();var u=function(e){if(void 0!==e){for(var t=r+e.RecordLengthAfterHeader,i=s.slice(r,t),n=jD(i),o=new DataView(n),a=6,l=Number(o.getUint16(a,!0)),u=[];l--;){var A={};A.key=o.getUint16(a+=2,!0),A.tiffTagLocation=o.getUint16(a+=2,!0),A.count=o.getUint16(a+=2,!0),A.valueOffset=o.getUint16(a+=2,!0),u.push(A)}var c=u.find((function(e){return 3072===e.key}));if(c&&c.hasOwnProperty("valueOffset"))return c.valueOffset}}(n.find((function(e){return"LASF_Projection"===e.UserId})));return u&&(e.epsg=u),e}()},jD=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),r=0;r<e.length;++r)i[r]=e[r];return t},zD=function(e){var t="";return e.forEach((function(e){var i=String.fromCharCode(e);"\0"!==i&&(t+=i)})),t.trim()},WD=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"lasLoader",e,n)).dataSource=n.dataSource,r.skip=n.skip,r.fp64=n.fp64,r.colorDepth=n.colorDepth,r.center=n.center,r.rotate=n.rotate,r.rotateX=n.rotateX,r.transform=n.transform,r}return I(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new VD}},{key:"skip",get:function(){return this._skip},set:function(e){this._skip=e||1}},{key:"fp64",get:function(){return this._fp64},set:function(e){this._fp64=!!e}},{key:"colorDepth",get:function(){return this._colorDepth},set:function(e){this._colorDepth=e||"auto"}},{key:"center",get:function(){return this._center},set:function(e){this._center=!!e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"rotate",get:function(){return this._rotate},set:function(e){this._rotate=e}},{key:"rotateX",get:function(){return this._rotateX},set:function(e){this._rotateX=e}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new Sc(this.viewer.scene,ge.apply(t,{maxGeometryBatchSize:5e5,isModel:!0}));if(!(t.src||t.las||t.manifest||t.manifestSrc))return this.error("load() param expected: src or las"),i;var r={las:{skip:this._skip,fp64:this._fp64,colorDepth:this._colorDepth}},n=this.viewer.scene.canvas.spinner,s=function(){i.scene.once("tick",(function(){i.destroyed||(i.scene.fire("modelLoaded",i.id),i.fire("loaded",!0,!1))})),n.processes--},o=function(t){n.processes--,e.error(t),i.fire("error",t)};if(t.src)this._loadModel(t.src,t,r,i);else if(t.las)n.processes++,this._parseModel(t.las,t,r,i).then(s,o);else if(t.manifest||t.manifestSrc){var a=t.manifestSrc?KD(t.manifestSrc):"",l=function(n){var l=0,u=new Array(n.length);!function A(){if(i.destroyed)s();else{if(l>=n.length)return;u[l]=!1,e._dataSource.getLAS("".concat(a).concat(n[l]),(function(n){var o=ge.apply(t,{isManifest:!0,index:l});e._parseModel(n,o,r,i).then((function(){u[o.index]=!0;var e=!0;u.forEach((function(t){t||(e=!1)})),e&&s()})),l++,e.scheduleTask(A,200)}),o)}}()},u=function(t){if(!i.destroyed){var r=t.lasFiles||t.lazFiles;!r||r.length<=0?e.error("load(): Failed to load model manifest - manifest not valid"):l(r)}};if(t.manifestSrc)this._dataSource.getManifest(t.manifestSrc,(function(e){u(e)}),(function(t){e.error(t),i.fire("error",t)}));else{var A=t.manifest;u(A)}}return i}},{key:"_loadModel",value:function(e,t,i,r){var n=this,s=this.viewer.scene.canvas.spinner;s.processes++,this._dataSource.getLAS(t.src,(function(e){n._parseModel(e,t,i,r).then((function(){r.scene.once("tick",(function(){r.destroyed||(r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1))})),s.processes--}),(function(e){s.processes--,n.error(e),r.fire("error",e)}))}),(function(e){s.processes--,n.error(e),r.fire("error",e)}))}},{key:"_parseModel",value:function(e,t,i,r){var n=this,s=function(e){var t=e.value;if(n._center){for(var i=le.vec3(),r=t.length,s=0,o=t.length;s<o;s+=3)i[0]+=t[s+0],i[1]+=t[s+1],i[2]+=t[s+2];i[0]/=r,i[1]/=r,i[2]/=r;for(var a=0,l=t.length;a<l;a+=3)t[a+0]-=i[0],t[a+1]-=i[1],t[a+2]-=i[2]}if(n._rotateX&&t)for(var u=0,A=t.length;u<A;u+=3){var c=t[u+1];t[u+1]=t[u+2],t[u+2]=c}if(n._rotate){var h=le.identityQuaternion(),d=le.mat4();le.eulerToQuaternion(n._rotate,"XYZ",h),le.quaternionToRotationMat4(h,d);for(var p=le.vec3(),f=0,v=t.length;f<v;f+=3)p[0]=t[f+0],p[1]=t[f+1],p[2]=t[f+2],le.transformPoint3(d,p,p),t[f+0]=p[0],t[f+1]=p[1],t[f+2]=p[2]}if(n._transform)for(var g=le.mat4(n._transform),m=le.vec3(),_=0,y=t.length;_<y;_+=3)m[0]=t[_+0],m[1]=t[_+1],m[2]=t[_+2],le.transformPoint3(g,m,m),t[_+0]=m[0],t[_+1]=m[1],t[_+2]=m[2];return t};function o(e,t){for(var i=e.value,r=e.size,n=t.value,s=4*n.length,o=new Uint8Array(s),a=0,l=0,u=0,A=n.length;a<A;a++,u+=r,l+=4)o[l+0]=i[u+0],o[l+1]=i[u+1],o[l+2]=i[u+2],o[l+3]=Math.round(n[a]/65536*255);return o}function a(e){for(var t=e.value,i=4*t.length,r=new Uint8Array(i),n=0,s=0,o=t.length;n<o;n++,s+=4)r[s+0]=0,r[s+1]=0,r[s+2]=0,r[s+3]=Math.round(t[n]/65536*255);return r}return new Promise((function(l,u){if(r.destroyed)u();else{var A=t.stats||{};A.sourceFormat="LAS",A.schemaVersion="",A.title="",A.author="",A.created="",A.numMetaObjects=0,A.numPropertySets=0,A.numObjects=0,A.numGeometries=0,A.numTriangles=0,A.numVertices=0;try{var c=GD(e);Tg(e,Lw,i).then((function(e){var A,h,d=e.attributes,p=e.loaderData,f=void 0!==p.pointsFormatId?p.pointsFormatId:-1;if(!d.POSITION)return r.finalize(),void u("No positions found in file");switch(f){case 0:A=s(d.POSITION),h=a(d.intensity);break;case 1:if(!d.intensity)return r.finalize(),void u("No positions found in file");A=s(d.POSITION),h=a(d.intensity);break;case 2:case 3:if(!d.intensity)return r.finalize(),void u("No positions found in file");A=s(d.POSITION),h=o(d.COLOR_0,d.intensity)}for(var v=XD(A,15e5),g=XD(h,2e6),m=[],_=0,y=v.length;_<y;_++){var b="".concat(t.isManifest?"model"+t.index:"","pointsMesh").concat(_);m.push(b),r.createMesh({id:b,primitive:"points",positions:v[_],colorsCompressed:_<g.length?g[_]:null})}var w=t.entityId||le.createUUID();if(r.createEntity({id:w,meshIds:m,isObject:!0}),r.finalize(),t.metaModelJSON){var B=r.id;n.viewer.metaScene.createMetaModel(B,t.metaModelJSON,i)}else if(!1!==t.loadMetadata){var x=le.createUUID(),P={projectId:"",author:"",createdAt:"",schema:"",creatingApplication:"",metaObjects:[{id:x,name:"Model",type:"Model"},{id:w,name:"PointCloud (LAS)",type:"PointCloud",parent:x,attributes:c||{}}],propertySets:[]},C=r.id;n.viewer.metaScene.createMetaModel(C,P,i)}l()}))}catch(e){r.finalize(),u(e)}}}))}}]),i}();function XD(e,t){if(t>=e.length)return[e];for(var i=[],r=0;r<e.length;r+=t)i.push(e.slice(r,r+t));return i}function KD(e){e.indexOf("?")>-1&&(e=e.split("?")[0]);var t=e.split("/");return t.pop(),t.join("/")+"/"}var ZD=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getCityJSON",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}}]),e}(),JD=le.vec2(),YD=le.vec3(),qD=le.vec3(),$D=le.vec3(),eS=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"cityJSONLoader",e,n)).dataSource=n.dataSource,r}return I(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new ZD}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);var t=new Sc(this.viewer.scene,ge.apply(e,{isModel:!0,edges:!0}));if(!e.src&&!e.cityJSON)return this.error("load() param expected: src or cityJSON"),t;var i={};if(e.src)this._loadModel(e.src,e,i,t);else{var r=this.viewer.scene.canvas.spinner;r.processes++,this._parseModel(e.cityJSON,e,i,t),r.processes--}return t}},{key:"_loadModel",value:function(e,t,i,r){var n=this,s=this.viewer.scene.canvas.spinner;s.processes++,this._dataSource.getCityJSON(t.src,(function(e){n._parseModel(e,t,i,r),s.processes--}),(function(e){s.processes--,n.error(e),r.fire("error",e)}))}},{key:"_parseModel",value:function(e,t,i,r){if(!r.destroyed){var n=e.transform?this._transformVertices(e.vertices,e.transform,i.rotateX):e.vertices,s=t.stats||{};s.sourceFormat=e.type||"CityJSON",s.schemaVersion=e.version||"",s.title="",s.author="",s.created="",s.numMetaObjects=0,s.numPropertySets=0,s.numObjects=0,s.numGeometries=0,s.numTriangles=0,s.numVertices=0;var o=!1!==t.loadMetadata,a=o?{id:le.createUUID(),name:"Model",type:"Model"}:null,l=o?{id:"",projectId:"",author:"",createdAt:"",schema:e.version||"",creatingApplication:"",metaObjects:[a],propertySets:[]}:null,u={data:e,vertices:n,sceneModel:r,loadMetadata:o,metadata:l,rootMetaObject:a,nextId:0,stats:s};if(this._parseCityJSON(u),r.finalize(),o){var A=r.id;this.viewer.metaScene.createMetaModel(A,u.metadata,i)}r.scene.once("tick",(function(){r.destroyed||(r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1))}))}}},{key:"_transformVertices",value:function(e,t,i){for(var r=[],n=t.scale||le.vec3([1,1,1]),s=t.translate||le.vec3([0,0,0]),o=0,a=0;o<e.length;o++,a+=3){var l=e[o][0]*n[0]+s[0],u=e[o][1]*n[1]+s[1],A=e[o][2]*n[2]+s[2];i?r.push([l,A,u]):r.push([l,u,A])}return r}},{key:"_parseCityJSON",value:function(e){var t=e.data.CityObjects;for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];this._parseCityObject(e,r,i)}}},{key:"_parseCityObject",value:function(e,t,i){var r=e.sceneModel,n=e.data;if(e.loadMetadata){var s=i,o=t.type,a=o+" : "+i,l=t.parents?t.parents[0]:e.rootMetaObject.id;e.metadata.metaObjects.push({id:s,name:a,type:o,parent:l})}if(e.stats.numMetaObjects++,t.geometry&&t.geometry.length>0){for(var u=[],A=0,c=t.geometry.length;A<c;A++){var h=t.geometry[A],d=void 0,p=void 0,f=n.appearance;if(f){var v=f.materials;if(v){var g=h.material;if(g){var m=Object.keys(g);if(m.length>0){var _=g[m[0]];if(void 0!==_.value)d=v[_.value];else{var y=_.values;if(y){p=[];for(var b=0,w=y.length;b<w;b++){var B=v[y[A]];p.push(B)}}}}}}}p?this._parseGeometrySurfacesWithOwnMaterials(e,h,p,u):this._parseGeometrySurfacesWithSharedMaterial(e,h,d,u)}u.length>0&&(r.createEntity({id:i,meshIds:u,isObject:!0}),e.stats.numObjects++)}}},{key:"_parseGeometrySurfacesWithOwnMaterials",value:function(e,t,i,r){switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":var n=t.boundaries;this._parseSurfacesWithOwnMaterials(e,i,n,r);break;case"Solid":for(var s=t.boundaries,o=0;o<s.length;o++){var a=s[o];this._parseSurfacesWithOwnMaterials(e,i,a,r)}break;case"MultiSolid":case"CompositeSolid":for(var l=t.boundaries,u=0;u<l.length;u++)for(var A=0;A<l[u].length;A++){var c=l[u][A];this._parseSurfacesWithOwnMaterials(e,i,c,r)}}}},{key:"_parseSurfacesWithOwnMaterials",value:function(e,t,i,r){for(var n=e.vertices,s=e.sceneModel,o=0;o<i.length;o++){for(var a=i[o],l=t[o]||{diffuseColor:[.8,.8,.8],transparency:1},u=[],A=[],c=[],h={positions:[],indices:[]},d=0;d<a.length;d++){u.length>0&&A.push(u.length);var p=this._extractLocalIndices(e,a[d],c,h);u.push.apply(u,f(p))}if(3===u.length)h.indices.push(u[0]),h.indices.push(u[1]),h.indices.push(u[2]);else if(u.length>3){for(var v=[],g=0;g<u.length;g++)v.push({x:n[c[u[g]]][0],y:n[c[u[g]]][1],z:n[c[u[g]]][2]});for(var m=this._getNormalOfPositions(v,le.vec3()),_=[],y=0;y<v.length;y++)this._to2D(v[y],m,JD),_.unshift(JD[0]),_.unshift(JD[1]);for(var b=dd(_,A,2),w=0;w<b.length;w+=3)h.indices.unshift(u[b[w]]),h.indices.unshift(u[b[w+1]]),h.indices.unshift(u[b[w+2]])}var B=""+e.nextId++;s.createMesh({id:B,primitive:"triangles",positions:h.positions,indices:h.indices,color:l&&l.diffuseColor?l.diffuseColor:[.8,.8,.8],opacity:l&&void 0!==l.transparency?1-l.transparency:1}),r.push(B),e.stats.numGeometries++,e.stats.numVertices+=h.positions.length/3,e.stats.numTriangles+=h.indices.length/3}}},{key:"_parseGeometrySurfacesWithSharedMaterial",value:function(e,t,i,r){var n=e.sceneModel,s=[],o={positions:[],indices:[]};switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":var a=t.boundaries;this._parseSurfacesWithSharedMaterial(e,a,s,o);break;case"Solid":for(var l=t.boundaries,u=0;u<l.length;u++){var A=l[u];this._parseSurfacesWithSharedMaterial(e,A,s,o)}break;case"MultiSolid":case"CompositeSolid":for(var c=t.boundaries,h=0;h<c.length;h++)for(var d=0;d<c[h].length;d++){var p=c[h][d];this._parseSurfacesWithSharedMaterial(e,p,s,o)}}if(o.positions.length>0&&o.indices.length>0){var f=""+e.nextId++;n.createMesh({id:f,primitive:"triangles",positions:o.positions,indices:o.indices,color:i&&i.diffuseColor?i.diffuseColor:[.8,.8,.8],opacity:1}),r.push(f),e.stats.numGeometries++,e.stats.numVertices+=o.positions.length/3,e.stats.numTriangles+=o.indices.length/3}}},{key:"_parseSurfacesWithSharedMaterial",value:function(e,t,i,r){for(var n=e.vertices,s=0;s<t.length;s++){for(var o=[],a=[],l=0;l<t[s].length;l++){o.length>0&&a.push(o.length);var u=this._extractLocalIndices(e,t[s][l],i,r);o.push.apply(o,f(u))}if(3===o.length)r.indices.push(o[0]),r.indices.push(o[1]),r.indices.push(o[2]);else if(o.length>3){for(var A=[],c=0;c<o.length;c++)A.push({x:n[i[o[c]]][0],y:n[i[o[c]]][1],z:n[i[o[c]]][2]});for(var h=this._getNormalOfPositions(A,le.vec3()),d=[],p=0;p<A.length;p++)this._to2D(A[p],h,JD),d.unshift(JD[0]),d.unshift(JD[1]);for(var v=dd(d,a,2),g=0;g<v.length;g+=3)r.indices.unshift(o[v[g]]),r.indices.unshift(o[v[g+1]]),r.indices.unshift(o[v[g+2]])}}}},{key:"_extractLocalIndices",value:function(e,t,i,r){for(var n=e.vertices,s=[],o=0,a=t.length;o<a;o++){var l=t[o];if(i.includes(l)){var u=i.indexOf(l);s.push(u)}else r.positions.push(n[l][0]),r.positions.push(n[l][1]),r.positions.push(n[l][2]),s.push(i.length),i.push(l)}return s}},{key:"_getNormalOfPositions",value:function(e,t){for(var i=0;i<e.length;i++){var r=i+1;r===e.length&&(r=0),t[0]+=(e[i].y-e[r].y)*(e[i].z+e[r].z),t[1]+=(e[i].z-e[r].z)*(e[i].x+e[r].x),t[2]+=(e[i].x-e[r].x)*(e[i].y+e[r].y)}return le.normalizeVec3(t)}},{key:"_to2D",value:function(e,t,i){var r=YD,n=qD,s=$D;r[0]=e.x,r[1]=e.y,r[2]=e.z,n[0]=t.x,n[1]=t.y,n[2]=t.z,s[0]=1.1,s[1]=1.1,s[2]=1.1,le.lenVec3(le.subVec3(s,n))<.01&&(s[0]+=1,s[1]+=2,s[2]+=3);var o=le.dotVec3(s,n),a=le.mulVec3Scalar(n,o,le.vec3());s[0]-=a[0],s[1]-=a[1],s[2]-=a[2],le.normalizeVec3(s);var l=le.cross3Vec3(n,s,le.vec3()),u=le.dotVec3(r,s),A=le.dotVec3(r,l);i[0]=u,i[1]=A}}]),i}(),tS=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};k(this,e),this.cacheBuster=!1!==t.cacheBuster}return I(e,[{key:"_cacheBusterURL",value:function(e){if(!this.cacheBuster)return e;var t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}},{key:"getDotBIM",value:function(e,t,i){ge.loadJSON(this._cacheBusterURL(e),(function(e){t(e)}),(function(e){i(e)}))}}]),e}(),iS=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"DotBIMLoader",e,n)).dataSource=n.dataSource,r.objectDefaults=n.objectDefaults,r}return I(i,[{key:"dataSource",get:function(){return this._dataSource},set:function(e){this._dataSource=e||new tS}},{key:"objectDefaults",get:function(){return this._objectDefaults},set:function(e){this._objectDefaults=e||vI}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new Sc(this.viewer.scene,ge.apply(t,{isModel:!0,backfaces:t.backfaces,dtxEnabled:t.dtxEnabled,rotation:t.rotation,origin:t.origin})),r=i.id;if(!t.src&&!t.dotBIM)return this.error("load() param expected: src or dotBIM"),i;var n,s,o=t.objectDefaults||this._objectDefaults||vI;if(t.includeTypes){n={};for(var a=0,l=t.includeTypes.length;a<l;a++)n[t.includeTypes[a]]=!0}if(t.excludeTypes){s={},n||(n={});for(var u=0,A=t.excludeTypes.length;u<A;u++)n[t.excludeTypes[u]]=!0}var c=function(t){for(var i=t.fileData,a=t.sceneModel,l={},u=le.createUUID(),A=le.createUUID(),c=le.createUUID(),h=le.createUUID(),d={metaObjects:[{id:u,name:"Project",type:"Project",parent:null},{id:A,name:"Site",type:"Site",parent:u},{id:c,name:"Building",type:"Building",parent:A},{id:h,name:"BuildingStorey",type:"BuildingStorey",parent:c}],propertySets:[]},p=i.elements,v=function(e,t){var r=p[e],u=r.type;if(s&&s[u])return"continue";if(n&&!n[u])return"continue";var A=r.info,c=void 0!==r.guid?"".concat(r.guid):void 0!==A&&void 0!==A.id?A.id:e,v=r.mesh_id,g=r.vector,m=r.rotation,_=o?o[u]||o.DEFAULT:null,y=!0,b=!0;if(void 0===r.face_colors){!function(e,t){if(!l[e]){var r=i.meshes.find((function(e){return e.mesh_id===t.mesh_id}));a.createGeometry({id:e,primitive:"triangles",positions:r.coordinates,indices:r.indices}),l[e]=!0}}(v,r);var w="".concat(c,"-mesh-").concat(v),B=r.color?[r.color.r/255,r.color.g/255,r.color.b/255]:[1,1,1],x=r.color?r.color.a/255:1;_&&(!1===_.visible&&(y=!1),!1===_.pickable&&(b=!1),_.colorize&&(B=_.colorize),void 0!==_.opacity&&null!==_.opacity&&(x=_.opacity)),a.createMesh({id:w,geometryId:v,color:B,opacity:x,quaternion:!m||0===m.qz&&0===m.qy&&0===m.qx&&1===m.qw?void 0:[m.qx,m.qy,m.qz,m.qw],position:g?[g.x,g.y,g.z]:void 0}),a.createEntity({id:c,meshIds:[w],visible:y,pickable:b,isObject:!0})}else{for(var P=r.face_colors,M={},F=0,k=i.meshes.find((function(e){return e.mesh_id===r.mesh_id})),E=0,I=P.length;E<I;E+=4){var T=[P[E],P[E+1],P[E+2],P[E+3]];void 0===M[T]&&(M[T]=[]);var D=k.indices[F],S=k.coordinates[3*D],R=k.coordinates[3*D+1],U=k.coordinates[3*D+2],L=k.indices[F+1],O=k.coordinates[3*L],N=k.coordinates[3*L+1],V=k.coordinates[3*L+2],Q=k.indices[F+2],H=k.coordinates[3*Q],G=k.coordinates[3*Q+1],j=k.coordinates[3*Q+2];M[T].push(S,R,U,O,N,V,H,G,j),F+=3}for(var z=[],W=0,X=Object.entries(M);W<X.length;W++){var K=C(X[W],2),Z=K[0],J=K[1];a.createGeometry({id:"".concat(v,"-").concat(Z),primitive:"triangles",positions:J,indices:f(Array(J.length/3).keys())});var Y="".concat(c,"-mesh-").concat(v,"-").concat(Z),q=Z.split(",").map(Number),$=[q[0]/255,q[1]/255,q[2]/255],ee=q[3]/255;_&&(!1===_.visible&&(y=!1),!1===_.pickable&&(b=!1),_.colorize&&($=_.colorize),void 0!==_.opacity&&null!==_.opacity&&(ee=_.opacity)),a.createMesh({id:Y,geometryId:"".concat(v,"-").concat(Z),color:$,opacity:ee,quaternion:!m||0===m.qz&&0===m.qy&&0===m.qx&&1===m.qw?void 0:[m.qx,m.qy,m.qz,m.qw],position:g?[g.x,g.y,g.z]:void 0}),z.push(Y)}a.createEntity({id:c,meshIds:z,visible:y,pickable:b,isObject:!0})}var te=[];for(var ie in A)te.push({name:ie,value:A[ie]});d.propertySets.push({id:c,name:"Properties",properties:te}),d.metaObjects.push({id:c,name:A&&A.Name&&"None"!==A.Name?A.Name:"".concat(r.type," ").concat(c),type:r.type,parent:h,propertySetIds:[c]})},g=0,m=p.length;g<m;g++)v(g);a.finalize(),e.viewer.metaScene.createMetaModel(r,d),a.scene.once("tick",(function(){a.destroyed||(a.scene.fire("modelLoaded",a.id),a.fire("loaded",!0,!1))}))};if(t.src){var h=t.src;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getDotBIM(h,(function(t){c({fileData:t,sceneModel:i,nextId:0,error:function(e){}}),e.viewer.scene.canvas.spinner.processes--}),(function(t){e.viewer.scene.canvas.spinner.processes--,e.error(t)}))}else if(t.dotBIM){var d={fileData:t.dotBIM,sceneModel:i,nextId:0,error:function(e){}};c(d)}return i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(r)})),i}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}(),rS=function(e){var t=function(t){return parseInt(e.substr(t+1,2),16)/255};return[t(0),t(2),t(4)]},nS=function(e,t,i){var r=null,n=function(n){if(n){r&&r.destroy();try{var s,o,a=hE(n.map((function(e){return[e[0],e[2]]}))),l=C(a,2),u=l[0],A=l[1],c=(s=[]).concat.apply(s,f(u.map((function(e){return[e[0],n[0][1],e[1]]})))),h=(o=[]).concat.apply(o,f(A));r=new vn(e,{pickable:!1,geometry:new mt(e,{positions:c,indices:h,normals:le.buildNormals(c,h)}),material:new bn(e,{alpha:void 0!==i?i:.5,backfaces:!0,diffuse:rS(t)})})}catch(e){r=null}}r&&(r.visible=!!n)};return n(null),{updateBase:n,destroy:function(){return r&&r.destroy()}}},sS=function(e,t){return function(i,r,n){var s=e.scene,o=s.canvas.canvas,a=function(e,t){return t[0]=e.clientX,t[1]=e.clientY,eE(o.ownerDocument.documentElement,o,t),t},l=function(e){var i=le.vec3(),r=le.vec3();return le.canvasPosToWorldRay(o,s.camera.viewMatrix,s.camera.projMatrix,s.camera.projection,e,i,r),t(i,r)},u=!1,A=function(){u=!1},c=function(){A(),o.removeEventListener("mousedown",d),o.removeEventListener("mousemove",p),e.cameraControl.off(f),o.removeEventListener("mouseup",v)},h=le.vec2(),d=function(e){1===e.which&&(a(e,h),u=!0)};o.addEventListener("mousedown",d);var p=function(e){var t=a(e,le.vec2());u&&le.distVec2(h,t)>20&&(A(),i())};o.addEventListener("mousemove",p);var f=e.cameraControl.on("rayMove",(function(e){var t=e.canvasPos;r(t,l(t))})),v=function(e){if(1===e.which&&u){c();var t=a(e,le.vec2());n(t,l(t))}};return o.addEventListener("mouseup",v),c}},oS=function(e,t,i,r){var n=-(le.dotVec3(i,t)-e)/le.dotVec3(r,t),s=le.vec3();return le.mulVec3Scalar(r,n,s),le.addVec3(i,s,s),s},aS=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(k(this,i),(r=t.call(this,e.viewer.scene,n)).plugin=e,r._container=n.container,!r._container)throw"config missing: container";return r._eventSubs={},r.plugin.viewer.scene,r._geometry=n.geometry,n.onMouseOver,n.onMouseLeave,n.onContextMenu,r._alpha="alpha"in n&&void 0!==n.alpha?n.alpha:.5,r.color=n.color,r._visible=!0,r._rebuildMesh(),r}return I(i,[{key:"_rebuildMesh",value:function(){var e,t=this,i=this.plugin.viewer.scene,r=this._geometry.planeCoordinates.slice(),n=this._geometry.height<0,s=this._geometry.altitude+(n?this._geometry.height:0),o=this._geometry.height*(n?-1:1),a=C(hE(r),3),l=a[0],u=a[1],A=a[2],c=[],h=[],d=function(e){var t,i=c.length,r=p(l);try{for(r.s();!(t=r.n()).done;){var n=t.value;c.push([n[0],s+(e?o:0),n[1]])}}catch(e){r.e(e)}finally{r.f()}var a,A=p(u);try{for(A.s();!(a=A.n()).done;){var d=a.value;h.push.apply(h,f((e?d:d.slice(0).reverse()).map((function(e){return e+i}))))}}catch(e){A.e(e)}finally{A.f()}};d(!1),d(!0);for(var v=function(e){var t=l[e],i=l[(l.length+e+(A?1:-1))%l.length],r=s,n=s+o,a=c.length;c.push([t[0],r,t[1]],[i[0],r,i[1]],[i[0],n,i[1]],[t[0],n,t[1]]),h.push.apply(h,f([0,1,2,0,2,3].map((function(e){return e+a}))))},g=0;g<l.length;++g)v(g);this._zoneMesh&&this._zoneMesh.destroy();var m=function(e){return Math.min.apply(Math,f(c.map((function(t){return t[e]}))))},_=function(e){return Math.max.apply(Math,f(c.map((function(t){return t[e]}))))},y=m(0),b=m(1),w=m(2),B=_(0),x=_(1),P=_(2);this._center=le.vec3([(y+B)/2,(b+x)/2,(w+P)/2]);var M=(e=[]).concat.apply(e,f(c.map((function(e){return le.subVec3(e,t._center,e)}))));this._zoneMesh=new vn(i,{origin:this._center,edges:this._edges,geometry:new mt(i,{positions:M,indices:h,normals:le.buildNormals(M,h)}),material:new bn(i,{alpha:this._alpha,backfaces:!0,diffuse:rS(this._color)}),visible:this._visible}),this._zoneMesh.highlighted=this._highlighted,this._zoneMesh.zone=this;var F,k=le.vec2(),E=le.vec2(),I=0,T=p(u);try{for(T.s();!(F=T.n()).done;){var D=F.value,S=l[D[0]],R=l[D[1]],U=l[D[2]];le.subVec2(R,S,k),le.subVec2(U,S,E),I+=Math.abs(k[0]*E[1]-k[1]*E[0])}}catch(e){T.e(e)}finally{T.f()}this._baseArea=I/2,this._metrics=null}},{key:"baseArea",get:function(){return this._baseArea}},{key:"area",get:function(){return this._getMetrics().area}},{key:"volume",get:function(){return this._getMetrics().volume}},{key:"_getMetrics",value:function(){if(null===this._metrics){for(var e=0,t=0,i=this._zoneMesh.geometry,r=[le.vec3(),le.vec3(),le.vec3()],n=le.vec3(),s=0;s<i.indices.length;s+=3){for(var o=0;o<3;++o)for(var a=r[o],l=3*i.indices[s+o],u=0;u<3;++u)a[u]=i.positions[l+u];e+=le.dotVec3(r[0],le.cross3Vec3(r[1],r[2],n)),le.subVec3(r[1],r[0],r[1]),le.subVec3(r[2],r[0],r[2]),t+=le.lenVec3(le.cross3Vec3(r[1],r[2],n))}this._metrics={area:t/2,volume:e/6}}return this._metrics}},{key:"sectionedAverage",value:function(e){var t=this._geometry.planeCoordinates.slice(),i=[],r=this._geometry.height,n=this._geometry.altitude,s=n+Math.max(0,r),o=n+Math.min(0,r),a=function(e){var r=t.map((function(t){return[t[0],e?s:o,t[1]]}));i.push(e?r:r.slice(0).reverse())};a(!0),a(!1);for(var l=function(e,i){return[t[e][0],i,t[e][1]]},u=0;u<t.length;++u){var A=(u+1)%t.length;i.push([l(u,o),l(A,o),l(A,s),l(u,s)])}var c,h=p(e);try{for(h.s();!(c=h.n()).done;){var d,f=c.value,v=f.dir,g=f.dist,m=[],_=p(i);try{for(_.s();!(d=_.n()).done;){for(var y=d.value,b=1e-5,w=0,B=[],x=0;x<y.length;x++){var P=le.dotVec3(v,y[x])+g,C=P<-1e-5?2:P>b?1:0;w|=C,B.push(C)}switch(w){case 0:case 1:m.push(y);break;case 2:break;case 3:for(var M=[],F=0;F<y.length;F++){var k=(F+1)%y.length,E=B[F],I=B[k],T=y[F],D=y[k];if(2!==E&&M.push(T),3==(E|I)){var S=le.vec3();le.subVec3(D,T,S);var R=-(g+le.dotVec3(v,T))/le.dotVec3(v,S),U=[0,0,0];le.lerpVec3(R,0,1,T,D,U),M.push(U)}}M.length>=3&&m.push(M)}}}catch(e){_.e(e)}finally{_.f()}i=m}}catch(e){h.e(e)}finally{h.f()}if(0===i.length)return null;var L,O=le.vec3([0,0,0]),N=new Set,V=p(i);try{for(V.s();!(L=V.n()).done;){var Q,H=p(L.value);try{for(H.s();!(Q=H.n()).done;){var G=Q.value,j=G.map((function(e){return e.toFixed(3)})).join(":");N.has(j)||(N.add(j),le.addVec3(O,G,O))}}catch(e){H.e(e)}finally{H.f()}}}catch(e){V.e(e)}finally{V.f()}return le.mulVec3Scalar(O,1/N.size,O),O}},{key:"center",get:function(){return this._center}},{key:"altitude",get:function(){return this._geometry.altitude},set:function(e){this._geometry.altitude=e,this._rebuildMesh()}},{key:"height",get:function(){return this._geometry.height},set:function(e){this._geometry.height=e,this._rebuildMesh()}},{key:"highlighted",get:function(){return this._highlighted},set:function(e){this._highlighted=e,this._zoneMesh&&(this._zoneMesh.highlighted=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._zoneMesh&&(this._zoneMesh.material.diffuse=rS(this._color))}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._alpha=e,this._zoneMesh&&(this._zoneMesh.material.alpha=this._alpha)}},{key:"edges",get:function(){return this._edges},set:function(e){this._edges=e,this._zoneMesh&&(this._zoneMesh.edges=this._edges)}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible=!!e,this._zoneMesh.visible=this._visible,this._needUpdate()}},{key:"getJSON",value:function(){return{id:this.id,geometry:this._geometry,alpha:this._alpha,color:this._color}}},{key:"duplicate",value:function(){return this.plugin.createZone({id:le.createUUID(),geometry:{planeCoordinates:this._geometry.planeCoordinates.map((function(e){return e.slice()})),altitude:this._geometry.altitude,height:this._geometry.height},alpha:this._alpha,color:this._color})}},{key:"destroy",value:function(){this._zoneMesh.destroy(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),lS=function(e){m(i,Ie);var t=y(i);function i(e,r,n){var s;return k(this,i),(s=t.call(this,e.viewer.scene)).zonesPlugin=e,s.pointerLens=r.pointerLens,s.createSelect3dPoint=n,s._deactivate=null,s}return I(i,[{key:"active",get:function(){return!!this._deactivate}},{key:"activate",value:function(e,t,i,r){if(!this._deactivate){if("object"===P(e)&&null!==e){var n=e,s=function(e,t){if(e in n)return n[e];if(void 0!==t)return t;throw"config missing: "+e};e=s("altitude"),t=s("height"),i=s("color","#008000"),r=s("alpha",.5)}var o=this.zonesPlugin,a=o.viewer,l=a.scene,u=this,A=this.createSelect3dPoint(a,(function(t,i){return oS(e,le.vec3([0,1,0]),t,i)}));!function n(){var s=nS(l,i,r),a=function(e,t,i,r,n,s){var o=aE(e,t),a=aE(e,t),l=i?function(e){i.visible=!!e,e&&(i.canvasPos=e)}:function(){},u=r((function(){l(null),o.update(null)}),(function(e,t){l(e),o.update(t)}),(function(e,t){o.update(t),u=r((function(){l(null),a.update(null),n(null)}),(function(e,i){l(e),a.update(i),n(le.distVec3(t,i)>.01&&[t,i])}),(function(e,i){a.update(i),o.destroy(),a.destroy(),l(null),s([t,i])}))}));return{deactivate:function(){u(),o.destroy(),a.destroy(),l(null)}}}(l,i,u.pointerLens,A,(function(e){if(e){var t=e[0],i=e[1],r=function(e){return Math.min(t[e],i[e])},n=function(e){return Math.max(t[e],i[e])},o=r(0),a=r(1),l=r(2),u=n(0);n(1);var A=n(2);s.updateBase([[o,a,A],[u,a,A],[u,a,l],[o,a,l]])}else s.updateBase(null)}),(function(a){s.destroy();var l=function(e,t,i,r,n,s,o){var a=function(i){return Math.min(e[i],t[i])},l=function(i){return Math.max(e[i],t[i])},u=a(0),A=a(2),c=l(0),h=l(2);return o.createZone({id:le.createUUID(),geometry:{planeCoordinates:[[u,h],[c,h],[c,A],[u,A]],altitude:i,height:r},alpha:s,color:n})}(a[0],a[1],e,t,i,r,o),A=!0;u._deactivate=function(){A=!1},u.fire("zoneEnd",l),A&&n()})).deactivate;u._deactivate=function(){a(),s.destroy()}}()}}},{key:"deactivate",value:function(){this._deactivate&&(this._deactivate(),this._deactivate=null)}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),uS=function(e){m(i,lS);var t=y(i);function i(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),t.call(this,e,r,(function(e,t){return sS(e,t)}))}return I(i)}(),AS=function(e){m(i,lS);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};k(this,i);var s=new Qe(e.viewer);return(r=t.call(this,e,n,(function(e,t){return cE(e,s,t)}))).pointerCircle=s,r}return I(i,[{key:"destroy",value:function(){this.pointerCircle.destroy(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),cS=function(e){m(i,vh);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,"Zones",e))._pointerLens=n.pointerLens,r._container=n.container||document.body,r._zones=[],r.defaultColor=void 0!==n.defaultColor?n.defaultColor:"#00BBFF",r.zIndex=n.zIndex||1e4,r._onMouseOver=function(e,t){r.fire("mouseOver",{plugin:w(r),zone:t,event:e})},r._onMouseLeave=function(e,t){r.fire("mouseLeave",{plugin:w(r),zone:t,event:e})},r._onContextMenu=function(e,t){r.fire("contextMenu",{plugin:w(r),zone:t,event:e})},r}return I(i,[{key:"createZone",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);var i=new aS(this,{id:t.id,plugin:this,container:this._container,geometry:t.geometry,alpha:t.alpha,color:t.color,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._zones.push(i),i.on("destroyed",(function(){var t=e._zones.indexOf(i);t>=0&&e._zones.splice(t,1)})),this.fire("zoneCreated",i),i}},{key:"zones",get:function(){return this._zones}},{key:"destroy",value:function(){v(x(i.prototype),"destroy",this).call(this)}}]),i}(),hS=function(e,t,i,r,n,s,o,a,l){var u,A=s?function(e){s.visible=!!e,e&&(s.canvasPos=e)}:function(){},c=[function(){return A(null)}],h=nS(e,r,n);return c.push((function(){return h.destroy()})),function s(d){var p=aE(e,r),f=d.length>0&&lE(e,r),v=f&&d[d.length-1].getWorldPos();c.push((function(){p.destroy(),f&&f.destroy()}));var g=d.length>0&&d[0],m=function(e){var t=g&&g.getCanvasPos();return t&&le.distVec2(t,e)<10&&{canvasPos:t,worldPos:g.getWorldPos()}},_=function(){var e=function(e,t,i){return t[0]<=Math.max(e[0],i[0])&&t[0]>=Math.min(e[0],i[0])&&t[1]<=Math.max(e[1],i[1])&&t[1]>=Math.min(e[1],i[1])},t=function(e,t,i){var r=(t[1]-e[1])*(i[0]-t[0])-(t[0]-e[0])*(i[1]-t[1]);return 0===r?0:r>0?1:2};return function(i,r){for(var n=i[i.length-2],s=i[i.length-1],o=r?1:0;o<i.length-2-1;++o){var a=i[o],l=i[o+1],u=t(n,s,a),A=t(n,s,l),c=t(a,l,n),h=t(a,l,s);if(u!==A&&c!==h||0===u&&e(n,a,s)||0===A&&e(n,l,s)||0===c&&e(a,n,l)||0===h&&e(a,s,l))return!0}return!1}}();u=a((function(){A(null),p.update(null),f&&f.update(v,null),h.updateBase(d.length>2?d.map((function(e){return e.getWorldPos()})):null)}),(function(e,t){var i=d.length>2&&m(e);if(g&&g.setHighlighted(!!i),A(i?i.canvasPos:e),p.update(!i&&t),f&&f.update(v,i?i.worldPos:t),d.length>=2){var r=d.map((function(e){return e.getWorldPos()})).concat(i?[]:[t]),n=_(r.map((function(e){return[e[0],e[2]]})),i);h.updateBase(n?null:r)}else h.updateBase(null)}),(function(e,a){var u=d.length>2&&m(e),A=d.map((function(e){return e.getWorldPos()})).concat(u?[]:[a]);h.updateBase(A);var g=A.map((function(e){return[e[0],e[2]]}));d.length>2&&_(g,u)?(c.pop()(),s(d)):u?(p.update(a),c.forEach((function(e){return e()})),l(o.createZone({id:le.createUUID(),geometry:{planeCoordinates:g,altitude:t,height:i},alpha:n,color:r}))):(p.update(a),f&&f.update(v,a),s(d.concat(p)))}))}([]),{closeSurface:function(){throw"TODO"},deactivate:function(){u(),c.forEach((function(e){return e()}))}}},dS=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e.viewer.scene)).zonesPlugin=e,r.pointerLens=n.pointerLens,r._action=null,r}return I(i,[{key:"active",get:function(){return!!this._action}},{key:"activate",value:function(e,t,i,r){if("object"===P(e)&&null!==e){var n=e,s=function(e,t){if(e in n)return n[e];if(void 0!==t)return t;throw"config missing: "+e};e=s("altitude"),t=s("height"),i=s("color","#008000"),r=s("alpha",.5)}if(!this._action){var o=this.zonesPlugin,a=o.viewer,l=a.scene,u=this,A=sS(a,(function(t,i){return oS(e,le.vec3([0,1,0]),t,i)}));!function n(){u._action=hS(l,e,t,i,r,u.pointerLens,o,A,(function(e){var t=!0;u._action={deactivate:function(){t=!1}},u.fire("zoneEnd",e),t&&n()}))}()}}},{key:"deactivate",value:function(){this._action&&(this._action.deactivate(),this._action=null)}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),pS=function(e){m(i,Ie);var t=y(i);function i(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return k(this,i),(r=t.call(this,e.viewer.scene)).zonesPlugin=e,r.pointerLens=n.pointerLens,r.pointerCircle=new Qe(e.viewer),r._action=null,r}return I(i,[{key:"active",get:function(){return!!this._action}},{key:"activate",value:function(e,t,i,r){if("object"===P(e)&&null!==e){var n=e,s=function(e,t){if(e in n)return n[e];if(void 0!==t)return t;throw"config missing: "+e};e=s("altitude"),t=s("height"),i=s("color","#008000"),r=s("alpha",.5)}if(!this._action){var o=this.zonesPlugin,a=o.viewer,l=a.scene,u=this,A=cE(a,this.pointerCircle,(function(t,i){return oS(e,le.vec3([0,1,0]),t,i)}));!function n(){u._action=hS(l,e,t,i,r,u.pointerLens,o,A,(function(e){var t=!0;u._action={deactivate:function(){t=!1}},u.fire("zoneEnd",e),t&&n()}))}()}}},{key:"deactivate",value:function(){this._action&&(this._action.deactivate(),this._action=null)}},{key:"destroy",value:function(){this.deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),fS=function(e){m(i,Ie);var t=y(i);function i(e,r,n,s){var o;k(this,i);var a=e.plugin.viewer,l=a.scene;o=t.call(this,l);var u=e._geometry.altitude,A=e._geometry.planeCoordinates.map((function(t){var i=l.canvas.canvas.ownerDocument.body,r=new nE(l,{},i,{fillColor:e._color});return r.worldPos=le.vec3([t[0],u,t[1]]),r.on("worldPos",(function(){t[0]=r.worldPos[0],t[1]=r.worldPos[2];try{e._rebuildMesh()}catch(t){e._zoneMesh&&(e._zoneMesh.destroy(),e._zoneMesh=null)}})),r})),c=AE({viewer:a,handleMouseEvents:n,handleTouchEvents:s,pointerLens:r&&r.pointerLens,dots:A,ray2WorldPos:function(e,t){return oS(u,le.vec3([0,1,0]),e,t)},onEnd:function(t,i){return e._zoneMesh&&o.fire("edited"),!!e._zoneMesh}}),h=function(){c(),A.forEach((function(e){return e.destroy()}))},d=e.on("destroyed",h);return o._deactivate=function(){e.off("destroyed",d),h()},o}return I(i,[{key:"deactivate",value:function(){this._deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),vS=function(e){m(i,fS);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!0,!1)}return I(i)}(),gS=function(e){m(i,fS);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!1,!0)}return I(i)}(),mS=function(e){m(i,Ie);var t=y(i);function i(e,r,n,s){var o;k(this,i);var a=e.plugin.viewer,l=a.scene,u=l.canvas.canvas,A=w(o=t.call(this,l)),c=e._geometry.altitude,h=r&&r.pointerLens,d=h?function(e){h.visible=!!e,e&&(h.canvasPos=e)}:function(){},p=function(e){var t,i,r=le.vec3(),n=le.vec3();return le.canvasPosToWorldRay(u,l.camera.viewMatrix,l.camera.projMatrix,l.camera.projection,e,r,n),t=r,i=n,oS(c,le.vec3([0,1,0]),t,i)},v=function(e,t){return t[0]=e.clientX,t[1]=e.clientY,eE(u.ownerDocument.documentElement,u,t),t},g=function(e,t){var i=function(e){e.preventDefault(),t(e)};return u.addEventListener(e,i),function(){return u.removeEventListener(e,i)}},m=function(){},_=function(t,i,r,n){var s,o,l,c,h=n(t),f=v(h,le.vec2()),_=a.scene.pick({canvasPos:f,includeEntities:[e._zoneMesh.id]});if((_&&_.entity&&_.entity.zone)===e){m(),u.style.cursor="move",a.cameraControl.active=!1;var y=(s=e._geometry.planeCoordinates.map((function(e){return e.slice()})),o=p(f),l=le.vec2([o[0],o[2]]),c=le.vec2(),function(t){var i=p(t);c[0]=i[0],c[1]=i[2],le.subVec2(l,c,c),e._geometry.planeCoordinates.forEach((function(e,t){le.subVec2(s[t],c,e)}));try{e._rebuildMesh()}catch(t){e._zoneMesh&&(e._zoneMesh.destroy(),e._zoneMesh=null)}}),b=g(i,(function(e){var t=n(e);if(t){var i=v(t,le.vec2());y(i),d(i)}})),w=g(r,(function(e){var t=n(e);if(t){var i=v(t,le.vec2());y(i),d(null),m(),A.fire("translated")}}));m=function(){m=function(){},u.style.cursor="default",a.cameraControl.active=!0,b(),w()}}},y=[];n&&y.push(g("mousedown",(function(e){1===e.which&&_(e,"mousemove","mouseup",(function(e){return 1===e.which&&e}))}))),s&&y.push(g("touchstart",(function(e){if(1===e.touches.length){var t=e.touches[0].identifier;_(e,"touchmove","touchend",(function(e){return f(e.changedTouches).find((function(e){return e.identifier===t}))}))}})));var b=function(){m(),y.forEach((function(e){return e()})),d(null)},B=e.on("destroyed",b);return o._deactivate=function(){e.off("destroyed",B),b()},o}return I(i,[{key:"deactivate",value:function(){this._deactivate(),v(x(i.prototype),"destroy",this).call(this)}}]),i}(),_S=function(e){m(i,mS);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!0,!1)}return I(i)}(),yS=function(e){m(i,mS);var t=y(i);function i(e,r){return k(this,i),t.call(this,e,r,!1,!0)}return I(i)}();export{Pi as AlphaFormat,Oc as AmbientLight,EE as AngleMeasurementEditMouseControl,IE as AngleMeasurementEditTouchControl,xE as AngleMeasurementsControl,PE as AngleMeasurementsMouseControl,CE as AngleMeasurementsPlugin,FE as AngleMeasurementsTouchControl,LE as AnnotationsPlugin,OE as AxisGizmoPlugin,GE as BCFViewpointsPlugin,Zn as Bitmap,fi as ByteType,Yc as CameraMemento,Ke as CameraPath,tt as CameraPathAnimation,eS as CityJSONLoaderPlugin,ii as ClampToEdgeWrapping,Ie as Component,pr as CompressedMediaType,po as Configs,ee as ContextMenu,ih as CubicBezierCurve,ze as Curve,ND as CxConverterIFCLoaderPlugin,ZA as DefaultLoadingManager,Ei as DepthFormat,Ii as DepthStencilFormat,Vc as DirLight,nI as DistanceMeasurementEditControl,sI as DistanceMeasurementEditMouseControl,oI as DistanceMeasurementEditTouchControl,$E as DistanceMeasurementsControl,eI as DistanceMeasurementsMouseControl,tI as DistanceMeasurementsPlugin,rI as DistanceMeasurementsTouchControl,nE as Dot3D,tS as DotBIMDefaultDataSource,iS as DotBIMLoaderPlugin,Xn as EdgeMaterial,zn as EmphasisMaterial,YI as FaceAlignedSectionPlanesPlugin,aI as FastNavPlugin,yi as FloatType,Kn as Fresnel,Ue as Frustum,Re as FrustumPlane,cr as GIFMediaType,lI as GLTFDefaultDataSource,gI as GLTFLoaderPlugin,bi as HalfFloatType,Un as ImagePlane,mi as IntType,hr as JPEGMediaType,tc as KTX2TextureTranscoder,WD as LASLoaderPlugin,sE as Label3D,Ln as LambertMaterial,Wc as LightMap,Uc as LineSet,ur as LinearEncoding,ui as LinearFilter,di as LinearMipMapLinearFilter,ci as LinearMipMapNearestFilter,hi as LinearMipmapLinearFilter,Ai as LinearMipmapNearestFilter,JA as Loader,KA as LoadingManager,He as LocaleService,ki as LuminanceAlphaFormat,Fi as LuminanceFormat,Z as Map,Zc as Marker,Ne as MarqueePicker,Ve as MarqueePickerMouseControl,vn as Mesh,ls as MeshSurfaceArea,es as MeshVolume,Vn as MetallicMaterial,ri as MirroredRepeatWrapping,$c as ModelMemento,bI as NavCubePlugin,ni as NearestFilter,li as NearestMipMapLinearFilter,si as NearestMipMapNearestFilter,ai as NearestMipmapLinearFilter,oi as NearestMipmapNearestFilter,Xt as Node,II as OBJLoaderPlugin,Ae as ObjectsKdTree3,th as ObjectsMemento,dr as PNGMediaType,rh as Path,sh as PerformanceModel,bn as PhongMaterial,ph as PickResult,vh as Plugin,Qc as PointLight,Qe as PointerCircle,te as PointerLens,nh as QuadraticBezierCurve,ce as Queue,Mi as RGBAFormat,Ui as RGBAIntegerFormat,sr as RGBA_ASTC_10x10_Format,ir as RGBA_ASTC_10x5_Format,rr as RGBA_ASTC_10x6_Format,nr as RGBA_ASTC_10x8_Format,or as RGBA_ASTC_12x10_Format,ar as RGBA_ASTC_12x12_Format,Ki as RGBA_ASTC_4x4_Format,Zi as RGBA_ASTC_5x4_Format,Ji as RGBA_ASTC_5x5_Format,Yi as RGBA_ASTC_6x5_Format,qi as RGBA_ASTC_6x6_Format,$i as RGBA_ASTC_8x5_Format,er as RGBA_ASTC_8x6_Format,tr as RGBA_ASTC_8x8_Format,lr as RGBA_BPTC_Format,Xi as RGBA_ETC2_EAC_Format,ji as RGBA_PVRTC_2BPPV1_Format,Gi as RGBA_PVRTC_4BPPV1_Format,Oi as RGBA_S3TC_DXT1_Format,Ni as RGBA_S3TC_DXT3_Format,Vi as RGBA_S3TC_DXT5_Format,Ci as RGBFormat,zi as RGB_ETC1_Format,Wi as RGB_ETC2_Format,Hi as RGB_PVRTC_2BPPV1_Format,Qi as RGB_PVRTC_4BPPV1_Format,Li as RGB_S3TC_DXT1_Format,Si as RGFormat,Ri as RGIntegerFormat,mt as ReadableGeometry,Ti as RedFormat,Di as RedIntegerFormat,zc as ReflectionMap,ti as RepeatWrapping,qI as STLDefaultDataSource,aT as STLLoaderPlugin,Sc as SceneModel,ds as SceneModelMesh,Pc as SceneModelTransform,hh as SectionPlane,LI as SectionPlanesPlugin,vi as ShortType,Gn as SpecularMaterial,We as SplineCurve,Jc as SpriteMarker,GI as StoreyViewsPlugin,In as Texture,dh as TextureTranscoder,TI as TransformControl,AT as TreeViewPlugin,pi as UnsignedByteType,xi as UnsignedInt248Type,_i as UnsignedIntType,wi as UnsignedShort4444Type,Bi as UnsignedShort5551Type,gi as UnsignedShortType,bt as VBOGeometry,fT as ViewCullPlugin,vE as Viewer,UD as WebIFCLoaderPlugin,oE as Wire3D,$A as WorkerPool,vT as XKTDefaultDataSource,mD as XKTLoaderPlugin,SD as XML3DLoaderPlugin,fS as ZoneEditControl,vS as ZoneEditMouseControl,gS as ZoneEditTouchControl,mS as ZoneTranslateControl,_S as ZoneTranslateMouseControl,yS as ZoneTranslateTouchControl,uS as ZonesMouseControl,cS as ZonesPlugin,dS as ZonesPolysurfaceMouseControl,pS as ZonesPolysurfaceTouchControl,AS as ZonesTouchControl,uE as activateDraggableDot,AE as activateDraggableDots,dE as addMousePressListener,pE as addTouchPressListener,Pt as buildBoxGeometry,Ct as buildBoxLinesGeometry,Mt as buildBoxLinesGeometryFromAABB,Ft as buildCylinderGeometry,kt as buildGridGeometry,Lt as buildLineGeometry,Et as buildPlaneGeometry,Rt as buildPolylineGeometry,Ut as buildPolylineGeometryFromCurve,It as buildSphereGeometry,Tt as buildTorusGeometry,St as buildVectorTextGeometry,gE as createCombinedTexture,Jt as createRTCViewMat,_E as createSkyboxMesh,yE as createSphereMapMesh,Oe as frustumIntersectsAABB3,rc as getKTX2TextureTranscoder,ei as getPlaneRTCPos,Jn as isTriangleMeshSolid,Bt as load3DSGeometry,xt as loadOBJGeometry,aE as marker3D,le as math,us as meshSurfaceArea,ts as meshVolume,fh as os,$t as rtcToWorldPos,Ar as sRGBEncoding,Le as setFrustum,fE as startPolygonCreate,he as stats,cE as touchPointSelector,eE as transformToNode,hE as triangulateEarClipping,ge as utils,lE as wire3D,Yt as worldToRTCPos,qt as worldToRTCPositions};
